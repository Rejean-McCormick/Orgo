=== FILE 1/22: apps/web/src/orgo/core/functional-ids.ts ===

/**
 * Shared stable functional IDs used across Orgo v3 for logging, analytics,
 * configuration references, etc.
 *
 * This file is mirrored by `apps/api/src/orgo/core/functional-ids.ts`.
 */
export const FUNCTIONAL_ID_VALUES = [
  // Backbone – organizations, users & persons
  "FN_ORG_CREATE",
  "FN_ORG_UPDATE",
  "FN_PERSON_PROFILE_UPSERT",
  "FN_ROLE_CREATE",
  "FN_RBAC_PERMISSION_ASSIGN",
  "FN_IDENTITY_LINK_USER_TO_PERSON",

  // Signals & ingestion (email, API, offline, sync)
  "FN_EMAIL_SEND",
  "FN_EMAIL_FETCH_INCOMING",
  "FN_EMAIL_PARSE_INCOMING",
  "FN_EMAIL_VALIDATE_PAYLOAD",
  "FN_EMAIL_POLL_MAILBOX",
  "FN_EMAIL_ROUTE_TO_WORKFLOW",
  "FN_EMAIL_IMPORT_ARCHIVE",
  "FN_SIGNAL_INGEST",
  "FN_SYNC_OFFLINE_NODE",
  "FN_SYNC_OFFLINE_TASKS",

  // Cases & cyclic review
  "FN_CASE_CREATE_FROM_SIGNAL",
  "FN_CASE_GET_WITH_TASKS",
  "FN_CASE_RUN_CYCLIC_REVIEW",

  // Workflow engine & escalation
  "FN_WORKFLOW_EXECUTE",
  "FN_WORKFLOW_VALIDATE_RULES",
  "FN_WORKFLOW_SIMULATE",
  "FN_WORKFLOW_EVALUATE_ESCALATIONS",

  // Task management
  "FN_TASK_CREATE",
  "FN_TASK_UPDATE_STATUS",
  "FN_TASK_ESCALATE",
  "FN_TASK_ASSIGN",
  "FN_TASK_ADD_COMMENT",
  "FN_TASK_GET_BY_ID",

  // Label & routing
  "FN_ROUTING_RESOLVE_LABEL",
  "FN_ROUTING_APPLY_RULES",
  "FN_LABEL_CREATE_DEFINITION",

  // Database / persistence
  "FN_DB_CONNECT",
  "FN_DB_GET_CLIENT",
  "FN_DB_FETCH_RECORDS",
  "FN_DB_INSERT_RECORD",
  "FN_DB_UPDATE_RECORD",
  "FN_DB_REPOSITORY_OPERATION",

  // Profiles, configuration & feature flags
  "FN_PROFILE_LOAD",
  "FN_PROFILE_APPLY_DEFAULTS",
  "FN_PROFILE_PREVIEW_DIFF",
  "FN_CONFIG_GET_GLOBAL",
  "FN_CONFIG_UPDATE_SERVICE",
  "FN_CONFIG_IMPORT_BUNDLE",
  "FN_CONFIG_VALIDATE",
  "FN_CONFIG_VALIDATE_BUNDLE",
  "FN_FEATURE_FLAG_SET",

  // Public API controllers
  "FN_API_TASK_LIST",
  "FN_API_TASK_GET",
  "FN_API_TASK_CREATE",
  "FN_API_CASE_LIST",
  "FN_API_CASE_GET",
  "FN_API_WORKFLOW_EXECUTE",

  // Admin UI / screens
  "FN_UI_ADMIN_TASK_OVERVIEW",
  "FN_UI_ADMIN_CASE_OVERVIEW",
  "FN_UI_ADMIN_PROFILE_SETTINGS",

  // Notifications & live updates
  "FN_NOTIFICATION_SEND_IN_APP",
  "FN_WS_TASK_EVENTS_STREAM",

  // Domain modules
  "FN_DOMAIN_MAINTENANCE_REGISTER_INCIDENT",
  "FN_DOMAIN_MAINTENANCE_LIST_INCIDENTS",
  "FN_DOMAIN_HR_REGISTER_REPORT",
  "FN_DOMAIN_HR_LIST_CASES",
  "FN_DOMAIN_EDUCATION_REGISTER_STUDENT_INCIDENT",
  "FN_DOMAIN_EDUCATION_LIST_INCIDENTS",
  "FN_DOMAIN_TASK_FACTORY_CREATE",
  "FN_DOMAIN_WORKFLOW_APPLY_OVERRIDES",

  // Insights & reporting
  "FN_INSIGHTS_GET_TASK_VOLUME_REPORT",
  "FN_INSIGHTS_GET_SLA_BREACHES",
  "FN_INSIGHTS_GET_PROFILE_SCORE",
  "FN_INSIGHTS_EXPORT_FACTS",
  "FN_INSIGHTS_REFRESH_VIEWS",
  "FN_INSIGHTS_PATTERN_RUN_WEEKLY",
  "FN_INSIGHTS_PATTERN_RUN_MONTHLY",
  "FN_INSIGHTS_PATTERN_RUN_YEARLY",
  "FN_INSIGHTS_CACHE_WARM_DASHBOARDS",
  "FN_INSIGHTS_EXPORT_ANALYTICS",
  "FN_UI_INSIGHTS_OVERVIEW",

  // Infrastructure, health, metrics & alerts
  "FN_INFRA_HEALTHCHECK",
  "FN_INFRA_WORKER_HEARTBEAT",
  "FN_INFRA_METRICS_RECORD_WORKFLOW_LATENCY",
  "FN_INFRA_METRICS_RECORD_QUEUE_DEPTH",
  "FN_ALERT_ESCALATION_DELAY",
  "FN_ALERT_ERROR_RATE",

  // Security & compliance
  "FN_SECURITY_AUTH_VALIDATE_ACCESS_TOKEN",
  "FN_SECURITY_RBAC_CHECK_PERMISSION",
  "FN_SECURITY_PRIVACY_ANONYMIZE_PAYLOAD",
  "FN_SECURITY_AUDIT_RECORD_EVENT",
  "FN_SECURITY_COMPLIANCE_EXPORT_AUDIT_LOG",

  // Logging
  "FN_LOG_SYSTEM_EVENT",
  "FN_LOG_SECURITY_EVENT",
  "FN_LOG_ROTATE",
  "FN_LOG_GET_ACTIVITY_FOR_ENTITY",

  // Validation & metadata
  "FN_VALIDATION_VALIDATE_PAYLOAD",
  "FN_VALIDATION_NORMALIZE_METADATA",
] as const;

export type FunctionalId = (typeof FUNCTIONAL_ID_VALUES)[number];

export const FunctionalIds: Record<FunctionalId, FunctionalId> =
  FUNCTIONAL_ID_VALUES.reduce(
    (acc, id) => {
      acc[id] = id;
      return acc;
    },
    {} as Record<FunctionalId, FunctionalId>,
  );

export function isFunctionalId(value: string): value is FunctionalId {
  return (FUNCTIONAL_ID_VALUES as readonly string[]).includes(value);
}


=== FILE 2/22: apps/web/src/orgo/hooks/useTaskEventStream.ts ===

// apps/web/src/orgo/hooks/useTaskEventStream.ts
import { useCallback, useEffect, useRef, useState } from "react";

export type TaskEventType =
  | "created"
  | "status_changed"
  | "priority_changed"
  | "ownership_changed"
  | "comment_added"
  | "email_linked"
  | "escalated"
  | "deadline_updated"
  | "metadata_updated"
  | string;

export interface TaskEvent {
  id?: string;
  taskId: string;
  organizationId?: string;
  eventType: TaskEventType;
  oldValue?: unknown;
  newValue?: unknown;
  actorUserId?: string | null;
  actorRoleId?: string | null;
  origin?: string;
  createdAt: string;
  // Allow extra fields from backend without losing them
  [key: string]: unknown;
}

export interface UseTaskEventStreamOptions {
  /**
   * Optional task filter. If provided, the client will request
   * events only for this task (server must support this convention).
   */
  taskId?: string;

  /**
   * Optional organization filter. Can be used by the server to scope events.
   */
  organizationId?: string;

  /**
   * Whether the WebSocket connection should be active.
   * Defaults to true.
   */
  enabled?: boolean;

  /**
   * Whether the hook should try to automatically reconnect on unexpected close.
   * Defaults to true.
   */
  autoReconnect?: boolean;

  /**
   * Optional callback invoked for every normalized TaskEvent.
   */
  onEvent?: (event: TaskEvent) => void;

  /**
   * Optional callback invoked when the WebSocket errors.
   */
  onError?: (error: Error) => void;
}

export interface UseTaskEventStreamResult {
  /**
   * All TaskEvents received during the lifetime of this hook instance.
   */
  events: TaskEvent[];

  /**
   * The most recently received TaskEvent, or null if none.
   */
  lastEvent: TaskEvent | null;

  /**
   * True while the WebSocket connection is open.
   */
  isConnected: boolean;

  /**
   * True while we are in the process of establishing a connection.
   */
  isConnecting: boolean;

  /**
   * Last error encountered by the WebSocket, if any.
   */
  error: Error | null;

  /**
   * Manually close the WebSocket and stop auto‑reconnect.
   */
  disconnect: () => void;

  /**
   * Force a reconnect (will reopen the WebSocket with current options).
   */
  reconnect: () => void;

  /**
   * Clear the in‑memory list of events and lastEvent.
   */
  clearEvents: () => void;
}

/**
 * Derive the WebSocket URL used for TaskEventsGateway.
 *
 * Priority:
 * 1. NEXT_PUBLIC_ORGO_TASK_EVENTS_WS_URL (full ws:// or wss:// URL)
 * 2. window.location.origin + /api/v3/task-events/stream (converted to ws:// or wss://)
 *
 * Optional filters (task_id, organization_id) are appended as query parameters.
 */
function resolveTaskEventsWsUrl(params: {
  taskId?: string;
  organizationId?: string;
}): string | null {
  if (typeof window === "undefined") {
    return null;
  }

  const explicit = process.env.NEXT_PUBLIC_ORGO_TASK_EVENTS_WS_URL;
  const httpUrl =
    explicit && explicit.length > 0
      ? explicit
      : `${window.location.origin}/api/v3/task-events/stream`;

  let url: URL;
  try {
    url = new URL(httpUrl, window.location.origin);
  } catch {
    return null;
  }

  // Ensure WebSocket protocol
  url.protocol = url.protocol === "https:" ? "wss:" : "ws:";

  if (params.taskId) {
    url.searchParams.set("task_id", params.taskId);
  }

  if (params.organizationId) {
    url.searchParams.set("organization_id", params.organizationId);
  }

  return url.toString();
}

function extractTaskEventPayload(raw: unknown): any {
  if (!raw || typeof raw !== "object") {
    return raw;
  }

  const obj = raw as any;

  // Common wrapping patterns: { event: {...} }, { data: {...} }, { payload: {...} }
  if (obj.event) return obj.event;
  if (obj.payload) return obj.payload;
  if (obj.data) return obj.data;

  return obj;
}

function normalizeTaskEvent(raw: unknown): TaskEvent | null {
  if (!raw) return null;

  const envelope = extractTaskEventPayload(raw);
  if (!envelope || typeof envelope !== "object") {
    return null;
  }

  const obj = envelope as any;

  const taskId = obj.task_id ?? obj.taskId;
  if (!taskId || typeof taskId !== "string") {
    // Not a task‑scoped event we understand
    return null;
  }

  const organizationId =
    obj.organization_id ??
    obj.organizationId ??
    (raw as any)?.organization_id ??
    (raw as any)?.organizationId;

  const eventType: TaskEventType =
    obj.event_type ??
    obj.eventType ??
    (raw as any)?.event_type ??
    (raw as any)?.eventType ??
    (raw as any)?.type ??
    "unknown";

  const createdAt: string =
    obj.created_at ??
    obj.createdAt ??
    (raw as any)?.created_at ??
    (raw as any)?.createdAt ??
    new Date().toISOString();

  const oldValue = obj.old_value ?? obj.oldValue;
  const newValue = obj.new_value ?? obj.newValue;

  const actorUserId =
    obj.actor_user_id ?? obj.actorUserId ?? (raw as any)?.actor_user_id;
  const actorRoleId =
    obj.actor_role_id ?? obj.actorRoleId ?? (raw as any)?.actor_role_id;

  const origin = obj.origin ?? (raw as any)?.origin;

  const id = obj.id ?? (raw as any)?.id;

  const event: TaskEvent = {
    id: typeof id === "string" ? id : undefined,
    taskId,
    organizationId:
      typeof organizationId === "string" ? organizationId : undefined,
    eventType,
    oldValue,
    newValue,
    actorUserId:
      typeof actorUserId === "string" || actorUserId === null
        ? actorUserId
        : undefined,
    actorRoleId:
      typeof actorRoleId === "string" || actorRoleId === null
        ? actorRoleId
        : undefined,
    origin: typeof origin === "string" ? origin : undefined,
    createdAt,
    // keep full raw payload attached for inspection if needed
    raw,
  };

  return event;
}

export function useTaskEventStream(
  options: UseTaskEventStreamOptions = {}
): UseTaskEventStreamResult {
  const {
    taskId,
    organizationId,
    enabled = true,
    autoReconnect = true,
    onEvent,
    onError,
  } = options;

  const [events, setEvents] = useState<TaskEvent[]>([]);
  const [lastEvent, setLastEvent] = useState<TaskEvent | null>(null);
  const [isConnected, setIsConnected] = useState(false);
  const [isConnecting, setIsConnecting] = useState(false);
  const [error, setError] = useState<Error | null>(null);

  const wsRef = useRef<WebSocket | null>(null);
  const reconnectTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(
    null
  );
  const manuallyDisconnectedRef = useRef(false);
  const isMountedRef = useRef(false);
  const [reconnectCounter, setReconnectCounter] = useState(0);

  const clearEvents = useCallback(() => {
    setEvents([]);
    setLastEvent(null);
  }, []);

  const disconnect = useCallback(() => {
    manuallyDisconnectedRef.current = true;

    if (reconnectTimeoutRef.current) {
      clearTimeout(reconnectTimeoutRef.current);
      reconnectTimeoutRef.current = null;
    }

    if (wsRef.current) {
      wsRef.current.close();
      wsRef.current = null;
    }

    if (isMountedRef.current) {
      setIsConnected(false);
      setIsConnecting(false);
    }
  }, []);

  const reconnect = useCallback(() => {
    manuallyDisconnectedRef.current = false;
    // Trigger effect to re-establish connection
    setReconnectCounter((prev) => prev + 1);
  }, []);

  useEffect(() => {
    if (!enabled || typeof window === "undefined") {
      return;
    }

    const url = resolveTaskEventsWsUrl({ taskId, organizationId });

    if (!url) {
      const err = new Error("Unable to resolve TaskEvents WebSocket URL");
      setError(err);
      if (onError) {
        onError(err);
      }
      return;
    }

    isMountedRef.current = true;
    manuallyDisconnectedRef.current = false;

    const ws = new WebSocket(url);
    wsRef.current = ws;

    setIsConnecting(true);
    setError(null);

    ws.onopen = () => {
      if (!isMountedRef.current) return;
      setIsConnecting(false);
      setIsConnected(true);
    };

    ws.onmessage = (event: MessageEvent) => {
      if (!isMountedRef.current) return;

      let payload: unknown = event.data;
      if (typeof event.data === "string") {
        try {
          payload = JSON.parse(event.data);
        } catch {
          // keep as raw string if it is not valid JSON
          payload = event.data;
        }
      }

      const normalized = normalizeTaskEvent(payload);
      if (!normalized) {
        return;
      }

      setLastEvent(normalized);
      setEvents((prev) => [...prev, normalized]);

      if (onEvent) {
        onEvent(normalized);
      }
    };

    ws.onerror = () => {
      if (!isMountedRef.current) return;

      const err = new Error("TaskEvents WebSocket error");
      setError(err);
      if (onError) {
        onError(err);
      }
    };

    ws.onclose = () => {
      if (!isMountedRef.current) return;

      setIsConnected(false);
      setIsConnecting(false);
      wsRef.current = null;

      if (autoReconnect && !manuallyDisconnectedRef.current) {
        reconnectTimeoutRef.current = setTimeout(() => {
          if (
            !isMountedRef.current ||
            manuallyDisconnectedRef.current ||
            !autoReconnect
          ) {
            return;
          }
          setReconnectCounter((prev) => prev + 1);
        }, 3000);
      }
    };

    return () => {
      isMountedRef.current = false;

      if (reconnectTimeoutRef.current) {
        clearTimeout(reconnectTimeoutRef.current);
        reconnectTimeoutRef.current = null;
      }

      if (wsRef.current) {
        wsRef.current.close();
        wsRef.current = null;
      }
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [
    enabled,
    autoReconnect,
    taskId,
    organizationId,
    onEvent,
    onError,
    reconnectCounter,
  ]);

  return {
    events,
    lastEvent,
    isConnected,
    isConnecting,
    error,
    disconnect,
    reconnect,
    clearEvents,
  };
}


=== FILE 3/22: apps/web/src/orgo/types/case.ts ===

// apps/web/src/orgo/types/case.ts

// Canonical enums for Case, aligned with Docs 1, 2 and 8.

/**
 * CASE_STATUS
 * - open
 * - in_progress
 * - resolved
 * - archived
 */
export const CASE_STATUSES = [
  'open',
  'in_progress',
  'resolved',
  'archived',
] as const;
export type CaseStatus = (typeof CASE_STATUSES)[number];

/**
 * JSON form of TASK_SEVERITY for Cases
 * - minor
 * - moderate
 * - major
 * - critical
 */
export const CASE_SEVERITIES = [
  'minor',
  'moderate',
  'major',
  'critical',
] as const;
export type CaseSeverity = (typeof CASE_SEVERITIES)[number];

/**
 * Case source_type / task_source_enum (JSON form)
 * - email
 * - api
 * - manual
 * - sync
 */
export const CASE_SOURCE_TYPES = ['email', 'api', 'manual', 'sync'] as const;
export type CaseSourceType = (typeof CASE_SOURCE_TYPES)[number];

// Common scalar aliases used across Orgo types
export type UUID = string;
export type IsoDateTimeString = string; // e.g. "2025-11-18T10:30:00Z"
export type IsoDurationString = string; // e.g. "PT2H"
export type LabelCode = string; // "<BASE>.<CATEGORY><SUBCATEGORY>.<HORIZONTAL_ROLE>"

/**
 * Canonical Case JSON contract for the web app, matching Doc 2 §2.11
 * and Doc 8 §8.4.1.
 *
 * This represents the shape returned by the public Case API
 * (GET /api/v3/cases, GET /api/v3/cases/:id) for the Case fields.
 */
export interface Case {
  case_id: UUID;
  organization_id: UUID;

  source_type: CaseSourceType;
  source_reference: string | null;

  label: LabelCode;
  title: string;
  description: string;

  status: CaseStatus;
  severity: CaseSeverity;

  /**
   * ISO‑8601 duration (e.g. "PT2H"); derived from profiles/workflows.
   * Null if no explicit SLA window is set for this Case.
   */
  reactivity_time: IsoDurationString | null;

  /**
   * Base part of the original label (e.g. 100, 1001).
   */
  origin_vertical_level: number | null;

  /**
   * Horizontal role of origin (e.g. "Ops.Maintenance").
   */
  origin_role: string | null;

  /**
   * High‑level tags (e.g. ["safety","wet_floor"]).
   */
  tags: string[] | null;

  /**
   * Structured location (site, building, GPS, etc.).
   */
  location: Record<string, unknown> | null;

  /**
   * Case‑level metadata (pattern_sensitivity, review settings, profile_id, etc.).
   */
  metadata: Record<string, unknown>;

  /**
   * Timestamps are ISO‑8601 in UTC.
   */
  created_at: IsoDateTimeString;
  updated_at: IsoDateTimeString;
}

/**
 * Optional extension used by Case details endpoints that include linked Tasks.
 *
 * TTask is generic so this file does not need to depend on a specific Task type;
 * callers can specialise it as CaseWithTasks<Task>.
 */
export interface CaseWithTasks<TTask = unknown> extends Case {
  tasks: TTask[];
}


=== FILE 4/22: apps/web/src/orgo/types/insights.ts ===

/**
 * Orgo v3 – Insights / Analytics Type Definitions
 *
 * This file models:
 * - Canonical enums reused in the Insights slice
 * - The /config/insights/config.yaml structure
 * - Star-schema dimensions and fact tables in the `insights.*` schema
 *
 * All enums and shapes are aligned with the v3 spec documents.
 */

/* -------------------------------------------------------------------------- */
/*  Common primitive aliases                                                   */
/* -------------------------------------------------------------------------- */

export type UUID = string;

/**
 * ISO-8601 timestamp in UTC, e.g. "2025-11-18T10:30:00Z".
 */
export type IsoDateTimeString = string;

/**
 * ISO-8601 calendar date, e.g. "2025-03-14".
 */
export type IsoDateString = string;

/* -------------------------------------------------------------------------- */
/*  Core enums used by Insights (mirroring canonical enums)                   */
/* -------------------------------------------------------------------------- */

/**
 * Global deployment environments.
 */
export type Environment = 'dev' | 'staging' | 'prod' | 'offline';

/**
 * Task lifecycle status in analytics and operational views.
 */
export type TaskStatus =
  | 'PENDING'
  | 'IN_PROGRESS'
  | 'ON_HOLD'
  | 'COMPLETED'
  | 'FAILED'
  | 'ESCALATED'
  | 'CANCELLED';

/**
 * Task priority.
 */
export type TaskPriority = 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';

/**
 * Task / Case severity.
 */
export type TaskSeverity = 'MINOR' | 'MODERATE' | 'MAJOR' | 'CRITICAL';

/**
 * Visibility of a task/case/event.
 */
export type Visibility = 'PUBLIC' | 'INTERNAL' | 'RESTRICTED' | 'ANONYMISED';

/**
 * Operational source of a task/case.
 */
export type TaskSource = 'email' | 'api' | 'manual' | 'sync';

/**
 * Case lifecycle status used in analytics.
 */
export type CaseStatus = 'open' | 'in_progress' | 'resolved' | 'archived';

/**
 * Notification channel enum values as used in analytics/export config.
 */
export type NotificationChannel = 'email' | 'sms' | 'in_app' | 'webhook';

/**
 * Notification scope, as used in profiles and reporting.
 */
export type NotificationScope = 'user' | 'team' | 'department' | 'org_wide';

/* -------------------------------------------------------------------------- */
/*  Profile keys (as referenced from Insights patterns config)                */
/* -------------------------------------------------------------------------- */

/**
 * Known profile keys from the profiles YAML.
 *
 * Additional profile keys may be added in the YAML; consumers should still
 * accept arbitrary strings where forward compatibility is needed.
 */
export type ProfileKey =
  | 'default'
  | 'friend_group'
  | 'hospital'
  | 'advocacy_group'
  | 'retail_chain'
  | 'military_organization'
  | 'environmental_group'
  | 'artist_collective';

/* -------------------------------------------------------------------------- */
/*  Insights config: /config/insights/config.yaml (insights: subtree)         */
/* -------------------------------------------------------------------------- */

/**
 * Warehouse types supported by the Insights slice.
 */
export type InsightsWarehouseType = 'postgres' | 'bigquery' | 'snowflake';

export interface InsightsWarehouseConfig {
  type: InsightsWarehouseType;
  connection_url: string;
  schema: string;
  read_only_user: string;
  write_user: string;
}

export interface InsightsEtlConfig {
  owner_email: string;
  default_batch_size: number;
  max_batch_size: number;
  concurrency: number;
}

export interface InsightsCacheTtlSeconds {
  dashboard_default: number;
  dashboard_slow: number;
  streaming_like: number;
}

export interface InsightsCacheMaxKeysPerDashboard {
  dev?: number;
  staging?: number;
  prod?: number;
  offline?: number;
}

export interface InsightsCacheConfig {
  backend: 'redis';
  url: string;
  ttl_seconds: InsightsCacheTtlSeconds;
  max_keys_per_dashboard: InsightsCacheMaxKeysPerDashboard;
}

/**
 * Per-environment numeric config slice, where not all environments
 * must be explicitly defined in YAML.
 */
export type PerEnvironmentNumber = Partial<Record<Exclude<Environment, 'offline'>, number>>;

export interface InsightsRetentionConfig {
  raw_event_retention_days: PerEnvironmentNumber;
  aggregated_retention_days: PerEnvironmentNumber;
  pattern_result_retention_days: PerEnvironmentNumber;
}

export interface InsightsBackupSlice {
  rpo_minutes: PerEnvironmentNumber;
  rto_minutes: PerEnvironmentNumber;
}

export interface InsightsExportLimitsPerEnvironment {
  dev?: number;
  staging?: number;
  prod?: number;
}

export interface InsightsExportConfig {
  max_rows_per_export: InsightsExportLimitsPerEnvironment;
  max_parallel_exports_per_user: InsightsExportLimitsPerEnvironment;
  pii_masking_enabled: boolean;
  allowed_visibilities: Visibility[];
}

/**
 * Sliding-window settings for pattern detection at a given cadence
 * (weekly / monthly / yearly).
 */
export interface InsightsPatternWindowConfig {
  window_days: number;
  min_events: number;
  min_distinct_sources: number;
}

/**
 * Pattern configuration, including profile selection by domain.
 */
export interface InsightsPatternsConfig {
  /**
   * Profile key to use when no domain-specific override applies.
   */
  default_profile_key: ProfileKey | string;

  /**
   * Mapping from Task.type (e.g. "maintenance", "hr_case") to profile key.
   */
  overrides_by_domain?: Record<string, ProfileKey | string>;

  weekly: InsightsPatternWindowConfig;
  monthly: InsightsPatternWindowConfig;
  yearly: InsightsPatternWindowConfig;
}

/**
 * Root of the /config/insights/config.yaml "insights" subtree.
 *
 * Note: some deployments may wrap this under a top-level `{ insights: InsightsConfig }`.
 */
export interface InsightsConfig {
  environment: Environment;
  warehouse: InsightsWarehouseConfig;
  etl: InsightsEtlConfig;
  cache: InsightsCacheConfig;
  retention: InsightsRetentionConfig;
  backups: InsightsBackupSlice;
  exports: InsightsExportConfig;
  patterns: InsightsPatternsConfig;
}

/* -------------------------------------------------------------------------- */
/*  Star-schema dimensions: insights.dim_*                                    */
/* -------------------------------------------------------------------------- */

/**
 * Calendar/date dimension row.
 */
export interface InsightsDimDate {
  date_key: IsoDateString; // e.g. "2025-03-14"
  year: number;
  quarter: number; // 1–4
  month: number; // 1–12
  month_name: string;
  week_of_year: number;
  day_of_week: number; // 1=Monday–7=Sunday
  day_name: string;
  is_weekend: boolean;
}

/**
 * Organization dimension row (analytics view over organizations).
 */
export interface InsightsDimOrganization {
  organization_id: UUID;
  slug: string;
  display_name: string;
  org_type: string | null;
  timezone: string;
  active_from: IsoDateString;
  active_to: IsoDateString | null;
}

/**
 * Task dimension row (denormalized task view).
 */
export interface InsightsDimTask {
  task_id: UUID;
  organization_id: UUID;
  case_id: UUID | null;

  label: string;
  type: string;
  category: string;
  subtype: string | null;

  priority: TaskPriority;
  severity: TaskSeverity;
  visibility: Visibility;
  source: TaskSource;

  assignee_role: string | null;

  created_at: IsoDateTimeString;
  closed_at: IsoDateTimeString | null;

  current_status: TaskStatus;
}

/**
 * Case dimension row (denormalized case view).
 */
export interface InsightsDimCase {
  case_id: UUID;
  organization_id: UUID;

  label: string;
  title: string;
  status: CaseStatus;
  severity: TaskSeverity;

  origin_vertical_level: number;
  origin_role: string;

  opened_at: IsoDateTimeString;
  closed_at: IsoDateTimeString | null;
}

/**
 * Person dimension row (analytics view over person_profiles).
 */
export type PersonConfidentialityLevel = 'normal' | 'sensitive' | 'highly_sensitive';

export interface InsightsDimPerson {
  person_id: UUID;
  organization_id: UUID;
  full_name: string;
  external_reference: string | null;
  confidentiality_level: PersonConfidentialityLevel;
}

/**
 * Learning group (class/team/group) dimension row.
 */
export interface InsightsDimLearningGroup {
  learning_group_id: UUID;
  organization_id: UUID;
  code: string;
  name: string;
  category: string;
}

/* -------------------------------------------------------------------------- */
/*  Star-schema fact tables: insights.fact_*                                  */
/* -------------------------------------------------------------------------- */

/**
 * Task fact row – core lifecycle metrics used in reporting.
 */
export interface InsightsFactTask {
  id: number; // bigserial in DB
  task_id: UUID;
  organization_id: UUID;

  created_date_key: IsoDateString;
  closed_date_key: IsoDateString | null;

  current_status: TaskStatus;
  priority: TaskPriority;
  severity: TaskSeverity;
  source: TaskSource;

  time_to_first_response_seconds: number | null;
  time_to_completion_seconds: number | null;

  escalation_count: number;
  comment_count: number;
}

/**
 * Case fact row – lifecycle metrics and link counts.
 */
export interface InsightsFactCase {
  id: number; // bigserial
  case_id: UUID;
  organization_id: UUID;

  opened_date_key: IsoDateString;
  closed_date_key: IsoDateString | null;

  status: CaseStatus;
  severity: TaskSeverity;

  linked_task_count: number;
  escalation_count: number;
  review_count: number;
}

/**
 * Wellbeing check-in fact row.
 */
export interface InsightsFactWellbeingCheckin {
  id: number; // bigserial
  checkin_id: UUID;
  organization_id: UUID;

  person_id: UUID | null;
  learning_group_id: UUID | null;

  date_key: IsoDateString;
  score: number;
  tags: string[];

  related_case_id: UUID | null;
  related_task_id: UUID | null;
}

/* -------------------------------------------------------------------------- */
/*  Generic helpers for UI/reporting                                         */
/* -------------------------------------------------------------------------- */

/**
 * Generic time-series point used by insights dashboards.
 */
export interface InsightsTimeSeriesPoint<TExtra = unknown> {
  /**
   * Calendar date for this bucket (usually mapped from dim_dates.date_key).
   */
  date_key: IsoDateString;

  /**
   * Primary value for this bucket (e.g. count of tasks).
   */
  value: number;

  /**
   * Optional extra payload per point (e.g. breakdowns).
   */
  extra?: TExtra;
}

/**
 * Simple grouped aggregate row, e.g. "tasks by status" or "cases by label".
 */
export interface InsightsGroupedAggregateRow<TKey = string> {
  key: TKey;
  count: number;
}

/**
 * Standard shape for "SLA breach" listings in analytics reports.
 * This does not directly map to a single table, but is a convenient
 * projection over tasks + fact_tasks + profiles.
 */
export interface InsightsSlaBreachRow {
  task_id: UUID;
  organization_id: UUID;
  title: string;
  type: string;
  category: string;
  priority: TaskPriority;
  severity: TaskSeverity;
  visibility: Visibility;
  source: TaskSource;

  status: TaskStatus;
  created_at: IsoDateTimeString;
  reactivity_deadline_at: IsoDateTimeString | null;
  closed_at: IsoDateTimeString | null;

  /**
   * Positive number of seconds the task is/was beyond its SLA, if applicable.
   */
  breach_seconds: number;
}


=== FILE 5/22: apps/web/src/orgo/types/organization.ts ===

// apps/web/src/orgo/types/organization.ts

/**
 * Organization and organization-profile related types used in the Orgo web app.
 *
 * These types mirror:
 * - The Orgo v3 database schema for `organizations` and `organization_profiles`.
 * - The profiles YAML behaviour schema (profile codes and behavioural knobs).
 */

/**
 * Canonical environment keys (ENVIRONMENT).
 */
export type EnvironmentKey = 'dev' | 'staging' | 'prod' | 'offline';

/**
 * Simple aliases for commonly used primitives.
 */
export type UUID = string;
export type ISO8601String = string;

/**
 * Status of an organization (organizations.status).
 * Backed by `organization_status_enum` in the database.
 */
export type OrganizationStatus = 'active' | 'suspended' | 'archived';

/**
 * Core Organization shape as exposed to the web app.
 *
 * Matches the `organizations` table logical fields:
 * - id (UUID PK)
 * - slug, display_name, legal_name, primary_domain
 * - status, timezone, default_locale
 * - created_at / updated_at (standard audit columns)
 */
export interface Organization {
  id: UUID;
  slug: string;
  display_name: string;
  legal_name: string | null;
  primary_domain: string | null;
  status: OrganizationStatus;
  /**
   * IANA timezone, e.g. "America/New_York".
   */
  timezone: string;
  /**
   * Locale code, e.g. "en", "fr-CA".
   */
  default_locale: string;
  /**
   * Standard audit timestamps (UTC ISO-8601).
   * Optional in case some APIs omit them.
   */
  created_at?: ISO8601String;
  updated_at?: ISO8601String;
}

/**
 * Known profile codes from the profiles YAML plus a string
 * extension point for custom / future profiles.
 *
 * These values correspond to `organization_profiles.profile_code`.
 */
export type OrganizationProfileKey =
  | 'default'
  | 'friend_group'
  | 'hospital'
  | 'advocacy_group'
  | 'retail_chain'
  | 'military_organization'
  | 'environmental_group'
  | 'artist_collective'
  | (string & {}); // allow custom codes while keeping string literal narrowing

/**
 * Behaviour profile primitives from the profiles YAML.
 */

export type TransparencyLevel = 'full' | 'balanced' | 'restricted' | 'private';

export type EscalationGranularity =
  | 'relaxed'
  | 'moderate'
  | 'detailed'
  | 'aggressive';

export type ReviewFrequency =
  | 'real_time'
  | 'daily'
  | 'weekly'
  | 'monthly'
  | 'quarterly'
  | 'yearly'
  | 'ad_hoc';

export type NotificationScope = 'user' | 'team' | 'department' | 'org_wide';

export type PatternSensitivity = 'low' | 'medium' | 'high' | 'critical';

export type SeverityThreshold = 'very_high' | 'high' | 'medium' | 'low';

export type LoggingLevel = 'minimal' | 'standard' | 'detailed' | 'audit';

export type AutomationLevel = 'manual' | 'low' | 'medium' | 'high' | 'full';

export type ProfileVisibilityDefault =
  | 'public'
  | 'internal'
  | 'restricted'
  | 'anonymised';

export type ProfilePriorityDefault = 'low' | 'medium' | 'high' | 'critical';

/**
 * Metadata block used in the profiles YAML.
 */
export interface BehaviorProfileMetadata {
  version: string;
  last_updated: string; // "YYYY-MM-DD"
  environment: EnvironmentKey;
}

/**
 * Severity policy section from the profiles YAML.
 */
export interface BehaviorProfileSeverityPolicyEntry {
  immediate_escalation: boolean;
}

export interface BehaviorProfileSeverityPolicy {
  critical: BehaviorProfileSeverityPolicyEntry;
  major: BehaviorProfileSeverityPolicyEntry;
  minor: BehaviorProfileSeverityPolicyEntry;
}

/**
 * Default task metadata section from the profiles YAML.
 * Values map to canonical TASK_PRIORITY and VISIBILITY enums.
 */
export interface BehaviorProfileDefaultTaskMetadata {
  visibility: ProfileVisibilityDefault;
  default_priority: ProfilePriorityDefault;
  /**
   * Default SLA window (in seconds) for tasks created under this profile.
   */
  default_reactivity_seconds: number;
}

/**
 * Cyclic overview / pattern detection configuration from the profiles YAML.
 */

export interface BehaviorProfileCyclicIncidentFrequency {
  min_events: number;
  window_days: number;
}

export interface BehaviorProfileCyclicThresholdTriggers {
  incident_frequency: BehaviorProfileCyclicIncidentFrequency;
  cross_departmental_trends: boolean;
  high_risk_indicators: boolean;
}

export interface BehaviorProfileCyclicSchedule {
  weekly: boolean;
  monthly: boolean;
  yearly: boolean;
}

export interface BehaviorProfileCyclicOverviewConfig {
  enabled: boolean;
  schedule: BehaviorProfileCyclicSchedule;
  threshold_triggers: BehaviorProfileCyclicThresholdTriggers;
}

/**
 * Behaviour profile as loaded from the profiles YAML
 * (one entry under `profiles:`).
 *
 * This describes how intense/urgent/private an org is:
 * reactivity, escalation, transparency, pattern sensitivity, logging, etc.
 */
export interface BehaviorProfile {
  description: string;
  metadata: BehaviorProfileMetadata;

  // 1. Reactivity / Escalation timing
  reactivity_seconds: number;
  max_escalation_seconds: number;

  // 2. Information visibility
  transparency_level: TransparencyLevel;

  // 3. Escalation structure
  escalation_granularity: EscalationGranularity;

  // 4. Review cadence
  review_frequency: ReviewFrequency;

  // 5. Who gets notified
  notification_scope: NotificationScope;

  // 6. Pattern detection
  pattern_sensitivity: PatternSensitivity;
  pattern_window_days: number;
  pattern_min_events: number;

  // 7. Severity / auto-escalation
  severity_threshold: SeverityThreshold;
  severity_policy: BehaviorProfileSeverityPolicy;

  // 8. Logging & traceability
  logging_level: LoggingLevel;
  log_retention_days: number;

  // 9. Automation level
  automation_level: AutomationLevel;

  // 10. Defaults for task metadata
  default_task_metadata: BehaviorProfileDefaultTaskMetadata;

  // 11. Cyclic Overview settings
  cyclic_overview: BehaviorProfileCyclicOverviewConfig;
}

/**
 * Mapping from profile code → behaviour profile.
 * Mirrors the `profiles:` top-level map in the YAML.
 */
export type BehaviorProfilesMap = Record<OrganizationProfileKey, BehaviorProfile>;

/**
 * Database-level link between an organization and a profile code,
 * plus per-organization overrides for reactivity / transparency /
 * pattern sensitivity / retention.
 *
 * Mirrors the `organization_profiles` table.
 */
export interface OrganizationProfile {
  id: UUID;
  organization_id: UUID;
  profile_code: OrganizationProfileKey;

  /**
   * Per-task-type SLA targets, minutes for LOW/MEDIUM/HIGH/CRITICAL
   * or a similar structure. Kept generic here because the concrete
   * shape is configuration-driven.
   */
  reactivity_profile: unknown;

  /**
   * Defaults for who can see what; configuration-driven structure.
   */
  transparency_profile: unknown;

  /**
   * Thresholds for insights/alerts; configuration-driven structure.
   */
  pattern_sensitivity_profile: unknown;

  /**
   * Log & data retention periods per category; configuration-driven structure.
   */
  retention_profile: unknown;

  /**
   * Incremented on profile changes.
   */
  version: number;

  created_at?: ISO8601String;
  updated_at?: ISO8601String;
}

/**
 * Convenience view used by the frontend when an organization is loaded
 * together with its profile linkage and the resolved behaviour profile
 * (from the profiles YAML).
 */
export interface OrganizationWithProfile {
  organization: Organization;
  organization_profile: OrganizationProfile | null;
  /**
   * Fully-resolved behavioural profile (e.g. "hospital", "friend_group"),
   * if it could be loaded for the given profile_code.
   */
  behavior_profile: BehaviorProfile | null;
}


=== FILE 6/22: apps/web/src/orgo/types/permission.ts ===

/**
 * Permission types for the Orgo web app.
 *
 * These mirror the backend `permissions` table:
 *   - id: UUID primary key
 *   - code: stable string identifier (e.g. "task.view_sensitive")
 *   - description: human-readable explanation
 *
 * Only a subset of permission codes is explicitly enumerated here; the type
 * remains open to any additional codes the backend defines.
 */

/**
 * Canonical permission codes that are explicitly referenced
 * in the Orgo v3 specification and UI.
 *
 * NOTE: This list is not exhaustive. New permissions added on the backend
 * will still be representable via `PermissionCode`.
 */
export const KNOWN_PERMISSIONS = [
  'task.view_sensitive',
  'workflow.edit_rules',
] as const;

/**
 * Narrow type for the explicitly-known permission codes.
 */
export type KnownPermissionCode = (typeof KNOWN_PERMISSIONS)[number];

/**
 * Canonical permission code used across the web app.
 *
 * `KnownPermissionCode` captures well-known, spec-documented codes, while the
 * `string & {}` intersection keeps the type open to any additional codes
 * defined in the backend without breaking type checking.
 */
export type PermissionCode = KnownPermissionCode | (string & {});

/**
 * Permission record as exposed by the Orgo API.
 *
 * This mirrors the logical shape of the `permissions` table:
 *   - id: UUID primary key
 *   - code: stable permission identifier
 *   - description: human-readable explanation
 */
export interface Permission {
  id: string;
  code: PermissionCode;
  description: string;
}

/**
 * A collection of permission codes, typically representing
 * the effective permission set for the current user.
 */
export type PermissionSet = ReadonlyArray<PermissionCode>;

/**
 * A lookup/map representation of permissions where a present key
 * means the permission is granted.
 */
export type PermissionLookup = Readonly<Record<string, true>>;

/**
 * Union type for any permission collection representation
 * this module knows how to check.
 */
export type PermissionCollection = PermissionSet | PermissionLookup;

/**
 * Convert a list of permission codes into a lookup map suitable
 * for fast, repeated permission checks.
 */
export function toPermissionLookup(set: PermissionSet): PermissionLookup {
  const lookup: Record<string, true> = {};

  for (const code of set) {
    // Using string index here keeps this tolerant of unknown codes.
    lookup[code] = true;
  }

  return lookup;
}

/**
 * Check whether a given permission is present in the provided
 * collection (array or lookup map).
 */
export function hasPermission(
  permissions: PermissionCollection,
  code: PermissionCode,
): boolean {
  if (Array.isArray(permissions)) {
    return permissions.includes(code);
  }

  return permissions[code] === true;
}

/**
 * Check whether at least one of the given permission codes
 * is present in the collection.
 */
export function hasAnyPermission(
  permissions: PermissionCollection,
  codes: ReadonlyArray<PermissionCode>,
): boolean {
  for (const code of codes) {
    if (hasPermission(permissions, code)) {
      return true;
    }
  }
  return false;
}

/**
 * Check whether all of the given permission codes are present
 * in the collection.
 */
export function hasAllPermissions(
  permissions: PermissionCollection,
  codes: ReadonlyArray<PermissionCode>,
): boolean {
  for (const code of codes) {
    if (!hasPermission(permissions, code)) {
      return false;
    }
  }
  return true;
}


=== FILE 7/22: apps/web/src/orgo/types/person.ts ===

// apps/web/src/orgo/types/person.ts

/**
 * Person-related types for the Orgo web application.
 *
 * These map to the `person_profiles` table and related enums in the Orgo v3
 * specification. Field names follow the JSON/API contract.
 */

/**
 * Canonical confidentiality levels for person profiles.
 *
 * DB / spec values:
 *   - normal
 *   - sensitive
 *   - highly_sensitive
 */
export type PersonConfidentialityLevel =
  | 'normal'
  | 'sensitive'
  | 'highly_sensitive';

/**
 * Stable identifier type alias for persons.
 *
 * Maps to:
 *   - DB: person_profiles.id
 *   - API/JSON: person_id
 */
export type PersonId = string;

/**
 * Core Person / PersonProfile representation as exposed via the API.
 *
 * This is a direct mapping of the `person_profiles` schema plus default
 * audit columns. Timestamps are ISO‑8601 strings in UTC.
 */
export interface Person {
  /**
   * Stable identifier for the person.
   * DB: person_profiles.id
   */
  person_id: PersonId;

  /**
   * Owning organization (tenant).
   * DB: person_profiles.organization_id
   */
  organization_id: string;

  /**
   * Optional linked user account if this person also has an Orgo login.
   * DB: person_profiles.linked_user_id
   */
  linked_user_id: string | null;

  /**
   * External reference such as student ID or employee number.
   * DB: person_profiles.external_reference
   */
  external_reference: string | null;

  /**
   * Full human name.
   * DB: person_profiles.full_name
   */
  full_name: string;

  /**
   * Date of birth in ISO‑8601 date format (YYYY‑MM‑DD), if known.
   * DB: person_profiles.date_of_birth
   */
  date_of_birth: string | null;

  /**
   * Primary contact email address, if any.
   * DB: person_profiles.primary_contact_email
   */
  primary_contact_email: string | null;

  /**
   * Primary contact phone number, if any.
   * DB: person_profiles.primary_contact_phone
   */
  primary_contact_phone: string | null;

  /**
   * Confidentiality level for this person, used by higher‑level
   * visibility and guardrail logic.
   * DB: person_profiles.confidentiality_level
   */
  confidentiality_level: PersonConfidentialityLevel;

  /**
   * Creation timestamp (UTC, ISO‑8601).
   * DB: person_profiles.created_at
   */
  created_at: string;

  /**
   * Last update timestamp (UTC, ISO‑8601).
   * DB: person_profiles.updated_at
   */
  updated_at: string;
}

/**
 * Alias for compatibility with code that prefers the PersonProfile name.
 * Both refer to the same underlying shape.
 */
export type PersonProfile = Person;


=== FILE 8/22: apps/web/src/orgo/types/profile.ts ===

// apps/web/src/orgo/types/profile.ts

/**
 * Profile-related types for the Orgo web application.
 *
 * This file sits on top of:
 * - Behavioural profile templates defined in the profiles YAML (Doc 7).
 * - The `organization_profiles` table and OrgProfileService types (Docs 1, 4, 5).
 * - Admin UI views for inspecting and previewing organization profiles.
 */

import type {
  UUID,
  OrganizationProfileKey,
  BehaviorProfile,
  BehaviorProfileMetadata,
  BehaviorProfileCyclicOverviewConfig,
  BehaviorProfilesMap,
  OrganizationProfile,
  OrganizationWithProfile,
} from './organization';

/**
 * Convenience alias for profile codes as used by UI / config APIs.
 *
 * Backed by `organization_profiles.profile_code` and the profiles YAML.
 */
export type OrgProfileCode = OrganizationProfileKey;

/* -------------------------------------------------------------------------- */
/*  Canonical tokens used by OrgProfileService                                */
/* -------------------------------------------------------------------------- */

/**
 * Canonical VISIBILITY token, aligned with the backend VISIBILITY enum.
 */
export type VisibilityToken =
  | 'PUBLIC'
  | 'INTERNAL'
  | 'RESTRICTED'
  | 'ANONYMISED';

/**
 * Canonical TASK_PRIORITY token, aligned with the backend TASK_PRIORITY enum.
 */
export type TaskPriorityToken = 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';

/* -------------------------------------------------------------------------- */
/*  Profile templates & resolved organization profile                         */
/* -------------------------------------------------------------------------- */

/**
 * Frontend alias for the behavioural profile template loaded
 * from the profiles YAML (Doc 7).
 *
 * The shape mirrors `BehaviorProfile` from organization.ts and the
 * backend `ProfileTemplate` type in OrgProfileService.
 */
export type ProfileTemplate = BehaviorProfile;

/**
 * Metadata attached to each profile template (version, environment, etc.).
 */
export type ProfileTemplateMetadata = BehaviorProfileMetadata;

/**
 * Cyclic overview / review configuration copied from a profile template.
 */
export type CyclicOverviewConfig = BehaviorProfileCyclicOverviewConfig;

/**
 * Fully-resolved profile for a specific organization, as returned by
 * `OrgProfileService.loadProfile` and configuration endpoints.
 *
 * Combines:
 *   - The selected profile code
 *   - The behavioural template from YAML
 *   - An optional shallow view of the `organization_profiles` row
 */
export interface ResolvedOrgProfile {
  /**
   * Owning organization identifier.
   */
  organizationId: UUID;
  /**
   * Active profile code (e.g. "default", "hospital").
   */
  profileCode: OrgProfileCode | string;
  /**
   * Behavioural template used for this organization.
   */
  template: ProfileTemplate;
  /**
   * Optional shallow copy of the DB row for callers that need to inspect
   * JSONB override blobs or the version counter.
   */
  dbProfile?: {
    id: UUID;
    version: number;
    reactivity_profile?: unknown;
    transparency_profile?: unknown;
    pattern_sensitivity_profile?: unknown;
    retention_profile?: unknown;
  };
}

/* -------------------------------------------------------------------------- */
/*  Applying profile defaults                                                  */
/* -------------------------------------------------------------------------- */

/**
 * What kind of entity profile defaults are being applied to.
 */
export type DefaultsTargetKind = 'task' | 'case';

/**
 * Input used when asking the backend to apply profile-driven defaults
 * to a Task/Case draft.
 *
 * The backend fills in any omitted values using the active profile.
 */
export interface ApplyDefaultsInput {
  organizationId: UUID;
  /**
   * What we are applying defaults to. For now this only changes how callers
   * interpret the result; the actual values are the same.
   */
  kind: DefaultsTargetKind;
  /**
   * Existing canonical priority (TASK_PRIORITY) if already chosen.
   * If omitted, the profile default is used.
   */
  existingPriority?: TaskPriorityToken;
  /**
   * Existing canonical visibility (VISIBILITY) if already chosen.
   * If omitted, the profile default is used.
   */
  existingVisibility?: VisibilityToken;
  /**
   * Explicit SLA (in seconds) computed by the caller. When omitted,
   * the profile's default reactivity is used.
   */
  requestedReactivitySeconds?: number | null;
}

/**
 * Result of applying profile defaults to a Task/Case draft.
 *
 * This is deliberately small; Task/Case handlers can embed it into
 * their own DTOs or view models.
 */
export interface ApplyDefaultsResult {
  organizationId: UUID;
  profileCode: OrgProfileCode | string;
  kind: DefaultsTargetKind;
  priority: TaskPriorityToken;
  visibility: VisibilityToken;
  /**
   * SLA before first escalation, in seconds, after applying defaults.
   */
  reactivitySeconds: number;
  /**
   * Reactivity window expressed as ISO‑8601 duration (e.g. "PT3600S").
   */
  reactivityTimeIso: string;
  /**
   * Automation level from the org profile, useful for workflow engines.
   */
  automationLevel: ProfileTemplate['automation_level'];
  /**
   * Cyclic overview configuration copied from the profile.
   */
  cyclicOverview: CyclicOverviewConfig;
}

/* -------------------------------------------------------------------------- */
/*  Profile diff / preview (Preview profile impact)                            */
/* -------------------------------------------------------------------------- */

/**
 * A simple numeric field change descriptor used when previewing
 * the impact of switching profiles.
 */
export interface ProfileDiffNumericField {
  field: string;
  from: number | null;
  to: number;
  direction: 'increase' | 'decrease' | 'same';
}

/**
 * A simple enum/string field change descriptor used when previewing
 * the impact of switching profiles.
 */
export interface ProfileDiffEnumField {
  field: string;
  from: string | null;
  to: string;
  changed: boolean;
}

/**
 * Compact summary of a profile's key behavioural knobs.
 */
export interface ProfileSummary {
  profileCode: OrgProfileCode | string;
  description: string;
  reactivitySeconds: number;
  maxEscalationSeconds: number;
  notificationScope: string;
  patternSensitivity: string;
  patternWindowDays: number;
  patternMinEvents: number;
  loggingLevel: string;
  logRetentionDays: number;
  defaultVisibility: VisibilityToken;
  defaultPriority: TaskPriorityToken;
}

/**
 * Result of simulating the impact of switching an organization to
 * a new profile code.
 */
export interface ProfileDiffResult {
  organizationId: UUID;
  currentProfileCode: OrgProfileCode | string | null;
  candidateProfileCode: OrgProfileCode | string;
  currentProfileSummary: ProfileSummary | null;
  candidateProfileSummary: ProfileSummary;
  numericChanges: ProfileDiffNumericField[];
  enumChanges: ProfileDiffEnumField[];
}

/**
 * Minimal preview payload used by the admin UI. Controllers are expected
 * to adapt `ProfileDiffResult` into this human-readable form.
 */
export interface ProfilePreviewDiff {
  /**
   * Free‑form summary paragraph describing the impact.
   */
  summary?: string;
  /**
   * Bullet points for the most important changes.
   */
  impact_bullets?: string[];
}

/* -------------------------------------------------------------------------- */
/*  Admin UI: current organization profile snapshot                           */
/* -------------------------------------------------------------------------- */

/**
 * Snapshot of an organization's current profile as expected by the
 * admin "Organization profile" screen.
 *
 * The `profile` sub-object is a relaxed, optional view over the
 * full ProfileTemplate/BehaviorProfile schema, using snake_case keys
 * exactly as in the YAML / backend.
 */
export interface OrgProfileSnapshot {
  organization_id: UUID;
  organization_slug?: string;
  organization_display_name?: string;
  profile_code: OrgProfileCode | string;
  /**
   * Profile version from `organization_profiles.version`, if available.
   */
  version?: number;
  profile: {
    description?: string;
    reactivity_seconds?: number;
    max_escalation_seconds?: number;
    transparency_level?: string;
    escalation_granularity?: string;
    review_frequency?: string;
    notification_scope?: string;
    pattern_sensitivity?: string;
    pattern_window_days?: number;
    pattern_min_events?: number;
    severity_threshold?: string;
    logging_level?: string;
    log_retention_days?: number;
    automation_level?: string;
    default_task_metadata?: {
      visibility?: string;
      default_priority?: string;
      default_reactivity_seconds?: number;
    };
    cyclic_overview?: {
      enabled?: boolean;
      schedule?: {
        weekly?: boolean;
        monthly?: boolean;
        yearly?: boolean;
      };
      threshold_triggers?: {
        incident_frequency?: {
          min_events?: number;
          window_days?: number;
        };
        cross_departmental_trends?: boolean;
        high_risk_indicators?: boolean;
      };
    };
  };
}

/* -------------------------------------------------------------------------- */
/*  Re‑exports for convenience                                                */
/* -------------------------------------------------------------------------- */

/**
 * Re-export core profile-related types from organization.ts so callers
 * can import them from a single module when working with profiles.
 */
export type {
  BehaviorProfile,
  BehaviorProfileMetadata,
  BehaviorProfileCyclicOverviewConfig,
  BehaviorProfilesMap,
  OrganizationProfile,
  OrganizationWithProfile,
};


=== FILE 9/22: apps/web/src/orgo/types/role.ts ===

// apps/web/src/orgo/types/role.ts

/**
 * Role and RBAC-related types for the Orgo web application.
 *
 * These map to the `roles` and `user_role_assignments` tables in the Orgo v3
 * database schema (Doc 1) and the RBAC HTTP API (`/rbac/*`).
 */

/**
 * Stable identifier type alias for roles.
 *
 * Maps to:
 *   - DB: roles.id
 */
export type RoleId = string;

/**
 * Stable identifier type alias for users within RBAC types.
 *
 * Maps to:
 *   - DB: user_accounts.id
 */
export type UserId = string;

/**
 * Stable identifier type alias for organizations.
 *
 * Maps to:
 *   - DB: organizations.id
 */
export type OrganizationId = string;

/**
 * ISO‑8601 timestamp string (UTC), used for audit fields.
 *
 * Examples:
 *   - "2025-11-18T10:30:00Z"
 */
export type IsoDateTimeString = string;

/**
 * Canonical role code.
 *
 * Stable lower_snake_case identifier used in configuration, logs and
 * routing rules, e.g. "ops_maintenance_coordinator".
 *
 * Maps to:
 *   - DB: roles.code
 */
export type RoleCode = string;

/**
 * Scope of a role assignment within an organization.
 *
 * Mirrors `user_role_assignments.scope_type`:
 *   - global   – applies across the whole organization
 *   - team     – scoped to a specific team
 *   - location – scoped to a site / location
 *   - unit     – scoped to a unit / department
 *   - custom   – caller-defined semantics in `scope_reference`
 */
export type RoleScopeType = 'global' | 'team' | 'location' | 'unit' | 'custom';

/**
 * Core Role representation as exposed by the RBAC API.
 *
 * Mirrors the logical shape of the `roles` table:
 *   - id: UUID primary key
 *   - organization_id: tenant that owns the role (null for global/system)
 *   - code: stable lower_snake_case code
 *   - display_name: human-readable label
 *   - description: free-text description of responsibilities
 *   - is_system_role: true for built-in/protected roles
 */
export interface Role {
  /**
   * Stable identifier for the role.
   * DB: roles.id
   */
  id: RoleId;

  /**
   * Owning organization (tenant) for org-scoped roles, or null
   * for global/system roles.
   * DB: roles.organization_id
   */
  organization_id: OrganizationId | null;

  /**
   * Stable lower_snake_case code, unique within the organization.
   * DB: roles.code
   */
  code: RoleCode;

  /**
   * Human-readable name.
   * DB: roles.display_name
   */
  display_name: string;

  /**
   * Longer free-text description of the role's responsibilities.
   * DB: roles.description
   */
  description: string;

  /**
   * True for built-in roles that cannot be modified or deleted
   * by tenants.
   * DB: roles.is_system_role
   */
  is_system_role: boolean;
}

/**
 * Database-level binding between a user and a role within an organization.
 *
 * Mirrors the `user_role_assignments` table:
 *   - id: UUID primary key
 *   - user_id: user being granted the role
 *   - role_id: granted role
 *   - organization_id: tenant in which the assignment applies
 *   - scope_type / scope_reference: optional scoping information
 *   - assigned_at / revoked_at: audit timestamps
 */
export interface UserRoleAssignment {
  /**
   * Stable identifier for the assignment.
   * DB: user_role_assignments.id
   */
  id: string;

  /**
   * User receiving the role.
   * DB: user_role_assignments.user_id
   */
  user_id: UserId;

  /**
   * Assigned role.
   * DB: user_role_assignments.role_id
   */
  role_id: RoleId;

  /**
   * Organization in which this assignment is valid.
   * DB: user_role_assignments.organization_id
   */
  organization_id: OrganizationId;

  /**
   * Scope type for this assignment (global/team/location/unit/custom).
   * DB: user_role_assignments.scope_type
   */
  scope_type: RoleScopeType;

  /**
   * Optional reference whose semantics depend on scope_type
   * (e.g. team id, location code).
   * DB: user_role_assignments.scope_reference
   */
  scope_reference: string | null;

  /**
   * When the role was granted to the user.
   * DB: user_role_assignments.assigned_at
   */
  assigned_at: IsoDateTimeString;

  /**
   * When the role was revoked, if ever.
   * DB: user_role_assignments.revoked_at
   */
  revoked_at: IsoDateTimeString | null;
}


=== FILE 10/22: apps/web/src/orgo/types/task.ts ===

// Canonical Orgo Task types for the web app.
// This mirrors the Task JSON contract exposed by the API.

/**
 * Simple ID aliases for clarity.
 */
export type TaskId = string;
export type OrganizationId = string;
export type CaseId = string;

/**
 * Task status values (JSON-level).
 * Back-end maps these to DB enums.
 */
export type TaskStatus =
  | 'pending'
  | 'in_progress'
  | 'on_hold'
  | 'completed'
  | 'failed'
  | 'escalated'
  | 'cancelled';

/**
 * Task priority values (JSON-level).
 */
export type TaskPriority = 'low' | 'medium' | 'high' | 'critical';

/**
 * Task severity values (JSON-level).
 */
export type TaskSeverity = 'minor' | 'moderate' | 'major' | 'critical';

/**
 * Visibility values (JSON-level).
 */
export type Visibility = 'public' | 'internal' | 'restricted' | 'anonymised';

/**
 * Task source/channel values (JSON-level).
 */
export type TaskSource = 'email' | 'api' | 'manual' | 'sync';

/**
 * Global task category values (JSON-level).
 */
export type TaskCategory =
  | 'request'
  | 'incident'
  | 'update'
  | 'report'
  | 'distribution';

/**
 * Arbitrary domain metadata attached to a Task.
 * Must not duplicate core fields (status, severity, etc.).
 */
export type TaskMetadata = Record<string, unknown>;

/**
 * Canonical Task object as returned by the Orgo API.
 * All timestamps are ISO-8601 strings (UTC).
 */
export interface Task {
  // Identity and tenancy
  task_id: TaskId;
  organization_id: OrganizationId;
  case_id: CaseId | null;

  // Classification
  type: string;
  category: TaskCategory;
  subtype: string | null;
  label: string;

  // Core text
  title: string;
  description: string;

  // State and enums
  status: TaskStatus;
  priority: TaskPriority;
  severity: TaskSeverity;
  visibility: Visibility;
  source: TaskSource;

  // Ownership / actors
  created_by_user_id: string | null;
  requester_person_id: string | null;
  owner_role_id: string | null;
  owner_user_id: string | null;
  assignee_role: string | null;

  // Timing / SLA
  due_at: string | null;
  created_at: string;
  updated_at: string;
  closed_at: string | null;
  reactivity_time: string | null;
  reactivity_deadline_at: string | null;
  escalation_level: number;

  // Domain-specific payload
  metadata: TaskMetadata;
}


=== FILE 11/22: apps/web/src/screens/admin/cases/AdminCaseOverviewPage.tsx ===

import React from "react";
import { useAdminCaseOverviewQuery } from "../../../store/services/orgoApi";

type CaseStatus = "open" | "in_progress" | "resolved" | "archived";

type CaseSeverity = "minor" | "moderate" | "major" | "critical";

type TimeFilter = "all" | "7d" | "30d" | "90d" | "180d" | "365d";

export interface AdminCaseOverviewCase {
  case_id: string;
  organization_id: string;
  title: string;
  description?: string | null;
  label: string;
  status: CaseStatus;
  severity: CaseSeverity;
  source_type: "email" | "api" | "manual" | "sync";
  reactivity_time?: string | null;
  reactivity_deadline_at?: string | null;
  created_at: string;
  updated_at: string;
  open_tasks_count?: number;
  overdue_tasks_count?: number;
  profile_key?: string;
}

export interface AdminCaseOverviewResponse {
  cases: AdminCaseOverviewCase[];
  totalCount: number;
}

export interface AdminCaseOverviewQueryArgs {
  status?: CaseStatus;
  severity?: CaseSeverity;
  search?: string;
  profileKey?: string;
  windowDays?: number;
}

interface SummaryCounts {
  total: number;
  unresolved: number;
  overdue: number;
  critical: number;
}

const unresolvedStatuses: CaseStatus[] = [
  "open",
  "in_progress",
];

function timeFilterToDays(value: TimeFilter): number | undefined {
  switch (value) {
    case "7d":
      return 7;
    case "30d":
      return 30;
    case "90d":
      return 90;
    case "180d":
      return 180;
    case "365d":
      return 365;
    case "all":
    default:
      return undefined;
  }
}

function formatDate(dateString?: string | null): string {
  if (!dateString) {
    return "—";
  }
  const date = new Date(dateString);
  if (Number.isNaN(date.getTime())) {
    return dateString;
  }
  return date.toLocaleString();
}

function formatStatusLabel(status: CaseStatus): string {
  if (status === "in_progress") {
    return "in progress";
  }
  return status;
}

function getStatusBadgeClasses(status: CaseStatus): string {
  switch (status) {
    case "open":
      return "bg-yellow-100 text-yellow-800";
    case "in_progress":
      return "bg-blue-100 text-blue-800";
    case "resolved":
      return "bg-green-100 text-green-800";
    case "archived":
      return "bg-gray-100 text-gray-700";
    default:
      return "bg-gray-100 text-gray-800";
  }
}

function getSeverityBadgeClasses(severity: CaseSeverity): string {
  switch (severity) {
    case "critical":
      return "bg-red-100 text-red-800";
    case "major":
      return "bg-orange-100 text-orange-800";
    case "moderate":
      return "bg-yellow-100 text-yellow-800";
    case "minor":
    default:
      return "bg-blue-100 text-blue-800";
  }
}

type TableCellProps = React.PropsWithChildren<{ className?: string }>;

function Th({ children, className = "" }: TableCellProps) {
  return (
    <th
      scope="col"
      className={`px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-gray-500 ${className}`}
    >
      {children}
    </th>
  );
}

function Td({ children, className = "" }: TableCellProps) {
  return (
    <td className={`px-4 py-3 align-top text-sm text-gray-900 ${className}`}>
      {children}
    </td>
  );
}

const Badge: React.FC<{ className?: string }> = ({
  className = "",
  children,
}) => (
  <span
    className={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${className}`}
  >
    {children}
  </span>
);

function buildSummary(cases: AdminCaseOverviewCase[]): SummaryCounts {
  const now = Date.now();

  let total = 0;
  let unresolved = 0;
  let overdue = 0;
  let critical = 0;

  for (const c of cases) {
    total += 1;

    const isUnresolved = unresolvedStatuses.includes(c.status);
    if (isUnresolved) {
      unresolved += 1;
    }

    if (c.severity === "critical") {
      critical += 1;
    }

    if (isUnresolved && c.reactivity_deadline_at) {
      const deadline = new Date(c.reactivity_deadline_at).getTime();
      if (!Number.isNaN(deadline) && deadline < now) {
        overdue += 1;
      }
    }
  }

  return { total, unresolved, overdue, critical };
}

export function AdminCaseOverviewPage() {
  const [statusFilter, setStatusFilter] = React.useState<
    "all" | CaseStatus
  >("open");
  const [severityFilter, setSeverityFilter] = React.useState<
    "all" | CaseSeverity
  >("all");
  const [timeFilter, setTimeFilter] =
    React.useState<TimeFilter>("30d");
  const [searchTerm, setSearchTerm] = React.useState("");

  const queryArgs: AdminCaseOverviewQueryArgs =
    React.useMemo(() => {
      const args: AdminCaseOverviewQueryArgs = {};

      if (statusFilter !== "all") {
        args.status = statusFilter;
      }

      if (severityFilter !== "all") {
        args.severity = severityFilter;
      }

      const trimmedSearch = searchTerm.trim();
      if (trimmedSearch.length > 0) {
        args.search = trimmedSearch;
      }

      const windowDays = timeFilterToDays(timeFilter);
      if (typeof windowDays === "number") {
        args.windowDays = windowDays;
      }

      return args;
    }, [statusFilter, severityFilter, timeFilter, searchTerm]);

  const { data, isLoading, isFetching, isError, refetch } =
    useAdminCaseOverviewQuery(queryArgs);

  const cases: AdminCaseOverviewCase[] = (
    data?.cases ?? []
  ) as AdminCaseOverviewCase[];

  const summary = React.useMemo(
    () => buildSummary(cases),
    [cases]
  );

  const totalCount =
    typeof data?.totalCount === "number"
      ? data.totalCount
      : cases.length;

  return (
    <div className="px-6 py-4">
      <header className="mb-4 flex flex-col items-start justify-between gap-4 md:flex-row md:items-center">
        <div>
          <h1 className="text-2xl font-semibold text-gray-900">
            Case overview
          </h1>
          <p className="mt-1 text-sm text-gray-600">
            High-level view of Cases for cyclic reviews and
            systemic follow-up.
          </p>
        </div>
        <button
          type="button"
          onClick={() => refetch()}
          className="inline-flex items-center rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-medium shadow-sm hover:bg-gray-50"
        >
          Refresh
        </button>
      </header>

      <section
        aria-label="Case overview summary"
        className="mb-4 grid gap-3 md:grid-cols-4"
      >
        <div className="rounded-md border border-gray-200 bg-white p-4">
          <div className="text-xs font-medium uppercase text-gray-500">
            Total cases
          </div>
          <div className="mt-1 text-2xl font-semibold text-gray-900">
            {summary.total}
          </div>
          <div className="mt-1 text-xs text-gray-500">
            Across all profiles and labels
          </div>
        </div>
        <div className="rounded-md border border-yellow-100 bg-yellow-50 p-4">
          <div className="text-xs font-medium uppercase text-yellow-800">
            Unresolved
          </div>
          <div className="mt-1 text-2xl font-semibold text-yellow-900">
            {summary.unresolved}
          </div>
          <div className="mt-1 text-xs text-yellow-900">
            Open or in progress
          </div>
        </div>
        <div className="rounded-md border border-red-100 bg-red-50 p-4">
          <div className="text-xs font-medium uppercase text-red-800">
            Overdue (by reactivity)
          </div>
          <div className="mt-1 text-2xl font-semibold text-red-900">
            {summary.overdue}
          </div>
          <div className="mt-1 text-xs text-red-900">
            Past reactivity deadline and unresolved
          </div>
        </div>
        <div className="rounded-md border border-gray-200 bg-white p-4">
          <div className="text-xs font-medium uppercase text-gray-500">
            Critical severity
          </div>
          <div className="mt-1 text-2xl font-semibold text-gray-900">
            {summary.critical}
          </div>
          <div className="mt-1 text-xs text-gray-500">
            Cases marked as critical
          </div>
        </div>
      </section>

      <section
        aria-label="Filters"
        className="mb-4 grid gap-3 rounded-md border border-gray-200 bg-white p-4 md:grid-cols-4"
      >
        <div className="flex flex-col gap-1">
          <label
            htmlFor="case-search"
            className="text-xs font-medium text-gray-700"
          >
            Search
          </label>
          <input
            id="case-search"
            type="search"
            placeholder="Title, label, ID…"
            value={searchTerm}
            onChange={(event) =>
              setSearchTerm(event.target.value)
            }
            className="rounded-md border border-gray-300 px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        <div className="flex flex-col gap-1">
          <label
            htmlFor="case-status-filter"
            className="text-xs font-medium text-gray-700"
          >
            Status
          </label>
          <select
            id="case-status-filter"
            value={statusFilter}
            onChange={(event) =>
              setStatusFilter(
                event.target
                  .value as "all" | CaseStatus
              )
            }
            className="rounded-md border border-gray-300 px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="all">All statuses</option>
            <option value="open">Open</option>
            <option value="in_progress">In progress</option>
            <option value="resolved">Resolved</option>
            <option value="archived">Archived</option>
          </select>
        </div>

        <div className="flex flex-col gap-1">
          <label
            htmlFor="case-severity-filter"
            className="text-xs font-medium text-gray-700"
          >
            Severity
          </label>
          <select
            id="case-severity-filter"
            value={severityFilter}
            onChange={(event) =>
              setSeverityFilter(
                event.target
                  .value as "all" | CaseSeverity
              )
            }
            className="rounded-md border border-gray-300 px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="all">All severities</option>
            <option value="minor">Minor</option>
            <option value="moderate">Moderate</option>
            <option value="major">Major</option>
            <option value="critical">Critical</option>
          </select>
        </div>

        <div className="flex flex-col gap-1">
          <label
            htmlFor="case-window-filter"
            className="text-xs font-medium text-gray-700"
          >
            Time window
          </label>
          <select
            id="case-window-filter"
            value={timeFilter}
            onChange={(event) =>
              setTimeFilter(
                event.target.value as TimeFilter
              )
            }
            className="rounded-md border border-gray-300 px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="30d">
              Last 30 days
            </option>
            <option value="7d">Last 7 days</option>
            <option value="90d">
              Last 90 days
            </option>
            <option value="180d">
              Last 180 days
            </option>
            <option value="365d">
              Last 365 days
            </option>
            <option value="all">All time</option>
          </select>
        </div>
      </section>

      <section className="overflow-hidden rounded-md border border-gray-200 bg-white">
        {isLoading ? (
          <div className="p-6 text-sm text-gray-600">
            Loading cases…
          </div>
        ) : isError ? (
          <div className="flex items-center justify-between gap-4 p-6 text-sm text-red-700">
            <span>
              Unable to load cases. Please try again.
            </span>
            <button
              type="button"
              onClick={() => refetch()}
              className="inline-flex items-center rounded-md border border-red-300 bg-white px-3 py-1 text-xs font-medium hover:bg-red-50"
            >
              Retry
            </button>
          </div>
        ) : cases.length === 0 ? (
          <div className="p-6 text-sm text-gray-600">
            No cases match your filters.
          </div>
        ) : (
          <>
            <div className="flex items-center justify-between border-b border-gray-200 px-4 py-2 text-xs text-gray-600">
              <span>
                Showing{" "}
                <span className="font-medium">
                  {cases.length}
                </span>{" "}
                of{" "}
                <span className="font-medium">
                  {totalCount}
                </span>{" "}
                cases
              </span>
            </div>
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200 text-sm">
                <thead className="bg-gray-50">
                  <tr>
                    <Th>Case</Th>
                    <Th>Label</Th>
                    <Th>Status</Th>
                    <Th>Severity</Th>
                    <Th>Open / overdue tasks</Th>
                    <Th>Created</Th>
                    <Th>Last updated</Th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-100 bg-white">
                  {cases.map((c) => (
                    <tr key={c.case_id}>
                      <Td className="max-w-xs">
                        <div className="flex flex-col">
                          <span className="truncate text-sm font-medium text-gray-900">
                            {c.title}
                          </span>
                          <span className="mt-0.5 text-xs text-gray-500">
                            #{c.case_id.slice(0, 8)} ·{" "}
                            {c.source_type}
                          </span>
                        </div>
                      </Td>
                      <Td className="max-w-xs">
                        <div className="flex flex-col">
                          <span className="truncate text-xs text-gray-700">
                            {c.label}
                          </span>
                          {c.profile_key && (
                            <span className="mt-0.5 text-xs text-gray-400">
                              Profile: {c.profile_key}
                            </span>
                          )}
                        </div>
                      </Td>
                      <Td>
                        <Badge
                          className={getStatusBadgeClasses(
                            c.status
                          )}
                        >
                          {formatStatusLabel(c.status)}
                        </Badge>
                      </Td>
                      <Td>
                        <Badge
                          className={getSeverityBadgeClasses(
                            c.severity
                          )}
                        >
                          {c.severity}
                        </Badge>
                      </Td>
                      <Td>
                        <div className="flex flex-col text-xs">
                          <span>
                            Open:{" "}
                            {typeof c.open_tasks_count ===
                            "number"
                              ? c.open_tasks_count
                              : "—"}
                          </span>
                          <span>
                            Overdue:{" "}
                            {typeof c.overdue_tasks_count ===
                            "number"
                              ? c.overdue_tasks_count
                              : "—"}
                          </span>
                        </div>
                      </Td>
                      <Td>
                        <span className="text-xs text-gray-700">
                          {formatDate(c.created_at)}
                        </span>
                      </Td>
                      <Td>
                        <span className="text-xs text-gray-700">
                          {formatDate(c.updated_at)}
                        </span>
                      </Td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </>
        )}
        {isFetching && !isLoading && (
          <div className="border-t border-gray-100 bg-gray-50 px-4 py-2 text-xs text-gray-500">
            Updating…
          </div>
        )}
      </section>
    </div>
  );
}

export default AdminCaseOverviewPage;


=== FILE 12/22: apps/web/src/screens/admin/profiles/OrgProfileSettingsPage.tsx ===

import React, { useEffect, useMemo, useState } from "react";
import {
  // Assumed RTK Query hooks defined in apps/web/src/store/services/orgoApi.ts
  useOrgProfilesQuery,
  useProfilePreviewMutation,
  useUpdateServiceConfigMutation,
} from "../../../store/services/orgoApi";

export type OrgProfileCode =
  | "default"
  | "friend_group"
  | "hospital"
  | "advocacy_group"
  | "retail_chain"
  | "military_organization"
  | "environmental_group"
  | "artist_collective";

const PROFILE_OPTIONS: { code: OrgProfileCode; label: string; description: string }[] = [
  {
    code: "default",
    label: "Default",
    description: "Balanced defaults for reactivity, transparency, logging and pattern detection.",
  },
  {
    code: "friend_group",
    label: "Friend group",
    description: "Low‑stakes group with relaxed timing and light logging.",
  },
  {
    code: "hospital",
    label: "Hospital",
    description: "Safety‑critical environment with fast escalation and strict privacy.",
  },
  {
    code: "advocacy_group",
    label: "Advocacy group",
    description: "Mission‑driven NGO with responsive handling and strong traceability.",
  },
  {
    code: "retail_chain",
    label: "Retail chain",
    description: "Distributed operations, store‑level incidents, mixed urgency and retention.",
  },
  {
    code: "military_organization",
    label: "Military organization",
    description: "Highly sensitive context with aggressive escalation and full audit logging.",
  },
  {
    code: "environmental_group",
    label: "Environmental group",
    description: "Campaign‑driven work with high pattern sensitivity and wide signalling.",
  },
  {
    code: "artist_collective",
    label: "Artist collective",
    description: "Creative group; relaxed timing, minimal logging, low pattern sensitivity.",
  },
];

interface OrgProfileSnapshot {
  organization_id: string;
  organization_slug?: string;
  organization_display_name?: string;
  profile_code: OrgProfileCode | string;
  version?: number;
  // Shape mirrors the profiles YAML (Doc 7), using snake_case keys.
  profile: {
    description?: string;
    reactivity_seconds?: number;
    max_escalation_seconds?: number;
    transparency_level?: string;
    escalation_granularity?: string;
    review_frequency?: string;
    notification_scope?: string;
    pattern_sensitivity?: string;
    pattern_window_days?: number;
    pattern_min_events?: number;
    severity_threshold?: string;
    logging_level?: string;
    log_retention_days?: number;
    automation_level?: string;
    default_task_metadata?: {
      visibility?: string;
      default_priority?: string;
      default_reactivity_seconds?: number;
    };
    cyclic_overview?: {
      enabled?: boolean;
      schedule?: {
        weekly?: boolean;
        monthly?: boolean;
        yearly?: boolean;
      };
      threshold_triggers?: {
        incident_frequency?: {
          min_events?: number;
          window_days?: number;
        };
        cross_departmental_trends?: boolean;
        high_risk_indicators?: boolean;
      };
    };
  };
}

interface ProfilePreviewDiff {
  summary?: string;
  impact_bullets?: string[];
}

/**
 * Format seconds into a coarse human‑readable duration.
 */
function formatSeconds(value?: number): string {
  if (value == null) return "—";
  if (value < 60) return `${value}s`;
  const minutes = Math.round(value / 60);
  if (minutes < 60) return `${minutes} min`;
  const hours = Math.round(minutes / 60);
  if (hours < 24) return `${hours} h`;
  const days = Math.round(hours / 24);
  return `${days} d`;
}

/**
 * Small badge component for enum‑like values.
 */
function Pill(props: { children: React.ReactNode }) {
  return (
    <span className="inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-medium">
      {props.children}
    </span>
  );
}

/**
 * Admin view to inspect and edit organization profiles and preview their impact.
 *
 * Assumptions (to be matched by the API implementation):
 * - useOrgProfilesQuery() returns either:
 *   - the active OrgProfileSnapshot for the current organization, or
 *   - an array of OrgProfileSnapshot, where index 0 is the active one.
 * - useProfilePreviewMutation() accepts:
 *     { organizationId, currentProfileCode, proposedProfileCode }
 *   and returns { summary, impact_bullets }.
 * - useUpdateServiceConfigMutation() accepts:
 *     { module: "org_profiles", organizationId, profileCode }
 *   and persists the change with audit logging.
 */
export const OrgProfileSettingsPage: React.FC = () => {
  const { data, isLoading, isError, refetch } = useOrgProfilesQuery();

  const activeProfile: OrgProfileSnapshot | undefined = useMemo(() => {
    if (!data) return undefined;
    if (Array.isArray(data)) {
      return (data[0] ?? null) as OrgProfileSnapshot | null || undefined;
    }
    return data as OrgProfileSnapshot;
  }, [data]);

  const [selectedProfileCode, setSelectedProfileCode] = useState<OrgProfileCode | "">("");
  const [triggerPreview, { data: previewData, isLoading: isPreviewLoading }] =
    useProfilePreviewMutation();
  const [updateConfig, { isLoading: isSaving, isSuccess: isSaveSuccess, error: saveError }] =
    useUpdateServiceConfigMutation();

  const preview: ProfilePreviewDiff | undefined = previewData as ProfilePreviewDiff | undefined;

  useEffect(() => {
    if (activeProfile?.profile_code) {
      setSelectedProfileCode(activeProfile.profile_code as OrgProfileCode);
    }
  }, [activeProfile?.profile_code]);

  const organizationName =
    activeProfile?.organization_display_name ||
    activeProfile?.organization_slug ||
    "Current organization";

  const currentProfileOption = PROFILE_OPTIONS.find(
    (opt) => opt.code === activeProfile?.profile_code
  );
  const selectedProfileOption = PROFILE_OPTIONS.find((opt) => opt.code === selectedProfileCode);

  const hasChanges =
    !!activeProfile &&
    !!selectedProfileCode &&
    selectedProfileCode !== (activeProfile.profile_code as OrgProfileCode);

  const handlePreview = () => {
    if (!activeProfile || !hasChanges) return;
    triggerPreview({
      organizationId: activeProfile.organization_id,
      currentProfileCode: activeProfile.profile_code,
      proposedProfileCode: selectedProfileCode,
    });
  };

  const handleSave = () => {
    if (!activeProfile || !selectedProfileCode) return;
    updateConfig({
      module: "org_profiles",
      organizationId: activeProfile.organization_id,
      profileCode: selectedProfileCode,
    });
  };

  if (isLoading) {
    return (
      <div className="p-6">
        <h1 className="mb-4 text-2xl font-semibold">Organization profile</h1>
        <p className="text-sm text-gray-600">Loading profile…</p>
      </div>
    );
  }

  if (isError || !activeProfile) {
    return (
      <div className="p-6">
        <h1 className="mb-4 text-2xl font-semibold">Organization profile</h1>
        <div className="rounded-md border border-red-200 bg-red-50 p-4 text-sm text-red-800">
          <p className="mb-2">Could not load the organization profile.</p>
          <button
            type="button"
            onClick={() => refetch()}
            className="rounded border px-3 py-1 text-xs font-medium"
          >
            Retry
          </button>
        </div>
      </div>
    );
  }

  const p = activeProfile.profile;

  return (
    <div className="p-6">
      <header className="mb-6 space-y-2">
        <h1 className="text-2xl font-semibold">Organization profile</h1>
        <p className="max-w-2xl text-sm text-gray-600">
          Profiles control how quickly work escalates, who can see it, how long records are kept,
          and how sensitive pattern detection is for{" "}
          <span className="font-medium">{organizationName}</span>.
        </p>
      </header>

      <div className="grid gap-6 lg:grid-cols-3">
        {/* Current profile summary */}
        <section className="lg:col-span-2 space-y-4 rounded-lg border bg-white p-4">
          <div className="flex items-start justify-between gap-4">
            <div>
              <p className="text-xs font-medium uppercase text-gray-500">
                Active profile archetype
              </p>
              <div className="mt-1 flex items-center gap-2">
                <span className="text-lg font-semibold">
                  {currentProfileOption?.label || activeProfile.profile_code}
                </span>
                <Pill>{activeProfile.profile_code}</Pill>
                {typeof activeProfile.version === "number" && (
                  <span className="text-xs text-gray-500">v{activeProfile.version}</span>
                )}
              </div>
              {p.description && (
                <p className="mt-1 max-w-xl text-sm text-gray-600">{p.description}</p>
              )}
            </div>
          </div>

          <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Reactivity</p>
              <p className="mt-1 text-sm">
                First escalation in{" "}
                <span className="font-medium">{formatSeconds(p.reactivity_seconds)}</span>
              </p>
              <p className="text-xs text-gray-500">
                Max escalation: {formatSeconds(p.max_escalation_seconds)}
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Transparency</p>
              <p className="mt-1 text-sm">
                <Pill>{p.transparency_level || "—"}</Pill>
              </p>
              <p className="text-xs text-gray-500">
                Escalation granularity: {p.escalation_granularity || "—"}
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Reviews</p>
              <p className="mt-1 text-sm">
                <Pill>{p.review_frequency || "—"}</Pill>
              </p>
              <p className="text-xs text-gray-500">
                Notification scope: {p.notification_scope || "—"}
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Patterns</p>
              <p className="mt-1 text-sm">
                Sensitivity: <Pill>{p.pattern_sensitivity || "—"}</Pill>
              </p>
              <p className="text-xs text-gray-500">
                Window: {p.pattern_window_days ?? "—"} days, min events:{" "}
                {p.pattern_min_events ?? "—"}
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Logging & retention</p>
              <p className="mt-1 text-sm">
                Logging: <Pill>{p.logging_level || "—"}</Pill>
              </p>
              <p className="text-xs text-gray-500">
                Log retention: {p.log_retention_days != null ? `${p.log_retention_days} days` : "—"}
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Automation</p>
              <p className="mt-1 text-sm">
                Level: <Pill>{p.automation_level || "—"}</Pill>
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Default Task metadata</p>
              <p className="mt-1 text-sm">
                Visibility:{" "}
                <Pill>{p.default_task_metadata?.visibility?.toLowerCase() || "—"}</Pill>
              </p>
              <p className="text-xs text-gray-500">
                Priority: {p.default_task_metadata?.default_priority || "—"},{" "}
                reactivity:{" "}
                {formatSeconds(p.default_task_metadata?.default_reactivity_seconds ?? undefined)}
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Cyclic overview</p>
              <p className="mt-1 text-sm">
                {p.cyclic_overview?.enabled ? (
                  <Pill>enabled</Pill>
                ) : (
                  <Pill>disabled</Pill>
                )}
              </p>
              <p className="text-xs text-gray-500">
                Schedule:{" "}
                {[
                  p.cyclic_overview?.schedule?.weekly && "weekly",
                  p.cyclic_overview?.schedule?.monthly && "monthly",
                  p.cyclic_overview?.schedule?.yearly && "yearly",
                ]
                  .filter(Boolean)
                  .join(", ") || "—"}
              </p>
            </div>
          </div>
        </section>

        {/* Edit + preview column */}
        <section className="space-y-4 rounded-lg border bg-white p-4">
          <div>
            <p className="text-xs font-medium uppercase text-gray-500">Select profile archetype</p>
            <label className="mt-2 block text-sm">
              <span className="mb-1 block text-gray-700">Archetype</span>
              <select
                value={selectedProfileCode}
                onChange={(e) => setSelectedProfileCode(e.target.value as OrgProfileCode)}
                className="mt-1 block w-full rounded-md border px-3 py-2 text-sm"
              >
                {PROFILE_OPTIONS.map((option) => (
                  <option key={option.code} value={option.code}>
                    {option.label}
                  </option>
                ))}
              </select>
            </label>
            {selectedProfileOption && (
              <p className="mt-2 text-xs text-gray-500">{selectedProfileOption.description}</p>
            )}
          </div>

          <div className="flex flex-col gap-2 border-t pt-4 text-sm">
            <div className="flex flex-wrap items-center gap-2">
              <button
                type="button"
                onClick={handlePreview}
                disabled={!hasChanges || isPreviewLoading}
                className="rounded-md border px-3 py-1 text-xs font-medium disabled:opacity-60"
              >
                {isPreviewLoading ? "Previewing…" : "Preview impact"}
              </button>
              <button
                type="button"
                onClick={handleSave}
                disabled={!hasChanges || isSaving}
                className="rounded-md bg-black px-3 py-1 text-xs font-medium text-white disabled:opacity-60"
              >
                {isSaving ? "Saving…" : "Apply change"}
              </button>
            </div>

            {isSaveSuccess && (
              <p className="text-xs text-green-700">Profile updated. New defaults will apply to future Tasks and Cases.</p>
            )}
            {saveError && (
              <p className="text-xs text-red-700">
                Failed to save changes. Please try again or check configuration logs.
              </p>
            )}
          </div>

          <div className="border-t pt-4">
            <p className="mb-2 text-xs font-medium uppercase text-gray-500">Preview</p>
            {!preview && !isPreviewLoading && (
              <p className="text-xs text-gray-500">
                Choose a different profile and click &ldquo;Preview impact&rdquo; to see how escalation,
                visibility, retention and patterns would change.
              </p>
            )}

            {preview && (
              <div className="space-y-2 text-xs">
                {preview.summary && <p className="text-gray-700">{preview.summary}</p>}
                {preview.impact_bullets && preview.impact_bullets.length > 0 && (
                  <ul className="list-disc space-y-1 pl-4 text-gray-700">
                    {preview.impact_bullets.map((item, index) => (
                      <li key={index}>{item}</li>
                    ))}
                  </ul>
                )}
              </div>
            )}
          </div>
        </section>
      </div>
    </div>
  );
};

export default OrgProfileSettingsPage;


=== FILE 13/22: apps/web/src/screens/admin/tasks/AdminTaskOverviewPage.tsx ===

import { useMemo, useState, ChangeEvent } from "react";
import { useAdminTaskOverviewQuery } from "../../../store/services/orgoApi";

type TaskStatus =
  | "PENDING"
  | "IN_PROGRESS"
  | "ON_HOLD"
  | "COMPLETED"
  | "FAILED"
  | "ESCALATED"
  | "CANCELLED";

type TaskPriority = "LOW" | "MEDIUM" | "HIGH" | "CRITICAL";

type TaskSeverity = "MINOR" | "MODERATE" | "MAJOR" | "CRITICAL";

type TaskCategory = "request" | "incident" | "update" | "report" | "distribution";

type FilterStatusOption = TaskStatus | "ALL";
type FilterPriorityOption = TaskPriority | "ALL";
type FilterSeverityOption = TaskSeverity | "ALL";
type FilterCategoryOption = TaskCategory | "ALL";

interface AdminTaskOverviewFilters {
  status: FilterStatusOption;
  priority: FilterPriorityOption;
  severity: FilterSeverityOption;
  category: FilterCategoryOption;
  type: string; // domain type, e.g. "maintenance", "hr_case"
  role: string; // assignee/owner role label
  labelSearch: string; // free‑text search over label/title
}

interface AdminTaskOverviewTask {
  task_id: string;
  organization_id: string;
  case_id: string | null;
  source: "email" | "api" | "manual" | "sync";
  type: string;
  category: TaskCategory;
  label: string;
  title: string;
  status: TaskStatus;
  priority: TaskPriority;
  severity: TaskSeverity;
  visibility: "PUBLIC" | "INTERNAL" | "RESTRICTED" | "ANONYMISED";
  assignee_role: string | null;
  owner_role_id: string | null;
  owner_user_id: string | null;
  reactivity_deadline_at: string | null;
  created_at: string;
}

interface AdminTaskOverviewResponse {
  tasks: AdminTaskOverviewTask[];
  total: number;
  page: number;
  pageSize: number;
}

/**
 * Query args passed to useAdminTaskOverviewQuery.
 * The orgoApi slice should accept this shape and translate it
 * to the backend /api/v3/tasks admin listing with filters.
 */
interface AdminTaskOverviewQueryArgs {
  page: number;
  pageSize: number;
  status?: TaskStatus;
  priority?: TaskPriority;
  severity?: TaskSeverity;
  category?: TaskCategory;
  type?: string;
  role?: string;
  labelSearch?: string;
}

const DEFAULT_PAGE_SIZE = 25;

const STATUS_OPTIONS: FilterStatusOption[] = [
  "ALL",
  "PENDING",
  "IN_PROGRESS",
  "ON_HOLD",
  "ESCALATED",
  "COMPLETED",
  "FAILED",
  "CANCELLED",
];

const PRIORITY_OPTIONS: FilterPriorityOption[] = ["ALL", "LOW", "MEDIUM", "HIGH", "CRITICAL"];

const SEVERITY_OPTIONS: FilterSeverityOption[] = ["ALL", "MINOR", "MODERATE", "MAJOR", "CRITICAL"];

const CATEGORY_OPTIONS: FilterCategoryOption[] = [
  "ALL",
  "request",
  "incident",
  "update",
  "report",
  "distribution",
];

function getStatusBadgeClasses(status: TaskStatus): string {
  switch (status) {
    case "PENDING":
      return "bg-gray-100 text-gray-800";
    case "IN_PROGRESS":
      return "bg-blue-100 text-blue-800";
    case "ON_HOLD":
      return "bg-yellow-100 text-yellow-800";
    case "ESCALATED":
      return "bg-red-100 text-red-800 border border-red-300";
    case "COMPLETED":
      return "bg-green-100 text-green-800";
    case "FAILED":
      return "bg-red-100 text-red-800";
    case "CANCELLED":
      return "bg-gray-200 text-gray-700";
    default:
      return "bg-gray-100 text-gray-800";
  }
}

function getPriorityBadgeClasses(priority: TaskPriority): string {
  switch (priority) {
    case "LOW":
      return "bg-gray-100 text-gray-800";
    case "MEDIUM":
      return "bg-sky-100 text-sky-800";
    case "HIGH":
      return "bg-orange-100 text-orange-800";
    case "CRITICAL":
      return "bg-red-100 text-red-800";
    default:
      return "bg-gray-100 text-gray-800";
  }
}

function getSeverityBadgeClasses(severity: TaskSeverity): string {
  switch (severity) {
    case "MINOR":
      return "bg-gray-100 text-gray-800";
    case "MODERATE":
      return "bg-amber-100 text-amber-800";
    case "MAJOR":
      return "bg-orange-100 text-orange-800";
    case "CRITICAL":
      return "bg-red-100 text-red-800";
    default:
      return "bg-gray-100 text-gray-800";
  }
}

function isUnresolvedStatus(status: TaskStatus): boolean {
  return ["PENDING", "IN_PROGRESS", "ON_HOLD", "ESCALATED"].includes(status);
}

function isOverdue(task: AdminTaskOverviewTask): boolean {
  if (!task.reactivity_deadline_at) return false;
  if (!isUnresolvedStatus(task.status)) return false;
  const deadline = new Date(task.reactivity_deadline_at).getTime();
  if (Number.isNaN(deadline)) return false;
  return Date.now() > deadline;
}

function formatDate(value: string | null | undefined): string {
  if (!value) return "—";
  const d = new Date(value);
  if (Number.isNaN(d.getTime())) return "—";
  return d.toLocaleString();
}

function truncateLabel(label: string, max = 40): string {
  if (label.length <= max) return label;
  return `${label.slice(0, max - 1)}…`;
}

const AdminTaskOverviewPage = () => {
  const [filters, setFilters] = useState<AdminTaskOverviewFilters>({
    status: "ALL",
    priority: "ALL",
    severity: "ALL",
    category: "ALL",
    type: "",
    role: "",
    labelSearch: "",
  });

  const [page, setPage] = useState(1);

  const queryArgs: AdminTaskOverviewQueryArgs = useMemo(() => {
    const args: AdminTaskOverviewQueryArgs = {
      page,
      pageSize: DEFAULT_PAGE_SIZE,
    };

    if (filters.status !== "ALL") {
      args.status = filters.status;
    }

    if (filters.priority !== "ALL") {
      args.priority = filters.priority;
    }

    if (filters.severity !== "ALL") {
      args.severity = filters.severity;
    }

    if (filters.category !== "ALL") {
      args.category = filters.category;
    }

    if (filters.type.trim()) {
      args.type = filters.type.trim();
    }

    if (filters.role.trim()) {
      args.role = filters.role.trim();
    }

    if (filters.labelSearch.trim()) {
      args.labelSearch = filters.labelSearch.trim();
    }

    return args;
  }, [filters, page]);

  // Cast to the expected response type for local usage; the orgoApi slice
  // should be implemented so that this cast matches the real response.
  const {
    data,
    isLoading,
    isError,
    refetch,
    isFetching,
  } = useAdminTaskOverviewQuery(queryArgs) as {
    data?: AdminTaskOverviewResponse;
    isLoading: boolean;
    isError: boolean;
    isFetching: boolean;
    refetch: () => void;
  };

  const tasks = data?.tasks ?? [];
  const total = data?.total ?? 0;
  const pageSize = data?.pageSize ?? DEFAULT_PAGE_SIZE;
  const totalPages = total > 0 ? Math.max(1, Math.ceil(total / pageSize)) : 1;

  const { openCount, overdueCount } = useMemo(() => {
    let open = 0;
    let overdue = 0;
    for (const t of tasks) {
      if (isUnresolvedStatus(t.status)) {
        open += 1;
        if (isOverdue(t)) {
          overdue += 1;
        }
      }
    }
    return { openCount: open, overdueCount: overdue };
  }, [tasks]);

  const handleSelectChange =
    <K extends keyof AdminTaskOverviewFilters>(key: K) =>
    (event: ChangeEvent<HTMLSelectElement>) => {
      const value = event.target.value as AdminTaskOverviewFilters[K];
      setPage(1);
      setFilters((prev) => ({
        ...prev,
        [key]: value,
      }));
    };

  const handleInputChange =
    <K extends keyof AdminTaskOverviewFilters>(key: K) =>
    (event: ChangeEvent<HTMLInputElement>) => {
      const value = event.target.value as AdminTaskOverviewFilters[K];
      setPage(1);
      setFilters((prev) => ({
        ...prev,
        [key]: value,
      }));
    };

  const canGoPrev = page > 1;
  const canGoNext = page < totalPages;

  return (
    <div className="min-h-screen bg-gray-50 px-4 py-6 sm:px-6 lg:px-8">
      <div className="mb-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h1 className="text-2xl font-semibold text-gray-900">Admin Task Overview</h1>
          <p className="mt-1 text-sm text-gray-600">
            Cross-domain task queues with filters by status, domain type, label, role, priority, and
            severity.
          </p>
        </div>
        <button
          type="button"
          onClick={() => refetch()}
          className="inline-flex items-center justify-center rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50"
        >
          {isFetching ? "Refreshing…" : "Refresh"}
        </button>
      </div>

      <div className="mb-4 grid gap-3 md:grid-cols-3 lg:grid-cols-6">
        <div className="flex flex-col">
          <label className="mb-1 text-xs font-medium text-gray-700" htmlFor="status">
            Status
          </label>
          <select
            id="status"
            className="block w-full rounded-md border border-gray-300 bg-white px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            value={filters.status}
            onChange={handleSelectChange("status")}
          >
            {STATUS_OPTIONS.map((option) => (
              <option key={option} value={option}>
                {option === "ALL" ? "All statuses" : option.replace("_", " ")}
              </option>
            ))}
          </select>
        </div>

        <div className="flex flex-col">
          <label className="mb-1 text-xs font-medium text-gray-700" htmlFor="priority">
            Priority
          </label>
          <select
            id="priority"
            className="block w-full rounded-md border border-gray-300 bg-white px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            value={filters.priority}
            onChange={handleSelectChange("priority")}
          >
            {PRIORITY_OPTIONS.map((option) => (
              <option key={option} value={option}>
                {option === "ALL" ? "All priorities" : option}
              </option>
            ))}
          </select>
        </div>

        <div className="flex flex-col">
          <label className="mb-1 text-xs font-medium text-gray-700" htmlFor="severity">
            Severity
          </label>
          <select
            id="severity"
            className="block w-full rounded-md border border-gray-300 bg-white px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            value={filters.severity}
            onChange={handleSelectChange("severity")}
          >
            {SEVERITY_OPTIONS.map((option) => (
              <option key={option} value={option}>
                {option === "ALL" ? "All severities" : option}
              </option>
            ))}
          </select>
        </div>

        <div className="flex flex-col">
          <label className="mb-1 text-xs font-medium text-gray-700" htmlFor="category">
            Category
          </label>
          <select
            id="category"
            className="block w-full rounded-md border border-gray-300 bg-white px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            value={filters.category}
            onChange={handleSelectChange("category")}
          >
            {CATEGORY_OPTIONS.map((option) => (
              <option key={option} value={option}>
                {option === "ALL"
                  ? "All categories"
                  : option.charAt(0).toUpperCase() + option.slice(1)}
              </option>
            ))}
          </select>
        </div>

        <div className="flex flex-col">
          <label className="mb-1 text-xs font-medium text-gray-700" htmlFor="type">
            Domain type
          </label>
          <input
            id="type"
            type="text"
            placeholder="e.g. maintenance, hr_case"
            className="block w-full rounded-md border border-gray-300 bg-white px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            value={filters.type}
            onChange={handleInputChange("type")}
          />
        </div>

        <div className="flex flex-col">
          <label className="mb-1 text-xs font-medium text-gray-700" htmlFor="role">
            Role or label search
          </label>
          <input
            id="role"
            type="text"
            placeholder="role or label fragment"
            className="block w-full rounded-md border border-gray-300 bg-white px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            value={filters.labelSearch}
            onChange={handleInputChange("labelSearch")}
          />
        </div>
      </div>

      <div className="mb-4 flex flex-wrap items-center gap-3 text-sm text-gray-700">
        <span>
          <span className="font-medium">{total}</span> tasks
        </span>
        <span className="hidden text-gray-400 sm:inline">•</span>
        <span>
          <span className="font-medium">{openCount}</span> unresolved
        </span>
        <span className="hidden text-gray-400 sm:inline">•</span>
        <span>
          <span className="font-medium">{overdueCount}</span> overdue by reactivity deadline
        </span>
        {isLoading && <span className="ml-auto text-xs text-gray-500">Loading…</span>}
        {isError && !isLoading && (
          <span className="ml-auto text-xs text-red-600">
            Error loading tasks. Try adjusting filters or refreshing.
          </span>
        )}
      </div>

      <div className="overflow-x-auto rounded-lg border border-gray-200 bg-white shadow-sm">
        <table className="min-w-full divide-y divide-gray-200 text-left text-sm">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-4 py-3 font-medium text-gray-700">Status</th>
              <th className="px-4 py-3 font-medium text-gray-700">Priority</th>
              <th className="px-4 py-3 font-medium text-gray-700">Severity</th>
              <th className="px-4 py-3 font-medium text-gray-700">Title</th>
              <th className="px-4 py-3 font-medium text-gray-700">Type / Category</th>
              <th className="px-4 py-3 font-medium text-gray-700">Label</th>
              <th className="px-4 py-3 font-medium text-gray-700">Assignee role</th>
              <th className="px-4 py-3 font-medium text-gray-700">React. deadline</th>
              <th className="px-4 py-3 font-medium text-gray-700">Created</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-100 bg-white">
            {isLoading && tasks.length === 0 ? (
              <tr>
                <td className="px-4 py-6 text-center text-sm text-gray-500" colSpan={9}>
                  Loading tasks…
                </td>
              </tr>
            ) : tasks.length === 0 ? (
              <tr>
                <td className="px-4 py-6 text-center text-sm text-gray-500" colSpan={9}>
                  No tasks match the current filters.
                </td>
              </tr>
            ) : (
              tasks.map((task) => {
                const overdue = isOverdue(task);
                return (
                  <tr key={task.task_id} className={overdue ? "bg-red-50" : undefined}>
                    <td className="whitespace-nowrap px-4 py-3">
                      <span
                        className={`inline-flex rounded-full px-2.5 py-0.5 text-xs font-medium ${getStatusBadgeClasses(
                          task.status
                        )}`}
                      >
                        {task.status.replace("_", " ")}
                      </span>
                    </td>
                    <td className="whitespace-nowrap px-4 py-3">
                      <span
                        className={`inline-flex rounded-full px-2.5 py-0.5 text-xs font-medium ${getPriorityBadgeClasses(
                          task.priority
                        )}`}
                      >
                        {task.priority}
                      </span>
                    </td>
                    <td className="whitespace-nowrap px-4 py-3">
                      <span
                        className={`inline-flex rounded-full px-2.5 py-0.5 text-xs font-medium ${getSeverityBadgeClasses(
                          task.severity
                        )}`}
                      >
                        {task.severity}
                      </span>
                    </td>
                    <td className="max-w-xs px-4 py-3">
                      <div className="truncate text-sm text-gray-900">{task.title}</div>
                    </td>
                    <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-700">
                      <div className="flex flex-col">
                        <span className="font-medium">{task.type}</span>
                        <span className="text-xs text-gray-500">{task.category}</span>
                      </div>
                    </td>
                    <td className="max-w-xs px-4 py-3 text-sm text-gray-700">
                      <span title={task.label} className="block truncate">
                        {truncateLabel(task.label)}
                      </span>
                    </td>
                    <td className="max-w-xs px-4 py-3 text-sm text-gray-700">
                      {task.assignee_role ? (
                        <span className="block truncate">{task.assignee_role}</span>
                      ) : (
                        <span className="text-gray-400">Unassigned</span>
                      )}
                    </td>
                    <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-700">
                      <div className="flex flex-col">
                        <span>{formatDate(task.reactivity_deadline_at)}</span>
                        {overdue && (
                          <span className="text-xs font-medium text-red-600">Overdue</span>
                        )}
                      </div>
                    </td>
                    <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-700">
                      {formatDate(task.created_at)}
                    </td>
                  </tr>
                );
              })
            )}
          </tbody>
        </table>
      </div>

      <div className="mt-4 flex flex-col items-center justify-between gap-3 text-sm text-gray-700 sm:flex-row">
        <div>
          Page{" "}
          <span className="font-medium">
            {Math.min(page, totalPages)} / {totalPages}
          </span>
          {total > 0 && (
            <span className="ml-2 text-gray-500">
              • Showing {(page - 1) * pageSize + 1}–
              {Math.min(page * pageSize, total)} of {total}
            </span>
          )}
        </div>
        <div className="inline-flex items-center gap-2">
          <button
            type="button"
            disabled={!canGoPrev}
            onClick={() => canGoPrev && setPage((p) => p - 1)}
            className="inline-flex items-center rounded-md border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:cursor-not-allowed disabled:bg-gray-100 disabled:text-gray-400"
          >
            Previous
          </button>
          <button
            type="button"
            disabled={!canGoNext}
            onClick={() => canGoNext && setPage((p) => p + 1)}
            className="inline-flex items-center rounded-md border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:cursor-not-allowed disabled:bg-gray-100 disabled:text-gray-400"
          >
            Next
          </button>
        </div>
      </div>
    </div>
  );
};

export default AdminTaskOverviewPage;


=== FILE 14/22: apps/web/src/screens/auth/login/login.tsx ===

import { Button } from "ui";

export function LoginScreen() {
  return (
    <div>
      Login Screen <Button />
    </div>
  );
}


=== FILE 15/22: apps/web/src/screens/insights/InsightsOverviewPage.tsx ===

// apps/web/src/screens/insights/InsightsOverviewPage.tsx

import React, { useMemo, useState } from "react";
import { useInsightsOverviewQuery } from "../../store/services/orgoApi";

type TaskStatus =
  | "PENDING"
  | "IN_PROGRESS"
  | "ON_HOLD"
  | "COMPLETED"
  | "FAILED"
  | "ESCALATED"
  | "CANCELLED";

type TimeFilter = "7d" | "30d" | "90d" | "180d" | "365d" | "all";

/**
 * One bucket in the task volume report – counts per day and status.
 * Mirrors the backend TaskVolumeBucket shape from the reports service.
 */
interface TaskVolumeBucket {
  date: string; // ISO date (YYYY-MM-DD)
  status: TaskStatus;
  count: number;
}

/**
 * Aggregated SLA breach data per domain (Task.type).
 * Mirrors the backend SlaBreachRow shape.
 */
interface SlaBreachRow {
  domainType: string;
  totalTasks: number;
  breachedTasks: number;
  breachRate: number; // 0–1
}

/**
 * Overall profile effectiveness score plus per-domain breakdown.
 * Mirrors the backend ProfileScore shape.
 */
interface ProfileScore {
  organizationId: string;
  fromDate: string; // ISO date (YYYY-MM-DD)
  toDate: string; // ISO date (YYYY-MM-DD)
  overallTasks: number;
  overallBreachedTasks: number;
  overallScore: number; // 0–100, 100 = no breaches
  perDomain: SlaBreachRow[];
}

/**
 * Combined payload returned by useInsightsOverviewQuery.
 * The orgoApi slice should implement this shape.
 */
interface InsightsOverviewResponse {
  taskVolume: TaskVolumeBucket[];
  profileScore: ProfileScore | null;
}

/**
 * Query args passed to useInsightsOverviewQuery.
 * The orgoApi slice should accept this shape and translate it to
 * the underlying reporting API (task volume + profile score).
 */
interface InsightsOverviewQueryArgs {
  /**
   * Lookback window in days (e.g. 7, 30, 90). When omitted, the
   * backend should apply its default window (e.g. 30 days).
   */
  windowDays?: number;
  /**
   * Optional domain type filter (e.g. "maintenance", "hr_case").
   * Used consistently across volume and SLA/profile reports.
   */
  type?: string;
}

interface DailyVolume {
  date: string; // ISO date (YYYY-MM-DD)
  total: number;
}

const UNRESOLVED_STATUSES: TaskStatus[] = [
  "PENDING",
  "IN_PROGRESS",
  "ON_HOLD",
  "ESCALATED",
];

function timeFilterToDays(value: TimeFilter): number | undefined {
  switch (value) {
    case "7d":
      return 7;
    case "30d":
      return 30;
    case "90d":
      return 90;
    case "180d":
      return 180;
    case "365d":
      return 365;
    case "all":
    default:
      return undefined;
  }
}

function buildDailyVolume(buckets: TaskVolumeBucket[]): DailyVolume[] {
  const map = new Map<string, number>();

  for (const bucket of buckets) {
    const current = map.get(bucket.date) ?? 0;
    map.set(bucket.date, current + bucket.count);
  }

  return Array.from(map.entries())
    .map(([date, total]) => ({ date, total }))
    .sort((a, b) => (a.date < b.date ? -1 : a.date > b.date ? 1 : 0));
}

function formatShortDate(value: string): string {
  const d = new Date(value);
  if (Number.isNaN(d.getTime())) return value;
  return d.toLocaleDateString(undefined, {
    month: "short",
    day: "numeric",
  });
}

function formatDateRange(from?: string, to?: string): string {
  if (!from && !to) return "—";
  const fromLabel = from ? formatShortDate(from) : "…";
  const toLabel = to ? formatShortDate(to) : "…";
  if (fromLabel === toLabel) return fromLabel;
  return `${fromLabel} – ${toLabel}`;
}

function formatPercent(value: number | undefined, digits = 1): string {
  if (value == null || Number.isNaN(value)) return "—";
  const pct = value * 100;
  return `${pct.toFixed(digits)}%`;
}

function getScoreLabel(score: number | undefined): string {
  if (score == null || Number.isNaN(score)) return "Unknown";
  if (score >= 90) return "Excellent";
  if (score >= 75) return "Good";
  if (score >= 60) return "Watch";
  return "At risk";
}

function getScoreBadgeClasses(score: number | undefined): string {
  if (score == null || Number.isNaN(score)) {
    return "bg-gray-100 text-gray-700";
  }
  if (score >= 90) {
    return "bg-green-100 text-green-800";
  }
  if (score >= 75) {
    return "bg-emerald-100 text-emerald-800";
  }
  if (score >= 60) {
    return "bg-yellow-100 text-yellow-800";
  }
  return "bg-red-100 text-red-800";
}

function getBreachBadgeClasses(rate: number): string {
  if (rate >= 0.4) return "bg-red-100 text-red-800";
  if (rate >= 0.25) return "bg-orange-100 text-orange-800";
  if (rate >= 0.1) return "bg-yellow-100 text-yellow-800";
  return "bg-green-100 text-green-800";
}

const InsightsOverviewPage: React.FC = () => {
  const [timeFilter, setTimeFilter] = useState<TimeFilter>("30d");
  const [domainType, setDomainType] = useState("");

  const queryArgs: InsightsOverviewQueryArgs = useMemo(() => {
    const args: InsightsOverviewQueryArgs = {};
    const windowDays = timeFilterToDays(timeFilter);
    if (typeof windowDays === "number") {
      args.windowDays = windowDays;
    }
    const trimmedType = domainType.trim();
    if (trimmedType.length > 0) {
      args.type = trimmedType;
    }
    return args;
  }, [timeFilter, domainType]);

  // Cast to the expected response type for local usage; the orgoApi slice
  // should be implemented so that this cast matches the real response.
  const { data, isLoading, isError, isFetching, refetch } =
    useInsightsOverviewQuery(queryArgs) as {
      data?: InsightsOverviewResponse;
      isLoading: boolean;
      isError: boolean;
      isFetching: boolean;
      refetch: () => void;
    };

  const taskVolume = data?.taskVolume ?? [];
  const profileScore = data?.profileScore ?? null;

  const dailyVolume = useMemo(
    () => buildDailyVolume(taskVolume),
    [taskVolume]
  );

  const maxDailyVolume = useMemo(
    () =>
      dailyVolume.reduce(
        (max, bucket) => (bucket.total > max ? bucket.total : max),
        0
      ),
    [dailyVolume]
  );

  const {
    totalTasksInWindow,
    unresolvedApprox,
    breachRate,
    highRiskDomainCount,
  } = useMemo(() => {
    const totalTasks = taskVolume.reduce(
      (sum, bucket) => sum + bucket.count,
      0
    );

    const unresolvedApproxCount = taskVolume.reduce(
      (sum, bucket) =>
        UNRESOLVED_STATUSES.includes(bucket.status)
          ? sum + bucket.count
          : sum,
      0
    );

    const overallTasks =
      profileScore?.overallTasks && profileScore.overallTasks > 0
        ? profileScore.overallTasks
        : totalTasks;

    const overallBreached = profileScore?.overallBreachedTasks ?? 0;
    const rate =
      overallTasks > 0 ? overallBreached / overallTasks : 0;

    const highRiskDomains =
      profileScore?.perDomain?.filter(
        (row) => row.breachRate >= 0.25
      ).length ?? 0;

    return {
      totalTasksInWindow: overallTasks,
      unresolvedApprox: unresolvedApproxCount,
      breachRate: rate,
      highRiskDomainCount: highRiskDomains,
    };
  }, [taskVolume, profileScore]);

  const perDomain = useMemo(() => {
    const rows = profileScore?.perDomain ?? [];
    return [...rows].sort(
      (a, b) => b.breachRate - a.breachRate
    );
  }, [profileScore]);

  const hasAnyData =
    dailyVolume.length > 0 ||
    (profileScore != null &&
      (profileScore.overallTasks > 0 ||
        profileScore.perDomain.length > 0));

  return (
    <div className="px-6 py-4">
      <header className="mb-4 flex flex-col items-start justify-between gap-4 md:flex-row md:items-center">
        <div>
          <h1 className="text-2xl font-semibold text-gray-900">
            Insights overview
          </h1>
          <p className="mt-1 text-sm text-gray-600">
            Task volume, SLA health and profile effectiveness for
            this organization.
          </p>
        </div>
        <div className="flex flex-wrap items-end gap-3">
          <div className="flex flex-col gap-1">
            <label
              htmlFor="insights-window"
              className="text-xs font-medium text-gray-700"
            >
              Window
            </label>
            <select
              id="insights-window"
              value={timeFilter}
              onChange={(event) =>
                setTimeFilter(
                  event.target.value as TimeFilter
                )
              }
              className="rounded-md border border-gray-300 px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            >
              <option value="7d">Last 7 days</option>
              <option value="30d">Last 30 days</option>
              <option value="90d">Last 90 days</option>
              <option value="180d">Last 180 days</option>
              <option value="365d">Last 12 months</option>
              <option value="all">All available</option>
            </select>
          </div>

          <div className="flex flex-col gap-1">
            <label
              htmlFor="insights-domain-type"
              className="text-xs font-medium text-gray-700"
            >
              Domain type
            </label>
            <input
              id="insights-domain-type"
              type="text"
              value={domainType}
              onChange={(event) =>
                setDomainType(event.target.value)
              }
              placeholder='e.g. "maintenance", "hr_case"'
              className="w-44 rounded-md border border-gray-300 px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            />
          </div>

          <button
            type="button"
            onClick={() => refetch()}
            className="inline-flex items-center rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-medium shadow-sm hover:bg-gray-50"
          >
            Refresh
          </button>
        </div>
      </header>

      {isError && (
        <div className="mb-4 rounded-md border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-800">
          Failed to load insights. Please try again or adjust
          the filters.
        </div>
      )}

      {isLoading && !hasAnyData && (
        <div className="mb-4 rounded-md border border-gray-200 bg-white px-3 py-2 text-sm text-gray-600">
          Loading insights…
        </div>
      )}

      {/* Summary cards */}
      {hasAnyData && (
        <section
          aria-label="Insights overview summary"
          className="mb-4 grid gap-3 md:grid-cols-4"
        >
          <div className="rounded-md border border-gray-200 bg-white p-4">
            <div className="text-xs font-medium uppercase text-gray-500">
              Tasks in window
            </div>
            <div className="mt-1 text-2xl font-semibold text-gray-900">
              {totalTasksInWindow}
            </div>
            <div className="mt-1 text-xs text-gray-500">
              Across all included domains
            </div>
          </div>

          <div className="rounded-md border border-yellow-100 bg-yellow-50 p-4">
            <div className="text-xs font-medium uppercase text-yellow-800">
              Unresolved (approx.)
            </div>
            <div className="mt-1 text-2xl font-semibold text-yellow-900">
              {unresolvedApprox}
            </div>
            <div className="mt-1 text-xs text-yellow-900">
              Based on current status distribution
            </div>
          </div>

          <div className="rounded-md border border-red-100 bg-red-50 p-4">
            <div className="text-xs font-medium uppercase text-red-800">
              SLA breach rate
            </div>
            <div className="mt-1 text-2xl font-semibold text-red-900">
              {formatPercent(breachRate, 1)}
            </div>
            <div className="mt-1 text-xs text-red-900">
              Share of tasks breaching profile SLAs
            </div>
          </div>

          <div className="rounded-md border border-gray-200 bg-white p-4">
            <div className="flex items-center justify-between gap-2">
              <div className="text-xs font-medium uppercase text-gray-500">
                Profile score
              </div>
              <span
                className={`inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-medium ${getScoreBadgeClasses(
                  profileScore?.overallScore
                )}`}
              >
                {getScoreLabel(profileScore?.overallScore)}
              </span>
            </div>
            <div className="mt-1 text-2xl font-semibold text-gray-900">
              {profileScore?.overallScore ?? "—"}
            </div>
            <div className="mt-1 text-xs text-gray-500">
              {highRiskDomainCount > 0
                ? `${highRiskDomainCount} domain${
                    highRiskDomainCount === 1 ? "" : "s"
                  } with breach rate ≥ 25%`
                : "No high‑risk domains in this window"}
            </div>
          </div>
        </section>
      )}

      {/* Task volume over time */}
      {hasAnyData && (
        <section className="mb-4 rounded-md border border-gray-200 bg-white p-4">
          <div className="mb-3 flex items-center justify-between gap-2">
            <div>
              <h2 className="text-sm font-semibold text-gray-900">
                Task volume over time
              </h2>
              <p className="mt-1 text-xs text-gray-500">
                Tasks created per day in the selected window.
              </p>
            </div>
            {profileScore && (
              <p className="text-xs text-gray-500">
                Window:{" "}
                {formatDateRange(
                  profileScore.fromDate,
                  profileScore.toDate
                )}
              </p>
            )}
          </div>

          {dailyVolume.length === 0 ? (
            <p className="text-xs text-gray-500">
              No tasks in this window yet.
            </p>
          ) : (
            <div className="space-y-2">
              {dailyVolume.map((bucket) => {
                const widthPct =
                  maxDailyVolume > 0
                    ? (bucket.total / maxDailyVolume) * 100
                    : 0;
                return (
                  <div
                    key={bucket.date}
                    className="flex items-center gap-2"
                  >
                    <div className="w-16 text-xs text-gray-500">
                      {formatShortDate(bucket.date)}
                    </div>
                    <div className="flex-1">
                      <div className="h-2 rounded-full bg-gray-100">
                        <div
                          className="h-2 rounded-full bg-indigo-500"
                          style={{ width: `${widthPct}%` }}
                        />
                      </div>
                    </div>
                    <div className="w-10 text-right text-xs text-gray-700">
                      {bucket.total}
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </section>
      )}

      {/* SLA / domain risk breakdown */}
      {hasAnyData && (
        <section
          aria-label="SLA and domain risk"
          className="mb-4 rounded-md border border-gray-200 bg-white p-4"
        >
          <div className="mb-3 flex items-center justify-between gap-2">
            <div>
              <h2 className="text-sm font-semibold text-gray-900">
                SLA breaches by domain
              </h2>
              <p className="mt-1 text-xs text-gray-500">
                Domains are ordered by highest breach rate first.
              </p>
            </div>
          </div>

          {perDomain.length === 0 ? (
            <p className="text-xs text-gray-500">
              No SLA breach data for this window. This usually means
              there are few or no tasks in scope.
            </p>
          ) : (
            <div className="-mx-4 overflow-x-auto">
              <table className="min-w-full table-fixed border-t border-gray-100 text-sm">
                <thead>
                  <tr className="bg-gray-50">
                    <th className="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                      Domain
                    </th>
                    <th className="px-4 py-2 text-right text-xs font-semibold uppercase tracking-wide text-gray-500">
                      Tasks
                    </th>
                    <th className="px-4 py-2 text-right text-xs font-semibold uppercase tracking-wide text-gray-500">
                      Breached
                    </th>
                    <th className="px-4 py-2 text-right text-xs font-semibold uppercase tracking-wide text-gray-500">
                      Breach rate
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {perDomain.map((row) => (
                    <tr
                      key={row.domainType}
                      className="border-t border-gray-100"
                    >
                      <td className="px-4 py-2 align-top text-sm text-gray-900">
                        <div className="flex flex-col">
                          <span className="font-medium">
                            {row.domainType || "—"}
                          </span>
                        </div>
                      </td>
                      <td className="px-4 py-2 text-right text-sm text-gray-900">
                        {row.totalTasks}
                      </td>
                      <td className="px-4 py-2 text-right text-sm text-gray-900">
                        {row.breachedTasks}
                      </td>
                      <td className="px-4 py-2 text-right text-sm text-gray-900">
                        <span
                          className={`inline-flex items-center justify-end rounded-full px-2 py-0.5 text-xs font-medium ${getBreachBadgeClasses(
                            row.breachRate
                          )}`}
                        >
                          {formatPercent(row.breachRate, 1)}
                        </span>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </section>
      )}

      {!isLoading && !isError && !hasAnyData && (
        <div className="rounded-md border border-gray-200 bg-white px-3 py-2 text-sm text-gray-600">
          No insights are available yet for this organization and
          filter combination.
        </div>
      )}

      {isFetching && !isLoading && (
        <div className="mt-2 text-xs text-gray-500">
          Updating…
        </div>
      )}
    </div>
  );
};

export default InsightsOverviewPage;


=== FILE 16/22: packages/config/nginx.conf ===

events {

}

http {

    server {
        listen 80;
        server_name localhost;

        location /api/ {
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_pass http://host.docker.internal:5002/;

            proxy_http_version 1.1;
            proxy_set_header Connection "upgrade";
            proxy_set_header Upgrade $http_upgrade;
        }

        location /_next/webpack-hmr {
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Host $host;


            proxy_pass http://host.docker.internal:3000;

            proxy_http_version 1.1;
            proxy_set_header Connection "upgrade";
            proxy_set_header Upgrade $http_upgrade;
        }

        location / {
            proxy_pass http://host.docker.internal:3000;
        }

    }

}


=== FILE 17/22: packages/config/package.json ===

{
  "name": "config",
  "version": "0.0.0",
  "main": "index.js",
  "license": "MIT",
  "files": [
    "eslint-preset.js"
  ],
  "dependencies": {
    "eslint-config-next": "^13.4.12",
    "eslint-config-prettier": "^8.9.0",
    "eslint-plugin-react": "7.33.1"
  }
}


=== FILE 18/22: packages/tsconfig/package.json ===

{
  "name": "tsconfig",
  "version": "0.0.0",
  "private": true,
  "main": "index.js",
  "files": [
    "base.json",
    "nextjs.json",
    "react-library.json"
  ]
}


=== FILE 19/22: packages/ui/components/Button/Button.tsx ===

export const Button = () => {
  return <button className="text-lg bg-red-500">boo</button>;
};


=== FILE 20/22: packages/ui/index.tsx ===

export * from "./components/Button/Button";


=== FILE 21/22: packages/ui/package.json ===

{
  "name": "ui",
  "version": "0.0.0",
  "private": true,
  "main": "./index.tsx",
  "types": "./index.tsx",
  "license": "MIT",
  "scripts": {
    "build": "echo \"[ui] build (no-op, handled by web/Next)\""
  },
  "peerDependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
  "devDependencies": {
    "@types/react": "^18.2.18",
    "@types/react-dom": "^18.2.7",
    "config": "*",
    "tsconfig": "*",
    "typescript": "^5.1.6"
  }
}


=== FILE 22/22: packages/ui/tsconfig.json ===

{
  "extends": "tsconfig/react-library.json",
  "include": ["."],
  "exclude": ["dist", "build", "node_modules"]
}


