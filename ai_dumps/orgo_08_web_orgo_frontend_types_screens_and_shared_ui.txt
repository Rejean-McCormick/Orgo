=== FILE 1/24: apps/web/src/orgo/core/functional-ids.ts ===

/**
 * Stable functional identifiers for Orgo v3 (frontend mirror).
 *
 * Pattern: FN_<MODULE>_<ACTION>
 *
 * These IDs are used in:
 * - Structured logging / analytics
 * - Configuration & feature flags (per-function overrides)
 *
 * This file must stay in sync with:
 * - apps/api/src/orgo/core/functional-ids.ts
 * - Doc 4 – Functional Code-Name Inventory
 */

/* -------------------------------------------------------------------------- */
/* Aggregate list (mirrors backend ALL_FUNCTIONAL_IDS)                        */
/* -------------------------------------------------------------------------- */

export const ALL_FUNCTIONAL_IDS = [
  // Backbone – organizations, persons, identity & RBAC
  "FN_ORG_CREATE_ORGANIZATION",
  "FN_ORG_UPDATE_ORGANIZATION",
  "FN_PERSON_UPSERT_PERSON_PROFILE",
  "FN_RBAC_CREATE_ROLE",
  "FN_RBAC_ASSIGN_PERMISSION",
  "FN_RBAC_ASSIGN_USER_ROLE",
  "FN_IDENTITY_LINK_USER_TO_PERSON",

  // Signals & ingestion – email, API, offline
  "FN_EMAIL_SEND",
  "FN_EMAIL_PARSE_INCOMING",
  "FN_EMAIL_VALIDATE_PAYLOAD",
  "FN_EMAIL_POLL_MAILBOX",
  "FN_EMAIL_ROUTE_TO_WORKFLOW",
  "FN_SIGNAL_INGEST",
  "FN_EMAIL_IMPORT_ARCHIVE",
  "FN_SYNC_OFFLINE_NODE",
  "FN_SYNC_OFFLINE_TASKS",

  // Core – cases, tasks, workflow, escalations & labels
  "FN_CASE_CREATE_FROM_SIGNAL",
  "FN_CASE_CREATE",
  "FN_CASE_GET_WITH_TASKS",
  "FN_CASE_RUN_CYCLIC_REVIEW",
  "FN_TASK_CREATE",
  "FN_TASK_UPDATE_STATUS",
  "FN_TASK_ESCALATE",
  "FN_TASK_ASSIGN",
  "FN_TASK_ADD_COMMENT",
  "FN_TASK_GET_BY_ID",
  "FN_WORKFLOW_EXECUTE",
  "FN_WORKFLOW_VALIDATE_RULES",
  "FN_WORKFLOW_SIMULATE",
  "FN_ESCALATION_EVALUATE",
  "FN_LABEL_RESOLVE",
  "FN_ROUTING_APPLY_RULES",
  "FN_LABEL_CREATE_DEFINITION",
  "FN_LABEL_APPLY_TO_ENTITY",

  // Config, profiles & feature flags
  "FN_PROFILE_LOAD",
  "FN_PROFILE_APPLY_DEFAULTS",
  "FN_PROFILE_PREVIEW_DIFF",
  "FN_CONFIG_GET_GLOBAL",
  "FN_CONFIG_UPDATE_SERVICE_CONFIG",
  "FN_CONFIG_IMPORT_BUNDLE",
  "FN_FEATURE_FLAG_SET",
  "FN_FEATURE_FLAG_EVALUATE",

  // Interfaces – public API, admin UI, live updates
  "FN_API_LIST_TASKS",
  "FN_API_GET_TASK",
  "FN_API_CREATE_TASK",
  "FN_API_UPDATE_TASK_STATUS",
  "FN_API_LIST_CASES",
  "FN_API_GET_CASE",
  "FN_API_EXECUTE_WORKFLOW",
  "FN_UI_ADMIN_TASK_OVERVIEW",
  "FN_UI_ADMIN_CASE_OVERVIEW",
  "FN_UI_ORG_PROFILE_SETTINGS",
  "FN_NOTIFICATION_SEND_IN_APP",
  "FN_NOTIFICATION_SEND_EMAIL",
  "FN_GATEWAY_TASK_EVENTS_STREAM",

  // Domain modules – maintenance, HR, education, generic domain API
  "FN_DOMAIN_MAINTENANCE_REGISTER_INCIDENT",
  "FN_DOMAIN_MAINTENANCE_LIST_INCIDENTS",
  "FN_DOMAIN_HR_REGISTER_REPORT",
  "FN_DOMAIN_HR_LIST_CASES",
  "FN_DOMAIN_EDUCATION_REGISTER_STUDENT_INCIDENT",
  "FN_DOMAIN_EDUCATION_LIST_INCIDENTS",
  "FN_DOMAIN_TASK_FACTORY_CREATE",
  "FN_DOMAIN_WORKFLOW_APPLY_OVERRIDES",

  // Insights, analytics & cyclic overview
  "FN_REPORTS_GET_TASK_VOLUME",
  "FN_REPORTS_GET_SLA_BREACHES",
  "FN_REPORTS_GET_PROFILE_SCORE",
  "FN_ANALYTICS_EXPORT_FACTS",
  "FN_ANALYTICS_REFRESH_MATERIALIZED_VIEWS",
  "FN_INSIGHTS_RUN_WEEKLY_PATTERNS",
  "FN_INSIGHTS_RUN_MONTHLY_TRENDS",
  "FN_INSIGHTS_RUN_YEARLY_SYSTEMIC_REVIEW",
  "FN_INSIGHTS_CACHE_WARM_DASHBOARDS",
  "FN_INSIGHTS_EXPORT_ANALYTICS",

  // Infrastructure, health, metrics & alerts
  "FN_HEALTH_GET",
  "FN_WORKER_HEARTBEAT",
  "FN_METRICS_RECORD_WORKFLOW_LATENCY",
  "FN_METRICS_RECORD_QUEUE_DEPTH",
  "FN_ALERT_ESCALATION_DELAY",
  "FN_ALERT_ERROR_RATE",

  // Security, privacy, compliance & logging
  "FN_AUTH_VALIDATE_ACCESS_TOKEN",
  "FN_RBAC_CHECK_PERMISSION",
  "FN_PRIVACY_ANONYMIZE_PAYLOAD",
  "FN_AUDIT_RECORD_EVENT",
  "FN_COMPLIANCE_EXPORT_AUDIT_LOG",
  "FN_LOG_SYSTEM_EVENT",
  "FN_LOG_SECURITY_EVENT",
  "FN_LOG_ROTATE_LOGS",
  "FN_LOG_QUERY_ENTITY_ACTIVITY",
  "FN_CONFIG_VALIDATE_BUNDLE",
  "FN_VALIDATE_API_PAYLOAD",
  "FN_METADATA_NORMALIZE",
] as const;

/**
 * Union type of all known functional IDs.
 * Mirrors the backend FunctionalId type.
 */
export type FunctionalId = (typeof ALL_FUNCTIONAL_IDS)[number];

/**
 * Backwards-compatible alias used by earlier web code.
 * Prefer ALL_FUNCTIONAL_IDS for new usage.
 */
export const FUNCTIONAL_ID_VALUES = ALL_FUNCTIONAL_IDS;

/**
 * Convenience map FunctionalIds[id] === id for ergonomic imports.
 */
export const FunctionalIds: Record<FunctionalId, FunctionalId> =
  ALL_FUNCTIONAL_IDS.reduce(
    (acc, id) => {
      acc[id] = id;
      return acc;
    },
    {} as Record<FunctionalId, FunctionalId>,
  );

/**
 * Type guard to validate whether a string is a known FunctionalId.
 */
export function isFunctionalId(value: string): value is FunctionalId {
  return (ALL_FUNCTIONAL_IDS as readonly string[]).includes(value);
}


=== FILE 2/24: apps/web/src/orgo/hooks/useTaskEventStream.ts ===

// apps/web/src/orgo/hooks/useTaskEventStream.ts
import { useCallback, useEffect, useRef, useState } from "react";

export type TaskEventType =
  | "created"
  | "status_changed"
  | "priority_changed"
  | "ownership_changed"
  | "comment_added"
  | "email_linked"
  | "escalated"
  | "deadline_updated"
  | "metadata_updated"
  | string;

export interface TaskEvent {
  id?: string;
  taskId: string;
  organizationId?: string;
  eventType: TaskEventType;
  oldValue?: unknown;
  newValue?: unknown;
  actorUserId?: string | null;
  actorRoleId?: string | null;
  origin?: string;
  createdAt: string;
  // Allow extra fields from backend without losing them
  [key: string]: unknown;
}

export interface UseTaskEventStreamOptions {
  /**
   * Optional task filter. If provided, the client will request
   * events only for this task (server must support this convention).
   */
  taskId?: string;

  /**
   * Optional organization filter. Can be used by the server to scope events.
   */
  organizationId?: string;

  /**
   * Whether the WebSocket connection should be active.
   * Defaults to true.
   */
  enabled?: boolean;

  /**
   * Whether the hook should try to automatically reconnect on unexpected close.
   * Defaults to true.
   */
  autoReconnect?: boolean;

  /**
   * Optional callback invoked for every normalized TaskEvent.
   */
  onEvent?: (event: TaskEvent) => void;

  /**
   * Optional callback invoked when the WebSocket errors.
   */
  onError?: (error: Error) => void;
}

export interface UseTaskEventStreamResult {
  /**
   * All TaskEvents received during the lifetime of this hook instance.
   */
  events: TaskEvent[];

  /**
   * The most recently received TaskEvent, or null if none.
   */
  lastEvent: TaskEvent | null;

  /**
   * True while the WebSocket connection is open.
   */
  isConnected: boolean;

  /**
   * True while we are in the process of establishing a connection.
   */
  isConnecting: boolean;

  /**
   * Last error encountered by the WebSocket, if any.
   */
  error: Error | null;

  /**
   * Manually close the WebSocket and stop auto‑reconnect.
   */
  disconnect: () => void;

  /**
   * Force a reconnect (will reopen the WebSocket with current options).
   */
  reconnect: () => void;

  /**
   * Clear the in‑memory list of events and lastEvent.
   */
  clearEvents: () => void;
}

/**
 * Derive the WebSocket URL used for TaskEventsGateway.
 *
 * Priority:
 * 1. NEXT_PUBLIC_ORGO_TASK_EVENTS_WS_URL (full ws:// or wss:// URL)
 * 2. window.location.origin + /api/v3/task-events/stream (converted to ws:// or wss://)
 *
 * Optional filters (task_id, organization_id) are appended as query parameters.
 */
function resolveTaskEventsWsUrl(params: {
  taskId?: string;
  organizationId?: string;
}): string | null {
  if (typeof window === "undefined") {
    return null;
  }

  const explicit = process.env.NEXT_PUBLIC_ORGO_TASK_EVENTS_WS_URL;
  const httpUrl =
    explicit && explicit.length > 0
      ? explicit
      : `${window.location.origin}/api/v3/task-events/stream`;

  let url: URL;
  try {
    url = new URL(httpUrl, window.location.origin);
  } catch {
    return null;
  }

  // Ensure WebSocket protocol
  url.protocol = url.protocol === "https:" ? "wss:" : "ws:";

  if (params.taskId) {
    url.searchParams.set("task_id", params.taskId);
  }

  if (params.organizationId) {
    url.searchParams.set("organization_id", params.organizationId);
  }

  return url.toString();
}

function extractTaskEventPayload(raw: unknown): any {
  if (!raw || typeof raw !== "object") {
    return raw;
  }

  const obj = raw as any;

  // Common wrapping patterns: { event: {...} }, { data: {...} }, { payload: {...} }
  if (obj.event) return obj.event;
  if (obj.payload) return obj.payload;
  if (obj.data) return obj.data;

  return obj;
}

function normalizeTaskEvent(raw: unknown): TaskEvent | null {
  if (!raw) return null;

  const envelope = extractTaskEventPayload(raw);
  if (!envelope || typeof envelope !== "object") {
    return null;
  }

  const obj = envelope as any;

  const taskId = obj.task_id ?? obj.taskId;
  if (!taskId || typeof taskId !== "string") {
    // Not a task‑scoped event we understand
    return null;
  }

  const organizationId =
    obj.organization_id ??
    obj.organizationId ??
    (raw as any)?.organization_id ??
    (raw as any)?.organizationId;

  const eventType: TaskEventType =
    obj.event_type ??
    obj.eventType ??
    (raw as any)?.event_type ??
    (raw as any)?.eventType ??
    (raw as any)?.type ??
    "unknown";

  const createdAt: string =
    obj.created_at ??
    obj.createdAt ??
    (raw as any)?.created_at ??
    (raw as any)?.createdAt ??
    new Date().toISOString();

  const oldValue = obj.old_value ?? obj.oldValue;
  const newValue = obj.new_value ?? obj.newValue;

  const actorUserId =
    obj.actor_user_id ?? obj.actorUserId ?? (raw as any)?.actor_user_id;
  const actorRoleId =
    obj.actor_role_id ?? obj.actorRoleId ?? (raw as any)?.actor_role_id;

  const origin = obj.origin ?? (raw as any)?.origin;

  const id = obj.id ?? (raw as any)?.id;

  const event: TaskEvent = {
    id: typeof id === "string" ? id : undefined,
    taskId,
    organizationId:
      typeof organizationId === "string" ? organizationId : undefined,
    eventType,
    oldValue,
    newValue,
    actorUserId:
      typeof actorUserId === "string" || actorUserId === null
        ? actorUserId
        : undefined,
    actorRoleId:
      typeof actorRoleId === "string" || actorRoleId === null
        ? actorRoleId
        : undefined,
    origin: typeof origin === "string" ? origin : undefined,
    createdAt,
    // keep full raw payload attached for inspection if needed
    raw,
  };

  return event;
}

export function useTaskEventStream(
  options: UseTaskEventStreamOptions = {}
): UseTaskEventStreamResult {
  const {
    taskId,
    organizationId,
    enabled = true,
    autoReconnect = true,
    onEvent,
    onError,
  } = options;

  const [events, setEvents] = useState<TaskEvent[]>([]);
  const [lastEvent, setLastEvent] = useState<TaskEvent | null>(null);
  const [isConnected, setIsConnected] = useState(false);
  const [isConnecting, setIsConnecting] = useState(false);
  const [error, setError] = useState<Error | null>(null);

  const wsRef = useRef<WebSocket | null>(null);
  const reconnectTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(
    null
  );
  const manuallyDisconnectedRef = useRef(false);
  const isMountedRef = useRef(false);
  const [reconnectCounter, setReconnectCounter] = useState(0);

  const clearEvents = useCallback(() => {
    setEvents([]);
    setLastEvent(null);
  }, []);

  const disconnect = useCallback(() => {
    manuallyDisconnectedRef.current = true;

    if (reconnectTimeoutRef.current) {
      clearTimeout(reconnectTimeoutRef.current);
      reconnectTimeoutRef.current = null;
    }

    if (wsRef.current) {
      wsRef.current.close();
      wsRef.current = null;
    }

    if (isMountedRef.current) {
      setIsConnected(false);
      setIsConnecting(false);
    }
  }, []);

  const reconnect = useCallback(() => {
    manuallyDisconnectedRef.current = false;
    // Trigger effect to re-establish connection
    setReconnectCounter((prev) => prev + 1);
  }, []);

  useEffect(() => {
    if (!enabled || typeof window === "undefined") {
      return;
    }

    const url = resolveTaskEventsWsUrl({ taskId, organizationId });

    if (!url) {
      const err = new Error("Unable to resolve TaskEvents WebSocket URL");
      setError(err);
      if (onError) {
        onError(err);
      }
      return;
    }

    isMountedRef.current = true;
    manuallyDisconnectedRef.current = false;

    const ws = new WebSocket(url);
    wsRef.current = ws;

    setIsConnecting(true);
    setError(null);

    ws.onopen = () => {
      if (!isMountedRef.current) return;
      setIsConnecting(false);
      setIsConnected(true);
    };

    ws.onmessage = (event: MessageEvent) => {
      if (!isMountedRef.current) return;

      let payload: unknown = event.data;
      if (typeof event.data === "string") {
        try {
          payload = JSON.parse(event.data);
        } catch {
          // keep as raw string if it is not valid JSON
          payload = event.data;
        }
      }

      const normalized = normalizeTaskEvent(payload);
      if (!normalized) {
        return;
      }

      setLastEvent(normalized);
      setEvents((prev) => [...prev, normalized]);

      if (onEvent) {
        onEvent(normalized);
      }
    };

    ws.onerror = () => {
      if (!isMountedRef.current) return;

      const err = new Error("TaskEvents WebSocket error");
      setError(err);
      if (onError) {
        onError(err);
      }
    };

    ws.onclose = () => {
      if (!isMountedRef.current) return;

      setIsConnected(false);
      setIsConnecting(false);
      wsRef.current = null;

      if (autoReconnect && !manuallyDisconnectedRef.current) {
        reconnectTimeoutRef.current = setTimeout(() => {
          if (
            !isMountedRef.current ||
            manuallyDisconnectedRef.current ||
            !autoReconnect
          ) {
            return;
          }
          setReconnectCounter((prev) => prev + 1);
        }, 3000);
      }
    };

    return () => {
      isMountedRef.current = false;

      if (reconnectTimeoutRef.current) {
        clearTimeout(reconnectTimeoutRef.current);
        reconnectTimeoutRef.current = null;
      }

      if (wsRef.current) {
        wsRef.current.close();
        wsRef.current = null;
      }
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [
    enabled,
    autoReconnect,
    taskId,
    organizationId,
    onEvent,
    onError,
    reconnectCounter,
  ]);

  return {
    events,
    lastEvent,
    isConnected,
    isConnecting,
    error,
    disconnect,
    reconnect,
    clearEvents,
  };
}


=== FILE 3/24: apps/web/src/orgo/types/case.ts ===

// apps/web/src/orgo/types/case.ts

// Canonical enums for Case, aligned with Docs 1, 2 and 8.

/**
 * CASE_STATUS
 * - open
 * - in_progress
 * - resolved
 * - archived
 */
export const CASE_STATUSES = [
  'open',
  'in_progress',
  'resolved',
  'archived',
] as const;
export type CaseStatus = (typeof CASE_STATUSES)[number];

/**
 * JSON form of TASK_SEVERITY for Cases
 * - minor
 * - moderate
 * - major
 * - critical
 */
export const CASE_SEVERITIES = [
  'minor',
  'moderate',
  'major',
  'critical',
] as const;
export type CaseSeverity = (typeof CASE_SEVERITIES)[number];

/**
 * Case source_type / task_source_enum (JSON form)
 * - email
 * - api
 * - manual
 * - sync
 */
export const CASE_SOURCE_TYPES = ['email', 'api', 'manual', 'sync'] as const;
export type CaseSourceType = (typeof CASE_SOURCE_TYPES)[number];

// Common scalar aliases used across Orgo types
export type UUID = string;
export type IsoDateTimeString = string; // e.g. "2025-11-18T10:30:00Z"
export type IsoDurationString = string; // e.g. "PT2H"
export type LabelCode = string; // "<BASE>.<CATEGORY><SUBCATEGORY>.<HORIZONTAL_ROLE>"

/**
 * Canonical Case JSON contract for the web app, matching Doc 2 §2.11
 * and Doc 8 §8.4.1.
 *
 * This represents the shape returned by the public Case API
 * (GET /api/v3/cases, GET /api/v3/cases/:id) for the Case fields.
 */
export interface Case {
  case_id: UUID;
  organization_id: UUID;

  source_type: CaseSourceType;
  source_reference: string | null;

  label: LabelCode;
  title: string;
  description: string;

  status: CaseStatus;
  severity: CaseSeverity;

  /**
   * ISO‑8601 duration (e.g. "PT2H"); derived from profiles/workflows.
   * Null if no explicit SLA window is set for this Case.
   */
  reactivity_time: IsoDurationString | null;

  /**
   * Base part of the original label (e.g. 100, 1001).
   */
  origin_vertical_level: number | null;

  /**
   * Horizontal role of origin (e.g. "Ops.Maintenance").
   */
  origin_role: string | null;

  /**
   * High‑level tags (e.g. ["safety","wet_floor"]).
   */
  tags: string[] | null;

  /**
   * Structured location (site, building, GPS, etc.).
   */
  location: Record<string, unknown> | null;

  /**
   * Case‑level metadata (pattern_sensitivity, review settings, profile_id, etc.).
   */
  metadata: Record<string, unknown>;

  /**
   * Timestamps are ISO‑8601 in UTC.
   */
  created_at: IsoDateTimeString;
  updated_at: IsoDateTimeString;
}

/**
 * Optional extension used by Case details endpoints that include linked Tasks.
 *
 * TTask is generic so this file does not need to depend on a specific Task type;
 * callers can specialise it as CaseWithTasks<Task>.
 */
export interface CaseWithTasks<TTask = unknown> extends Case {
  tasks: TTask[];
}


=== FILE 4/24: apps/web/src/orgo/types/insights.ts ===

/**
 * Orgo v3 – Insights / Analytics Type Definitions
 *
 * This file models:
 * - Canonical enums reused in the Insights slice
 * - The /config/insights/config.yaml structure
 * - Star-schema dimensions and fact tables in the `insights.*` schema
 *
 * All enums and shapes are aligned with the v3 spec documents.
 */

/* -------------------------------------------------------------------------- */
/*  Common primitive aliases                                                   */
/* -------------------------------------------------------------------------- */

export type UUID = string;

/**
 * ISO-8601 timestamp in UTC, e.g. "2025-11-18T10:30:00Z".
 */
export type IsoDateTimeString = string;

/**
 * ISO-8601 calendar date, e.g. "2025-03-14".
 */
export type IsoDateString = string;

/* -------------------------------------------------------------------------- */
/*  Core enums used by Insights (mirroring canonical enums)                   */
/* -------------------------------------------------------------------------- */

/**
 * Global deployment environments.
 */
export type Environment = 'dev' | 'staging' | 'prod' | 'offline';

/**
 * Task lifecycle status in analytics and operational views.
 */
export type TaskStatus =
  | 'PENDING'
  | 'IN_PROGRESS'
  | 'ON_HOLD'
  | 'COMPLETED'
  | 'FAILED'
  | 'ESCALATED'
  | 'CANCELLED';

/**
 * Task priority.
 */
export type TaskPriority = 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';

/**
 * Task / Case severity.
 */
export type TaskSeverity = 'MINOR' | 'MODERATE' | 'MAJOR' | 'CRITICAL';

/**
 * Visibility of a task/case/event.
 */
export type Visibility = 'PUBLIC' | 'INTERNAL' | 'RESTRICTED' | 'ANONYMISED';

/**
 * Operational source of a task/case.
 */
export type TaskSource = 'email' | 'api' | 'manual' | 'sync';

/**
 * Case lifecycle status used in analytics.
 */
export type CaseStatus = 'open' | 'in_progress' | 'resolved' | 'archived';

/**
 * Notification channel enum values as used in analytics/export config.
 */
export type NotificationChannel = 'email' | 'sms' | 'in_app' | 'webhook';

/**
 * Notification scope, as used in profiles and reporting.
 */
export type NotificationScope = 'user' | 'team' | 'department' | 'org_wide';

/* -------------------------------------------------------------------------- */
/*  Profile keys (as referenced from Insights patterns config)                */
/* -------------------------------------------------------------------------- */

/**
 * Known profile keys from the profiles YAML.
 *
 * Additional profile keys may be added in the YAML; consumers should still
 * accept arbitrary strings where forward compatibility is needed.
 */
export type ProfileKey =
  | 'default'
  | 'friend_group'
  | 'hospital'
  | 'advocacy_group'
  | 'retail_chain'
  | 'military_organization'
  | 'environmental_group'
  | 'artist_collective';

/* -------------------------------------------------------------------------- */
/*  Insights config: /config/insights/config.yaml (insights: subtree)         */
/* -------------------------------------------------------------------------- */

/**
 * Warehouse types supported by the Insights slice.
 */
export type InsightsWarehouseType = 'postgres' | 'bigquery' | 'snowflake';

export interface InsightsWarehouseConfig {
  type: InsightsWarehouseType;
  connection_url: string;
  schema: string;
  read_only_user: string;
  write_user: string;
}

export interface InsightsEtlConfig {
  owner_email: string;
  default_batch_size: number;
  max_batch_size: number;
  concurrency: number;
}

export interface InsightsCacheTtlSeconds {
  dashboard_default: number;
  dashboard_slow: number;
  streaming_like: number;
}

export interface InsightsCacheMaxKeysPerDashboard {
  dev?: number;
  staging?: number;
  prod?: number;
  offline?: number;
}

export interface InsightsCacheConfig {
  backend: 'redis';
  url: string;
  ttl_seconds: InsightsCacheTtlSeconds;
  max_keys_per_dashboard: InsightsCacheMaxKeysPerDashboard;
}

/**
 * Per-environment numeric config slice, where not all environments
 * must be explicitly defined in YAML.
 */
export type PerEnvironmentNumber = Partial<Record<Exclude<Environment, 'offline'>, number>>;

export interface InsightsRetentionConfig {
  raw_event_retention_days: PerEnvironmentNumber;
  aggregated_retention_days: PerEnvironmentNumber;
  pattern_result_retention_days: PerEnvironmentNumber;
}

export interface InsightsBackupSlice {
  rpo_minutes: PerEnvironmentNumber;
  rto_minutes: PerEnvironmentNumber;
}

export interface InsightsExportLimitsPerEnvironment {
  dev?: number;
  staging?: number;
  prod?: number;
}

export interface InsightsExportConfig {
  max_rows_per_export: InsightsExportLimitsPerEnvironment;
  max_parallel_exports_per_user: InsightsExportLimitsPerEnvironment;
  pii_masking_enabled: boolean;
  allowed_visibilities: Visibility[];
}

/**
 * Sliding-window settings for pattern detection at a given cadence
 * (weekly / monthly / yearly).
 */
export interface InsightsPatternWindowConfig {
  window_days: number;
  min_events: number;
  min_distinct_sources: number;
}

/**
 * Pattern configuration, including profile selection by domain.
 */
export interface InsightsPatternsConfig {
  /**
   * Profile key to use when no domain-specific override applies.
   */
  default_profile_key: ProfileKey | string;

  /**
   * Mapping from Task.type (e.g. "maintenance", "hr_case") to profile key.
   */
  overrides_by_domain?: Record<string, ProfileKey | string>;

  weekly: InsightsPatternWindowConfig;
  monthly: InsightsPatternWindowConfig;
  yearly: InsightsPatternWindowConfig;
}

/**
 * Root of the /config/insights/config.yaml "insights" subtree.
 *
 * Note: some deployments may wrap this under a top-level `{ insights: InsightsConfig }`.
 */
export interface InsightsConfig {
  environment: Environment;
  warehouse: InsightsWarehouseConfig;
  etl: InsightsEtlConfig;
  cache: InsightsCacheConfig;
  retention: InsightsRetentionConfig;
  backups: InsightsBackupSlice;
  exports: InsightsExportConfig;
  patterns: InsightsPatternsConfig;
}

/* -------------------------------------------------------------------------- */
/*  Star-schema dimensions: insights.dim_*                                    */
/* -------------------------------------------------------------------------- */

/**
 * Calendar/date dimension row.
 */
export interface InsightsDimDate {
  date_key: IsoDateString; // e.g. "2025-03-14"
  year: number;
  quarter: number; // 1–4
  month: number; // 1–12
  month_name: string;
  week_of_year: number;
  day_of_week: number; // 1=Monday–7=Sunday
  day_name: string;
  is_weekend: boolean;
}

/**
 * Organization dimension row (analytics view over organizations).
 */
export interface InsightsDimOrganization {
  organization_id: UUID;
  slug: string;
  display_name: string;
  org_type: string | null;
  timezone: string;
  active_from: IsoDateString;
  active_to: IsoDateString | null;
}

/**
 * Task dimension row (denormalized task view).
 */
export interface InsightsDimTask {
  task_id: UUID;
  organization_id: UUID;
  case_id: UUID | null;

  label: string;
  type: string;
  category: string;
  subtype: string | null;

  priority: TaskPriority;
  severity: TaskSeverity;
  visibility: Visibility;
  source: TaskSource;

  assignee_role: string | null;

  created_at: IsoDateTimeString;
  closed_at: IsoDateTimeString | null;

  current_status: TaskStatus;
}

/**
 * Case dimension row (denormalized case view).
 */
export interface InsightsDimCase {
  case_id: UUID;
  organization_id: UUID;

  label: string;
  title: string;
  status: CaseStatus;
  severity: TaskSeverity;

  origin_vertical_level: number;
  origin_role: string;

  opened_at: IsoDateTimeString;
  closed_at: IsoDateTimeString | null;
}

/**
 * Person dimension row (analytics view over person_profiles).
 */
export type PersonConfidentialityLevel = 'normal' | 'sensitive' | 'highly_sensitive';

export interface InsightsDimPerson {
  person_id: UUID;
  organization_id: UUID;
  full_name: string;
  external_reference: string | null;
  confidentiality_level: PersonConfidentialityLevel;
}

/**
 * Learning group (class/team/group) dimension row.
 */
export interface InsightsDimLearningGroup {
  learning_group_id: UUID;
  organization_id: UUID;
  code: string;
  name: string;
  category: string;
}

/* -------------------------------------------------------------------------- */
/*  Star-schema fact tables: insights.fact_*                                  */
/* -------------------------------------------------------------------------- */

/**
 * Task fact row – core lifecycle metrics used in reporting.
 */
export interface InsightsFactTask {
  id: number; // bigserial in DB
  task_id: UUID;
  organization_id: UUID;

  created_date_key: IsoDateString;
  closed_date_key: IsoDateString | null;

  current_status: TaskStatus;
  priority: TaskPriority;
  severity: TaskSeverity;
  source: TaskSource;

  time_to_first_response_seconds: number | null;
  time_to_completion_seconds: number | null;

  escalation_count: number;
  comment_count: number;
}

/**
 * Case fact row – lifecycle metrics and link counts.
 */
export interface InsightsFactCase {
  id: number; // bigserial
  case_id: UUID;
  organization_id: UUID;

  opened_date_key: IsoDateString;
  closed_date_key: IsoDateString | null;

  status: CaseStatus;
  severity: TaskSeverity;

  linked_task_count: number;
  escalation_count: number;
  review_count: number;
}

/**
 * Wellbeing check-in fact row.
 */
export interface InsightsFactWellbeingCheckin {
  id: number; // bigserial
  checkin_id: UUID;
  organization_id: UUID;

  person_id: UUID | null;
  learning_group_id: UUID | null;

  date_key: IsoDateString;
  score: number;
  tags: string[];

  related_case_id: UUID | null;
  related_task_id: UUID | null;
}

/* -------------------------------------------------------------------------- */
/*  Generic helpers for UI/reporting                                         */
/* -------------------------------------------------------------------------- */

/**
 * Generic time-series point used by insights dashboards.
 */
export interface InsightsTimeSeriesPoint<TExtra = unknown> {
  /**
   * Calendar date for this bucket (usually mapped from dim_dates.date_key).
   */
  date_key: IsoDateString;

  /**
   * Primary value for this bucket (e.g. count of tasks).
   */
  value: number;

  /**
   * Optional extra payload per point (e.g. breakdowns).
   */
  extra?: TExtra;
}

/**
 * Simple grouped aggregate row, e.g. "tasks by status" or "cases by label".
 */
export interface InsightsGroupedAggregateRow<TKey = string> {
  key: TKey;
  count: number;
}

/**
 * Standard shape for "SLA breach" listings in analytics reports.
 * This does not directly map to a single table, but is a convenient
 * projection over tasks + fact_tasks + profiles.
 */
export interface InsightsSlaBreachRow {
  task_id: UUID;
  organization_id: UUID;
  title: string;
  type: string;
  category: string;
  priority: TaskPriority;
  severity: TaskSeverity;
  visibility: Visibility;
  source: TaskSource;

  status: TaskStatus;
  created_at: IsoDateTimeString;
  reactivity_deadline_at: IsoDateTimeString | null;
  closed_at: IsoDateTimeString | null;

  /**
   * Positive number of seconds the task is/was beyond its SLA, if applicable.
   */
  breach_seconds: number;
}


=== FILE 5/24: apps/web/src/orgo/types/organization.ts ===

// apps/web/src/orgo/types/organization.ts

/**
 * Organization and organization-profile related types used in the Orgo web app.
 *
 * These types mirror:
 * - The Orgo v3 database schema for `organizations` and `organization_profiles`.
 * - The profiles YAML behaviour schema (profile codes and behavioural knobs).
 */

/**
 * Canonical environment keys (ENVIRONMENT).
 */
export type EnvironmentKey = 'dev' | 'staging' | 'prod' | 'offline';

/**
 * Simple aliases for commonly used primitives.
 */
export type UUID = string;
export type ISO8601String = string;

/**
 * Status of an organization (organizations.status).
 * Backed by `organization_status_enum` in the database.
 */
export type OrganizationStatus = 'active' | 'suspended' | 'archived';

/**
 * Core Organization shape as exposed to the web app.
 *
 * Matches the `organizations` table logical fields:
 * - id (UUID PK)
 * - slug, display_name, legal_name, primary_domain
 * - status, timezone, default_locale
 * - created_at / updated_at (standard audit columns)
 */
export interface Organization {
  id: UUID;
  slug: string;
  display_name: string;
  legal_name: string | null;
  primary_domain: string | null;
  status: OrganizationStatus;
  /**
   * IANA timezone, e.g. "America/New_York".
   */
  timezone: string;
  /**
   * Locale code, e.g. "en", "fr-CA".
   */
  default_locale: string;
  /**
   * Standard audit timestamps (UTC ISO-8601).
   * Optional in case some APIs omit them.
   */
  created_at?: ISO8601String;
  updated_at?: ISO8601String;
}

/**
 * Known profile codes from the profiles YAML plus a string
 * extension point for custom / future profiles.
 *
 * These values correspond to `organization_profiles.profile_code`.
 */
export type OrganizationProfileKey =
  | 'default'
  | 'friend_group'
  | 'hospital'
  | 'advocacy_group'
  | 'retail_chain'
  | 'military_organization'
  | 'environmental_group'
  | 'artist_collective'
  | (string & {}); // allow custom codes while keeping string literal narrowing

/**
 * Behaviour profile primitives from the profiles YAML.
 */

export type TransparencyLevel = 'full' | 'balanced' | 'restricted' | 'private';

export type EscalationGranularity =
  | 'relaxed'
  | 'moderate'
  | 'detailed'
  | 'aggressive';

export type ReviewFrequency =
  | 'real_time'
  | 'daily'
  | 'weekly'
  | 'monthly'
  | 'quarterly'
  | 'yearly'
  | 'ad_hoc';

export type NotificationScope = 'user' | 'team' | 'department' | 'org_wide';

export type PatternSensitivity = 'low' | 'medium' | 'high' | 'critical';

export type SeverityThreshold = 'very_high' | 'high' | 'medium' | 'low';

export type LoggingLevel = 'minimal' | 'standard' | 'detailed' | 'audit';

export type AutomationLevel = 'manual' | 'low' | 'medium' | 'high' | 'full';

export type ProfileVisibilityDefault =
  | 'public'
  | 'internal'
  | 'restricted'
  | 'anonymised';

export type ProfilePriorityDefault = 'low' | 'medium' | 'high' | 'critical';

/**
 * Metadata block used in the profiles YAML.
 */
export interface BehaviorProfileMetadata {
  version: string;
  last_updated: string; // "YYYY-MM-DD"
  environment: EnvironmentKey;
}

/**
 * Severity policy section from the profiles YAML.
 */
export interface BehaviorProfileSeverityPolicyEntry {
  immediate_escalation: boolean;
}

export interface BehaviorProfileSeverityPolicy {
  critical: BehaviorProfileSeverityPolicyEntry;
  major: BehaviorProfileSeverityPolicyEntry;
  minor: BehaviorProfileSeverityPolicyEntry;
}

/**
 * Default task metadata section from the profiles YAML.
 * Values map to canonical TASK_PRIORITY and VISIBILITY enums.
 */
export interface BehaviorProfileDefaultTaskMetadata {
  visibility: ProfileVisibilityDefault;
  default_priority: ProfilePriorityDefault;
  /**
   * Default SLA window (in seconds) for tasks created under this profile.
   */
  default_reactivity_seconds: number;
}

/**
 * Cyclic overview / pattern detection configuration from the profiles YAML.
 */
export interface BehaviorProfileCyclicIncidentFrequency {
  min_events: number;
  window_days: number;
}

export interface BehaviorProfileCyclicThresholdTriggers {
  incident_frequency: BehaviorProfileCyclicIncidentFrequency;
  cross_departmental_trends: boolean;
  high_risk_indicators: boolean;
}

export interface BehaviorProfileCyclicSchedule {
  weekly: boolean;
  monthly: boolean;
  yearly: boolean;
}

export interface BehaviorProfileCyclicOverviewConfig {
  enabled: boolean;
  schedule: BehaviorProfileCyclicSchedule;
  threshold_triggers: BehaviorProfileCyclicThresholdTriggers;
}

/**
 * Behaviour profile as loaded from the profiles YAML
 * (one entry under `profiles:`).
 *
 * This describes how intense/urgent/private an org is:
 * reactivity, escalation, transparency, pattern sensitivity, logging, etc.
 */
export interface BehaviorProfile {
  description: string;
  metadata: BehaviorProfileMetadata;

  // 1. Reactivity / Escalation timing
  reactivity_seconds: number;
  max_escalation_seconds: number;

  // 2. Information visibility
  transparency_level: TransparencyLevel;

  // 3. Escalation structure
  escalation_granularity: EscalationGranularity;

  // 4. Review cadence
  review_frequency: ReviewFrequency;

  // 5. Who gets notified
  notification_scope: NotificationScope;

  // 6. Pattern detection
  pattern_sensitivity: PatternSensitivity;
  pattern_window_days: number;
  pattern_min_events: number;

  // 7. Severity / auto-escalation
  severity_threshold: SeverityThreshold;
  severity_policy: BehaviorProfileSeverityPolicy;

  // 8. Logging & traceability
  logging_level: LoggingLevel;
  log_retention_days: number;

  // 9. Automation level
  automation_level: AutomationLevel;

  // 10. Defaults for task metadata
  default_task_metadata: BehaviorProfileDefaultTaskMetadata;

  // 11. Cyclic Overview settings
  cyclic_overview: BehaviorProfileCyclicOverviewConfig;
}

/**
 * Mapping from profile code → behaviour profile.
 * Mirrors the `profiles:` top-level map in the YAML.
 */
export type BehaviorProfilesMap = Record<
  OrganizationProfileKey,
  BehaviorProfile
>;

/**
 * Database-level link between an organization and a profile code,
 * plus per-organization overrides for reactivity / transparency /
 * pattern sensitivity / retention.
 *
 * Mirrors the `organization_profiles` table.
 */
export interface OrganizationProfile {
  id: UUID;
  organization_id: UUID;
  profile_code: OrganizationProfileKey;

  /**
   * Per-task-type SLA targets, minutes for LOW/MEDIUM/HIGH/CRITICAL
   * or a similar structure. Kept generic here because the concrete
   * shape is configuration-driven.
   */
  reactivity_profile: unknown;

  /**
   * Defaults for who can see what; configuration-driven structure.
   */
  transparency_profile: unknown;

  /**
   * Thresholds for insights/alerts; configuration-driven structure.
   */
  pattern_sensitivity_profile: unknown;

  /**
   * Log & data retention periods per category; configuration-driven structure.
   */
  retention_profile: unknown;

  /**
   * Incremented on profile changes.
   */
  version: number;

  created_at?: ISO8601String;
  updated_at?: ISO8601String;
}

/**
 * Convenience view used by the frontend when an organization is loaded
 * together with its profile linkage and the resolved behaviour profile
 * (from the profiles YAML).
 */
export interface OrganizationWithProfile {
  organization: Organization;
  organization_profile: OrganizationProfile | null;
  /**
   * Fully-resolved behavioural profile (e.g. "hospital", "friend_group"),
   * if it could be loaded for the given profile_code.
   */
  behavior_profile: BehaviorProfile | null;
}


=== FILE 6/24: apps/web/src/orgo/types/permission.ts ===

/**
 * Permission types for the Orgo web app.
 *
 * These mirror the backend `permissions` table:
 *   - id: UUID primary key
 *   - code: stable string identifier (e.g. "task.view_sensitive")
 *   - description: human-readable explanation
 *
 * Only a subset of permission codes is explicitly enumerated here; the type
 * remains open to any additional codes the backend defines.
 */

/**
 * Canonical permission codes that are explicitly referenced
 * in the Orgo v3 specification and UI.
 *
 * NOTE: This list is not exhaustive. New permissions added on the backend
 * will still be representable via `PermissionCode`.
 */
export const KNOWN_PERMISSIONS = [
  'task.view_sensitive',
  'workflow.edit_rules',
] as const;

/**
 * Narrow type for the explicitly-known permission codes.
 */
export type KnownPermissionCode = (typeof KNOWN_PERMISSIONS)[number];

/**
 * Canonical permission code used across the web app.
 *
 * `KnownPermissionCode` captures well-known, spec-documented codes, while the
 * `string & {}` intersection keeps the type open to any additional codes
 * defined in the backend without breaking type checking.
 */
export type PermissionCode = KnownPermissionCode | (string & {});

/**
 * Permission record as exposed by the Orgo API.
 *
 * This mirrors the logical shape of the `permissions` table:
 *   - id: UUID primary key
 *   - code: stable permission identifier
 *   - description: human-readable explanation
 */
export interface Permission {
  id: string;
  code: PermissionCode;
  description: string;
}

/**
 * A collection of permission codes, typically representing
 * the effective permission set for the current user.
 */
export type PermissionSet = ReadonlyArray<PermissionCode>;

/**
 * A lookup/map representation of permissions where a present key
 * means the permission is granted.
 */
export type PermissionLookup = Readonly<Record<string, true>>;

/**
 * Union type for any permission collection representation
 * this module knows how to check.
 */
export type PermissionCollection = PermissionSet | PermissionLookup;

/**
 * Convert a list of permission codes into a lookup map suitable
 * for fast, repeated permission checks.
 */
export function toPermissionLookup(set: PermissionSet): PermissionLookup {
  const lookup: Record<string, true> = {};

  for (const code of set) {
    // Using string index here keeps this tolerant of unknown codes.
    lookup[code] = true;
  }

  return lookup;
}

/**
 * Check whether a given permission is present in the provided
 * collection (array or lookup map).
 */
export function hasPermission(
  permissions: PermissionCollection,
  code: PermissionCode,
): boolean {
  if (Array.isArray(permissions)) {
    return permissions.includes(code);
  }

  return permissions[code] === true;
}

/**
 * Check whether at least one of the given permission codes
 * is present in the collection.
 */
export function hasAnyPermission(
  permissions: PermissionCollection,
  codes: ReadonlyArray<PermissionCode>,
): boolean {
  for (const code of codes) {
    if (hasPermission(permissions, code)) {
      return true;
    }
  }
  return false;
}

/**
 * Check whether all of the given permission codes are present
 * in the collection.
 */
export function hasAllPermissions(
  permissions: PermissionCollection,
  codes: ReadonlyArray<PermissionCode>,
): boolean {
  for (const code of codes) {
    if (!hasPermission(permissions, code)) {
      return false;
    }
  }
  return true;
}


=== FILE 7/24: apps/web/src/orgo/types/person.ts ===

// apps/web/src/orgo/types/person.ts

/**
 * Person-related types for the Orgo web application.
 *
 * These map to the `person_profiles` table and related enums in the Orgo v3
 * specification. Field names follow the JSON/API contract.
 */

/**
 * Canonical confidentiality levels for person profiles.
 *
 * DB / spec values:
 *   - normal
 *   - sensitive
 *   - highly_sensitive
 */
export type PersonConfidentialityLevel =
  | 'normal'
  | 'sensitive'
  | 'highly_sensitive';

/**
 * Stable identifier type alias for persons.
 *
 * Maps to:
 *   - DB: person_profiles.id
 *   - API/JSON: person_id
 */
export type PersonId = string;

/**
 * Core Person / PersonProfile representation as exposed via the API.
 *
 * This is a direct mapping of the `person_profiles` schema plus default
 * audit columns. Timestamps are ISO‑8601 strings in UTC.
 */
export interface Person {
  /**
   * Stable identifier for the person.
   * DB: person_profiles.id
   */
  person_id: PersonId;

  /**
   * Owning organization (tenant).
   * DB: person_profiles.organization_id
   */
  organization_id: string;

  /**
   * Optional linked user account if this person also has an Orgo login.
   * DB: person_profiles.linked_user_id
   */
  linked_user_id: string | null;

  /**
   * External reference such as student ID or employee number.
   * DB: person_profiles.external_reference
   */
  external_reference: string | null;

  /**
   * Full human name.
   * DB: person_profiles.full_name
   */
  full_name: string;

  /**
   * Date of birth in ISO‑8601 date format (YYYY‑MM‑DD), if known.
   * DB: person_profiles.date_of_birth
   */
  date_of_birth: string | null;

  /**
   * Primary contact email address, if any.
   * DB: person_profiles.primary_contact_email
   */
  primary_contact_email: string | null;

  /**
   * Primary contact phone number, if any.
   * DB: person_profiles.primary_contact_phone
   */
  primary_contact_phone: string | null;

  /**
   * Confidentiality level for this person, used by higher‑level
   * visibility and guardrail logic.
   * DB: person_profiles.confidentiality_level
   */
  confidentiality_level: PersonConfidentialityLevel;

  /**
   * Creation timestamp (UTC, ISO‑8601).
   * DB: person_profiles.created_at
   */
  created_at: string;

  /**
   * Last update timestamp (UTC, ISO‑8601).
   * DB: person_profiles.updated_at
   */
  updated_at: string;
}

/**
 * Alias for compatibility with code that prefers the PersonProfile name.
 * Both refer to the same underlying shape.
 */
export type PersonProfile = Person;


=== FILE 8/24: apps/web/src/orgo/types/profile.ts ===

// apps/web/src/orgo/types/profile.ts

/**
 * Profile-related types for the Orgo web application.
 *
 * This file sits on top of:
 * - Behavioural profile templates defined in the profiles YAML (Doc 7).
 * - The `organization_profiles` table and OrgProfileService types (Docs 1, 4, 5).
 * - Admin UI views for inspecting and previewing organization profiles.
 */

import type {
  UUID,
  OrganizationProfileKey,
  BehaviorProfile,
  BehaviorProfileMetadata,
  BehaviorProfileCyclicOverviewConfig,
  BehaviorProfilesMap,
  OrganizationProfile,
  OrganizationWithProfile,
} from './organization';

/**
 * Convenience alias for profile codes as used by UI / config APIs.
 *
 * Backed by `organization_profiles.profile_code` and the profiles YAML.
 */
export type OrgProfileCode = OrganizationProfileKey;

/* -------------------------------------------------------------------------- */
/*  Canonical tokens used by OrgProfileService                                */
/* -------------------------------------------------------------------------- */

/**
 * Canonical VISIBILITY token, aligned with the backend VISIBILITY enum.
 */
export type VisibilityToken =
  | 'PUBLIC'
  | 'INTERNAL'
  | 'RESTRICTED'
  | 'ANONYMISED';

/**
 * Canonical TASK_PRIORITY token, aligned with the backend TASK_PRIORITY enum.
 */
export type TaskPriorityToken = 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';

/* -------------------------------------------------------------------------- */
/*  Profile templates & resolved organization profile                         */
/* -------------------------------------------------------------------------- */

/**
 * Frontend alias for the behavioural profile template loaded
 * from the profiles YAML (Doc 7).
 *
 * The shape mirrors `BehaviorProfile` from organization.ts and the
 * backend `ProfileTemplate` type in OrgProfileService.
 */
export type ProfileTemplate = BehaviorProfile;

/**
 * Metadata attached to each profile template (version, environment, etc.).
 */
export type ProfileTemplateMetadata = BehaviorProfileMetadata;

/**
 * Cyclic overview / review configuration copied from a profile template.
 */
export type CyclicOverviewConfig = BehaviorProfileCyclicOverviewConfig;

/**
 * Fully-resolved profile for a specific organization, as returned by
 * `OrgProfileService.loadProfile` and configuration endpoints.
 *
 * Combines:
 *   - The selected profile code
 *   - The behavioural template from YAML
 *   - An optional shallow view of the `organization_profiles` row
 */
export interface ResolvedOrgProfile {
  /**
   * Owning organization identifier.
   */
  organizationId: UUID;
  /**
   * Active profile code (e.g. "default", "hospital").
   */
  profileCode: OrgProfileCode | string;
  /**
   * Behavioural template used for this organization.
   */
  template: ProfileTemplate;
  /**
   * Optional shallow copy of the DB row for callers that need to inspect
   * JSONB override blobs or the version counter.
   */
  dbProfile?: {
    id: UUID;
    version: number;
    reactivity_profile?: unknown;
    transparency_profile?: unknown;
    pattern_sensitivity_profile?: unknown;
    retention_profile?: unknown;
  };
}

/* -------------------------------------------------------------------------- */
/*  Applying profile defaults                                                  */
/* -------------------------------------------------------------------------- */

/**
 * What kind of entity profile defaults are being applied to.
 */
export type DefaultsTargetKind = 'task' | 'case';

/**
 * Input used when asking the backend to apply profile-driven defaults
 * to a Task/Case draft.
 *
 * The backend fills in any omitted values using the active profile.
 */
export interface ApplyDefaultsInput {
  organizationId: UUID;
  /**
   * What we are applying defaults to. For now this only changes how callers
   * interpret the result; the actual values are the same.
   */
  kind: DefaultsTargetKind;
  /**
   * Existing canonical priority (TASK_PRIORITY) if already chosen.
   * If omitted, the profile default is used.
   */
  existingPriority?: TaskPriorityToken;
  /**
   * Existing canonical visibility (VISIBILITY) if already chosen.
   * If omitted, the profile default is used.
   */
  existingVisibility?: VisibilityToken;
  /**
   * Explicit SLA (in seconds) computed by the caller. When omitted,
   * the profile's default reactivity is used.
   */
  requestedReactivitySeconds?: number | null;
}

/**
 * Result of applying profile defaults to a Task/Case draft.
 *
 * This is deliberately small; Task/Case handlers can embed it into
 * their own DTOs or view models.
 */
export interface ApplyDefaultsResult {
  organizationId: UUID;
  profileCode: OrgProfileCode | string;
  kind: DefaultsTargetKind;
  priority: TaskPriorityToken;
  visibility: VisibilityToken;
  /**
   * SLA before first escalation, in seconds, after applying defaults.
   */
  reactivitySeconds: number;
  /**
   * Reactivity window expressed as ISO‑8601 duration (e.g. "PT3600S").
   */
  reactivityTimeIso: string;
  /**
   * Automation level from the org profile, useful for workflow engines.
   */
  automationLevel: ProfileTemplate['automation_level'];
  /**
   * Cyclic overview configuration copied from the profile.
   */
  cyclicOverview: CyclicOverviewConfig;
}

/* -------------------------------------------------------------------------- */
/*  Profile diff / preview (Preview profile impact)                            */
/* -------------------------------------------------------------------------- */

/**
 * A simple numeric field change descriptor used when previewing
 * the impact of switching profiles.
 */
export interface ProfileDiffNumericField {
  field: string;
  from: number | null;
  to: number;
  direction: 'increase' | 'decrease' | 'same';
}

/**
 * A simple enum/string field change descriptor used when previewing
 * the impact of switching profiles.
 */
export interface ProfileDiffEnumField {
  field: string;
  from: string | null;
  to: string;
  changed: boolean;
}

/**
 * Compact summary of a profile's key behavioural knobs.
 */
export interface ProfileSummary {
  profileCode: OrgProfileCode | string;
  description: string;
  reactivitySeconds: number;
  maxEscalationSeconds: number;
  notificationScope: string;
  patternSensitivity: string;
  patternWindowDays: number;
  patternMinEvents: number;
  loggingLevel: string;
  logRetentionDays: number;
  defaultVisibility: VisibilityToken;
  defaultPriority: TaskPriorityToken;
}

/**
 * Result of simulating the impact of switching an organization to
 * a new profile code.
 */
export interface ProfileDiffResult {
  organizationId: UUID;
  currentProfileCode: OrgProfileCode | string | null;
  candidateProfileCode: OrgProfileCode | string;
  currentProfileSummary: ProfileSummary | null;
  candidateProfileSummary: ProfileSummary;
  numericChanges: ProfileDiffNumericField[];
  enumChanges: ProfileDiffEnumField[];
}

/**
 * Minimal preview payload used by the admin UI. Controllers are expected
 * to adapt `ProfileDiffResult` into this human-readable form.
 */
export interface ProfilePreviewDiff {
  /**
   * Free‑form summary paragraph describing the impact.
   */
  summary?: string;
  /**
   * Bullet points for the most important changes.
   */
  impact_bullets?: string[];
}

/* -------------------------------------------------------------------------- */
/*  Admin UI: current organization profile snapshot                           */
/* -------------------------------------------------------------------------- */

/**
 * Snapshot of an organization's current profile as expected by the
 * admin "Organization profile" screen.
 *
 * The `profile` sub-object is a relaxed, optional view over the
 * full ProfileTemplate/BehaviorProfile schema, using snake_case keys
 * exactly as in the YAML / backend.
 */
export interface OrgProfileSnapshot {
  organization_id: UUID;
  organization_slug?: string;
  organization_display_name?: string;
  profile_code: OrgProfileCode | string;
  /**
   * Profile version from `organization_profiles.version`, if available.
   */
  version?: number;
  profile: {
    description?: string;
    reactivity_seconds?: number;
    max_escalation_seconds?: number;
    transparency_level?: string;
    escalation_granularity?: string;
    review_frequency?: string;
    notification_scope?: string;
    pattern_sensitivity?: string;
    pattern_window_days?: number;
    pattern_min_events?: number;
    severity_threshold?: string;
    logging_level?: string;
    log_retention_days?: number;
    automation_level?: string;
    default_task_metadata?: {
      visibility?: string;
      default_priority?: string;
      default_reactivity_seconds?: number;
    };
    cyclic_overview?: {
      enabled?: boolean;
      schedule?: {
        weekly?: boolean;
        monthly?: boolean;
        yearly?: boolean;
      };
      threshold_triggers?: {
        incident_frequency?: {
          min_events?: number;
          window_days?: number;
        };
        cross_departmental_trends?: boolean;
        high_risk_indicators?: boolean;
      };
    };
  };
}

/* -------------------------------------------------------------------------- */
/*  Re‑exports for convenience                                                */
/* -------------------------------------------------------------------------- */

/**
 * Re-export core profile-related types from organization.ts so callers
 * can import them from a single module when working with profiles.
 */
export type {
  BehaviorProfile,
  BehaviorProfileMetadata,
  BehaviorProfileCyclicOverviewConfig,
  BehaviorProfilesMap,
  OrganizationProfile,
  OrganizationWithProfile,
};


=== FILE 9/24: apps/web/src/orgo/types/role.ts ===

// apps/web/src/orgo/types/role.ts

/**
 * Role and RBAC-related types for the Orgo web application.
 *
 * These map to the `roles` and `user_role_assignments` tables in the Orgo v3
 * database schema (Doc 1) and the RBAC HTTP API (`/rbac/*`).
 */

/**
 * Stable identifier type alias for roles.
 *
 * Maps to:
 *   - DB: roles.id
 */
export type RoleId = string;

/**
 * Stable identifier type alias for users within RBAC types.
 *
 * Maps to:
 *   - DB: user_accounts.id
 */
export type UserId = string;

/**
 * Stable identifier type alias for organizations.
 *
 * Maps to:
 *   - DB: organizations.id
 */
export type OrganizationId = string;

/**
 * ISO‑8601 timestamp string (UTC), used for audit fields.
 *
 * Examples:
 *   - "2025-11-18T10:30:00Z"
 */
export type IsoDateTimeString = string;

/**
 * Canonical role code.
 *
 * Stable lower_snake_case identifier used in configuration, logs and
 * routing rules, e.g. "ops_maintenance_coordinator".
 *
 * Maps to:
 *   - DB: roles.code
 */
export type RoleCode = string;

/**
 * Scope of a role assignment within an organization.
 *
 * Mirrors `user_role_assignments.scope_type`:
 *   - global   – applies across the whole organization
 *   - team     – scoped to a specific team
 *   - location – scoped to a site / location
 *   - unit     – scoped to a unit / department
 *   - custom   – caller-defined semantics in `scope_reference`
 */
export type RoleScopeType = 'global' | 'team' | 'location' | 'unit' | 'custom';

/**
 * Core Role representation as exposed by the RBAC API.
 *
 * Mirrors the logical shape of the `roles` table:
 *   - id: UUID primary key
 *   - organization_id: tenant that owns the role (null for global/system)
 *   - code: stable lower_snake_case code
 *   - display_name: human-readable label
 *   - description: free-text description of responsibilities
 *   - is_system_role: true for built-in/protected roles
 */
export interface Role {
  /**
   * Stable identifier for the role.
   * DB: roles.id
   */
  id: RoleId;

  /**
   * Owning organization (tenant) for org-scoped roles, or null
   * for global/system roles.
   * DB: roles.organization_id
   */
  organization_id: OrganizationId | null;

  /**
   * Stable lower_snake_case code, unique within the organization.
   * DB: roles.code
   */
  code: RoleCode;

  /**
   * Human-readable name.
   * DB: roles.display_name
   */
  display_name: string;

  /**
   * Longer free-text description of the role's responsibilities.
   * DB: roles.description
   */
  description: string;

  /**
   * True for built-in roles that cannot be modified or deleted
   * by tenants.
   * DB: roles.is_system_role
   */
  is_system_role: boolean;
}

/**
 * Database-level binding between a user and a role within an organization.
 *
 * Mirrors the `user_role_assignments` table:
 *   - id: UUID primary key
 *   - user_id: user being granted the role
 *   - role_id: granted role
 *   - organization_id: tenant in which the assignment applies
 *   - scope_type / scope_reference: optional scoping information
 *   - assigned_at / revoked_at: audit timestamps
 */
export interface UserRoleAssignment {
  /**
   * Stable identifier for the assignment.
   * DB: user_role_assignments.id
   */
  id: string;

  /**
   * User receiving the role.
   * DB: user_role_assignments.user_id
   */
  user_id: UserId;

  /**
   * Assigned role.
   * DB: user_role_assignments.role_id
   */
  role_id: RoleId;

  /**
   * Organization in which this assignment is valid.
   * DB: user_role_assignments.organization_id
   */
  organization_id: OrganizationId;

  /**
   * Scope type for this assignment (global/team/location/unit/custom).
   * DB: user_role_assignments.scope_type
   */
  scope_type: RoleScopeType;

  /**
   * Optional reference whose semantics depend on scope_type
   * (e.g. team id, location code).
   * DB: user_role_assignments.scope_reference
   */
  scope_reference: string | null;

  /**
   * When the role was granted to the user.
   * DB: user_role_assignments.assigned_at
   */
  assigned_at: IsoDateTimeString;

  /**
   * When the role was revoked, if ever.
   * DB: user_role_assignments.revoked_at
   */
  revoked_at: IsoDateTimeString | null;
}


=== FILE 10/24: apps/web/src/orgo/types/task.ts ===

// apps/web/src/orgo/types/task.ts

// Canonical Orgo Task types for the web app.
// This mirrors the Task JSON contract exposed by the API (Docs 2, 5, 8).

/**
 * Common scalar aliases used across Orgo types.
 */
export type UUID = string;
export type IsoDateTimeString = string; // e.g. "2025-11-18T10:30:00Z"
export type IsoDurationString = string; // e.g. "PT2H"
export type LabelCode = string; // "<BASE>.<CATEGORY><SUBCATEGORY>.<HORIZONTAL_ROLE>"

/**
 * Simple ID aliases for clarity.
 */
export type TaskId = UUID;
export type OrganizationId = UUID;
export type CaseId = UUID;

/**
 * Task status values (JSON-level).
 * Back-end maps these to DB enums (TASK_STATUS).
 *
 * - pending
 * - in_progress
 * - on_hold
 * - completed
 * - failed
 * - escalated
 * - cancelled
 */
export const TASK_STATUSES = [
  "pending",
  "in_progress",
  "on_hold",
  "completed",
  "failed",
  "escalated",
  "cancelled",
] as const;
export type TaskStatus = (typeof TASK_STATUSES)[number];

/**
 * Task priority values (JSON-level).
 * Maps to TASK_PRIORITY (LOW/MEDIUM/HIGH/CRITICAL) at DB/analytics level.
 *
 * - low
 * - medium
 * - high
 * - critical
 */
export const TASK_PRIORITIES = ["low", "medium", "high", "critical"] as const;
export type TaskPriority = (typeof TASK_PRIORITIES)[number];

/**
 * Task severity values (JSON-level).
 * Maps to TASK_SEVERITY (MINOR/MODERATE/MAJOR/CRITICAL).
 *
 * - minor
 * - moderate
 * - major
 * - critical
 */
export const TASK_SEVERITIES = [
  "minor",
  "moderate",
  "major",
  "critical",
] as const;
export type TaskSeverity = (typeof TASK_SEVERITIES)[number];

/**
 * Visibility values (JSON-level).
 * Maps to VISIBILITY (PUBLIC/INTERNAL/RESTRICTED/ANONYMISED).
 *
 * - public
 * - internal
 * - restricted
 * - anonymised
 */
export const TASK_VISIBILITIES = [
  "public",
  "internal",
  "restricted",
  "anonymised",
] as const;
export type Visibility = (typeof TASK_VISIBILITIES)[number];

/**
 * Task source/channel values (JSON-level).
 * Backed by task_source_enum in the DB.
 *
 * - email
 * - api
 * - manual
 * - sync
 */
export const TASK_SOURCES = ["email", "api", "manual", "sync"] as const;
export type TaskSource = (typeof TASK_SOURCES)[number];

/**
 * Global task category values (JSON-level).
 *
 * - request
 * - incident
 * - update
 * - report
 * - distribution
 */
export const TASK_CATEGORIES = [
  "request",
  "incident",
  "update",
  "report",
  "distribution",
] as const;
export type TaskCategory = (typeof TASK_CATEGORIES)[number];

/**
 * Arbitrary domain metadata attached to a Task.
 * Must not duplicate core fields (status, severity, etc.).
 */
export type TaskMetadata = Record<string, unknown>;

/**
 * Canonical Task object as returned by the Orgo API.
 * All timestamps are ISO-8601 strings (UTC).
 *
 * Mirrors the TaskDto shape from the Core Services API.
 */
export interface Task {
  // Identity and tenancy
  task_id: TaskId;
  organization_id: OrganizationId;
  case_id: CaseId | null;

  // Classification
  type: string;
  category: TaskCategory;
  subtype: string | null;
  label: LabelCode;

  // Core text
  title: string;
  description: string;

  // State and enums (JSON-level tokens)
  status: TaskStatus;
  priority: TaskPriority;
  severity: TaskSeverity;
  visibility: Visibility;
  source: TaskSource;

  // Ownership / actors (UUIDs at JSON level)
  created_by_user_id: UUID | null;
  requester_person_id: UUID | null;
  owner_role_id: UUID | null;
  owner_user_id: UUID | null;
  assignee_role: string | null;

  // Timing / SLA
  due_at: IsoDateTimeString | null;
  created_at: IsoDateTimeString;
  updated_at: IsoDateTimeString;
  closed_at: IsoDateTimeString | null;
  /**
   * ISO-8601 duration (e.g. "PT2H"); SLA window from creation used to derive
   * reactivity_deadline_at. Null if no explicit SLA window is set.
   */
  reactivity_time: IsoDurationString | null;
  reactivity_deadline_at: IsoDateTimeString | null;
  escalation_level: number;

  // Domain-specific payload
  metadata: TaskMetadata;
}


=== FILE 11/24: apps/web/src/screens/admin/cases/AdminCaseOverviewPage.tsx ===

import React, { useEffect, useState } from 'react';
import { useNavigate, useParams } from 'react-router-dom';

type CaseStatus =
  | 'OPEN'
  | 'IN_PROGRESS'
  | 'ON_HOLD'
  | 'RESOLVED'
  | 'CLOSED'
  | 'CANCELLED';

type CasePriority = 'LOW' | 'MEDIUM' | 'HIGH' | 'URGENT';

interface CaseUser {
  id: string;
  name: string;
  email?: string | null;
  avatarUrl?: string | null;
}

interface CaseNote {
  id: string;
  body: string;
  createdAt: string;
  author?: CaseUser | null;
  isInternal?: boolean;
}

interface CaseActivity {
  id: string;
  type:
    | 'status_change'
    | 'field_change'
    | 'comment'
    | 'note'
    | 'attachment'
    | 'system'
    | 'other';
  createdAt: string;
  actor?: CaseUser | null;
  message: string;
  metadata?: Record<string, unknown>;
}

interface CaseAttachment {
  id: string;
  fileName: string;
  url: string;
  fileSize?: number | null;
  contentType?: string | null;
  uploadedAt: string;
  uploadedBy?: CaseUser | null;
}

interface AdminCaseOverview {
  id: string;
  externalId?: string | null;
  title: string;
  summary?: string | null;
  description?: string | null;
  status: CaseStatus;
  priority: CasePriority;
  createdAt: string;
  updatedAt: string;
  closedAt?: string | null;
  slaDueAt?: string | null;
  tags?: string[];
  requester?: CaseUser | null;
  assignee?: CaseUser | null;
  teamName?: string | null;
  channel?: string | null;
  category?: string | null;
  subcategory?: string | null;
  activities?: CaseActivity[];
  notes?: CaseNote[];
  attachments?: CaseAttachment[];
}

type ActiveTab = 'summary' | 'activity' | 'notes' | 'attachments';

interface AdminCaseOverviewPageProps {
  /**
   * Optional caseId prop. If not provided, the component will
   * try to read `caseId` from the router params.
   */
  caseId?: string;
}

type LoadingState = 'idle' | 'loading' | 'success' | 'error' | 'not_found';

interface PageState {
  status: LoadingState;
  data: AdminCaseOverview | null;
  error: string | null;
}

const AdminCaseOverviewPage: React.FC<AdminCaseOverviewPageProps> = ({
  caseId: caseIdProp,
}) => {
  const { caseId: caseIdFromParams } = useParams<{ caseId: string }>();
  const navigate = useNavigate();

  const caseId = caseIdProp ?? caseIdFromParams ?? '';

  const [state, setState] = useState<PageState>({
    status: caseId ? 'loading' : 'idle',
    data: null,
    error: null,
  });
  const [activeTab, setActiveTab] = useState<ActiveTab>('summary');
  const [reloadToken, setReloadToken] = useState<number>(0);

  useEffect(() => {
    if (!caseId) {
      setState({
        status: 'error',
        data: null,
        error: 'Missing case id.',
      });
      return;
    }

    let cancelled = false;
    const controller = new AbortController();

    const fetchCase = async () => {
      setState((prev) => ({
        ...prev,
        status: 'loading',
        error: null,
      }));

      try {
        // Adjust this endpoint and query parameters to match your backend.
        const response = await fetch(
          `/api/admin/cases/${encodeURIComponent(caseId)}?include=overview`,
          { signal: controller.signal },
        );

        if (cancelled) {
          return;
        }

        if (response.status === 404) {
          setState({
            status: 'not_found',
            data: null,
            error: 'Case not found.',
          });
          return;
        }

        if (response.status === 403) {
          throw new Error('You do not have permission to view this case.');
        }

        if (!response.ok) {
          throw new Error('Unable to load case overview.');
        }

        const body = (await response.json()) as AdminCaseOverview;

        setState({
          status: 'success',
          data: body,
          error: null,
        });
      } catch (err) {
        if (cancelled || (err as any)?.name === 'AbortError') {
          return;
        }

        const message =
          err instanceof Error
            ? err.message
            : 'Unexpected error while loading case.';
        setState({
          status: 'error',
          data: null,
          error: message,
        });
      }
    };

    fetchCase();

    return () => {
      cancelled = true;
      controller.abort();
    };
  }, [caseId, reloadToken]);

  const { status, data, error } = state;
  const isLoading = status === 'idle' || status === 'loading';

  const handleRetry = () => {
    setReloadToken((value) => value + 1);
  };

  const handleBack = () => {
    // Adjust destination path to match your routing.
    navigate('/admin/cases');
  };

  const handleTabChange = (tab: ActiveTab) => {
    setActiveTab(tab);
    // If you persist tab selection to the URL, integrate it here.
  };

  const title =
    data?.title || (caseId ? `Case ${caseId}` : 'Case overview');

  return (
    <div className="AdminCaseOverviewPage">
      <header className="AdminCaseOverviewPage__header">
        <div className="AdminCaseOverviewPage__headerTop">
          <button
            type="button"
            onClick={handleBack}
            className="AdminCaseOverviewPage__backButton"
          >
            ← Back to cases
          </button>
        </div>

        <div className="AdminCaseOverviewPage__headerMain">
          <div>
            <h1 className="AdminCaseOverviewPage__title">{title}</h1>
            {data && (
              <div className="AdminCaseOverviewPage__metaRow">
                <StatusBadge status={data.status} />
                <PriorityBadge priority={data.priority} />
                <span className="AdminCaseOverviewPage__id">#{data.id}</span>
              </div>
            )}
          </div>

          {data && (
            <div className="AdminCaseOverviewPage__headerRight">
              <HeaderMeta
                label="Created"
                value={formatDateTime(data.createdAt)}
              />
              <HeaderMeta
                label="Updated"
                value={formatDateTime(data.updatedAt)}
              />
              {data.slaDueAt && (
                <HeaderMeta
                  label="SLA due"
                  value={formatDateTime(data.slaDueAt)}
                />
              )}
              {data.closedAt && (
                <HeaderMeta
                  label="Closed"
                  value={formatDateTime(data.closedAt)}
                />
              )}
            </div>
          )}
        </div>
      </header>

      {isLoading && (
        <div className="AdminCaseOverviewPage__state AdminCaseOverviewPage__state--loading">
          Loading case…
        </div>
      )}

      {!isLoading && status === 'not_found' && (
        <div className="AdminCaseOverviewPage__state AdminCaseOverviewPage__state--empty">
          <p>Case not found.</p>
          <div className="AdminCaseOverviewPage__stateActions">
            <button type="button" onClick={handleBack}>
              Back to cases
            </button>
          </div>
        </div>
      )}

      {!isLoading && status === 'error' && error && (
        <div className="AdminCaseOverviewPage__state AdminCaseOverviewPage__state--error">
          <p>{error}</p>
          <div className="AdminCaseOverviewPage__stateActions">
            <button type="button" onClick={handleRetry}>
              Try again
            </button>
            <button type="button" onClick={handleBack}>
              Back to cases
            </button>
          </div>
        </div>
      )}

      {!isLoading && status === 'success' && data && (
        <main className="AdminCaseOverviewPage__main">
          <section className="AdminCaseOverviewPage__topGrid">
            <SectionCard title="Case details">
              <p className="AdminCaseOverviewPage__summary">
                {data.summary || data.description || 'No summary provided.'}
              </p>
              <dl className="AdminCaseOverviewPage__detailsList">
                <KeyValueRow
                  label="External ID"
                  value={data.externalId || '—'}
                />
                <KeyValueRow
                  label="Category"
                  value={data.category || '—'}
                />
                <KeyValueRow
                  label="Subcategory"
                  value={data.subcategory || '—'}
                />
                <KeyValueRow
                  label="Channel"
                  value={data.channel || '—'}
                />
                {data.tags && data.tags.length > 0 && (
                  <div className="AdminCaseOverviewPage__detailsRow">
                    <dt>Tags</dt>
                    <dd>
                      <div className="AdminCaseOverviewPage__tags">
                        {data.tags.map((tag) => (
                          <span
                            key={tag}
                            className="AdminCaseOverviewPage__tag"
                          >
                            {tag}
                          </span>
                        ))}
                      </div>
                    </dd>
                  </div>
                )}
              </dl>
            </SectionCard>

            <SectionCard title="People">
              <div className="AdminCaseOverviewPage__people">
                <PersonRow label="Requester" user={data.requester} />
                <PersonRow label="Assignee" user={data.assignee} />
                <KeyValueRow
                  label="Team"
                  value={data.teamName || '—'}
                />
              </div>
            </SectionCard>
          </section>

          <section className="AdminCaseOverviewPage__tabsSection">
            <nav
              className="AdminCaseOverviewPage__tabs"
              aria-label="Case overview sections"
              role="tablist"
            >
              <TabButton
                label="Overview"
                isActive={activeTab === 'summary'}
                onClick={() => handleTabChange('summary')}
              />
              <TabButton
                label="Activity"
                isActive={activeTab === 'activity'}
                onClick={() => handleTabChange('activity')}
              />
              <TabButton
                label="Notes"
                isActive={activeTab === 'notes'}
                onClick={() => handleTabChange('notes')}
              />
              <TabButton
                label="Attachments"
                isActive={activeTab === 'attachments'}
                onClick={() => handleTabChange('attachments')}
              />
            </nav>

            <div className="AdminCaseOverviewPage__tabContent">
              {activeTab === 'summary' && (
                <SectionCard title="Overview">
                  <p>
                    {data.description ||
                      data.summary ||
                      'No additional information.'}
                  </p>
                  <dl className="AdminCaseOverviewPage__detailsList AdminCaseOverviewPage__detailsList--twoColumn">
                    <KeyValueRow
                      label="Status"
                      value={formatStatus(data.status)}
                    />
                    <KeyValueRow
                      label="Priority"
                      value={formatPriority(data.priority)}
                    />
                    <KeyValueRow
                      label="Created"
                      value={formatDateTime(data.createdAt)}
                    />
                    <KeyValueRow
                      label="Updated"
                      value={formatDateTime(data.updatedAt)}
                    />
                    <KeyValueRow
                      label="SLA due"
                      value={formatDateTime(data.slaDueAt)}
                    />
                    <KeyValueRow
                      label="Closed"
                      value={formatDateTime(data.closedAt)}
                    />
                  </dl>
                </SectionCard>
              )}

              {activeTab === 'activity' && (
                <SectionCard title="Activity">
                  <ActivityList activities={data.activities || []} />
                </SectionCard>
              )}

              {activeTab === 'notes' && (
                <SectionCard title="Notes">
                  <NotesList notes={data.notes || []} />
                  {/* Hook up your note composer / editor component here */}
                </SectionCard>
              )}

              {activeTab === 'attachments' && (
                <SectionCard title="Attachments">
                  <AttachmentsList
                    attachments={data.attachments || []}
                  />
                </SectionCard>
              )}
            </div>
          </section>
        </main>
      )}
    </div>
  );
};

interface StatusBadgeProps {
  status: CaseStatus;
}

const StatusBadge: React.FC<StatusBadgeProps> = ({ status }) => {
  return (
    <span
      className={`AdminCaseOverviewPage__status AdminCaseOverviewPage__status--${status}`}
    >
      {formatStatus(status)}
    </span>
  );
};

interface PriorityBadgeProps {
  priority: CasePriority;
}

const PriorityBadge: React.FC<PriorityBadgeProps> = ({ priority }) => {
  return (
    <span
      className={`AdminCaseOverviewPage__priority AdminCaseOverviewPage__priority--${priority}`}
    >
      {formatPriority(priority)}
    </span>
  );
};

interface HeaderMetaProps {
  label: string;
  value: string;
}

const HeaderMeta: React.FC<HeaderMetaProps> = ({ label, value }) => (
  <div className="AdminCaseOverviewPage__headerMeta">
    <div className="AdminCaseOverviewPage__headerMetaLabel">{label}</div>
    <div className="AdminCaseOverviewPage__headerMetaValue">{value}</div>
  </div>
);

interface SectionCardProps {
  title: string;
  children: React.ReactNode;
}

const SectionCard: React.FC<SectionCardProps> = ({ title, children }) => (
  <section className="AdminCaseOverviewPage__card">
    <h2 className="AdminCaseOverviewPage__cardTitle">{title}</h2>
    <div className="AdminCaseOverviewPage__cardBody">{children}</div>
  </section>
);

interface KeyValueRowProps {
  label: string;
  value: string;
}

const KeyValueRow: React.FC<KeyValueRowProps> = ({ label, value }) => (
  <div className="AdminCaseOverviewPage__detailsRow">
    <dt>{label}</dt>
    <dd>{value}</dd>
  </div>
);

interface PersonRowProps {
  label: string;
  user?: CaseUser | null;
}

const PersonRow: React.FC<PersonRowProps> = ({ label, user }) => (
  <div className="AdminCaseOverviewPage__personRow">
    <div className="AdminCaseOverviewPage__personLabel">{label}</div>
    {user ? (
      <div className="AdminCaseOverviewPage__person">
        <Avatar name={user.name} avatarUrl={user.avatarUrl} />
        <div className="AdminCaseOverviewPage__personInfo">
          <div className="AdminCaseOverviewPage__personName">
            {user.name}
          </div>
          {user.email && (
            <div className="AdminCaseOverviewPage__personEmail">
              {user.email}
            </div>
          )}
        </div>
      </div>
    ) : (
      <div className="AdminCaseOverviewPage__personEmpty">
        Unassigned
      </div>
    )}
  </div>
);

interface AvatarProps {
  name: string;
  avatarUrl?: string | null;
}

const Avatar: React.FC<AvatarProps> = ({ name, avatarUrl }) => {
  const initial = name?.trim()?.charAt(0).toUpperCase() || '?';

  if (avatarUrl) {
    return (
      <img
        src={avatarUrl}
        alt={name}
        className="AdminCaseOverviewPage__avatar"
      />
    );
  }

  return (
    <div className="AdminCaseOverviewPage__avatar AdminCaseOverviewPage__avatar--fallback">
      {initial}
    </div>
  );
};

interface TabButtonProps {
  label: string;
  isActive: boolean;
  onClick: () => void;
}

const TabButton: React.FC<TabButtonProps> = ({
  label,
  isActive,
  onClick,
}) => (
  <button
    type="button"
    className={`AdminCaseOverviewPage__tabButton${
      isActive ? ' AdminCaseOverviewPage__tabButton--active' : ''
    }`}
    onClick={onClick}
    role="tab"
    aria-selected={isActive}
  >
    {label}
  </button>
);

interface NotesListProps {
  notes: CaseNote[];
}

const NotesList: React.FC<NotesListProps> = ({ notes }) => {
  if (!notes.length) {
    return (
      <div className="AdminCaseOverviewPage__emptyState">
        No notes yet.
      </div>
    );
  }

  return (
    <ul className="AdminCaseOverviewPage__notesList">
      {notes.map((note) => (
        <li key={note.id} className="AdminCaseOverviewPage__noteItem">
          <div className="AdminCaseOverviewPage__noteHeader">
            <div className="AdminCaseOverviewPage__noteAuthor">
              {note.author ? (
                <>
                  <Avatar
                    name={note.author.name}
                    avatarUrl={note.author.avatarUrl}
                  />
                  <span className="AdminCaseOverviewPage__noteAuthorName">
                    {note.author.name}
                  </span>
                </>
              ) : (
                <span className="AdminCaseOverviewPage__noteAuthorName">
                  System
                </span>
              )}
            </div>
            <div className="AdminCaseOverviewPage__noteMeta">
              <span className="AdminCaseOverviewPage__noteTimestamp">
                {formatDateTime(note.createdAt)}
              </span>
              {note.isInternal && (
                <span className="AdminCaseOverviewPage__noteInternalTag">
                  Internal
                </span>
              )}
            </div>
          </div>
          <div className="AdminCaseOverviewPage__noteBody">
            {note.body}
          </div>
        </li>
      ))}
    </ul>
  );
};

interface ActivityListProps {
  activities: CaseActivity[];
}

const ActivityList: React.FC<ActivityListProps> = ({ activities }) => {
  if (!activities.length) {
    return (
      <div className="AdminCaseOverviewPage__emptyState">
        No activity yet.
      </div>
    );
  }

  return (
    <ul className="AdminCaseOverviewPage__activityList">
      {activities.map((activity) => (
        <li
          key={activity.id}
          className="AdminCaseOverviewPage__activityItem"
        >
          <div className="AdminCaseOverviewPage__activityHeader">
            <div className="AdminCaseOverviewPage__activityActor">
              {activity.actor ? (
                <>
                  <Avatar
                    name={activity.actor.name}
                    avatarUrl={activity.actor.avatarUrl}
                  />
                  <span className="AdminCaseOverviewPage__activityActorName">
                    {activity.actor.name}
                  </span>
                </>
              ) : (
                <span className="AdminCaseOverviewPage__activityActorName">
                  System
                </span>
              )}
            </div>
            <span className="AdminCaseOverviewPage__activityTimestamp">
              {formatDateTime(activity.createdAt)}
            </span>
          </div>
          <div className="AdminCaseOverviewPage__activityMessage">
            {activity.message}
          </div>
        </li>
      ))}
    </ul>
  );
};

interface AttachmentsListProps {
  attachments: CaseAttachment[];
}

const AttachmentsList: React.FC<AttachmentsListProps> = ({
  attachments,
}) => {
  if (!attachments.length) {
    return (
      <div className="AdminCaseOverviewPage__emptyState">
        No attachments.
      </div>
    );
  }

  return (
    <ul className="AdminCaseOverviewPage__attachmentsList">
      {attachments.map((attachment) => (
        <li
          key={attachment.id}
          className="AdminCaseOverviewPage__attachmentItem"
        >
          <div className="AdminCaseOverviewPage__attachmentMain">
            <a
              href={attachment.url}
              target="_blank"
              rel="noopener noreferrer"
              className="AdminCaseOverviewPage__attachmentName"
            >
              {attachment.fileName}
            </a>
            <div className="AdminCaseOverviewPage__attachmentMeta">
              {attachment.fileSize != null && (
                <span>{formatBytes(attachment.fileSize)}</span>
              )}
              {attachment.contentType && (
                <span className="AdminCaseOverviewPage__attachmentContentType">
                  {attachment.contentType}
                </span>
              )}
            </div>
          </div>
          <div className="AdminCaseOverviewPage__attachmentFooter">
            <span>{formatDateTime(attachment.uploadedAt)}</span>
            {attachment.uploadedBy && (
              <span className="AdminCaseOverviewPage__attachmentUploader">
                by {attachment.uploadedBy.name}
              </span>
            )}
          </div>
        </li>
      ))}
    </ul>
  );
};

function formatStatus(status: CaseStatus): string {
  return status
    .toLowerCase()
    .split('_')
    .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
    .join(' ');
}

function formatPriority(priority: CasePriority): string {
  const label = priority.toLowerCase();
  return label.charAt(0).toUpperCase() + label.slice(1);
}

function formatDateTime(value?: string | null): string {
  if (!value) {
    return '—';
  }
  const date = new Date(value);
  if (Number.isNaN(date.getTime())) {
    return value;
  }
  return date.toLocaleString();
}

function formatBytes(size: number): string {
  if (size === 0) return '0 B';
  const units = ['B', 'KB', 'MB', 'GB', 'TB'];
  const exponent = Math.floor(Math.log(size) / Math.log(1024));
  const value = size / Math.pow(1024, exponent);
  return `${value.toFixed(1)} ${units[exponent]}`;
}

export default AdminCaseOverviewPage;


=== FILE 12/24: apps/web/src/screens/admin/insights/InsightsOverviewPage.tsx ===

import React, { useCallback, useEffect, useState } from 'react';

type Timeframe = '7d' | '30d' | '90d';

export interface InsightsMetric {
  id: string;
  label: string;
  value: number;
  formattedValue?: string;
  /**
   * Percentage change vs previous comparable period.
   * Example: 0.12 for +12%, -0.05 for -5%.
   */
  changePercent?: number | null;
}

export interface TimeSeriesPoint {
  /**
   * ISO 8601 date string, e.g. "2025-01-15".
   */
  date: string;
  value: number;
}

export interface InsightsOverview {
  timeframe: Timeframe;
  metrics: InsightsMetric[];
  primaryTrend: TimeSeriesPoint[];
  secondaryTrend?: TimeSeriesPoint[];
  /**
   * ISO timestamp when this snapshot was generated.
   */
  generatedAt?: string;
}

interface UseInsightsOverviewResult {
  data: InsightsOverview | null;
  loading: boolean;
  error: Error | null;
  refetch: () => void;
}

const TIMEFRAME_OPTIONS: { value: Timeframe; label: string }[] = [
  { value: '7d', label: 'Last 7 days' },
  { value: '30d', label: 'Last 30 days' },
  { value: '90d', label: 'Last 90 days' },
];

export const InsightsOverviewPage: React.FC = () => {
  const [timeframe, setTimeframe] = useState<Timeframe>('30d');
  const { data, loading, error, refetch } = useInsightsOverview(timeframe);

  const hasMetrics = !!data && data.metrics.length > 0;
  const hasTrend = !!data && data.primaryTrend && data.primaryTrend.length > 0;

  return (
    <div className="insights-page">
      <header className="insights-page__header">
        <div className="insights-page__heading">
          <h1 className="insights-page__title">Insights overview</h1>
          <p className="insights-page__subtitle">
            High‑level product usage metrics and trends for your workspace.
          </p>
        </div>

        <div className="insights-page__controls">
          <TimeframeSelect value={timeframe} onChange={setTimeframe} />
        </div>
      </header>

      {loading && !data && <LoadingState />}

      {!loading && error && (
        <ErrorState message={error.message} onRetry={refetch} />
      )}

      {!loading && !error && !hasMetrics && (
        <EmptyState />
      )}

      {!loading && !error && data && hasMetrics && (
        <>
          <MetricsGrid
            metrics={data.metrics}
            generatedAt={data.generatedAt}
          />

          <section className="insights-page__section">
            <div className="insights-page__section-header">
              <h2 className="insights-page__section-title">Activity over time</h2>
              {hasTrend && (
                <p className="insights-page__section-subtitle">
                  {formatDateRangeFromPoints(data.primaryTrend)}
                </p>
              )}
            </div>

            {hasTrend ? (
              <TrendChart points={data.primaryTrend} />
            ) : (
              <div className="insights-page__section-empty">
                <p>No trend data available for the selected timeframe.</p>
              </div>
            )}
          </section>
        </>
      )}
    </div>
  );
};

export default InsightsOverviewPage;

function TimeframeSelect(props: {
  value: Timeframe;
  onChange: (value: Timeframe) => void;
}) {
  const handleChange = (event: React.ChangeEvent<HTMLSelectElement>) => {
    props.onChange(event.target.value as Timeframe);
  };

  return (
    <label className="insights-timeframe-select">
      <span className="insights-timeframe-select__label">Timeframe</span>
      <select
        className="insights-timeframe-select__control"
        value={props.value}
        onChange={handleChange}
      >
        {TIMEFRAME_OPTIONS.map((option) => (
          <option key={option.value} value={option.value}>
            {option.label}
          </option>
        ))}
      </select>
    </label>
  );
}

function MetricsGrid(props: {
  metrics: InsightsMetric[];
  generatedAt?: string;
}) {
  return (
    <section className="insights-page__section">
      <div className="insights-page__section-header">
        <h2 className="insights-page__section-title">Key metrics</h2>
        {props.generatedAt && (
          <p className="insights-page__section-subtitle">
            Last updated {formatRelativeDateTime(props.generatedAt)}
          </p>
        )}
      </div>

      <div className="insights-metrics-grid">
        {props.metrics.map((metric) => (
          <MetricCard key={metric.id} metric={metric} />
        ))}
      </div>
    </section>
  );
}

function MetricCard(props: { metric: InsightsMetric }) {
  const { metric } = props;
  const hasChange =
    typeof metric.changePercent === 'number' &&
    !Number.isNaN(metric.changePercent);

  const changeLabel = hasChange
    ? formatPercent(metric.changePercent as number)
    : null;

  const changePositive =
    hasChange && (metric.changePercent as number) > 0;

  const changeNegative =
    hasChange && (metric.changePercent as number) < 0;

  const changeClassName = [
    'insights-metric-card__change',
    changePositive && 'insights-metric-card__change--positive',
    changeNegative && 'insights-metric-card__change--negative',
  ]
    .filter(Boolean)
    .join(' ');

  return (
    <article className="insights-metric-card">
      <header className="insights-metric-card__header">
        <span className="insights-metric-card__label">
          {metric.label}
        </span>
      </header>

      <div className="insights-metric-card__value">
        {metric.formattedValue ?? metric.value.toLocaleString()}
      </div>

      {hasChange && changeLabel && (
        <div className={changeClassName}>
          <span className="insights-metric-card__change-value">
            {changeLabel}
          </span>
          <span className="insights-metric-card__change-caption">
            vs previous period
          </span>
        </div>
      )}
    </article>
  );
}

function TrendChart(props: { points: TimeSeriesPoint[] }) {
  const { points } = props;

  if (!points.length) {
    return null;
  }

  const sortedPoints = [...points].sort(
    (a, b) => new Date(a.date).getTime() - new Date(b.date).getTime(),
  );

  const values = sortedPoints.map((p) => p.value);
  const max = Math.max(...values);
  const min = Math.min(...values);
  const range = max - min || 1;

  const width = 100;
  const height = 40;

  const pathD = sortedPoints
    .map((point, index) => {
      const x =
        (index / Math.max(sortedPoints.length - 1, 1)) * width;
      const y =
        height -
        ((point.value - min) / range) * height;

      return `${index === 0 ? 'M' : 'L'} ${x} ${y}`;
    })
    .join(' ');

  return (
    <div className="insights-chart">
      <svg
        className="insights-chart__svg"
        viewBox={`0 0 ${width} ${height}`}
        preserveAspectRatio="none"
      >
        <path
          d={pathD}
          className="insights-chart__line"
          fill="none"
          stroke="currentColor"
          strokeWidth={1.5}
          strokeLinecap="round"
          strokeLinejoin="round"
        />
      </svg>

      <div className="insights-chart__axis insights-chart__axis--x">
        <span className="insights-chart__axis-label">
          {formatShortDate(sortedPoints[0].date)}
        </span>
        <span className="insights-chart__axis-label insights-chart__axis-label--end">
          {formatShortDate(
            sortedPoints[sortedPoints.length - 1].date,
          )}
        </span>
      </div>
    </div>
  );
}

function LoadingState() {
  return (
    <section className="insights-state insights-state--loading">
      <div className="insights-state__content">
        <div className="insights-state__spinner" aria-hidden="true" />
        <div className="insights-state__text">
          <h2 className="insights-state__title">Loading insights</h2>
          <p className="insights-state__description">
            Fetching your latest metrics and trends…
          </p>
        </div>
      </div>
    </section>
  );
}

function ErrorState(props: {
  message: string;
  onRetry: () => void;
}) {
  return (
    <section className="insights-state insights-state--error">
      <div className="insights-state__content">
        <h2 className="insights-state__title">
          Unable to load insights
        </h2>
        <p className="insights-state__description">
          {props.message || 'Something went wrong while fetching data.'}
        </p>
        <button
          type="button"
          className="insights-state__action"
          onClick={props.onRetry}
        >
          Try again
        </button>
      </div>
    </section>
  );
}

function EmptyState() {
  return (
    <section className="insights-state insights-state--empty">
      <div className="insights-state__content">
        <h2 className="insights-state__title">No insights yet</h2>
        <p className="insights-state__description">
          We haven&apos;t generated insights for this workspace and
          timeframe yet. Try expanding the timeframe or check back
          later once more data is available.
        </p>
      </div>
    </section>
  );
}

/**
 * Data fetching hook for the overview.
 *
 * This uses the Fetch API directly so it does not depend on a specific
 * query library. If your app uses React Query / SWR / etc., you can
 * replace the internals with your standard pattern.
 */
function useInsightsOverview(timeframe: Timeframe): UseInsightsOverviewResult {
  const [data, setData] = useState<InsightsOverview | null>(null);
  const [loading, setLoading] = useState<boolean>(false);
  const [error, setError] = useState<Error | null>(null);
  const [reloadToken, setReloadToken] = useState<number>(0);

  const refetch = useCallback(() => {
    setReloadToken((prev) => prev + 1);
  }, []);

  useEffect(() => {
    let cancelled = false;

    const load = async () => {
      setLoading(true);
      setError(null);

      try {
        const response = await fetch(
          `/api/admin/insights/overview?timeframe=${encodeURIComponent(
            timeframe,
          )}`,
        );

        if (!response.ok) {
          throw new Error('Failed to load insights overview');
        }

        const json = (await response.json()) as InsightsOverview;

        if (!cancelled) {
          setData(json);
        }
      } catch (err) {
        if (!cancelled) {
          setError(
            err instanceof Error
              ? err
              : new Error('Unknown error while loading insights'),
          );
        }
      } finally {
        if (!cancelled) {
          setLoading(false);
        }
      }
    };

    void load();

    return () => {
      cancelled = true;
    };
  }, [timeframe, reloadToken]);

  return { data, loading, error, refetch };
}

/**
 * Helpers
 */

function formatRelativeDateTime(isoString: string): string {
  const date = new Date(isoString);
  if (Number.isNaN(date.getTime())) {
    return 'unknown';
  }

  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMinutes = Math.round(diffMs / (1000 * 60));

  if (diffMinutes < 1) {
    return 'just now';
  }
  if (diffMinutes < 60) {
    return `${diffMinutes} min ago`;
  }

  const diffHours = Math.round(diffMinutes / 60);
  if (diffHours < 24) {
    return `${diffHours} h ago`;
  }

  const diffDays = Math.round(diffHours / 24);
  if (diffDays < 7) {
    return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
  }

  return new Intl.DateTimeFormat(undefined, {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  }).format(date);
}

function formatPercent(value: number): string {
  return new Intl.NumberFormat(undefined, {
    style: 'percent',
    maximumFractionDigits: 1,
  }).format(value);
}

function formatShortDate(isoDate: string): string {
  const date = new Date(isoDate);
  if (Number.isNaN(date.getTime())) {
    return isoDate;
  }

  return new Intl.DateTimeFormat(undefined, {
    month: 'short',
    day: 'numeric',
  }).format(date);
}

function formatDateRangeFromPoints(points: TimeSeriesPoint[]): string {
  if (!points.length) {
    return '';
  }

  const sorted = [...points].sort(
    (a, b) => new Date(a.date).getTime() - new Date(b.date).getTime(),
  );

  const start = new Date(sorted[0].date);
  const end = new Date(sorted[sorted.length - 1].date);

  if (
    Number.isNaN(start.getTime()) ||
    Number.isNaN(end.getTime())
  ) {
    return '';
  }

  const sameYear = start.getFullYear() === end.getFullYear();

  const formatter = new Intl.DateTimeFormat(undefined, sameYear
    ? { month: 'short', day: 'numeric' }
    : { month: 'short', day: 'numeric', year: 'numeric' });

  return `${formatter.format(start)} – ${formatter.format(end)}`;
}


=== FILE 13/24: apps/web/src/screens/admin/org/OrgProfileSettingsPage.tsx ===

// apps/web/src/screens/admin/org/OrgProfileSettingsPage.tsx

import React, { useEffect, useMemo, useState } from "react";
import {
  useOrgProfilesQuery,
  useProfilePreviewMutation,
  useUpdateServiceConfigMutation,
} from "../../../store/services/orgoApi";
import type {
  OrgProfileCode,
  OrgProfileSnapshot,
  ProfilePreviewDiff,
} from "../../../orgo/types/profile";

const PROFILE_OPTIONS: { code: OrgProfileCode; label: string; description: string }[] = [
  {
    code: "default",
    label: "Default",
    description: "Balanced defaults for reactivity, transparency, logging and pattern detection.",
  },
  {
    code: "friend_group",
    label: "Friend group",
    description: "Low-stakes group with relaxed timing and light logging.",
  },
  {
    code: "hospital",
    label: "Hospital",
    description: "Safety-critical environment with fast escalation and strict privacy.",
  },
  {
    code: "advocacy_group",
    label: "Advocacy group",
    description: "Mission-driven NGO with responsive handling and strong traceability.",
  },
  {
    code: "retail_chain",
    label: "Retail chain",
    description: "Distributed operations, store-level incidents, mixed urgency and retention.",
  },
  {
    code: "military_organization",
    label: "Military organization",
    description: "Highly sensitive context with aggressive escalation and full audit logging.",
  },
  {
    code: "environmental_group",
    label: "Environmental group",
    description: "Campaign-driven work with high pattern sensitivity and wide signalling.",
  },
  {
    code: "artist_collective",
    label: "Artist collective",
    description: "Creative group; relaxed timing, minimal logging, low pattern sensitivity.",
  },
];

/**
 * Format seconds into a coarse human-readable duration.
 */
function formatSeconds(value?: number): string {
  if (value == null) return "—";
  if (value < 60) return `${value}s`;
  const minutes = Math.round(value / 60);
  if (minutes < 60) return `${minutes} min`;
  const hours = Math.round(minutes / 60);
  if (hours < 24) return `${hours} h`;
  const days = Math.round(hours / 24);
  return `${days} d`;
}

/**
 * Small badge component for enum-like values.
 */
function Pill(props: { children: React.ReactNode }) {
  return (
    <span className="inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-medium">
      {props.children}
    </span>
  );
}

/**
 * Admin view to inspect and edit organization profiles and preview their impact.
 *
 * Assumptions (to be matched by the API implementation):
 * - useOrgProfilesQuery() returns either:
 *   - the active OrgProfileSnapshot for the current organization, or
 *   - an array of OrgProfileSnapshot, where index 0 is the active one.
 * - useProfilePreviewMutation() accepts:
 *     { organizationId, currentProfileCode, proposedProfileCode }
 *   and returns { summary, impact_bullets }.
 * - useUpdateServiceConfigMutation() accepts:
 *     { module: "org_profiles", organizationId, profileCode }
 *   and persists the change with audit logging.
 */
const OrgProfileSettingsPage: React.FC = () => {
  const { data, isLoading, isError, refetch } = useOrgProfilesQuery();

  const activeProfile: OrgProfileSnapshot | undefined = useMemo(() => {
    if (!data) return undefined;
    if (Array.isArray(data)) {
      return (data[0] ?? null) as OrgProfileSnapshot | null | undefined;
    }
    return data as OrgProfileSnapshot;
  }, [data]);

  const [selectedProfileCode, setSelectedProfileCode] = useState<OrgProfileCode | "">("");
  const [triggerPreview, { data: previewData, isLoading: isPreviewLoading }] =
    useProfilePreviewMutation();
  const [updateConfig, { isLoading: isSaving, isSuccess: isSaveSuccess, error: saveError }] =
    useUpdateServiceConfigMutation();

  const preview: ProfilePreviewDiff | undefined = previewData as ProfilePreviewDiff | undefined;

  useEffect(() => {
    if (activeProfile?.profile_code) {
      setSelectedProfileCode(activeProfile.profile_code as OrgProfileCode);
    }
  }, [activeProfile?.profile_code]);

  const organizationName =
    activeProfile?.organization_display_name ||
    activeProfile?.organization_slug ||
    "Current organization";

  const currentProfileOption = PROFILE_OPTIONS.find(
    (opt) => opt.code === activeProfile?.profile_code
  );
  const selectedProfileOption = PROFILE_OPTIONS.find((opt) => opt.code === selectedProfileCode);

  const hasChanges =
    !!activeProfile &&
    !!selectedProfileCode &&
    selectedProfileCode !== (activeProfile.profile_code as OrgProfileCode);

  const handlePreview = () => {
    if (!activeProfile || !hasChanges) return;
    triggerPreview({
      organizationId: activeProfile.organization_id,
      currentProfileCode: activeProfile.profile_code,
      proposedProfileCode: selectedProfileCode,
    });
  };

  const handleSave = () => {
    if (!activeProfile || !selectedProfileCode) return;
    updateConfig({
      module: "org_profiles",
      organizationId: activeProfile.organization_id,
      profileCode: selectedProfileCode,
    });
  };

  if (isLoading) {
    return (
      <div className="p-6">
        <h1 className="mb-4 text-2xl font-semibold">Organization profile</h1>
        <p className="text-sm text-gray-600">Loading profile…</p>
      </div>
    );
  }

  if (isError || !activeProfile) {
    return (
      <div className="p-6">
        <h1 className="mb-4 text-2xl font-semibold">Organization profile</h1>
        <div className="rounded-md border border-red-200 bg-red-50 p-4 text-sm text-red-800">
          <p className="mb-2">Could not load the organization profile.</p>
          <button
            type="button"
            onClick={() => refetch()}
            className="rounded border px-3 py-1 text-xs font-medium"
          >
            Retry
          </button>
        </div>
      </div>
    );
  }

  const p = activeProfile.profile;

  return (
    <div className="p-6">
      <header className="mb-6 space-y-2">
        <h1 className="text-2xl font-semibold">Organization profile</h1>
        <p className="max-w-2xl text-sm text-gray-600">
          Profiles control how quickly work escalates, who can see it, how long records are kept,
          and how sensitive pattern detection is for{" "}
          <span className="font-medium">{organizationName}</span>.
        </p>
      </header>

      <div className="grid gap-6 lg:grid-cols-3">
        {/* Current profile summary */}
        <section className="space-y-4 rounded-lg border bg-white p-4 lg:col-span-2">
          <div className="flex items-start justify-between gap-4">
            <div>
              <p className="text-xs font-medium uppercase text-gray-500">
                Active profile archetype
              </p>
              <div className="mt-1 flex items-center gap-2">
                <span className="text-lg font-semibold">
                  {currentProfileOption?.label || activeProfile.profile_code}
                </span>
                <Pill>{activeProfile.profile_code}</Pill>
                {typeof activeProfile.version === "number" && (
                  <span className="text-xs text-gray-500">v{activeProfile.version}</span>
                )}
              </div>
              {p.description && (
                <p className="mt-1 max-w-xl text-sm text-gray-600">{p.description}</p>
              )}
            </div>
          </div>

          <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Reactivity</p>
              <p className="mt-1 text-sm">
                First escalation in{" "}
                <span className="font-medium">{formatSeconds(p.reactivity_seconds)}</span>
              </p>
              <p className="text-xs text-gray-500">
                Max escalation: {formatSeconds(p.max_escalation_seconds)}
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Transparency</p>
              <p className="mt-1 text-sm">
                <Pill>{p.transparency_level || "—"}</Pill>
              </p>
              <p className="text-xs text-gray-500">
                Escalation granularity: {p.escalation_granularity || "—"}
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Reviews</p>
              <p className="mt-1 text-sm">
                <Pill>{p.review_frequency || "—"}</Pill>
              </p>
              <p className="text-xs text-gray-500">
                Notification scope: {p.notification_scope || "—"}
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Patterns</p>
              <p className="mt-1 text-sm">
                Sensitivity: <Pill>{p.pattern_sensitivity || "—"}</Pill>
              </p>
              <p className="text-xs text-gray-500">
                Window: {p.pattern_window_days ?? "—"} days, min events:{" "}
                {p.pattern_min_events ?? "—"}
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Logging &amp; retention</p>
              <p className="mt-1 text-sm">
                Logging: <Pill>{p.logging_level || "—"}</Pill>
              </p>
              <p className="text-xs text-gray-500">
                Log retention: {p.log_retention_days != null ? `${p.log_retention_days} days` : "—"}
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Automation</p>
              <p className="mt-1 text-sm">
                Level: <Pill>{p.automation_level || "—"}</Pill>
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Default Task metadata</p>
              <p className="mt-1 text-sm">
                Visibility:{" "}
                <Pill>{p.default_task_metadata?.visibility?.toLowerCase() || "—"}</Pill>
              </p>
              <p className="text-xs text-gray-500">
                Priority: {p.default_task_metadata?.default_priority || "—"},{" "}
                reactivity:{" "}
                {formatSeconds(p.default_task_metadata?.default_reactivity_seconds ?? undefined)}
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Cyclic overview</p>
              <p className="mt-1 text-sm">
                {p.cyclic_overview?.enabled ? (
                  <Pill>enabled</Pill>
                ) : (
                  <Pill>disabled</Pill>
                )}
              </p>
              <p className="text-xs text-gray-500">
                Schedule:{" "}
                {[
                  p.cyclic_overview?.schedule?.weekly && "weekly",
                  p.cyclic_overview?.schedule?.monthly && "monthly",
                  p.cyclic_overview?.schedule?.yearly && "yearly",
                ]
                  .filter(Boolean)
                  .join(", ") || "—"}
              </p>
            </div>
          </div>
        </section>

        {/* Edit + preview column */}
        <section className="space-y-4 rounded-lg border bg-white p-4">
          <div>
            <p className="text-xs font-medium uppercase text-gray-500">Select profile archetype</p>
            <label className="mt-2 block text-sm">
              <span className="mb-1 block text-gray-700">Archetype</span>
              <select
                value={selectedProfileCode}
                onChange={(e) => setSelectedProfileCode(e.target.value as OrgProfileCode)}
                className="mt-1 block w-full rounded-md border px-3 py-2 text-sm"
              >
                {PROFILE_OPTIONS.map((option) => (
                  <option key={option.code} value={option.code}>
                    {option.label}
                  </option>
                ))}
              </select>
            </label>
            {selectedProfileOption && (
              <p className="mt-2 text-xs text-gray-500">{selectedProfileOption.description}</p>
            )}
          </div>

          <div className="flex flex-col gap-2 border-t pt-4 text-sm">
            <div className="flex flex-wrap items-center gap-2">
              <button
                type="button"
                onClick={handlePreview}
                disabled={!hasChanges || isPreviewLoading}
                className="rounded-md border px-3 py-1 text-xs font-medium disabled:opacity-60"
              >
                {isPreviewLoading ? "Previewing…" : "Preview impact"}
              </button>
              <button
                type="button"
                onClick={handleSave}
                disabled={!hasChanges || isSaving}
                className="rounded-md bg-black px-3 py-1 text-xs font-medium text-white disabled:opacity-60"
              >
                {isSaving ? "Saving…" : "Apply change"}
              </button>
            </div>

            {isSaveSuccess && (
              <p className="text-xs text-green-700">
                Profile updated. New defaults will apply to future Tasks and Cases.
              </p>
            )}
            {saveError && (
              <p className="text-xs text-red-700">
                Failed to save changes. Please try again or check configuration logs.
              </p>
            )}
          </div>

          <div className="border-t pt-4">
            <p className="mb-2 text-xs font-medium uppercase text-gray-500">Preview</p>
            {!preview && !isPreviewLoading && (
              <p className="text-xs text-gray-500">
                Choose a different profile and click &ldquo;Preview impact&rdquo; to see how
                escalation, visibility, retention and patterns would change.
              </p>
            )}

            {preview && (
              <div className="space-y-2 text-xs">
                {preview.summary && <p className="text-gray-700">{preview.summary}</p>}
                {preview.impact_bullets && preview.impact_bullets.length > 0 && (
                  <ul className="list-disc space-y-1 pl-4 text-gray-700">
                    {preview.impact_bullets.map((item, index) => (
                      <li key={index}>{item}</li>
                    ))}
                  </ul>
                )}
              </div>
            )}
          </div>
        </section>
      </div>
    </div>
  );
};

export default OrgProfileSettingsPage;


=== FILE 14/24: apps/web/src/screens/admin/profiles/OrgProfileSettingsPage.tsx ===

import React, { useEffect, useMemo, useState } from "react";
import {
  // Assumed RTK Query hooks defined in apps/web/src/store/services/orgoApi.ts
  useOrgProfilesQuery,
  useProfilePreviewMutation,
  useUpdateServiceConfigMutation,
} from "../../../store/services/orgoApi";

export type OrgProfileCode =
  | "default"
  | "friend_group"
  | "hospital"
  | "advocacy_group"
  | "retail_chain"
  | "military_organization"
  | "environmental_group"
  | "artist_collective";

const PROFILE_OPTIONS: { code: OrgProfileCode; label: string; description: string }[] = [
  {
    code: "default",
    label: "Default",
    description: "Balanced defaults for reactivity, transparency, logging and pattern detection.",
  },
  {
    code: "friend_group",
    label: "Friend group",
    description: "Low‑stakes group with relaxed timing and light logging.",
  },
  {
    code: "hospital",
    label: "Hospital",
    description: "Safety‑critical environment with fast escalation and strict privacy.",
  },
  {
    code: "advocacy_group",
    label: "Advocacy group",
    description: "Mission‑driven NGO with responsive handling and strong traceability.",
  },
  {
    code: "retail_chain",
    label: "Retail chain",
    description: "Distributed operations, store‑level incidents, mixed urgency and retention.",
  },
  {
    code: "military_organization",
    label: "Military organization",
    description: "Highly sensitive context with aggressive escalation and full audit logging.",
  },
  {
    code: "environmental_group",
    label: "Environmental group",
    description: "Campaign‑driven work with high pattern sensitivity and wide signalling.",
  },
  {
    code: "artist_collective",
    label: "Artist collective",
    description: "Creative group; relaxed timing, minimal logging, low pattern sensitivity.",
  },
];

interface OrgProfileSnapshot {
  organization_id: string;
  organization_slug?: string;
  organization_display_name?: string;
  profile_code: OrgProfileCode | string;
  version?: number;
  // Shape mirrors the profiles YAML (Doc 7), using snake_case keys.
  profile: {
    description?: string;
    reactivity_seconds?: number;
    max_escalation_seconds?: number;
    transparency_level?: string;
    escalation_granularity?: string;
    review_frequency?: string;
    notification_scope?: string;
    pattern_sensitivity?: string;
    pattern_window_days?: number;
    pattern_min_events?: number;
    severity_threshold?: string;
    logging_level?: string;
    log_retention_days?: number;
    automation_level?: string;
    default_task_metadata?: {
      visibility?: string;
      default_priority?: string;
      default_reactivity_seconds?: number;
    };
    cyclic_overview?: {
      enabled?: boolean;
      schedule?: {
        weekly?: boolean;
        monthly?: boolean;
        yearly?: boolean;
      };
      threshold_triggers?: {
        incident_frequency?: {
          min_events?: number;
          window_days?: number;
        };
        cross_departmental_trends?: boolean;
        high_risk_indicators?: boolean;
      };
    };
  };
}

interface ProfilePreviewDiff {
  summary?: string;
  impact_bullets?: string[];
}

/**
 * Format seconds into a coarse human‑readable duration.
 */
function formatSeconds(value?: number): string {
  if (value == null) return "—";
  if (value < 60) return `${value}s`;
  const minutes = Math.round(value / 60);
  if (minutes < 60) return `${minutes} min`;
  const hours = Math.round(minutes / 60);
  if (hours < 24) return `${hours} h`;
  const days = Math.round(hours / 24);
  return `${days} d`;
}

/**
 * Small badge component for enum‑like values.
 */
function Pill(props: { children: React.ReactNode }) {
  return (
    <span className="inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-medium">
      {props.children}
    </span>
  );
}

/**
 * Admin view to inspect and edit organization profiles and preview their impact.
 *
 * Assumptions (to be matched by the API implementation):
 * - useOrgProfilesQuery() returns either:
 *   - the active OrgProfileSnapshot for the current organization, or
 *   - an array of OrgProfileSnapshot, where index 0 is the active one.
 * - useProfilePreviewMutation() accepts:
 *     { organizationId, currentProfileCode, proposedProfileCode }
 *   and returns { summary, impact_bullets }.
 * - useUpdateServiceConfigMutation() accepts:
 *     { module: "org_profiles", organizationId, profileCode }
 *   and persists the change with audit logging.
 */
export const OrgProfileSettingsPage: React.FC = () => {
  const { data, isLoading, isError, refetch } = useOrgProfilesQuery();

  const activeProfile: OrgProfileSnapshot | undefined = useMemo(() => {
    if (!data) return undefined;
    if (Array.isArray(data)) {
      return (data[0] ?? null) as OrgProfileSnapshot | null || undefined;
    }
    return data as OrgProfileSnapshot;
  }, [data]);

  const [selectedProfileCode, setSelectedProfileCode] = useState<OrgProfileCode | "">("");
  const [triggerPreview, { data: previewData, isLoading: isPreviewLoading }] =
    useProfilePreviewMutation();
  const [updateConfig, { isLoading: isSaving, isSuccess: isSaveSuccess, error: saveError }] =
    useUpdateServiceConfigMutation();

  const preview: ProfilePreviewDiff | undefined = previewData as ProfilePreviewDiff | undefined;

  useEffect(() => {
    if (activeProfile?.profile_code) {
      setSelectedProfileCode(activeProfile.profile_code as OrgProfileCode);
    }
  }, [activeProfile?.profile_code]);

  const organizationName =
    activeProfile?.organization_display_name ||
    activeProfile?.organization_slug ||
    "Current organization";

  const currentProfileOption = PROFILE_OPTIONS.find(
    (opt) => opt.code === activeProfile?.profile_code
  );
  const selectedProfileOption = PROFILE_OPTIONS.find((opt) => opt.code === selectedProfileCode);

  const hasChanges =
    !!activeProfile &&
    !!selectedProfileCode &&
    selectedProfileCode !== (activeProfile.profile_code as OrgProfileCode);

  const handlePreview = () => {
    if (!activeProfile || !hasChanges) return;
    triggerPreview({
      organizationId: activeProfile.organization_id,
      currentProfileCode: activeProfile.profile_code,
      proposedProfileCode: selectedProfileCode,
    });
  };

  const handleSave = () => {
    if (!activeProfile || !selectedProfileCode) return;
    updateConfig({
      module: "org_profiles",
      organizationId: activeProfile.organization_id,
      profileCode: selectedProfileCode,
    });
  };

  if (isLoading) {
    return (
      <div className="p-6">
        <h1 className="mb-4 text-2xl font-semibold">Organization profile</h1>
        <p className="text-sm text-gray-600">Loading profile…</p>
      </div>
    );
  }

  if (isError || !activeProfile) {
    return (
      <div className="p-6">
        <h1 className="mb-4 text-2xl font-semibold">Organization profile</h1>
        <div className="rounded-md border border-red-200 bg-red-50 p-4 text-sm text-red-800">
          <p className="mb-2">Could not load the organization profile.</p>
          <button
            type="button"
            onClick={() => refetch()}
            className="rounded border px-3 py-1 text-xs font-medium"
          >
            Retry
          </button>
        </div>
      </div>
    );
  }

  const p = activeProfile.profile;

  return (
    <div className="p-6">
      <header className="mb-6 space-y-2">
        <h1 className="text-2xl font-semibold">Organization profile</h1>
        <p className="max-w-2xl text-sm text-gray-600">
          Profiles control how quickly work escalates, who can see it, how long records are kept,
          and how sensitive pattern detection is for{" "}
          <span className="font-medium">{organizationName}</span>.
        </p>
      </header>

      <div className="grid gap-6 lg:grid-cols-3">
        {/* Current profile summary */}
        <section className="lg:col-span-2 space-y-4 rounded-lg border bg-white p-4">
          <div className="flex items-start justify-between gap-4">
            <div>
              <p className="text-xs font-medium uppercase text-gray-500">
                Active profile archetype
              </p>
              <div className="mt-1 flex items-center gap-2">
                <span className="text-lg font-semibold">
                  {currentProfileOption?.label || activeProfile.profile_code}
                </span>
                <Pill>{activeProfile.profile_code}</Pill>
                {typeof activeProfile.version === "number" && (
                  <span className="text-xs text-gray-500">v{activeProfile.version}</span>
                )}
              </div>
              {p.description && (
                <p className="mt-1 max-w-xl text-sm text-gray-600">{p.description}</p>
              )}
            </div>
          </div>

          <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Reactivity</p>
              <p className="mt-1 text-sm">
                First escalation in{" "}
                <span className="font-medium">{formatSeconds(p.reactivity_seconds)}</span>
              </p>
              <p className="text-xs text-gray-500">
                Max escalation: {formatSeconds(p.max_escalation_seconds)}
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Transparency</p>
              <p className="mt-1 text-sm">
                <Pill>{p.transparency_level || "—"}</Pill>
              </p>
              <p className="text-xs text-gray-500">
                Escalation granularity: {p.escalation_granularity || "—"}
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Reviews</p>
              <p className="mt-1 text-sm">
                <Pill>{p.review_frequency || "—"}</Pill>
              </p>
              <p className="text-xs text-gray-500">
                Notification scope: {p.notification_scope || "—"}
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Patterns</p>
              <p className="mt-1 text-sm">
                Sensitivity: <Pill>{p.pattern_sensitivity || "—"}</Pill>
              </p>
              <p className="text-xs text-gray-500">
                Window: {p.pattern_window_days ?? "—"} days, min events:{" "}
                {p.pattern_min_events ?? "—"}
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Logging & retention</p>
              <p className="mt-1 text-sm">
                Logging: <Pill>{p.logging_level || "—"}</Pill>
              </p>
              <p className="text-xs text-gray-500">
                Log retention: {p.log_retention_days != null ? `${p.log_retention_days} days` : "—"}
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Automation</p>
              <p className="mt-1 text-sm">
                Level: <Pill>{p.automation_level || "—"}</Pill>
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Default Task metadata</p>
              <p className="mt-1 text-sm">
                Visibility:{" "}
                <Pill>{p.default_task_metadata?.visibility?.toLowerCase() || "—"}</Pill>
              </p>
              <p className="text-xs text-gray-500">
                Priority: {p.default_task_metadata?.default_priority || "—"},{" "}
                reactivity:{" "}
                {formatSeconds(p.default_task_metadata?.default_reactivity_seconds ?? undefined)}
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Cyclic overview</p>
              <p className="mt-1 text-sm">
                {p.cyclic_overview?.enabled ? (
                  <Pill>enabled</Pill>
                ) : (
                  <Pill>disabled</Pill>
                )}
              </p>
              <p className="text-xs text-gray-500">
                Schedule:{" "}
                {[
                  p.cyclic_overview?.schedule?.weekly && "weekly",
                  p.cyclic_overview?.schedule?.monthly && "monthly",
                  p.cyclic_overview?.schedule?.yearly && "yearly",
                ]
                  .filter(Boolean)
                  .join(", ") || "—"}
              </p>
            </div>
          </div>
        </section>

        {/* Edit + preview column */}
        <section className="space-y-4 rounded-lg border bg-white p-4">
          <div>
            <p className="text-xs font-medium uppercase text-gray-500">Select profile archetype</p>
            <label className="mt-2 block text-sm">
              <span className="mb-1 block text-gray-700">Archetype</span>
              <select
                value={selectedProfileCode}
                onChange={(e) => setSelectedProfileCode(e.target.value as OrgProfileCode)}
                className="mt-1 block w-full rounded-md border px-3 py-2 text-sm"
              >
                {PROFILE_OPTIONS.map((option) => (
                  <option key={option.code} value={option.code}>
                    {option.label}
                  </option>
                ))}
              </select>
            </label>
            {selectedProfileOption && (
              <p className="mt-2 text-xs text-gray-500">{selectedProfileOption.description}</p>
            )}
          </div>

          <div className="flex flex-col gap-2 border-t pt-4 text-sm">
            <div className="flex flex-wrap items-center gap-2">
              <button
                type="button"
                onClick={handlePreview}
                disabled={!hasChanges || isPreviewLoading}
                className="rounded-md border px-3 py-1 text-xs font-medium disabled:opacity-60"
              >
                {isPreviewLoading ? "Previewing…" : "Preview impact"}
              </button>
              <button
                type="button"
                onClick={handleSave}
                disabled={!hasChanges || isSaving}
                className="rounded-md bg-black px-3 py-1 text-xs font-medium text-white disabled:opacity-60"
              >
                {isSaving ? "Saving…" : "Apply change"}
              </button>
            </div>

            {isSaveSuccess && (
              <p className="text-xs text-green-700">Profile updated. New defaults will apply to future Tasks and Cases.</p>
            )}
            {saveError && (
              <p className="text-xs text-red-700">
                Failed to save changes. Please try again or check configuration logs.
              </p>
            )}
          </div>

          <div className="border-t pt-4">
            <p className="mb-2 text-xs font-medium uppercase text-gray-500">Preview</p>
            {!preview && !isPreviewLoading && (
              <p className="text-xs text-gray-500">
                Choose a different profile and click &ldquo;Preview impact&rdquo; to see how escalation,
                visibility, retention and patterns would change.
              </p>
            )}

            {preview && (
              <div className="space-y-2 text-xs">
                {preview.summary && <p className="text-gray-700">{preview.summary}</p>}
                {preview.impact_bullets && preview.impact_bullets.length > 0 && (
                  <ul className="list-disc space-y-1 pl-4 text-gray-700">
                    {preview.impact_bullets.map((item, index) => (
                      <li key={index}>{item}</li>
                    ))}
                  </ul>
                )}
              </div>
            )}
          </div>
        </section>
      </div>
    </div>
  );
};

export default OrgProfileSettingsPage;


=== FILE 15/24: apps/web/src/screens/admin/tasks/AdminTaskOverviewPage.tsx ===

// apps/web/src/screens/admin/tasks/AdminTaskOverviewPage.tsx

import { useMemo, useState, useEffect, ChangeEvent } from "react";
import { useAdminTaskOverviewQuery } from "../../../store/services/orgoApi";

type TaskStatus =
  | "PENDING"
  | "IN_PROGRESS"
  | "ON_HOLD"
  | "COMPLETED"
  | "FAILED"
  | "ESCALATED"
  | "CANCELLED";

type TaskPriority = "LOW" | "MEDIUM" | "HIGH" | "CRITICAL";

type TaskSeverity = "MINOR" | "MODERATE" | "MAJOR" | "CRITICAL";

type TaskCategory = "request" | "incident" | "update" | "report" | "distribution";

type FilterStatusOption = TaskStatus | "ALL";
type FilterPriorityOption = TaskPriority | "ALL";
type FilterSeverityOption = TaskSeverity | "ALL";
type FilterCategoryOption = TaskCategory | "ALL";

type SortField = "created_at" | "reactivity_deadline_at" | "priority";
type SortDirection = "asc" | "desc";

interface AdminTaskOverviewFilters {
  status: FilterStatusOption;
  priority: FilterPriorityOption;
  severity: FilterSeverityOption;
  category: FilterCategoryOption;
  type: string; // domain type, e.g. "maintenance", "hr_case"
  role: string; // assignee/owner role label
  labelSearch: string; // free-text search over label/title
}

/**
 * Canonical lightweight task shape for the admin overview table.
 * This mirrors the /api/v3/tasks admin listing payload.
 */
interface AdminTaskOverviewTask {
  task_id: string;
  organization_id: string;
  case_id: string | null;
  source: "email" | "api" | "manual" | "sync";
  type: string;
  category: TaskCategory;
  label: string;
  title: string;
  status: TaskStatus;
  priority: TaskPriority;
  severity: TaskSeverity;
  visibility: "PUBLIC" | "INTERNAL" | "RESTRICTED" | "ANONYMISED";
  assignee_role: string | null;
  owner_role_id: string | null;
  owner_user_id: string | null;
  reactivity_deadline_at: string | null;
  created_at: string;
}

interface AdminTaskOverviewResponse {
  tasks: AdminTaskOverviewTask[];
  total: number;
  page: number;
  pageSize: number;
}

/**
 * Query args passed to useAdminTaskOverviewQuery.
 * The orgoApi slice should accept this shape and translate it
 * to the backend /api/v3/tasks admin listing with filters.
 */
interface AdminTaskOverviewQueryArgs {
  page: number;
  pageSize: number;
  status?: TaskStatus;
  priority?: TaskPriority;
  severity?: TaskSeverity;
  category?: TaskCategory;
  type?: string;
  role?: string;
  labelSearch?: string;
}

const DEFAULT_PAGE_SIZE = 25;

const STATUS_OPTIONS: FilterStatusOption[] = [
  "ALL",
  "PENDING",
  "IN_PROGRESS",
  "ON_HOLD",
  "ESCALATED",
  "COMPLETED",
  "FAILED",
  "CANCELLED",
];

const PRIORITY_OPTIONS: FilterPriorityOption[] = ["ALL", "LOW", "MEDIUM", "HIGH", "CRITICAL"];

const SEVERITY_OPTIONS: FilterSeverityOption[] = ["ALL", "MINOR", "MODERATE", "MAJOR", "CRITICAL"];

const CATEGORY_OPTIONS: FilterCategoryOption[] = [
  "ALL",
  "request",
  "incident",
  "update",
  "report",
  "distribution",
];

const PRIORITY_RANK: Record<TaskPriority, number> = {
  LOW: 0,
  MEDIUM: 1,
  HIGH: 2,
  CRITICAL: 3,
};

function getStatusBadgeClasses(status: TaskStatus): string {
  switch (status) {
    case "PENDING":
      return "bg-gray-100 text-gray-800";
    case "IN_PROGRESS":
      return "bg-blue-100 text-blue-800";
    case "ON_HOLD":
      return "bg-yellow-100 text-yellow-800";
    case "ESCALATED":
      return "bg-red-100 text-red-800 border border-red-300";
    case "COMPLETED":
      return "bg-green-100 text-green-800";
    case "FAILED":
      return "bg-red-100 text-red-800";
    case "CANCELLED":
      return "bg-gray-200 text-gray-700";
    default:
      return "bg-gray-100 text-gray-800";
  }
}

function getPriorityBadgeClasses(priority: TaskPriority): string {
  switch (priority) {
    case "LOW":
      return "bg-gray-100 text-gray-800";
    case "MEDIUM":
      return "bg-sky-100 text-sky-800";
    case "HIGH":
      return "bg-orange-100 text-orange-800";
    case "CRITICAL":
      return "bg-red-100 text-red-800";
    default:
      return "bg-gray-100 text-gray-800";
  }
}

function getSeverityBadgeClasses(severity: TaskSeverity): string {
  switch (severity) {
    case "MINOR":
      return "bg-gray-100 text-gray-800";
    case "MODERATE":
      return "bg-amber-100 text-amber-800";
    case "MAJOR":
      return "bg-orange-100 text-orange-800";
    case "CRITICAL":
      return "bg-red-100 text-red-800";
    default:
      return "bg-gray-100 text-gray-800";
  }
}

function isUnresolvedStatus(status: TaskStatus): boolean {
  return ["PENDING", "IN_PROGRESS", "ON_HOLD", "ESCALATED"].includes(status);
}

function isOverdue(task: AdminTaskOverviewTask): boolean {
  if (!task.reactivity_deadline_at) return false;
  if (!isUnresolvedStatus(task.status)) return false;
  const deadline = new Date(task.reactivity_deadline_at).getTime();
  if (Number.isNaN(deadline)) return false;
  return Date.now() > deadline;
}

function formatDate(value: string | null | undefined): string {
  if (!value) return "—";
  const d = new Date(value);
  if (Number.isNaN(d.getTime())) return "—";
  return d.toLocaleString();
}

function truncateLabel(label: string, max = 40): string {
  if (label.length <= max) return label;
  return `${label.slice(0, max - 1)}…`;
}

/**
 * Small generic debounce hook so the backend is not hammered
 * while the user types in free-text filters.
 */
function useDebouncedValue<T>(value: T, delay: number): T {
  const [debounced, setDebounced] = useState(value);

  useEffect(() => {
    const handle = setTimeout(() => {
      setDebounced(value);
    }, delay);

    return () => {
      clearTimeout(handle);
    };
  }, [value, delay]);

  return debounced;
}

function getNextSort(
  currentField: SortField,
  currentDirection: SortDirection,
  clickedField: SortField,
): { field: SortField; direction: SortDirection } {
  if (currentField !== clickedField) {
    return { field: clickedField, direction: "desc" };
  }
  return {
    field: clickedField,
    direction: currentDirection === "desc" ? "asc" : "desc",
  };
}

const AdminTaskOverviewPage = () => {
  const [filters, setFilters] = useState<AdminTaskOverviewFilters>({
    status: "ALL",
    priority: "ALL",
    severity: "ALL",
    category: "ALL",
    type: "",
    role: "",
    labelSearch: "",
  });

  const [page, setPage] = useState(1);
  const [sort, setSort] = useState<{ field: SortField; direction: SortDirection }>({
    field: "created_at",
    direction: "desc",
  });

  // Debounce text-based filters only
  const debouncedType = useDebouncedValue(filters.type, 300);
  const debouncedRole = useDebouncedValue(filters.role, 300);
  const debouncedLabelSearch = useDebouncedValue(filters.labelSearch, 300);

  const queryArgs: AdminTaskOverviewQueryArgs = useMemo(() => {
    const args: AdminTaskOverviewQueryArgs = {
      page,
      pageSize: DEFAULT_PAGE_SIZE,
    };

    if (filters.status !== "ALL") {
      args.status = filters.status;
    }

    if (filters.priority !== "ALL") {
      args.priority = filters.priority;
    }

    if (filters.severity !== "ALL") {
      args.severity = filters.severity;
    }

    if (filters.category !== "ALL") {
      args.category = filters.category;
    }

    if (debouncedType.trim()) {
      args.type = debouncedType.trim();
    }

    if (debouncedRole.trim()) {
      args.role = debouncedRole.trim();
    }

    if (debouncedLabelSearch.trim()) {
      args.labelSearch = debouncedLabelSearch.trim();
    }

    return args;
  }, [
    page,
    filters.status,
    filters.priority,
    filters.severity,
    filters.category,
    debouncedType,
    debouncedRole,
    debouncedLabelSearch,
  ]);

  // Cast to the expected response type for local usage; the orgoApi slice
  // should be implemented so that this cast matches the real response.
  const { data, isLoading, isError, refetch, isFetching } = useAdminTaskOverviewQuery(
    queryArgs,
  ) as {
    data?: AdminTaskOverviewResponse;
    isLoading: boolean;
    isError: boolean;
    isFetching: boolean;
    refetch: () => void;
  };

  const tasks = data?.tasks ?? [];
  const total = data?.total ?? 0;
  const pageSize = data?.pageSize ?? DEFAULT_PAGE_SIZE;
  const totalPages = total > 0 ? Math.max(1, Math.ceil(total / pageSize)) : 1;

  const sortedTasks = useMemo(() => {
    if (!tasks.length) return [];

    const copy = [...tasks];

    copy.sort((a, b) => {
      let aValue: number;
      let bValue: number;

      if (sort.field === "priority") {
        aValue = PRIORITY_RANK[a.priority];
        bValue = PRIORITY_RANK[b.priority];
      } else {
        const aDate = a[sort.field];
        const bDate = b[sort.field];

        const aTime = aDate ? new Date(aDate).getTime() : 0;
        const bTime = bDate ? new Date(bDate).getTime() : 0;

        aValue = Number.isNaN(aTime) ? 0 : aTime;
        bValue = Number.isNaN(bTime) ? 0 : bTime;
      }

      if (aValue === bValue) return 0;
      if (sort.direction === "desc") {
        return aValue > bValue ? -1 : 1;
      }
      return aValue < bValue ? -1 : 1;
    });

    return copy;
  }, [tasks, sort.field, sort.direction]);

  const { openCount, overdueCount } = useMemo(() => {
    let open = 0;
    let overdue = 0;
    for (const t of tasks) {
      if (isUnresolvedStatus(t.status)) {
        open += 1;
        if (isOverdue(t)) {
          overdue += 1;
        }
      }
    }
    return { openCount: open, overdueCount: overdue };
  }, [tasks]);

  const handleSelectChange =
    <K extends keyof AdminTaskOverviewFilters>(key: K) =>
    (event: ChangeEvent<HTMLSelectElement>) => {
      const value = event.target.value as AdminTaskOverviewFilters[K];
      setPage(1);
      setFilters((prev) => ({
        ...prev,
        [key]: value,
      }));
    };

  const handleInputChange =
    <K extends keyof AdminTaskOverviewFilters>(key: K) =>
    (event: ChangeEvent<HTMLInputElement>) => {
      const value = event.target.value as AdminTaskOverviewFilters[K];
      setPage(1);
      setFilters((prev) => ({
        ...prev,
        [key]: value,
      }));
    };

  const handleClearFilters = () => {
    setFilters({
      status: "ALL",
      priority: "ALL",
      severity: "ALL",
      category: "ALL",
      type: "",
      role: "",
      labelSearch: "",
    });
    setPage(1);
  };

  const handleSortClick = (field: SortField) => {
    setSort((current) => getNextSort(current.field, current.direction, field));
  };

  const canGoPrev = page > 1;
  const canGoNext = page < totalPages;

  const hasActiveFilters =
    filters.status !== "ALL" ||
    filters.priority !== "ALL" ||
    filters.severity !== "ALL" ||
    filters.category !== "ALL" ||
    Boolean(filters.type.trim()) ||
    Boolean(filters.role.trim()) ||
    Boolean(filters.labelSearch.trim());

  const renderSortIndicator = (field: SortField) => {
    if (sort.field !== field) {
      return (
        <span className="ml-1 text-xs text-gray-400" aria-hidden="true">
          ↕
        </span>
      );
    }
    return (
      <span className="ml-1 text-xs text-gray-600" aria-hidden="true">
        {sort.direction === "desc" ? "↓" : "↑"}
      </span>
    );
  };

  return (
    <div className="min-h-screen bg-gray-50 px-4 py-6 sm:px-6 lg:px-8">
      <div className="mb-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h1 className="text-2xl font-semibold text-gray-900">Admin Task Overview</h1>
          <p className="mt-1 text-sm text-gray-600">
            Cross-domain task queues with filters by status, domain type, label, role, priority, and
            severity.
          </p>
        </div>
        <div className="flex items-center gap-2">
          {hasActiveFilters && (
            <button
              type="button"
              onClick={handleClearFilters}
              className="inline-flex items-center justify-center rounded-md border border-gray-200 bg-white px-3 py-2 text-xs font-medium text-gray-600 shadow-sm hover:bg-gray-50"
            >
              Clear filters
            </button>
          )}
          <button
            type="button"
            onClick={() => refetch()}
            className="inline-flex items-center justify-center rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50"
          >
            {isFetching ? "Refreshing…" : "Refresh"}
          </button>
        </div>
      </div>

      <div className="mb-4 grid gap-3 md:grid-cols-3 lg:grid-cols-6">
        <div className="flex flex-col">
          <label className="mb-1 text-xs font-medium text-gray-700" htmlFor="status">
            Status
          </label>
          <select
            id="status"
            className="block w-full rounded-md border border-gray-300 bg-white px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            value={filters.status}
            onChange={handleSelectChange("status")}
          >
            {STATUS_OPTIONS.map((option) => (
              <option key={option} value={option}>
                {option === "ALL" ? "All statuses" : option.replace("_", " ")}
              </option>
            ))}
          </select>
        </div>

        <div className="flex flex-col">
          <label className="mb-1 text-xs font-medium text-gray-700" htmlFor="priority">
            Priority
          </label>
          <select
            id="priority"
            className="block w-full rounded-md border border-gray-300 bg-white px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            value={filters.priority}
            onChange={handleSelectChange("priority")}
          >
            {PRIORITY_OPTIONS.map((option) => (
              <option key={option} value={option}>
                {option === "ALL" ? "All priorities" : option}
              </option>
            ))}
          </select>
        </div>

        <div className="flex flex-col">
          <label className="mb-1 text-xs font-medium text-gray-700" htmlFor="severity">
            Severity
          </label>
          <select
            id="severity"
            className="block w-full rounded-md border border-gray-300 bg-white px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            value={filters.severity}
            onChange={handleSelectChange("severity")}
          >
            {SEVERITY_OPTIONS.map((option) => (
              <option key={option} value={option}>
                {option === "ALL" ? "All severities" : option}
              </option>
            ))}
          </select>
        </div>

        <div className="flex flex-col">
          <label className="mb-1 text-xs font-medium text-gray-700" htmlFor="category">
            Category
          </label>
          <select
            id="category"
            className="block w-full rounded-md border border-gray-300 bg-white px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            value={filters.category}
            onChange={handleSelectChange("category")}
          >
            {CATEGORY_OPTIONS.map((option) => (
              <option key={option} value={option}>
                {option === "ALL"
                  ? "All categories"
                  : option.charAt(0).toUpperCase() + option.slice(1)}
              </option>
            ))}
          </select>
        </div>

        <div className="flex flex-col">
          <label className="mb-1 text-xs font-medium text-gray-700" htmlFor="type">
            Domain type
          </label>
          <input
            id="type"
            type="text"
            placeholder="e.g. maintenance, hr_case"
            className="block w-full rounded-md border border-gray-300 bg-white px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            value={filters.type}
            onChange={handleInputChange("type")}
          />
        </div>

        <div className="flex flex-col">
          <label className="mb-1 text-xs font-medium text-gray-700" htmlFor="role">
            Role or label search
          </label>
          <input
            id="role"
            type="text"
            placeholder="role or label fragment"
            className="block w-full rounded-md border border-gray-300 bg-white px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            value={filters.labelSearch}
            onChange={(event: ChangeEvent<HTMLInputElement>) => {
              const value = event.target.value;
              setPage(1);
              setFilters((prev) => ({
                ...prev,
                role: value,
                labelSearch: value,
              }));
            }}
          />
        </div>
      </div>

      <div className="mb-4 flex flex-wrap items-center gap-3 text-sm text-gray-700">
        <span>
          <span className="font-medium">{total}</span> tasks
        </span>
        <span className="hidden text-gray-400 sm:inline">•</span>
        <span>
          <span className="font-medium">{openCount}</span> unresolved
        </span>
        <span className="hidden text-gray-400 sm:inline">•</span>
        <span>
          <span className="font-medium">{overdueCount}</span> overdue by reactivity deadline
        </span>
        {isLoading && <span className="ml-auto text-xs text-gray-500">Loading…</span>}
        {isError && !isLoading && (
          <span className="ml-auto text-xs text-red-600">
            Error loading tasks. Try adjusting filters or refreshing.
          </span>
        )}
      </div>

      <div className="overflow-x-auto rounded-lg border border-gray-200 bg-white shadow-sm">
        <table className="min-w-full divide-y divide-gray-200 text-left text-sm">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-4 py-3 font-medium text-gray-700">Status</th>
              <th className="px-4 py-3 font-medium text-gray-700" scope="col">
                <button
                  type="button"
                  className="inline-flex items-center"
                  onClick={() => handleSortClick("priority")}
                >
                  Priority
                  {renderSortIndicator("priority")}
                </button>
              </th>
              <th className="px-4 py-3 font-medium text-gray-700">Severity</th>
              <th className="px-4 py-3 font-medium text-gray-700">Title</th>
              <th className="px-4 py-3 font-medium text-gray-700">Type / Category</th>
              <th className="px-4 py-3 font-medium text-gray-700">Label</th>
              <th className="px-4 py-3 font-medium text-gray-700">Assignee role</th>
              <th className="px-4 py-3 font-medium text-gray-700" scope="col">
                <button
                  type="button"
                  className="inline-flex items-center"
                  onClick={() => handleSortClick("reactivity_deadline_at")}
                >
                  React. deadline
                  {renderSortIndicator("reactivity_deadline_at")}
                </button>
              </th>
              <th className="px-4 py-3 font-medium text-gray-700" scope="col">
                <button
                  type="button"
                  className="inline-flex items-center"
                  onClick={() => handleSortClick("created_at")}
                >
                  Created
                  {renderSortIndicator("created_at")}
                </button>
              </th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-100 bg-white">
            {isLoading && tasks.length === 0 ? (
              <tr>
                <td className="px-4 py-6 text-center text-sm text-gray-500" colSpan={9}>
                  Loading tasks…
                </td>
              </tr>
            ) : sortedTasks.length === 0 ? (
              <tr>
                <td className="px-4 py-6 text-center text-sm text-gray-500" colSpan={9}>
                  No tasks match the current filters.
                </td>
              </tr>
            ) : (
              sortedTasks.map((task) => {
                const overdue = isOverdue(task);
                return (
                  <tr key={task.task_id} className={overdue ? "bg-red-50" : undefined}>
                    <td className="whitespace-nowrap px-4 py-3">
                      <span
                        className={`inline-flex rounded-full px-2.5 py-0.5 text-xs font-medium ${getStatusBadgeClasses(
                          task.status,
                        )}`}
                      >
                        {task.status.replace("_", " ")}
                      </span>
                    </td>
                    <td className="whitespace-nowrap px-4 py-3">
                      <span
                        className={`inline-flex rounded-full px-2.5 py-0.5 text-xs font-medium ${getPriorityBadgeClasses(
                          task.priority,
                        )}`}
                      >
                        {task.priority}
                      </span>
                    </td>
                    <td className="whitespace-nowrap px-4 py-3">
                      <span
                        className={`inline-flex rounded-full px-2.5 py-0.5 text-xs font-medium ${getSeverityBadgeClasses(
                          task.severity,
                        )}`}
                      >
                        {task.severity}
                      </span>
                    </td>
                    <td className="max-w-xs px-4 py-3">
                      <div className="truncate text-sm text-gray-900">{task.title}</div>
                    </td>
                    <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-700">
                      <div className="flex flex-col">
                        <span className="font-medium">{task.type}</span>
                        <span className="text-xs text-gray-500">{task.category}</span>
                      </div>
                    </td>
                    <td className="max-w-xs px-4 py-3 text-sm text-gray-700">
                      <span title={task.label} className="block truncate">
                        {truncateLabel(task.label)}
                      </span>
                    </td>
                    <td className="max-w-xs px-4 py-3 text-sm text-gray-700">
                      {task.assignee_role ? (
                        <span className="block truncate">{task.assignee_role}</span>
                      ) : (
                        <span className="text-gray-400">Unassigned</span>
                      )}
                    </td>
                    <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-700">
                      <div className="flex flex-col">
                        <span>{formatDate(task.reactivity_deadline_at)}</span>
                        {overdue && (
                          <span className="text-xs font-medium text-red-600">Overdue</span>
                        )}
                      </div>
                    </td>
                    <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-700">
                      {formatDate(task.created_at)}
                    </td>
                  </tr>
                );
              })
            )}
          </tbody>
        </table>
      </div>

      <div className="mt-4 flex flex-col items-center justify-between gap-3 text-sm text-gray-700 sm:flex-row">
        <div>
          Page{" "}
          <span className="font-medium">
            {Math.min(page, totalPages)} / {totalPages}
          </span>
          {total > 0 && (
            <span className="ml-2 text-gray-500">
              • Showing {(page - 1) * pageSize + 1}–{Math.min(page * pageSize, total)} of {total}
            </span>
          )}
        </div>
        <div className="inline-flex items-center gap-2">
          <button
            type="button"
            disabled={!canGoPrev}
            onClick={() => canGoPrev && setPage((p) => p - 1)}
            className="inline-flex items-center rounded-md border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:cursor-not-allowed disabled:bg-gray-100 disabled:text-gray-400"
          >
            Previous
          </button>
          <button
            type="button"
            disabled={!canGoNext}
            onClick={() => canGoNext && setPage((p) => p + 1)}
            className="inline-flex items-center rounded-md border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:cursor-not-allowed disabled:bg-gray-100 disabled:text-gray-400"
          >
            Next
          </button>
        </div>
      </div>
    </div>
  );
};

export default AdminTaskOverviewPage;


=== FILE 16/24: apps/web/src/screens/auth/login/login.tsx ===

import { Button } from "ui";

export function LoginScreen() {
  return (
    <div>
      Login Screen <Button />
    </div>
  );
}


=== FILE 17/24: apps/web/src/screens/insights/InsightsOverviewPage.tsx ===

// apps/web/src/screens/insights/InsightsOverviewPage.tsx

import React, { useMemo, useState } from "react";
import { useInsightsOverviewQuery } from "../../store/services/orgoApi";

type TaskStatus =
  | "PENDING"
  | "IN_PROGRESS"
  | "ON_HOLD"
  | "COMPLETED"
  | "FAILED"
  | "ESCALATED"
  | "CANCELLED";

type TimeFilter = "7d" | "30d" | "90d" | "180d" | "365d" | "all";

/**
 * One bucket in the task volume report – counts per day and status.
 * Mirrors the backend TaskVolumeBucket shape from the reports service.
 */
interface TaskVolumeBucket {
  date: string; // ISO date (YYYY-MM-DD)
  status: TaskStatus;
  count: number;
}

/**
 * Aggregated SLA breach data per domain (Task.type).
 * Mirrors the backend SlaBreachRow shape.
 */
interface SlaBreachRow {
  domainType: string;
  totalTasks: number;
  breachedTasks: number;
  breachRate: number; // 0–1
}

/**
 * Overall profile effectiveness score plus per-domain breakdown.
 * Mirrors the backend ProfileScore shape.
 */
interface ProfileScore {
  organizationId: string;
  fromDate: string; // ISO date (YYYY-MM-DD)
  toDate: string; // ISO date (YYYY-MM-DD)
  overallTasks: number;
  overallBreachedTasks: number;
  overallScore: number; // 0–100, 100 = no breaches
  perDomain: SlaBreachRow[];
}

/**
 * Combined payload returned by useInsightsOverviewQuery.
 * The orgoApi slice should implement this shape.
 */
interface InsightsOverviewResponse {
  taskVolume: TaskVolumeBucket[];
  profileScore: ProfileScore | null;
}

/**
 * Query args passed to useInsightsOverviewQuery.
 * The orgoApi slice should accept this shape and translate it to
 * the underlying reporting API (task volume + profile score).
 */
interface InsightsOverviewQueryArgs {
  /**
   * Lookback window in days (e.g. 7, 30, 90). When omitted, the
   * backend should apply its default window (e.g. 30 days).
   */
  windowDays?: number;
  /**
   * Optional domain type filter (e.g. "maintenance", "hr_case").
   * Used consistently across volume and SLA/profile reports.
   */
  type?: string;
}

interface DailyVolume {
  date: string; // ISO date (YYYY-MM-DD)
  total: number;
}

const UNRESOLVED_STATUSES: TaskStatus[] = [
  "PENDING",
  "IN_PROGRESS",
  "ON_HOLD",
  "ESCALATED",
];

function timeFilterToDays(value: TimeFilter): number | undefined {
  switch (value) {
    case "7d":
      return 7;
    case "30d":
      return 30;
    case "90d":
      return 90;
    case "180d":
      return 180;
    case "365d":
      return 365;
    case "all":
    default:
      return undefined;
  }
}

function buildDailyVolume(buckets: TaskVolumeBucket[]): DailyVolume[] {
  const map = new Map<string, number>();

  for (const bucket of buckets) {
    const current = map.get(bucket.date) ?? 0;
    map.set(bucket.date, current + bucket.count);
  }

  return Array.from(map.entries())
    .map(([date, total]) => ({ date, total }))
    .sort((a, b) => (a.date < b.date ? -1 : a.date > b.date ? 1 : 0));
}

function formatShortDate(value: string): string {
  const d = new Date(value);
  if (Number.isNaN(d.getTime())) return value;
  return d.toLocaleDateString(undefined, {
    month: "short",
    day: "numeric",
  });
}

function formatDateRange(from?: string, to?: string): string {
  if (!from && !to) return "—";
  const fromLabel = from ? formatShortDate(from) : "…";
  const toLabel = to ? formatShortDate(to) : "…";
  if (fromLabel === toLabel) return fromLabel;
  return `${fromLabel} – ${toLabel}`;
}

function formatPercent(value: number | undefined, digits = 1): string {
  if (value == null || Number.isNaN(value)) return "—";
  const pct = value * 100;
  return `${pct.toFixed(digits)}%`;
}

function getScoreLabel(score: number | undefined): string {
  if (score == null || Number.isNaN(score)) return "Unknown";
  if (score >= 90) return "Excellent";
  if (score >= 75) return "Good";
  if (score >= 60) return "Watch";
  return "At risk";
}

function getScoreBadgeClasses(score: number | undefined): string {
  if (score == null || Number.isNaN(score)) {
    return "bg-gray-100 text-gray-700";
  }
  if (score >= 90) {
    return "bg-green-100 text-green-800";
  }
  if (score >= 75) {
    return "bg-emerald-100 text-emerald-800";
  }
  if (score >= 60) {
    return "bg-yellow-100 text-yellow-800";
  }
  return "bg-red-100 text-red-800";
}

function getBreachBadgeClasses(rate: number): string {
  if (rate >= 0.4) return "bg-red-100 text-red-800";
  if (rate >= 0.25) return "bg-orange-100 text-orange-800";
  if (rate >= 0.1) return "bg-yellow-100 text-yellow-800";
  return "bg-green-100 text-green-800";
}

const InsightsOverviewPage: React.FC = () => {
  const [timeFilter, setTimeFilter] = useState<TimeFilter>("30d");
  const [domainType, setDomainType] = useState("");

  const queryArgs: InsightsOverviewQueryArgs = useMemo(() => {
    const args: InsightsOverviewQueryArgs = {};
    const windowDays = timeFilterToDays(timeFilter);
    if (typeof windowDays === "number") {
      args.windowDays = windowDays;
    }
    const trimmedType = domainType.trim();
    if (trimmedType.length > 0) {
      args.type = trimmedType;
    }
    return args;
  }, [timeFilter, domainType]);

  // Cast to the expected response type for local usage; the orgoApi slice
  // should be implemented so that this cast matches the real response.
  const { data, isLoading, isError, isFetching, refetch } =
    useInsightsOverviewQuery(queryArgs) as {
      data?: InsightsOverviewResponse;
      isLoading: boolean;
      isError: boolean;
      isFetching: boolean;
      refetch: () => void;
    };

  const taskVolume = data?.taskVolume ?? [];
  const profileScore = data?.profileScore ?? null;

  const dailyVolume = useMemo(
    () => buildDailyVolume(taskVolume),
    [taskVolume]
  );

  const maxDailyVolume = useMemo(
    () =>
      dailyVolume.reduce(
        (max, bucket) => (bucket.total > max ? bucket.total : max),
        0
      ),
    [dailyVolume]
  );

  const {
    totalTasksInWindow,
    unresolvedApprox,
    breachRate,
    highRiskDomainCount,
  } = useMemo(() => {
    const totalTasks = taskVolume.reduce(
      (sum, bucket) => sum + bucket.count,
      0
    );

    const unresolvedApproxCount = taskVolume.reduce(
      (sum, bucket) =>
        UNRESOLVED_STATUSES.includes(bucket.status)
          ? sum + bucket.count
          : sum,
      0
    );

    const overallTasks =
      profileScore?.overallTasks && profileScore.overallTasks > 0
        ? profileScore.overallTasks
        : totalTasks;

    const overallBreached = profileScore?.overallBreachedTasks ?? 0;
    const rate =
      overallTasks > 0 ? overallBreached / overallTasks : 0;

    const highRiskDomains =
      profileScore?.perDomain?.filter(
        (row) => row.breachRate >= 0.25
      ).length ?? 0;

    return {
      totalTasksInWindow: overallTasks,
      unresolvedApprox: unresolvedApproxCount,
      breachRate: rate,
      highRiskDomainCount: highRiskDomains,
    };
  }, [taskVolume, profileScore]);

  const perDomain = useMemo(() => {
    const rows = profileScore?.perDomain ?? [];
    return [...rows].sort(
      (a, b) => b.breachRate - a.breachRate
    );
  }, [profileScore]);

  const hasAnyData =
    dailyVolume.length > 0 ||
    (profileScore != null &&
      (profileScore.overallTasks > 0 ||
        profileScore.perDomain.length > 0));

  return (
    <div className="px-6 py-4">
      <header className="mb-4 flex flex-col items-start justify-between gap-4 md:flex-row md:items-center">
        <div>
          <h1 className="text-2xl font-semibold text-gray-900">
            Insights overview
          </h1>
          <p className="mt-1 text-sm text-gray-600">
            Task volume, SLA health and profile effectiveness for
            this organization.
          </p>
        </div>
        <div className="flex flex-wrap items-end gap-3">
          <div className="flex flex-col gap-1">
            <label
              htmlFor="insights-window"
              className="text-xs font-medium text-gray-700"
            >
              Window
            </label>
            <select
              id="insights-window"
              value={timeFilter}
              onChange={(event) =>
                setTimeFilter(
                  event.target.value as TimeFilter
                )
              }
              className="rounded-md border border-gray-300 px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            >
              <option value="7d">Last 7 days</option>
              <option value="30d">Last 30 days</option>
              <option value="90d">Last 90 days</option>
              <option value="180d">Last 180 days</option>
              <option value="365d">Last 12 months</option>
              <option value="all">All available</option>
            </select>
          </div>

          <div className="flex flex-col gap-1">
            <label
              htmlFor="insights-domain-type"
              className="text-xs font-medium text-gray-700"
            >
              Domain type
            </label>
            <input
              id="insights-domain-type"
              type="text"
              value={domainType}
              onChange={(event) =>
                setDomainType(event.target.value)
              }
              placeholder='e.g. "maintenance", "hr_case"'
              className="w-44 rounded-md border border-gray-300 px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            />
          </div>

          <button
            type="button"
            onClick={() => refetch()}
            className="inline-flex items-center rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-medium shadow-sm hover:bg-gray-50"
          >
            Refresh
          </button>
        </div>
      </header>

      {isError && (
        <div className="mb-4 rounded-md border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-800">
          Failed to load insights. Please try again or adjust
          the filters.
        </div>
      )}

      {isLoading && !hasAnyData && (
        <div className="mb-4 rounded-md border border-gray-200 bg-white px-3 py-2 text-sm text-gray-600">
          Loading insights…
        </div>
      )}

      {/* Summary cards */}
      {hasAnyData && (
        <section
          aria-label="Insights overview summary"
          className="mb-4 grid gap-3 md:grid-cols-4"
        >
          <div className="rounded-md border border-gray-200 bg-white p-4">
            <div className="text-xs font-medium uppercase text-gray-500">
              Tasks in window
            </div>
            <div className="mt-1 text-2xl font-semibold text-gray-900">
              {totalTasksInWindow}
            </div>
            <div className="mt-1 text-xs text-gray-500">
              Across all included domains
            </div>
          </div>

          <div className="rounded-md border border-yellow-100 bg-yellow-50 p-4">
            <div className="text-xs font-medium uppercase text-yellow-800">
              Unresolved (approx.)
            </div>
            <div className="mt-1 text-2xl font-semibold text-yellow-900">
              {unresolvedApprox}
            </div>
            <div className="mt-1 text-xs text-yellow-900">
              Based on current status distribution
            </div>
          </div>

          <div className="rounded-md border border-red-100 bg-red-50 p-4">
            <div className="text-xs font-medium uppercase text-red-800">
              SLA breach rate
            </div>
            <div className="mt-1 text-2xl font-semibold text-red-900">
              {formatPercent(breachRate, 1)}
            </div>
            <div className="mt-1 text-xs text-red-900">
              Share of tasks breaching profile SLAs
            </div>
          </div>

          <div className="rounded-md border border-gray-200 bg-white p-4">
            <div className="flex items-center justify-between gap-2">
              <div className="text-xs font-medium uppercase text-gray-500">
                Profile score
              </div>
              <span
                className={`inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-medium ${getScoreBadgeClasses(
                  profileScore?.overallScore
                )}`}
              >
                {getScoreLabel(profileScore?.overallScore)}
              </span>
            </div>
            <div className="mt-1 text-2xl font-semibold text-gray-900">
              {profileScore?.overallScore ?? "—"}
            </div>
            <div className="mt-1 text-xs text-gray-500">
              {highRiskDomainCount > 0
                ? `${highRiskDomainCount} domain${
                    highRiskDomainCount === 1 ? "" : "s"
                  } with breach rate ≥ 25%`
                : "No high‑risk domains in this window"}
            </div>
          </div>
        </section>
      )}

      {/* Task volume over time */}
      {hasAnyData && (
        <section className="mb-4 rounded-md border border-gray-200 bg-white p-4">
          <div className="mb-3 flex items-center justify-between gap-2">
            <div>
              <h2 className="text-sm font-semibold text-gray-900">
                Task volume over time
              </h2>
              <p className="mt-1 text-xs text-gray-500">
                Tasks created per day in the selected window.
              </p>
            </div>
            {profileScore && (
              <p className="text-xs text-gray-500">
                Window:{" "}
                {formatDateRange(
                  profileScore.fromDate,
                  profileScore.toDate
                )}
              </p>
            )}
          </div>

          {dailyVolume.length === 0 ? (
            <p className="text-xs text-gray-500">
              No tasks in this window yet.
            </p>
          ) : (
            <div className="space-y-2">
              {dailyVolume.map((bucket) => {
                const widthPct =
                  maxDailyVolume > 0
                    ? (bucket.total / maxDailyVolume) * 100
                    : 0;
                return (
                  <div
                    key={bucket.date}
                    className="flex items-center gap-2"
                  >
                    <div className="w-16 text-xs text-gray-500">
                      {formatShortDate(bucket.date)}
                    </div>
                    <div className="flex-1">
                      <div className="h-2 rounded-full bg-gray-100">
                        <div
                          className="h-2 rounded-full bg-indigo-500"
                          style={{ width: `${widthPct}%` }}
                        />
                      </div>
                    </div>
                    <div className="w-10 text-right text-xs text-gray-700">
                      {bucket.total}
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </section>
      )}

      {/* SLA / domain risk breakdown */}
      {hasAnyData && (
        <section
          aria-label="SLA and domain risk"
          className="mb-4 rounded-md border border-gray-200 bg-white p-4"
        >
          <div className="mb-3 flex items-center justify-between gap-2">
            <div>
              <h2 className="text-sm font-semibold text-gray-900">
                SLA breaches by domain
              </h2>
              <p className="mt-1 text-xs text-gray-500">
                Domains are ordered by highest breach rate first.
              </p>
            </div>
          </div>

          {perDomain.length === 0 ? (
            <p className="text-xs text-gray-500">
              No SLA breach data for this window. This usually means
              there are few or no tasks in scope.
            </p>
          ) : (
            <div className="-mx-4 overflow-x-auto">
              <table className="min-w-full table-fixed border-t border-gray-100 text-sm">
                <thead>
                  <tr className="bg-gray-50">
                    <th className="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                      Domain
                    </th>
                    <th className="px-4 py-2 text-right text-xs font-semibold uppercase tracking-wide text-gray-500">
                      Tasks
                    </th>
                    <th className="px-4 py-2 text-right text-xs font-semibold uppercase tracking-wide text-gray-500">
                      Breached
                    </th>
                    <th className="px-4 py-2 text-right text-xs font-semibold uppercase tracking-wide text-gray-500">
                      Breach rate
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {perDomain.map((row) => (
                    <tr
                      key={row.domainType}
                      className="border-t border-gray-100"
                    >
                      <td className="px-4 py-2 align-top text-sm text-gray-900">
                        <div className="flex flex-col">
                          <span className="font-medium">
                            {row.domainType || "—"}
                          </span>
                        </div>
                      </td>
                      <td className="px-4 py-2 text-right text-sm text-gray-900">
                        {row.totalTasks}
                      </td>
                      <td className="px-4 py-2 text-right text-sm text-gray-900">
                        {row.breachedTasks}
                      </td>
                      <td className="px-4 py-2 text-right text-sm text-gray-900">
                        <span
                          className={`inline-flex items-center justify-end rounded-full px-2 py-0.5 text-xs font-medium ${getBreachBadgeClasses(
                            row.breachRate
                          )}`}
                        >
                          {formatPercent(row.breachRate, 1)}
                        </span>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </section>
      )}

      {!isLoading && !isError && !hasAnyData && (
        <div className="rounded-md border border-gray-200 bg-white px-3 py-2 text-sm text-gray-600">
          No insights are available yet for this organization and
          filter combination.
        </div>
      )}

      {isFetching && !isLoading && (
        <div className="mt-2 text-xs text-gray-500">
          Updating…
        </div>
      )}
    </div>
  );
};

export default InsightsOverviewPage;


=== FILE 18/24: packages/config/nginx.conf ===

events {

}

http {

    server {
        listen 80;
        server_name localhost;

        location /api/ {
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_pass http://host.docker.internal:5002/;

            proxy_http_version 1.1;
            proxy_set_header Connection "upgrade";
            proxy_set_header Upgrade $http_upgrade;
        }

        location /_next/webpack-hmr {
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Host $host;


            proxy_pass http://host.docker.internal:3000;

            proxy_http_version 1.1;
            proxy_set_header Connection "upgrade";
            proxy_set_header Upgrade $http_upgrade;
        }

        location / {
            proxy_pass http://host.docker.internal:3000;
        }

    }

}


=== FILE 19/24: packages/config/package.json ===

{
  "name": "config",
  "version": "0.0.0",
  "main": "index.js",
  "license": "MIT",
  "files": [
    "eslint-preset.js"
  ],
  "dependencies": {
    "eslint-config-next": "^13.4.12",
    "eslint-config-prettier": "^8.9.0",
    "eslint-plugin-react": "7.33.1"
  }
}


=== FILE 20/24: packages/tsconfig/package.json ===

{
  "name": "tsconfig",
  "version": "0.0.0",
  "private": true,
  "main": "index.js",
  "files": [
    "base.json",
    "nextjs.json",
    "react-library.json"
  ]
}


=== FILE 21/24: packages/ui/components/Button/Button.tsx ===

export const Button = () => {
  return <button className="text-lg bg-red-500">boo</button>;
};


=== FILE 22/24: packages/ui/index.tsx ===

export * from "./components/Button/Button";


=== FILE 23/24: packages/ui/package.json ===

{
  "name": "ui",
  "version": "0.0.0",
  "private": true,
  "main": "./index.tsx",
  "types": "./index.tsx",
  "license": "MIT",
  "scripts": {
    "build": "echo \"[ui] build (no-op, handled by web/Next)\""
  },
  "peerDependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
  "devDependencies": {
    "@types/react": "^18.2.18",
    "@types/react-dom": "^18.2.7",
    "config": "*",
    "tsconfig": "*",
    "typescript": "^5.1.6"
  }
}


=== FILE 24/24: packages/ui/tsconfig.json ===

{
  "extends": "tsconfig/react-library.json",
  "include": ["."],
  "exclude": ["dist", "build", "node_modules"]
}


