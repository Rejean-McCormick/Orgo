===== TOC (180 fichiers) =====
1. C:\MyCode\Orgo\.dockerignore
2. C:\MyCode\Orgo\.gitignore
3. C:\MyCode\Orgo\ai_bundle.md
4. C:\MyCode\Orgo\apps\api\.env.example
5. C:\MyCode\Orgo\apps\api\.eslintrc.js
6. C:\MyCode\Orgo\apps\api\.prettierrc
7. C:\MyCode\Orgo\apps\api\Dockerfile
8. C:\MyCode\Orgo\apps\api\nest-cli.json
9. C:\MyCode\Orgo\apps\api\package.json
10. C:\MyCode\Orgo\apps\api\prisma\migrations\20220307034109_initial_migrate\migration.sql
11. C:\MyCode\Orgo\apps\api\prisma\migrations\migration_lock.toml
12. C:\MyCode\Orgo\apps\api\prisma\schema.prisma
13. C:\MyCode\Orgo\apps\api\README.md
14. C:\MyCode\Orgo\apps\api\src\app.controller.spec.ts
15. C:\MyCode\Orgo\apps\api\src\app.controller.ts
16. C:\MyCode\Orgo\apps\api\src\app.module.ts
17. C:\MyCode\Orgo\apps\api\src\app.service.ts
18. C:\MyCode\Orgo\apps\api\src\config\environment-variables.ts
19. C:\MyCode\Orgo\apps\api\src\main.ts
20. C:\MyCode\Orgo\apps\api\src\orgo\backbone\identity\dto\link-user-person.dto.ts
21. C:\MyCode\Orgo\apps\api\src\orgo\backbone\identity\identity-link.controller.ts
22. C:\MyCode\Orgo\apps\api\src\orgo\backbone\identity\identity-link.module.ts
23. C:\MyCode\Orgo\apps\api\src\orgo\backbone\identity\identity-link.service.ts
24. C:\MyCode\Orgo\apps\api\src\orgo\backbone\organizations\dto\create-organization.dto.ts
25. C:\MyCode\Orgo\apps\api\src\orgo\backbone\organizations\dto\update-organization.dto.ts
26. C:\MyCode\Orgo\apps\api\src\orgo\backbone\organizations\organization.controller.ts
27. C:\MyCode\Orgo\apps\api\src\orgo\backbone\organizations\organization.module.ts
28. C:\MyCode\Orgo\apps\api\src\orgo\backbone\organizations\organization.service.ts
29. C:\MyCode\Orgo\apps\api\src\orgo\backbone\persons\dto\upsert-person-profile.dto.ts
30. C:\MyCode\Orgo\apps\api\src\orgo\backbone\persons\person-profile.controller.ts
31. C:\MyCode\Orgo\apps\api\src\orgo\backbone\persons\person-profile.module.ts
32. C:\MyCode\Orgo\apps\api\src\orgo\backbone\persons\person-profile.service.ts
33. C:\MyCode\Orgo\apps\api\src\orgo\backbone\rbac\dto\assign-permission.dto.ts
34. C:\MyCode\Orgo\apps\api\src\orgo\backbone\rbac\dto\create-role.dto.ts
35. C:\MyCode\Orgo\apps\api\src\orgo\backbone\rbac\permission.service.ts
36. C:\MyCode\Orgo\apps\api\src\orgo\backbone\rbac\rbac.controller.ts
37. C:\MyCode\Orgo\apps\api\src\orgo\backbone\rbac\rbac.module.ts
38. C:\MyCode\Orgo\apps\api\src\orgo\backbone\rbac\role.service.ts
39. C:\MyCode\Orgo\apps\api\src\orgo\config\config.controller.ts
40. C:\MyCode\Orgo\apps\api\src\orgo\config\config.module.ts
41. C:\MyCode\Orgo\apps\api\src\orgo\config\config.service.ts
42. C:\MyCode\Orgo\apps\api\src\orgo\config\feature-flag.controller.ts
43. C:\MyCode\Orgo\apps\api\src\orgo\config\feature-flag.service.ts
44. C:\MyCode\Orgo\apps\api\src\orgo\config\org-profile.controller.ts
45. C:\MyCode\Orgo\apps\api\src\orgo\config\org-profile.service.ts
46. C:\MyCode\Orgo\apps\api\src\orgo\core\alerts\alerting.service.ts
47. C:\MyCode\Orgo\apps\api\src\orgo\core\cases\case.controller.ts
48. C:\MyCode\Orgo\apps\api\src\orgo\core\cases\case.module.ts
49. C:\MyCode\Orgo\apps\api\src\orgo\core\cases\case.service.ts
50. C:\MyCode\Orgo\apps\api\src\orgo\core\cases\dto\create-case.dto.ts
51. C:\MyCode\Orgo\apps\api\src\orgo\core\cases\dto\update-case-status.dto.ts
52. C:\MyCode\Orgo\apps\api\src\orgo\core\database\database.service.ts
53. C:\MyCode\Orgo\apps\api\src\orgo\core\database\repository-factory.service.ts
54. C:\MyCode\Orgo\apps\api\src\orgo\core\email\email-ingest.service.ts
55. C:\MyCode\Orgo\apps\api\src\orgo\core\email\email-parser.service.ts
56. C:\MyCode\Orgo\apps\api\src\orgo\core\email\email-router.service.ts
57. C:\MyCode\Orgo\apps\api\src\orgo\core\email\email-validator.service.ts
58. C:\MyCode\Orgo\apps\api\src\orgo\core\email\email.controller.ts
59. C:\MyCode\Orgo\apps\api\src\orgo\core\email\email.module.ts
60. C:\MyCode\Orgo\apps\api\src\orgo\core\email\email.service.ts
61. C:\MyCode\Orgo\apps\api\src\orgo\core\functional-ids.ts
62. C:\MyCode\Orgo\apps\api\src\orgo\core\health\health.controller.ts
63. C:\MyCode\Orgo\apps\api\src\orgo\core\health\worker-health.service.ts
64. C:\MyCode\Orgo\apps\api\src\orgo\core\labels\label-routing.service.ts
65. C:\MyCode\Orgo\apps\api\src\orgo\core\labels\label.service.ts
66. C:\MyCode\Orgo\apps\api\src\orgo\core\labels\labels.module.ts
67. C:\MyCode\Orgo\apps\api\src\orgo\core\labels\routing-rule.service.ts
68. C:\MyCode\Orgo\apps\api\src\orgo\core\logging\log.service.ts
69. C:\MyCode\Orgo\apps\api\src\orgo\core\logging\logger.module.ts
70. C:\MyCode\Orgo\apps\api\src\orgo\core\metrics\metrics.service.ts
71. C:\MyCode\Orgo\apps\api\src\orgo\core\notifications\notification.controller.ts
72. C:\MyCode\Orgo\apps\api\src\orgo\core\notifications\notification.module.ts
73. C:\MyCode\Orgo\apps\api\src\orgo\core\notifications\notification.service.ts
74. C:\MyCode\Orgo\apps\api\src\orgo\core\offline\offline-sync.module.ts
75. C:\MyCode\Orgo\apps\api\src\orgo\core\offline\sync.service.ts
76. C:\MyCode\Orgo\apps\api\src\orgo\core\signals\dto\create-signal.dto.ts
77. C:\MyCode\Orgo\apps\api\src\orgo\core\signals\signal-ingest.service.ts
78. C:\MyCode\Orgo\apps\api\src\orgo\core\signals\signal.controller.ts
79. C:\MyCode\Orgo\apps\api\src\orgo\core\signals\signals.module.ts
80. C:\MyCode\Orgo\apps\api\src\orgo\core\tasks\dto\create-task.dto.ts
81. C:\MyCode\Orgo\apps\api\src\orgo\core\tasks\dto\update-task-status.dto.ts
82. C:\MyCode\Orgo\apps\api\src\orgo\core\tasks\task-events.gateway.ts
83. C:\MyCode\Orgo\apps\api\src\orgo\core\tasks\task-events.service.ts
84. C:\MyCode\Orgo\apps\api\src\orgo\core\tasks\task.controller.ts
85. C:\MyCode\Orgo\apps\api\src\orgo\core\tasks\task.module.ts
86. C:\MyCode\Orgo\apps\api\src\orgo\core\tasks\task.service.ts
87. C:\MyCode\Orgo\apps\api\src\orgo\core\validation\config-validation.service.ts
88. C:\MyCode\Orgo\apps\api\src\orgo\core\validation\metadata.service.ts
89. C:\MyCode\Orgo\apps\api\src\orgo\core\validation\payload-validation.pipe.ts
90. C:\MyCode\Orgo\apps\api\src\orgo\core\workflow\escalation.service.ts
91. C:\MyCode\Orgo\apps\api\src\orgo\core\workflow\workflow-engine.service.ts
92. C:\MyCode\Orgo\apps\api\src\orgo\core\workflow\workflow.controller.ts
93. C:\MyCode\Orgo\apps\api\src\orgo\core\workflow\workflow.module.ts
94. C:\MyCode\Orgo\apps\api\src\orgo\domain\education\education.module.ts
95. C:\MyCode\Orgo\apps\api\src\orgo\domain\hr\hr.module.ts
96. C:\MyCode\Orgo\apps\api\src\orgo\domain\hr\hr.service.ts
97. C:\MyCode\Orgo\apps\api\src\orgo\insights\cache\insights-cache-warmup.service.ts
98. C:\MyCode\Orgo\apps\api\src\orgo\insights\export\analytics-export.service.ts
99. C:\MyCode\Orgo\apps\api\src\orgo\insights\insights.module.ts
100. C:\MyCode\Orgo\apps\api\src\orgo\insights\patterns\pattern-detection.service.ts
101. C:\MyCode\Orgo\apps\api\src\orgo\insights\reports\reports.controller.ts
102. C:\MyCode\Orgo\apps\api\src\orgo\insights\reports\reports.service.ts
103. C:\MyCode\Orgo\apps\api\src\orgo\orgo.module.ts
104. C:\MyCode\Orgo\apps\api\src\orgo\security\audit\audit-trail.service.ts
105. C:\MyCode\Orgo\apps\api\src\orgo\security\auth\auth.guard.ts
106. C:\MyCode\Orgo\apps\api\src\orgo\security\auth\auth.module.ts
107. C:\MyCode\Orgo\apps\api\src\orgo\security\auth\auth.service.ts
108. C:\MyCode\Orgo\apps\api\src\orgo\security\compliance\compliance-export.service.ts
109. C:\MyCode\Orgo\apps\api\src\orgo\security\logging\log-query.service.ts
110. C:\MyCode\Orgo\apps\api\src\orgo\security\privacy\privacy.service.ts
111. C:\MyCode\Orgo\apps\api\src\orgo\security\rbac\rbac.service.ts
112. C:\MyCode\Orgo\apps\api\src\persistence\persistence.module.ts
113. C:\MyCode\Orgo\apps\api\src\persistence\prisma\prisma.service.spec.ts
114. C:\MyCode\Orgo\apps\api\src\persistence\prisma\prisma.service.ts
115. C:\MyCode\Orgo\apps\api\test\app.e2e-spec.ts
116. C:\MyCode\Orgo\apps\api\test\jest-e2e.json
117. C:\MyCode\Orgo\apps\api\tsconfig.build.json
118. C:\MyCode\Orgo\apps\api\tsconfig.json
119. C:\MyCode\Orgo\apps\api\webpack-hmr.config.js
120. C:\MyCode\Orgo\apps\web\.env.example
121. C:\MyCode\Orgo\apps\web\.eslintrc.js
122. C:\MyCode\Orgo\apps\web\Dockerfile
123. C:\MyCode\Orgo\apps\web\jest.config.js
124. C:\MyCode\Orgo\apps\web\jest.setup.js
125. C:\MyCode\Orgo\apps\web\next-env.d.ts
126. C:\MyCode\Orgo\apps\web\next.config.js
127. C:\MyCode\Orgo\apps\web\package.json
128. C:\MyCode\Orgo\apps\web\pages\_app.tsx
129. C:\MyCode\Orgo\apps\web\pages\index.tsx
130. C:\MyCode\Orgo\apps\web\postcss.config.js
131. C:\MyCode\Orgo\apps\web\README.md
132. C:\MyCode\Orgo\apps\web\src\common\.gitkeep
133. C:\MyCode\Orgo\apps\web\src\orgo\core\functional-ids.ts
134. C:\MyCode\Orgo\apps\web\src\orgo\hooks\useTaskEventStream.ts
135. C:\MyCode\Orgo\apps\web\src\orgo\types\case.ts
136. C:\MyCode\Orgo\apps\web\src\orgo\types\insights.ts
137. C:\MyCode\Orgo\apps\web\src\orgo\types\organization.ts
138. C:\MyCode\Orgo\apps\web\src\orgo\types\permission.ts
139. C:\MyCode\Orgo\apps\web\src\orgo\types\person.ts
140. C:\MyCode\Orgo\apps\web\src\orgo\types\profile.ts
141. C:\MyCode\Orgo\apps\web\src\orgo\types\role.ts
142. C:\MyCode\Orgo\apps\web\src\orgo\types\task.ts
143. C:\MyCode\Orgo\apps\web\src\screens\admin\.gitkeep
144. C:\MyCode\Orgo\apps\web\src\screens\admin\cases\AdminCaseOverviewPage.tsx
145. C:\MyCode\Orgo\apps\web\src\screens\admin\profiles\OrgProfileSettingsPage.tsx
146. C:\MyCode\Orgo\apps\web\src\screens\admin\tasks\AdminTaskOverviewPage.tsx
147. C:\MyCode\Orgo\apps\web\src\screens\auth\login\login.test.tsx
148. C:\MyCode\Orgo\apps\web\src\screens\auth\login\login.tsx
149. C:\MyCode\Orgo\apps\web\src\screens\common\.gitkeep
150. C:\MyCode\Orgo\apps\web\src\screens\employee\.gitkeep
151. C:\MyCode\Orgo\apps\web\src\screens\insights\InsightsOverviewPage.tsx
152. C:\MyCode\Orgo\apps\web\src\store\index.ts
153. C:\MyCode\Orgo\apps\web\src\store\services\api.ts
154. C:\MyCode\Orgo\apps\web\src\store\services\orgoApi.ts
155. C:\MyCode\Orgo\apps\web\src\styles\global.css
156. C:\MyCode\Orgo\apps\web\tailwind.config.js
157. C:\MyCode\Orgo\apps\web\tsconfig.json
158. C:\MyCode\Orgo\concat_orgo.py
159. C:\MyCode\Orgo\docker-compose.yml
160. C:\MyCode\Orgo\LICENSE
161. C:\MyCode\Orgo\package-scripts.js
162. C:\MyCode\Orgo\package.json
163. C:\MyCode\Orgo\packages\config\eslint-preset.js
164. C:\MyCode\Orgo\packages\config\nginx.conf
165. C:\MyCode\Orgo\packages\config\package.json
166. C:\MyCode\Orgo\packages\config\postcss.config.js
167. C:\MyCode\Orgo\packages\config\tailwind.config.js
168. C:\MyCode\Orgo\packages\tsconfig\base.json
169. C:\MyCode\Orgo\packages\tsconfig\nestjs.json
170. C:\MyCode\Orgo\packages\tsconfig\nextjs.json
171. C:\MyCode\Orgo\packages\tsconfig\package.json
172. C:\MyCode\Orgo\packages\tsconfig\react-library.json
173. C:\MyCode\Orgo\packages\tsconfig\README.md
174. C:\MyCode\Orgo\packages\ui\components\Button\Button.tsx
175. C:\MyCode\Orgo\packages\ui\index.tsx
176. C:\MyCode\Orgo\packages\ui\package.json
177. C:\MyCode\Orgo\packages\ui\tsconfig.json
178. C:\MyCode\Orgo\README.md
179. C:\MyCode\Orgo\turbo.json
180. C:\MyCode\Orgo\yarn.lock
===== END TOC =====


===== BEGIN .dockerignore =====
**/node_modules
**/.next
**/dist
**/.turbo
===== END .dockerignore =====


===== BEGIN .gitignore =====
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
node_modules
.pnp
.pnp.js

# testing
coverage

# next.js
.next/
out/
build

**/dist
**/.env

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# local env files
.env.local
.env.development.local
.env.test.local
.env.production.local

# turbo
.turbo
===== END .gitignore =====


===== BEGIN ai_bundle.md =====
## C:\MyCode\Orgo\docker-compose.yml

```
version: "3.8"

services:
  reverse-proxy:
    image: nginx:latest
    container_name: nginx_container
    ports:
      - 80:80
    depends_on:
      - postgres
    volumes:
      - ./packages/config/nginx.conf:/etc/nginx/nginx.conf
    extra_hosts:
      - "host.docker.internal:host-gateway"

  postgres:
    image: postgres:15
    environment:
      - POSTGRES_DB=mydb
      - POSTGRES_USER=test
      - POSTGRES_PASSWORD=test
    volumes:
      - db_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

volumes:
  db_data:

```

## C:\MyCode\Orgo\package-scripts.js

```
const path = require("path");

const apiPath = path.resolve(__dirname, "apps/api");
const webPath = path.resolve(__dirname, "apps/web");

const ciApiPath = path.resolve(__dirname, "out/apps/api");
const ciWebPath = path.resolve(__dirname, "out/apps/web");

module.exports = {
  scripts: {
    prepare: {
      default: `nps prepare.web prepare.api`,
      web: `yarn`,
      api: `nps prepare.docker prisma.migrate.dev`,
      docker: "docker compose up -d",
      ci: {
        web: `npx turbo prune --scope=web && cd out && yarn install --frozen-lockfile`,
        api: `npx turbo prune --scope=api && cd out && yarn install --frozen-lockfile && nps prisma.generate`,
      },
    },
    test: {
      default: `nps test.web test.api`,
      web: `cd ${webPath} && yarn test`,
      api: `cd ${apiPath} && yarn test`,
      ci: {
        default: `nps test.ci.web test.ci.api`,
        web: `cd ${ciWebPath} && yarn test:ci`,
        api: `cd ${ciApiPath} && yarn test:ci`,
      },
      watch: {
        default: `nps test.watch.web test.watch.api`,
        web: `cd ${webPath} && yarn test:watch`,
        api: `cd ${apiPath} && yarn test:watch`,
      },
    },
    prisma: {
      generate: `cd ${apiPath} && npx prisma generate`,
      studio: `cd ${apiPath} && npx prisma studio`,
      migrate: {
        dev: `cd ${apiPath} && npx prisma migrate dev`,
      },
    },
    build: {
      default: "npx turbo run build",
      ci: {
        web: "cd out && npm run build",
        api: "cd out && npm run build",
      },
    },
    docker: {
      build: {
        default: "nps docker.build.web docker.build.api",
        web: `docker build -t web . -f ${webPath}/Dockerfile`,
        api: `docker build -t api . -f ${apiPath}/Dockerfile`,
      },
    },
    dev: "npx turbo run dev",
  },
};

```

## C:\MyCode\Orgo\package.json

```
{
  "name": "turborepo-basic-shared",
  "version": "0.0.0",
  "private": true,
  "workspaces": [
    "apps/*",
    "packages/*"
  ],
  "scripts": {
    "build": "turbo run build",
    "dev": "turbo run dev --parallel",
    "lint": "turbo run lint",
    "format": "prettier --write \"**/*.{ts,tsx,md}\""
  },
  "devDependencies": {
    "prettier": "^3.0.0",
    "prisma": "^5.1.0",
    "turbo": "1.10.12"
  },
  "engines": {
    "npm": ">=7.0.0",
    "node": ">=14.0.0"
  },
  "packageManager": "yarn@1.22.17"
}

```

## C:\MyCode\Orgo\README.md

```
# Turborepo (NestJS + Prisma + NextJS + Tailwind + Typescript + Jest) Starter

This is fullstack turborepo starter. It comes with the following features. 

- ✅ Turborepo 
- ✅ Nestjs 
    - ✅ Env Config with Validation  
    - ✅ Prisma 
- ✅ NextJS 
    - ✅ Tailwind 
    - ✅ Redux Toolkit Query 
- ✅ Testing using Jest 
- ✅ Github Actions 
- ✅ Reverse Proxy using Nginx 
- ✅ Docker Integration 
- ✅ Postgres Database 
- ✅ Package scripts using NPS 

## What's inside?

This turborepo uses [Yarn](https://classic.yarnpkg.com/lang/en/) as a package manager. It includes the following packages/apps:

### Apps and Packages

- `api`: a [NestJS](https://nestjs.com/) app
- `web`: a [Next.js](https://nextjs.org) app
- `ui`: a stub React component library used by `web`.
- `config`: `eslint`, `nginx` and `tailwind` (includes `eslint-config-next` and `eslint-config-prettier`)
- `tsconfig`: `tsconfig.json`s used throughout the monorepo

Each package/app is 100% [TypeScript](https://www.typescriptlang.org/).

### Utilities

This turborepo has some additional tools already setup for you:

- [Node Package Scripts](https://github.com/sezna/nps#readme) for automation scripts
- [TypeScript](https://www.typescriptlang.org/) for static type checking
- [ESLint](https://eslint.org/) for code linting
- [Prettier](https://prettier.io) for code formatting

## Setup
This starter kit is using turborepo and yarn workspaces for monorepo workflow.

### Prerequisites 
- Install nps by running 
```
npm i -g nps
```
- Make sure docker and docker-compose are
 installed. Refer to docs for your operating system.

### Configure Environment
- Frontend 
    - `cd apps/web && cp .env.example .env`
- Backend 
    - `cd apps/api && cp .env.example .env`

### Install Dependencies
Make sure you are at root of the project and just run 

```
nps prepare
```
### Build

To build all apps and packages, run the following command at the root of project:

```
nps build
```

### Develop

To develop all apps and packages, run the following command at the root of project:

```
nps dev
```
The app should be running at `http://localhost` with reverse proxy configured.


## Other available commands
Run `nps` in the terminal to see list of all available commands. 

```

## C:\MyCode\Orgo\turbo.json

```
{
  "pipeline": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**", ".next/**"]
    },
    "lint": {
      "outputs": []
    },
    "dev": {
      "cache": false
    },
    "test:ci": {
      "cache": false
    }
  }
}

```

## C:\MyCode\Orgo\apps\api\.env.example

```

DATABASE_URL="postgresql://test:test@localhost:5432/mydb?schema=public"
```

## C:\MyCode\Orgo\apps\api\Dockerfile

```
FROM node:16-alpine AS builder
RUN apk update
# Set working directory
WORKDIR /app
RUN yarn global add turbo
COPY . .
RUN turbo prune --scope=api --docker

# Add lockfile and package.json's of isolated subworkspace
FROM node:16-alpine AS installer
RUN apk update
WORKDIR /app
COPY --from=builder /app/out/json/ .
COPY --from=builder /app/out/yarn.lock ./yarn.lock
COPY --from=builder /app/turbo.json ./turbo.json
COPY --from=builder /app/apps/api/prisma ./prisma
RUN yarn install --frozen-lockfile
RUN yarn prisma generate 


FROM node:16-alpine AS sourcer
WORKDIR /app
COPY --from=installer /app/ .
COPY --from=builder /app/out/full/ .
COPY .gitignore .gitignore
RUN yarn turbo run build --scope=api --include-dependencies --no-deps

FROM node:16-alpine as runner
WORKDIR /app
COPY --from=sourcer /app/ .
CMD [ "node", "apps/api/dist/main.js" ]

```

## C:\MyCode\Orgo\apps\api\nest-cli.json

```
{
  "collection": "@nestjs/schematics",
  "sourceRoot": "src"
}

```

## C:\MyCode\Orgo\apps\api\package.json

```
{
  "name": "api",
  "version": "0.0.1",
  "description": "",
  "author": "",
  "private": true,
  "license": "UNLICENSED",
  "scripts": {
    "prebuild": "rimraf dist",
    "build": "nest build",
    "format": "prettier --write \"src/**/*.ts\" \"test/**/*.ts\"",
    "start": "nest start",
    "dev": "nest build --webpack --webpackPath webpack-hmr.config.js --watch",
    "start:debug": "nest start --debug --watch",
    "start:prod": "node dist/main",
    "lint": "eslint \"{src,apps,libs,test}/**/*.ts\" --fix",
    "test": "jest",
    "test:watch": "jest --watch --runInBand",
    "test:cov": "jest --coverage",
    "test:debug": "node --inspect-brk -r tsconfig-paths/register -r ts-node/register node_modules/.bin/jest --runInBand",
    "test:e2e": "jest --config ./test/jest-e2e.json --runInBand",
    "test:ci": "jest --ci --runInBand"
  },
  "dependencies": {
    "@nestjs/common": "^10.1.3",
    "@nestjs/config": "^3.0.0",
    "@nestjs/core": "^10.1.3",
    "@nestjs/platform-express": "^10.1.3",
    "@nestjs/swagger": "^7.1.6",
    "@prisma/client": "^5.1.0",
    "joi": "^17.9.2",
    "reflect-metadata": "^0.1.13",
    "rimraf": "^5.0.1",
    "rxjs": "^7.8.1",
    "swagger-ui-express": "^5.0.0"
  },
  "devDependencies": {
    "@nestjs/cli": "^10.1.11",
    "@nestjs/schematics": "^10.0.1",
    "@nestjs/testing": "^10.1.3",
    "@types/express": "^4.17.17",
    "@types/jest": "^29.5.3",
    "@types/node": "^20.4.5",
    "@types/supertest": "^2.0.12",
    "@typescript-eslint/eslint-plugin": "^6.2.1",
    "@typescript-eslint/parser": "^6.2.1",
    "eslint": "^8.46.0",
    "eslint-config-prettier": "^8.9.0",
    "eslint-plugin-prettier": "^5.0.0",
    "jest": "^29.6.2",
    "prettier": "^3.0.0",
    "prisma": "^5.1.0",
    "run-script-webpack-plugin": "^0.2.0",
    "source-map-support": "^0.5.21",
    "supertest": "^6.3.3",
    "ts-jest": "^29.1.1",
    "ts-loader": "^9.4.4",
    "ts-node": "^10.9.1",
    "tsconfig": "*",
    "tsconfig-paths": "^4.2.0",
    "typescript": "^5.1.6",
    "webpack": "^5.88.2",
    "webpack-node-externals": "^3.0.0"
  },
  "jest": {
    "moduleFileExtensions": [
      "js",
      "json",
      "ts"
    ],
    "rootDir": "src",
    "testRegex": ".*\\.spec\\.ts$",
    "transform": {
      "^.+\\.(t|j)s$": "ts-jest"
    },
    "collectCoverageFrom": [
      "**/*.(t|j)s"
    ],
    "coverageDirectory": "../coverage",
    "testEnvironment": "node"
  }
}

```

## C:\MyCode\Orgo\apps\api\README.md

```
<p align="center">
  <a href="http://nestjs.com/" target="blank"><img src="https://nestjs.com/img/logo_text.svg" width="320" alt="Nest Logo" /></a>
</p>

[circleci-image]: https://img.shields.io/circleci/build/github/nestjs/nest/master?token=abc123def456
[circleci-url]: https://circleci.com/gh/nestjs/nest

  <p align="center">A progressive <a href="http://nodejs.org" target="_blank">Node.js</a> framework for building efficient and scalable server-side applications.</p>
    <p align="center">
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/v/@nestjs/core.svg" alt="NPM Version" /></a>
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/l/@nestjs/core.svg" alt="Package License" /></a>
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/dm/@nestjs/common.svg" alt="NPM Downloads" /></a>
<a href="https://circleci.com/gh/nestjs/nest" target="_blank"><img src="https://img.shields.io/circleci/build/github/nestjs/nest/master" alt="CircleCI" /></a>
<a href="https://coveralls.io/github/nestjs/nest?branch=master" target="_blank"><img src="https://coveralls.io/repos/github/nestjs/nest/badge.svg?branch=master#9" alt="Coverage" /></a>
<a href="https://discord.gg/G7Qnnhy" target="_blank"><img src="https://img.shields.io/badge/discord-online-brightgreen.svg" alt="Discord"/></a>
<a href="https://opencollective.com/nest#backer" target="_blank"><img src="https://opencollective.com/nest/backers/badge.svg" alt="Backers on Open Collective" /></a>
<a href="https://opencollective.com/nest#sponsor" target="_blank"><img src="https://opencollective.com/nest/sponsors/badge.svg" alt="Sponsors on Open Collective" /></a>
  <a href="https://paypal.me/kamilmysliwiec" target="_blank"><img src="https://img.shields.io/badge/Donate-PayPal-ff3f59.svg"/></a>
    <a href="https://opencollective.com/nest#sponsor"  target="_blank"><img src="https://img.shields.io/badge/Support%20us-Open%20Collective-41B883.svg" alt="Support us"></a>
  <a href="https://twitter.com/nestframework" target="_blank"><img src="https://img.shields.io/twitter/follow/nestframework.svg?style=social&label=Follow"></a>
</p>
  <!--[![Backers on Open Collective](https://opencollective.com/nest/backers/badge.svg)](https://opencollective.com/nest#backer)
  [![Sponsors on Open Collective](https://opencollective.com/nest/sponsors/badge.svg)](https://opencollective.com/nest#sponsor)-->

## Description

[Nest](https://github.com/nestjs/nest) framework TypeScript starter repository.

## Installation

```bash
$ npm install
```

## Running the app

```bash
# development
$ npm run start

# watch mode
$ npm run start:dev

# production mode
$ npm run start:prod
```

## Test

```bash
# unit tests
$ npm run test

# e2e tests
$ npm run test:e2e

# test coverage
$ npm run test:cov
```

## Support

Nest is an MIT-licensed open source project. It can grow thanks to the sponsors and support by the amazing backers. If you'd like to join them, please [read more here](https://docs.nestjs.com/support).

## Stay in touch

- Author - [Kamil Myśliwiec](https://kamilmysliwiec.com)
- Website - [https://nestjs.com](https://nestjs.com/)
- Twitter - [@nestframework](https://twitter.com/nestframework)

## License

Nest is [MIT licensed](LICENSE).

```

## C:\MyCode\Orgo\apps\api\tsconfig.build.json

```
{
  "extends": "./tsconfig.json",
  "exclude": [
    "node_modules",
    "../../node_modules",
    "test",
    "dist",
    "**/*spec.ts"
  ]
}

```

## C:\MyCode\Orgo\apps\api\tsconfig.json

```
{
  "extends": "tsconfig/nestjs.json",
  "compilerOptions": {
    "outDir": "./dist",
    "baseUrl": "./"
  }
}

```

## C:\MyCode\Orgo\apps\api\webpack-hmr.config.js

```
/* eslint-disable @typescript-eslint/no-var-requires */
const nodeExternals = require('webpack-node-externals');
const { RunScriptWebpackPlugin } = require('run-script-webpack-plugin');

module.exports = function (options, webpack) {
  return {
    ...options,
    entry: ['webpack/hot/poll?100', options.entry],
    externals: [
      nodeExternals({
        allowlist: ['webpack/hot/poll?100'],
        modulesDir: '../../node_modules',
      }),
    ],
    plugins: [
      ...options.plugins,
      new webpack.HotModuleReplacementPlugin(),
      new webpack.WatchIgnorePlugin({
        paths: [/\.js$/, /\.d\.ts$/],
      }),
      new RunScriptWebpackPlugin({ name: options.output.filename }),
    ],
  };
};

```

## C:\MyCode\Orgo\apps\api\prisma\schema.prisma

```
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id    Int     @id @default(autoincrement())
  email String  @unique
  name  String?
}

```

## C:\MyCode\Orgo\apps\api\prisma\migrations\20220307034109_initial_migrate\migration.sql

```
-- CreateTable
CREATE TABLE "User" (
    "id" SERIAL NOT NULL,
    "email" TEXT NOT NULL,
    "name" TEXT,

    CONSTRAINT "User_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE UNIQUE INDEX "User_email_key" ON "User"("email");

```

## C:\MyCode\Orgo\apps\api\src\app.controller.ts

```
import { Controller, Get } from '@nestjs/common';
import { AppService } from './app.service';

@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get()
  async getHello(): Promise<{ message: string }> {
    return await this.appService.getHello();
  }
}

```

## C:\MyCode\Orgo\apps\api\src\app.module.ts

```
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { validationSchemaForEnv } from './config/environment-variables';
import { PersistenceModule } from './persistence/persistence.module';

@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true,
      validationSchema: validationSchemaForEnv,
    }),
    PersistenceModule,
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}

```

## C:\MyCode\Orgo\apps\api\src\app.service.ts

```
import { Injectable } from '@nestjs/common';

@Injectable()
export class AppService {
  async getHello(): Promise<{ message: string }> {
    return { message: 'Hello World' };
  }
}

```

## C:\MyCode\Orgo\apps\api\src\main.ts

```
import { Logger } from '@nestjs/common';
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { SwaggerModule, DocumentBuilder } from '@nestjs/swagger';

declare const module: any;
async function bootstrap() {
  const logger = new Logger('EntryPoint');
  const app = await NestFactory.create(AppModule);

  const config = new DocumentBuilder()
    .setTitle('Leaves Tracker')
    .setDescription('Api Docs for leaves tracker')
    .setVersion('1.0')
    .build();

  const document = SwaggerModule.createDocument(app, config);
  SwaggerModule.setup('docs', app, document);

  const PORT = 5002;

  await app.listen(PORT);

  if (module.hot) {
    module.hot.accept();
    module.hot.dispose(() => app.close());
  }
  logger.log(`Server running on http://localhost:${PORT}`);
}
bootstrap();

```

## C:\MyCode\Orgo\apps\api\src\config\environment-variables.ts

```
import * as Joi from 'joi';

export interface EnvironmentVariables {
  DATABASE_URL: string;
}

export const validationSchemaForEnv = Joi.object<EnvironmentVariables, true>({
  DATABASE_URL: Joi.string().required(),
});

```

## C:\MyCode\Orgo\apps\api\src\persistence\persistence.module.ts

```
import { Module } from '@nestjs/common';
import { PrismaService } from './prisma/prisma.service';

@Module({
  providers: [PrismaService],
  exports: [PrismaService],
})
export class PersistenceModule {}

```

## C:\MyCode\Orgo\apps\api\src\persistence\prisma\prisma.service.ts

```
import { Injectable, OnModuleInit } from '@nestjs/common';
import { PrismaClient } from '@prisma/client';

@Injectable()
export class PrismaService extends PrismaClient implements OnModuleInit {
  async onModuleInit() {
    await this.$connect();
  }
}

```

## C:\MyCode\Orgo\apps\web\.env.example

```
```

## C:\MyCode\Orgo\apps\web\Dockerfile

```
FROM node:16-alpine AS builder
RUN apk update
# Set working directory
WORKDIR /app
RUN yarn global add turbo
COPY . .
# Only Take packages that are needed to compile this app
RUN turbo prune --scope=web --docker

# Add lockfile and package.json's of isolated subworkspace
FROM node:16-alpine AS installer
RUN apk update
RUN apk add --no-cache libc6-compat
WORKDIR /app
COPY --from=builder /app/out/json/ .
COPY --from=builder /app/out/yarn.lock ./yarn.lock
COPY --from=builder /app/turbo.json ./turbo.json
RUN yarn install --frozen-lockfile


FROM node:16-alpine AS sourcer
RUN apk update
WORKDIR /app
COPY --from=installer /app/ .
COPY --from=builder /app/out/full/ .
COPY .gitignore .gitignore
RUN yarn turbo run build --scope=web --include-dependencies --no-deps

FROM node:16-alpine as runner
WORKDIR /app
COPY --from=sourcer /app/ .
WORKDIR /app/apps/web/
CMD [ "npm", "start" ]

```

## C:\MyCode\Orgo\apps\web\next.config.js

```
const withTM = require("next-transpile-modules")(["ui"]);

module.exports = withTM({
  reactStrictMode: true,
});

```

## C:\MyCode\Orgo\apps\web\package.json

```
{
  "name": "web",
  "version": "0.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:ci": "jest --ci"
  },
  "dependencies": {
    "@reduxjs/toolkit": "^1.9.5",
    "next": "13.4.12",
    "react": "18.2.0",
    "react-dom": "18.2.0",
    "react-redux": "^8.1.2",
    "ui": "*"
  },
  "devDependencies": {
    "@testing-library/jest-dom": "^5.17.0",
    "@testing-library/react": "^14.0.0",
    "@testing-library/user-event": "14.4.3",
    "@types/node": "^20.4.5",
    "@types/react": "18.2.18",
    "autoprefixer": "^10.4.14",
    "config": "*",
    "eslint": "8.46.0",
    "jest": "^29.6.2",
    "jest-environment-jsdom": "^29.6.2",
    "next-transpile-modules": "10.0.1",
    "postcss": "^8.4.27",
    "tailwindcss": "^3.3.3",
    "tsconfig": "*",
    "typescript": "^5.1.6"
  }
}

```

## C:\MyCode\Orgo\apps\web\postcss.config.js

```
module.exports = require("config/postcss.config");

```

## C:\MyCode\Orgo\apps\web\README.md

```
## Getting Started

First, run the development server:

```bash
yarn dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `pages/index.js`. The page auto-updates as you edit the file.

[API routes](https://nextjs.org/docs/api-routes/introduction) can be accessed on [http://localhost:3000/api/hello](http://localhost:3000/api/hello). This endpoint can be edited in `pages/api/hello.js`.

The `pages/api` directory is mapped to `/api/*`. Files in this directory are treated as [API routes](https://nextjs.org/docs/api-routes/introduction) instead of React pages.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js/) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_source=github.com&utm_medium=referral&utm_campaign=turborepo-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/deployment) for more details.

```

## C:\MyCode\Orgo\apps\web\tailwind.config.js

```
module.exports = require("config/tailwind.config");

```

## C:\MyCode\Orgo\apps\web\tsconfig.json

```
{
  "extends": "tsconfig/nextjs.json",
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", "jest.setup.js"],
  "exclude": ["node_modules"]
}

```

## C:\MyCode\Orgo\apps\web\pages\_app.tsx

```
import type { AppProps } from "next/app";
import { Provider } from "react-redux";
import store from "../src/store";
import "../src/styles/global.css";

function MyApp({ Component, pageProps }: AppProps) {
  return (
    <Provider store={store}>
      <Component {...pageProps} />;
    </Provider>
  );
}

export default MyApp;

```

## C:\MyCode\Orgo\apps\web\pages\index.tsx

```
import { Button } from "ui";
import { useHelloQuery } from "../src/store/services/api";

export default function Web() {
  const { data } = useHelloQuery();

  return (
    <div>
      <h1>{data?.message}</h1>
      <Button />
    </div>
  );
}

```

## C:\MyCode\Orgo\apps\web\src\screens\auth\login\login.test.tsx

```
import { render } from "@testing-library/react";
import { LoginScreen } from "./login";

test("render login component", () => {
  render(<LoginScreen />);
});

```

## C:\MyCode\Orgo\apps\web\src\screens\auth\login\login.tsx

```
import { Button } from "ui";

export function LoginScreen() {
  return (
    <div>
      Login Screen <Button />
    </div>
  );
}

```

## C:\MyCode\Orgo\apps\web\src\store\index.ts

```
import { configureStore } from "@reduxjs/toolkit";
import { TypedUseSelectorHook, useDispatch, useSelector } from "react-redux";

import { api } from "./services/api";

export function makeStore() {
  return configureStore({
    reducer: {
      [api.reducerPath]: api.reducer,
    },

    middleware: (getDefaultMiddleware) =>
      getDefaultMiddleware().concat(api.middleware),
  });
}

const store = makeStore();

export type RootState = ReturnType<typeof store.getState>;

export type AppDispatch = typeof store.dispatch;

export const useAppDispatch = () => useDispatch<AppDispatch>();

export const useAppSelector: TypedUseSelectorHook<RootState> = useSelector;

export default store;

```

## C:\MyCode\Orgo\apps\web\src\store\services\api.ts

```
import { createApi, fetchBaseQuery } from "@reduxjs/toolkit/query/react";

export const api = createApi({
  reducerPath: "baseApi",
  baseQuery: fetchBaseQuery({
    baseUrl: "api",
  }),
  tagTypes: [],
  endpoints: (builder) => ({
    hello: builder.query<{ message: string }, void>({
      query: () => ({
        url: "/",
      }),
    }),
  }),
});

export const { useHelloQuery } = api;

```

## C:\MyCode\Orgo\apps\web\src\styles\global.css

```
@tailwind base;
@tailwind components;
@tailwind utilities;

```

## C:\MyCode\Orgo\packages\config\nginx.conf

```
events {

}

http {

    server {
        listen 80;
        server_name localhost;

        location /api/ {
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_pass http://host.docker.internal:5002/;

            proxy_http_version 1.1;
            proxy_set_header Connection "upgrade";
            proxy_set_header Upgrade $http_upgrade;
        }

        location /_next/webpack-hmr {
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Host $host;


            proxy_pass http://host.docker.internal:3000;

            proxy_http_version 1.1;
            proxy_set_header Connection "upgrade";
            proxy_set_header Upgrade $http_upgrade;
        }

        location / {
            proxy_pass http://host.docker.internal:3000;
        }

    }

}

```

## C:\MyCode\Orgo\packages\config\package.json

```
{
  "name": "config",
  "version": "0.0.0",
  "main": "index.js",
  "license": "MIT",
  "files": [
    "eslint-preset.js"
  ],
  "dependencies": {
    "eslint-config-next": "^13.4.12",
    "eslint-config-prettier": "^8.9.0",
    "eslint-plugin-react": "7.33.1"
  }
}

```

## C:\MyCode\Orgo\packages\config\postcss.config.js

```
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};

```

## C:\MyCode\Orgo\packages\config\tailwind.config.js

```
module.exports = {
  content: [
    "../../packages/ui/**/*.{js,ts,jsx,tsx}",
    "./pages/**/*.{js,ts,jsx,tsx}",
    "./components/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {},
  },
  plugins: [],
};

```

## C:\MyCode\Orgo\packages\tsconfig\base.json

```
{
  "$schema": "https://json.schemastore.org/tsconfig",
  "display": "Default",
  "compilerOptions": {
    "composite": false,
    "declaration": true,
    "declarationMap": true,
    "esModuleInterop": true,
    "forceConsistentCasingInFileNames": true,
    "inlineSources": false,
    "isolatedModules": true,
    "moduleResolution": "node",
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "preserveWatchOutput": true,
    "skipLibCheck": true,
    "strict": true
  },
  "exclude": ["node_modules"]
}

```

## C:\MyCode\Orgo\packages\tsconfig\nestjs.json

```
{
  "$schema": "https://json.schemastore.org/tsconfig",
  "extends": "./base.json",
  "compilerOptions": {
    "module": "commonjs",
    "declaration": true,
    "removeComments": true,
    "emitDecoratorMetadata": true,
    "experimentalDecorators": true,
    "allowSyntheticDefaultImports": true,
    "target": "es2017",
    "sourceMap": true,
    "incremental": true,
    "skipLibCheck": true,
    "strictNullChecks": false,
    "noImplicitAny": false,
    "strictBindCallApply": false,
    "forceConsistentCasingInFileNames": false,
    "noFallthroughCasesInSwitch": false
  }
}

```

## C:\MyCode\Orgo\packages\tsconfig\nextjs.json

```
{
  "$schema": "https://json.schemastore.org/tsconfig",
  "display": "Next.js",
  "extends": "./base.json",
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": false,
    "forceConsistentCasingInFileNames": true,
    "noEmit": true,
    "incremental": true,
    "esModuleInterop": true,
    "module": "esnext",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve"
  },
  "include": ["src", "next-env.d.ts"],
  "exclude": ["node_modules"]
}

```

## C:\MyCode\Orgo\packages\tsconfig\package.json

```
{
  "name": "tsconfig",
  "version": "0.0.0",
  "private": true,
  "main": "index.js",
  "files": [
    "base.json",
    "nextjs.json",
    "react-library.json"
  ]
}

```

## C:\MyCode\Orgo\packages\tsconfig\react-library.json

```
{
  "$schema": "https://json.schemastore.org/tsconfig",
  "display": "React Library",
  "extends": "./base.json",
  "compilerOptions": {
    "lib": ["ES2015"],
    "module": "ESNext",
    "target": "ES6",
    "jsx": "react-jsx"
  }
}

```

## C:\MyCode\Orgo\packages\tsconfig\README.md

```
# `tsconfig`

These are base shared `tsconfig.json`s from which all other `tsconfig.json`'s inherit from.

```

## C:\MyCode\Orgo\packages\ui\index.tsx

```
export * from "./components/Button/Button";

```

## C:\MyCode\Orgo\packages\ui\package.json

```
{
  "name": "ui",
  "version": "0.0.0",
  "main": "./index.tsx",
  "types": "./index.tsx",
  "license": "MIT",
  "devDependencies": {
    "@types/react": "^18.2.18",
    "@types/react-dom": "^18.2.7",
    "config": "*",
    "tsconfig": "*",
    "typescript": "^5.1.6"
  }
}

```

## C:\MyCode\Orgo\packages\ui\tsconfig.json

```
{
  "extends": "tsconfig/react-library.json",
  "include": ["."],
  "exclude": ["dist", "build", "node_modules"]
}

```

## C:\MyCode\Orgo\packages\ui\components\Button\Button.tsx

```
export const Button = () => {
  return <button className="text-lg bg-red-500">boo</button>;
};

```


===== END ai_bundle.md =====


===== BEGIN apps/api/.env.example =====

DATABASE_URL="postgresql://test:test@localhost:5432/mydb?schema=public"
===== END apps/api/.env.example =====


===== BEGIN apps/api/.eslintrc.js =====
module.exports = {
  parser: '@typescript-eslint/parser',
  parserOptions: {
    project: 'tsconfig.json',
    sourceType: 'module',
    tsconfigRootDir: __dirname,
  },
  plugins: ['@typescript-eslint/eslint-plugin'],
  extends: [
    'plugin:@typescript-eslint/recommended',
    'plugin:prettier/recommended',
  ],
  root: true,
  env: {
    node: true,
    jest: true,
  },
  ignorePatterns: ['.eslintrc.js'],
  rules: {
    '@typescript-eslint/interface-name-prefix': 'off',
    '@typescript-eslint/explicit-function-return-type': 'off',
    '@typescript-eslint/explicit-module-boundary-types': 'off',
    '@typescript-eslint/no-explicit-any': 'off',
  },
};

===== END apps/api/.eslintrc.js =====


===== BEGIN apps/api/.prettierrc =====
{
  "singleQuote": true,
  "trailingComma": "all"
}
===== END apps/api/.prettierrc =====


===== BEGIN apps/api/Dockerfile =====
FROM node:16-alpine AS builder
RUN apk update
# Set working directory
WORKDIR /app
RUN yarn global add turbo
COPY . .
RUN turbo prune --scope=api --docker

# Add lockfile and package.json's of isolated subworkspace
FROM node:16-alpine AS installer
RUN apk update
WORKDIR /app
COPY --from=builder /app/out/json/ .
COPY --from=builder /app/out/yarn.lock ./yarn.lock
COPY --from=builder /app/turbo.json ./turbo.json
COPY --from=builder /app/apps/api/prisma ./prisma
RUN yarn install --frozen-lockfile
RUN yarn prisma generate 


FROM node:16-alpine AS sourcer
WORKDIR /app
COPY --from=installer /app/ .
COPY --from=builder /app/out/full/ .
COPY .gitignore .gitignore
RUN yarn turbo run build --scope=api --include-dependencies --no-deps

FROM node:16-alpine as runner
WORKDIR /app
COPY --from=sourcer /app/ .
CMD [ "node", "apps/api/dist/main.js" ]

===== END apps/api/Dockerfile =====


===== BEGIN apps/api/nest-cli.json =====
{
  "collection": "@nestjs/schematics",
  "sourceRoot": "src"
}

===== END apps/api/nest-cli.json =====


===== BEGIN apps/api/package.json =====
{
  "name": "api",
  "version": "0.0.1",
  "description": "",
  "author": "",
  "private": true,
  "license": "UNLICENSED",
  "scripts": {
    "prebuild": "rimraf dist",
    "build": "nest build",
    "format": "prettier --write \"src/**/*.ts\" \"test/**/*.ts\"",
    "start": "nest start",
    "dev": "nest build --webpack --webpackPath webpack-hmr.config.js --watch",
    "start:debug": "nest start --debug --watch",
    "start:prod": "node dist/main",
    "lint": "eslint \"{src,apps,libs,test}/**/*.ts\" --fix",
    "test": "jest",
    "test:watch": "jest --watch --runInBand",
    "test:cov": "jest --coverage",
    "test:debug": "node --inspect-brk -r tsconfig-paths/register -r ts-node/register node_modules/.bin/jest --runInBand",
    "test:e2e": "jest --config ./test/jest-e2e.json --runInBand",
    "test:ci": "jest --ci --runInBand"
  },
  "dependencies": {
    "@nestjs/common": "^10.1.3",
    "@nestjs/config": "^3.0.0",
    "@nestjs/core": "^10.1.3",
    "@nestjs/platform-express": "^10.1.3",
    "@nestjs/swagger": "^7.1.6",
    "@prisma/client": "^5.1.0",
    "joi": "^17.9.2",
    "reflect-metadata": "^0.1.13",
    "rimraf": "^5.0.1",
    "rxjs": "^7.8.1",
    "swagger-ui-express": "^5.0.0"
  },
  "devDependencies": {
    "@nestjs/cli": "^10.1.11",
    "@nestjs/schematics": "^10.0.1",
    "@nestjs/testing": "^10.1.3",
    "@types/express": "^4.17.17",
    "@types/jest": "^29.5.3",
    "@types/node": "^20.4.5",
    "@types/supertest": "^2.0.12",
    "@typescript-eslint/eslint-plugin": "^6.2.1",
    "@typescript-eslint/parser": "^6.2.1",
    "eslint": "^8.46.0",
    "eslint-config-prettier": "^8.9.0",
    "eslint-plugin-prettier": "^5.0.0",
    "jest": "^29.6.2",
    "prettier": "^3.0.0",
    "prisma": "^5.1.0",
    "run-script-webpack-plugin": "^0.2.0",
    "source-map-support": "^0.5.21",
    "supertest": "^6.3.3",
    "ts-jest": "^29.1.1",
    "ts-loader": "^9.4.4",
    "ts-node": "^10.9.1",
    "tsconfig": "*",
    "tsconfig-paths": "^4.2.0",
    "typescript": "^5.1.6",
    "webpack": "^5.88.2",
    "webpack-node-externals": "^3.0.0"
  },
  "jest": {
    "moduleFileExtensions": [
      "js",
      "json",
      "ts"
    ],
    "rootDir": "src",
    "testRegex": ".*\\.spec\\.ts$",
    "transform": {
      "^.+\\.(t|j)s$": "ts-jest"
    },
    "collectCoverageFrom": [
      "**/*.(t|j)s"
    ],
    "coverageDirectory": "../coverage",
    "testEnvironment": "node"
  }
}

===== END apps/api/package.json =====


===== BEGIN apps/api/prisma/migrations/20220307034109_initial_migrate/migration.sql =====
-- CreateTable
CREATE TABLE "User" (
    "id" SERIAL NOT NULL,
    "email" TEXT NOT NULL,
    "name" TEXT,

    CONSTRAINT "User_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE UNIQUE INDEX "User_email_key" ON "User"("email");

===== END apps/api/prisma/migrations/20220307034109_initial_migrate/migration.sql =====


===== BEGIN apps/api/prisma/migrations/migration_lock.toml =====
# Please do not edit this file manually
# It should be added in your version-control system (i.e. Git)
provider = "postgresql"
===== END apps/api/prisma/migrations/migration_lock.toml =====


===== BEGIN apps/api/prisma/schema.prisma =====
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id    Int     @id @default(autoincrement())
  email String  @unique
  name  String?
}

===== END apps/api/prisma/schema.prisma =====


===== BEGIN apps/api/README.md =====
<p align="center">
  <a href="http://nestjs.com/" target="blank"><img src="https://nestjs.com/img/logo_text.svg" width="320" alt="Nest Logo" /></a>
</p>

[circleci-image]: https://img.shields.io/circleci/build/github/nestjs/nest/master?token=abc123def456
[circleci-url]: https://circleci.com/gh/nestjs/nest

  <p align="center">A progressive <a href="http://nodejs.org" target="_blank">Node.js</a> framework for building efficient and scalable server-side applications.</p>
    <p align="center">
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/v/@nestjs/core.svg" alt="NPM Version" /></a>
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/l/@nestjs/core.svg" alt="Package License" /></a>
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/dm/@nestjs/common.svg" alt="NPM Downloads" /></a>
<a href="https://circleci.com/gh/nestjs/nest" target="_blank"><img src="https://img.shields.io/circleci/build/github/nestjs/nest/master" alt="CircleCI" /></a>
<a href="https://coveralls.io/github/nestjs/nest?branch=master" target="_blank"><img src="https://coveralls.io/repos/github/nestjs/nest/badge.svg?branch=master#9" alt="Coverage" /></a>
<a href="https://discord.gg/G7Qnnhy" target="_blank"><img src="https://img.shields.io/badge/discord-online-brightgreen.svg" alt="Discord"/></a>
<a href="https://opencollective.com/nest#backer" target="_blank"><img src="https://opencollective.com/nest/backers/badge.svg" alt="Backers on Open Collective" /></a>
<a href="https://opencollective.com/nest#sponsor" target="_blank"><img src="https://opencollective.com/nest/sponsors/badge.svg" alt="Sponsors on Open Collective" /></a>
  <a href="https://paypal.me/kamilmysliwiec" target="_blank"><img src="https://img.shields.io/badge/Donate-PayPal-ff3f59.svg"/></a>
    <a href="https://opencollective.com/nest#sponsor"  target="_blank"><img src="https://img.shields.io/badge/Support%20us-Open%20Collective-41B883.svg" alt="Support us"></a>
  <a href="https://twitter.com/nestframework" target="_blank"><img src="https://img.shields.io/twitter/follow/nestframework.svg?style=social&label=Follow"></a>
</p>
  <!--[![Backers on Open Collective](https://opencollective.com/nest/backers/badge.svg)](https://opencollective.com/nest#backer)
  [![Sponsors on Open Collective](https://opencollective.com/nest/sponsors/badge.svg)](https://opencollective.com/nest#sponsor)-->

## Description

[Nest](https://github.com/nestjs/nest) framework TypeScript starter repository.

## Installation

```bash
$ npm install
```

## Running the app

```bash
# development
$ npm run start

# watch mode
$ npm run start:dev

# production mode
$ npm run start:prod
```

## Test

```bash
# unit tests
$ npm run test

# e2e tests
$ npm run test:e2e

# test coverage
$ npm run test:cov
```

## Support

Nest is an MIT-licensed open source project. It can grow thanks to the sponsors and support by the amazing backers. If you'd like to join them, please [read more here](https://docs.nestjs.com/support).

## Stay in touch

- Author - [Kamil Myśliwiec](https://kamilmysliwiec.com)
- Website - [https://nestjs.com](https://nestjs.com/)
- Twitter - [@nestframework](https://twitter.com/nestframework)

## License

Nest is [MIT licensed](LICENSE).

===== END apps/api/README.md =====


===== BEGIN apps/api/src/app.controller.spec.ts =====
import { Test, TestingModule } from '@nestjs/testing';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { PersistenceModule } from './persistence/persistence.module';

describe('AppController', () => {
  let appController: AppController;

  beforeEach(async () => {
    const app: TestingModule = await Test.createTestingModule({
      imports: [PersistenceModule],
      controllers: [AppController],
      providers: [AppService],
    }).compile();

    appController = app.get<AppController>(AppController);
  });

  describe('root', () => {
    it('should return "Hello World!"', async () => {
      expect(await appController.getHello()).toEqual({
        message: 'Hello World',
      });
    });
  });
});

===== END apps/api/src/app.controller.spec.ts =====


===== BEGIN apps/api/src/app.controller.ts =====
import { Controller, Get } from '@nestjs/common';
import { AppService } from './app.service';

@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get()
  async getHello(): Promise<{ message: string }> {
    return await this.appService.getHello();
  }
}

===== END apps/api/src/app.controller.ts =====


===== BEGIN apps/api/src/app.module.ts =====
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { validationSchemaForEnv } from './config/environment-variables';
import { PersistenceModule } from './persistence/persistence.module';

@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true,
      validationSchema: validationSchemaForEnv,
    }),
    PersistenceModule,
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}

===== END apps/api/src/app.module.ts =====


===== BEGIN apps/api/src/app.service.ts =====
import { Injectable } from '@nestjs/common';

@Injectable()
export class AppService {
  async getHello(): Promise<{ message: string }> {
    return { message: 'Hello World' };
  }
}

===== END apps/api/src/app.service.ts =====


===== BEGIN apps/api/src/config/environment-variables.ts =====
import * as Joi from 'joi';

export interface EnvironmentVariables {
  DATABASE_URL: string;
}

export const validationSchemaForEnv = Joi.object<EnvironmentVariables, true>({
  DATABASE_URL: Joi.string().required(),
});

===== END apps/api/src/config/environment-variables.ts =====


===== BEGIN apps/api/src/main.ts =====
import { Logger } from '@nestjs/common';
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { SwaggerModule, DocumentBuilder } from '@nestjs/swagger';

declare const module: any;
async function bootstrap() {
  const logger = new Logger('EntryPoint');
  const app = await NestFactory.create(AppModule);

  const config = new DocumentBuilder()
    .setTitle('Leaves Tracker')
    .setDescription('Api Docs for leaves tracker')
    .setVersion('1.0')
    .build();

  const document = SwaggerModule.createDocument(app, config);
  SwaggerModule.setup('docs', app, document);

  const PORT = 5002;

  await app.listen(PORT);

  if (module.hot) {
    module.hot.accept();
    module.hot.dispose(() => app.close());
  }
  logger.log(`Server running on http://localhost:${PORT}`);
}
bootstrap();

===== END apps/api/src/main.ts =====


===== BEGIN apps/api/src/orgo/backbone/identity/dto/link-user-person.dto.ts =====
import { ApiProperty } from '@nestjs/swagger';
import { IsNotEmpty, IsUUID } from 'class-validator';

/**
 * Payload for linking an existing user account to an existing person profile.
 *
 * Invariants (enforced by the consuming service, not this DTO):
 * - userId and personId must both exist.
 * - Both records must belong to the same organization.
 * - A user account should be linked to at most one person profile.
 * - A person profile should be linked to at most one user account.
 */
export class LinkUserPersonDto {
  @ApiProperty({
    description:
      'ID of the user account to link (user_accounts.id in the current organization).',
    format: 'uuid',
    example: '3b1f0c66-0272-4bf7-8f03-4620e2a7f8da',
  })
  @IsUUID('4')
  @IsNotEmpty()
  userId!: string;

  @ApiProperty({
    description:
      'ID of the person profile to link (person_profiles.id in the current organization).',
    format: 'uuid',
    example: '5e8c3dda-38bb-4c64-a8b1-7ecaf0c2f3e4',
  })
  @IsUUID('4')
  @IsNotEmpty()
  personId!: string;
}

===== END apps/api/src/orgo/backbone/identity/dto/link-user-person.dto.ts =====


===== BEGIN apps/api/src/orgo/backbone/identity/identity-link.controller.ts =====
import {
  BadRequestException,
  Body,
  Controller,
  Delete,
  Get,
  Headers,
  HttpCode,
  HttpStatus,
  Param,
  Post,
} from '@nestjs/common';
import { IsBoolean, IsOptional, IsUUID } from 'class-validator';

import { IdentityLinkService } from './identity-link.service';

/**
 * Standard result shape used across Core Services:
 * { ok: true, data: ..., error: null } or
 * { ok: false, data: null, error: { code, message, details? } }
 *
 * See Core Services spec for the canonical shape.
 */
export interface StandardResult<T> {
  ok: boolean;
  data: T | null;
  error:
    | null
    | {
        code: string;
        message: string;
        details?: Record<string, unknown>;
      };
}

/**
 * Logical view of a user–person link.
 * Physically this is backed by person_profiles.linked_user_id,
 * together with the shared organization_id invariant.
 */
export interface IdentityLinkView {
  organizationId: string;
  userId: string;
  personId: string;
}

/**
 * DTO for creating or updating a user–person link.
 *
 * The actual multi‑tenant enforcement is done in the service:
 * - userId and personId must both belong to organizationId
 * - person_profiles.linked_user_id is updated accordingly
 */
export class LinkUserToPersonDto {
  @IsUUID('4')
  userId!: string;

  @IsUUID('4')
  personId!: string;

  /**
   * If true, the service may break an existing link for the user or person
   * in order to apply this new link. If false, conflicting links should
   * cause a validation error.
   */
  @IsOptional()
  @IsBoolean()
  force?: boolean;
}

/**
 * DTO for unlinking a user–person pair.
 *
 * At least one of userId or personId must be provided; the service will
 * resolve the other from existing data (if any).
 */
export class UnlinkUserFromPersonDto {
  @IsOptional()
  @IsUUID('4')
  userId?: string;

  @IsOptional()
  @IsUUID('4')
  personId?: string;
}

/**
 * IdentityLinkController
 *
 * Responsibility: thin HTTP layer over IdentityLinkService for linking and
 * unlinking user accounts (user_accounts) and person profiles (person_profiles)
 * within a single organization.
 *
 * Route base is kept narrow; the global Nest app prefix (e.g. /api/v3)
 * is assumed to be configured at bootstrap level.
 */
@Controller('identity-link')
export class IdentityLinkController {
  constructor(private readonly identityLinkService: IdentityLinkService) {}

  /**
   * Create or update a link between a UserAccount and a PersonProfile.
   *
   * - organizationId is taken from the X-Organization-Id header.
   * - userId and personId must both belong to that organization.
   * - If force=true, the service may overwrite existing links.
   *
   * Example request:
   *   POST /identity-link
   *   Headers:
   *     X-Organization-Id: <org-uuid>
   *   Body:
   *   {
   *     "userId": "<user-uuid>",
   *     "personId": "<person-uuid>",
   *     "force": false
   *   }
   */
  @Post()
  @HttpCode(HttpStatus.OK)
  async linkUserToPerson(
    @Headers('x-organization-id') organizationId: string,
    @Body() body: LinkUserToPersonDto,
  ): Promise<StandardResult<IdentityLinkView>> {
    const orgId = this.normalizeOrganizationId(organizationId);

    return this.identityLinkService.linkUserToPerson({
      organizationId: orgId,
      userId: body.userId,
      personId: body.personId,
      force: body.force ?? false,
    });
  }

  /**
   * Remove a link between a UserAccount and a PersonProfile.
   *
   * At least one of userId or personId must be provided. The service will
   * resolve the other side if a link exists and clear it.
   *
   * Example request:
   *   DELETE /identity-link
   *   Headers:
   *     X-Organization-Id: <org-uuid>
   *   Body:
   *   {
   *     "personId": "<person-uuid>"
   *   }
   *
   * On success, data will typically be null (no active link remains).
   */
  @Delete()
  @HttpCode(HttpStatus.OK)
  async unlinkUserFromPerson(
    @Headers('x-organization-id') organizationId: string,
    @Body() body: UnlinkUserFromPersonDto,
  ): Promise<StandardResult<IdentityLinkView | null>> {
    const orgId = this.normalizeOrganizationId(organizationId);

    if (!body.userId && !body.personId) {
      throw new BadRequestException(
        'At least one of userId or personId must be provided to unlink.',
      );
    }

    return this.identityLinkService.unlinkUserFromPerson({
      organizationId: orgId,
      userId: body.userId,
      personId: body.personId,
    });
  }

  /**
   * Fetch the current PersonProfile link for a given UserAccount.
   *
   * Example request:
   *   GET /identity-link/user/<userId>
   *   Headers:
   *     X-Organization-Id: <org-uuid>
   *
   * If no link exists, ok=true with data=null is returned.
   */
  @Get('user/:userId')
  async getLinkForUser(
    @Headers('x-organization-id') organizationId: string,
    @Param('userId') userId: string,
  ): Promise<StandardResult<IdentityLinkView | null>> {
    const orgId = this.normalizeOrganizationId(organizationId);

    if (!userId) {
      throw new BadRequestException('userId path parameter is required.');
    }

    return this.identityLinkService.getLinkByUserId({
      organizationId: orgId,
      userId,
    });
  }

  /**
   * Fetch the current UserAccount link for a given PersonProfile.
   *
   * Example request:
   *   GET /identity-link/person/<personId>
   *   Headers:
   *     X-Organization-Id: <org-uuid>
   *
   * If no link exists, ok=true with data=null is returned.
   */
  @Get('person/:personId')
  async getLinkForPerson(
    @Headers('x-organization-id') organizationId: string,
    @Param('personId') personId: string,
  ): Promise<StandardResult<IdentityLinkView | null>> {
    const orgId = this.normalizeOrganizationId(organizationId);

    if (!personId) {
      throw new BadRequestException('personId path parameter is required.');
    }

    return this.identityLinkService.getLinkByPersonId({
      organizationId: orgId,
      personId,
    });
  }

  /**
   * Normalize and validate the organization ID header.
   *
   * This keeps multi‑tenant invariants explicit at the controller boundary.
   */
  private normalizeOrganizationId(raw: string | undefined): string {
    const value = (raw || '').trim();

    if (!value) {
      throw new BadRequestException(
        'Missing X-Organization-Id header for multi-tenant operation.',
      );
    }

    return value;
  }
}

===== END apps/api/src/orgo/backbone/identity/identity-link.controller.ts =====


===== BEGIN apps/api/src/orgo/backbone/identity/identity-link.module.ts =====
import { Module } from '@nestjs/common';
import { PersistenceModule } from '../../../persistence/persistence.module';
import { PersonProfileModule } from '../persons/person-profile.module';
import { IdentityLinkService } from './identity-link.service';
import { IdentityLinkController } from './identity-link.controller';

/**
 * IdentityLinkModule
 *
 * Backbone module responsible for linking user accounts to person profiles
 * in a multi-tenant-safe way, using the canonical Orgo identity model
 * (user_accounts vs person_profiles) and the shared persistence layer.
 *
 * Exposes IdentityLinkService so other modules can establish or query links.
 */
@Module({
  imports: [PersistenceModule, PersonProfileModule],
  providers: [IdentityLinkService],
  controllers: [IdentityLinkController],
  exports: [IdentityLinkService],
})
export class IdentityLinkModule {}

===== END apps/api/src/orgo/backbone/identity/identity-link.module.ts =====


===== BEGIN apps/api/src/orgo/backbone/identity/identity-link.service.ts =====

===== END apps/api/src/orgo/backbone/identity/identity-link.service.ts =====


===== BEGIN apps/api/src/orgo/backbone/organizations/dto/create-organization.dto.ts =====
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';
import {
  IsIn,
  IsNotEmpty,
  IsOptional,
  IsString,
  Matches,
  MaxLength,
  MinLength,
} from 'class-validator';

export const ORGANIZATION_STATUS_VALUES = ['active', 'suspended', 'archived'] as const;

export type OrganizationStatus = (typeof ORGANIZATION_STATUS_VALUES)[number];

export class CreateOrganizationDto {
  @ApiProperty({
    description:
      'Short, URL-safe identifier for the organization (lowercase, hyphen-separated). Must be unique.',
    example: 'northside-hospital',
  })
  @IsString()
  @IsNotEmpty()
  @MinLength(3)
  @MaxLength(64)
  @Matches(/^[a-z0-9]+(?:-[a-z0-9]+)*$/, {
    message:
      'slug must contain only lowercase letters, digits and single hyphens between segments (e.g. "northside-hospital").',
  })
  slug!: string;

  @ApiProperty({
    description: 'Human-readable display name for the organization.',
    example: 'Northside Hospital',
  })
  @IsString()
  @IsNotEmpty()
  @MaxLength(255)
  display_name!: string;

  @ApiPropertyOptional({
    description: 'Registered legal name of the organization.',
    example: 'Northside Hospital Foundation, Inc.',
  })
  @IsOptional()
  @IsString()
  @MaxLength(255)
  legal_name?: string;

  @ApiPropertyOptional({
    description: 'Primary email/web domain used by this organization.',
    example: 'northside.example.org',
  })
  @IsOptional()
  @IsString()
  @MaxLength(255)
  @Matches(/^[a-z0-9.-]+\.[a-z]{2,}$/i, {
    message: 'primary_domain must be a valid domain name (e.g. "orgo.example.org").',
  })
  primary_domain?: string;

  @ApiProperty({
    description: 'Default IANA timezone for this organization.',
    example: 'America/New_York',
  })
  @IsString()
  @IsNotEmpty()
  @MaxLength(100)
  timezone!: string;

  @ApiProperty({
    description: 'Default locale for this organization (IETF language tag, e.g. "en" or "fr-CA").',
    example: 'en',
  })
  @IsString()
  @IsNotEmpty()
  @Matches(/^[a-z]{2}(?:-[A-Z]{2})?$/, {
    message: 'default_locale must look like "en" or "fr-CA".',
  })
  default_locale!: string;

  @ApiPropertyOptional({
    description:
      'Behavioral profile key to attach to this organization (see profiles YAML, e.g. "default", "hospital"). If omitted, the system default profile is used.',
    example: 'default',
  })
  @IsOptional()
  @IsString()
  @MinLength(1)
  @MaxLength(64)
  @Matches(/^[a-z0-9_]+$/, {
    message: 'profile_code must use lowercase letters, digits and underscores only.',
  })
  profile_code?: string;

  @ApiPropertyOptional({
    description:
      'Initial status for the organization. If omitted, it defaults to "active" at the service/persistence layer.',
    enum: ORGANIZATION_STATUS_VALUES,
    example: 'active',
  })
  @IsOptional()
  @IsString()
  @IsIn(ORGANIZATION_STATUS_VALUES)
  status?: OrganizationStatus;
}

===== END apps/api/src/orgo/backbone/organizations/dto/create-organization.dto.ts =====


===== BEGIN apps/api/src/orgo/backbone/organizations/dto/update-organization.dto.ts =====
import { ApiPropertyOptional } from '@nestjs/swagger';
import {
  IsEnum,
  IsFQDN,
  IsLocale,
  IsOptional,
  IsString,
  Matches,
  MaxLength,
} from 'class-validator';

/**
 * JSON-facing representation of organization_status_enum.
 *
 * Canonical DB enum: organization_status_enum = 'active' | 'suspended' | 'archived'
 * JSON uses the same lower-case tokens.
 */
export enum OrganizationStatus {
  Active = 'active',
  Suspended = 'suspended',
  Archived = 'archived',
}

/**
 * DTO for partially updating an Organization.
 *
 * All fields are optional; only provided fields will be updated.
 * To clear nullable fields (legal_name, primary_domain), send them explicitly as null.
 */
export class UpdateOrganizationDto {
  @ApiPropertyOptional({
    description:
      'Short, URL-safe slug used as the stable organization identifier (e.g. in URLs and config).',
    example: 'northside-hospital',
  })
  @IsOptional()
  @IsString()
  @Matches(/^[a-z0-9]+(?:-[a-z0-9]+)*$/, {
    message:
      'slug must be lower-case, alphanumeric, and may contain single hyphens between segments',
  })
  @MaxLength(190)
  slug?: string;

  @ApiPropertyOptional({
    description: 'Human-friendly display name for the organization.',
    example: 'Northside Hospital',
  })
  @IsOptional()
  @IsString()
  @MaxLength(255)
  display_name?: string;

  @ApiPropertyOptional({
    description: 'Registered legal name for the organization (nullable).',
    example: 'Northside Hospital Inc.',
    nullable: true,
  })
  @IsOptional()
  @IsString()
  @MaxLength(255)
  legal_name?: string | null;

  @ApiPropertyOptional({
    description:
      'Primary email/web domain for the organization (nullable). Used for email routing and link generation.',
    example: 'northside.example.org',
    nullable: true,
  })
  @IsOptional()
  @IsFQDN()
  @MaxLength(255)
  primary_domain?: string | null;

  @ApiPropertyOptional({
    description: 'Operational status of the organization.',
    enum: OrganizationStatus,
    example: OrganizationStatus.Active,
  })
  @IsOptional()
  @IsEnum(OrganizationStatus)
  status?: OrganizationStatus;

  @ApiPropertyOptional({
    description: 'Default IANA timezone for the organization.',
    example: 'America/New_York',
  })
  @IsOptional()
  @IsString()
  @MaxLength(100)
  timezone?: string;

  @ApiPropertyOptional({
    description:
      'Default locale (BCP 47) for the organization, e.g. "en", "fr-CA".',
    example: 'en',
  })
  @IsOptional()
  @IsLocale()
  @MaxLength(20)
  default_locale?: string;

  @ApiPropertyOptional({
    description:
      'Behavioral profile code linked to organization_profiles.profile_code (e.g. "default", "hospital", "friend_group").',
    example: 'default',
  })
  @IsOptional()
  @IsString()
  @MaxLength(100)
  profile_code?: string;
}

===== END apps/api/src/orgo/backbone/organizations/dto/update-organization.dto.ts =====


===== BEGIN apps/api/src/orgo/backbone/organizations/organization.controller.ts =====
// apps/api/src/orgo/backbone/organizations/organization.controller.ts

import {
  Body,
  Controller,
  Get,
  Param,
  ParseUUIDPipe,
  Patch,
  Post,
  Query,
} from '@nestjs/common';
import {
  ApiBadRequestResponse,
  ApiCreatedResponse,
  ApiNotFoundResponse,
  ApiOkResponse,
  ApiOperation,
  ApiTags,
} from '@nestjs/swagger';
import { OrganizationService } from './organization.service';
import { CreateOrganizationDto } from './dto/create-organization.dto';
import { UpdateOrganizationDto } from './dto/update-organization.dto';
import { ListOrganizationsQueryDto } from './dto/list-organizations-query.dto';
import { OrganizationResponseDto } from './dto/organization-response.dto';

@ApiTags('organizations')
@Controller('api/v3/organizations')
export class OrganizationController {
  constructor(private readonly organizationService: OrganizationService) {}

  @Get()
  @ApiOperation({
    summary: 'List organizations',
    description:
      'Returns the list of organizations (tenants), optionally filtered by status or search term.',
  })
  @ApiOkResponse({
    description: 'List of organizations.',
    type: OrganizationResponseDto,
    isArray: true,
  })
  async listOrganizations(
    @Query() query: ListOrganizationsQueryDto,
  ): Promise<OrganizationResponseDto[]> {
    return this.organizationService.listOrganizations(query);
  }

  @Get(':id')
  @ApiOperation({
    summary: 'Get a single organization',
    description: 'Returns a single organization by its ID.',
  })
  @ApiOkResponse({
    description: 'The organization matching the given ID.',
    type: OrganizationResponseDto,
  })
  @ApiNotFoundResponse({
    description: 'Organization not found.',
  })
  async getOrganization(
    @Param('id', new ParseUUIDPipe({ version: '4' })) id: string,
  ): Promise<OrganizationResponseDto> {
    return this.organizationService.getOrganizationByIdOrThrow(id);
  }

  @Post()
  @ApiOperation({
    summary: 'Create an organization',
    description:
      'Creates a new organization (tenant) with slug, display name, timezone, locale, status, and optional profile linkage.',
  })
  @ApiCreatedResponse({
    description: 'Organization created successfully.',
    type: OrganizationResponseDto,
  })
  @ApiBadRequestResponse({
    description: 'Validation error while creating the organization.',
  })
  async createOrganization(
    @Body() dto: CreateOrganizationDto,
  ): Promise<OrganizationResponseDto> {
    return this.organizationService.createOrganization(dto);
  }

  @Patch(':id')
  @ApiOperation({
    summary: 'Update an organization',
    description:
      'Updates an existing organization (tenant). Typically used to change display name, status, timezone, locale, or primary domain.',
  })
  @ApiOkResponse({
    description: 'Organization updated successfully.',
    type: OrganizationResponseDto,
  })
  @ApiNotFoundResponse({
    description: 'Organization not found.',
  })
  @ApiBadRequestResponse({
    description: 'Validation error while updating the organization.',
  })
  async updateOrganization(
    @Param('id', new ParseUUIDPipe({ version: '4' })) id: string,
    @Body() dto: UpdateOrganizationDto,
  ): Promise<OrganizationResponseDto> {
    return this.organizationService.updateOrganization(id, dto);
  }
}

===== END apps/api/src/orgo/backbone/organizations/organization.controller.ts =====


===== BEGIN apps/api/src/orgo/backbone/organizations/organization.module.ts =====
// apps/api/src/orgo/backbone/organizations/organization.module.ts

import { Module } from '@nestjs/common';
import { PersistenceModule } from '../../../persistence/persistence.module';
import { LoggerModule } from '../../core/logging/logger.module';
import { OrgoConfigModule } from '../../config/config.module';
import { OrganizationService } from './organization.service';
import { OrganizationController } from './organization.controller';

/**
 * OrganizationModule
 *
 * NestJS module for the multi-tenant backbone "organizations" slice.
 * - Exposes OrganizationService and OrganizationController.
 * - Depends on:
 *   - PersistenceModule (Prisma access to `organizations`, `organization_profiles`, etc.)
 *   - LoggerModule (structured logging / audit)
 *   - OrgoConfigModule (organization profiles, feature flags, global config)
 */
@Module({
  imports: [
    PersistenceModule,
    LoggerModule,
    OrgoConfigModule,
  ],
  controllers: [OrganizationController],
  providers: [OrganizationService],
  exports: [OrganizationService],
})
export class OrganizationModule {}

===== END apps/api/src/orgo/backbone/organizations/organization.module.ts =====


===== BEGIN apps/api/src/orgo/backbone/organizations/organization.service.ts =====
// apps/api/src/orgo/backbone/organizations/organization.service.ts

import {
  BadRequestException,
  ConflictException,
  Injectable,
  Logger,
  NotFoundException,
} from '@nestjs/common';
import { randomUUID } from 'crypto';

import { PrismaService } from '../../../persistence/prisma/prisma.service';
import { LogService } from '../../core/logging/log.service';

export type OrganizationStatus = 'active' | 'suspended' | 'archived';

export interface CreateOrganizationInput {
  slug?: string;
  displayName: string;
  legalName?: string | null;
  primaryDomain?: string | null;
  timezone: string;
  defaultLocale: string;
  /**
   * Profile code from profiles YAML (e.g. "default", "hospital", "advocacy_group").
   * If omitted, defaults to "default".
   */
  profileCode?: string;
  status?: OrganizationStatus;
}

export interface UpdateOrganizationInput {
  slug?: string;
  displayName?: string;
  legalName?: string | null;
  primaryDomain?: string | null;
  timezone?: string;
  defaultLocale?: string;
  /**
   * New profile code to attach to this org. If omitted, existing profile is kept.
   * If explicitly set to null, existing profile is left unchanged (no delete here).
   */
  profileCode?: string | null;
  status?: OrganizationStatus;
}

/**
 * Canonical TS view of an Organization row with its linked profile_code.
 * Maps directly from the `organizations` and `organization_profiles` tables. 
 */
export interface OrganizationWithProfile {
  id: string;
  slug: string;
  displayName: string;
  legalName: string | null;
  primaryDomain: string | null;
  status: OrganizationStatus;
  timezone: string;
  defaultLocale: string;
  profileCode: string | null;
  createdAt: Date;
  updatedAt: Date;
}

/**
 * Internal shape that matches the DB row names (`snake_case`) plus optional `profile_code`
 * when joined with `organization_profiles`. 
 */
interface DbOrganizationRow {
  id: string;
  slug: string;
  display_name: string;
  legal_name: string | null;
  primary_domain: string | null;
  status: OrganizationStatus;
  timezone: string;
  default_locale: string;
  created_at: Date;
  updated_at: Date;
  profile_code?: string | null;
}

@Injectable()
export class OrganizationService {
  private readonly logger = new Logger(OrganizationService.name);

  private static readonly ALLOWED_STATUSES: OrganizationStatus[] = [
    'active',
    'suspended',
    'archived',
  ];

  constructor(
    private readonly prisma: PrismaService,
    private readonly logService: LogService,
  ) {}

  /**
   * Create a new organization (tenant) and attach a single active profile row. 
   */
  async createOrganization(
    input: CreateOrganizationInput,
  ): Promise<OrganizationWithProfile> {
    const displayName = input.displayName?.trim();
    if (!displayName) {
      throw new BadRequestException('displayName is required');
    }

    const timezone = input.timezone?.trim();
    if (!timezone) {
      throw new BadRequestException('timezone is required');
    }

    const defaultLocale = input.defaultLocale?.trim();
    if (!defaultLocale) {
      throw new BadRequestException('defaultLocale is required');
    }

    const slug = this.normalizeSlug(input.slug ?? displayName);
    if (!slug) {
      throw new BadRequestException('Organization slug cannot be empty');
    }

    const status: OrganizationStatus = input.status ?? 'active';
    this.ensureValidStatus(status);

    const profileCode = input.profileCode ?? 'default';

    const organization = await this.prisma.$transaction<OrganizationWithProfile>(
      async (tx) => {
        // Enforce unique slug
        const existing = await tx.$queryRaw<Pick<DbOrganizationRow, 'id'>[]>`
          SELECT id FROM organizations WHERE slug = ${slug} LIMIT 1
        `;
        if (existing.length > 0) {
          throw new ConflictException(
            `Organization slug "${slug}" is already in use`,
          );
        }

        const orgId = randomUUID();
        const profileId = randomUUID();

        const [inserted] = await tx.$queryRaw<DbOrganizationRow[]>`
          INSERT INTO organizations (
            id,
            slug,
            display_name,
            legal_name,
            primary_domain,
            status,
            timezone,
            default_locale
          )
          VALUES (
            ${orgId},
            ${slug},
            ${displayName},
            ${input.legalName ?? null},
            ${input.primaryDomain ?? null},
            ${status},
            ${timezone},
            ${defaultLocale}
          )
          RETURNING
            id,
            slug,
            display_name,
            legal_name,
            primary_domain,
            status,
            timezone,
            default_locale,
            created_at,
            updated_at
        `;

        // Create a single profile row for this org (one active profile per org). :contentReference[oaicite:3]{index=3}
        await tx.$queryRaw`
          INSERT INTO organization_profiles (
            id,
            organization_id,
            profile_code,
            reactivity_profile,
            transparency_profile,
            pattern_sensitivity_profile,
            retention_profile,
            version
          )
          VALUES (
            ${profileId},
            ${orgId},
            ${profileCode},
            '{}'::jsonb,
            '{}'::jsonb,
            '{}'::jsonb,
            '{}'::jsonb,
            1
          )
        `;

        return this.mapOrganizationRow({
          ...inserted,
          profile_code: profileCode,
        });
      },
    );

    this.logService.logEvent({
      category: 'SYSTEM',
      logLevel: 'INFO',
      message: 'Organization created',
      identifier: `organization_id:${organization.id}`,
      metadata: {
        slug: organization.slug,
        profileCode: organization.profileCode,
      },
    });

    this.logger.log(`Created organization "${organization.slug}"`);

    return organization;
  }

  /**
   * Update an existing organization and optionally its attached profile_code. :contentReference[oaicite:4]{index=4}
   */
  async updateOrganization(
    id: string,
    input: UpdateOrganizationInput,
  ): Promise<OrganizationWithProfile> {
    if (!id) {
      throw new BadRequestException('id is required');
    }

    const organization = await this.prisma.$transaction<OrganizationWithProfile>(
      async (tx) => {
        const rows = await tx.$queryRaw<DbOrganizationRow[]>`
          SELECT
            o.id,
            o.slug,
            o.display_name,
            o.legal_name,
            o.primary_domain,
            o.status,
            o.timezone,
            o.default_locale,
            o.created_at,
            o.updated_at,
            op.profile_code
          FROM organizations o
          LEFT JOIN organization_profiles op
            ON op.organization_id = o.id
          WHERE o.id = ${id}
          LIMIT 1
        `;

        if (rows.length === 0) {
          throw new NotFoundException(
            `Organization with id "${id}" not found`,
          );
        }

        const current = rows[0];

        const newSlug =
          input.slug !== undefined
            ? this.normalizeSlug(input.slug)
            : current.slug;

        if (!newSlug) {
          throw new BadRequestException('Organization slug cannot be empty');
        }

        let newStatus: OrganizationStatus = current.status;
        if (input.status) {
          this.ensureValidStatus(input.status);
          newStatus = input.status;
        }

        const newDisplayName =
          input.displayName?.trim() || current.display_name;
        const newLegalName =
          input.legalName !== undefined ? input.legalName : current.legal_name;
        const newPrimaryDomain =
          input.primaryDomain !== undefined
            ? input.primaryDomain
            : current.primary_domain;
        const newTimezone =
          input.timezone?.trim() || current.timezone;
        const newDefaultLocale =
          input.defaultLocale?.trim() || current.default_locale;

        const newProfileCode =
          input.profileCode !== undefined
            ? input.profileCode
            : current.profile_code ?? null;

        // If slug changed, ensure it remains unique
        if (newSlug !== current.slug) {
          const existingSlug = await tx.$queryRaw<
            Pick<DbOrganizationRow, 'id'>[]
          >`
            SELECT id
            FROM organizations
            WHERE slug = ${newSlug}
              AND id <> ${id}
            LIMIT 1
          `;
          if (existingSlug.length > 0) {
            throw new ConflictException(
              `Organization slug "${newSlug}" is already in use`,
            );
          }
        }

        const [updated] = await tx.$queryRaw<DbOrganizationRow[]>`
          UPDATE organizations
          SET
            slug = ${newSlug},
            display_name = ${newDisplayName},
            legal_name = ${newLegalName},
            primary_domain = ${newPrimaryDomain},
            status = ${newStatus},
            timezone = ${newTimezone},
            default_locale = ${newDefaultLocale},
            updated_at = NOW()
          WHERE id = ${id}
          RETURNING
            id,
            slug,
            display_name,
            legal_name,
            primary_domain,
            status,
            timezone,
            default_locale,
            created_at,
            updated_at
        `;

        if (newProfileCode) {
          // Upsert the org's profile row; enforce single profile per org. :contentReference[oaicite:5]{index=5}
          const existingProfile = await tx.$queryRaw<{ id: string }[]>`
            SELECT id
            FROM organization_profiles
            WHERE organization_id = ${id}
            LIMIT 1
          `;

          if (existingProfile.length === 0) {
            const profileId = randomUUID();
            await tx.$queryRaw`
              INSERT INTO organization_profiles (
                id,
                organization_id,
                profile_code,
                reactivity_profile,
                transparency_profile,
                pattern_sensitivity_profile,
                retention_profile,
                version
              )
              VALUES (
                ${profileId},
                ${id},
                ${newProfileCode},
                '{}'::jsonb,
                '{}'::jsonb,
                '{}'::jsonb,
                '{}'::jsonb,
                1
              )
            `;
          } else {
            await tx.$queryRaw`
              UPDATE organization_profiles
              SET
                profile_code = ${newProfileCode},
                version = version + 1,
                updated_at = NOW()
              WHERE organization_id = ${id}
            `;
          }
        }

        return this.mapOrganizationRow({
          ...updated,
          profile_code: newProfileCode ?? current.profile_code ?? null,
        });
      },
    );

    this.logService.logEvent({
      category: 'SYSTEM',
      logLevel: 'INFO',
      message: 'Organization updated',
      identifier: `organization_id:${organization.id}`,
      metadata: {
        slug: organization.slug,
        profileCode: organization.profileCode,
      },
    });

    this.logger.log(`Updated organization "${organization.slug}"`);

    return organization;
  }

  /**
   * Fetch a single organization by id, including its profile_code.
   */
  async getOrganizationById(id: string): Promise<OrganizationWithProfile> {
    if (!id) {
      throw new BadRequestException('id is required');
    }

    const rows = await this.prisma.$queryRaw<DbOrganizationRow[]>`
      SELECT
        o.id,
        o.slug,
        o.display_name,
        o.legal_name,
        o.primary_domain,
        o.status,
        o.timezone,
        o.default_locale,
        o.created_at,
        o.updated_at,
        op.profile_code
      FROM organizations o
      LEFT JOIN organization_profiles op
        ON op.organization_id = o.id
      WHERE o.id = ${id}
      LIMIT 1
    `;

    if (rows.length === 0) {
      throw new NotFoundException(`Organization with id "${id}" not found`);
    }

    return this.mapOrganizationRow(rows[0]);
  }

  /**
   * Fetch a single organization by slug, including its profile_code.
   */
  async getOrganizationBySlug(
    slug: string,
  ): Promise<OrganizationWithProfile> {
    const normalizedSlug = this.normalizeSlug(slug);
    if (!normalizedSlug) {
      throw new BadRequestException('slug cannot be empty');
    }

    const rows = await this.prisma.$queryRaw<DbOrganizationRow[]>`
      SELECT
        o.id,
        o.slug,
        o.display_name,
        o.legal_name,
        o.primary_domain,
        o.status,
        o.timezone,
        o.default_locale,
        o.created_at,
        o.updated_at,
        op.profile_code
      FROM organizations o
      LEFT JOIN organization_profiles op
        ON op.organization_id = o.id
      WHERE o.slug = ${normalizedSlug}
      LIMIT 1
    `;

    if (rows.length === 0) {
      throw new NotFoundException(
        `Organization with slug "${normalizedSlug}" not found`,
      );
    }

    return this.mapOrganizationRow(rows[0]);
  }

  /**
   * List all organizations with their attached profile_code, ordered by display_name.
   */
  async listOrganizations(): Promise<OrganizationWithProfile[]> {
    const rows = await this.prisma.$queryRaw<DbOrganizationRow[]>`
      SELECT
        o.id,
        o.slug,
        o.display_name,
        o.legal_name,
        o.primary_domain,
        o.status,
        o.timezone,
        o.default_locale,
        o.created_at,
        o.updated_at,
        op.profile_code
      FROM organizations o
      LEFT JOIN organization_profiles op
        ON op.organization_id = o.id
      ORDER BY o.display_name ASC
    `;

    return rows.map((row) => this.mapOrganizationRow(row));
  }

  /**
   * Ensure the status value is within `organization_status_enum`. :contentReference[oaicite:6]{index=6}
   */
  private ensureValidStatus(status: OrganizationStatus): void {
    if (!OrganizationService.ALLOWED_STATUSES.includes(status)) {
      throw new BadRequestException(
        `Invalid organization status "${status}" (expected one of: ${OrganizationService.ALLOWED_STATUSES.join(
          ', ',
        )})`,
      );
    }
  }

  /**
   * Normalize a human-entered slug or name into a stable org slug:
   * - lower-case
   * - non-alphanumeric → "-"
   * - trim leading/trailing "-"
   * - max length 63 chars (DNS-ish). :contentReference[oaicite:7]{index=7}
   */
  private normalizeSlug(source: string): string {
    return source
      .trim()
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-+|-+$/g, '')
      .slice(0, 63);
  }

  /**
   * Map a DB row (snake_case) into the canonical TS view (camelCase + profileCode).
   */
  private mapOrganizationRow(row: DbOrganizationRow): OrganizationWithProfile {
    return {
      id: row.id,
      slug: row.slug,
      displayName: row.display_name,
      legalName: row.legal_name,
      primaryDomain: row.primary_domain,
      status: row.status,
      timezone: row.timezone,
      defaultLocale: row.default_locale,
      profileCode: row.profile_code ?? null,
      createdAt: row.created_at,
      updatedAt: row.updated_at,
    };
  }
}

===== END apps/api/src/orgo/backbone/organizations/organization.service.ts =====


===== BEGIN apps/api/src/orgo/backbone/persons/dto/upsert-person-profile.dto.ts =====
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';
import {
  IsUUID,
  IsOptional,
  IsString,
  IsEmail,
  IsEnum,
  MaxLength,
  IsDateString,
} from 'class-validator';

export enum PersonConfidentialityLevel {
  Normal = 'normal',
  Sensitive = 'sensitive',
  HighlySensitive = 'highly_sensitive',
}

export class UpsertPersonProfileDto {
  @ApiPropertyOptional({
    description:
      'Existing person profile ID. Omit when creating a new person; include when updating.',
    format: 'uuid',
  })
  @IsOptional()
  @IsUUID('4')
  id?: string;

  @ApiPropertyOptional({
    description:
      'ID of the linked user account in the same organization, if this person also has a login.',
    format: 'uuid',
  })
  @IsOptional()
  @IsUUID('4')
  linkedUserId?: string;

  @ApiPropertyOptional({
    description:
      'External reference such as a student ID, employee number, or membership code.',
    maxLength: 255,
  })
  @IsOptional()
  @IsString()
  @MaxLength(255)
  externalReference?: string;

  @ApiProperty({
    description: 'Full display name of the person.',
    maxLength: 255,
  })
  @IsString()
  @MaxLength(255)
  fullName!: string;

  @ApiPropertyOptional({
    description:
      'Date of birth in ISO format (YYYY-MM-DD). Must not be in the future (enforced in service layer).',
    type: String,
    format: 'date',
  })
  @IsOptional()
  @IsDateString()
  dateOfBirth?: string;

  @ApiPropertyOptional({
    description: 'Primary contact email address for the person.',
    maxLength: 320,
  })
  @IsOptional()
  @IsEmail()
  @MaxLength(320)
  primaryContactEmail?: string;

  @ApiPropertyOptional({
    description:
      'Primary contact phone number for the person. Format is domain-specific and validated downstream.',
    maxLength: 64,
  })
  @IsOptional()
  @IsString()
  @MaxLength(64)
  primaryContactPhone?: string;

  @ApiPropertyOptional({
    description:
      'Confidentiality level used by visibility rules and guardrails for this person.',
    enum: PersonConfidentialityLevel,
    enumName: 'PersonConfidentialityLevel',
  })
  @IsOptional()
  @IsEnum(PersonConfidentialityLevel)
  confidentialityLevel?: PersonConfidentialityLevel;
}

===== END apps/api/src/orgo/backbone/persons/dto/upsert-person-profile.dto.ts =====


===== BEGIN apps/api/src/orgo/backbone/persons/person-profile.controller.ts =====
import {
  BadRequestException,
  Body,
  Controller,
  DefaultValuePipe,
  Delete,
  Get,
  HttpCode,
  HttpStatus,
  Param,
  ParseIntPipe,
  ParseUUIDPipe,
  Post,
  Put,
  Query,
  Req,
} from '@nestjs/common';
import {
  ApiOperation,
  ApiProperty,
  ApiQuery,
  ApiResponse,
  ApiTags,
} from '@nestjs/swagger';
import {
  IsDateString,
  IsEmail,
  IsEnum,
  IsOptional,
  IsString,
  IsUUID,
  MaxLength,
} from 'class-validator';
import { Request } from 'express';
import { PersonProfileService } from './person-profile.service';

interface RequestWithContext extends Request {
  /**
   * Organization (tenant) identifier injected by auth/multi-tenant middleware.
   */
  organizationId?: string;

  /**
   * Authenticated user identifier injected by auth middleware.
   */
  userId?: string;
}

/**
 * Mirrors the `confidentiality_level` enum on `person_profiles`:
 *   normal | sensitive | highly_sensitive
 * :contentReference[oaicite:0]{index=0}
 */
export enum ConfidentialityLevel {
  NORMAL = 'normal',
  SENSITIVE = 'sensitive',
  HIGHLY_SENSITIVE = 'highly_sensitive',
}

/**
 * Canonical Person Profile representation at the API boundary.
 * Shape is aligned to the `person_profiles` table and Insights dim_persons. 
 */
export class PersonProfileDto {
  @ApiProperty({
    format: 'uuid',
    description: 'Stable person identifier (maps from person_profiles.id).',
  })
  person_id: string;

  @ApiProperty({
    format: 'uuid',
    description: 'Owning organization (tenant) identifier.',
  })
  organization_id: string;

  @ApiProperty({
    required: false,
    format: 'uuid',
    nullable: true,
    description:
      'Linked user account (user_accounts.id) if the person also has a login account.',
  })
  linked_user_id: string | null;

  @ApiProperty({
    required: false,
    nullable: true,
    description: 'External reference, e.g. student ID or employee number.',
  })
  external_reference: string | null;

  @ApiProperty({
    maxLength: 512,
    description: 'Full display name for the person.',
  })
  full_name: string;

  @ApiProperty({
    required: false,
    nullable: true,
    format: 'date',
    description: 'Date of birth (YYYY-MM-DD), if known.',
  })
  date_of_birth: string | null;

  @ApiProperty({
    required: false,
    nullable: true,
    description: 'Primary contact email for this person.',
  })
  primary_contact_email: string | null;

  @ApiProperty({
    required: false,
    nullable: true,
    description: 'Primary contact phone number for this person.',
  })
  primary_contact_phone: string | null;

  @ApiProperty({
    enum: ConfidentialityLevel,
    description:
      'Confidentiality level; used by higher-level visibility and guardrail rules.',
  })
  confidentiality_level: ConfidentialityLevel;

  @ApiProperty({
    format: 'date-time',
    description: 'Creation timestamp (UTC).',
  })
  created_at: string;

  @ApiProperty({
    format: 'date-time',
    description: 'Last update timestamp (UTC).',
  })
  updated_at: string;
}

/**
 * Payload for creating or updating (upserting) a person profile.
 * `person_id` is optional; if provided, the corresponding person will be updated.
 */
export class UpsertPersonProfileDto {
  @ApiProperty({
    required: false,
    format: 'uuid',
    description:
      'Person identifier. If provided, the profile is updated; if omitted, a new profile is created.',
  })
  @IsOptional()
  @IsUUID('4')
  person_id?: string;

  @ApiProperty({
    maxLength: 512,
    description: 'Full display name for the person.',
  })
  @IsString()
  @MaxLength(512)
  full_name: string;

  @ApiProperty({
    required: false,
    nullable: true,
    description: 'External reference, e.g. student ID or employee number.',
  })
  @IsOptional()
  @IsString()
  @MaxLength(255)
  external_reference?: string;

  @ApiProperty({
    required: false,
    nullable: true,
    format: 'date',
    description: 'Date of birth (YYYY-MM-DD), if known.',
  })
  @IsOptional()
  @IsDateString()
  date_of_birth?: string;

  @ApiProperty({
    required: false,
    nullable: true,
    description: 'Primary contact email for this person.',
  })
  @IsOptional()
  @IsEmail()
  @MaxLength(320)
  primary_contact_email?: string;

  @ApiProperty({
    required: false,
    nullable: true,
    description: 'Primary contact phone number for this person.',
  })
  @IsOptional()
  @IsString()
  @MaxLength(64)
  primary_contact_phone?: string;

  @ApiProperty({
    required: false,
    enum: ConfidentialityLevel,
    default: ConfidentialityLevel.NORMAL,
    description: 'Confidentiality level; defaults to normal if omitted.',
  })
  @IsOptional()
  @IsEnum(ConfidentialityLevel)
  confidentiality_level?: ConfidentialityLevel;

  @ApiProperty({
    required: false,
    nullable: true,
    format: 'uuid',
    description:
      'Linked user account (user_accounts.id) if the person also has a login account.',
  })
  @IsOptional()
  @IsUUID('4')
  linked_user_id?: string;
}

/**
 * Paginated list response for person profiles.
 */
export class PersonProfileListResponseDto {
  @ApiProperty({ type: [PersonProfileDto] })
  items: PersonProfileDto[];

  @ApiProperty({
    description: 'Total number of matching person profiles for the current filters.',
  })
  total: number;

  @ApiProperty({
    description: 'Maximum number of items returned in this page.',
  })
  limit: number;

  @ApiProperty({
    description: 'Number of items skipped from the start.',
  })
  offset: number;
}

@ApiTags('persons')
@Controller('persons')
export class PersonProfileController {
  constructor(
    private readonly personProfileService: PersonProfileService,
  ) {}

  @Get()
  @ApiOperation({
    summary: 'List person profiles for the current organization',
    description:
      'Returns a paginated list of person profiles scoped to the requesting organization. Supports optional search and linking filters.',
  })
  @ApiResponse({ status: 200, type: PersonProfileListResponseDto })
  @ApiQuery({
    name: 'search',
    required: false,
    description:
      'Free-text search across full_name, external_reference, primary_contact_email and primary_contact_phone.',
  })
  @ApiQuery({
    name: 'external_reference',
    required: false,
    description: 'Filter by exact external reference (e.g. student ID, employee number).',
  })
  @ApiQuery({
    name: 'linked_user_id',
    required: false,
    description: 'Filter by linked user account ID (user_accounts.id).',
  })
  @ApiQuery({
    name: 'limit',
    required: false,
    description: 'Maximum number of items to return (default 50).',
  })
  @ApiQuery({
    name: 'offset',
    required: false,
    description: 'Number of items to skip from the start (default 0).',
  })
  async listPersonProfiles(
    @Req() req: RequestWithContext,
    @Query('search') search?: string,
    @Query('external_reference') externalReference?: string,
    @Query('linked_user_id') linkedUserId?: string,
    @Query('limit', new DefaultValuePipe(50), ParseIntPipe) limit = 50,
    @Query('offset', new DefaultValuePipe(0), ParseIntPipe) offset = 0,
  ): Promise<PersonProfileListResponseDto> {
    const organizationId = this.getOrganizationIdFromRequest(req);

    return this.personProfileService.listPersonProfiles(organizationId, {
      search,
      externalReference,
      linkedUserId,
      limit,
      offset,
    });
  }

  @Get(':personId')
  @ApiOperation({
    summary: 'Get a single person profile by ID',
  })
  @ApiResponse({ status: 200, type: PersonProfileDto })
  async getPersonProfile(
    @Req() req: RequestWithContext,
    @Param('personId', new ParseUUIDPipe()) personId: string,
  ): Promise<PersonProfileDto> {
    const organizationId = this.getOrganizationIdFromRequest(req);
    return this.personProfileService.getPersonProfile(organizationId, personId);
  }

  @Get('by-external-reference/:externalReference')
  @ApiOperation({
    summary: 'Look up a person profile by external reference',
    description:
      'Convenience endpoint to fetch a person profile by an external reference (e.g. student ID, employee number) within the current organization.',
  })
  @ApiResponse({ status: 200, type: PersonProfileDto })
  async getPersonProfileByExternalReference(
    @Req() req: RequestWithContext,
    @Param('externalReference') externalReference: string,
  ): Promise<PersonProfileDto> {
    const organizationId = this.getOrganizationIdFromRequest(req);
    return this.personProfileService.getPersonProfileByExternalReference(
      organizationId,
      externalReference,
    );
  }

  @Post()
  @HttpCode(HttpStatus.OK)
  @ApiOperation({
    summary: 'Create or update a person profile (upsert)',
    description:
      'If person_id is present in the payload, updates the existing profile (scoped to the current organization). If person_id is omitted, creates a new person profile.',
  })
  @ApiResponse({ status: 200, type: PersonProfileDto })
  async upsertPersonProfile(
    @Req() req: RequestWithContext,
    @Body() payload: UpsertPersonProfileDto,
  ): Promise<PersonProfileDto> {
    const organizationId = this.getOrganizationIdFromRequest(req);
    const actorUserId = this.getUserIdFromRequest(req);

    return this.personProfileService.upsertPersonProfile(
      organizationId,
      payload,
      actorUserId,
    );
  }

  @Put(':personId')
  @ApiOperation({
    summary: 'Update an existing person profile',
    description:
      'Updates an existing person profile identified by the path parameter. The path ID takes precedence over any person_id provided in the body.',
  })
  @ApiResponse({ status: 200, type: PersonProfileDto })
  async updatePersonProfile(
    @Req() req: RequestWithContext,
    @Param('personId', new ParseUUIDPipe()) personId: string,
    @Body() payload: UpsertPersonProfileDto,
  ): Promise<PersonProfileDto> {
    const organizationId = this.getOrganizationIdFromRequest(req);
    const actorUserId = this.getUserIdFromRequest(req);

    const finalPayload: UpsertPersonProfileDto = {
      ...payload,
      person_id: personId,
    };

    return this.personProfileService.upsertPersonProfile(
      organizationId,
      finalPayload,
      actorUserId,
    );
  }

  @Delete(':personId')
  @HttpCode(HttpStatus.NO_CONTENT)
  @ApiOperation({
    summary: 'Delete or anonymise a person profile',
    description:
      'Deletes (or, depending on implementation, anonymises) a person profile within the current organization. Implementations should respect guardrails for sensitive data.',
  })
  @ApiResponse({ status: 204 })
  async deletePersonProfile(
    @Req() req: RequestWithContext,
    @Param('personId', new ParseUUIDPipe()) personId: string,
  ): Promise<void> {
    const organizationId = this.getOrganizationIdFromRequest(req);
    const actorUserId = this.getUserIdFromRequest(req);

    await this.personProfileService.deletePersonProfile(
      organizationId,
      personId,
      actorUserId,
    );
  }

  /**
   * Extracts the organization identifier from the request context.
   * Throws a 400 error if the context is missing.
   */
  private getOrganizationIdFromRequest(req: RequestWithContext): string {
    const organizationId = req.organizationId;
    if (!organizationId) {
      throw new BadRequestException('Missing organization context on request.');
    }
    return organizationId;
  }

  /**
   * Extracts the authenticated user identifier from the request context, if present.
   */
  private getUserIdFromRequest(req: RequestWithContext): string | undefined {
    return req.userId;
  }
}

===== END apps/api/src/orgo/backbone/persons/person-profile.controller.ts =====


===== BEGIN apps/api/src/orgo/backbone/persons/person-profile.module.ts =====
// apps/api/src/orgo/backbone/persons/person-profile.module.ts

import { Module } from '@nestjs/common';
import { PersistenceModule } from '../../../persistence/persistence.module';
import { LoggerModule } from '../../core/logging/logger.module';
import { PersonProfileService } from './person-profile.service';
import { PersonProfileController } from './person-profile.controller';

@Module({
  imports: [
    // Provides Prisma / DB access
    PersistenceModule,
    // Provides structured logging (LogService)
    LoggerModule,
  ],
  controllers: [PersonProfileController],
  providers: [PersonProfileService],
  exports: [PersonProfileService],
})
export class PersonProfileModule {}

===== END apps/api/src/orgo/backbone/persons/person-profile.module.ts =====


===== BEGIN apps/api/src/orgo/backbone/persons/person-profile.service.ts =====
import {
  BadRequestException,
  Injectable,
  Logger,
  NotFoundException,
} from '@nestjs/common';
import { Prisma, PersonProfile } from '@prisma/client';
import { PrismaService } from '../../../persistence/prisma/prisma.service';
import { FN_BACKBONE_PERSON_UPSERT } from '../../core/functional-ids';

export type ConfidentialityLevel = 'normal' | 'sensitive' | 'highly_sensitive';

export interface UpsertPersonProfileInput {
  /**
   * Tenant isolation key – required for all operations.
   */
  organizationId: string;

  /**
   * Optional person ID:
   * - If provided → update this record (after org check).
   * - If omitted → create a new record or reuse by (org, externalReference) if present.
   */
  personId?: string;

  /**
   * Optional link to a user account in the same org.
   * Can be null to explicitly clear the link.
   */
  linkedUserId?: string | null;

  /**
   * Optional external reference (student ID, employee number, etc.).
   * Used as a secondary key for “upsert by external id” when personId is not provided.
   */
  externalReference?: string | null;

  /**
   * Canonical full name for analytics (insights.dim_persons.full_name).
   */
  fullName: string;

  /**
   * Date of birth (ISO date string or Date). Nullable.
   */
  dateOfBirth?: string | Date | null;

  /**
   * Primary contact email. Nullable.
   */
  primaryContactEmail?: string | null;

  /**
   * Primary contact phone. Nullable.
   */
  primaryContactPhone?: string | null;

  /**
   * Confidentiality level, drives visibility/guardrails.
   * Defaults to "normal" when omitted.
   */
  confidentialityLevel?: ConfidentialityLevel;
}

@Injectable()
export class PersonProfileService {
  private readonly logger = new Logger(PersonProfileService.name);

  constructor(private readonly prisma: PrismaService) {}

  /**
   * Create or update a person profile within an organization.
   *
   * Resolution order:
   * 1. If personId is provided → update that record (after verifying organizationId).
   * 2. Else if externalReference is provided → try to find (organizationId, externalReference) and update it.
   * 3. Else → create a new person profile.
   */
  async upsertPersonProfile(input: UpsertPersonProfileInput): Promise<PersonProfile> {
    const { organizationId } = input;

    if (!organizationId) {
      throw new BadRequestException('organizationId is required.');
    }

    if (!input.fullName || !input.fullName.trim()) {
      throw new BadRequestException('fullName is required.');
    }

    const confidentialityLevel: ConfidentialityLevel =
      input.confidentialityLevel ?? 'normal';

    if (!this.isValidConfidentialityLevel(confidentialityLevel)) {
      throw new BadRequestException(
        `Invalid confidentialityLevel "${confidentialityLevel}". Expected one of "normal" | "sensitive" | "highly_sensitive".`,
      );
    }

    const dateOfBirth = this.parseDateOfBirth(input.dateOfBirth);

    const basePayload = {
      organizationId,
      linkedUserId:
        typeof input.linkedUserId === 'undefined' ? undefined : input.linkedUserId,
      externalReference:
        typeof input.externalReference === 'undefined'
          ? undefined
          : input.externalReference,
      fullName: input.fullName.trim(),
      dateOfBirth,
      primaryContactEmail:
        typeof input.primaryContactEmail === 'undefined'
          ? undefined
          : input.primaryContactEmail,
      primaryContactPhone:
        typeof input.primaryContactPhone === 'undefined'
          ? undefined
          : input.primaryContactPhone,
      confidentialityLevel,
    };

    let targetId = input.personId;

    // If no explicit ID, try to resolve by (organizationId, externalReference)
    if (!targetId && input.externalReference) {
      const existingByExternal = await this.prisma.personProfile.findFirst({
        where: {
          organizationId,
          externalReference: input.externalReference,
        },
      });

      if (existingByExternal) {
        targetId = existingByExternal.id;
      }
    }

    // Update existing record
    if (targetId) {
      const existing = await this.prisma.personProfile.findUnique({
        where: { id: targetId },
      });

      if (!existing || existing.organizationId !== organizationId) {
        throw new NotFoundException(
          'PersonProfile not found for the specified organization.',
        );
      }

      this.logger.debug(
        `Updating person profile ${targetId} for org ${organizationId} [${FN_BACKBONE_PERSON_UPSERT}]`,
      );

      const updateData: Prisma.PersonProfileUpdateInput = {
        // Never allow cross-tenant moves – enforce same org id
        organizationId: existing.organizationId,
        ...this.buildUpdatePayload(basePayload),
      };

      return this.prisma.personProfile.update({
        where: { id: targetId },
        data: updateData,
      });
    }

    // Create new record
    this.logger.debug(
      `Creating person profile for org ${organizationId} (external_reference=${input.externalReference ?? 'null'}) [${FN_BACKBONE_PERSON_UPSERT}]`,
    );

    const createData: Prisma.PersonProfileCreateInput = {
      ...this.buildCreatePayload(basePayload),
    };

    return this.prisma.personProfile.create({
      data: createData,
    });
  }

  /**
   * Fetch a single person profile by ID within an organization.
   * Enforces multi-tenant isolation via organizationId.
   */
  async getPersonProfileById(
    organizationId: string,
    personId: string,
  ): Promise<PersonProfile> {
    if (!organizationId) {
      throw new BadRequestException('organizationId is required.');
    }

    if (!personId) {
      throw new BadRequestException('personId is required.');
    }

    const profile = await this.prisma.personProfile.findFirst({
      where: { id: personId, organizationId },
    });

    if (!profile) {
      throw new NotFoundException('PersonProfile not found.');
    }

    return profile;
  }

  /**
   * Fetch a person profile by (organizationId, externalReference).
   * Returns null when no match is found.
   */
  async findPersonProfileByExternalReference(
    organizationId: string,
    externalReference: string,
  ): Promise<PersonProfile | null> {
    if (!organizationId) {
      throw new BadRequestException('organizationId is required.');
    }

    if (!externalReference) {
      throw new BadRequestException('externalReference is required.');
    }

    return this.prisma.personProfile.findFirst({
      where: { organizationId, externalReference },
    });
  }

  /**
   * Lightweight search over person profiles within an organization.
   * - query matches full_name, primary_contact_email, primary_contact_phone (case-insensitive).
   * - externalReference filter optionally narrows the search.
   */
  async searchPersonProfiles(params: {
    organizationId: string;
    query?: string;
    externalReference?: string;
    limit?: number;
  }): Promise<PersonProfile[]> {
    const { organizationId, query, externalReference, limit = 25 } = params;

    if (!organizationId) {
      throw new BadRequestException('organizationId is required.');
    }

    const where: Prisma.PersonProfileWhereInput = {
      organizationId,
    };

    if (externalReference) {
      where.externalReference = {
        contains: externalReference,
        mode: 'insensitive',
      };
    }

    if (query && query.trim().length > 0) {
      const q = query.trim();
      where.OR = [
        { fullName: { contains: q, mode: 'insensitive' } },
        { primaryContactEmail: { contains: q, mode: 'insensitive' } },
        { primaryContactPhone: { contains: q, mode: 'insensitive' } },
      ];
    }

    return this.prisma.personProfile.findMany({
      where,
      take: limit,
      orderBy: { fullName: 'asc' },
    });
  }

  private isValidConfidentialityLevel(
    level: string,
  ): level is ConfidentialityLevel {
    return level === 'normal' || level === 'sensitive' || level === 'highly_sensitive';
  }

  private parseDateOfBirth(
    value: string | Date | null | undefined,
  ): Date | null {
    if (!value) {
      return null;
    }

    if (value instanceof Date) {
      if (Number.isNaN(value.getTime())) {
        throw new BadRequestException('dateOfBirth is invalid.');
      }
      return value;
    }

    const parsed = new Date(value);
    if (Number.isNaN(parsed.getTime())) {
      throw new BadRequestException('dateOfBirth must be a valid ISO date string.');
    }

    return parsed;
  }

  /**
   * Build payload for create operations.
   * Explicitly sets nullable fields to null when not provided.
   */
  private buildCreatePayload(base: {
    organizationId: string;
    linkedUserId?: string | null;
    externalReference?: string | null;
    fullName: string;
    dateOfBirth: Date | null;
    primaryContactEmail?: string | null;
    primaryContactPhone?: string | null;
    confidentialityLevel: ConfidentialityLevel;
  }): Prisma.PersonProfileCreateInput {
    return {
      organizationId: base.organizationId,
      linkedUserId: base.linkedUserId ?? null,
      externalReference: base.externalReference ?? null,
      fullName: base.fullName,
      dateOfBirth: base.dateOfBirth,
      primaryContactEmail: base.primaryContactEmail ?? null,
      primaryContactPhone: base.primaryContactPhone ?? null,
      confidentialityLevel: base.confidentialityLevel,
    };
  }

  /**
   * Build payload for update operations.
   * Uses the same semantics as create (fields not supplied are cleared to null),
   * but does not attempt to change organizationId.
   */
  private buildUpdatePayload(base: {
    organizationId: string;
    linkedUserId?: string | null;
    externalReference?: string | null;
    fullName: string;
    dateOfBirth: Date | null;
    primaryContactEmail?: string | null;
    primaryContactPhone?: string | null;
    confidentialityLevel: ConfidentialityLevel;
  }): Prisma.PersonProfileUpdateInput {
    const data: Prisma.PersonProfileUpdateInput = {
      fullName: base.fullName,
      dateOfBirth: base.dateOfBirth,
      confidentialityLevel: base.confidentialityLevel,
    };

    if (typeof base.linkedUserId !== 'undefined') {
      data.linkedUserId = base.linkedUserId;
    }

    if (typeof base.externalReference !== 'undefined') {
      data.externalReference = base.externalReference;
    }

    if (typeof base.primaryContactEmail !== 'undefined') {
      data.primaryContactEmail = base.primaryContactEmail;
    }

    if (typeof base.primaryContactPhone !== 'undefined') {
      data.primaryContactPhone = base.primaryContactPhone;
    }

    return data;
  }
}

===== END apps/api/src/orgo/backbone/persons/person-profile.service.ts =====


===== BEGIN apps/api/src/orgo/backbone/rbac/dto/assign-permission.dto.ts =====

===== END apps/api/src/orgo/backbone/rbac/dto/assign-permission.dto.ts =====


===== BEGIN apps/api/src/orgo/backbone/rbac/dto/create-role.dto.ts =====
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';
import {
  IsUUID,
  IsString,
  IsNotEmpty,
  IsOptional,
  MaxLength,
  Matches,
} from 'class-validator';

/**
 * DTO for creating a new Role within an organization.
 *
 * Maps to the `roles` table (Doc 1):
 *   - organization_id
 *   - code
 *   - display_name
 *   - description
 *   - is_system_role (implicitly false for API-created roles)
 */
export class CreateRoleDto {
  @ApiProperty({
    description:
      'Organization that owns this role (tenant identifier). For tenant-defined roles this is required.',
    format: 'uuid',
  })
  @IsUUID('4', { message: 'organizationId must be a valid UUID' })
  organizationId: string;

  @ApiProperty({
    description:
      'Stable code for the role, unique within the organization. Lower_snake_case; used in config, logs and routing rules.',
    example: 'ops_maintenance_coordinator',
  })
  @IsString()
  @IsNotEmpty()
  @MaxLength(128)
  @Matches(/^[a-z0-9_]+$/, {
    message:
      'code must use lower_snake_case (lowercase letters, digits, and underscores only)',
  })
  code: string;

  @ApiProperty({
    description: 'Human-readable name for the role.',
    example: 'Maintenance Coordinator',
  })
  @IsString()
  @IsNotEmpty()
  @MaxLength(255)
  displayName: string;

  @ApiPropertyOptional({
    description:
      'Longer free-text description of what this role is responsible for.',
    example: 'Coordinates all maintenance tasks for facilities and equipment.',
  })
  @IsString()
  @IsOptional()
  @MaxLength(2048)
  description?: string;
}

===== END apps/api/src/orgo/backbone/rbac/dto/create-role.dto.ts =====


===== BEGIN apps/api/src/orgo/backbone/rbac/permission.service.ts =====
// apps/api/src/orgo/backbone/rbac/permission.service.ts

import {
  BadRequestException,
  Injectable,
  Logger,
  NotFoundException,
} from '@nestjs/common';
import { Permission, RolePermission } from '@prisma/client';
import { PrismaService } from '../../../persistence/prisma/prisma.service';

/**
 * PermissionService
 *
 * Backbone RBAC helper for managing global permissions and their
 * assignment to roles.
 *
 * Backed by:
 *   - permissions
 *   - roles
 *   - role_permissions
 *
 * This service does NOT make authorization decisions itself; it
 * maintains the Role ↔ Permission mapping used by higher‑level
 * RBAC / auth guards.
 */
@Injectable()
export class PermissionService {
  private readonly logger = new Logger(PermissionService.name);

  constructor(private readonly prisma: PrismaService) {}

  /**
   * Create (or upsert) a global permission code.
   *
   * Codes are stable identifiers like:
   *   - "task.view_sensitive"
   *   - "workflow.edit_rules"
   */
  async createPermission(
    code: string,
    description: string,
  ): Promise<Permission> {
    const normalizedCode = code?.trim();

    if (!normalizedCode) {
      throw new BadRequestException('Permission code is required');
    }

    return this.prisma.permission.upsert({
      where: { code: normalizedCode },
      update: {
        // allow description updates over time
        description: description?.trim() || normalizedCode,
      },
      create: {
        code: normalizedCode,
        description: description?.trim() || normalizedCode,
      },
    });
  }

  /**
   * Fetch a permission by its global code.
   * Returns null if not found.
   */
  async getPermissionByCode(code: string): Promise<Permission | null> {
    const normalizedCode = code?.trim();
    if (!normalizedCode) {
      return null;
    }

    return this.prisma.permission.findUnique({
      where: { code: normalizedCode },
    });
  }

  /**
   * List all permissions (global).
   */
  async listPermissions(): Promise<Permission[]> {
    return this.prisma.permission.findMany({
      orderBy: { code: 'asc' },
    });
  }

  /**
   * Assign a permission to a role (idempotent).
   *
   * - Validates that the role exists.
   * - Validates that the permission code exists.
   * - Creates or reuses a RolePermission row.
   *
   * Returns the assignment including the Permission row.
   */
  async assignPermission(params: {
    roleId: string;
    permissionCode: string;
    grantedByUserId?: string | null;
  }): Promise<RolePermission & { permission: Permission }> {
    const { roleId, permissionCode, grantedByUserId } = params;

    if (!roleId) {
      throw new BadRequestException('roleId is required');
    }
    const normalizedCode = permissionCode?.trim();
    if (!normalizedCode) {
      throw new BadRequestException('permissionCode is required');
    }

    const role = await this.prisma.role.findUnique({
      where: { id: roleId },
    });

    if (!role) {
      throw new NotFoundException(`Role not found for id "${roleId}"`);
    }

    const permission = await this.prisma.permission.findUnique({
      where: { code: normalizedCode },
    });

    if (!permission) {
      throw new NotFoundException(
        `Permission not found for code "${normalizedCode}"`,
      );
    }

    // Idempotent: if already assigned, return existing mapping.
    const existing = await this.prisma.rolePermission.findFirst({
      where: {
        roleId: role.id,
        permissionId: permission.id,
      },
      include: {
        permission: true,
      },
    });

    if (existing) {
      return existing;
    }

    const assignment = await this.prisma.rolePermission.create({
      data: {
        roleId: role.id,
        permissionId: permission.id,
        grantedByUserId: grantedByUserId ?? null,
        grantedAt: new Date(),
      },
      include: {
        permission: true,
      },
    });

    this.logger.log(
      `Assigned permission "${permission.code}" to role "${role.code}" (${role.id})`,
    );

    return assignment;
  }

  /**
   * Revoke a permission from a role (idempotent).
   *
   * Returns:
   *   - true  → an assignment existed and was deleted
   *   - false → nothing to revoke
   */
  async revokePermission(params: {
    roleId: string;
    permissionCode: string;
  }): Promise<boolean> {
    const { roleId, permissionCode } = params;

    if (!roleId) {
      throw new BadRequestException('roleId is required');
    }
    const normalizedCode = permissionCode?.trim();
    if (!normalizedCode) {
      throw new BadRequestException('permissionCode is required');
    }

    const permission = await this.prisma.permission.findUnique({
      where: { code: normalizedCode },
    });

    if (!permission) {
      // Nothing to revoke if the permission itself does not exist.
      return false;
    }

    const existing = await this.prisma.rolePermission.findFirst({
      where: {
        roleId,
        permissionId: permission.id,
      },
    });

    if (!existing) {
      return false;
    }

    await this.prisma.rolePermission.delete({
      where: {
        id: existing.id,
      },
    });

    this.logger.log(
      `Revoked permission "${permission.code}" from role "${roleId}"`,
    );

    return true;
  }

  /**
   * Get Permission entities for a given role.
   */
  async getPermissionsForRole(roleId: string): Promise<Permission[]> {
    if (!roleId) {
      throw new BadRequestException('roleId is required');
    }

    const assignments = await this.prisma.rolePermission.findMany({
      where: { roleId },
      include: {
        permission: true,
      },
      orderBy: {
        // deterministic ordering; safe even without a composite index
        createdAt: 'asc',
      },
    });

    return assignments.map((rp) => rp.permission);
  }

  /**
   * Convenience helper: get only permission codes for a role.
   */
  async getPermissionCodesForRole(roleId: string): Promise<string[]> {
    const permissions = await this.getPermissionsForRole(roleId);
    return permissions.map((p) => p.code);
  }

  /**
   * Resolve effective permission codes for a user within an organization.
   *
   * This walks:
   *   user_role_assignments → roles → role_permissions → permissions
   *
   * Returned codes are de‑duplicated.
   */
  async getEffectivePermissionCodesForUser(params: {
    userId: string;
    organizationId: string;
  }): Promise<string[]> {
    const { userId, organizationId } = params;

    if (!userId) {
      throw new BadRequestException('userId is required');
    }
    if (!organizationId) {
      throw new BadRequestException('organizationId is required');
    }

    // Use a single SQL query via Prisma; relies only on table/column names
    // defined in the Orgo DB schema.
    const rows: Array<{ code: string }> = await this.prisma.$queryRawUnsafe(
      `
      SELECT DISTINCT p.code
      FROM user_role_assignments ura
      JOIN roles r ON ura.role_id = r.id
      JOIN role_permissions rp ON rp.role_id = r.id
      JOIN permissions p ON p.id = rp.permission_id
      WHERE ura.user_id = $1
        AND ura.organization_id = $2
        AND ura.revoked_at IS NULL
    `,
      userId,
      organizationId,
    );

    return rows.map((row) => row.code).sort();
  }
}

===== END apps/api/src/orgo/backbone/rbac/permission.service.ts =====


===== BEGIN apps/api/src/orgo/backbone/rbac/rbac.controller.ts =====
import {
  Body,
  Controller,
  Get,
  Post,
  Patch,
  Delete,
  Param,
  Req,
  UseGuards,
  HttpCode,
  HttpStatus,
} from '@nestjs/common';
import {
  ArrayNotEmpty,
  IsArray,
  IsIn,
  IsNotEmpty,
  IsOptional,
  IsString,
  IsUUID,
} from 'class-validator';
import { AuthGuard } from '../../security/auth.guard';
import { RbacService } from './rbac.service';

/**
 * Auth context attached by AuthGuard.validateAccessToken.
 * See Doc 4 – Authentication & RBAC. :contentReference[oaicite:0]{index=0}
 */
interface AuthenticatedUserContext {
  userId: string;
  organizationId: string;
  roles?: string[];
  permissions?: string[];
}

/**
 * Minimal request shape we rely on; transport (Express/Fastify) is abstracted.
 */
interface AuthenticatedRequest {
  user: AuthenticatedUserContext;
  // Allow other properties without tying to a specific HTTP framework.
  [key: string]: unknown;
}

/**
 * Standard result envelope (aligned with Core Services spec). :contentReference[oaicite:1]{index=1}
 */
export interface StandardResult<T = any> {
  ok: boolean;
  data: T | null;
  error: { code: string; message: string; details?: any } | null;
}

/**
 * DTOs
 */

export class CreateRoleDto {
  @IsString()
  @IsNotEmpty()
  code!: string;

  @IsString()
  @IsNotEmpty()
  displayName!: string;

  @IsString()
  @IsOptional()
  description?: string;
}

export class UpdateRoleDto {
  @IsString()
  @IsOptional()
  displayName?: string;

  @IsString()
  @IsOptional()
  description?: string;
}

/**
 * Atomic permission codes, e.g. "task.view_sensitive", "workflow.edit_rules". :contentReference[oaicite:2]{index=2}
 */
export class AssignPermissionsToRoleDto {
  @IsArray()
  @ArrayNotEmpty()
  @IsString({ each: true })
  permissionCodes!: string[];
}

/**
 * User → Role assignments with optional scope (team, location, etc.). :contentReference[oaicite:3]{index=3}
 */
export class AssignRolesToUserDto {
  @IsArray()
  @ArrayNotEmpty()
  @IsUUID('4', { each: true })
  roleIds!: string[];

  @IsOptional()
  @IsString()
  @IsIn(['global', 'team', 'location', 'unit', 'custom'])
  scopeType?: string;

  @IsOptional()
  @IsString()
  scopeReference?: string;
}

/**
 * Permission check payload: primarily by permission code, with optional
 * resource/action context for audit/troubleshooting. :contentReference[oaicite:4]{index=4}
 */
export class CheckPermissionDto {
  @IsString()
  @IsNotEmpty()
  permissionCode!: string;

  @IsOptional()
  @IsString()
  resource?: string;

  @IsOptional()
  @IsString()
  action?: string;
}

@Controller('rbac')
@UseGuards(AuthGuard)
export class RbacController {
  constructor(private readonly rbacService: RbacService) {}

  /**
   * List roles available in the caller's organization (including any global/system roles
   * that apply to this org). Roles map to the `roles` table in Doc 1. :contentReference[oaicite:5]{index=5}
   */
  @Get('roles')
  async listRoles(@Req() req: AuthenticatedRequest): Promise<StandardResult> {
    const { organizationId } = req.user;
    const roles = await this.rbacService.listRolesForOrganization(organizationId);
    return this.buildOkResult(roles);
  }

  /**
   * Create a new org-scoped Role (roles.organization_id = caller org). :contentReference[oaicite:6]{index=6}
   */
  @Post('roles')
  async createRole(
    @Req() req: AuthenticatedRequest,
    @Body() body: CreateRoleDto,
  ): Promise<StandardResult> {
    const { organizationId, userId } = req.user;
    const role = await this.rbacService.createRole(organizationId, body, userId);
    return this.buildOkResult(role);
  }

  /**
   * Fetch a single Role by id, scoped to the caller's organization (plus any
   * applicable global/system role). :contentReference[oaicite:7]{index=7}
   */
  @Get('roles/:roleId')
  async getRole(
    @Req() req: AuthenticatedRequest,
    @Param('roleId') roleId: string,
  ): Promise<StandardResult> {
    const { organizationId } = req.user;
    const role = await this.rbacService.getRoleById(organizationId, roleId);
    return this.buildOkResult(role);
  }

  /**
   * Update an existing Role's display metadata. System roles and foreign-org
   * roles must be protected inside RbacService. :contentReference[oaicite:8]{index=8}
   */
  @Patch('roles/:roleId')
  async updateRole(
    @Req() req: AuthenticatedRequest,
    @Param('roleId') roleId: string,
    @Body() body: UpdateRoleDto,
  ): Promise<StandardResult> {
    const { organizationId, userId } = req.user;
    const role = await this.rbacService.updateRole(organizationId, roleId, body, userId);
    return this.buildOkResult(role);
  }

  /**
   * Optional hard-delete endpoint for roles. Implementations may treat this as
   * a soft-delete or disallow deletion for system/built-in roles.
   */
  @Delete('roles/:roleId')
  async deleteRole(
    @Req() req: AuthenticatedRequest,
    @Param('roleId') roleId: string,
  ): Promise<StandardResult> {
    const { organizationId, userId } = req.user;
    const result = await this.rbacService.deleteRole(organizationId, roleId, userId);
    return this.buildOkResult(result);
  }

  /**
   * List all defined Permission codes (from the `permissions` table). :contentReference[oaicite:9]{index=9}
   */
  @Get('permissions')
  async listPermissions(): Promise<StandardResult> {
    const permissions = await this.rbacService.listPermissions();
    return this.buildOkResult(permissions);
  }

  /**
   * List Permission codes currently granted to a Role via role_permissions. :contentReference[oaicite:10]{index=10}
   */
  @Get('roles/:roleId/permissions')
  async listRolePermissions(
    @Req() req: AuthenticatedRequest,
    @Param('roleId') roleId: string,
  ): Promise<StandardResult> {
    const { organizationId } = req.user;
    const permissions = await this.rbacService.getPermissionsForRole(organizationId, roleId);
    return this.buildOkResult(permissions);
  }

  /**
   * Grant one or more Permission codes to a Role (insert into role_permissions). :contentReference[oaicite:11]{index=11}
   */
  @Post('roles/:roleId/permissions')
  async assignPermissionsToRole(
    @Req() req: AuthenticatedRequest,
    @Param('roleId') roleId: string,
    @Body() body: AssignPermissionsToRoleDto,
  ): Promise<StandardResult> {
    const { organizationId, userId } = req.user;
    const result = await this.rbacService.assignPermissionsToRole(
      organizationId,
      roleId,
      body.permissionCodes,
      userId,
    );
    return this.buildOkResult(result);
  }

  /**
   * Revoke a Permission from a Role by permission code.
   */
  @Delete('roles/:roleId/permissions/:permissionCode')
  async revokePermissionFromRole(
    @Req() req: AuthenticatedRequest,
    @Param('roleId') roleId: string,
    @Param('permissionCode') permissionCode: string,
  ): Promise<StandardResult> {
    const { organizationId, userId } = req.user;
    const result = await this.rbacService.revokePermissionFromRole(
      organizationId,
      roleId,
      permissionCode,
      userId,
    );
    return this.buildOkResult(result);
  }

  /**
   * List roles currently assigned to a user within the caller's organization,
   * including scope information from user_role_assignments. :contentReference[oaicite:12]{index=12}
   */
  @Get('users/:userId/roles')
  async listUserRoles(
    @Req() req: AuthenticatedRequest,
    @Param('userId') userId: string,
  ): Promise<StandardResult> {
    const { organizationId } = req.user;
    const roles = await this.rbacService.getRolesForUser(organizationId, userId);
    return this.buildOkResult(roles);
  }

  /**
   * Assign one or more Roles to a user in the caller's organization, with an
   * optional scope (team/location/unit/custom). :contentReference[oaicite:13]{index=13}
   */
  @Post('users/:userId/roles')
  async assignRolesToUser(
    @Req() req: AuthenticatedRequest,
    @Param('userId') userId: string,
    @Body() body: AssignRolesToUserDto,
  ): Promise<StandardResult> {
    const { organizationId, userId: actorUserId } = req.user;
    const result = await this.rbacService.assignRolesToUser(
      organizationId,
      userId,
      body.roleIds,
      body.scopeType,
      body.scopeReference,
      actorUserId,
    );
    return this.buildOkResult(result);
  }

  /**
   * Revoke a specific Role from a user in the caller's organization.
   */
  @Delete('users/:userId/roles/:roleId')
  async revokeRoleFromUser(
    @Req() req: AuthenticatedRequest,
    @Param('userId') userId: string,
    @Param('roleId') roleId: string,
  ): Promise<StandardResult> {
    const { organizationId, userId: actorUserId } = req.user;
    const result = await this.rbacService.revokeRoleFromUser(
      organizationId,
      userId,
      roleId,
      actorUserId,
    );
    return this.buildOkResult(result);
  }

  /**
   * Return the current caller's effective access profile: roles and permission
   * codes derived from roles + scopes + org/profile guardrails. :contentReference[oaicite:14]{index=14}
   */
  @Get('me')
  async getCurrentUserAccessProfile(
    @Req() req: AuthenticatedRequest,
  ): Promise<StandardResult> {
    const { organizationId, userId } = req.user;
    const roles = await this.rbacService.getRolesForUser(organizationId, userId);
    const permissions =
      await this.rbacService.getEffectivePermissionsForUser(organizationId, userId);

    return this.buildOkResult({
      organization_id: organizationId,
      user_id: userId,
      roles,
      permissions,
    });
  }

  /**
   * Check whether the current caller has a given permission. This is primarily
   * an introspection endpoint; actual enforcement should happen inside guards
   * and services via RbacService.checkPermission. :contentReference[oaicite:15]{index=15}
   */
  @Post('check')
  @HttpCode(HttpStatus.OK)
  async checkPermission(
    @Req() req: AuthenticatedRequest,
    @Body() body: CheckPermissionDto,
  ): Promise<StandardResult<{ allowed: boolean }>> {
    const { organizationId, userId } = req.user;

    const allowed = await this.rbacService.checkPermissionForUser({
      organizationId,
      userId,
      permissionCode: body.permissionCode,
      resource: body.resource,
      action: body.action,
    });

    return this.buildOkResult({ allowed });
  }

  /**
   * Helper to construct the standard { ok, data, error } envelope.
   */
  private buildOkResult<T>(data: T): StandardResult<T> {
    return {
      ok: true,
      data,
      error: null,
    };
  }
}

===== END apps/api/src/orgo/backbone/rbac/rbac.controller.ts =====


===== BEGIN apps/api/src/orgo/backbone/rbac/rbac.module.ts =====
import { Global, Module } from '@nestjs/common';
import { RbacService } from './rbac.service';
import { RoleService } from './role.service';
import { PermissionService } from './permission.service';
import { UserRoleAssignmentService } from './user-role-assignment.service';

/**
 * Orgo v3 RBAC backbone module.
 *
 * This module groups all RBAC-related services so they can be injected
 * across the application:
 *
 * - RoleService: CRUD and management for roles (backed by `roles`).
 * - PermissionService: CRUD and assignment helpers for permissions
 *   (backed by `permissions` and `role_permissions`).
 * - UserRoleAssignmentService: management of user-role bindings
 *   (backed by `user_role_assignments`).
 * - RbacService: cross-cutting permission checks used by guards and
 *   other services (`RbacService.checkPermission`, etc.).
 *
 * It is marked as @Global so that importing RbacModule once (e.g. in
 * AppModule or BackboneModule) makes these providers available
 * everywhere without repeated imports.
 */
@Global()
@Module({
  providers: [
    RbacService,
    RoleService,
    PermissionService,
    UserRoleAssignmentService,
  ],
  exports: [
    RbacService,
    RoleService,
    PermissionService,
    UserRoleAssignmentService,
  ],
})
export class RbacModule {}

===== END apps/api/src/orgo/backbone/rbac/rbac.module.ts =====


===== BEGIN apps/api/src/orgo/backbone/rbac/role.service.ts =====
import {
  Injectable,
  BadRequestException,
  ConflictException,
  NotFoundException,
} from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { In, Not, Repository } from 'typeorm';

import { Role } from './role.entity';
import { Permission } from './permission.entity';
import { CreateRoleDto } from './dto/create-role.dto';
import { UpdateRoleDto } from './dto/update-role.dto';

@Injectable()
export class RoleService {
  constructor(
    @InjectRepository(Role)
    private readonly roleRepository: Repository<Role>,
    @InjectRepository(Permission)
    private readonly permissionRepository: Repository<Permission>,
  ) {}

  /**
   * Returns all roles, including their permissions, ordered by name.
   */
  async findAll(): Promise<Role[]> {
    return this.roleRepository.find({
      relations: { permissions: true },
      order: { name: 'ASC' },
    });
  }

  /**
   * Returns a single role by id or throws if it does not exist.
   */
  async findById(id: string): Promise<Role> {
    return this.getRoleOrThrow(id);
  }

  /**
   * Returns a single role by slug, or null if it does not exist.
   */
  async findBySlug(slug: string): Promise<Role | null> {
    return this.roleRepository.findOne({
      where: { slug },
      relations: { permissions: true },
    });
  }

  /**
   * Creates a new role.
   *
   * - Ensures the slug is unique.
   * - Optionally derives slug from the name if not provided.
   * - Optionally attaches a set of permissions.
   */
  async create(input: CreateRoleDto): Promise<Role> {
    const slug = input.slug
      ? this.normalizeSlug(input.slug)
      : this.slugify(input.name);

    await this.ensureSlugIsUnique(slug);

    const role = this.roleRepository.create({
      name: input.name,
      slug,
      description: input.description ?? null,
    });

    await this.applyPermissions(role, input.permissionIds);

    return this.roleRepository.save(role);
  }

  /**
   * Updates an existing role.
   *
   * - Throws if the role does not exist.
   * - Ensures new slug (if provided and changed) is unique.
   * - Optionally updates permissions.
   */
  async update(id: string, input: UpdateRoleDto): Promise<Role> {
    const role = await this.getRoleOrThrow(id);

    if (typeof input.name === 'string') {
      role.name = input.name;
    }

    if (typeof input.description === 'string' || input.description === null) {
      role.description = input.description;
    }

    if (
      typeof input.slug === 'string' &&
      input.slug.trim() !== '' &&
      input.slug !== role.slug
    ) {
      const slug = this.normalizeSlug(input.slug);
      await this.ensureSlugIsUnique(slug, role.id);
      role.slug = slug;
    }

    await this.applyPermissions(role, input.permissionIds);

    return this.roleRepository.save(role);
  }

  /**
   * Deletes a role permanently.
   *
   * Throws if the role does not exist.
   */
  async remove(id: string): Promise<void> {
    const role = await this.getRoleOrThrow(id);
    await this.roleRepository.remove(role);
  }

  /**
   * Replaces the full permission set for a role.
   *
   * This is a convenience wrapper over `update` that only deals with permissions.
   */
  async updatePermissions(
    roleId: string,
    permissionIds: string[],
  ): Promise<Role> {
    const role = await this.getRoleOrThrow(roleId);
    await this.applyPermissions(role, permissionIds);
    return this.roleRepository.save(role);
  }

  /**
   * Internal helper to fetch a role or throw a NotFoundException.
   */
  private async getRoleOrThrow(id: string): Promise<Role> {
    const role = await this.roleRepository.findOne({
      where: { id },
      relations: { permissions: true },
    });

    if (!role) {
      throw new NotFoundException(`Role with id "${id}" not found.`);
    }

    return role;
  }

  /**
   * Ensures the slug is unique across all roles.
   *
   * If ignoreRoleId is provided, that role will be excluded from the uniqueness check
   * (useful when updating an existing role).
   */
  private async ensureSlugIsUnique(
    slug: string,
    ignoreRoleId?: string,
  ): Promise<void> {
    const where = ignoreRoleId ? { slug, id: Not(ignoreRoleId) } : { slug };

    const existing = await this.roleRepository.findOne({ where });

    if (existing) {
      throw new ConflictException(`Role with slug "${slug}" already exists.`);
    }
  }

  /**
   * Applies the given permission ids to the provided role instance.
   *
   * If permissionIds is:
   * - undefined: do nothing (keep existing permissions).
   * - []: clear all permissions.
   * - non-empty array: replace with the given set, validating that all exist.
   */
  private async applyPermissions(
    role: Role,
    permissionIds?: string[] | null,
  ): Promise<void> {
    if (permissionIds === undefined) {
      return;
    }

    if (!permissionIds || permissionIds.length === 0) {
      role.permissions = [];
      return;
    }

    const permissions = await this.permissionRepository.find({
      where: { id: In(permissionIds) },
    });

    const foundIds = new Set(permissions.map((p) => p.id));
    const missing = permissionIds.filter((id) => !foundIds.has(id));

    if (missing.length > 0) {
      throw new BadRequestException(
        `Unknown permission id(s): ${missing.join(', ')}`,
      );
    }

    role.permissions = permissions;
  }

  /**
   * Normalizes a user-provided slug string.
   */
  private normalizeSlug(slug: string): string {
    const normalized = slug.trim().toLowerCase();
    if (!normalized) {
      throw new BadRequestException('Slug cannot be empty.');
    }
    return normalized.replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
  }

  /**
   * Generates a slug from a role name.
   */
  private slugify(name: string): string {
    if (!name || !name.trim()) {
      throw new BadRequestException(
        'Role name is required to generate a slug.',
      );
    }

    return name
      .normalize('NFKD')
      .replace(/[\u0300-\u036F]/g, '')
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-+|-+$/g, '')
      .replace(/-{2,}/g, '-');
  }
}

===== END apps/api/src/orgo/backbone/rbac/role.service.ts =====


===== BEGIN apps/api/src/orgo/config/config.controller.ts =====
import {
  Body,
  Controller,
  Get,
  Param,
  Post,
  Put,
  Query,
} from '@nestjs/common';
import { ApiOperation, ApiParam, ApiQuery, ApiTags } from '@nestjs/swagger';

import { ConfigService } from './config.service';
import { OrgProfileService } from './org-profile.service';
import { FeatureFlagService } from './feature-flag.service';

/**
 * Standard result shape used by core services (Doc 5).
 * Controllers generally just pass this through to the client.
 */
export interface StandardResult<T = any> {
  ok: boolean;
  data: T | null;
  error: {
    code: string;
    message: string;
    details?: any;
  } | null;
}

/**
 * Global configuration request for GET /config.
 * All fields are optional; the service is expected to apply defaults.
 */
export interface GetGlobalConfigOptions {
  organizationId?: string;
  environment?: 'dev' | 'staging' | 'prod' | 'offline';
  /**
   * Optional list of module identifiers whose config should be included.
   * Example: ["core", "insights", "maintenance"].
   */
  modules?: string[];
}

/**
 * Payload for updating a slice of service configuration.
 * This is intentionally generic; concrete validation lives in ConfigService.
 */
export interface UpdateServiceConfigRequest {
  /**
   * Optional organization scope; when omitted, applies to global/default config.
   */
  organizationId?: string;

  /**
   * Optional environment scope; must be one of the canonical ENVIRONMENT values (Doc 2).
   */
  environment?: 'dev' | 'staging' | 'prod' | 'offline';

  /**
   * Logical module or service identifier, e.g. "core", "email", "logging", "insights".
   */
  module: string;

  /**
   * Arbitrary config patch for the module. The service is responsible
   * for schema validation and for writing to parameter_overrides / YAML.
   */
  changes: Record<string, unknown>;

  /**
   * Optional free‑form description for audit logs.
   */
  reason?: string;
}

/**
 * Payload for importing a full configuration bundle (YAML/JSON).
 */
export interface ImportConfigBundleRequest {
  /**
   * The raw bundle. For JSON imports this will be an object; for YAML
   * you can send the YAML as a string and let ConfigService parse it.
   */
  bundle: string | Record<string, unknown>;

  /**
   * Optional hint for parser selection.
   */
  format?: 'yaml' | 'json';

  /**
   * When true, validate and compute the impact but do not persist.
   */
  dryRun?: boolean;

  /**
   * Optional environment this bundle targets.
   */
  environment?: 'dev' | 'staging' | 'prod' | 'offline';

  /**
   * Optional organization scope for org‑specific bundles.
   */
  organizationId?: string;

  /**
   * Optional human‑readable description for audit trail.
   */
  reason?: string;
}

/**
 * Payload for previewing the impact of an organization profile change.
 * This is used by the Profile configuration screen (Admin UI).
 */
export interface PreviewOrgProfileRequest {
  /**
   * Target profile code, e.g. "friend_group", "hospital", "advocacy_group".
   * Must correspond to a profile defined in the profiles YAML (Doc 7).
   */
  profileCode: string;

  /**
   * Optional fine‑grained overrides on top of the base profile.
   * The exact structure maps to the profiles YAML schema.
   */
  overrides?: Record<string, unknown>;
}

/**
 * Payload for toggling a feature flag.
 */
export interface SetFeatureFlagRequest {
  /**
   * Optional organization scope; when omitted, applies as a global flag.
   */
  organizationId?: string;

  /**
   * Whether the feature is enabled.
   */
  enabled: boolean;

  /**
   * Optional rollout strategy descriptor (JSONB column in DB),
   * e.g. percentage rollout, role filters, etc.
   */
  rolloutStrategy?: Record<string, unknown>;
}

/**
 * Options for listing feature flags.
 */
export interface ListFeatureFlagsOptions {
  organizationId?: string;
}

/**
 * Admin / configuration controller exposing:
 * - Global configuration (ConfigService)
 * - Organization profiles (OrgProfileService)
 * - Feature flags (FeatureFlagService)
 *
 * Route prefix aligns with the /api/v3 namespace used for other controllers.
 */
@ApiTags('config')
@Controller('api/v3/config')
export class ConfigController {
  constructor(
    private readonly configService: ConfigService,
    private readonly orgProfileService: OrgProfileService,
    private readonly featureFlagService: FeatureFlagService,
  ) {}

  // ---------------------------------------------------------------------------
  // Global configuration
  // ---------------------------------------------------------------------------

  @Get()
  @ApiOperation({
    summary: 'Fetch merged global configuration',
    description:
      'Returns merged base + environment + organization configuration, ' +
      'optionally filtered by module list.',
  })
  @ApiQuery({
    name: 'organizationId',
    required: false,
    description:
      'Optional organization scope; when omitted, returns defaults/global config.',
  })
  @ApiQuery({
    name: 'environment',
    required: false,
    description:
      'Optional environment; one of dev, staging, prod, offline. ' +
      'If omitted, the deployment default is used.',
  })
  @ApiQuery({
    name: 'modules',
    required: false,
    description:
      'Comma‑separated list of module identifiers (e.g. "core,insights,maintenance").',
  })
  async getGlobalConfig(
    @Query('organizationId') organizationId?: string,
    @Query('environment') environment?: string,
    @Query('modules') modules?: string,
  ): Promise<StandardResult> {
    const opts: GetGlobalConfigOptions = {
      organizationId: organizationId || undefined,
      environment:
        (environment as GetGlobalConfigOptions['environment']) || undefined,
      modules: modules
        ? modules
            .split(',')
            .map((m) => m.trim())
            .filter(Boolean)
        : undefined,
    };

    return this.configService.getGlobalConfig(opts);
  }

  @Put()
  @ApiOperation({
    summary: 'Update service configuration',
    description:
      'Applies a configuration patch for a given module/environment/org scope. ' +
      'Changes are validated and audited by ConfigService.',
  })
  async updateServiceConfig(
    @Body() body: UpdateServiceConfigRequest,
  ): Promise<StandardResult> {
    return this.configService.updateServiceConfig(body);
  }

  @Post('import-bundle')
  @ApiOperation({
    summary: 'Import configuration bundle',
    description:
      'Imports a YAML/JSON bundle (including profiles and insights settings). ' +
      'Validation and atomic activation are handled by ConfigService.',
  })
  async importConfigBundle(
    @Body() body: ImportConfigBundleRequest,
  ): Promise<StandardResult> {
    return this.configService.importConfigBundle(body);
  }

  // ---------------------------------------------------------------------------
  // Organization profiles
  // ---------------------------------------------------------------------------

  @Get('org-profiles/:organizationId')
  @ApiOperation({
    summary: 'Load organization profile',
    description:
      'Returns the active behavioral profile for the given organization, ' +
      'including reactivity, transparency, pattern sensitivity and retention settings.',
  })
  @ApiParam({
    name: 'organizationId',
    description: 'Organization identifier (UUID or slug, depending on setup).',
  })
  @ApiQuery({
    name: 'includeDerivedDefaults',
    required: false,
    description:
      'When "true", includes derived defaults for tasks/cases/escalations in the response.',
  })
  async getOrganizationProfile(
    @Param('organizationId') organizationId: string,
    @Query('includeDerivedDefaults') includeDerivedDefaults?: string,
  ): Promise<StandardResult> {
    const includeDerived =
      typeof includeDerivedDefaults === 'string' &&
      includeDerivedDefaults.toLowerCase() === 'true';

    return this.orgProfileService.loadProfile(organizationId, {
      includeDerivedDefaults: includeDerived,
    });
  }

  @Post('org-profiles/:organizationId/preview')
  @ApiOperation({
    summary: 'Preview impact of profile changes',
    description:
      'Simulates profile changes and returns their impact on escalation timings, ' +
      'notification scope, retention and insights pattern sensitivity.',
  })
  @ApiParam({
    name: 'organizationId',
    description: 'Organization identifier (UUID or slug, depending on setup).',
  })
  async previewOrganizationProfile(
    @Param('organizationId') organizationId: string,
    @Body() body: PreviewOrgProfileRequest,
  ): Promise<StandardResult> {
    return this.orgProfileService.previewProfileDiff(organizationId, body);
  }

  // ---------------------------------------------------------------------------
  // Feature flags
  // ---------------------------------------------------------------------------

  @Get('feature-flags')
  @ApiOperation({
    summary: 'List feature flags',
    description:
      'Lists feature flags, optionally scoped to a specific organization.',
  })
  @ApiQuery({
    name: 'organizationId',
    required: false,
    description:
      'Organization identifier; when omitted, returns global feature flags.',
  })
  async listFeatureFlags(
    @Query('organizationId') organizationId?: string,
  ): Promise<StandardResult> {
    const options: ListFeatureFlagsOptions = {
      organizationId: organizationId || undefined,
    };

    return this.featureFlagService.listFlags(options);
  }

  @Post('feature-flags/:code')
  @ApiOperation({
    summary: 'Toggle a feature flag',
    description:
      'Enables or disables a feature flag, optionally scoped to an organization, ' +
      'and records rollout strategy metadata.',
  })
  @ApiParam({
    name: 'code',
    description:
      'Feature flag code (e.g. "insights_cyclic_reviews_v2", "maintenance_module_v3").',
  })
  async setFeatureFlag(
    @Param('code') code: string,
    @Body() body: SetFeatureFlagRequest,
  ): Promise<StandardResult> {
    return this.featureFlagService.setFlag({
      code,
      organizationId: body.organizationId,
      enabled: body.enabled,
      rolloutStrategy: body.rolloutStrategy,
    });
  }
}

===== END apps/api/src/orgo/config/config.controller.ts =====


===== BEGIN apps/api/src/orgo/config/config.module.ts =====
import { Global, Module } from '@nestjs/common';
import { PersistenceModule } from '../../persistence/persistence.module';
import { ConfigService } from './config.service';
import { OrgProfileService } from './org-profile.service';
import { FeatureFlagService } from './feature-flag.service';

/**
 * Orgo configuration & profiles module.
 *
 * Responsibilities:
 * - Expose ConfigService for merged global/org configuration
 *   (parameter_overrides + YAML/service configs).
 * - Expose OrgProfileService for loading/applying organization profiles.
 * - Expose FeatureFlagService for feature flag toggles.
 *
 * Marked as @Global so these services can be injected anywhere
 * without re-importing the module in every feature module.
 */
@Global()
@Module({
  imports: [PersistenceModule],
  providers: [ConfigService, OrgProfileService, FeatureFlagService],
  exports: [ConfigService, OrgProfileService, FeatureFlagService],
})
export class OrgoConfigModule {}

===== END apps/api/src/orgo/config/config.module.ts =====


===== BEGIN apps/api/src/orgo/config/config.service.ts =====
import { Injectable, Logger } from '@nestjs/common';
import { ConfigService as NestConfigService } from '@nestjs/config';
import * as fs from 'fs';
import * as path from 'path';
import * as yaml from 'js-yaml';

export type OrgoEnvironment = 'dev' | 'staging' | 'prod' | 'offline';

export interface ConfigMetadata {
  config_name: string;
  version: string;
  environment: OrgoEnvironment;
  last_updated: string;
  owner?: string;
  organization_id?: string;
}

export interface BaseConfig {
  metadata?: ConfigMetadata;
  // Allow arbitrary additional keys – each config file defines its own subtree.
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  [key: string]: any;
}

/**
 * Database config (database_connection.yaml)
 * Shape aligned with Doc 5 Core Services specification. :contentReference[oaicite:0]{index=0}
 */
export interface DatabasePoolConfig {
  min_connections?: number;
  max_connections?: number;
  idle_timeout_seconds?: number;
}

export interface PostgresDatabaseConfig {
  enabled?: boolean;
  url_env?: string;
  host?: string;
  port?: number;
  database?: string;
  schema?: string;
  user_env?: string;
  password_env?: string;
  pool?: DatabasePoolConfig;
}

export interface SqliteDatabaseConfig {
  enabled?: boolean;
  file_path?: string;
  timeout_seconds?: number;
}

export interface DatabaseConfig extends BaseConfig {
  postgres?: PostgresDatabaseConfig;
  sqlite?: SqliteDatabaseConfig;
}

/**
 * Email config (email_config.yaml) :contentReference[oaicite:1]{index=1}
 */
export interface SmtpConfig {
  host?: string;
  port?: number;
  use_tls?: boolean;
  use_ssl?: boolean;
  username_env?: string;
  password_env?: string;
  connection_timeout_secs?: number;
  send_timeout_secs?: number;
  max_retries?: number;
  retry_backoff_secs?: number;
}

export interface ImapConfig {
  host?: string;
  port?: number;
  use_ssl?: boolean;
  username_env?: string;
  password_env?: string;
  connection_timeout_secs?: number;
  read_timeout_secs?: number;
  folder?: string;
}

export interface EmailLimitsConfig {
  max_email_size_mb?: number;
  allowed_attachment_mimetypes?: string[];
}

export interface EmailConfig extends BaseConfig {
  smtp?: SmtpConfig;
  imap?: ImapConfig;
  limits?: EmailLimitsConfig;
}

/**
 * Logging config (logging_config.yaml) :contentReference[oaicite:2]{index=2}
 */
export type LogLevel = 'DEBUG' | 'INFO' | 'WARNING' | 'ERROR' | 'CRITICAL';
export type LogCategory =
  | 'WORKFLOW'
  | 'TASK'
  | 'SYSTEM'
  | 'SECURITY'
  | 'EMAIL';

export interface LoggingRootConfig {
  level?: LogLevel;
  format?: 'json' | 'text';
  log_dir?: string;
}

export interface LoggingCategoryConfig {
  file?: string;
  retention_days?: number;
  rotation?: 'daily' | 'weekly' | 'size';
  max_file_size_mb?: number;
}

export interface LoggingConfig extends BaseConfig {
  logging?: LoggingRootConfig;
  categories?: Partial<Record<LogCategory | string, LoggingCategoryConfig>>;
}

/**
 * Notification config (notification_config.yaml) :contentReference[oaicite:3]{index=3}
 */
export type NotificationChannel = 'EMAIL' | 'SMS' | 'IN_APP' | 'WEBHOOK';

export interface NotificationChannelsConfig {
  email?: {
    enabled?: boolean;
    sender_name?: string;
    sender_address?: string;
  };
  in_app?: {
    enabled?: boolean;
  };
  sms?: {
    enabled?: boolean;
  };
  webhook?: {
    enabled?: boolean;
  };
}

export interface NotificationTemplatesConfig {
  task_created?: string;
  task_assignment?: string;
  task_escalation?: string;
  task_completed?: string;
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  [templateId: string]: any;
}

export interface NotificationConfig extends BaseConfig {
  notifications?: {
    default_channel?: NotificationChannel;
    channels?: NotificationChannelsConfig;
    templates?: NotificationTemplatesConfig;
  };
}

/**
 * Insights config (config.yaml – wrapper around `insights:` subtree). :contentReference[oaicite:4]{index=4}
 */
// eslint-disable-next-line @typescript-eslint/no-explicit-any
export interface InsightsConfig extends BaseConfig {
  insights?: any;
}

/**
 * Profiles YAML (organization_profiles.yaml – top-level `profiles:` map). :contentReference[oaicite:5]{index=5}
 */
// eslint-disable-next-line @typescript-eslint/no-explicit-any
export interface ProfilesConfig {
  profiles: Record<string, any>;
}

export interface GlobalConfigSnapshot {
  environment: OrgoEnvironment;
  configBasePath: string;
  database: DatabaseConfig | null;
  email: EmailConfig | null;
  logging: LoggingConfig | null;
  notifications: NotificationConfig | null;
  insights: InsightsConfig | null;
  profiles: ProfilesConfig | null;
}

export class ConfigValidationError extends Error {
  constructor(message: string, public readonly filePath?: string) {
    super(filePath ? `${message} (config file: ${filePath})` : message);
  }
}

@Injectable()
export class ConfigService {
  private readonly logger = new Logger(ConfigService.name);

  private readonly env: OrgoEnvironment;
  private readonly basePath: string;

  private readonly cache = new Map<string, BaseConfig>();

  private static readonly VALID_ENVIRONMENTS: OrgoEnvironment[] = [
    'dev',
    'staging',
    'prod',
    'offline',
  ];

  private static readonly VALID_LOG_LEVELS: LogLevel[] = [
    'DEBUG',
    'INFO',
    'WARNING',
    'ERROR',
    'CRITICAL',
  ];

  private static readonly VALID_LOG_CATEGORIES: LogCategory[] = [
    'WORKFLOW',
    'TASK',
    'SYSTEM',
    'SECURITY',
    'EMAIL',
  ];

  private static readonly VALID_NOTIFICATION_CHANNELS: NotificationChannel[] =
    ['EMAIL', 'SMS', 'IN_APP', 'WEBHOOK'];

  constructor(private readonly nestConfig: NestConfigService) {
    this.env = this.resolveEnvironment();
    this.basePath = this.resolveBasePath();

    this.logger.log(
      `Initialising Orgo ConfigService (env="${this.env}", basePath="${this.basePath}")`,
    );

    // Validate core configs eagerly so the app fails fast on misconfiguration.
    this.ensureCoreConfigsLoaded();
  }

  /**
   * Returns the canonical Orgo environment inferred from env vars.
   */
  getEnvironment(): OrgoEnvironment {
    return this.env;
  }

  /**
   * Returns the absolute base path where Orgo YAML configs are expected.
   */
  getConfigBasePath(): string {
    return this.basePath;
  }

  /**
   * Returns a merged view of key Orgo configuration slices.
   */
  getGlobalConfig(): GlobalConfigSnapshot {
    return {
      environment: this.env,
      configBasePath: this.basePath,
      database: this.getDatabaseConfig(false),
      email: this.getEmailConfig(false),
      logging: this.getLoggingConfig(false),
      notifications: this.getNotificationConfig(false),
      insights: this.getInsightsConfig(false),
      profiles: this.getProfilesConfig(false),
    };
  }

  /**
   * Load and validate database_connection.yaml.
   */
  getDatabaseConfig(required = true): DatabaseConfig | null {
    const config = this.loadYamlFile<DatabaseConfig>(
      'database/database_connection.yaml',
      { required, validateMetadata: true },
    );
    if (!config) {
      return null;
    }
    this.validateDatabaseConfig(config, 'database/database_connection.yaml');
    return config;
  }

  /**
   * Load and validate email_config.yaml.
   */
  getEmailConfig(required = true): EmailConfig | null {
    const config = this.loadYamlFile<EmailConfig>('email/email_config.yaml', {
      required,
      validateMetadata: true,
    });
    if (!config) {
      return null;
    }
    this.validateEmailConfig(config, 'email/email_config.yaml');
    return config;
  }

  /**
   * Load and validate logging_config.yaml.
   */
  getLoggingConfig(required = true): LoggingConfig | null {
    const config = this.loadYamlFile<LoggingConfig>(
      'logging/logging_config.yaml',
      {
        required,
        validateMetadata: true,
      },
    );
    if (!config) {
      return null;
    }
    this.validateLoggingConfig(config, 'logging/logging_config.yaml');
    return config;
  }

  /**
   * Load and validate notification_config.yaml.
   */
  getNotificationConfig(required = true): NotificationConfig | null {
    const config = this.loadYamlFile<NotificationConfig>(
      'notifications/notification_config.yaml',
      { required, validateMetadata: true },
    );
    if (!config) {
      return null;
    }
    this.validateNotificationConfig(
      config,
      'notifications/notification_config.yaml',
    );
    return config;
  }

  /**
   * Load and validate insights/config.yaml.
   */
  getInsightsConfig(required = true): InsightsConfig | null {
    const config = this.loadYamlFile<InsightsConfig>('insights/config.yaml', {
      required,
      validateMetadata: true,
    });
    if (!config) {
      return null;
    }
    // Additional invariants for insights are mostly enforced by Insights module itself;
    // here we only validate common metadata.
    return config;
  }

  /**
   * Load profiles YAML (organization profiles). This file uses per-profile metadata
   * rather than a single top-level metadata block, so metadata validation is skipped. :contentReference[oaicite:6]{index=6}
   */
  getProfilesConfig(required = true): ProfilesConfig | null {
    const config = this.loadYamlFile<ProfilesConfig>(
      'profiles/organization_profiles.yaml',
      {
        required,
        validateMetadata: false,
      },
    );
    if (!config) {
      return null;
    }
    if (!config.profiles || typeof config.profiles !== 'object') {
      throw new ConfigValidationError(
        'Profiles config must contain a top-level "profiles" map',
        'profiles/organization_profiles.yaml',
      );
    }
    return config;
  }

  /**
   * Placeholder for future updates via admin APIs.
   * Aligns with Doc 4 entry ConfigService.updateServiceConfig. :contentReference[oaicite:7]{index=7}
   *
   * This method is intentionally conservative and only supports in-process updates;
   * persisting config changes back to YAML and writing audit logs should be handled
   * by a dedicated configuration management flow.
   */
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  async updateServiceConfig(
    // e.g. "email", "logging", "database", "notifications", "insights"
    logicalServiceName: string,
    // New config subtree to apply (already validated at DTO level).
    value: any,
  ): Promise<void> {
    this.logger.warn(
      `updateServiceConfig("${logicalServiceName}") called, but dynamic persistence is not yet implemented. ` +
        'You can implement YAML write-back and audit logging here when enabling the admin config UI.',
    );
    // No-op for now – config is read-only at runtime.
  }

  // -------------------------------------------------------------------------
  // Internal helpers
  // -------------------------------------------------------------------------

  private resolveEnvironment(): OrgoEnvironment {
    const explicit =
      this.nestConfig.get<string>('ORGO_ENV') ?? process.env.ORGO_ENV;
    const nodeEnv =
      this.nestConfig.get<string>('NODE_ENV') ?? process.env.NODE_ENV;

    let raw = (explicit ?? nodeEnv ?? 'dev').toLowerCase();

    if (raw === 'development') {
      raw = 'dev';
    }
    if (raw === 'production') {
      raw = 'prod';
    }

    if (
      (ConfigService.VALID_ENVIRONMENTS as string[]).includes(
        raw as OrgoEnvironment,
      )
    ) {
      return raw as OrgoEnvironment;
    }

    this.logger.warn(
      `Unknown environment "${raw}", falling back to "dev". Expected one of: ${ConfigService.VALID_ENVIRONMENTS.join(
        ', ',
      )}`,
    );
    return 'dev';
  }

  private resolveBasePath(): string {
    const override =
      this.nestConfig.get<string>('ORGO_CONFIG_BASE_PATH') ??
      process.env.ORGO_CONFIG_BASE_PATH;

    if (override) {
      return path.resolve(override);
    }

    // At runtime the API app usually executes from apps/api or apps/api/dist.
    // Going two levels up reaches the monorepo root, then /config.
    return path.resolve(process.cwd(), '..', '..', 'config');
  }

  /**
   * Eagerly load and validate core configs so the app fails fast on misconfiguration.
   */
  private ensureCoreConfigsLoaded(): void {
    try {
      // Database & logging are required for any serious deployment.
      this.getDatabaseConfig(true);
      this.getLoggingConfig(true);

      // Email, notifications and insights may be optional; load if present.
      this.getEmailConfig(false);
      this.getNotificationConfig(false);
      this.getInsightsConfig(false);
      this.getProfilesConfig(false);
    } catch (error) {
      if (error instanceof ConfigValidationError) {
        this.logger.error(error.message);
      } else {
        this.logger.error(
          `Unexpected error while loading Orgo config: ${
            (error as Error)?.message ?? String(error)
          }`,
        );
      }
      // Re-throw so NestJS fails the bootstrap process.
      throw error;
    }
  }

  /**
   * Load a YAML file from the config base path, optionally validate metadata,
   * and cache the result for subsequent calls.
   */
  private loadYamlFile<T extends BaseConfig>(
    relativePath: string,
    options: { required?: boolean; validateMetadata?: boolean } = {},
  ): T | null {
    const { required = true, validateMetadata = true } = options;

    if (this.cache.has(relativePath)) {
      return this.cache.get(relativePath) as T;
    }

    const absolutePath = path.resolve(this.basePath, relativePath);

    if (!fs.existsSync(absolutePath)) {
      const message = `Config file not found at ${absolutePath}`;
      if (required) {
        throw new ConfigValidationError(message, relativePath);
      }
      this.logger.warn(message);
      return null;
    }

    const fileContents = fs.readFileSync(absolutePath, 'utf8');
    const parsed = yaml.load(fileContents) as T;

    if (!parsed || typeof parsed !== 'object') {
      throw new ConfigValidationError(
        'Config file did not contain a YAML object at the top level',
        relativePath,
      );
    }

    if (validateMetadata) {
      this.validateMetadata(parsed, relativePath);
    }

    this.cache.set(relativePath, parsed);
    return parsed;
  }

  private validateMetadata(config: BaseConfig, relativePath: string): void {
    if (!config.metadata || typeof config.metadata !== 'object') {
      throw new ConfigValidationError(
        'Missing or invalid "metadata" section',
        relativePath,
      );
    }

    const { config_name, version, environment, last_updated } = config.metadata;

    if (!config_name || typeof config_name !== 'string') {
      throw new ConfigValidationError(
        '"metadata.config_name" must be a non-empty string',
        relativePath,
      );
    }

    if (!version || typeof version !== 'string') {
      throw new ConfigValidationError(
        '"metadata.version" must be a non-empty string',
        relativePath,
      );
    }

    // Doc 2: version must match ^3\.[0-9]+$ for Orgo v3 configs. :contentReference[oaicite:8]{index=8}
    const versionPattern = /^3\.[0-9]+$/;
    if (!versionPattern.test(version)) {
      throw new ConfigValidationError(
        `"metadata.version" must match ${versionPattern.source} for Orgo v3 configs`,
        relativePath,
      );
    }

    if (!environment || typeof environment !== 'string') {
      throw new ConfigValidationError(
        '"metadata.environment" must be set',
        relativePath,
      );
    }

    if (
      !ConfigService.VALID_ENVIRONMENTS.includes(
        environment as OrgoEnvironment,
      )
    ) {
      throw new ConfigValidationError(
        `"metadata.environment" must be one of ${ConfigService.VALID_ENVIRONMENTS.join(
          ', ',
        )}`,
        relativePath,
      );
    }

    if (!last_updated || typeof last_updated !== 'string') {
      throw new ConfigValidationError(
        '"metadata.last_updated" must be a non-empty string in YYYY-MM-DD format',
        relativePath,
      );
    }

    const datePattern = /^\d{4}-\d{2}-\d{2}$/;
    if (!datePattern.test(last_updated)) {
      throw new ConfigValidationError(
        '"metadata.last_updated" must be in YYYY-MM-DD format',
        relativePath,
      );
    }
  }

  private validateDatabaseConfig(
    config: DatabaseConfig,
    relativePath: string,
  ): void {
    const postgresEnabled = !!config.postgres?.enabled;
    const sqliteEnabled = !!config.sqlite?.enabled;

    // Doc 2/5: exactly one of postgres.enabled / sqlite.enabled may be true. 
    if (postgresEnabled && sqliteEnabled) {
      throw new ConfigValidationError(
        'Only one of postgres.enabled or sqlite.enabled can be true',
        relativePath,
      );
    }

    if (!postgresEnabled && !sqliteEnabled) {
      this.logger.warn(
        `Neither Postgres nor SQLite is enabled in ${relativePath} – database-dependent services may fail.`,
      );
    }

    if (config.postgres?.pool) {
      const { min_connections, max_connections } = config.postgres.pool;
      if (
        typeof min_connections === 'number' &&
        typeof max_connections === 'number' &&
        min_connections > max_connections
      ) {
        throw new ConfigValidationError(
          'postgres.pool.min_connections must be <= postgres.pool.max_connections',
          relativePath,
        );
      }
    }

    if (sqliteEnabled && !config.sqlite?.file_path) {
      this.logger.warn(
        `SQLite is enabled but "sqlite.file_path" is not set in ${relativePath}`,
      );
    }
  }

  private validateEmailConfig(
    config: EmailConfig,
    relativePath: string,
  ): void {
    const hasSmtpHost = !!config.smtp?.host;
    const hasImapHost = !!config.imap?.host;

    // Doc 2/5: at least one of SMTP/IMAP should be configured. 
    if (!hasSmtpHost && !hasImapHost) {
      this.logger.warn(
        `Neither SMTP nor IMAP host is configured in ${relativePath} – email send/receive may be disabled.`,
      );
    }

    if (!config.limits) {
      throw new ConfigValidationError(
        '"limits" section is required in email config',
        relativePath,
      );
    }

    if (
      typeof config.limits.max_email_size_mb !== 'number' ||
      config.limits.max_email_size_mb <= 0
    ) {
      throw new ConfigValidationError(
        '"limits.max_email_size_mb" must be a positive number',
        relativePath,
      );
    }

    if (
      !Array.isArray(config.limits.allowed_attachment_mimetypes) ||
      config.limits.allowed_attachment_mimetypes.length === 0
    ) {
      throw new ConfigValidationError(
        '"limits.allowed_attachment_mimetypes" must be a non-empty array',
        relativePath,
      );
    }
  }

  private validateLoggingConfig(
    config: LoggingConfig,
    relativePath: string,
  ): void {
    if (!config.logging) {
      throw new ConfigValidationError(
        'Missing "logging" root block in logging config',
        relativePath,
      );
    }

    const level = config.logging.level;
    if (
      level &&
      !ConfigService.VALID_LOG_LEVELS.includes(level as LogLevel)
    ) {
      throw new ConfigValidationError(
        `"logging.level" must be one of ${ConfigService.VALID_LOG_LEVELS.join(
          ', ',
        )}`,
        relativePath,
      );
    }

    if (config.categories) {
      Object.keys(config.categories).forEach((categoryKey) => {
        if (
          !ConfigService.VALID_LOG_CATEGORIES.includes(
            categoryKey as LogCategory,
          )
        ) {
          this.logger.warn(
            `Unknown log category "${categoryKey}" in ${relativePath} – this is allowed but will not map to a canonical LOG_CATEGORY value.`,
          );
        }
      });
    }
  }

  private validateNotificationConfig(
    config: NotificationConfig,
    relativePath: string,
  ): void {
    if (!config.notifications) {
      throw new ConfigValidationError(
        'Missing "notifications" root block in notification config',
        relativePath,
      );
    }

    const { default_channel } = config.notifications;

    if (
      default_channel &&
      !ConfigService.VALID_NOTIFICATION_CHANNELS.includes(
        default_channel as NotificationChannel,
      )
    ) {
      throw new ConfigValidationError(
        `"notifications.default_channel" must be one of ${ConfigService.VALID_NOTIFICATION_CHANNELS.join(
          ', ',
        )}`,
        relativePath,
      );
    }

    if (!config.notifications.templates) {
      this.logger.warn(
        `No notification templates defined under "notifications.templates" in ${relativePath}`,
      );
    }
  }
}

===== END apps/api/src/orgo/config/config.service.ts =====


===== BEGIN apps/api/src/orgo/config/feature-flag.controller.ts =====
// apps/api/src/orgo/config/feature-flag.controller.ts

import {
  Body,
  Controller,
  Delete,
  Get,
  HttpCode,
  HttpStatus,
  NotFoundException,
  Param,
  Put,
  Query,
} from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import {
  ApiBody,
  ApiOperation,
  ApiParam,
  ApiQuery,
  ApiResponse,
  ApiTags,
  ApiProperty,
} from '@nestjs/swagger';
import { FeatureFlagService } from './feature-flag.service';

/**
 * Canonical environment values for Orgo v3 (Doc 2 – ENVIRONMENT).
 * This is kept local to avoid coupling to config-loader details.
 */
export type OrgoEnvironment = 'dev' | 'staging' | 'prod' | 'offline';

/**
 * Scope for listing / reading / deleting feature flags.
 * Flags can be global (organizationId = null) or scoped to a specific org.
 */
export class FeatureFlagScopeQueryDto {
  @ApiProperty({
    required: false,
    nullable: true,
    description:
      'Organization to scope flags to. If omitted, global flags are used (organization_id = NULL).',
  })
  organizationId?: string;

  @ApiProperty({
    required: false,
    enum: ['dev', 'staging', 'prod', 'offline'],
    description:
      'Environment to scope flags to. If omitted, derived from the server environment (NODE_ENV / ORGO_ENV).',
  })
  environment?: OrgoEnvironment;
}

/**
 * DTO representing a feature flag as exposed via the API.
 * The underlying storage will typically include additional fields;
 * this shape is stable for external consumers.
 */
export class FeatureFlagDto {
  @ApiProperty({
    description:
      'Stable feature flag key (e.g. "orgo.insights.enabled", "orgo.workflow.new_router").',
  })
  key!: string;

  @ApiProperty({
    description:
      'Whether the flag is currently enabled for the given org/environment scope.',
  })
  enabled!: boolean;

  @ApiProperty({
    required: false,
    description:
      'Optional human-readable description for admins; does not affect behaviour.',
  })
  description?: string;

  @ApiProperty({
    required: false,
    nullable: true,
    minimum: 0,
    maximum: 100,
    description:
      'Optional rollout percentage (0–100). When set, downstream services may use gradual rollout.',
  })
  rolloutPercentage?: number | null;

  @ApiProperty({
    enum: ['dev', 'staging', 'prod', 'offline'],
    description: 'Environment this flag value applies to.',
  })
  environment!: OrgoEnvironment;

  @ApiProperty({
    required: false,
    nullable: true,
    description:
      'Organization this flag value applies to. NULL / undefined means global default (organization_id = NULL).',
  })
  organizationId?: string | null;

  @ApiProperty({
    required: false,
    type: String,
    format: 'date-time',
    description: 'Last update timestamp in ISO‑8601 (UTC), if available.',
  })
  updatedAt?: string;

  @ApiProperty({
    required: false,
    nullable: true,
    description:
      'User ID that last updated the flag (if tracked by the implementation).',
  })
  updatedByUserId?: string | null;

  @ApiProperty({
    required: false,
    description:
      'True if this value is inherited from a global default rather than defined explicitly for the org.',
  })
  inherited?: boolean;
}

/**
 * Payload for creating/updating (upserting) a feature flag value.
 * The key is taken from the URL path; this DTO controls value-level fields.
 */
export class UpsertFeatureFlagDto {
  @ApiProperty({
    description:
      'Whether the flag should be enabled for this org/environment scope.',
  })
  enabled!: boolean;

  @ApiProperty({
    required: false,
    description:
      'Optional human-readable description; stored with the flag for admin UIs.',
  })
  description?: string;

  @ApiProperty({
    required: false,
    nullable: true,
    minimum: 0,
    maximum: 100,
    description:
      'Optional rollout percentage (0–100). When undefined, no gradual rollout is configured.',
  })
  rolloutPercentage?: number | null;

  @ApiProperty({
    required: false,
    enum: ['dev', 'staging', 'prod', 'offline'],
    description:
      'Environment to scope this flag value to. If omitted, derived from the server environment.',
  })
  environment?: OrgoEnvironment;

  @ApiProperty({
    required: false,
    nullable: true,
    description:
      'Organization to scope this flag value to. If omitted, the flag is treated as global (organization_id = NULL).',
  })
  organizationId?: string | null;
}

@ApiTags('Config / Feature Flags')
@Controller('orgo/config/feature-flags')
export class FeatureFlagController {
  constructor(
    private readonly featureFlagService: FeatureFlagService,
    private readonly configService: ConfigService,
  ) {}

  /**
   * Resolve an Orgo ENVIRONMENT value from an optional explicit value
   * plus process / config environment variables.
   *
   * Canonical values: "dev" | "staging" | "prod" | "offline"
   * (Doc 2 – Foundations, §2.1 Environments).
   */
  private resolveEnvironment(explicit?: string): OrgoEnvironment {
    const raw =
      explicit ??
      this.configService.get<string>('ORGO_ENV') ??
      this.configService.get<string>('NODE_ENV') ??
      'dev';

    const value = raw.toLowerCase();

    if (value === 'dev' || value === 'development' || value === 'local') {
      return 'dev';
    }

    if (value === 'staging' || value === 'stage') {
      return 'staging';
    }

    if (value === 'prod' || value === 'production') {
      return 'prod';
    }

    if (value === 'offline') {
      return 'offline';
    }

    // Fallback: be explicit and predictable.
    return 'dev';
  }

  // ---------------------------------------------------------------------------
  // GET /orgo/config/feature-flags
  // ---------------------------------------------------------------------------

  @Get()
  @ApiOperation({
    summary: 'List feature flags',
    description:
      'Returns all feature flags for the given org/environment scope. If organizationId is omitted, global flags are returned.',
  })
  @ApiQuery({
    name: 'organizationId',
    required: false,
    description:
      'Organization to filter flags for. If omitted, returns global flags (organization_id = NULL).',
  })
  @ApiQuery({
    name: 'environment',
    required: false,
    enum: ['dev', 'staging', 'prod', 'offline'],
    description:
      'Environment to filter flags for. If omitted, derived from server environment.',
  })
  @ApiResponse({ status: 200, type: FeatureFlagDto, isArray: true })
  async listFeatureFlags(
    @Query() scope: FeatureFlagScopeQueryDto,
  ): Promise<FeatureFlagDto[]> {
    const environment = this.resolveEnvironment(scope.environment);
    const organizationId = scope.organizationId ?? null;

    return this.featureFlagService.listFlags({
      environment,
      organizationId,
    });
  }

  // ---------------------------------------------------------------------------
  // GET /orgo/config/feature-flags/:key
  // ---------------------------------------------------------------------------

  @Get(':key')
  @ApiOperation({
    summary: 'Get a single feature flag',
    description:
      'Returns the effective value of a feature flag for the given org/environment scope.',
  })
  @ApiParam({
    name: 'key',
    description:
      'Feature flag key (e.g. "orgo.insights.enabled", "orgo.workflow.new_router").',
  })
  @ApiQuery({
    name: 'organizationId',
    required: false,
    description:
      'Organization scope. If omitted, the global value (organization_id = NULL) is returned.',
  })
  @ApiQuery({
    name: 'environment',
    required: false,
    enum: ['dev', 'staging', 'prod', 'offline'],
    description:
      'Environment scope. If omitted, derived from server environment.',
  })
  @ApiResponse({ status: 200, type: FeatureFlagDto })
  @ApiResponse({ status: 404, description: 'Flag not found for given scope.' })
  async getFeatureFlag(
    @Param('key') key: string,
    @Query() scope: FeatureFlagScopeQueryDto,
  ): Promise<FeatureFlagDto> {
    const environment = this.resolveEnvironment(scope.environment);
    const organizationId = scope.organizationId ?? null;

    const flag = await this.featureFlagService.getFlag({
      key,
      environment,
      organizationId,
    });

    if (!flag) {
      throw new NotFoundException(
        `Feature flag "${key}" not found for environment="${environment}" and organizationId="${organizationId ?? 'null'}".`,
      );
    }

    return flag;
  }

  // ---------------------------------------------------------------------------
  // PUT /orgo/config/feature-flags/:key
  // ---------------------------------------------------------------------------

  @Put(':key')
  @HttpCode(HttpStatus.OK)
  @ApiOperation({
    summary: 'Create or update a feature flag (upsert)',
    description:
      'Creates or updates a feature flag value for a given org/environment scope. The key is taken from the URL path.',
  })
  @ApiParam({
    name: 'key',
    description:
      'Feature flag key (e.g. "orgo.insights.enabled", "orgo.workflow.new_router").',
  })
  @ApiBody({ type: UpsertFeatureFlagDto })
  @ApiResponse({ status: 200, type: FeatureFlagDto })
  async upsertFeatureFlag(
    @Param('key') key: string,
    @Body() body: UpsertFeatureFlagDto,
  ): Promise<FeatureFlagDto> {
    const environment = this.resolveEnvironment(body.environment);
    const organizationId = body.organizationId ?? null;

    return this.featureFlagService.setFlag({
      key,
      enabled: body.enabled,
      description: body.description,
      rolloutPercentage: body.rolloutPercentage ?? null,
      environment,
      organizationId,
    });
  }

  // ---------------------------------------------------------------------------
  // DELETE /orgo/config/feature-flags/:key
  // ---------------------------------------------------------------------------

  @Delete(':key')
  @HttpCode(HttpStatus.NO_CONTENT)
  @ApiOperation({
    summary: 'Delete a feature flag value for a scope',
    description:
      'Removes a feature flag value for the given org/environment scope. Global defaults and other scopes are left untouched.',
  })
  @ApiParam({
    name: 'key',
    description: 'Feature flag key to delete.',
  })
  @ApiQuery({
    name: 'organizationId',
    required: false,
    description:
      'Organization scope. If omitted, deletes the global value (organization_id = NULL).',
  })
  @ApiQuery({
    name: 'environment',
    required: false,
    enum: ['dev', 'staging', 'prod', 'offline'],
    description:
      'Environment scope. If omitted, derived from the server environment.',
  })
  @ApiResponse({ status: 204, description: 'Flag deleted (or not present).' })
  async deleteFeatureFlag(
    @Param('key') key: string,
    @Query() scope: FeatureFlagScopeQueryDto,
  ): Promise<void> {
    const environment = this.resolveEnvironment(scope.environment);
    const organizationId = scope.organizationId ?? null;

    await this.featureFlagService.deleteFlag({
      key,
      environment,
      organizationId,
    });
  }
}

===== END apps/api/src/orgo/config/feature-flag.controller.ts =====


===== BEGIN apps/api/src/orgo/config/feature-flag.service.ts =====
import { Injectable, Logger } from '@nestjs/common';
import { FeatureFlag } from '@prisma/client';
import { PrismaService } from '../../persistence/prisma/prisma.service';

/**
 * Rollout strategies supported via feature_flags.rollout_strategy (JSONB).
 *
 * Stored JSON is expected to contain at least a "type" discriminator:
 *
 *   { "type": "all" }
 *   { "type": "percentage", "percentage": 10, "seed": "optional-stable-seed" }
 *   { "type": "roles", "roleCodes": ["maintenance_coordinator", "hr_officer"] }
 *   { "type": "users", "userIds": ["<uuid>", ...] }
 */
export type RolloutStrategy =
  | { type: 'all' }
  | { type: 'percentage'; percentage: number; seed?: string }
  | { type: 'roles'; roleCodes: string[] }
  | { type: 'users'; userIds: string[] };

/**
 * Context used when evaluating whether a flag is effectively enabled.
 */
export interface FeatureFlagEvaluationContext {
  organizationId?: string | null;
  userId?: string | null;
  roleCodes?: string[];
}

/**
 * Input for FeatureFlagService.setFlag.
 *
 * organizationId:
 *   - UUID string for org‑scoped flags.
 *   - null / undefined for global flags.
 */
export interface SetFeatureFlagInput {
  organizationId?: string | null;
  code: string;
  enabled: boolean;
  description?: string;
  rolloutStrategy?: RolloutStrategy | Record<string, unknown> | null;
  enabledFrom?: Date | string | null;
  disabledAt?: Date | string | null;
}

/**
 * FeatureFlagService
 *
 * Manages feature_flags to gradually roll out or restrict features per organization.
 * Physical table shape is defined in the Orgo DB schema reference (Doc 1, feature_flags). 
 */
@Injectable()
export class FeatureFlagService {
  private readonly logger = new Logger(FeatureFlagService.name);

  constructor(private readonly prisma: PrismaService) {}

  /**
   * Returns the effective set of flags for an organization:
   * - Includes both global flags (organizationId = null) and org‑scoped flags.
   * - For each code, org‑scoped row overrides the global row when both exist.
   */
  async listFlagsForOrganization(
    organizationId?: string | null,
  ): Promise<FeatureFlag[]> {
    const orgId = organizationId ?? null;

    const flags = await this.prisma.featureFlag.findMany({
      where: {
        OR: [{ organizationId: orgId }, { organizationId: null }],
      },
      orderBy: [{ code: 'asc' }, { organizationId: 'asc' }],
    });

    const byCode = new Map<string, FeatureFlag>();

    for (const flag of flags) {
      const existing = byCode.get(flag.code);
      if (!existing) {
        byCode.set(flag.code, flag);
        continue;
      }

      // Prefer org‑specific override over global flag.
      if (flag.organizationId && !existing.organizationId) {
        byCode.set(flag.code, flag);
      }
    }

    return Array.from(byCode.values());
  }

  /**
   * Fetch a single flag by code for an organization, with override resolution:
   * - Prefers org‑scoped flag if present.
   * - Falls back to global flag.
   */
  async getFlag(
    code: string,
    organizationId?: string | null,
  ): Promise<FeatureFlag | null> {
    const orgId = organizationId ?? null;

    const flag = await this.prisma.featureFlag.findFirst({
      where: {
        code,
        OR: [{ organizationId: orgId }, { organizationId: null }],
      },
      orderBy: [
        // Non‑null organizationId (org‑specific) should win over global.
        { organizationId: 'desc' },
      ],
    });

    return flag ?? null;
  }

  /**
   * Evaluate whether a feature is effectively enabled for the given context:
   * - resolves org/global override,
   * - checks enabled boolean + time window,
   * - applies rollout_strategy (percentage / roles / users) if present.
   */
  async isFeatureEnabled(
    code: string,
    params: {
      organizationId?: string | null;
      context?: FeatureFlagEvaluationContext;
    } = {},
  ): Promise<boolean> {
    const { organizationId, context } = params;
    const flag = await this.getFlag(code, organizationId);

    if (!flag) {
      return false;
    }

    if (!flag.enabled) {
      return false;
    }

    if (!this.isWithinActiveWindow(flag)) {
      return false;
    }

    const mergedContext: FeatureFlagEvaluationContext = {
      organizationId: flag.organizationId ?? organizationId ?? null,
      ...(context ?? {}),
    };

    const rolloutOk = this.evaluateRolloutStrategy(
      flag.rolloutStrategy,
      mergedContext,
    );

    return rolloutOk;
  }

  /**
   * Create or update a feature flag for an organization.
   *
   * Semantics:
   * - (orgId, code) pair is treated as unique (org override vs global default).
   * - If a row exists, it is updated; otherwise a new row is created.
   * - When enabled = true and no enabledFrom is provided, enabledFrom defaults to now.
   * - When enabled = false and no disabledAt is provided, disabledAt defaults to now.
   */
  async setFlag(input: SetFeatureFlagInput): Promise<FeatureFlag> {
    const orgId = input.organizationId ?? null;
    const now = new Date();

    const existing = await this.prisma.featureFlag.findFirst({
      where: {
        organizationId: orgId,
        code: input.code,
      },
    });

    const description =
      input.description ?? existing?.description ?? input.code;

    const enabledFrom = (() => {
      const explicit = this.toDateOrNull(input.enabledFrom);
      if (explicit) {
        return explicit;
      }

      if (input.enabled) {
        // Default to "now" whenever explicitly enabling without a schedule.
        return now;
      }

      // For disabled flags, keep any existing enabledFrom (historical info),
      // or leave null if there was none.
      return existing?.enabledFrom ?? null;
    })();

    const disabledAt = (() => {
      const explicit = this.toDateOrNull(input.disabledAt);
      if (explicit) {
        return explicit;
      }

      if (!input.enabled) {
        // When disabling without an explicit schedule, mark disabled "now".
        return now;
      }

      // When enabling and no explicit disabledAt is set, clear any previous value.
      return null;
    })();

    const rolloutStrategy =
      input.rolloutStrategy === undefined
        ? existing?.rolloutStrategy ?? null
        : (input.rolloutStrategy as unknown);

    if (existing) {
      const updated = await this.prisma.featureFlag.update({
        where: { id: existing.id },
        data: {
          enabled: input.enabled,
          description,
          rolloutStrategy,
          enabledFrom,
          disabledAt,
        },
      });

      this.logger.log(
        `Updated feature flag "${updated.code}" for org=${updated.organizationId ?? 'GLOBAL'} enabled=${updated.enabled}`,
      );

      return updated;
    }

    const created = await this.prisma.featureFlag.create({
      data: {
        organizationId: orgId,
        code: input.code,
        enabled: input.enabled,
        description,
        rolloutStrategy,
        enabledFrom,
        disabledAt,
      },
    });

    this.logger.log(
      `Created feature flag "${created.code}" for org=${created.organizationId ?? 'GLOBAL'} enabled=${created.enabled}`,
    );

    return created;
  }

  /**
   * Checks whether the current time falls within the active window of a flag.
   *
   * Active when:
   * - enabledFrom is null or <= now, AND
   * - disabledAt is null or > now.
   */
  private isWithinActiveWindow(
    flag: FeatureFlag,
    now: Date = new Date(),
  ): boolean {
    const { enabledFrom, disabledAt } = flag;

    if (enabledFrom && enabledFrom > now) {
      return false;
    }

    if (disabledAt && disabledAt <= now) {
      return false;
    }

    return true;
  }

  /**
   * Apply rollout_strategy for a flag based on evaluation context.
   *
   * If rollout_strategy is null/undefined, it is treated as "no additional gating"
   * and returns true (flag state is controlled solely by enabled/time window).
   *
   * If rollout_strategy is present but malformed or of an unknown type, the
   * strategy is treated as invalid and the feature is considered disabled,
   * which is the safe default for configuration errors.
   */
  private evaluateRolloutStrategy(
    rawStrategy: unknown,
    context: FeatureFlagEvaluationContext,
  ): boolean {
    if (rawStrategy === null || rawStrategy === undefined) {
      return true;
    }

    const strategy = this.normalizeRolloutStrategy(rawStrategy);
    if (!strategy) {
      this.logger.warn(
        'Unknown or invalid rollout strategy on feature flag; treating as disabled',
      );
      return false;
    }

    switch (strategy.type) {
      case 'all':
        return true;

      case 'percentage': {
        const percentage = Math.max(0, Math.min(100, strategy.percentage));
        if (percentage === 0) {
          return false;
        }
        if (percentage === 100) {
          return true;
        }

        const seed =
          strategy.seed ??
          (context.userId
            ? `user:${context.userId}`
            : context.organizationId
            ? `org:${context.organizationId}`
            : context.roleCodes && context.roleCodes.length > 0
            ? `roles:${context.roleCodes.sort().join(',')}`
            : 'global');

        const value = this.stableHashToUnitInterval(seed);
        return value * 100 < percentage;
      }

      case 'roles': {
        if (!context.roleCodes || context.roleCodes.length === 0) {
          return false;
        }
        const allowed = new Set(strategy.roleCodes);
        return context.roleCodes.some((role) => allowed.has(role));
      }

      case 'users': {
        if (!context.userId) {
          return false;
        }
        const allowedUsers = new Set(strategy.userIds);
        return allowedUsers.has(context.userId);
      }

      default:
        // Should not happen if normalizeRolloutStrategy is exhaustive.
        return false;
    }
  }

  /**
   * Normalizes raw JSON from rollout_strategy into a RolloutStrategy object.
   * Returns null if the JSON does not conform to any supported strategy.
   */
  private normalizeRolloutStrategy(raw: unknown): RolloutStrategy | null {
    if (!raw || typeof raw !== 'object') {
      return null;
    }

    const obj = raw as { [key: string]: unknown };
    const type = typeof obj.type === 'string' ? obj.type : undefined;

    switch (type) {
      case 'all':
        return { type: 'all' };

      case 'percentage': {
        const rawPercentage = (obj.percentage ?? obj['pct']) as
          | number
          | string
          | undefined;

        const percentage =
          typeof rawPercentage === 'number'
            ? rawPercentage
            : rawPercentage !== undefined
            ? Number(rawPercentage)
            : NaN;

        if (!Number.isFinite(percentage)) {
          return null;
        }

        const seed =
          typeof obj.seed === 'string' ? (obj.seed as string) : undefined;

        return { type: 'percentage', percentage, seed };
      }

      case 'roles': {
        const rawRoleCodes = Array.isArray(obj.roleCodes)
          ? obj.roleCodes
          : [];
        const roleCodes = rawRoleCodes.filter(
          (v): v is string => typeof v === 'string',
        );

        if (roleCodes.length === 0) {
          return null;
        }

        return { type: 'roles', roleCodes };
      }

      case 'users': {
        const rawUserIds = Array.isArray(obj.userIds) ? obj.userIds : [];
        const userIds = rawUserIds.filter(
          (v): v is string => typeof v === 'string',
        );

        if (userIds.length === 0) {
          return null;
        }

        return { type: 'users', userIds };
      }

      default:
        return null;
    }
  }

  /**
   * Deterministic hash from a string seed into [0, 1).
   * Uses a simple 32‑bit accumulator; sufficient for stable percentage rollouts.
   */
  private stableHashToUnitInterval(seed: string): number {
    let hash = 0;

    for (let i = 0; i < seed.length; i += 1) {
      hash = (hash * 31 + seed.charCodeAt(i)) | 0;
    }

    const unsigned = hash >>> 0;
    return unsigned / 0xffffffff;
  }

  /**
   * Helper: parse Date or ISO string into Date, returning null on invalid input.
   */
  private toDateOrNull(value?: Date | string | null): Date | null {
    if (!value) {
      return null;
    }

    if (value instanceof Date) {
      return value;
    }

    const parsed = new Date(value);
    if (Number.isNaN(parsed.getTime())) {
      return null;
    }

    return parsed;
  }
}

===== END apps/api/src/orgo/config/feature-flag.service.ts =====


===== BEGIN apps/api/src/orgo/config/org-profile.controller.ts =====

===== END apps/api/src/orgo/config/org-profile.controller.ts =====


===== BEGIN apps/api/src/orgo/config/org-profile.service.ts =====
import { Injectable, Logger } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { PrismaService } from '../../persistence/prisma/prisma.service';
import * as fs from 'fs';
import * as path from 'path';
import * as yaml from 'js-yaml';

export type VisibilityToken = 'PUBLIC' | 'INTERNAL' | 'RESTRICTED' | 'ANONYMISED';
export type TaskPriorityToken = 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';

type LowerVisibility =
  | 'public'
  | 'internal'
  | 'restricted'
  | 'anonymised'
  | 'anonymized'; // accept US spelling as alias

type LowerPriority = 'low' | 'medium' | 'high' | 'critical';

export interface ProfileDefaultTaskMetadataTemplate {
  visibility: LowerVisibility;
  default_priority: LowerPriority;
  default_reactivity_seconds: number;
}

export interface CyclicOverviewConfig {
  enabled: boolean;
  schedule: {
    weekly: boolean;
    monthly: boolean;
    yearly: boolean;
  };
  threshold_triggers: {
    incident_frequency: {
      min_events: number;
      window_days: number;
    };
    cross_departmental_trends: boolean;
    high_risk_indicators: boolean;
  };
}

export type EnvironmentToken = 'dev' | 'staging' | 'prod' | 'offline';

export interface ProfileTemplateMetadata {
  version: string;
  last_updated: string;
  environment: EnvironmentToken;
}

export interface ProfileTemplate {
  description: string;
  metadata: ProfileTemplateMetadata;

  // Reactivity / escalation timing
  reactivity_seconds: number;
  max_escalation_seconds: number;

  // Information visibility
  transparency_level: 'full' | 'balanced' | 'restricted' | 'private';

  // Escalation structure
  escalation_granularity: 'relaxed' | 'moderate' | 'detailed' | 'aggressive';

  // Review cadence
  review_frequency:
    | 'real_time'
    | 'daily'
    | 'weekly'
    | 'monthly'
    | 'quarterly'
    | 'yearly'
    | 'ad_hoc';

  // Notification scope
  notification_scope: 'user' | 'team' | 'department' | 'org_wide';

  // Pattern detection
  pattern_sensitivity: 'low' | 'medium' | 'high' | 'critical';
  pattern_window_days: number;
  pattern_min_events: number;

  // Severity / auto‑escalation
  severity_threshold: 'very_high' | 'high' | 'medium' | 'low';
  severity_policy: {
    critical: { immediate_escalation: boolean };
    major: { immediate_escalation: boolean };
    minor: { immediate_escalation: boolean };
  };

  // Logging & traceability
  logging_level: 'minimal' | 'standard' | 'detailed' | 'audit';
  log_retention_days: number;

  // Automation level
  automation_level: 'manual' | 'low' | 'medium' | 'high' | 'full';

  // Defaults for Task metadata
  default_task_metadata: ProfileDefaultTaskMetadataTemplate;

  // Cyclic overview / pattern review config
  cyclic_overview: CyclicOverviewConfig;
}

export interface ResolvedOrgProfile {
  organizationId: string;
  profileCode: string;
  template: ProfileTemplate;
  // Shallow copy of DB row for callers that need it; type is intentionally loose
  dbProfile?: {
    id: string;
    version: number;
    reactivity_profile?: unknown;
    transparency_profile?: unknown;
    pattern_sensitivity_profile?: unknown;
    retention_profile?: unknown;
  };
}

export type DefaultsTargetKind = 'task' | 'case';

export interface ApplyDefaultsInput {
  organizationId: string;
  /**
   * What we are applying defaults to. For now this only changes how callers
   * interpret the result; the actual values are the same.
   */
  kind: DefaultsTargetKind;
  /**
   * Existing canonical priority (TASK_PRIORITY) if already chosen.
   * If omitted, profile default is used.
   */
  existingPriority?: TaskPriorityToken;
  /**
   * Existing canonical visibility (VISIBILITY) if already chosen.
   * If omitted, profile default is used.
   */
  existingVisibility?: VisibilityToken;
  /**
   * If the caller already computed a reactivity SLA (in seconds),
   * pass it here; otherwise the profile default is used.
   */
  requestedReactivitySeconds?: number | null;
}

/**
 * Result of applying profile defaults to a Task/Case draft.
 * This is deliberately small; Task/Case handlers can attach it into
 * their own DTOs / DB models.
 */
export interface ApplyDefaultsResult {
  organizationId: string;
  profileCode: string;
  kind: DefaultsTargetKind;
  priority: TaskPriorityToken;
  visibility: VisibilityToken;
  /**
   * SLA before first escalation, in seconds, after applying profile defaults.
   */
  reactivitySeconds: number;
  /**
   * Reactivity time expressed as ISO‑8601 duration (e.g. "PT3600S").
   */
  reactivityTimeIso: string;
  /**
   * Automation level from the org profile, useful for downstream
   * workflow/notification engines.
   */
  automationLevel: ProfileTemplate['automation_level'];
  /**
   * Cyclic overview configuration copied from the profile, so
   * callers can decide whether to schedule reviews.
   */
  cyclicOverview: CyclicOverviewConfig;
}

/**
 * A simple numeric field change descriptor used in previewProfileDiff.
 */
export interface ProfileDiffNumericField {
  field: string;
  from: number | null;
  to: number;
  direction: 'increase' | 'decrease' | 'same';
}

/**
 * A simple enum/string field change descriptor used in previewProfileDiff.
 */
export interface ProfileDiffEnumField {
  field: string;
  from: string | null;
  to: string;
  changed: boolean;
}

export interface ProfileSummary {
  profileCode: string;
  description: string;
  reactivitySeconds: number;
  maxEscalationSeconds: number;
  notificationScope: string;
  patternSensitivity: string;
  patternWindowDays: number;
  patternMinEvents: number;
  loggingLevel: string;
  logRetentionDays: number;
  defaultVisibility: VisibilityToken;
  defaultPriority: TaskPriorityToken;
}

/**
 * Result of simulating the impact of switching to a new profile for an org.
 */
export interface ProfileDiffResult {
  organizationId: string;
  currentProfileCode: string | null;
  candidateProfileCode: string;
  currentProfileSummary: ProfileSummary | null;
  candidateProfileSummary: ProfileSummary;
  numericChanges: ProfileDiffNumericField[];
  enumChanges: ProfileDiffEnumField[];
}

interface ProfilesFileShape {
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  metadata?: any;
  profiles?: Record<string, ProfileTemplate>;
}

const DEFAULT_PROFILE_CODE = 'default';

const PROFILE_CONFIG_ENV_VAR = 'ORGO_PROFILES_CONFIG_PATH';

@Injectable()
export class OrgProfileService {
  private readonly logger = new Logger(OrgProfileService.name);

  /**
   * Profiles loaded from YAML configuration (Doc 7 shape).
   * Keyed by profile_code (e.g. "default", "friend_group", "hospital").
   */
  private profileTemplates: Record<string, ProfileTemplate> = {};

  private readonly profilesConfigPath: string;

  constructor(
    private readonly prisma: PrismaService,
    private readonly configService: ConfigService,
  ) {
    const fromEnv = this.configService.get<string>(PROFILE_CONFIG_ENV_VAR);
    this.profilesConfigPath =
      fromEnv ??
      path.resolve(
        process.cwd(),
        'config',
        'profiles',
        'organization_profiles.yaml',
      );
    this.loadProfilesFromConfig();
  }

  /**
   * Load and cache profile templates from the profiles YAML file.
   * Fails softly: if the file is missing or invalid, we fall back to
   * a hard‑coded "default" profile so the system can still operate.
   */
  private loadProfilesFromConfig(): void {
    try {
      if (!fs.existsSync(this.profilesConfigPath)) {
        this.logger.warn(
          `Org profiles config not found at "${this.profilesConfigPath}". Falling back to hard‑coded default profile.`,
        );
        this.profileTemplates = {
          [DEFAULT_PROFILE_CODE]: this.buildHardcodedDefaultProfile(),
        };
        return;
      }

      const raw = fs.readFileSync(this.profilesConfigPath, 'utf8');
      const parsed = yaml.load(raw) as ProfilesFileShape | undefined;

      if (!parsed || typeof parsed !== 'object' || !parsed.profiles) {
        this.logger.warn(
          `Org profiles config at "${this.profilesConfigPath}" is missing a "profiles" root key. Falling back to hard‑coded default profile.`,
        );
        this.profileTemplates = {
          [DEFAULT_PROFILE_CODE]: this.buildHardcodedDefaultProfile(),
        };
        return;
      }

      this.profileTemplates = { ...parsed.profiles };

      if (!this.profileTemplates[DEFAULT_PROFILE_CODE]) {
        this.logger.warn(
          `Org profiles config at "${this.profilesConfigPath}" does not define a "${DEFAULT_PROFILE_CODE}" profile. Injecting built‑in default profile.`,
        );
        this.profileTemplates[DEFAULT_PROFILE_CODE] =
          this.buildHardcodedDefaultProfile();
      }

      // Never expose the internal "_template" as a usable profile.
      if (this.profileTemplates._template) {
        delete this.profileTemplates._template;
      }

      this.logger.log(
        `Loaded ${Object.keys(this.profileTemplates).length} org profile templates from YAML config.`,
      );
    } catch (error: unknown) {
      const message =
        error instanceof Error ? error.message : String(error ?? '');
      this.logger.error(
        `Failed to load org profiles config from "${this.profilesConfigPath}": ${message}. Falling back to hard‑coded default profile.`,
      );
      this.profileTemplates = {
        [DEFAULT_PROFILE_CODE]: this.buildHardcodedDefaultProfile(),
      };
    }
  }

  /**
   * Hard‑coded default profile matching the "default" profile from Doc 7.
   * This is used as a safety net when YAML config is unavailable or invalid.
   */
  private buildHardcodedDefaultProfile(): ProfileTemplate {
    return {
      description:
        'Default balanced organizational profile used when no more specific archetype is selected.',
      metadata: {
        version: '3.0',
        last_updated: '2025-11-19',
        environment: 'prod',
      },
      reactivity_seconds: 43200,
      max_escalation_seconds: 172800,
      transparency_level: 'balanced',
      escalation_granularity: 'moderate',
      review_frequency: 'monthly',
      notification_scope: 'department',
      pattern_sensitivity: 'medium',
      pattern_window_days: 30,
      pattern_min_events: 3,
      severity_threshold: 'medium',
      severity_policy: {
        critical: { immediate_escalation: true },
        major: { immediate_escalation: true },
        minor: { immediate_escalation: false },
      },
      logging_level: 'standard',
      log_retention_days: 1095,
      automation_level: 'medium',
      default_task_metadata: {
        visibility: 'internal',
        default_priority: 'medium',
        default_reactivity_seconds: 43200,
      },
      cyclic_overview: {
        enabled: true,
        schedule: {
          weekly: true,
          monthly: true,
          yearly: true,
        },
        threshold_triggers: {
          incident_frequency: {
            min_events: 3,
            window_days: 30,
          },
          cross_departmental_trends: true,
          high_risk_indicators: true,
        },
      },
    };
  }

  /**
   * Internal helper to fetch a profile template by code, falling back
   * to the default profile when the requested code is unknown.
   */
  private getProfileTemplate(profileCode: string): ProfileTemplate {
    const normalizedCode = profileCode || DEFAULT_PROFILE_CODE;
    const fromConfig = this.profileTemplates[normalizedCode];

    if (fromConfig) {
      return fromConfig;
    }

    if (normalizedCode !== DEFAULT_PROFILE_CODE) {
      this.logger.warn(
        `Profile code "${normalizedCode}" not found in org profiles config. Falling back to "${DEFAULT_PROFILE_CODE}" profile.`,
      );
    }

    const fallback =
      this.profileTemplates[DEFAULT_PROFILE_CODE] ??
      this.buildHardcodedDefaultProfile();

    // Cache the fallback default to avoid re‑creating it.
    if (!this.profileTemplates[DEFAULT_PROFILE_CODE]) {
      this.profileTemplates[DEFAULT_PROFILE_CODE] = fallback;
    }

    return fallback;
  }

  /**
   * Load an organization's active profile by combining:
   *   - The profile record in organization_profiles (if present), and
   *   - The profile template from the profiles YAML (Doc 7).
   *
   * If no DB row exists or the table is not yet present, the default profile
   * template is returned.
   */
  async loadProfile(organizationId: string): Promise<ResolvedOrgProfile> {
    if (!organizationId) {
      throw new Error('organizationId is required to load org profile.');
    }

    let dbProfile:
      | {
          id: string;
          organization_id: string;
          profile_code: string;
          version: number;
          reactivity_profile?: unknown;
          transparency_profile?: unknown;
          pattern_sensitivity_profile?: unknown;
          retention_profile?: unknown;
        }
      | null = null;

    try {
      // Use "any" to avoid tight coupling to a particular Prisma schema version.
      const prismaAny = this.prisma as any;
      if (
        prismaAny &&
        prismaAny.organizationProfile &&
        typeof prismaAny.organizationProfile.findUnique === 'function'
      ) {
        dbProfile = await prismaAny.organizationProfile.findUnique({
          where: { organization_id: organizationId },
        });
      }
    } catch (error: unknown) {
      const message =
        error instanceof Error ? error.message : String(error ?? '');
      this.logger.warn(
        `Failed to fetch organization profile from DB for org "${organizationId}": ${message}. Continuing with YAML profile only.`,
      );
    }

    const profileCode = dbProfile?.profile_code ?? DEFAULT_PROFILE_CODE;
    const template = this.getProfileTemplate(profileCode);

    return {
      organizationId,
      profileCode,
      template,
      dbProfile:
        dbProfile == null
          ? undefined
          : {
              id: dbProfile.id,
              version: dbProfile.version,
              reactivity_profile: dbProfile.reactivity_profile,
              transparency_profile: dbProfile.transparency_profile,
              pattern_sensitivity_profile: dbProfile.pattern_sensitivity_profile,
              retention_profile: dbProfile.retention_profile,
            },
    };
  }

  /**
   * Applies profile‑driven defaults to a Task/Case draft:
   *   - priority (TASK_PRIORITY)
   *   - visibility (VISIBILITY)
   *   - reactivity SLA (seconds + ISO‑8601 duration)
   *   - automation level
   *   - cyclic overview schedule (for review scheduling)
   */
  async applyDefaults(
    input: ApplyDefaultsInput,
  ): Promise<ApplyDefaultsResult> {
    const resolved = await this.loadProfile(input.organizationId);
    const template = resolved.template;
    const defaults = template.default_task_metadata;

    const priority =
      input.existingPriority ??
      this.normalizePriorityToken(defaults.default_priority);
    const visibility =
      input.existingVisibility ??
      this.normalizeVisibilityToken(defaults.visibility);

    const reactivitySeconds =
      input.requestedReactivitySeconds ??
      defaults.default_reactivity_seconds ??
      template.reactivity_seconds;

    const reactivityTimeIso = this.secondsToIsoDuration(reactivitySeconds);

    return {
      organizationId: input.organizationId,
      profileCode: resolved.profileCode,
      kind: input.kind,
      priority,
      visibility,
      reactivitySeconds,
      reactivityTimeIso,
      automationLevel: template.automation_level,
      cyclicOverview: template.cyclic_overview,
    };
  }

  /**
   * Simulate the impact of switching an organization to a new profile code.
   *
   * Returns a compact diff over key behavioural knobs:
   *   - Reactivity & escalation timing
   *   - Notification scope
   *   - Pattern sensitivity & windows
   *   - Logging retention
   *   - Default visibility & priority
   */
  async previewProfileDiff(
    organizationId: string,
    candidateProfileCode: string,
  ): Promise<ProfileDiffResult> {
    if (!candidateProfileCode) {
      throw new Error('candidateProfileCode is required.');
    }

    const [currentResolved, candidateTemplate] = await Promise.all([
      this.loadProfile(organizationId).catch(() => null),
      Promise.resolve(this.getProfileTemplate(candidateProfileCode)),
    ]);

    const currentTemplate = currentResolved?.template ?? null;

    const currentSummary = currentTemplate
      ? this.summarizeProfile(
          currentResolved!.profileCode,
          currentTemplate,
        )
      : null;
    const candidateSummary = this.summarizeProfile(
      candidateProfileCode,
      candidateTemplate,
    );

    const numericChanges: ProfileDiffNumericField[] = [
      this.makeNumericDiff(
        'reactivity_seconds',
        currentSummary?.reactivitySeconds ?? null,
        candidateSummary.reactivitySeconds,
      ),
      this.makeNumericDiff(
        'max_escalation_seconds',
        currentSummary?.maxEscalationSeconds ?? null,
        candidateSummary.maxEscalationSeconds,
      ),
      this.makeNumericDiff(
        'pattern_window_days',
        currentSummary?.patternWindowDays ?? null,
        candidateSummary.patternWindowDays,
      ),
      this.makeNumericDiff(
        'pattern_min_events',
        currentSummary?.patternMinEvents ?? null,
        candidateSummary.patternMinEvents,
      ),
      this.makeNumericDiff(
        'log_retention_days',
        currentSummary?.logRetentionDays ?? null,
        candidateSummary.logRetentionDays,
      ),
    ];

    const enumChanges: ProfileDiffEnumField[] = [
      this.makeEnumDiff(
        'notification_scope',
        currentSummary?.notificationScope ?? null,
        candidateSummary.notificationScope,
      ),
      this.makeEnumDiff(
        'pattern_sensitivity',
        currentSummary?.patternSensitivity ?? null,
        candidateSummary.patternSensitivity,
      ),
      this.makeEnumDiff(
        'logging_level',
        currentSummary?.loggingLevel ?? null,
        candidateSummary.loggingLevel,
      ),
      this.makeEnumDiff(
        'default_visibility',
        currentSummary?.defaultVisibility ?? null,
        candidateSummary.defaultVisibility,
      ),
      this.makeEnumDiff(
        'default_priority',
        currentSummary?.defaultPriority ?? null,
        candidateSummary.defaultPriority,
      ),
    ];

    return {
      organizationId,
      currentProfileCode: currentResolved?.profileCode ?? null,
      candidateProfileCode,
      currentProfileSummary: currentSummary,
      candidateProfileSummary: candidateSummary,
      numericChanges,
      enumChanges,
    };
  }

  private summarizeProfile(
    profileCode: string,
    template: ProfileTemplate,
  ): ProfileSummary {
    const defaultVisibility = this.normalizeVisibilityToken(
      template.default_task_metadata.visibility,
    );
    const defaultPriority = this.normalizePriorityToken(
      template.default_task_metadata.default_priority,
    );

    return {
      profileCode,
      description: template.description,
      reactivitySeconds: template.reactivity_seconds,
      maxEscalationSeconds: template.max_escalation_seconds,
      notificationScope: template.notification_scope,
      patternSensitivity: template.pattern_sensitivity,
      patternWindowDays: template.pattern_window_days,
      patternMinEvents: template.pattern_min_events,
      loggingLevel: template.logging_level,
      logRetentionDays: template.log_retention_days,
      defaultVisibility,
      defaultPriority,
    };
  }

  private makeNumericDiff(
    field: string,
    from: number | null,
    to: number,
  ): ProfileDiffNumericField {
    let direction: ProfileDiffNumericField['direction'] = 'same';
    if (from == null) {
      direction = 'increase';
    } else if (to > from) {
      direction = 'increase';
    } else if (to < from) {
      direction = 'decrease';
    }

    return { field, from, to, direction };
  }

  private makeEnumDiff(
    field: string,
    from: string | null,
    to: string,
  ): ProfileDiffEnumField {
    return {
      field,
      from,
      to,
      changed: from == null ? true : from !== to,
    };
  }

  /**
   * Map lower‑case config values for priority to canonical TASK_PRIORITY tokens.
   */
  private normalizePriorityToken(priority: LowerPriority | string): TaskPriorityToken {
    const value = String(priority).toLowerCase() as LowerPriority;

    switch (value) {
      case 'low':
        return 'LOW';
      case 'high':
        return 'HIGH';
      case 'critical':
        return 'CRITICAL';
      case 'medium':
      default:
        return 'MEDIUM';
    }
  }

  /**
   * Map lower‑case config values for visibility to canonical VISIBILITY tokens.
   */
  private normalizeVisibilityToken(
    visibility: LowerVisibility | string,
  ): VisibilityToken {
    const value = String(visibility).toLowerCase() as LowerVisibility;

    switch (value) {
      case 'public':
        return 'PUBLIC';
      case 'restricted':
        return 'RESTRICTED';
      case 'anonymised':
      case 'anonymized':
        return 'ANONYMISED';
      case 'internal':
      default:
        return 'INTERNAL';
    }
  }

  /**
   * Convert a number of seconds into an ISO‑8601 duration string, e.g. 3600 → "PT3600S".
   */
  private secondsToIsoDuration(seconds: number): string {
    const safe = Number.isFinite(seconds) && seconds > 0 ? Math.floor(seconds) : 0;
    return `PT${safe}S`;
  }
}

===== END apps/api/src/orgo/config/org-profile.service.ts =====


===== BEGIN apps/api/src/orgo/core/alerts/alerting.service.ts =====
import { Injectable } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';

import { LogService } from '../logging/log.service';
import {
  FN_ALERT_ESCALATION_DELAY,
  FN_ALERT_ERROR_RATE,
} from '../functional-ids';

/**
 * Canonical log levels for Core Services (Doc 2 / Doc 5).
 */
export type LogLevel = 'DEBUG' | 'INFO' | 'WARNING' | 'ERROR' | 'CRITICAL';

/**
 * Canonical log categories for Core Services (Doc 2 / Doc 5).
 */
export type LogCategory = 'WORKFLOW' | 'TASK' | 'SYSTEM' | 'SECURITY' | 'EMAIL';

/**
 * Canonical environment values (Doc 2).
 */
export type Environment = 'dev' | 'staging' | 'prod' | 'offline';

/**
 * Standard result error shape (Doc 5 §2.4).
 */
export interface StandardError {
  code: string;
  message: string;
  details?: unknown;
}

/**
 * Standard result shape (ok / data / error) used across Core Services (Doc 5 §2.4).
 */
export interface StandardResult<T> {
  ok: boolean;
  data: T | null;
  error: StandardError | null;
}

/**
 * Alert types handled by AlertingService.
 */
export type AlertType = 'ESCALATION_DELAY' | 'ERROR_RATE';

/**
 * Result payload describing whether an alert was emitted.
 */
export interface AlertTriggerResult {
  alertType: AlertType;
  triggered: boolean;
  reason: string;
  metadata?: Record<string, unknown>;
}

/**
 * Input payload for escalation-delay alerts.
 *
 * The job `orgo.alerts.escalation-delay` is expected to compute these metrics
 * using SLA rules derived from profiles/config (Docs 2, 5, 7, 8) and pass them here.
 */
export interface EscalationDelayAlertInput {
  /**
   * Organization the metrics apply to (tenant).
   */
  organizationId: string;

  /**
   * Profile key used for SLA expectations (e.g. "hospital", "default").
   * See Doc 7 – profiles YAML.
   */
  profileKey: string;

  /**
   * Environment in which the alert is being evaluated.
   */
  environment: Environment;

  /**
   * Number of unresolved Tasks whose `reactivity_deadline_at` has passed
   * (as per Doc 8 §8.7.2).
   */
  overdueUnresolvedCount: number;

  /**
   * Number of those overdue Tasks that are `CRITICAL` severity.
   */
  overdueCriticalCount: number;

  /**
   * Maximum delay in seconds beyond `reactivity_deadline_at`
   * among the overdue Tasks.
   */
  maxDelaySeconds: number;

  /**
   * Optional threshold overrides already resolved by the caller.
   * If omitted, defaults derived from config are used.
   */
  thresholds?: {
    /**
     * Minimum overdue Task count required before an alert is emitted.
     */
    minOverdueCount?: number;

    /**
     * Minimum maximum delay (in seconds) beyond SLA before emitting an alert.
     */
    minMaxDelaySeconds?: number;
  };
}

/**
 * Input payload for error-rate alerts.
 *
 * The job `orgo.alerts.error-rate` is expected to compute these metrics from
 * observability data (e.g. Prometheus / logs) and pass them here.
 */
export interface ErrorRateAlertInput {
  /**
   * Identifier of the service / worker being monitored (e.g. "task_handler").
   */
  serviceId: string;

  /**
   * Environment in which the alert is being evaluated.
   */
  environment: Environment;

  /**
   * Rolling window size (in minutes) used to compute the error rate.
   */
  windowMinutes: number;

  /**
   * Error rate in the window, expressed as a fraction between 0 and 1.
   * Example: 0.02 = 2% error rate.
   */
  errorRate: number;

  /**
   * Total request count in the window; used for sanity checks and logging.
   */
  requestCount: number;

  /**
   * Optional threshold override already resolved by the caller.
   * If omitted, defaults derived from config are used.
   */
  thresholdErrorRate?: number;
}

/**
 * AlertingService
 *
 * Infrastructure & Monitoring sub-module responsible for emitting alerts
 * when SLA- and error-related conditions are breached (Doc 4 §3.8).
 *
 * Code names (Doc 4 §3.8):
 * - Trigger escalation delay alert → AlertingService.triggerEscalationDelayAlert,
 *   job `orgo.alerts.escalation-delay`.
 * - Trigger error-rate alert → AlertingService.triggerErrorRateAlert,
 *   job `orgo.alerts.error-rate`.
 */
@Injectable()
export class AlertingService {
  /**
   * Default thresholds used when no explicit values are provided via config
   * or method parameters. These values are conservative and intended to be
   * overridden per-environment via configuration.
   */
  private readonly defaultEscalationMinOverdueCount: number;
  private readonly defaultEscalationMinMaxDelaySeconds: number;
  private readonly defaultErrorRateThreshold: number;

  constructor(
    private readonly logService: LogService,
    private readonly configService: ConfigService,
  ) {
    // Escalation-delay thresholds (may be overridden by config).
    this.defaultEscalationMinOverdueCount =
      Number(
        this.configService.get(
          'alerts.escalationDelay.min_overdue_count',
        ) as number | string,
      ) || 1;

    this.defaultEscalationMinMaxDelaySeconds =
      Number(
        this.configService.get(
          'alerts.escalationDelay.min_max_delay_seconds',
        ) as number | string,
      ) || 60;

    // Error-rate threshold (may be overridden by config).
    // Default: 1% error rate.
    this.defaultErrorRateThreshold =
      Number(
        this.configService.get('alerts.errorRate.threshold') as number | string,
      ) || 0.01;
  }

  /**
   * Emits an alert when escalations fall behind SLAs derived from profiles/config.
   *
   * This method is typically called by the background job
   * `orgo.alerts.escalation-delay`, which aggregates metrics across Tasks and
   * passes them in the `input` payload.
   */
  async triggerEscalationDelayAlert(
    input: EscalationDelayAlertInput,
  ): Promise<StandardResult<AlertTriggerResult>> {
    try {
      const minOverdueCount =
        input.thresholds?.minOverdueCount ??
        this.defaultEscalationMinOverdueCount;
      const minMaxDelaySeconds =
        input.thresholds?.minMaxDelaySeconds ??
        this.defaultEscalationMinMaxDelaySeconds;

      const breached =
        input.overdueUnresolvedCount >= minOverdueCount &&
        input.maxDelaySeconds >= minMaxDelaySeconds;

      const reason = breached
        ? `Escalation delay thresholds breached: overdue_unresolved=${input.overdueUnresolvedCount}, overdue_critical=${input.overdueCriticalCount}, max_delay_seconds=${input.maxDelaySeconds}, min_overdue_count=${minOverdueCount}, min_max_delay_seconds=${minMaxDelaySeconds}.`
        : `Escalation delay thresholds not breached: overdue_unresolved=${input.overdueUnresolvedCount}, overdue_critical=${input.overdueCriticalCount}, max_delay_seconds=${input.maxDelaySeconds}, min_overdue_count=${minOverdueCount}, min_max_delay_seconds=${minMaxDelaySeconds}.`;

      await this.logService.logEvent({
        category: 'SYSTEM' as LogCategory,
        level: (breached ? 'WARNING' : 'INFO') as LogLevel,
        message: breached
          ? 'Escalation delay alert evaluated: thresholds breached.'
          : 'Escalation delay alert evaluated: thresholds not breached.',
        identifier: `org_id:${input.organizationId}`,
        functionId: FN_ALERT_ESCALATION_DELAY,
        metadata: {
          environment: input.environment,
          profileKey: input.profileKey,
          overdueUnresolvedCount: input.overdueUnresolvedCount,
          overdueCriticalCount: input.overdueCriticalCount,
          maxDelaySeconds: input.maxDelaySeconds,
          minOverdueCount,
          minMaxDelaySeconds,
          breached,
        },
      });

      return {
        ok: true,
        data: {
          alertType: 'ESCALATION_DELAY',
          triggered: breached,
          reason,
          metadata: {
            organizationId: input.organizationId,
            profileKey: input.profileKey,
            environment: input.environment,
          },
        },
        error: null,
      };
    } catch (error) {
      const err =
        error instanceof Error
          ? error
          : new Error('Unknown error in triggerEscalationDelayAlert');

      await this.logService.logEvent({
        category: 'SYSTEM' as LogCategory,
        level: 'ERROR' as LogLevel,
        message: 'Failed to evaluate escalation delay alert.',
        identifier: `org_id:${input.organizationId}`,
        functionId: FN_ALERT_ESCALATION_DELAY,
        metadata: {
          error: err.message,
        },
      });

      return {
        ok: false,
        data: null,
        error: {
          code: 'ALERT_EVALUATION_ERROR',
          message: err.message,
          details: {
            alertType: 'ESCALATION_DELAY',
          },
        },
      };
    }
  }

  /**
   * Emits an alert when error rates across services exceed configured thresholds.
   *
   * This method is typically called by the background job
   * `orgo.alerts.error-rate`, which aggregates error-rate metrics from the
   * observability stack (Prometheus/Grafana, logs, etc.) and passes them here.
   */
  async triggerErrorRateAlert(
    input: ErrorRateAlertInput,
  ): Promise<StandardResult<AlertTriggerResult>> {
    try {
      const threshold =
        input.thresholdErrorRate ?? this.defaultErrorRateThreshold;

      const breached =
        input.errorRate >= threshold && input.requestCount > 0 && threshold > 0;

      const reason = breached
        ? `Error-rate threshold breached for service "${input.serviceId}" in ${input.environment}: error_rate=${input.errorRate}, threshold=${threshold}, window_minutes=${input.windowMinutes}, request_count=${input.requestCount}.`
        : `Error-rate threshold not breached for service "${input.serviceId}" in ${input.environment}: error_rate=${input.errorRate}, threshold=${threshold}, window_minutes=${input.windowMinutes}, request_count=${input.requestCount}.`;

      await this.logService.logEvent({
        category: 'SYSTEM' as LogCategory,
        level: (breached ? 'WARNING' : 'INFO') as LogLevel,
        message: breached
          ? 'Error-rate alert evaluated: thresholds breached.'
          : 'Error-rate alert evaluated: thresholds not breached.',
        identifier: `service_id:${input.serviceId}`,
        functionId: FN_ALERT_ERROR_RATE,
        metadata: {
          environment: input.environment,
          serviceId: input.serviceId,
          errorRate: input.errorRate,
          requestCount: input.requestCount,
          threshold,
          windowMinutes: input.windowMinutes,
          breached,
        },
      });

      return {
        ok: true,
        data: {
          alertType: 'ERROR_RATE',
          triggered: breached,
          reason,
          metadata: {
            serviceId: input.serviceId,
            environment: input.environment,
          },
        },
        error: null,
      };
    } catch (error) {
      const err =
        error instanceof Error
          ? error
          : new Error('Unknown error in triggerErrorRateAlert');

      await this.logService.logEvent({
        category: 'SYSTEM' as LogCategory,
        level: 'ERROR' as LogLevel,
        message: 'Failed to evaluate error-rate alert.',
        identifier: `service_id:${input.serviceId}`,
        functionId: FN_ALERT_ERROR_RATE,
        metadata: {
          error: err.message,
        },
      });

      return {
        ok: false,
        data: null,
        error: {
          code: 'ALERT_EVALUATION_ERROR',
          message: err.message,
          details: {
            alertType: 'ERROR_RATE',
          },
        },
      };
    }
  }
}

===== END apps/api/src/orgo/core/alerts/alerting.service.ts =====


===== BEGIN apps/api/src/orgo/core/cases/case.controller.ts =====
import {
  BadRequestException,
  Controller,
  Get,
  Logger,
  NotFoundException,
  Param,
  Query,
  Req,
} from '@nestjs/common';
import {
  ApiExtraModels,
  ApiOkResponse,
  ApiOperation,
  ApiParam,
  ApiProperty,
  ApiPropertyOptional,
  ApiTags,
} from '@nestjs/swagger';
import { Request } from 'express';
import { CaseService } from './case.service';

// -----------------------------------------------------------------------------
// Canonical enums (mirroring Docs 2 & 8 JSON shapes for Cases / Tasks)
// -----------------------------------------------------------------------------

export const CASE_STATUS_VALUES = ['open', 'in_progress', 'resolved', 'archived'] as const;
export type CaseStatus = (typeof CASE_STATUS_VALUES)[number];

export const CASE_SEVERITY_VALUES = ['minor', 'moderate', 'major', 'critical'] as const;
export type CaseSeverity = (typeof CASE_SEVERITY_VALUES)[number];

export const VISIBILITY_VALUES = ['PUBLIC', 'INTERNAL', 'RESTRICTED', 'ANONYMISED'] as const;
export type Visibility = (typeof VISIBILITY_VALUES)[number];

export const TASK_STATUS_VALUES = [
  'PENDING',
  'IN_PROGRESS',
  'ON_HOLD',
  'COMPLETED',
  'FAILED',
  'ESCALATED',
  'CANCELLED',
] as const;
export type TaskStatus = (typeof TASK_STATUS_VALUES)[number];

export const TASK_PRIORITY_VALUES = ['LOW', 'MEDIUM', 'HIGH', 'CRITICAL'] as const;
export type TaskPriority = (typeof TASK_PRIORITY_VALUES)[number];

export const TASK_SEVERITY_VALUES = ['MINOR', 'MODERATE', 'MAJOR', 'CRITICAL'] as const;
export type TaskSeverity = (typeof TASK_SEVERITY_VALUES)[number];

export const TASK_CATEGORY_VALUES = [
  'request',
  'incident',
  'update',
  'report',
  'distribution',
] as const;
export type TaskCategory = (typeof TASK_CATEGORY_VALUES)[number];

export type CaseSortBy = 'created_at' | 'updated_at';
export type SortDirection = 'asc' | 'desc';

// -----------------------------------------------------------------------------
// DTOs
// -----------------------------------------------------------------------------

export class ListCasesQueryDto {
  @ApiPropertyOptional({ enum: CASE_STATUS_VALUES, description: 'Filter by Case status' })
  status?: CaseStatus;

  @ApiPropertyOptional({
    enum: CASE_SEVERITY_VALUES,
    description: 'Filter by Case severity (JSON form)',
  })
  severity?: CaseSeverity;

  @ApiPropertyOptional({
    enum: VISIBILITY_VALUES,
    description: 'Filter by visibility; maps to VISIBILITY enum',
  })
  visibility?: Visibility;

  @ApiPropertyOptional({
    description:
      'Filter by canonical label "<BASE>.<CATEGORY><SUBCATEGORY>.<HORIZONTAL_ROLE>"',
    example: '100.94.Operations.Safety',
  })
  label?: string;

  @ApiPropertyOptional({
    description: 'Free-text search over title/description/metadata (implementation-specific)',
  })
  search?: string;

  @ApiPropertyOptional({
    minimum: 1,
    default: 1,
    description: '1-based page number for pagination',
  })
  page?: number;

  @ApiPropertyOptional({
    minimum: 1,
    maximum: 200,
    default: 25,
    description: 'Page size for pagination (max 200)',
  })
  pageSize?: number;

  @ApiPropertyOptional({
    enum: ['created_at', 'updated_at'],
    default: 'updated_at',
    description: 'Field to sort by',
  })
  sortBy?: CaseSortBy;

  @ApiPropertyOptional({
    enum: ['asc', 'desc'],
    default: 'desc',
    description: 'Sort direction',
  })
  sortDirection?: SortDirection;
}

/**
 * Canonical Case JSON DTO (aligned with Doc 8 §8.4.1).
 */
export class CaseDto {
  @ApiProperty({ format: 'uuid', description: 'Case identifier (maps from cases.id)' })
  case_id!: string;

  @ApiProperty({ format: 'uuid', description: 'Owning organization (tenant) id' })
  organization_id!: string;

  @ApiProperty({
    enum: ['email', 'api', 'manual', 'sync'],
    description: 'Origin channel for this Case',
  })
  source_type!: 'email' | 'api' | 'manual' | 'sync';

  @ApiPropertyOptional({
    nullable: true,
    description: 'Channel-specific reference (e.g., email message-id, external URI)',
  })
  source_reference?: string | null;

  @ApiProperty({
    description: 'Canonical label "<BASE>.<CATEGORY><SUBCATEGORY>.<HORIZONTAL_ROLE>"',
  })
  label!: string;

  @ApiProperty({ description: 'Short human-readable title' })
  title!: string;

  @ApiProperty({ description: 'Free-text description/body' })
  description!: string;

  @ApiProperty({
    enum: CASE_STATUS_VALUES,
    description: 'Case lifecycle status (CASE_STATUS; JSON form)',
  })
  status!: CaseStatus;

  @ApiProperty({
    enum: CASE_SEVERITY_VALUES,
    description: 'Severity (JSON form mapping to TASK_SEVERITY enum)',
  })
  severity!: CaseSeverity;

  @ApiPropertyOptional({
    nullable: true,
    description: 'ISO-8601 duration; SLA window for Case handling (e.g. "PT2H")',
  })
  reactivity_time?: string | null;

  @ApiPropertyOptional({
    nullable: true,
    description: 'Vertical base of the originating label (e.g. 100, 1000)',
  })
  origin_vertical_level?: number | null;

  @ApiPropertyOptional({
    nullable: true,
    description: 'Horizontal role of origin (e.g. "Ops.Maintenance")',
  })
  origin_role?: string | null;

  @ApiPropertyOptional({
    type: [String],
    nullable: true,
    description: 'Optional tag list attached to the Case',
  })
  tags?: string[] | null;

  @ApiPropertyOptional({
    type: Object,
    nullable: true,
    description: 'Structured location payload (site/building/geo, etc.)',
  })
  location?: Record<string, unknown> | null;

  @ApiPropertyOptional({
    type: Object,
    description:
      'Case-level metadata (pattern_sensitivity, review settings, domain-specific fields, etc.)',
  })
  metadata?: Record<string, unknown>;

  @ApiProperty({
    description: 'Creation timestamp (ISO-8601 UTC)',
  })
  created_at!: string;

  @ApiProperty({
    description: 'Last update timestamp (ISO-8601 UTC)',
  })
  updated_at!: string;
}

/**
 * Summary view of a Task for inclusion under a Case.
 * Uses canonical Task enums from Docs 2 & 8.
 */
export class TaskSummaryDto {
  @ApiProperty({ format: 'uuid', description: 'Task identifier (maps from tasks.id)' })
  task_id!: string;

  @ApiProperty({
    enum: TASK_STATUS_VALUES,
    description: 'Task lifecycle status (TASK_STATUS)',
  })
  status!: TaskStatus;

  @ApiProperty({
    enum: TASK_PRIORITY_VALUES,
    description: 'Task priority (TASK_PRIORITY)',
  })
  priority!: TaskPriority;

  @ApiProperty({
    enum: TASK_SEVERITY_VALUES,
    description: 'Task severity (TASK_SEVERITY)',
  })
  severity!: TaskSeverity;

  @ApiProperty({
    enum: TASK_CATEGORY_VALUES,
    description: 'Global Task category',
  })
  category!: TaskCategory;

  @ApiPropertyOptional({
    nullable: true,
    description: 'Domain-specific subtype (e.g. "plumbing", "harassment")',
  })
  subtype?: string | null;

  @ApiProperty({
    description: 'Canonical Task label',
  })
  label!: string;

  @ApiProperty({ description: 'Short Task title' })
  title!: string;

  @ApiPropertyOptional({
    nullable: true,
    description: 'Current owning routing role label (e.g. "Ops.Maintenance")',
  })
  assignee_role?: string | null;

  @ApiPropertyOptional({
    nullable: true,
    description: 'Due date (ISO-8601 UTC), if any',
  })
  due_at?: string | null;

  @ApiPropertyOptional({
    nullable: true,
    description:
      'First-response SLA deadline (ISO-8601 UTC; derived from created_at + reactivity_time)',
  })
  reactivity_deadline_at?: string | null;
}

/**
 * Shape returned by GET /v3/cases/:caseId – Case plus linked Tasks.
 */
export class CaseWithTasksDto {
  @ApiProperty({ type: () => CaseDto })
  case!: CaseDto;

  @ApiProperty({ type: () => [TaskSummaryDto] })
  tasks!: TaskSummaryDto[];
}

/**
 * Paginated Case list response for GET /v3/cases.
 */
export class PaginatedCaseSummaryDto {
  @ApiProperty({ type: () => [CaseDto] })
  items!: CaseDto[];

  @ApiProperty({
    description: 'Total number of Cases matching the filter (across all pages)',
  })
  total!: number;

  @ApiProperty({
    description: 'Current page index (1-based)',
    example: 1,
  })
  page!: number;

  @ApiProperty({
    description: 'Page size used for this response',
    example: 25,
  })
  pageSize!: number;
}

// Internal normalized query representation used between controller and service.
interface NormalizedCaseListQuery {
  status?: CaseStatus;
  severity?: CaseSeverity;
  visibility?: Visibility;
  label?: string;
  search?: string;
  page: number;
  pageSize: number;
  sortBy: CaseSortBy;
  sortDirection: SortDirection;
}

// -----------------------------------------------------------------------------
// Controller
// -----------------------------------------------------------------------------

@ApiTags('cases')
@ApiExtraModels(CaseDto, TaskSummaryDto, CaseWithTasksDto, PaginatedCaseSummaryDto)
@Controller('v3/cases')
export class CaseController {
  private readonly logger = new Logger(CaseController.name);

  constructor(private readonly caseService: CaseService) {}

  /**
   * List Cases for the current organization, with basic filtering and pagination.
   *
   * External path (via reverse proxy): GET /api/v3/cases
   */
  @Get()
  @ApiOperation({
    summary: 'List Cases',
    description:
      'Returns a paginated list of Cases for the current organization, filtered by status, severity, visibility, label, and/or search text.',
  })
  @ApiOkResponse({ type: PaginatedCaseSummaryDto })
  async listCases(
    @Req() req: Request,
    @Query() query: ListCasesQueryDto,
  ): Promise<PaginatedCaseSummaryDto> {
    const organizationId = this.getOrganizationIdFromRequest(req);
    const normalizedQuery = this.normalizeListQuery(query);

    this.logger.debug(
      `Listing cases for org ${organizationId} (page=${normalizedQuery.page}, pageSize=${normalizedQuery.pageSize})`,
    );

    // Implementation of listCases is provided by CaseService.
    return this.caseService.listCases(organizationId, normalizedQuery);
  }

  /**
   * Fetch a single Case and its linked Tasks for the current organization.
   *
   * External path (via reverse proxy): GET /api/v3/cases/:caseId
   */
  @Get(':caseId')
  @ApiOperation({
    summary: 'Get Case details',
    description: 'Returns a Case and its linked Tasks for the current organization.',
  })
  @ApiParam({
    name: 'caseId',
    description: 'Case identifier (UUID)',
  })
  @ApiOkResponse({ type: CaseWithTasksDto })
  async getCaseById(
    @Req() req: Request,
    @Param('caseId') caseId: string,
  ): Promise<CaseWithTasksDto> {
    const organizationId = this.getOrganizationIdFromRequest(req);

    const result = await this.caseService.getCaseWithTasks(organizationId, caseId);

    if (!result) {
      throw new NotFoundException(
        `Case ${caseId} not found for current organization or access is not permitted.`,
      );
    }

    return result;
  }

  // ---------------------------------------------------------------------------
  // Helpers
  // ---------------------------------------------------------------------------

  /**
   * Extracts the current organization id from the HTTP request.
   *
   * In a real deployment this is typically injected by an Auth/RBAC guard
   * (e.g. from a JWT). For now we expect X-Org-Id or X-Organization-Id headers.
   */
  private getOrganizationIdFromRequest(req: Request): string {
    const headerValue =
      (req.headers['x-org-id'] as string | undefined) ||
      (req.headers['x-organization-id'] as string | undefined);

    if (!headerValue) {
      throw new BadRequestException(
        'Missing organization identifier (expected X-Org-Id or X-Organization-Id header).',
      );
    }

    return headerValue;
  }

  /**
   * Normalizes list query parameters, validates enums, and applies defaults.
   */
  private normalizeListQuery(query: ListCasesQueryDto): NormalizedCaseListQuery {
    const pageRaw = query.page ?? 1;
    const page = Number.isFinite(+pageRaw) && +pageRaw > 0 ? Number(pageRaw) : 1;

    const pageSizeRaw = query.pageSize ?? 25;
    const rawPageSize = Number.isFinite(+pageSizeRaw) && +pageSizeRaw > 0 ? Number(pageSizeRaw) : 25;
    const pageSize = Math.min(rawPageSize, 200);

    let status: CaseStatus | undefined;
    if (query.status !== undefined) {
      if (!CASE_STATUS_VALUES.includes(query.status)) {
        throw new BadRequestException(
          `Invalid status "${query.status}". Expected one of: ${CASE_STATUS_VALUES.join(', ')}`,
        );
      }
      status = query.status;
    }

    let severity: CaseSeverity | undefined;
    if (query.severity !== undefined) {
      if (!CASE_SEVERITY_VALUES.includes(query.severity)) {
        throw new BadRequestException(
          `Invalid severity "${query.severity}". Expected one of: ${CASE_SEVERITY_VALUES.join(', ')}`,
        );
      }
      severity = query.severity;
    }

    let visibility: Visibility | undefined;
    if (query.visibility !== undefined) {
      if (!VISIBILITY_VALUES.includes(query.visibility)) {
        throw new BadRequestException(
          `Invalid visibility "${query.visibility}". Expected one of: ${VISIBILITY_VALUES.join(', ')}`,
        );
      }
      visibility = query.visibility;
    }

    const sortBy: CaseSortBy = (query.sortBy ?? 'updated_at') as CaseSortBy;
    if (!['created_at', 'updated_at'].includes(sortBy)) {
      throw new BadRequestException('sortBy must be one of: "created_at", "updated_at".');
    }

    const sortDirection: SortDirection = (query.sortDirection ?? 'desc') as SortDirection;
    if (!['asc', 'desc'].includes(sortDirection)) {
      throw new BadRequestException('sortDirection must be one of: "asc", "desc".');
    }

    const label = query.label?.trim() || undefined;
    const search = query.search?.trim() || undefined;

    return {
      status,
      severity,
      visibility,
      label,
      search,
      page,
      pageSize,
      sortBy,
      sortDirection,
    };
  }
}

===== END apps/api/src/orgo/core/cases/case.controller.ts =====


===== BEGIN apps/api/src/orgo/core/cases/case.module.ts =====
import { Module } from '@nestjs/common';
import { CaseService } from './case.service';
import { CaseController } from './case.controller';
import { CaseReviewService } from './case-review.service';
import { DatabaseModule } from '../database/database.module';

/**
 * CaseModule
 *
 * Core Services – Case Management
 * Wires up:
 *  - CaseService (create/fetch cases, link to tasks)
 *  - CaseReviewService (cyclic case review passes)
 *  - CaseController (HTTP API surface for cases)
 *
 * Depends on:
 *  - DatabaseModule (DatabaseService + RepositoryFactory)
 */
@Module({
  imports: [DatabaseModule],
  controllers: [CaseController],
  providers: [CaseService, CaseReviewService],
  exports: [CaseService, CaseReviewService],
})
export class CaseModule {}

===== END apps/api/src/orgo/core/cases/case.module.ts =====


===== BEGIN apps/api/src/orgo/core/cases/case.service.ts =====
import { Injectable } from '@nestjs/common';
import { Prisma, Case, Task } from '@prisma/client';
import { PrismaService } from '../../../persistence/prisma/prisma.service';
import { LogService } from '../logging/log.service';

export type CaseStatus = 'open' | 'in_progress' | 'resolved' | 'archived';

export type CaseSeverity = 'MINOR' | 'MODERATE' | 'MAJOR' | 'CRITICAL';

export interface ServiceError {
  code: string;
  message: string;
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  details?: any;
}

export interface ServiceResult<T> {
  ok: boolean;
  data: T | null;
  error: ServiceError | null;
}

export interface CreateCaseFromSignalInput {
  organizationId: string;
  sourceType: string; // email | api | manual | sync (or historical ui/import/insight)
  sourceReference?: string | null;

  label: string; // "<BASE>.<CATEGORY><SUBCATEGORY>.<HORIZONTAL_ROLE>"
  title: string;
  description: string;

  severity: string; // MINOR|MODERATE|MAJOR|CRITICAL or lower-case/json variant

  // Optional context
  originVerticalLevel?: number | null;
  originRole?: string | null;
  tags?: string[];
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  location?: Record<string, any> | null;
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  metadata?: Record<string, any> | null;

  /**
   * Optional SLA for this case, in seconds.
   * If provided, will be stored as an ISO-8601 duration string (e.g. "PT3600S").
   * Profiles / workflows may override or refine this later.
   */
  reactivityTimeSeconds?: number | null;
}

export interface GetCaseWithTasksOptions {
  organizationId: string;
  caseId: string;
  /**
   * If false, only unresolved tasks are returned (PENDING, IN_PROGRESS, ON_HOLD, ESCALATED).
   * Defaults to true = include all tasks.
   */
  includeClosedTasks?: boolean;
}

export interface CaseWithTasks {
  case: Case;
  tasks: Task[];
}

export interface ListCasesParams {
  organizationId: string;
  status?: CaseStatus | CaseStatus[];
  severity?: CaseSeverity | CaseSeverity[];
  /**
   * Filter by label prefix (e.g. "100.94." to get all safety-related cases at base 100).
   */
  labelPrefix?: string;
  /**
   * Free-text search in title/description.
   */
  search?: string;
  /**
   * Pagination (offset/limit).
   */
  offset?: number;
  limit?: number;
}

export interface PaginatedResult<T> {
  items: T[];
  total: number;
  offset: number;
  limit: number;
}

/**
 * CaseService implements the generic Case management logic:
 * - createCaseFromSignal: create a Case from an incoming signal/pattern
 * - getCaseWithTasks: fetch a Case and its linked Tasks
 * - listCases: list Cases per organization with filters
 * - updateCaseStatus: enforce the Case status lifecycle
 *
 * It follows the Orgo v3 specs (Docs 1, 2, 5, 8) for schema and lifecycle.
 */
@Injectable()
export class CaseService {
  constructor(
    private readonly prisma: PrismaService,
    private readonly logService: LogService,
  ) {}

  /**
   * Creates a Case row from an incoming signal (email/API/offline) or pattern.
   *
   * Responsibilities:
   * - Validate required fields.
   * - Normalize sourceType and severity to canonical tokens.
   * - Set initial status = "open".
   * - Store profile/workflow-driven fields in metadata/reactivityTime where applicable.
   */
  async createCaseFromSignal(
    input: CreateCaseFromSignalInput,
  ): Promise<ServiceResult<Case>> {
    const validationError = this.validateCreateCaseInput(input);
    if (validationError) {
      return {
        ok: false,
        data: null,
        error: validationError,
      };
    }

    let severity: CaseSeverity;
    let sourceType: 'email' | 'api' | 'manual' | 'sync';
    try {
      severity = this.normalizeSeverity(input.severity);
      sourceType = this.normalizeSourceType(input.sourceType);
    } catch (err) {
      return this.failure<Case>(
        'CASE_VALIDATION_ERROR',
        (err as Error).message,
      );
    }

    const reactivityTime =
      input.reactivityTimeSeconds != null
        ? this.secondsToIsoDuration(input.reactivityTimeSeconds)
        : null;

    try {
      const created = await this.prisma.case.create({
        data: {
          organizationId: input.organizationId,
          sourceType,
          sourceReference: input.sourceReference ?? null,
          label: input.label,
          title: input.title,
          description: input.description,
          status: 'open',
          severity,
          reactivityTime,
          originVerticalLevel: input.originVerticalLevel ?? null,
          originRole: input.originRole ?? null,
          tags: input.tags ?? [],
          location: (input.location ?? {}) as Prisma.JsonValue,
          metadata: (input.metadata ?? {}) as Prisma.JsonValue,
        },
      });

      // Best-effort logging; failures here should not break the main flow.
      void this.logService.logEvent({
        category: 'SYSTEM',
        level: 'INFO',
        message: 'Case created from signal',
        identifier: `case_id:${created.id}`,
        metadata: {
          organizationId: created.organizationId,
          sourceType,
          label: created.label,
          severity: created.severity,
          functionId: 'FN_CASE_CREATE',
        },
      });

      return this.success(created);
    } catch (error) {
      void this.logService.logEvent({
        category: 'SYSTEM',
        level: 'ERROR',
        message: 'Failed to create case from signal',
        metadata: {
          organizationId: input.organizationId,
          label: input.label,
          error: this.safeErrorToString(error),
          functionId: 'FN_CASE_CREATE',
        },
      });

      return this.failure<Case>(
        'CASE_CREATE_ERROR',
        'Failed to create case',
        error,
      );
    }
  }

  /**
   * Fetch a Case and its linked Tasks (via tasks.caseId).
   *
   * This is used by generic Case detail UIs and domain-specific views.
   */
  async getCaseWithTasks(
    options: GetCaseWithTasksOptions,
  ): Promise<ServiceResult<CaseWithTasks>> {
    const { organizationId, caseId } = options;

    try {
      const caseRecord = await this.prisma.case.findFirst({
        where: {
          id: caseId,
          organizationId,
        },
      });

      if (!caseRecord) {
        return this.failure<CaseWithTasks>(
          'CASE_NOT_FOUND',
          'Case not found for this organization',
          { organizationId, caseId },
        );
      }

      const tasksWhere: Prisma.TaskWhereInput = {
        organizationId,
        caseId: caseRecord.id,
      };

      if (options.includeClosedTasks === false) {
        tasksWhere.status = {
          in: ['PENDING', 'IN_PROGRESS', 'ON_HOLD', 'ESCALATED'],
        };
      }

      const tasks = await this.prisma.task.findMany({
        where: tasksWhere,
        orderBy: { createdAt: 'asc' },
      });

      return this.success<CaseWithTasks>({
        case: caseRecord,
        tasks,
      });
    } catch (error) {
      void this.logService.logEvent({
        category: 'SYSTEM',
        level: 'ERROR',
        message: 'Failed to fetch case with tasks',
        metadata: {
          organizationId,
          caseId,
          error: this.safeErrorToString(error),
          functionId: 'FN_CASE_GET_WITH_TASKS',
        },
      });

      return this.failure<CaseWithTasks>(
        'CASE_FETCH_ERROR',
        'Failed to fetch case with tasks',
        error,
      );
    }
  }

  /**
   * List Cases for an organization with basic filters and pagination.
   */
  async listCases(
    params: ListCasesParams,
  ): Promise<ServiceResult<PaginatedResult<Case>>> {
    const {
      organizationId,
      status,
      severity,
      labelPrefix,
      search,
      offset = 0,
      limit = 50,
    } = params;

    const where: Prisma.CaseWhereInput = {
      organizationId,
    };

    if (status) {
      if (Array.isArray(status)) {
        where.status = { in: status };
      } else {
        where.status = status;
      }
    }

    if (severity) {
      if (Array.isArray(severity)) {
        where.severity = { in: severity };
      } else {
        where.severity = severity;
      }
    }

    if (labelPrefix) {
      where.label = { startsWith: labelPrefix };
    }

    if (search) {
      where.OR = [
        { title: { contains: search, mode: 'insensitive' } },
        { description: { contains: search, mode: 'insensitive' } },
      ];
    }

    try {
      const [items, total] = await this.prisma.$transaction([
        this.prisma.case.findMany({
          where,
          orderBy: { createdAt: 'desc' },
          skip: offset,
          take: limit,
        }),
        this.prisma.case.count({ where }),
      ]);

      return this.success<PaginatedResult<Case>>({
        items,
        total,
        offset,
        limit,
      });
    } catch (error) {
      void this.logService.logEvent({
        category: 'SYSTEM',
        level: 'ERROR',
        message: 'Failed to list cases',
        metadata: {
          organizationId,
          error: this.safeErrorToString(error),
          functionId: 'FN_CASE_LIST',
        },
      });

      return this.failure<PaginatedResult<Case>>(
        'CASE_LIST_ERROR',
        'Failed to list cases',
        error,
      );
    }
  }

  /**
   * Update Case status, enforcing the canonical Case lifecycle:
   *
   * Allowed transitions:
   * - open        -> in_progress, resolved, archived
   * - in_progress -> resolved, archived
   * - resolved    -> archived, in_progress (re-open)
   * - archived    -> (terminal)
   */
  async updateCaseStatus(
    organizationId: string,
    caseId: string,
    newStatus: CaseStatus,
  ): Promise<ServiceResult<Case>> {
    try {
      const caseRecord = await this.prisma.case.findFirst({
        where: {
          id: caseId,
          organizationId,
        },
      });

      if (!caseRecord) {
        return this.failure<Case>(
          'CASE_NOT_FOUND',
          'Case not found for this organization',
          { organizationId, caseId },
        );
      }

      const currentStatus = caseRecord.status as CaseStatus;

      if (!this.isValidStatusTransition(currentStatus, newStatus)) {
        return this.failure<Case>(
          'INVALID_CASE_STATE_TRANSITION',
          `Transition ${currentStatus} → ${newStatus} is not allowed`,
          { organizationId, caseId },
        );
      }

      const updated = await this.prisma.case.update({
        where: { id: caseRecord.id },
        data: {
          status: newStatus,
        },
      });

      void this.logService.logEvent({
        category: 'SYSTEM',
        level: 'INFO',
        message: 'Case status updated',
        identifier: `case_id:${updated.id}`,
        metadata: {
          organizationId: updated.organizationId,
          oldStatus: currentStatus,
          newStatus,
          functionId: 'FN_CASE_UPDATE_STATUS',
        },
      });

      return this.success(updated);
    } catch (error) {
      void this.logService.logEvent({
        category: 'SYSTEM',
        level: 'ERROR',
        message: 'Failed to update case status',
        metadata: {
          organizationId,
          caseId,
          newStatus,
          error: this.safeErrorToString(error),
          functionId: 'FN_CASE_UPDATE_STATUS',
        },
      });

      return this.failure<Case>(
        'CASE_UPDATE_STATUS_ERROR',
        'Failed to update case status',
        error,
      );
    }
  }

  // ---------------------------------------------------------------------------
  // Helpers
  // ---------------------------------------------------------------------------

  private validateCreateCaseInput(
    input: CreateCaseFromSignalInput,
  ): ServiceError | null {
    const missing: string[] = [];

    if (!input.organizationId) missing.push('organizationId');
    if (!input.sourceType) missing.push('sourceType');
    if (!input.label) missing.push('label');
    if (!input.title) missing.push('title');
    if (!input.description) missing.push('description');
    if (!input.severity) missing.push('severity');

    if (missing.length > 0) {
      return {
        code: 'CASE_VALIDATION_ERROR',
        message: `Missing required fields: ${missing.join(', ')}`,
        details: { missingFields: missing },
      };
    }

    return null;
  }

  private normalizeSeverity(severity: string): CaseSeverity {
    const value = severity.trim();

    if (!value) {
      throw new Error('Severity must not be empty');
    }

    const lower = value.toLowerCase();

    // Historical mapping: "info" -> MINOR (Doc 1/2).
    if (lower === 'info') {
      return 'MINOR';
    }

    const upper = lower.toUpperCase() as CaseSeverity;

    if (upper === 'MINOR' || upper === 'MODERATE' || upper === 'MAJOR' || upper === 'CRITICAL') {
      return upper;
    }

    throw new Error(`Invalid case severity: ${severity}`);
  }

  private normalizeSourceType(
    sourceType: string,
  ): 'email' | 'api' | 'manual' | 'sync' {
    const value = sourceType.trim();

    if (!value) {
      throw new Error('sourceType must not be empty');
    }

    const lower = value.toLowerCase();

    // Historical mappings (Doc 1 §Enum implementation notes).
    if (lower === 'ui') return 'manual';
    if (lower === 'import') return 'sync';
    if (lower === 'insight') return 'api';

    if (lower === 'email' || lower === 'api' || lower === 'manual' || lower === 'sync') {
      return lower;
    }

    throw new Error(`Invalid case sourceType: ${sourceType}`);
  }

  /**
   * Convert seconds to an ISO-8601 duration string (e.g. 3600 -> "PT3600S").
   * DB stores reactivityTime as an interval; the exact mapping is handled at schema level.
   */
  private secondsToIsoDuration(seconds: number): string {
    const s = Math.max(0, Math.floor(seconds));
    return `PT${s}S`;
  }

  private isValidStatusTransition(
    from: CaseStatus,
    to: CaseStatus,
  ): boolean {
    if (from === to) {
      // No-op transitions are allowed but usually pointless; treat as valid.
      return true;
    }

    switch (from) {
      case 'open':
        return to === 'in_progress' || to === 'resolved' || to === 'archived';
      case 'in_progress':
        return to === 'resolved' || to === 'archived';
      case 'resolved':
        return to === 'archived' || to === 'in_progress';
      case 'archived':
        // archived is terminal in normal flows
        return false;
      default:
        return false;
    }
  }

  private success<T>(data: T): ServiceResult<T> {
    return {
      ok: true,
      data,
      error: null,
    };
  }

  private failure<T>(
    code: string,
    message: string,
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    details?: any,
  ): ServiceResult<T> {
    return {
      ok: false,
      data: null,
      error: { code, message, details },
    };
  }

  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  private safeErrorToString(error: any): string {
    if (!error) return 'Unknown error';
    if (error instanceof Error) return error.message;
    if (typeof error === 'string') return error;
    try {
      return JSON.stringify(error);
    } catch {
      return 'Unserializable error';
    }
  }
}

===== END apps/api/src/orgo/core/cases/case.service.ts =====


===== BEGIN apps/api/src/orgo/core/cases/dto/create-case.dto.ts =====
// apps/api/src/orgo/core/cases/dto/create-case.dto.ts

import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';
import { Transform } from 'class-transformer';
import {
  IsArray,
  IsIn,
  IsInt,
  IsNotEmpty,
  IsObject,
  IsOptional,
  IsString,
  IsUUID,
  MaxLength,
  Min,
  Matches,
} from 'class-validator';

// Canonical enums for Cases (JSON-facing, aligned with Docs 1/2/8)
export const CASE_SOURCE_TYPES = ['email', 'api', 'manual', 'sync'] as const;
export type CaseSourceType = (typeof CASE_SOURCE_TYPES)[number];

export const CASE_SEVERITIES = ['minor', 'moderate', 'major', 'critical'] as const;
export type CaseSeverity = (typeof CASE_SEVERITIES)[number];

// Canonical label shape: "<BASE>.<CATEGORY><SUBCATEGORY>.<HORIZONTAL_ROLE?>"
// BASE: integer (e.g. 1, 11, 100, 1000)
// CATEGORY: 1–9, SUBCATEGORY: 1–5  → encoded as two digits [1-9][1-5]
// HORIZONTAL_ROLE: dot‑separated segments like "Ops.Maintenance"
export const LABEL_CODE_REGEX =
  /^\d+\.[1-9][1-5](?:\.[A-Za-z0-9]+(?:\.[A-Za-z0-9]+)*)?$/;

export class CreateCaseDto {
  @ApiProperty({
    description: 'Tenant organization identifier (UUID; maps to organizations.id).',
    format: 'uuid',
  })
  @IsUUID()
  organization_id!: string;

  @ApiProperty({
    description:
      'Origin channel for the Case (maps to cases.source_type / task_source_enum).',
    enum: CASE_SOURCE_TYPES,
    example: 'email',
  })
  @Transform(({ value }) =>
    typeof value === 'string' ? value.toLowerCase().trim() : value,
  )
  @IsIn(CASE_SOURCE_TYPES)
  source_type!: CaseSourceType;

  @ApiPropertyOptional({
    description:
      'Channel-specific reference (e.g. email message-id, external URI).',
    nullable: true,
    example: '<message-id@example.org>',
  })
  @Transform(({ value }) => (value === null ? undefined : value))
  @IsString()
  @IsOptional()
  source_reference?: string;

  @ApiProperty({
    description:
      'Canonical information label "<BASE>.<CATEGORY><SUBCATEGORY>.<HORIZONTAL_ROLE?>".',
    example: '100.94.Operations.Safety',
  })
  @Transform(({ value }) => (typeof value === 'string' ? value.trim() : value))
  @IsString()
  @IsNotEmpty()
  @Matches(LABEL_CODE_REGEX, {
    message:
      'label must match "<BASE>.<CATEGORY><SUBCATEGORY>.<HORIZONTAL_ROLE?>" (e.g. "100.94.Operations.Safety")',
  })
  label!: string;

  @ApiProperty({
    description: 'Short human-readable title for the Case.',
    maxLength: 512,
    example: 'Wet floor in main hallway near gym entrance',
  })
  @Transform(({ value }) => (typeof value === 'string' ? value.trim() : value))
  @IsString()
  @IsNotEmpty()
  @MaxLength(512)
  title!: string;

  @ApiProperty({
    description: 'Detailed description or narrative for the Case.',
    example:
      'Student slipped on wet floor near the gym entrance. No serious injury, but repeated incidents reported over the past month.',
  })
  @Transform(({ value }) => (typeof value === 'string' ? value.trim() : value))
  @IsString()
  @IsNotEmpty()
  description!: string;

  @ApiProperty({
    description:
      'Case severity (JSON form of TASK_SEVERITY; lower-case tokens map to DB enum).',
    enum: CASE_SEVERITIES,
    example: 'major',
  })
  @Transform(({ value }) =>
    typeof value === 'string' ? value.toLowerCase().trim() : value,
  )
  @IsIn(CASE_SEVERITIES)
  severity!: CaseSeverity;

  @ApiPropertyOptional({
    description:
      'ISO‑8601 duration for expected responsiveness window (e.g. "PT2H").',
    nullable: true,
    example: 'PT2H',
  })
  @Transform(({ value }) => (value === null ? undefined : value))
  @IsString()
  @IsOptional()
  reactivity_time?: string;

  @ApiPropertyOptional({
    description:
      'Vertical base from the original label (e.g. 100, 1000); used for cyclic overview and broadcast semantics.',
    nullable: true,
    example: 1000,
  })
  @Transform(({ value }) => (value === null ? undefined : value))
  @IsInt()
  @Min(1)
  @IsOptional()
  origin_vertical_level?: number;

  @ApiPropertyOptional({
    description:
      'Horizontal role of origin (e.g. "Ops.Maintenance", "HR.CaseOfficer").',
    nullable: true,
    example: 'Ops.Maintenance',
  })
  @Transform(({ value }) =>
    typeof value === 'string' ? value.trim() : value === null ? undefined : value,
  )
  @IsString()
  @IsOptional()
  origin_role?: string;

  @ApiPropertyOptional({
    description:
      'High-level classification tags for the Case (e.g. ["safety","wet_floor"]).',
    nullable: true,
    type: [String],
    example: ['safety', 'facility', 'wet_floor'],
  })
  @Transform(({ value }) => (value === null ? undefined : value))
  @IsArray()
  @IsString({ each: true })
  @IsOptional()
  tags?: string[];

  @ApiPropertyOptional({
    description:
      'Structured location information (site, building, GPS, etc.). Shape is domain-specific.',
    nullable: true,
    example: {
      site: 'North Campus',
      building: 'Gym',
      floor: 1,
      area: 'Main entrance corridor',
    },
  })
  @Transform(({ value }) => (value === null ? undefined : value))
  @IsObject()
  @IsOptional()
  location?: Record<string, any>;

  @ApiPropertyOptional({
    description:
      'Case-level metadata (pattern_sensitivity, review settings, visibility, escalation path, profile hints, etc.).',
    nullable: true,
    example: {
      visibility: 'internal',
      pattern_sensitivity: 'high',
      review_frequency: 'monthly',
    },
  })
  @Transform(({ value }) => (value === null ? undefined : value))
  @IsObject()
  @IsOptional()
  metadata?: Record<string, any>;
}

===== END apps/api/src/orgo/core/cases/dto/create-case.dto.ts =====


===== BEGIN apps/api/src/orgo/core/cases/dto/update-case-status.dto.ts =====
import { ApiProperty } from '@nestjs/swagger';
import { IsIn, IsOptional, IsString, MaxLength } from 'class-validator';

export const CASE_STATUS_VALUES = [
  'open',
  'in_progress',
  'resolved',
  'archived',
] as const;

export type CaseStatus = (typeof CASE_STATUS_VALUES)[number];

export class UpdateCaseStatusDto {
  @ApiProperty({
    description: 'New status for the Case.',
    enum: CASE_STATUS_VALUES,
    example: 'resolved',
  })
  @IsString()
  @IsIn(CASE_STATUS_VALUES, {
    message: `status must be one of: ${CASE_STATUS_VALUES.join(', ')}`,
  })
  status!: CaseStatus;

  @ApiProperty({
    description:
      'Optional human-readable reason explaining why the status is changing. ' +
      'For example, reasons for archiving as out-of-scope, duplicate, or spam.',
    required: false,
    maxLength: 2000,
  })
  @IsOptional()
  @IsString()
  @MaxLength(2000)
  reason?: string;
}

===== END apps/api/src/orgo/core/cases/dto/update-case-status.dto.ts =====


===== BEGIN apps/api/src/orgo/core/database/database.service.ts =====
import { Injectable, Logger } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { PrismaClient } from '@prisma/client';
import { PrismaService } from '../../../persistence/prisma/prisma.service';

export type DatabaseMode = 'ONLINE' | 'OFFLINE';

export type OrgoErrorCode =
  | 'DB_CONFIG_ERROR'
  | 'DB_UNKNOWN_TABLE'
  | 'DB_QUERY_FAILED'
  | 'UNSUPPORTED_DB_MODE';

export interface OrgoError {
  code: OrgoErrorCode;
  message: string;
  details?: Record<string, unknown>;
}

/**
 * Standard Orgo result shape (Doc 5 §2.4).
 * ok: true  -> data is set, error is null
 * ok: false -> data is null, error is set
 */
export interface OrgoResult<T> {
  ok: boolean;
  data: T | null;
  error: OrgoError | null;
}

/**
 * Core Database Service for Orgo v3.
 *
 * Responsibilities (Doc 4 & Doc 5):
 * - Provide a single, central entry point to the Prisma client:
 *     DatabaseService.getPrismaClient()
 * - Implement logical persistence helpers:
 *     connectToDatabase, fetchRecords, insertRecord, updateRecord
 * - Align with the standard Orgo result shape for all operations.
 *
 * Notes:
 * - ONLINE mode uses Postgres via Prisma and DATABASE_URL (validated by ConfigModule).
 * - OFFLINE mode (SQLite) is not implemented in this starter and will return UNSUPPORTED_DB_MODE.
 */
@Injectable()
export class DatabaseService {
  private readonly logger = new Logger(DatabaseService.name);

  /**
   * Underlying Prisma client.
   * PrismaService is already configured to connect using DATABASE_URL and
   * calls $connect() in its own onModuleInit hook.
   */
  private readonly prisma: PrismaService;

  /**
   * Cached database URL, primarily for diagnostics and downstream utilities.
   */
  private readonly databaseUrl: string;

  private hasConnected = false;

  constructor(
    prismaService: PrismaService,
    private readonly configService: ConfigService,
  ) {
    this.prisma = prismaService;

    // DATABASE_URL is validated at startup by ConfigModule (environment-variables.ts),
    // but we defensively re-check here for clarity.
    const url = this.configService.get<string>('DATABASE_URL');
    if (!url) {
      this.logger.error(
        'DATABASE_URL is not set. Check your environment (.env) configuration.',
      );
      throw new Error('DATABASE_URL is required but was not provided.');
    }

    this.databaseUrl = url;
  }

  /**
   * Canonical entry point for anything that needs direct Prisma access.
   *
   * Functional inventory reference:
   *   Core Services / Database Ops → DatabaseService.getPrismaClient
   *   (Doc 4 – Functional Code‑Name Inventory) :contentReference[oaicite:0]{index=0}
   */
  getPrismaClient(): PrismaClient {
    return this.prisma;
  }

  /**
   * Returns the DATABASE_URL used by Prisma, for diagnostics / health checks.
   */
  getDatabaseUrl(): string {
    return this.databaseUrl;
  }

  /**
   * Connect to the database in the requested mode.
   *
   * Logical contract from Doc 5 §8.3 (connect_to_database). :contentReference[oaicite:1]{index=1}
   *
   * In this starter:
   * - Only ONLINE (Postgres via Prisma) is supported.
   * - OFFLINE (SQLite) is not implemented yet and will throw.
   */
  async connectToDatabase(
    mode: DatabaseMode = 'ONLINE',
  ): Promise<PrismaClient> {
    if (mode === 'OFFLINE') {
      this.logger.error(
        "Database mode 'OFFLINE' requested, but offline/SQLite support is not implemented in this build.",
      );
      throw new Error(
        "Database mode 'OFFLINE' is not supported in this deployment.",
      );
    }

    if (!this.hasConnected) {
      await this.prisma.$connect();
      this.hasConnected = true;
      this.logger.log('Successfully connected to the primary database (ONLINE).');
    }

    return this.prisma;
  }

  /**
   * Fetch records from a logical table / Prisma model.
   *
   * Logical contract from Doc 5 §8.3 (fetch_records). :contentReference[oaicite:2]{index=2}
   *
   * This uses Prisma delegates dynamically:
   *   const delegate = (prisma as any)[table];
   *   delegate.findMany({ where })
   *
   * @param table Prisma model name (e.g. "user", "tasks", "cases").
   * @param where Optional filter object (Prisma "where" clause).
   * @param mode  ONLINE/ OFFLINE (ONLINE only in this build).
   */
  async fetchRecords<T = unknown>(
    table: string,
    where?: Record<string, unknown>,
    mode: DatabaseMode = 'ONLINE',
  ): Promise<OrgoResult<T[]>> {
    if (mode === 'OFFLINE') {
      return {
        ok: false,
        data: null,
        error: {
          code: 'UNSUPPORTED_DB_MODE',
          message:
            "Database mode 'OFFLINE' is not supported in this deployment.",
          details: { table, mode },
        },
      };
    }

    try {
      await this.connectToDatabase('ONLINE');

      const delegate = (this.prisma as any)[table];
      if (!delegate || typeof delegate.findMany !== 'function') {
        return {
          ok: false,
          data: null,
          error: {
            code: 'DB_UNKNOWN_TABLE',
            message: `Prisma model '${table}' does not exist on the Prisma client.`,
            details: { table },
          },
        };
      }

      const rows = await delegate.findMany({
        // Prisma treats undefined as "not provided"; passing an empty object is also fine.
        where: where ?? {},
      });

      return {
        ok: true,
        data: rows as T[],
        error: null,
      };
    } catch (err) {
      const error = err as Error;
      this.logger.error(
        `Failed to fetch records from table '${table}': ${error.message}`,
        error.stack,
      );

      return {
        ok: false,
        data: null,
        error: {
          code: 'DB_QUERY_FAILED',
          message: 'Failed to fetch records from the database.',
          details: {
            table,
            where,
            error: error.message,
          },
        },
      };
    }
  }

  /**
   * Insert a record into a logical table / Prisma model.
   *
   * Logical contract from Doc 5 §8.3 (insert_record). :contentReference[oaicite:3]{index=3}
   *
   * @param table Prisma model name.
   * @param data  Data object matching the Prisma model "create" input.
   * @param mode  ONLINE/ OFFLINE (ONLINE only in this build).
   */
  async insertRecord<T = unknown>(
    table: string,
    data: Record<string, unknown>,
    mode: DatabaseMode = 'ONLINE',
  ): Promise<OrgoResult<T>> {
    if (mode === 'OFFLINE') {
      return {
        ok: false,
        data: null,
        error: {
          code: 'UNSUPPORTED_DB_MODE',
          message:
            "Database mode 'OFFLINE' is not supported in this deployment.",
          details: { table, mode },
        },
      };
    }

    try {
      await this.connectToDatabase('ONLINE');

      const delegate = (this.prisma as any)[table];
      if (!delegate || typeof delegate.create !== 'function') {
        return {
          ok: false,
          data: null,
          error: {
            code: 'DB_UNKNOWN_TABLE',
            message: `Prisma model '${table}' does not exist on the Prisma client.`,
            details: { table },
          },
        };
      }

      const created = await delegate.create({ data });

      return {
        ok: true,
        data: created as T,
        error: null,
      };
    } catch (err) {
      const error = err as Error;
      this.logger.error(
        `Failed to insert record into table '${table}': ${error.message}`,
        error.stack,
      );

      return {
        ok: false,
        data: null,
        error: {
          code: 'DB_QUERY_FAILED',
          message: 'Failed to insert record into the database.',
          details: {
            table,
            data,
            error: error.message,
          },
        },
      };
    }
  }

  /**
   * Update a record in a logical table / Prisma model.
   *
   * Logical contract from Doc 5 §8.3 (update_record). :contentReference[oaicite:4]{index=4}
   *
   * @param table   Prisma model name.
   * @param key     Primary key / unique key filter (Prisma "where" clause).
   * @param updates Partial data to update (Prisma "data" clause).
   * @param mode    ONLINE/ OFFLINE (ONLINE only in this build).
   */
  async updateRecord<T = unknown>(
    table: string,
    key: Record<string, unknown>,
    updates: Record<string, unknown>,
    mode: DatabaseMode = 'ONLINE',
  ): Promise<OrgoResult<T>> {
    if (mode === 'OFFLINE') {
      return {
        ok: false,
        data: null,
        error: {
          code: 'UNSUPPORTED_DB_MODE',
          message:
            "Database mode 'OFFLINE' is not supported in this deployment.",
          details: { table, mode },
        },
      };
    }

    try {
      await this.connectToDatabase('ONLINE');

      const delegate = (this.prisma as any)[table];
      if (!delegate || typeof delegate.update !== 'function') {
        return {
          ok: false,
          data: null,
          error: {
            code: 'DB_UNKNOWN_TABLE',
            message: `Prisma model '${table}' does not exist on the Prisma client.`,
            details: { table },
          },
        };
      }

      const updated = await delegate.update({
        where: key,
        data: updates,
      });

      return {
        ok: true,
        data: updated as T,
        error: null,
      };
    } catch (err) {
      const error = err as Error;
      this.logger.error(
        `Failed to update record in table '${table}': ${error.message}`,
        error.stack,
      );

      return {
        ok: false,
        data: null,
        error: {
          code: 'DB_QUERY_FAILED',
          message: 'Failed to update record in the database.',
          details: {
            table,
            key,
            updates,
            error: error.message,
          },
        },
      };
    }
  }
}

===== END apps/api/src/orgo/core/database/database.service.ts =====


===== BEGIN apps/api/src/orgo/core/database/repository-factory.service.ts =====
import { Injectable, Logger } from '@nestjs/common';
import { Prisma } from '@prisma/client';
import { PrismaService } from '../../../persistence/prisma/prisma.service';

export type OrgoEntity = Prisma.ModelName;

export interface OrgoRepository<TRecord = any> {
  /**
   * Generic passthrough to Prisma `<model>.findMany` with optional tenant enforcement.
   */
  findMany(args?: any, organizationIdOverride?: string): Promise<TRecord[]>;

  /**
   * Generic passthrough to Prisma `<model>.findFirst` with optional tenant enforcement.
   */
  findFirst(args?: any, organizationIdOverride?: string): Promise<TRecord | null>;

  /**
   * Generic passthrough to Prisma `<model>.findUnique` with optional tenant enforcement.
   */
  findUnique(args: any, organizationIdOverride?: string): Promise<TRecord | null>;

  /**
   * Convenience helper for the common `id` + `organization_id` pattern.
   */
  findById(
    id: string,
    options?: {
      organizationId?: string;
      select?: any;
      include?: any;
    },
  ): Promise<TRecord | null>;

  /**
   * Generic passthrough to Prisma `<model>.create` with tenant enforcement on `data.organization_id`.
   */
  create(args: any, organizationIdOverride?: string): Promise<TRecord>;

  /**
   * Generic passthrough to Prisma `<model>.createMany` with tenant enforcement on each item in `data`.
   */
  createMany(
    args: any,
    organizationIdOverride?: string,
  ): Promise<Prisma.BatchPayload>;

  /**
   * Generic passthrough to Prisma `<model>.update` with optional tenant enforcement on `where` + `data`.
   */
  update(args: any, organizationIdOverride?: string): Promise<TRecord>;

  /**
   * Generic passthrough to Prisma `<model>.updateMany` with optional tenant enforcement on `where` + `data`.
   */
  updateMany(
    args: any,
    organizationIdOverride?: string,
  ): Promise<Prisma.BatchPayload>;

  /**
   * Generic passthrough to Prisma `<model>.delete` with optional tenant enforcement on `where`.
   */
  delete(args: any, organizationIdOverride?: string): Promise<TRecord>;

  /**
   * Generic passthrough to Prisma `<model>.deleteMany` with optional tenant enforcement on `where`.
   */
  deleteMany(
    args: any,
    organizationIdOverride?: string,
  ): Promise<Prisma.BatchPayload>;
}

/**
 * RepositoryFactoryService
 *
 * Central factory for Orgo repositories. It wraps Prisma model delegates and:
 * - Provides a consistent `.getRepository(entity)` entry point.
 * - Enforces multi‑tenant scoping by injecting `organization_id` where requested.
 * - Adds simple helpers like `findById`.
 *
 * It is intentionally light on TypeScript generics so it can work across all
 * Orgo entities without needing to update this file when new Prisma models
 * are added.
 */
@Injectable()
export class RepositoryFactoryService {
  private readonly logger = new Logger(RepositoryFactoryService.name);

  constructor(private readonly prisma: PrismaService) {}

  /**
   * Returns a repository wrapper for the given Prisma model name.
   *
   * Example usage:
   *
   *   const tasksRepo = repositoryFactory.getRepository('Task', orgId);
   *   const tasks = await tasksRepo.findMany({ where: { status: 'PENDING' } });
   */
  getRepository<TRecord = any>(
    entity: OrgoEntity,
    organizationId?: string,
  ): OrgoRepository<TRecord> {
    const delegate = this.getDelegate(entity);
    const baseOrgId = organizationId;

    const applyOrgFilter = (where: any, orgOverride?: string) =>
      this.applyOrganizationFilter(where, orgOverride ?? baseOrgId);

    const applyOrgToCreateArgs = (args: any, orgOverride?: string) =>
      this.applyOrganizationToCreateArgs(args, orgOverride ?? baseOrgId);

    const applyOrgToUpdateArgs = (args: any, orgOverride?: string) =>
      this.applyOrganizationToUpdateArgs(args, orgOverride ?? baseOrgId);

    const repo: OrgoRepository<TRecord> = {
      findMany: async (args: any = {}, orgOverride?: string) => {
        const prismaArgs = { ...(args || {}) };
        prismaArgs.where = applyOrgFilter(prismaArgs.where, orgOverride);
        return delegate.findMany(prismaArgs);
      },

      findFirst: async (args: any = {}, orgOverride?: string) => {
        const prismaArgs = { ...(args || {}) };
        prismaArgs.where = applyOrgFilter(prismaArgs.where, orgOverride);
        return delegate.findFirst(prismaArgs);
      },

      findUnique: async (args: any, orgOverride?: string) => {
        const prismaArgs = { ...(args || {}) };
        prismaArgs.where = applyOrgFilter(prismaArgs.where, orgOverride);
        return delegate.findUnique(prismaArgs);
      },

      findById: async (
        id: string,
        options?: { organizationId?: string; select?: any; include?: any },
      ) => {
        const targetOrgId = options?.organizationId ?? baseOrgId;
        const where = applyOrgFilter({ id }, targetOrgId);
        const prismaArgs: any = {
          where,
          ...(options?.select ? { select: options.select } : {}),
          ...(options?.include ? { include: options.include } : {}),
        };
        return delegate.findUnique(prismaArgs);
      },

      create: async (args: any, orgOverride?: string) => {
        const prismaArgs = applyOrgToCreateArgs(args || {}, orgOverride);
        return delegate.create(prismaArgs);
      },

      createMany: async (args: any, orgOverride?: string) => {
        const prismaArgs = applyOrgToCreateArgs(args || {}, orgOverride);
        return delegate.createMany(prismaArgs);
      },

      update: async (args: any, orgOverride?: string) => {
        const prismaArgs = applyOrgToUpdateArgs(args || {}, orgOverride);
        prismaArgs.where = applyOrgFilter(prismaArgs.where, orgOverride);
        return delegate.update(prismaArgs);
      },

      updateMany: async (args: any, orgOverride?: string) => {
        const prismaArgs = applyOrgToUpdateArgs(args || {}, orgOverride);
        prismaArgs.where = applyOrgFilter(prismaArgs.where, orgOverride);
        return delegate.updateMany(prismaArgs);
      },

      delete: async (args: any, orgOverride?: string) => {
        const prismaArgs = { ...(args || {}) };
        prismaArgs.where = applyOrgFilter(prismaArgs.where, orgOverride);
        return delegate.delete(prismaArgs);
      },

      deleteMany: async (args: any, orgOverride?: string) => {
        const prismaArgs = { ...(args || {}) };
        prismaArgs.where = applyOrgFilter(prismaArgs.where, orgOverride);
        return delegate.deleteMany(prismaArgs);
      },
    };

    return repo;
  }

  /**
   * Resolves a Prisma model delegate (e.g. `prisma.task`, `prisma.case`) from
   * a Prisma model name (e.g. `"Task"`, `"Case"`).
   */
  private getDelegate(entity: OrgoEntity): any {
    const delegatePropertyName =
      entity.charAt(0).toLowerCase() + entity.slice(1);

    const delegate = (this.prisma as any)[delegatePropertyName];

    if (!delegate) {
      const message = `No Prisma delegate found for entity "${entity}" (expected property "${delegatePropertyName}" on PrismaService)`;
      this.logger.error(message);
      throw new Error(message);
    }

    return delegate;
  }

  /**
   * Injects `organization_id` into `where` clauses when an organizationId is
   * provided. If `organization_id` is already present with a different value,
   * it throws to prevent cross‑tenant leakage.
   */
  private applyOrganizationFilter(
    originalWhere: any | undefined,
    organizationId?: string,
  ): any | undefined {
    if (!organizationId) {
      return originalWhere;
    }

    if (originalWhere == null) {
      return { organization_id: organizationId };
    }

    if (typeof originalWhere !== 'object') {
      return originalWhere;
    }

    if ('organization_id' in originalWhere) {
      const existing = (originalWhere as any).organization_id;

      if (existing && existing !== organizationId) {
        const message =
          'Cross-tenant query prevented: where.organization_id does not match requested organizationId.';
        this.logger.error(message);
        throw new Error(message);
      }

      return { ...originalWhere, organization_id: existing ?? organizationId };
    }

    return { ...originalWhere, organization_id: organizationId };
  }

  /**
   * Injects `organization_id` into `create` payloads (including createMany)
   * when an organizationId is provided. If `organization_id` is already set
   * to a different value on any item, it throws.
   */
  private applyOrganizationToCreateArgs(
    args: any,
    organizationId?: string,
  ): any {
    if (!organizationId || !args || typeof args !== 'object') {
      return args;
    }

    if (!('data' in args)) {
      return args;
    }

    const originalData = (args as any).data;

    if (Array.isArray(originalData)) {
      const data = originalData.map((item) =>
        this.applyOrganizationToData(item, organizationId),
      );
      return { ...args, data };
    }

    const data = this.applyOrganizationToData(originalData, organizationId);
    return { ...args, data };
  }

  /**
   * Injects `organization_id` into `update` payloads where a row is org‑scoped.
   * This primarily ensures we don't accidentally move a record between tenants.
   */
  private applyOrganizationToUpdateArgs(
    args: any,
    organizationId?: string,
  ): any {
    if (!organizationId || !args || typeof args !== 'object') {
      return args;
    }

    if (!('data' in args)) {
      return args;
    }

    const originalData = (args as any).data;
    const data = this.applyOrganizationToData(originalData, organizationId);
    return { ...args, data };
  }

  /**
   * Helper to apply `organization_id` to a single data object.
   */
  private applyOrganizationToData(
    originalData: any,
    organizationId: string,
  ): any {
    if (!originalData || typeof originalData !== 'object') {
      return originalData;
    }

    if ('organization_id' in originalData) {
      const existing = (originalData as any).organization_id;

      if (existing && existing !== organizationId) {
        const message =
          'Cross-tenant write prevented: data.organization_id does not match requested organizationId.';
        this.logger.error(message);
        throw new Error(message);
      }

      return {
        ...originalData,
        organization_id: existing ?? organizationId,
      };
    }

    return {
      ...originalData,
      organization_id: organizationId,
    };
  }
}

===== END apps/api/src/orgo/core/database/repository-factory.service.ts =====


===== BEGIN apps/api/src/orgo/core/email/email-ingest.service.ts =====
import {
  Inject,
  Injectable,
  Logger,
  Optional,
} from '@nestjs/common';
import * as crypto from 'crypto';

import { PersistenceService } from '../persistence/persistence.service';
import { EmailParserService } from './email-parser.service';
import { EmailValidatorService } from './email-validator.service';
import { EmailRouterService } from './email-router.service';
import { LogService } from '../logging/log.service';

/**
 * Injection token for the low‑level mailbox client (IMAP/POP/etc.).
 * A concrete implementation should be registered against this token.
 */
export const EMAIL_MAILBOX_CLIENT = Symbol('EMAIL_MAILBOX_CLIENT');

/**
 * Injection token for attachment storage (e.g. S3, GCS, local FS).
 */
export const EMAIL_ATTACHMENT_STORAGE = Symbol('EMAIL_ATTACHMENT_STORAGE');

/**
 * Standard error shape used across Core Services.
 */
export interface StandardError {
  code: string;
  message: string;
  details?: Record<string, unknown>;
}

/**
 * Standard result shape (`ok` / `data` / `error`) – locked for v3 Core Services.
 */
export interface StandardResult<T> {
  ok: boolean;
  data: T | null;
  error: StandardError | null;
}

/**
 * Connection information for an IMAP/POP mailbox.
 * Concrete mailbox clients can extend this via intersection types if needed.
 */
export interface MailboxConnectionOptions {
  host: string;
  port: number;
  useSsl: boolean;
  username: string;
  password: string;
  folder: string;
}

/**
 * Raw email as returned by the mailbox client before parsing.
 */
export interface MailboxRawEmail {
  remoteId: string;
  raw: Buffer | string;
  receivedAt?: Date;
  sizeBytes?: number;
}

/**
 * Raw email with multi‑tenant context attached (org + config).
 * This is what we pass into the EmailParserService.
 */
export interface RawEmail extends MailboxRawEmail {
  organizationId: string;
  emailAccountConfigId: string;
}

/**
 * Canonical parsed email payload compatible with the `email_messages` /
 * `email_threads` tables and the EMAIL_MESSAGE logical view.
 */
export interface ParsedEmail {
  organizationId: string;
  emailAccountConfigId: string;

  externalThreadKey?: string | null;
  messageIdHeader?: string | null;
  direction: 'inbound' | 'outbound';

  fromAddress: string;
  toAddresses: string[];
  ccAddresses?: string[];
  bccAddresses?: string[];

  subject: string;
  receivedAt?: Date | null;
  sentAt?: Date | null;

  rawHeaders?: string | null;
  textBody?: string | null;
  htmlBody?: string | null;

  sensitivity?: 'normal' | 'sensitive' | 'highly_sensitive';

  attachments?: ParsedEmailAttachment[];
}

/**
 * Parsed attachment; the storage backend will receive `content` and return
 * a storage key that we store in `email_attachments`.
 */
export interface ParsedEmailAttachment {
  fileName: string;
  mimeType: string;
  sizeBytes: number;
  content: Buffer;
  checksum?: string;
}

/**
 * Low‑level mailbox client abstraction. A concrete implementation should hide
 * IMAP/POP details and return MailboxRawEmail objects.
 */
export interface MailboxClient {
  fetchUnreadMessages(
    connection: MailboxConnectionOptions,
    maxMessages: number,
  ): Promise<MailboxRawEmail[]>;

  /**
   * Optional hook to mark messages as processed on the remote server.
   * Implementations may no‑op if they rely on server‑side flags already.
   */
  markMessagesAsProcessed?(
    connection: MailboxConnectionOptions,
    remoteIds: string[],
  ): Promise<void>;
}

/**
 * Attachment storage abstraction; concrete implementations can use S3, GCS, etc.
 */
export interface EmailAttachmentStorage {
  saveAttachment(
    storageKey: string,
    content: Buffer,
    metadata: { mimeType: string; sizeBytes: number },
  ): Promise<void>;
}

/**
 * Allowed event types in `email_processing_events`.
 */
export type EmailProcessingEventType =
  | 'parsed'
  | 'classification_succeeded'
  | 'classification_failed'
  | 'task_created'
  | 'linked_to_existing_task'
  | 'dropped';

/**
 * Shape of an `email_account_configs` row as used by this service.
 * Field names match the DB schema.
 */
export interface EmailAccountConfigRecord {
  id: string;
  organization_id: string;
  label: string;
  imap_host: string;
  imap_port: number;
  imap_use_ssl: boolean;
  smtp_host: string;
  smtp_port: number;
  smtp_use_ssl: boolean;
  username: string;
  encrypted_password: string;
  polling_interval_seconds: number;
  last_successful_poll_at: Date | null;
  is_active: boolean;
}

/**
 * Per‑batch ingestion summary – mirrors what we track in `email_ingestion_batches`.
 */
export interface EmailIngestionBatchResult {
  batchId: string;
  emailAccountConfigId: string;
  organizationId: string;
  totalFetched: number;
  persistedMessages: number;
  failedMessages: number;
  status: 'completed' | 'failed';
  errorSummary?: string;
}

/**
 * Options for polling mailboxes.
 *
 * If `emailAccountConfigId` is provided, only that account is polled.
 * If `organizationId` is provided, all active accounts for that org are polled.
 * If neither is provided, all active accounts are polled (multi‑tenant).
 */
export interface PollMailboxOptions {
  organizationId?: string;
  emailAccountConfigId?: string;
  maxMessages?: number;
}

@Injectable()
export class EmailIngestService {
  private readonly logger = new Logger(EmailIngestService.name);

  constructor(
    private readonly persistence: PersistenceService,
    private readonly emailParser: EmailParserService,
    private readonly emailValidator: EmailValidatorService,
    private readonly emailRouter: EmailRouterService,
    private readonly logService: LogService,
    @Inject(EMAIL_MAILBOX_CLIENT)
    private readonly mailboxClient: MailboxClient,
    @Optional()
    @Inject(EMAIL_ATTACHMENT_STORAGE)
    private readonly attachmentStorage?: EmailAttachmentStorage,
  ) {}

  /**
   * Polls one or more mailboxes based on the provided options and ingests new
   * messages into `email_messages` / `email_attachments`, recording a row in
   * `email_ingestion_batches` for each polled account.
   */
  async pollMailbox(
    options: PollMailboxOptions = {},
  ): Promise<StandardResult<EmailIngestionBatchResult[]>> {
    const maxMessages = options.maxMessages ?? 50;

    try {
      const where: Record<string, unknown> = {
        is_active: true,
      };

      if (options.emailAccountConfigId) {
        where.id = options.emailAccountConfigId;
      }

      if (options.organizationId) {
        where.organization_id = options.organizationId;
      }

      const configsResult = await this.persistence.fetchRecords(
        'email_account_configs',
        where,
      );

      if (!configsResult.ok || !configsResult.data) {
        const error: StandardError = {
          code: 'EMAIL_INGEST_CONFIG_FETCH_FAILED',
          message: 'Failed to load email account configurations for polling',
          details: configsResult.error ?? undefined,
        };

        this.logService.logEvent({
          category: 'EMAIL',
          logLevel: 'ERROR',
          message: error.message,
          identifier: 'email_ingest:pollMailbox',
          metadata: { where, error },
        });

        return {
          ok: false,
          data: null,
          error,
        };
      }

      const configs = configsResult.data as EmailAccountConfigRecord[];

      if (!configs.length) {
        // Nothing to do – treat as success with an empty result set.
        return {
          ok: true,
          data: [],
          error: null,
        };
      }

      const batchResults: EmailIngestionBatchResult[] = [];

      for (const config of configs) {
        const batchResult = await this.ingestForAccountConfig(
          config,
          maxMessages,
        );
        batchResults.push(batchResult);
      }

      const anyFailed = batchResults.some(
        (result) => result.status === 'failed',
      );

      return {
        ok: !anyFailed,
        data: batchResults,
        error: anyFailed
          ? {
              code: 'EMAIL_INGEST_PARTIAL_FAILURE',
              message: 'One or more email ingestion batches failed',
              details: {
                failedBatchIds: batchResults
                  .filter((r) => r.status === 'failed')
                  .map((r) => r.batchId),
              },
            }
          : null,
      };
    } catch (err: unknown) {
      const error: StandardError = {
        code: 'EMAIL_INGEST_ERROR',
        message: 'Unhandled error while polling mailboxes',
        details: {
          error:
            err instanceof Error ? err.message : (err as string | unknown),
        },
      };

      this.logService.logEvent({
        category: 'EMAIL',
        logLevel: 'ERROR',
        message: error.message,
        identifier: 'email_ingest:pollMailbox',
        metadata: error.details,
      });

      this.logger.error(
        `Unhandled error while polling mailboxes: ${
          err instanceof Error ? err.stack ?? err.message : String(err)
        }`,
      );

      return {
        ok: false,
        data: null,
        error,
      };
    }
  }

  /**
   * Ingests emails for a single `email_account_configs` record.
   * Creates an `email_ingestion_batches` row and updates it as messages
   * are processed.
   */
  private async ingestForAccountConfig(
    config: EmailAccountConfigRecord,
    maxMessages: number,
  ): Promise<EmailIngestionBatchResult> {
    const startedAt = new Date();

    const batchInsert = await this.persistence.insertRecord(
      'email_ingestion_batches',
      {
        email_account_config_id: config.id,
        started_at: startedAt,
        finished_at: null,
        message_count: 0,
        status: 'running',
        error_summary: null,
      },
    );

    const batchId =
      batchInsert.ok && batchInsert.data
        ? (batchInsert.data as { id: string }).id
        : undefined;

    if (!batchId) {
      const errorSummary = 'Failed to create email_ingestion_batches row';

      this.logService.logEvent({
        category: 'EMAIL',
        logLevel: 'ERROR',
        message: errorSummary,
        identifier: `email_ingest:batch:${config.id}`,
        metadata: { configId: config.id, error: batchInsert.error },
      });

      return {
        batchId: 'unknown',
        emailAccountConfigId: config.id,
        organizationId: config.organization_id,
        totalFetched: 0,
        persistedMessages: 0,
        failedMessages: 0,
        status: 'failed',
        errorSummary,
      };
    }

    let totalFetched = 0;
    let persistedMessages = 0;
    let failedMessages = 0;
    const errors: string[] = [];

    const connection: MailboxConnectionOptions = {
      host: config.imap_host,
      port: config.imap_port,
      useSsl: config.imap_use_ssl,
      username: config.username,
      password: this.decryptPassword(config.encrypted_password),
      folder: 'INBOX',
    };

    try {
      const rawMessages = await this.mailboxClient.fetchUnreadMessages(
        connection,
        maxMessages,
      );

      totalFetched = rawMessages.length;

      for (const mail of rawMessages) {
        const rawEmail: RawEmail = {
          ...mail,
          organizationId: config.organization_id,
          emailAccountConfigId: config.id,
        };

        const success = await this.ingestSingleEmail(batchId, config, rawEmail);

        if (success) {
          persistedMessages += 1;
        } else {
          failedMessages += 1;
        }
      }

      // Mark messages as processed on the remote server, if supported.
      if (this.mailboxClient.markMessagesAsProcessed && rawMessages.length) {
        const remoteIds = rawMessages.map((m) => m.remoteId);
        try {
          await this.mailboxClient.markMessagesAsProcessed(
            connection,
            remoteIds,
          );
        } catch (err: unknown) {
          const message =
            'Failed to mark messages as processed on remote mailbox';
          errors.push(
            err instanceof Error ? err.message : String(err ?? 'unknown'),
          );

          this.logService.logEvent({
            category: 'EMAIL',
            logLevel: 'WARNING',
            message,
            identifier: `email_ingest:markProcessed:${batchId}`,
            metadata: { configId: config.id, error: errors[errors.length - 1] },
          });

          this.logger.warn(
            `${message}: ${
              err instanceof Error ? err.stack ?? err.message : String(err)
            }`,
          );
        }
      }

      const status: 'completed' | 'failed' =
        failedMessages > 0 && persistedMessages === 0 ? 'failed' : 'completed';
      const errorSummary =
        errors.length > 0 ? errors.join('; ').slice(0, 1024) : null;

      await this.persistence.updateRecord(
        'email_ingestion_batches',
        { id: batchId },
        {
          finished_at: new Date(),
          message_count: totalFetched,
          status,
          error_summary: errorSummary,
        },
      );

      if (status === 'completed') {
        await this.persistence.updateRecord(
          'email_account_configs',
          { id: config.id },
          {
            last_successful_poll_at: new Date(),
          },
        );
      }

      return {
        batchId,
        emailAccountConfigId: config.id,
        organizationId: config.organization_id,
        totalFetched,
        persistedMessages,
        failedMessages,
        status,
        errorSummary: errorSummary ?? undefined,
      };
    } catch (err: unknown) {
      const message =
        'Unhandled error while ingesting emails for account config';
      const errorText =
        err instanceof Error ? err.message : String(err ?? 'unknown');

      errors.push(errorText);

      this.logService.logEvent({
        category: 'EMAIL',
        logLevel: 'ERROR',
        message,
        identifier: `email_ingest:batch:${batchId}`,
        metadata: { configId: config.id, error: errorText },
      });

      this.logger.error(
        `${message} (config=${config.id}, batch=${batchId}): ${
          err instanceof Error ? err.stack ?? err.message : String(err)
        }`,
      );

      await this.persistence.updateRecord(
        'email_ingestion_batches',
        { id: batchId },
        {
          finished_at: new Date(),
          message_count: totalFetched,
          status: 'failed',
          error_summary: errors.join('; ').slice(0, 1024),
        },
      );

      return {
        batchId,
        emailAccountConfigId: config.id,
        organizationId: config.organization_id,
        totalFetched,
        persistedMessages,
        failedMessages,
        status: 'failed',
        errorSummary: errors.join('; ').slice(0, 1024),
      };
    }
  }

  /**
   * Ingests a single raw email: parse → validate → persist → route to workflow.
   * Returns `true` if the email was successfully persisted to `email_messages`,
   * regardless of downstream routing outcome.
   */
  private async ingestSingleEmail(
    batchId: string,
    config: EmailAccountConfigRecord,
    rawEmail: RawEmail,
  ): Promise<boolean> {
    try {
      const parseResult = await this.emailParser.parseIncoming(rawEmail);

      if (!parseResult || !parseResult.ok || !parseResult.data) {
        const message = 'Failed to parse incoming email';

        this.logService.logEvent({
          category: 'EMAIL',
          logLevel: 'ERROR',
          message,
          identifier: `email_ingest:parse:${batchId}`,
          metadata: {
            configId: config.id,
            remoteId: rawEmail.remoteId,
            error: parseResult?.error ?? null,
          },
        });

        this.logger.error(
          `${message} (config=${config.id}, remoteId=${rawEmail.remoteId})`,
        );

        return false;
      }

      const parsed = parseResult.data as ParsedEmail;

      const validateResult = await this.emailValidator.validateEmailPayload(
        parsed,
      );

      if (!validateResult || !validateResult.ok) {
        const message = 'Incoming email failed validation';

        this.logService.logEvent({
          category: 'EMAIL',
          logLevel: 'ERROR',
          message,
          identifier: `email_ingest:validate:${batchId}`,
          metadata: {
            configId: config.id,
            remoteId: rawEmail.remoteId,
            error: validateResult?.error ?? null,
          },
        });

        this.logger.error(
          `${message} (config=${config.id}, remoteId=${rawEmail.remoteId})`,
        );

        return false;
      }

      const { emailMessageId } = await this.persistParsedEmail(
        parsed,
        config.organization_id,
      );

      await this.createProcessingEvent(emailMessageId, 'parsed', {
        batchId,
        remoteId: rawEmail.remoteId,
      });

      // Route into workflows / tasks; failures here are logged and recorded as
      // classification failures but do not retroactively delete the message.
      try {
        await this.emailRouter.routeToWorkflow({
          emailMessageId,
          organizationId: config.organization_id,
          emailAccountConfigId: config.id,
        });
      } catch (err: unknown) {
        const errorText =
          err instanceof Error ? err.message : String(err ?? 'unknown');

        await this.createProcessingEvent(
          emailMessageId,
          'classification_failed',
          {
            batchId,
            remoteId: rawEmail.remoteId,
            error: errorText,
          },
        );

        this.logService.logEvent({
          category: 'EMAIL',
          logLevel: 'ERROR',
          message:
            'Failed to route ingested email into workflow (classification_failed)',
          identifier: `email_ingest:route:${batchId}`,
          metadata: {
            configId: config.id,
            emailMessageId,
            error: errorText,
          },
        });

        this.logger.error(
          `Failed to route ingested email into workflow (emailMessageId=${emailMessageId}): ${
            err instanceof Error ? err.stack ?? err.message : String(err)
          }`,
        );
      }

      return true;
    } catch (err: unknown) {
      const message = 'Unhandled error while ingesting single email';
      const errorText =
        err instanceof Error ? err.message : String(err ?? 'unknown');

      this.logService.logEvent({
        category: 'EMAIL',
        logLevel: 'ERROR',
        message,
        identifier: `email_ingest:single:${batchId}`,
        metadata: {
          configId: config.id,
          remoteId: rawEmail.remoteId,
          error: errorText,
        },
      });

      this.logger.error(
        `${message} (config=${config.id}, remoteId=${rawEmail.remoteId}): ${
          err instanceof Error ? err.stack ?? err.message : String(err)
        }`,
      );

      return false;
    }
  }

  /**
   * Persists a parsed email into `email_threads`, `email_messages`, and
   * `email_attachments`. Returns the new `email_message_id`.
   */
  private async persistParsedEmail(
    parsed: ParsedEmail,
    organizationId: string,
  ): Promise<{ emailMessageId: string }> {
    const messageTimestamp =
      parsed.receivedAt ?? parsed.sentAt ?? new Date();

    const externalThreadKey =
      parsed.externalThreadKey ??
      parsed.messageIdHeader ??
      this.buildSyntheticThreadKey(parsed);

    // Find or create the email_thread for this conversation.
    let threadId: string | null = null;

    if (externalThreadKey) {
      const existingThreadsResult = await this.persistence.fetchRecords(
        'email_threads',
        {
          organization_id: organizationId,
          external_thread_key: externalThreadKey,
        },
      );

      const existingThreads =
        (existingThreadsResult.ok && existingThreadsResult.data) || [];

      if (existingThreads.length > 0) {
        const existing = existingThreads[0] as { id: string };

        threadId = existing.id;

        // Update last_message_at on the existing thread.
        await this.persistence.updateRecord(
          'email_threads',
          { id: threadId },
          {
            last_message_at: messageTimestamp,
            subject_snapshot: parsed.subject,
          },
        );
      } else {
        const createdThread = await this.persistence.insertRecord(
          'email_threads',
          {
            organization_id: organizationId,
            external_thread_key: externalThreadKey,
            subject_snapshot: parsed.subject,
            primary_task_id: null,
            last_message_at: messageTimestamp,
          },
        );

        if (createdThread.ok && createdThread.data) {
          threadId = (createdThread.data as { id: string }).id;
        }
      }
    }

    const messageInsert = await this.persistence.insertRecord(
      'email_messages',
      {
        organization_id: organizationId,
        email_account_config_id: parsed.emailAccountConfigId,
        thread_id: threadId,
        message_id_header: parsed.messageIdHeader ?? null,
        direction: parsed.direction,
        from_address: parsed.fromAddress,
        to_addresses: parsed.toAddresses,
        cc_addresses: parsed.ccAddresses ?? null,
        bcc_addresses: parsed.bccAddresses ?? null,
        subject: parsed.subject,
        received_at: parsed.receivedAt ?? null,
        sent_at: parsed.sentAt ?? null,
        raw_headers: parsed.rawHeaders ?? null,
        text_body: parsed.textBody ?? null,
        html_body: parsed.htmlBody ?? null,
        related_task_id: null,
        sensitivity: parsed.sensitivity ?? 'normal',
      },
    );

    if (!messageInsert.ok || !messageInsert.data) {
      throw new Error('Failed to insert email_messages row');
    }

    const emailMessage = messageInsert.data as { id: string };
    const emailMessageId = emailMessage.id;

    // Persist attachments if we have a storage backend and any attachments.
    if (parsed.attachments && parsed.attachments.length > 0) {
      await this.persistAttachments(emailMessageId, parsed.attachments);
    }

    return { emailMessageId };
  }

  /**
   * Persists `email_attachments` rows and optionally writes attachment content
   * to the configured storage backend (S3/GCS/local).
   */
  private async persistAttachments(
    emailMessageId: string,
    attachments: ParsedEmailAttachment[],
  ): Promise<void> {
    if (!attachments.length) {
      return;
    }

    if (!this.attachmentStorage) {
      // If we have no storage backend, we log a warning and skip attachments.
      this.logService.logEvent({
        category: 'EMAIL',
        logLevel: 'WARNING',
        message:
          'Skipping attachment persistence because no attachment storage backend is configured',
        identifier: `email_ingest:attachments:${emailMessageId}`,
        metadata: { attachmentsCount: attachments.length },
      });
      return;
    }

    let index = 0;

    for (const attachment of attachments) {
      index += 1;

      const storageKey = this.buildAttachmentStorageKey(
        emailMessageId,
        index,
        attachment.fileName,
      );
      const checksum =
        attachment.checksum ?? this.computeChecksum(attachment.content);

      await this.attachmentStorage.saveAttachment(storageKey, attachment.content, {
        mimeType: attachment.mimeType,
        sizeBytes: attachment.sizeBytes,
      });

      await this.persistence.insertRecord('email_attachments', {
        email_message_id: emailMessageId,
        file_name: attachment.fileName,
        mime_type: attachment.mimeType,
        size_bytes: attachment.sizeBytes,
        storage_key: storageKey,
        checksum,
      });
    }
  }

  /**
   * Writes an `email_processing_events` row for the given message.
   */
  private async createProcessingEvent(
    emailMessageId: string,
    eventType: EmailProcessingEventType,
    details: Record<string, unknown>,
  ): Promise<void> {
    await this.persistence.insertRecord('email_processing_events', {
      email_message_id: emailMessageId,
      event_type: eventType,
      details,
      created_at: new Date(),
    });
  }

  /**
   * Placeholder decryptor for `email_account_configs.encrypted_password`.
   * In production, this should delegate to a KMS/secret manager and never
   * expose plaintext secrets in logs.
   */
  private decryptPassword(encrypted: string): string {
    // TODO: Replace with real decryption using KMS/secret management.
    return encrypted;
  }

  /**
   * Builds a synthetic thread key when no provider‑native thread identifier
   * is available. This is best‑effort and primarily used for grouping
   * messages that share the same subject and sender.
   */
  private buildSyntheticThreadKey(parsed: ParsedEmail): string {
    const subject = parsed.subject?.trim().toLowerCase() ?? '';
    const from = parsed.fromAddress?.trim().toLowerCase() ?? '';
    const hash = crypto
      .createHash('sha256')
      .update(`${from}::${subject}`)
      .digest('hex')
      .slice(0, 16);

    return `synthetic:${hash}`;
  }

  /**
   * Builds an attachment storage key under a simple, deterministic path.
   */
  private buildAttachmentStorageKey(
    emailMessageId: string,
    index: number,
    fileName: string,
  ): string {
    const safeName = fileName.replace(/[^a-zA-Z0-9._-]/g, '_');
    return `email/${emailMessageId}/${index}-${safeName}`;
  }

  /**
   * Computes a SHA‑256 checksum for attachment content.
   */
  private computeChecksum(buffer: Buffer): string {
    return crypto.createHash('sha256').update(buffer).digest('hex');
  }
}

===== END apps/api/src/orgo/core/email/email-ingest.service.ts =====


===== BEGIN apps/api/src/orgo/core/email/email-parser.service.ts =====
import { Injectable, Logger } from '@nestjs/common';
import { randomUUID } from 'crypto';

/**
 * Direction of the email relative to Orgo.
 * Maps to email_direction_enum ('inbound' | 'outbound').
 */
export type EmailDirection = 'inbound' | 'outbound';

/**
 * Sensitivity classification for email_message.sensitivity.
 */
export type EmailSensitivity = 'normal' | 'sensitive' | 'highly_sensitive';

/**
 * Generic address shape from common IMAP/SMTP/mailparser libraries.
 */
export interface RawEmailAddressLike {
  address: string;
  name?: string | null;
}

export type RawEmailAddressInput =
  | string
  | RawEmailAddressLike
  | Array<string | RawEmailAddressLike>;

/**
 * Raw email payload as handed off by the Email Gateway / IMAP client.
 * This is intentionally generic and library‑agnostic.
 */
export interface RawEmailPayload {
  subject?: string | null;
  from?: RawEmailAddressInput | null;
  to?: RawEmailAddressInput | null;
  cc?: RawEmailAddressInput | null;
  bcc?: RawEmailAddressInput | null;

  text?: string | null;
  html?: string | null;

  headers?: Record<string, string | string[] | undefined>;
  messageId?: string | null;

  /**
   * Optional size in bytes reported by the mail server/client.
   * If not present, the parser will estimate the size.
   */
  sizeInBytes?: number | null;

  /**
   * Attachments as emitted by the mail client / library.
   * Only metadata fields used by Orgo are required here.
   */
  attachments?: RawEmailAttachment[];

  /**
   * When the message was received by the mailbox (inbound).
   */
  receivedAt?: Date | string | null;

  /**
   * When the message was sent (outbound).
   */
  sentAt?: Date | string | null;

  /**
   * Direction hint; if omitted, parser defaults to 'inbound'.
   */
  direction?: EmailDirection;
}

/**
 * Raw attachment payload from the mail client.
 * This is intentionally minimal and may be extended later.
 */
export interface RawEmailAttachment {
  filename?: string | null;
  contentType?: string | null;
  mimeType?: string | null; // some libraries use mimeType instead of contentType
  size?: number | null; // bytes, if available
  contentId?: string | null;
  cid?: string | null; // alias for contentId
  inline?: boolean | null;
}

/**
 * Normalised attachment metadata stored alongside EMAIL_MESSAGE.
 * Aligns with the logical EMAIL_MESSAGE schema (Doc 5 §3.2). :contentReference[oaicite:0]{index=0}
 */
export interface EmailAttachmentMeta {
  filename: string | null;
  contentType: string | null;
  sizeBytes: number;
  inline: boolean;
  contentId: string | null;
  /**
   * True if the attachment's MIME type is in the allowed list
   * configured for the deployment (email_config.yaml limits). :contentReference[oaicite:1]{index=1}
   */
  allowed: boolean;
}

/**
 * Logical EMAIL_MESSAGE envelope as produced by the parser.
 * Maps 1:1 to the EMAIL_MESSAGE logical view in Doc 5 §3.2. :contentReference[oaicite:2]{index=2}
 */
export interface EmailMessageEnvelope {
  emailMessageId: string;
  organizationId: string;
  emailAccountConfigId: string | null;
  threadId: string | null;

  messageIdHeader: string | null;

  direction: EmailDirection;

  fromAddress: string;
  toAddresses: string[];
  ccAddresses: string[];
  bccAddresses: string[];

  subject: string;
  receivedAt: Date | null;
  sentAt: Date | null;

  rawHeaders: Record<string, string | string[]>;
  textBody: string | null;
  htmlBody: string | null;

  relatedTaskId: string | null;
  sensitivity: EmailSensitivity;

  parsedMetadata: Record<string, unknown>;
  attachmentsMeta: EmailAttachmentMeta[];
  securityFlags: Record<string, unknown>;
}

/**
 * Context supplied by the Email Gateway when parsing a message.
 * Orgo‑specific fields (organization_id, linkage, config ids). 
 */
export interface EmailParserContext {
  organizationId: string;
  emailAccountConfigId?: string | null;
  threadId?: string | null;
  relatedTaskId?: string | null;
  direction?: EmailDirection;
  /**
   * Optional override for sensitivity; if omitted, parser will derive
   * a conservative default based on headers/content.
   */
  sensitivityOverride?: EmailSensitivity;
}

/**
 * Limits and policy flags taken (eventually) from email_config.yaml. :contentReference[oaicite:4]{index=4}
 */
export interface EmailParserLimits {
  /**
   * Maximum email size (in bytes). Defaults to 10 MB if not provided.
   */
  maxEmailSizeBytes?: number;
  /**
   * Allowed MIME types for attachments; if empty/omitted, all attachment
   * types are accepted and simply marked as allowed=true.
   */
  allowedAttachmentMimeTypes?: string[];
  /**
   * If true (default), disallow emails that exceed the size limit.
   */
  enforceSizeLimit?: boolean;
}

/**
 * Standard result shape for Core Services (ok / data / error). :contentReference[oaicite:5]{index=5}
 */
export interface EmailParserResult<T> {
  ok: boolean;
  data: T | null;
  error: {
    code: EmailParserErrorCode;
    message: string;
    details?: Record<string, unknown>;
  } | null;
}

export type EmailParserErrorCode =
  | 'EMAIL_PARSING_ERROR'
  | 'EMAIL_VALIDATION_ERROR'
  | 'EMAIL_TOO_LARGE'
  | 'EMAIL_ATTACHMENT_TYPE_NOT_ALLOWED';

const DEFAULT_MAX_EMAIL_SIZE_BYTES = 10 * 1024 * 1024; // 10 MB, matches email_config.yaml default. :contentReference[oaicite:6]{index=6}

@Injectable()
export class EmailParserService {
  private readonly logger = new Logger(EmailParserService.name);

  /**
   * Parse and normalise a raw email payload into an EmailMessageEnvelope.
   *
   * This method:
   *  - normalises addresses (from/to/cc/bcc),
   *  - parses / sanitises text & HTML bodies,
   *  - computes size and enforces max size limits (if configured),
   *  - normalises attachments metadata and flags disallowed MIME types,
   *  - extracts selected headers into parsedMetadata/securityFlags,
   *  - returns the standard Core Services result shape.
   */
  parseIncoming(
    raw: RawEmailPayload,
    context: EmailParserContext,
    limits: EmailParserLimits = {},
  ): EmailParserResult<EmailMessageEnvelope> {
    try {
      const normalized = this.toEnvelope(raw, context, limits);

      const validationError = this.validateEnvelope(normalized, limits);
      if (validationError) {
        return {
          ok: false,
          data: null,
          error: validationError,
        };
      }

      return {
        ok: true,
        data: normalized,
        error: null,
      };
    } catch (err: unknown) {
      this.logger.error('Unexpected error while parsing email', err as Error);

      return {
        ok: false,
        data: null,
        error: {
          code: 'EMAIL_PARSING_ERROR',
          message:
            err instanceof Error ? err.message : 'Unexpected email parsing error',
        },
      };
    }
  }

  /**
   * Convert the raw payload and context into an EmailMessageEnvelope.
   * This method is pure and throws only on truly unexpected conditions;
   * policy validation is handled separately in validateEnvelope().
   */
  private toEnvelope(
    raw: RawEmailPayload,
    context: EmailParserContext,
    limits: EmailParserLimits,
  ): EmailMessageEnvelope {
    const direction: EmailDirection = context.direction ?? raw.direction ?? 'inbound';
    const rawHeaders = this.normaliseHeaders(raw.headers ?? {});
    const subject = (raw.subject ?? '').trim();

    const fromList = this.normaliseAddressList(raw.from);
    const fromAddress = fromList[0] ?? '';

    const toAddresses = this.normaliseAddressList(raw.to);
    const ccAddresses = this.normaliseAddressList(raw.cc);
    const bccAddresses = this.normaliseAddressList(raw.bcc);

    const { textBody, htmlBody } = this.normaliseBodies(raw.text, raw.html);

    const { attachmentsMeta, hadDisallowedAttachments } =
      this.normaliseAttachments(raw.attachments ?? [], limits);

    const estimatedSizeBytes = this.estimateEmailSize(
      raw,
      textBody,
      htmlBody,
      attachmentsMeta,
    );

    const messageIdHeader =
      raw.messageId ??
      (rawHeaders['message-id'] as string | undefined) ??
      null;

    const receivedAt = this.normaliseDate(raw.receivedAt);
    const sentAt = this.normaliseDate(raw.sentAt);

    const sensitivity =
      context.sensitivityOverride ??
      this.deriveSensitivity(subject, textBody, rawHeaders);

    const securityFlags = this.deriveSecurityFlags(rawHeaders);

    const parsedMetadata: Record<string, unknown> = {
      rawSizeBytes: raw.sizeInBytes ?? null,
      estimatedSizeBytes,
      hadDisallowedAttachments,
      attachmentCount: attachmentsMeta.length,
      hasHtmlBody: htmlBody !== null,
      hasTextBody: textBody !== null,
      messageIdHeader,
      direction,
    };

    return {
      emailMessageId: randomUUID(),
      organizationId: context.organizationId,
      emailAccountConfigId: context.emailAccountConfigId ?? null,
      threadId: context.threadId ?? null,
      messageIdHeader,
      direction,
      fromAddress,
      toAddresses,
      ccAddresses,
      bccAddresses,
      subject,
      receivedAt,
      sentAt,
      rawHeaders,
      textBody,
      htmlBody,
      relatedTaskId: context.relatedTaskId ?? null,
      sensitivity,
      parsedMetadata,
      attachmentsMeta,
      securityFlags,
    };
  }

  /**
   * Validate a normalised EmailMessageEnvelope against hard requirements
   * (required fields, size limit, attachment policy).
   */
  private validateEnvelope(
    envelope: EmailMessageEnvelope,
    limits: EmailParserLimits,
  ): EmailParserResult<EmailMessageEnvelope>['error'] {
    // Required fields: subject, from, at least one recipient, and some body.
    if (!envelope.subject) {
      return {
        code: 'EMAIL_VALIDATION_ERROR',
        message: "Missing required field 'subject'",
        details: { field: 'subject' },
      };
    }

    if (!envelope.fromAddress) {
      return {
        code: 'EMAIL_VALIDATION_ERROR',
        message: "Missing required field 'fromAddress'",
        details: { field: 'fromAddress' },
      };
    }

    if (
      envelope.toAddresses.length === 0 &&
      envelope.ccAddresses.length === 0 &&
      envelope.bccAddresses.length === 0
    ) {
      return {
        code: 'EMAIL_VALIDATION_ERROR',
        message: 'Email must have at least one recipient',
        details: { field: 'to/cc/bcc' },
      };
    }

    if (!envelope.textBody && !envelope.htmlBody) {
      return {
        code: 'EMAIL_VALIDATION_ERROR',
        message: 'Email must have a text or HTML body',
        details: { field: 'textBody/htmlBody' },
      };
    }

    // Size limit enforcement (if enabled).
    const enforceSizeLimit = limits.enforceSizeLimit ?? true;
    const maxBytes =
      typeof limits.maxEmailSizeBytes === 'number'
        ? limits.maxEmailSizeBytes
        : DEFAULT_MAX_EMAIL_SIZE_BYTES;

    if (enforceSizeLimit) {
      const estimatedSize = envelope.parsedMetadata.estimatedSizeBytes;
      if (typeof estimatedSize === 'number' && estimatedSize > maxBytes) {
        return {
          code: 'EMAIL_TOO_LARGE',
          message: `Email exceeds maximum size: ${estimatedSize} bytes > ${maxBytes} bytes`,
          details: { estimatedSizeBytes: estimatedSize, maxEmailSizeBytes: maxBytes },
        };
      }
    }

    // Attachment policy: if allowedAttachmentMimeTypes is non‑empty,
    // disallow attachments whose contentType is not in the list.
    const allowedTypes = limits.allowedAttachmentMimeTypes ?? [];
    if (allowedTypes.length > 0) {
      const hasForbidden = envelope.attachmentsMeta.some(
        (a) => a.contentType && !allowedTypes.includes(a.contentType),
      );

      if (hasForbidden) {
        return {
          code: 'EMAIL_ATTACHMENT_TYPE_NOT_ALLOWED',
          message: 'One or more attachments have disallowed MIME types',
          details: {
            allowedAttachmentMimeTypes: allowedTypes,
          },
        };
      }
    }

    return null;
  }

  // ---------------------------------------------------------------------------
  // Normalisation helpers
  // ---------------------------------------------------------------------------

  private normaliseHeaders(
    headers: Record<string, string | string[] | undefined>,
  ): Record<string, string | string[]> {
    const out: Record<string, string | string[]> = {};

    for (const [key, value] of Object.entries(headers)) {
      if (typeof value === 'undefined') {
        continue;
      }
      const canonicalKey = key.toLowerCase();
      out[canonicalKey] = value;
    }

    return out;
  }

  private normaliseAddressList(
    value?: RawEmailAddressInput | null,
  ): string[] {
    if (!value) {
      return [];
    }

    const items = Array.isArray(value) ? value : [value];
    const result: string[] = [];

    for (const item of items) {
      if (typeof item === 'string') {
        result.push(...this.extractEmailAddressesFromString(item));
      } else if (item && typeof item.address === 'string') {
        const parsed = this.extractEmailAddressesFromString(item.address);
        result.push(...parsed);
      }
    }

    return result.filter(Boolean);
  }

  private extractEmailAddressesFromString(raw: string): string[] {
    if (!raw) {
      return [];
    }

    // Handle comma‑separated lists like "A <a@example.org>, b@example.org"
    const parts = raw.split(',').map((p) => p.trim());
    const result: string[] = [];

    for (const part of parts) {
      if (!part) continue;

      const angleMatch = part.match(/<([^>]+)>/);
      if (angleMatch && angleMatch[1]) {
        result.push(angleMatch[1].trim());
      } else {
        result.push(part.trim());
      }
    }

    return result;
  }

  private normaliseBodies(
    text?: string | null,
    html?: string | null,
  ): { textBody: string | null; htmlBody: string | null } {
    const rawText = text?.trim() ?? '';
    const rawHtml = html?.trim() ?? '';

    let textBody: string | null = rawText || null;
    let htmlBody: string | null = rawHtml || null;

    if (!textBody && htmlBody) {
      textBody = this.extractPlainTextFromHtml(htmlBody) || null;
    }

    if (htmlBody) {
      htmlBody = this.sanitiseHtml(htmlBody);
    }

    return { textBody, htmlBody };
  }

  private extractPlainTextFromHtml(html: string): string {
    // Remove script/style blocks.
    let text = html.replace(
      /<(script|style)[^>]*>[\s\S]*?<\/\1>/gi,
      '',
    );
    // Strip tags.
    text = text.replace(/<[^>]+>/g, ' ');
    // Collapse whitespace.
    text = text.replace(/\s+/g, ' ').trim();
    return text;
  }

  private sanitiseHtml(html: string): string {
    let out = html;

    // Remove script/style tags completely.
    out = out.replace(/<(script|style)[^>]*>[\s\S]*?<\/\1>/gi, '');

    // Basic sanitisation for inline event handlers and javascript: URLs.
    out = out.replace(/\son[a-z]+\s*=\s*(['"]).*?\1/gi, '');
    out = out.replace(/javascript:/gi, '');

    return out;
  }

  private normaliseAttachments(
    rawAttachments: RawEmailAttachment[],
    limits: EmailParserLimits,
  ): { attachmentsMeta: EmailAttachmentMeta[]; hadDisallowedAttachments: boolean } {
    const allowedTypes = limits.allowedAttachmentMimeTypes ?? [];
    const attachmentsMeta: EmailAttachmentMeta[] = [];
    let hadDisallowed = false;

    for (const raw of rawAttachments) {
      const filename = raw.filename ?? null;
      const contentType = (raw.contentType ?? raw.mimeType ?? null)?.toLowerCase() ?? null;
      const sizeBytes = typeof raw.size === 'number' && raw.size > 0 ? raw.size : 0;
      const contentId = (raw.contentId ?? raw.cid ?? null) || null;
      const inline = Boolean(raw.inline);

      let allowed = true;
      if (allowedTypes.length > 0 && contentType) {
        allowed = allowedTypes.includes(contentType);
        if (!allowed) {
          hadDisallowed = true;
        }
      }

      attachmentsMeta.push({
        filename,
        contentType,
        sizeBytes,
        inline,
        contentId,
        allowed,
      });
    }

    return { attachmentsMeta, hadDisallowedAttachments: hadDisallowed };
  }

  private estimateEmailSize(
    raw: RawEmailPayload,
    textBody: string | null,
    htmlBody: string | null,
    attachments: EmailAttachmentMeta[],
  ): number {
    if (typeof raw.sizeInBytes === 'number' && raw.sizeInBytes > 0) {
      return raw.sizeInBytes;
    }

    let total = 0;

    const accumulate = (value: string | null | undefined) => {
      if (!value) return;
      // Approximate: 1 char ≈ 1 byte (good enough for limit checks).
      total += value.length;
    };

    accumulate(raw.subject ?? null);
    accumulate(textBody);
    accumulate(htmlBody);

    for (const attachment of attachments) {
      total += attachment.sizeBytes;
    }

    return total;
  }

  private normaliseDate(value?: Date | string | null): Date | null {
    if (!value) return null;
    if (value instanceof Date) return value;

    const parsed = new Date(value);
    if (Number.isNaN(parsed.getTime())) {
      return null;
    }
    return parsed;
  }

  private deriveSensitivity(
    subject: string,
    textBody: string | null,
    headers: Record<string, string | string[]>,
  ): EmailSensitivity {
    // Very conservative and generic heuristic:
    //  - if headers mark content as confidential, treat as 'sensitive'
    //  - otherwise, look for common sensitivity hints in subject/body.
    const classificationHeader =
      (headers['sensitivity'] as string | undefined) ??
      (headers['x-classification'] as string | undefined) ??
      '';

    const lcClassification = classificationHeader.toLowerCase();
    if (
      lcClassification.includes('confidential') ||
      lcClassification.includes('restricted')
    ) {
      return 'sensitive';
    }

    const text = `${subject} ${textBody ?? ''}`.toLowerCase();
    if (
      text.includes('confidential') ||
      text.includes('harassment') ||
      text.includes('medical') ||
      text.includes('patient') ||
      text.includes('complaint')
    ) {
      return 'sensitive';
    }

    return 'normal';
  }

  private deriveSecurityFlags(
    headers: Record<string, string | string[]>,
  ): Record<string, unknown> {
    const result: Record<string, unknown> = {};

    const contentType = (headers['content-type'] as string | undefined) ?? '';
    const lcContentType = contentType.toLowerCase();

    result.pgpEncrypted =
      lcContentType.includes('multipart/encrypted') ||
      lcContentType.includes('application/pgp-encrypted') ||
      this.headerContains(headers, 'x-pgp-encrypted', 'yes');

    result.spamScore = this.parseFloatHeader(headers, 'x-spam-score');
    result.spamStatus = (headers['x-spam-status'] as string | undefined) ?? null;

    return result;
  }

  private headerContains(
    headers: Record<string, string | string[]>,
    key: string,
    needle: string,
  ): boolean {
    const value = headers[key.toLowerCase()];
    if (!value) return false;

    if (Array.isArray(value)) {
      return value.some((v) => v.toLowerCase().includes(needle.toLowerCase()));
    }

    return value.toLowerCase().includes(needle.toLowerCase());
  }

  private parseFloatHeader(
    headers: Record<string, string | string[]>,
    key: string,
  ): number | null {
    const value = headers[key.toLowerCase()];
    if (!value) return null;

    const s = Array.isArray(value) ? value[0] : value;
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : null;
  }
}

===== END apps/api/src/orgo/core/email/email-parser.service.ts =====


===== BEGIN apps/api/src/orgo/core/email/email-router.service.ts =====
import { Injectable, Logger } from '@nestjs/common';
import { WorkflowEngineService } from '../workflow/workflow-engine.service';
import { TaskService } from '../task/task.service';
import { NotificationService } from '../notification/notification.service';

export interface OrgoError<TDetails = unknown> {
  code: string;
  message: string;
  details?: TDetails;
}

export interface OrgoResult<TData = unknown, TErrorDetails = unknown> {
  ok: boolean;
  data: TData | null;
  error: OrgoError<TErrorDetails> | null;
}

/**
 * Logical EMAIL_MESSAGE envelope, aligned with the Doc 5 logical model
 * and the `email_messages` table in Doc 1.
 */
export interface EmailMessageEnvelope {
  id: string;
  organization_id: string;
  email_account_config_id?: string | null;
  thread_id?: string | null;
  message_id_header?: string | null;
  direction: 'inbound' | 'outbound';
  from_address: string;
  to_addresses: string[];
  cc_addresses?: string[] | null;
  bcc_addresses?: string[] | null;
  subject: string;
  received_at?: Date | string | null;
  sent_at?: Date | string | null;
  raw_headers?: string | null;
  text_body?: string | null;
  html_body?: string | null;
  related_task_id?: string | null;
  sensitivity: 'normal' | 'sensitive' | 'highly_sensitive';
  parsed_metadata?: Record<string, unknown> | null;
  attachments_meta?: unknown[] | null;
  security_flags?: Record<string, unknown> | null;
  [key: string]: unknown;
}

export type WorkflowSource = 'EMAIL' | 'API' | 'SYSTEM' | 'TIMER';

export type WorkflowActionType =
  | 'CREATE_TASK'
  | 'UPDATE_TASK'
  | 'ROUTE'
  | 'ESCALATE'
  | 'ATTACH_TEMPLATE'
  | 'SET_METADATA'
  | 'NOTIFY';

export interface WorkflowAction<TPayload = any> {
  type: WorkflowActionType;
  payload?: TPayload;
}

export interface WorkflowExecution {
  actions: WorkflowAction[];
  rule_ids?: string[];
  metadata?: Record<string, unknown>;
}

/**
 * Context object passed into the workflow engine when routing an email.
 * At minimum, `source` and `organization_id` are required; the email
 * envelope is provided under `email`.
 */
export interface WorkflowContext {
  source: WorkflowSource;
  organization_id: string;
  email?: EmailMessageEnvelope;
  [key: string]: unknown;
}

/**
 * Minimal Task creation payload, following the canonical Task JSON
 * contract (Doc 2 §2.10 / Doc 8 §8.4.2). Most fields are optional here
 * because validation is enforced in TaskService, not in the router.
 */
export interface CreateTaskPayload {
  organization_id?: string;
  type?: string;
  category?: string;
  subtype?: string | null;
  label?: string;
  title?: string;
  description?: string;
  status?: string;
  priority?: string;
  severity?: string;
  visibility?: string;
  source?: string;
  case_id?: string | null;
  created_by_user_id?: string | null;
  requester_person_id?: string | null;
  owner_role_id?: string | null;
  owner_user_id?: string | null;
  assignee_role?: string | null;
  due_at?: string | Date | null;
  reactivity_time?: string | null;
  reactivity_deadline_at?: string | Date | null;
  escalation_level?: number;
  metadata?: Record<string, unknown>;
  [key: string]: unknown;
}

/**
 * Minimal view of a Task returned by TaskService; we only need a stable
 * identifier and treat the rest as opaque.
 */
export type TaskDTO = {
  task_id?: string;
  id?: string;
  [key: string]: unknown;
};

export interface NotifyActionPayload {
  task_id?: string;
  event_type?: 'CREATED' | 'ASSIGNED' | 'ESCALATED' | 'COMPLETED';
  [key: string]: unknown;
}

/**
 * Options for routing a single email through the workflow engine.
 *
 * - dry_run: if true, compute actions but do not apply them.
 * - context_overrides: optional extra keys / overrides for WorkflowContext.
 */
export interface EmailRoutingOptions {
  dry_run?: boolean;
  context_overrides?: Partial<WorkflowContext>;
}

export interface ApplyActionsResult {
  created_task_ids: string[];
  notifications_sent: number;
}

export interface EmailRoutingResult {
  email_id: string;
  organization_id: string;
  workflow_execution: WorkflowExecution;
  created_task_ids: string[];
  notifications_sent: number;
}

/**
 * EmailRouterService
 *
 * Responsibilities (aligned with Docs 2, 4, 5 and 8):
 *  - Build a WorkflowContext from a parsed/validated email.
 *  - Execute workflow rules via WorkflowEngineService.
 *  - Apply the resulting actions by delegating to TaskService and
 *    NotificationService.
 *  - Return a standard result shape (ok/data/error).
 */
@Injectable()
export class EmailRouterService {
  private readonly logger = new Logger(EmailRouterService.name);

  constructor(
    private readonly workflowEngine: WorkflowEngineService,
    private readonly taskService: TaskService,
    private readonly notificationService: NotificationService,
  ) {}

  /**
   * Route a parsed email into the workflow engine and apply resulting actions.
   *
   * Typical flow:
   *  - Build WorkflowContext { source: "EMAIL", organization_id, email }
   *  - Execute workflow rules
   *  - For CREATE_TASK actions: create Tasks
   *  - For ROUTE / ESCALATE / NOTIFY: delegate to TaskService/NotificationService
   *
   * If `options.dry_run` is true, actions are computed but not applied.
   */
  async routeToWorkflow(
    email: EmailMessageEnvelope,
    options: EmailRoutingOptions = {},
  ): Promise<OrgoResult<EmailRoutingResult>> {
    if (!email) {
      return {
        ok: false,
        data: null,
        error: {
          code: 'EMAIL_ROUTING_ERROR',
          message: 'Email payload is required for routing',
        },
      };
    }

    if (!email.organization_id) {
      return {
        ok: false,
        data: null,
        error: {
          code: 'EMAIL_ROUTING_ERROR',
          message: 'Email payload must include organization_id',
          details: { email_id: email.id },
        },
      };
    }

    const { dry_run = false, context_overrides = {} } = options;

    const context: WorkflowContext = {
      source: 'EMAIL',
      organization_id: email.organization_id,
      email,
      ...context_overrides,
    };

    let executionResult: OrgoResult<WorkflowExecution>;
    try {
      executionResult = (await this.workflowEngine.executeWorkflow(
        context,
      )) as OrgoResult<WorkflowExecution>;
    } catch (err) {
      this.logger.error(
        `Workflow execution failed for email ${email.id}`,
        (err as Error).stack || String(err),
      );

      return {
        ok: false,
        data: null,
        error: {
          code: 'WORKFLOW_EXECUTION_FAILED',
          message: 'Failed to execute workflow for email',
          details: {
            email_id: email.id,
            organization_id: email.organization_id,
          },
        },
      };
    }

    if (!executionResult.ok || !executionResult.data) {
      this.logger.warn(
        `Workflow execution returned error for email ${email.id}: ${
          executionResult.error?.code ?? 'UNKNOWN_ERROR'
        }`,
      );

      return {
        ok: false,
        data: null,
        error:
          executionResult.error ??
          ({
            code: 'WORKFLOW_EXECUTION_FAILED',
            message:
              'Workflow execution failed without specific error detail',
          } as OrgoError),
      };
    }

    const workflowExecution = executionResult.data;

    if (dry_run) {
      // Only compute actions; do not apply anything.
      return {
        ok: true,
        data: {
          email_id: email.id,
          organization_id: email.organization_id,
          workflow_execution: workflowExecution,
          created_task_ids: [],
          notifications_sent: 0,
        },
        error: null,
      };
    }

    const applyResult = await this.applyActions(
      workflowExecution.actions ?? [],
      email,
    );

    if (!applyResult.ok || !applyResult.data) {
      return {
        ok: false,
        data: null,
        error:
          applyResult.error ??
          ({
            code: 'EMAIL_ROUTING_APPLY_FAILED',
            message: 'Failed to apply workflow actions for email',
          } as OrgoError),
      };
    }

    const { created_task_ids, notifications_sent } = applyResult.data;

    return {
      ok: true,
      data: {
        email_id: email.id,
        organization_id: email.organization_id,
        workflow_execution: workflowExecution,
        created_task_ids,
        notifications_sent,
      },
      error: null,
    };
  }

  /**
   * Apply workflow actions that resulted from executing rules for an email.
   * Supports:
   *  - CREATE_TASK: TaskService.createTask
   *  - ROUTE: TaskService.assignTask
   *  - ESCALATE: TaskService.escalateTask
   *  - NOTIFY: NotificationService.sendTaskNotification
   *
   * Other action types are logged and ignored at this layer.
   */
  private async applyActions(
    actions: WorkflowAction[],
    email: EmailMessageEnvelope,
  ): Promise<OrgoResult<ApplyActionsResult>> {
    const created_task_ids: string[] = [];
    let notifications_sent = 0;

    for (const action of actions) {
      if (!action || !action.type) {
        this.logger.warn(
          `Encountered workflow action without type for email ${email.id}; skipping`,
        );
        continue;
      }

      try {
        switch (action.type) {
          case 'CREATE_TASK':
            await this.handleCreateTaskAction(action, email, created_task_ids);
            break;

          case 'ROUTE':
            await this.handleRouteAction(action);
            break;

          case 'ESCALATE':
            await this.handleEscalateAction(action);
            break;

          case 'NOTIFY':
            notifications_sent += await this.handleNotifyAction(action);
            break;

          case 'ATTACH_TEMPLATE':
          case 'SET_METADATA':
          case 'UPDATE_TASK':
            // These are typically handled inside workflow-specific services.
            this.logger.debug(
              `Ignoring action type "${action.type}" in EmailRouterService.applyActions; not handled at email router layer`,
            );
            break;

          default:
            this.logger.warn(
              `Unknown workflow action type "${
                (action as any).type
              }" encountered for email ${email.id}`,
            );
        }
      } catch (err) {
        this.logger.error(
          `Failed to apply action "${action.type}" for email ${email.id}`,
          (err as Error).stack || String(err),
        );

        return {
          ok: false,
          data: null,
          error: {
            code: 'EMAIL_ROUTING_APPLY_FAILED',
            message: `Failed to apply workflow action "${action.type}"`,
            details: {
              email_id: email.id,
              action_type: action.type,
            },
          },
        };
      }
    }

    return {
      ok: true,
      data: {
        created_task_ids,
        notifications_sent,
      },
      error: null,
    };
  }

  private async handleCreateTaskAction(
    action: WorkflowAction,
    email: EmailMessageEnvelope,
    created_task_ids: string[],
  ): Promise<void> {
    const rawPayload = (action.payload ?? {}) as CreateTaskPayload;

    const payload: CreateTaskPayload = {
      ...rawPayload,
      organization_id: rawPayload.organization_id ?? email.organization_id,
      source: rawPayload.source ?? 'email',
      metadata: {
        ...(rawPayload.metadata ?? {}),
        email_message_id: email.id,
        email_thread_id: email.thread_id ?? undefined,
        email_direction: email.direction,
        email_subject: email.subject,
        email_from_address: email.from_address,
        email_to_addresses: email.to_addresses,
      },
    };

    const result = (await this.taskService.createTask(
      payload,
    )) as OrgoResult<TaskDTO>;

    if (!result.ok || !result.data) {
      throw new Error(
        result.error?.message ??
          'TaskService.createTask returned an error without details',
      );
    }

    const task = result.data;
    const taskId = (task.task_id ?? task.id) as string | undefined;

    if (!taskId) {
      this.logger.warn(
        'TaskService.createTask succeeded but returned task without task_id / id; task will not be tracked in routing result',
      );
      return;
    }

    created_task_ids.push(taskId);
  }

  private async handleRouteAction(action: WorkflowAction): Promise<void> {
    const payload = (action.payload ?? {}) as {
      task_id?: string;
      assignee_role?: string;
      actor_user_id?: string;
      assignee_user_id?: string;
      [key: string]: unknown;
    };

    if (!payload.task_id && !payload.assignee_role && !payload.assignee_user_id) {
      this.logger.debug('ROUTE action missing routing payload; nothing to do');
      return;
    }

    if (!payload.task_id) {
      this.logger.warn('ROUTE action missing task_id; cannot perform routing');
      return;
    }

    await this.taskService.assignTask(payload.task_id, {
      assignee_role: payload.assignee_role,
      actor_user_id: payload.actor_user_id,
      assignee_user_id: payload.assignee_user_id,
    });
  }

  private async handleEscalateAction(action: WorkflowAction): Promise<void> {
    const payload = (action.payload ?? {}) as {
      task_id?: string;
      reason?: string;
      actor_user_id?: string;
      [key: string]: unknown;
    };

    if (!payload.task_id) {
      this.logger.warn(
        'ESCALATE action missing task_id; cannot perform escalation',
      );
      return;
    }

    await this.taskService.escalateTask(payload.task_id, {
      reason: payload.reason ?? 'Escalation triggered by workflow',
      actor_user_id: payload.actor_user_id,
    });
  }

  private async handleNotifyAction(action: WorkflowAction): Promise<number> {
    const payload = (action.payload ?? {}) as NotifyActionPayload;

    if (!payload.task_id || !payload.event_type) {
      this.logger.debug(
        'NOTIFY action missing task_id or event_type; nothing to do',
      );
      return 0;
    }

    const taskResult = (await this.taskService.getTaskById(
      payload.task_id,
    )) as OrgoResult<TaskDTO>;

    if (!taskResult.ok || !taskResult.data) {
      this.logger.warn(
        `NOTIFY action could not load task ${payload.task_id}; skipping notification`,
      );
      return 0;
    }

    const notifyResult = await this.notificationService.sendTaskNotification(
      taskResult.data,
      payload.event_type,
    );

    if (!notifyResult.ok) {
      this.logger.warn(
        `sendTaskNotification failed for task ${
          payload.task_id
        }: ${notifyResult.error?.code ?? 'UNKNOWN_ERROR'}`,
      );
      return 0;
    }

    return 1;
  }
}

===== END apps/api/src/orgo/core/email/email-router.service.ts =====


===== BEGIN apps/api/src/orgo/core/email/email-validator.service.ts =====
import { Injectable, Logger } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';

/**
 * Shape of a single email attachment as seen by the email gateway.
 * This is a logical view over the underlying email_attachments table.
 */
export interface EmailAttachment {
  filename?: string | null;
  contentType?: string | null; // MIME type, e.g. "application/pdf"
  size?: number | null; // size in bytes, if known
}

/**
 * Parsed email payload shape expected by the validator.
 * Typically produced by an EmailParserService before validation.
 */
export interface ParsedEmailPayload {
  subject?: string | null;
  fromAddress?: string | null;
  toAddresses?: string[] | null;
  ccAddresses?: string[] | null;
  bccAddresses?: string[] | null;
  textBody?: string | null;
  htmlBody?: string | null;
  attachments?: EmailAttachment[] | null;

  /**
   * Optional raw size hint (in bytes). If provided, this will be used as an
   * upper bound when computing total message size.
   */
  rawSizeBytes?: number | null;
}

/**
 * Canonical service error shape for Core Services:
 * aligns with the `{ ok, data, error }` result contract.
 */
export interface ServiceError {
  code: string;
  message: string;
  details?: Record<string, unknown>;
}

/**
 * Canonical service result wrapper used by core services.
 */
export interface ServiceResult<T> {
  ok: boolean;
  data: T | null;
  error: ServiceError | null;
}

/**
 * High‑level summary returned on successful validation.
 */
export interface EmailValidationSummary {
  totalSizeBytes: number;
  maxSizeBytes: number;
  attachmentCount: number;
}

/**
 * Email limits derived from configuration.
 * Mirrors the `limits` section of `email_config.yaml`.
 */
export interface EmailLimitsConfig {
  maxEmailSizeMb: number;
  allowedAttachmentMimetypes: string[];
}

/**
 * Email validator for the Email Gateway.
 *
 * Responsibilities:
 *  - Enforce required fields on parsed email payloads.
 *  - Enforce max total email size (default 10MB, configurable).
 *  - Enforce allowed attachment MIME types.
 *  - Return a standard `{ ok, data, error }` result shape.
 */
@Injectable()
export class EmailValidatorService {
  private readonly logger = new Logger(EmailValidatorService.name);

  private readonly maxEmailSizeBytes: number;
  private readonly allowedAttachmentMimetypes: Set<string>;

  // Defaults taken from the email config example in the Core Services spec.
  private static readonly DEFAULT_MAX_EMAIL_SIZE_MB = 10;
  private static readonly DEFAULT_ALLOWED_MIMETYPES: string[] = [
    'application/pdf',
    'image/png',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
  ];

  constructor(private readonly configService: ConfigService) {
    const limits = this.loadLimitsFromConfig();

    this.maxEmailSizeBytes = limits.maxEmailSizeMb * 1024 * 1024;
    this.allowedAttachmentMimetypes = new Set(
      limits.allowedAttachmentMimetypes.map((mt) => mt.toLowerCase()),
    );
  }

  /**
   * Validate a parsed email payload against Orgo's email limits and invariants.
   *
   * On success:
   *   { ok: true, data: { totalSizeBytes, maxSizeBytes, attachmentCount }, error: null }
   *
   * On failure:
   *   { ok: false, data: null, error: { code, message, details: { issues: [...] } } }
   */
  validateEmailPayload(
    payload: ParsedEmailPayload,
  ): ServiceResult<EmailValidationSummary> {
    const issues: Array<{
      code: string;
      message: string;
      field?: string;
      attachmentName?: string | null;
    }> = [];

    // 1. Required fields: subject, from, to, and at least one body.
    if (!payload.subject || !payload.subject.trim()) {
      issues.push({
        code: 'MISSING_SUBJECT',
        message: 'Email subject is required.',
        field: 'subject',
      });
    }

    if (!payload.fromAddress || !payload.fromAddress.trim()) {
      issues.push({
        code: 'MISSING_FROM_ADDRESS',
        message: 'From address is required.',
        field: 'fromAddress',
      });
    } else if (!this.isValidEmailAddress(payload.fromAddress)) {
      issues.push({
        code: 'INVALID_FROM_ADDRESS',
        message: 'From address is not a valid email address.',
        field: 'fromAddress',
      });
    }

    const toAddresses = payload.toAddresses ?? [];
    if (!Array.isArray(toAddresses) || toAddresses.length === 0) {
      issues.push({
        code: 'MISSING_TO_ADDRESSES',
        message: 'At least one recipient (to) address is required.',
        field: 'toAddresses',
      });
    } else {
      for (const addr of toAddresses) {
        if (!this.isValidEmailAddress(addr)) {
          issues.push({
            code: 'INVALID_TO_ADDRESS',
            message: `Recipient address "${addr}" is not valid.`,
            field: 'toAddresses',
          });
        }
      }
    }

    const hasTextBody = !!(payload.textBody && payload.textBody.trim());
    const hasHtmlBody = !!(payload.htmlBody && payload.htmlBody.trim());
    if (!hasTextBody && !hasHtmlBody) {
      issues.push({
        code: 'MISSING_BODY',
        message:
          'Email body is required (either textBody or htmlBody must be non-empty).',
        field: 'textBody/htmlBody',
      });
    }

    // 2. Attachment MIME type validation against allowed list.
    const attachments = payload.attachments ?? [];
    for (const attachment of attachments) {
      const contentType = (attachment.contentType ?? '').toLowerCase().trim();
      // If content type is missing or not allowed, treat as invalid.
      if (!contentType || !this.allowedAttachmentMimetypes.has(contentType)) {
        issues.push({
          code: 'EMAIL_ATTACHMENT_TYPE_NOT_ALLOWED',
          message: `Attachment "${
            attachment.filename ?? 'unnamed'
          }" has disallowed or unknown MIME type "${
            attachment.contentType ?? 'unknown'
          }".`,
          field: 'attachments',
          attachmentName: attachment.filename ?? null,
        });
      }
    }

    // 3. Total size validation (payload + attachments) vs configured max.
    const totalSizeBytes = this.computeApproximateSize(payload);
    if (totalSizeBytes > this.maxEmailSizeBytes) {
      issues.push({
        code: 'EMAIL_SIZE_EXCEEDED',
        message: `Email exceeds maximum size of ${this.maxEmailSizeBytes} bytes.`,
        field: 'rawSizeBytes',
      });
    }

    if (issues.length > 0) {
      this.logger.warn(
        `Email validation failed with ${issues.length} issue(s). First: ${issues[0].code} – ${issues[0].message}`,
      );

      return {
        ok: false,
        data: null,
        error: {
          code: 'EMAIL_VALIDATION_ERROR',
          message: 'Parsed email payload failed validation.',
          details: { issues },
        },
      };
    }

    const summary: EmailValidationSummary = {
      totalSizeBytes,
      maxSizeBytes: this.maxEmailSizeBytes,
      attachmentCount: attachments.length,
    };

    return {
      ok: true,
      data: summary,
      error: null,
    };
  }

  /**
   * Load email limits from configuration.
   *
   * This implementation uses environment variables via Nest ConfigService:
   *   - EMAIL_MAX_SIZE_MB (number, defaults to 10)
   *   - EMAIL_ALLOWED_ATTACHMENT_MIMETYPES (comma‑separated list of MIME types)
   *
   * This is intentionally compatible with the `email_config.yaml` structure
   * described in the Core Services spec; a future Orgo config loader can hydrate
   * these into environment variables or ConfigService keys.
   */
  private loadLimitsFromConfig(): EmailLimitsConfig {
    const maxSizeFromEnv = this.configService.get<number | string>(
      'EMAIL_MAX_SIZE_MB',
    );
    const maxEmailSizeMb =
      typeof maxSizeFromEnv === 'number'
        ? maxSizeFromEnv
        : maxSizeFromEnv
        ? Number.parseInt(maxSizeFromEnv, 10)
        : EmailValidatorService.DEFAULT_MAX_EMAIL_SIZE_MB;

    const allowedFromEnv = this.configService.get<string>(
      'EMAIL_ALLOWED_ATTACHMENT_MIMETYPES',
    );

    const allowedAttachmentMimetypes =
      typeof allowedFromEnv === 'string' && allowedFromEnv.trim().length > 0
        ? allowedFromEnv
            .split(',')
            .map((s) => s.trim())
            .filter((s) => s.length > 0)
        : EmailValidatorService.DEFAULT_ALLOWED_MIMETYPES;

    return {
      maxEmailSizeMb:
        Number.isFinite(maxEmailSizeMb) && maxEmailSizeMb > 0
          ? maxEmailSizeMb
          : EmailValidatorService.DEFAULT_MAX_EMAIL_SIZE_MB,
      allowedAttachmentMimetypes,
    };
  }

  /**
   * Compute an approximate total size of the email (in bytes), using:
   *  - rawSizeBytes if provided (as an upper bound),
   *  - otherwise, the UTF‑8 byte length of key string fields plus attachment sizes.
   */
  private computeApproximateSize(payload: ParsedEmailPayload): number {
    // If a raw size hint is provided and positive, trust it.
    if (typeof payload.rawSizeBytes === 'number' && payload.rawSizeBytes > 0) {
      return payload.rawSizeBytes;
    }

    let total = 0;

    const addString = (value?: string | null) => {
      if (!value) return;
      total += Buffer.byteLength(value, 'utf8');
    };

    addString(payload.subject);
    addString(payload.fromAddress);

    (payload.toAddresses ?? []).forEach(addString);
    (payload.ccAddresses ?? []).forEach(addString);
    (payload.bccAddresses ?? []).forEach(addString);

    addString(payload.textBody);
    addString(payload.htmlBody);

    for (const attachment of payload.attachments ?? []) {
      if (typeof attachment.size === 'number' && attachment.size > 0) {
        total += attachment.size;
      }
      addString(attachment.filename ?? undefined);
      addString(attachment.contentType ?? undefined);
    }

    return total;
  }

  /**
   * Very conservative RFC‑2822‑style email address validator.
   * This is intentionally simple; higher‑fidelity validation can be added later.
   */
  private isValidEmailAddress(address: string): boolean {
    const trimmed = address.trim();
    if (!trimmed) {
      return false;
    }

    // Basic pattern: local@domain with at least one dot in the domain.
    const basicEmailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    return basicEmailRegex.test(trimmed);
  }
}

===== END apps/api/src/orgo/core/email/email-validator.service.ts =====


===== BEGIN apps/api/src/orgo/core/email/email.controller.ts =====
import {
  Body,
  Controller,
  Get,
  HttpCode,
  HttpException,
  HttpStatus,
  Post,
  Query,
} from '@nestjs/common';
import { ApiOperation, ApiResponse, ApiTags } from '@nestjs/swagger';
import { EmailService } from './email.service';
import { LogService } from '../logging/log.service';
import {
  FN_EMAIL_SEND,
  FN_EMAIL_SEND_TEST,
  FN_EMAIL_POLL_MAILBOX,
  FN_EMAIL_CONFIG_STATUS,
} from '../functional-ids';

/**
 * Standard Orgo result shape for Core Services.
 * EmailService implementations should return this shape.
 */
interface OrgoResult<T> {
  ok: boolean;
  data: T | null;
  error: {
    code: string;
    message: string;
    details?: Record<string, unknown>;
  } | null;
}

/**
 * Request body for sending an email (transactional / notification style).
 * This mirrors the logical EMAIL_MESSAGE envelope in Doc 5.
 */
export class SendEmailRequestDto {
  /**
   * Optional organization context; if omitted, EmailService should
   * resolve a default org / config (e.g. "default").
   */
  organizationId?: string;

  /**
   * Primary recipients (RFC822 email addresses).
   */
  to!: string[];

  /**
   * Optional CC recipients.
   */
  cc?: string[];

  /**
   * Optional BCC recipients.
   */
  bcc?: string[];

  /**
   * Subject line (required, non‑empty).
   */
  subject!: string;

  /**
   * Email body as plain text or HTML (EmailService will normalize).
   */
  body!: string;

  /**
   * Optional idempotency key so callers can safely retry a send
   * without creating duplicate outbound messages.
   */
  idempotencyKey?: string;
}

/**
 * Request body for sending a test email to verify configuration.
 * Slimmer than SendEmailRequestDto on purpose.
 */
export class SendTestEmailRequestDto {
  /**
   * Optional organization context for multi‑tenant config lookup.
   */
  organizationId?: string;

  /**
   * Target address for the test email.
   */
  to!: string;

  /**
   * Optional human‑friendly label for the test.
   * Used only for logging / templates.
   */
  label?: string;
}

/**
 * Request body for manually polling an inbound mailbox.
 */
export class PollMailboxRequestDto {
  /**
   * Optional organization context; if omitted, service will decide
   * which default mailbox / org to poll.
   */
  organizationId?: string;

  /**
   * Maximum number of messages to fetch in this run.
   * If omitted, EmailService will use its default batch size.
   */
  maxCount?: number;

  /**
   * If true, run parsing/validation without committing
   * side‑effects (debug / diagnostics mode).
   */
  dryRun?: boolean;
}

/**
 * Minimal response for a successful send.
 */
export class EmailSendResponseDto {
  /**
   * Identifier of the stored outbound email message, if any.
   */
  emailMessageId?: string;

  /**
   * Underlying provider / SMTP message identifier, if available.
   */
  providerMessageId?: string;

  /**
   * Whether the message has been handed off to the provider.
   */
  accepted!: boolean;
}

/**
 * Status snapshot for the outbound / inbound email configuration.
 */
export class EmailStatusResponseDto {
  outboundConfigured!: boolean;
  inboundConfigured!: boolean;
  lastSuccessfulOutboundAt?: string | null;
  lastSuccessfulInboundAt?: string | null;
  issues!: string[];
}

/**
 * Result of a manual mailbox poll.
 */
export class PollMailboxResponseDto {
  /**
   * Number of raw messages fetched from the mailbox.
   */
  fetched!: number;

  /**
   * Number of messages successfully parsed into EMAIL_MESSAGE envelopes.
   */
  parsed!: number;

  /**
   * Number of messages rejected due to validation / limits.
   */
  rejected!: number;
}

@ApiTags('email')
@Controller('api/v3/email')
export class EmailController {
  constructor(
    private readonly emailService: EmailService,
    private readonly logService: LogService,
  ) {}

  /**
   * Send a transactional / notification email.
   *
   * This endpoint is primarily intended for internal Orgo modules
   * and admin tools, not for bulk marketing.
   */
  @Post('send')
  @HttpCode(HttpStatus.ACCEPTED)
  @ApiOperation({
    summary: 'Send email',
    description:
      'Send a transactional / notification email using the configured SMTP account for the organization.',
  })
  @ApiResponse({
    status: 202,
    description: 'Email accepted for delivery.',
    type: EmailSendResponseDto,
  })
  async sendEmail(
    @Body() body: SendEmailRequestDto,
  ): Promise<EmailSendResponseDto> {
    const result: OrgoResult<EmailSendResponseDto> =
      await this.emailService.sendEmail(body);

    return this.unwrapResult(result, {
      functionalId: FN_EMAIL_SEND,
      action: 'sendEmail',
      identifier: body.idempotencyKey,
      successMessage: 'Email accepted for delivery',
    });
  }

  /**
   * Send a simple test email to verify outbound configuration.
   */
  @Post('test')
  @HttpCode(HttpStatus.ACCEPTED)
  @ApiOperation({
    summary: 'Send test email',
    description:
      'Send a simple test email to verify SMTP configuration for an organization.',
  })
  @ApiResponse({
    status: 202,
    description: 'Test email accepted for delivery.',
    type: EmailSendResponseDto,
  })
  async sendTestEmail(
    @Body() body: SendTestEmailRequestDto,
  ): Promise<EmailSendResponseDto> {
    const result: OrgoResult<EmailSendResponseDto> =
      await this.emailService.sendTestEmail(body);

    return this.unwrapResult(result, {
      functionalId: FN_EMAIL_SEND_TEST,
      action: 'sendTestEmail',
      identifier: body.to,
      successMessage: 'Test email accepted for delivery',
    });
  }

  /**
   * Return a lightweight snapshot of email gateway health for the org.
   */
  @Get('status')
  @HttpCode(HttpStatus.OK)
  @ApiOperation({
    summary: 'Email gateway status',
    description:
      'Return a snapshot of inbound/outbound email configuration and recent health checks.',
  })
  @ApiResponse({
    status: 200,
    description: 'Status information for email gateway.',
    type: EmailStatusResponseDto,
  })
  async getStatus(
    @Query('organizationId') organizationId?: string,
  ): Promise<EmailStatusResponseDto> {
    const result: OrgoResult<EmailStatusResponseDto> =
      await this.emailService.getStatus({ organizationId });

    return this.unwrapResult(result, {
      functionalId: FN_EMAIL_CONFIG_STATUS,
      action: 'getStatus',
      identifier: organizationId,
      successMessage: 'Email gateway status fetched',
    });
  }

  /**
   * Manually trigger a mailbox poll.
   *
   * This is mainly for development, diagnostics, or controlled
   * backfills; normal ingestion should run via background workers.
   */
  @Post('poll')
  @HttpCode(HttpStatus.OK)
  @ApiOperation({
    summary: 'Poll inbound mailbox',
    description:
      'Manually poll the configured inbound mailbox and ingest up to `maxCount` messages.',
  })
  @ApiResponse({
    status: 200,
    description: 'Mailbox poll result.',
    type: PollMailboxResponseDto,
  })
  async pollMailbox(
    @Body() body: PollMailboxRequestDto,
  ): Promise<PollMailboxResponseDto> {
    const result: OrgoResult<PollMailboxResponseDto> =
      await this.emailService.pollMailbox(body);

    return this.unwrapResult(result, {
      functionalId: FN_EMAIL_POLL_MAILBOX,
      action: 'pollMailbox',
      identifier: body.organizationId,
      successMessage: 'Mailbox polled successfully',
    });
  }

  /**
   * Helper to unify handling of OrgoResult responses:
   *  - Logs success or failure.
   *  - Maps error codes to HTTP exceptions.
   *  - Returns the inner data on success.
   */
  private unwrapResult<T>(
    result: OrgoResult<T>,
    opts: {
      functionalId: string;
      action: string;
      identifier?: string | null;
      successMessage: string;
    },
  ): T {
    const { functionalId, action, identifier, successMessage } = opts;

    if (result.ok && result.data !== null) {
      this.logService.logEvent({
        category: 'EMAIL',
        logLevel: 'INFO',
        message: successMessage,
        identifier: identifier ?? undefined,
        metadata: {
          fn: functionalId,
          action,
        },
      });

      return result.data;
    }

    const error = result.error ?? {
      code: 'UNKNOWN_ERROR',
      message: 'Unknown error in EmailService',
    };

    this.logService.logEvent({
      category: 'EMAIL',
      logLevel: 'ERROR',
      message: error.message,
      identifier: identifier ?? undefined,
      metadata: {
        fn: functionalId,
        action,
        errorCode: error.code,
        errorDetails: error.details ?? undefined,
      },
    });

    const status = this.mapErrorCodeToHttpStatus(error.code);

    throw new HttpException(
      {
        code: error.code,
        message: error.message,
        details: error.details,
      },
      status,
    );
  }

  /**
   * Map Orgo core error codes to HTTP status codes.
   */
  private mapErrorCodeToHttpStatus(code: string): HttpStatus {
    if (code.endsWith('_VALIDATION_ERROR')) {
      return HttpStatus.BAD_REQUEST;
    }

    if (
      code === 'EMAIL_SEND_FAILED' ||
      code === 'EMAIL_PARSING_ERROR' ||
      code === 'EMAIL_GATEWAY_UNAVAILABLE'
    ) {
      return HttpStatus.BAD_GATEWAY;
    }

    return HttpStatus.INTERNAL_SERVER_ERROR;
  }
}

===== END apps/api/src/orgo/core/email/email.controller.ts =====


===== BEGIN apps/api/src/orgo/core/email/email.module.ts =====
// apps/api/src/orgo/core/email/email.module.ts

import { Module } from '@nestjs/common';

import { PersistenceModule } from '../../../persistence/persistence.module';
import { LoggerModule } from '../logging/logger.module';
import { WorkflowModule } from '../workflow/workflow.module';
import { TaskModule } from '../tasks/task.module';
import { OrgoConfigModule } from '../../config/config.module';

import { EmailService } from './email.service';
import { EmailParserService } from './email-parser.service';
import { EmailValidatorService } from './email-validator.service';
import { EmailIngestService } from './email-ingest.service';
import { EmailRouterService } from './email-router.service';

/**
 * EmailModule
 *
 * Wires up the Orgo email gateway (“email_gateway” core service):
 * - EmailIngestService: polling / fetching raw emails
 * - EmailParserService: normalisation into EMAIL_MESSAGE envelopes
 * - EmailValidatorService: size / attachment / field validation
 * - EmailRouterService: hand-off into the workflow engine
 * - EmailService: public façade used by other modules to send email
 *
 * Dependencies:
 * - PersistenceModule: access to the database (PrismaService)
 * - LoggerModule: structured logging for EMAIL / WORKFLOW categories
 * - WorkflowModule: to route parsed emails into workflows / tasks
 * - TaskModule: task creation / linkage when workflows produce tasks
 * - OrgoConfigModule: access to YAML-based email configuration
 */
@Module({
  imports: [
    PersistenceModule,
    LoggerModule,
    WorkflowModule,
    TaskModule,
    OrgoConfigModule,
  ],
  providers: [
    EmailService,
    EmailParserService,
    EmailValidatorService,
    EmailIngestService,
    EmailRouterService,
  ],
  exports: [
    EmailService,
    EmailParserService,
    EmailValidatorService,
    EmailIngestService,
    EmailRouterService,
  ],
})
export class EmailModule {}

===== END apps/api/src/orgo/core/email/email.module.ts =====


===== BEGIN apps/api/src/orgo/core/email/email.service.ts =====
import { Injectable } from '@nestjs/common';
import nodemailer, { Transporter } from 'nodemailer';

import { OrgoConfigService } from '../../config/config.service';
import { LogService } from '../logging/log.service';
import { FN_EMAIL_SEND } from '../functional-ids';

export interface ServiceError {
  code: string;
  message: string;
  // Free-form extra details; must be safe to log.
  details?: Record<string, unknown>;
}

export interface ServiceResult<T> {
  ok: boolean;
  data: T | null;
  error: ServiceError | null;
}

export interface EmailAttachment {
  filename: string;
  content: Buffer | string;
  contentType?: string;
}

export interface SendEmailOptions {
  to: string | string[];
  subject: string;
  text?: string;
  html?: string;
  cc?: string | string[];
  bcc?: string | string[];
  replyTo?: string;
  headers?: Record<string, string>;
  attachments?: EmailAttachment[];
  /**
   * Optional explicit from header, e.g. `"Orgo" <no-reply@example.org>`.
   * If omitted, a default from the email config (or a safe fallback) will be used.
   */
  fromOverride?: string;
}

/**
 * Shape of the email config as returned by OrgoConfigService.
 * This mirrors the core parts of /config/email/email_config.yaml (Doc 5).
 */
export interface EmailConfig {
  smtp: {
    host: string;
    port: number;
    use_tls?: boolean;
    use_ssl?: boolean;
    username_env?: string;
    password_env?: string;
    connection_timeout_secs?: number;
    send_timeout_secs?: number;
    max_retries?: number;
    retry_backoff_secs?: number;
  };
  limits?: {
    max_email_size_mb?: number;
    allowed_attachment_mimetypes?: string[];
  };
}

/**
 * Result payload for a successful sendEmail call.
 */
export interface EmailSendData {
  messageId: string;
  accepted: string[];
  rejected: string[];
}

/**
 * Core EmailService for Orgo.
 *
 * Responsibilities (aligned with Core Services spec, Doc 5):
 *  - Send outbound email via SMTP using configuration from OrgoConfigService.
 *  - Enforce basic validation and configured size limits.
 *  - Apply retry + backoff on transient failures.
 *  - Emit structured log events via LogService.
 *
 * It returns the standard `{ ok, data, error }` result shape.
 */
@Injectable()
export class EmailService {
  private transporter: Transporter | null = null;

  constructor(
    private readonly config: OrgoConfigService,
    private readonly logService: LogService,
  ) {}

  /**
   * Public entrypoint used by NotificationService and other core services.
   */
  async sendEmail(
    options: SendEmailOptions,
  ): Promise<ServiceResult<EmailSendData>> {
    const emailConfig = this.config.getEmailConfig?.() as EmailConfig | undefined;

    if (!emailConfig || !emailConfig.smtp) {
      this.logService.logEvent({
        category: 'EMAIL',
        logLevel: 'ERROR',
        message: 'Email config missing; cannot send email',
        identifier: FN_EMAIL_SEND,
        metadata: {
          reason: 'email_config_missing',
        },
      });

      return {
        ok: false,
        data: null,
        error: {
          code: 'EMAIL_CONFIG_ERROR',
          message: 'Email configuration is missing or invalid',
        },
      };
    }

    const validationError = this.validateOutgoingEmail(options, emailConfig);
    if (validationError) {
      this.logService.logEvent({
        category: 'EMAIL',
        logLevel: 'WARNING',
        message: 'Outgoing email validation failed',
        identifier: FN_EMAIL_SEND,
        metadata: {
          code: validationError.code,
          details: validationError.details,
        },
      });

      return {
        ok: false,
        data: null,
        error: validationError,
      };
    }

    try {
      const transporter = await this.ensureTransporter(emailConfig);
      const { to, cc, bcc } = this.normalizeRecipients(options);
      const from = this.resolveFrom(options, emailConfig);

      const mailOptions = {
        from,
        to,
        cc,
        bcc,
        subject: options.subject,
        text: options.text,
        html: options.html,
        replyTo: options.replyTo,
        headers: options.headers,
        attachments: options.attachments?.map((att) => ({
          filename: att.filename,
          content: att.content,
          contentType: att.contentType,
        })),
      };

      const maxRetries =
        emailConfig.smtp.max_retries !== undefined
          ? emailConfig.smtp.max_retries
          : 3;
      const retryBackoffSecs =
        emailConfig.smtp.retry_backoff_secs !== undefined
          ? emailConfig.smtp.retry_backoff_secs
          : 2;

      let lastError: unknown;

      for (let attempt = 1; attempt <= Math.max(1, maxRetries); attempt += 1) {
        try {
          const info = await transporter.sendMail(mailOptions);

          this.logService.logEvent({
            category: 'EMAIL',
            logLevel: 'INFO',
            message: 'Email sent',
            identifier: FN_EMAIL_SEND,
            metadata: {
              to,
              cc,
              bcc,
              messageId: info.messageId,
              attempt,
            },
          });

          return {
            ok: true,
            data: {
              messageId: info.messageId,
              accepted: Array.isArray(info.accepted)
                ? info.accepted.map(String)
                : [],
              rejected: Array.isArray(info.rejected)
                ? info.rejected.map(String)
                : [],
            },
            error: null,
          };
        } catch (err) {
          lastError = err;

          const transient = this.isTransientError(err);

          this.logService.logEvent({
            category: 'EMAIL',
            logLevel: transient ? 'WARNING' : 'ERROR',
            message: 'Email send attempt failed',
            identifier: FN_EMAIL_SEND,
            metadata: {
              to,
              attempt,
              transient,
              errorMessage:
                err instanceof Error ? err.message : 'Unknown error',
            },
          });

          const isLastAttempt =
            attempt === maxRetries || !transient || maxRetries <= 1;
          if (isLastAttempt) {
            break;
          }

          const backoffMs = retryBackoffSecs * 1000 * attempt;
          await this.sleep(backoffMs);
        }
      }

      const errorMessage =
        lastError instanceof Error
          ? lastError.message
          : 'Unknown error while sending email';

      this.logService.logEvent({
        category: 'EMAIL',
        logLevel: 'ERROR',
        message: 'Email send failed after retries',
        identifier: FN_EMAIL_SEND,
        metadata: {
          to: this.normalizeRecipients(options).to,
          errorMessage,
        },
      });

      return {
        ok: false,
        data: null,
        error: {
          code: 'EMAIL_SEND_FAILED',
          message: errorMessage,
        },
      };
    } catch (err) {
      const message =
        err instanceof Error ? err.message : 'Unknown error in EmailService';

      this.logService.logEvent({
        category: 'EMAIL',
        logLevel: 'ERROR',
        message: 'Unexpected error in EmailService.sendEmail',
        identifier: FN_EMAIL_SEND,
        metadata: {
          errorMessage: message,
        },
      });

      return {
        ok: false,
        data: null,
        error: {
          code: 'EMAIL_UNEXPECTED_ERROR',
          message,
        },
      };
    }
  }

  /**
   * Validates the outgoing email against the minimal Orgo rules
   * and configured size limits.
   */
  private validateOutgoingEmail(
    options: SendEmailOptions,
    emailConfig: EmailConfig,
  ): ServiceError | null {
    const { to } = this.normalizeRecipients(options);

    if (!to.length) {
      return {
        code: 'EMAIL_VALIDATION_ERROR',
        message: 'At least one recipient is required',
        details: { field: 'to' },
      };
    }

    if (!options.subject || !options.subject.trim()) {
      return {
        code: 'EMAIL_VALIDATION_ERROR',
        message: 'Subject is required',
        details: { field: 'subject' },
      };
    }

    if (!options.text && !options.html) {
      return {
        code: 'EMAIL_VALIDATION_ERROR',
        message: 'Either text or html body is required',
        details: { field: 'text|html' },
      };
    }

    const maxMb = emailConfig.limits?.max_email_size_mb;
    if (maxMb && maxMb > 0) {
      const approxMb = this.approximateEmailSizeMb(options);
      if (approxMb > maxMb) {
        return {
          code: 'EMAIL_SIZE_EXCEEDED',
          message: `Email size ${approxMb.toFixed(
            2,
          )} MB exceeds configured maximum of ${maxMb} MB`,
          details: {
            approximateSizeMb: approxMb,
            maxAllowedMb: maxMb,
          },
        };
      }
    }

    const allowedTypes = emailConfig.limits?.allowed_attachment_mimetypes;
    if (allowedTypes && allowedTypes.length && options.attachments?.length) {
      const disallowed = new Set<string>();

      for (const att of options.attachments) {
        if (!att.contentType) {
          continue;
        }
        if (!allowedTypes.includes(att.contentType)) {
          disallowed.add(att.contentType);
        }
      }

      if (disallowed.size > 0) {
        return {
          code: 'EMAIL_ATTACHMENT_TYPE_NOT_ALLOWED',
          message: 'One or more attachment MIME types are not allowed',
          details: {
            disallowedTypes: Array.from(disallowed),
            allowedTypes,
          },
        };
      }
    }

    return null;
  }

  /**
   * Creates or returns a cached nodemailer transporter
   * based on the configured SMTP settings.
   */
  private async ensureTransporter(emailConfig: EmailConfig): Promise<Transporter> {
    if (this.transporter) {
      return this.transporter;
    }

    const { smtp } = emailConfig;

    if (!smtp.host || !smtp.port) {
      throw new Error('SMTP host and port must be configured');
    }

    const user =
      smtp.username_env && process.env[smtp.username_env]
        ? process.env[smtp.username_env]
        : undefined;
    const pass =
      smtp.password_env && process.env[smtp.password_env]
        ? process.env[smtp.password_env]
        : undefined;

    const secure =
      smtp.use_ssl !== undefined
        ? smtp.use_ssl
        : smtp.port === 465 || smtp.use_tls === true;

    const connectionTimeoutMs = (smtp.connection_timeout_secs ?? 10) * 1000;
    const socketTimeoutMs = (smtp.send_timeout_secs ?? 30) * 1000;

    const transporter = nodemailer.createTransport({
      host: smtp.host,
      port: smtp.port,
      secure,
      auth:
        user && pass
          ? {
              user,
              pass,
            }
          : undefined,
      connectionTimeout: connectionTimeoutMs,
      socketTimeout: socketTimeoutMs,
    });

    // Verify connection once at startup of the transporter.
    try {
      await transporter.verify();
      this.logService.logEvent({
        category: 'EMAIL',
        logLevel: 'INFO',
        message: 'SMTP transport verified',
        identifier: FN_EMAIL_SEND,
        metadata: {
          host: smtp.host,
          port: smtp.port,
        },
      });
    } catch (err) {
      const message =
        err instanceof Error
          ? err.message
          : 'Failed to verify SMTP connection';

      this.logService.logEvent({
        category: 'EMAIL',
        logLevel: 'ERROR',
        message: 'SMTP verification failed',
        identifier: FN_EMAIL_SEND,
        metadata: {
          host: smtp.host,
          port: smtp.port,
          errorMessage: message,
        },
      });

      // Let callers see the failure as EMAIL_CONFIG_ERROR or EMAIL_SEND_FAILED.
      throw new Error(`SMTP verification failed: ${message}`);
    }

    this.transporter = transporter;
    return transporter;
  }

  private normalizeRecipients(options: SendEmailOptions): {
    to: string[];
    cc: string[];
    bcc: string[];
  } {
    const normalize = (value?: string | string[]): string[] => {
      if (!value) return [];
      if (Array.isArray(value)) {
        return value
          .map((v) => v.trim())
          .filter((v) => v.length > 0);
      }
      return value
        .split(',')
        .map((v) => v.trim())
        .filter((v) => v.length > 0);
    };

    return {
      to: normalize(options.to),
      cc: normalize(options.cc),
      bcc: normalize(options.bcc),
    };
  }

  /**
   * Resolve the "from" header from overrides or configuration.
   */
  private resolveFrom(
    options: SendEmailOptions,
    _emailConfig: EmailConfig,
  ): string {
    if (options.fromOverride && options.fromOverride.trim()) {
      return options.fromOverride.trim();
    }

    // Fallback; notification_config should typically provide a better sender.
    return 'Orgo System <no-reply@orgo.local>';
  }

  /**
   * Very rough approximation of email size in MB, used to enforce limits.
   * This is deliberately conservative and avoids buffering full MIME output.
   */
  private approximateEmailSizeMb(options: SendEmailOptions): number {
    let bytes = 0;

    const add = (value?: string) => {
      if (!value) return;
      bytes += Buffer.byteLength(value, 'utf8');
    };

    add(
      Array.isArray(options.to) ? options.to.join(',') : options.to ?? '',
    );
    add(
      Array.isArray(options.cc) ? options.cc.join(',') : options.cc ?? '',
    );
    add(
      Array.isArray(options.bcc)
        ? options.bcc.join(',')
        : options.bcc ?? '',
    );
    add(options.subject);
    add(options.text);
    add(options.html);

    if (options.attachments) {
      for (const att of options.attachments) {
        if (typeof att.content === 'string') {
          bytes += Buffer.byteLength(att.content, 'utf8');
        } else {
          bytes += att.content.length;
        }
        add(att.filename);
        if (att.contentType) add(att.contentType);
      }
    }

    return bytes / (1024 * 1024);
  }

  /**
   * Heuristic detection of transient SMTP / network errors.
   * Used to decide whether to retry.
   */
  private isTransientError(err: unknown): boolean {
    if (!err || typeof err !== 'object') {
      return false;
    }

    const anyErr = err as { code?: string; responseCode?: number };

    const transientNodeErrorCodes = new Set([
      'ETIMEDOUT',
      'ECONNRESET',
      'EAI_AGAIN',
      'ECONNREFUSED',
      'ENOTFOUND',
    ]);

    if (anyErr.code && transientNodeErrorCodes.has(anyErr.code)) {
      return true;
    }

    // For SMTP codes, treat typical resource/availability issues as transient.
    if (typeof anyErr.responseCode === 'number') {
      const code = anyErr.responseCode;
      if (
        code === 421 || // Service not available, closing transmission channel
        code === 450 || // Requested mail action not taken: mailbox unavailable
        code === 451 || // Local error in processing
        code === 452 // Insufficient system storage
      ) {
        return true;
      }
    }

    return false;
  }

  private sleep(ms: number): Promise<void> {
    return new Promise((resolve) => {
      setTimeout(resolve, ms);
    });
  }
}

===== END apps/api/src/orgo/core/email/email.service.ts =====


===== BEGIN apps/api/src/orgo/core/functional-ids.ts =====
/**
 * Stable functional identifiers for Orgo v3.
 *
 * Pattern: FN_<MODULE>_<ACTION>
 *
 * These IDs are used in:
 * - Structured logging (`identifier` field in LOG_EVENT)
 * - Analytics / Insights dimensions
 * - Configuration & feature flags (per-function overrides)
 *
 * This file must stay in sync with:
 * - apps/web/src/orgo/core/functional-ids.ts
 * - Doc 4 – Functional Code-Name Inventory
 */

/* ------------------------------------------------------------------------- */
/* Backbone: Organizations, Persons, Identity & RBAC                         */
/* ------------------------------------------------------------------------- */

export const FN_ORG_CREATE_ORGANIZATION = 'FN_ORG_CREATE_ORGANIZATION' as const;
export const FN_ORG_UPDATE_ORGANIZATION = 'FN_ORG_UPDATE_ORGANIZATION' as const;

export const FN_PERSON_UPSERT_PERSON_PROFILE =
  'FN_PERSON_UPSERT_PERSON_PROFILE' as const;

export const FN_RBAC_CREATE_ROLE = 'FN_RBAC_CREATE_ROLE' as const;
export const FN_RBAC_ASSIGN_PERMISSION = 'FN_RBAC_ASSIGN_PERMISSION' as const;
export const FN_RBAC_ASSIGN_USER_ROLE = 'FN_RBAC_ASSIGN_USER_ROLE' as const;

export const FN_IDENTITY_LINK_USER_TO_PERSON =
  'FN_IDENTITY_LINK_USER_TO_PERSON' as const;

/* ------------------------------------------------------------------------- */
/* Signals & Ingestion: Email, API, Offline                                  */
/* ------------------------------------------------------------------------- */

export const FN_EMAIL_SEND = 'FN_EMAIL_SEND' as const;
export const FN_EMAIL_PARSE_INCOMING = 'FN_EMAIL_PARSE_INCOMING' as const;
export const FN_EMAIL_VALIDATE_PAYLOAD = 'FN_EMAIL_VALIDATE_PAYLOAD' as const;
export const FN_EMAIL_POLL_MAILBOX = 'FN_EMAIL_POLL_MAILBOX' as const;
export const FN_EMAIL_ROUTE_TO_WORKFLOW = 'FN_EMAIL_ROUTE_TO_WORKFLOW' as const;

export const FN_SIGNAL_INGEST = 'FN_SIGNAL_INGEST' as const;

export const FN_EMAIL_IMPORT_ARCHIVE = 'FN_EMAIL_IMPORT_ARCHIVE' as const;

export const FN_SYNC_OFFLINE_NODE = 'FN_SYNC_OFFLINE_NODE' as const;
export const FN_SYNC_OFFLINE_TASKS = 'FN_SYNC_OFFLINE_TASKS' as const;

/* ------------------------------------------------------------------------- */
/* Core: Cases, Tasks, Workflow, Escalations & Labels                        */
/* ------------------------------------------------------------------------- */

/** Case management */
export const FN_CASE_CREATE_FROM_SIGNAL =
  'FN_CASE_CREATE_FROM_SIGNAL' as const;
export const FN_CASE_CREATE = 'FN_CASE_CREATE' as const;
export const FN_CASE_GET_WITH_TASKS = 'FN_CASE_GET_WITH_TASKS' as const;
export const FN_CASE_RUN_CYCLIC_REVIEW =
  'FN_CASE_RUN_CYCLIC_REVIEW' as const;

/** Task management */
export const FN_TASK_CREATE = 'FN_TASK_CREATE' as const;
export const FN_TASK_UPDATE_STATUS = 'FN_TASK_UPDATE_STATUS' as const;
export const FN_TASK_ESCALATE = 'FN_TASK_ESCALATE' as const;
export const FN_TASK_ASSIGN = 'FN_TASK_ASSIGN' as const;
export const FN_TASK_ADD_COMMENT = 'FN_TASK_ADD_COMMENT' as const;
export const FN_TASK_GET_BY_ID = 'FN_TASK_GET_BY_ID' as const;

/** Workflow engine & escalation */
export const FN_WORKFLOW_EXECUTE = 'FN_WORKFLOW_EXECUTE' as const;
export const FN_WORKFLOW_VALIDATE_RULES =
  'FN_WORKFLOW_VALIDATE_RULES' as const;
export const FN_WORKFLOW_SIMULATE = 'FN_WORKFLOW_SIMULATE' as const;

export const FN_ESCALATION_EVALUATE = 'FN_ESCALATION_EVALUATE' as const;

/** Labels & routing */
export const FN_LABEL_RESOLVE = 'FN_LABEL_RESOLVE' as const;
export const FN_ROUTING_APPLY_RULES = 'FN_ROUTING_APPLY_RULES' as const;
export const FN_LABEL_CREATE_DEFINITION =
  'FN_LABEL_CREATE_DEFINITION' as const;
export const FN_LABEL_APPLY_TO_ENTITY = 'FN_LABEL_APPLY_TO_ENTITY' as const;

/* ------------------------------------------------------------------------- */
/* Configuration, Profiles & Feature Flags                                   */
/* ------------------------------------------------------------------------- */

export const FN_PROFILE_LOAD = 'FN_PROFILE_LOAD' as const;
export const FN_PROFILE_APPLY_DEFAULTS =
  'FN_PROFILE_APPLY_DEFAULTS' as const;
export const FN_PROFILE_PREVIEW_DIFF = 'FN_PROFILE_PREVIEW_DIFF' as const;

export const FN_CONFIG_GET_GLOBAL = 'FN_CONFIG_GET_GLOBAL' as const;
export const FN_CONFIG_UPDATE_SERVICE_CONFIG =
  'FN_CONFIG_UPDATE_SERVICE_CONFIG' as const;
export const FN_CONFIG_IMPORT_BUNDLE = 'FN_CONFIG_IMPORT_BUNDLE' as const;

export const FN_FEATURE_FLAG_SET = 'FN_FEATURE_FLAG_SET' as const;
export const FN_FEATURE_FLAG_EVALUATE = 'FN_FEATURE_FLAG_EVALUATE' as const;

/* ------------------------------------------------------------------------- */
/* Interfaces: Public API, Admin UI, Live Updates                            */
/* ------------------------------------------------------------------------- */

/** Public REST API – Tasks */
export const FN_API_LIST_TASKS = 'FN_API_LIST_TASKS' as const;
export const FN_API_GET_TASK = 'FN_API_GET_TASK' as const;
export const FN_API_CREATE_TASK = 'FN_API_CREATE_TASK' as const;
export const FN_API_UPDATE_TASK_STATUS =
  'FN_API_UPDATE_TASK_STATUS' as const;

/** Public REST API – Cases */
export const FN_API_LIST_CASES = 'FN_API_LIST_CASES' as const;
export const FN_API_GET_CASE = 'FN_API_GET_CASE' as const;

/** Public REST API – Workflows */
export const FN_API_EXECUTE_WORKFLOW = 'FN_API_EXECUTE_WORKFLOW' as const;

/** Admin UI screens */
export const FN_UI_ADMIN_TASK_OVERVIEW =
  'FN_UI_ADMIN_TASK_OVERVIEW' as const;
export const FN_UI_ADMIN_CASE_OVERVIEW =
  'FN_UI_ADMIN_CASE_OVERVIEW' as const;
export const FN_UI_ORG_PROFILE_SETTINGS =
  'FN_UI_ORG_PROFILE_SETTINGS' as const;

/** Notifications & live updates */
export const FN_NOTIFICATION_SEND_IN_APP =
  'FN_NOTIFICATION_SEND_IN_APP' as const;
export const FN_NOTIFICATION_SEND_EMAIL =
  'FN_NOTIFICATION_SEND_EMAIL' as const;

export const FN_GATEWAY_TASK_EVENTS_STREAM =
  'FN_GATEWAY_TASK_EVENTS_STREAM' as const;

/* ------------------------------------------------------------------------- */
/* Domain Modules: Maintenance, HR, Education, Generic Domain API           */
/* ------------------------------------------------------------------------- */

/** Maintenance domain */
export const FN_DOMAIN_MAINTENANCE_REGISTER_INCIDENT =
  'FN_DOMAIN_MAINTENANCE_REGISTER_INCIDENT' as const;
export const FN_DOMAIN_MAINTENANCE_LIST_INCIDENTS =
  'FN_DOMAIN_MAINTENANCE_LIST_INCIDENTS' as const;

/** HR domain */
export const FN_DOMAIN_HR_REGISTER_REPORT =
  'FN_DOMAIN_HR_REGISTER_REPORT' as const;
export const FN_DOMAIN_HR_LIST_CASES = 'FN_DOMAIN_HR_LIST_CASES' as const;

/** Education domain */
export const FN_DOMAIN_EDUCATION_REGISTER_STUDENT_INCIDENT =
  'FN_DOMAIN_EDUCATION_REGISTER_STUDENT_INCIDENT' as const;
export const FN_DOMAIN_EDUCATION_LIST_INCIDENTS =
  'FN_DOMAIN_EDUCATION_LIST_INCIDENTS' as const;

/** Generic domain abstractions */
export const FN_DOMAIN_TASK_FACTORY_CREATE =
  'FN_DOMAIN_TASK_FACTORY_CREATE' as const;
export const FN_DOMAIN_WORKFLOW_APPLY_OVERRIDES =
  'FN_DOMAIN_WORKFLOW_APPLY_OVERRIDES' as const;

/* ------------------------------------------------------------------------- */
/* Insights, Analytics & Cyclic Overview                                     */
/* ------------------------------------------------------------------------- */

export const FN_REPORTS_GET_TASK_VOLUME =
  'FN_REPORTS_GET_TASK_VOLUME' as const;
export const FN_REPORTS_GET_SLA_BREACHES =
  'FN_REPORTS_GET_SLA_BREACHES' as const;
export const FN_REPORTS_GET_PROFILE_SCORE =
  'FN_REPORTS_GET_PROFILE_SCORE' as const;

export const FN_ANALYTICS_EXPORT_FACTS =
  'FN_ANALYTICS_EXPORT_FACTS' as const;
export const FN_ANALYTICS_REFRESH_MATERIALIZED_VIEWS =
  'FN_ANALYTICS_REFRESH_MATERIALIZED_VIEWS' as const;

export const FN_INSIGHTS_RUN_WEEKLY_PATTERNS =
  'FN_INSIGHTS_RUN_WEEKLY_PATTERNS' as const;
export const FN_INSIGHTS_RUN_MONTHLY_TRENDS =
  'FN_INSIGHTS_RUN_MONTHLY_TRENDS' as const;
export const FN_INSIGHTS_RUN_YEARLY_SYSTEMIC_REVIEW =
  'FN_INSIGHTS_RUN_YEARLY_SYSTEMIC_REVIEW' as const;

export const FN_INSIGHTS_CACHE_WARM_DASHBOARDS =
  'FN_INSIGHTS_CACHE_WARM_DASHBOARDS' as const;

/* ------------------------------------------------------------------------- */
/* Infrastructure, Health, Metrics & Alerts                                  */
/* ------------------------------------------------------------------------- */

export const FN_HEALTH_GET = 'FN_HEALTH_GET' as const;
export const FN_WORKER_HEARTBEAT = 'FN_WORKER_HEARTBEAT' as const;

export const FN_METRICS_RECORD_WORKFLOW_LATENCY =
  'FN_METRICS_RECORD_WORKFLOW_LATENCY' as const;
export const FN_METRICS_RECORD_QUEUE_DEPTH =
  'FN_METRICS_RECORD_QUEUE_DEPTH' as const;

export const FN_ALERT_ESCALATION_DELAY =
  'FN_ALERT_ESCALATION_DELAY' as const;
export const FN_ALERT_ERROR_RATE = 'FN_ALERT_ERROR_RATE' as const;

/* ------------------------------------------------------------------------- */
/* Security, Privacy, Compliance & Logging                                   */
/* ------------------------------------------------------------------------- */

export const FN_AUTH_VALIDATE_ACCESS_TOKEN =
  'FN_AUTH_VALIDATE_ACCESS_TOKEN' as const;
export const FN_RBAC_CHECK_PERMISSION =
  'FN_RBAC_CHECK_PERMISSION' as const;

export const FN_PRIVACY_ANONYMIZE_PAYLOAD =
  'FN_PRIVACY_ANONYMIZE_PAYLOAD' as const;

export const FN_AUDIT_RECORD_EVENT = 'FN_AUDIT_RECORD_EVENT' as const;
export const FN_COMPLIANCE_EXPORT_AUDIT_LOG =
  'FN_COMPLIANCE_EXPORT_AUDIT_LOG' as const;
export const FN_INSIGHTS_EXPORT_ANALYTICS =
  'FN_INSIGHTS_EXPORT_ANALYTICS' as const;

/** Logging functions – `FN_LOG_SYSTEM_EVENT` is explicitly referenced in specs. */
export const FN_LOG_SYSTEM_EVENT = 'FN_LOG_SYSTEM_EVENT' as const;
export const FN_LOG_SECURITY_EVENT = 'FN_LOG_SECURITY_EVENT' as const;
export const FN_LOG_ROTATE_LOGS = 'FN_LOG_ROTATE_LOGS' as const;
export const FN_LOG_QUERY_ENTITY_ACTIVITY =
  'FN_LOG_QUERY_ENTITY_ACTIVITY' as const;

/** Validation helpers */
export const FN_CONFIG_VALIDATE_BUNDLE =
  'FN_CONFIG_VALIDATE_BUNDLE' as const;
export const FN_VALIDATE_API_PAYLOAD =
  'FN_VALIDATE_API_PAYLOAD' as const;
export const FN_METADATA_NORMALIZE = 'FN_METADATA_NORMALIZE' as const;

/* ------------------------------------------------------------------------- */
/* Aggregates & Type Helpers                                                 */
/* ------------------------------------------------------------------------- */

export const ALL_FUNCTIONAL_IDS = [
  /* Backbone */
  FN_ORG_CREATE_ORGANIZATION,
  FN_ORG_UPDATE_ORGANIZATION,
  FN_PERSON_UPSERT_PERSON_PROFILE,
  FN_RBAC_CREATE_ROLE,
  FN_RBAC_ASSIGN_PERMISSION,
  FN_RBAC_ASSIGN_USER_ROLE,
  FN_IDENTITY_LINK_USER_TO_PERSON,

  /* Signals & ingestion */
  FN_EMAIL_SEND,
  FN_EMAIL_PARSE_INCOMING,
  FN_EMAIL_VALIDATE_PAYLOAD,
  FN_EMAIL_POLL_MAILBOX,
  FN_EMAIL_ROUTE_TO_WORKFLOW,
  FN_SIGNAL_INGEST,
  FN_EMAIL_IMPORT_ARCHIVE,
  FN_SYNC_OFFLINE_NODE,
  FN_SYNC_OFFLINE_TASKS,

  /* Core: Cases, Tasks, Workflow, Labels */
  FN_CASE_CREATE_FROM_SIGNAL,
  FN_CASE_CREATE,
  FN_CASE_GET_WITH_TASKS,
  FN_CASE_RUN_CYCLIC_REVIEW,
  FN_TASK_CREATE,
  FN_TASK_UPDATE_STATUS,
  FN_TASK_ESCALATE,
  FN_TASK_ASSIGN,
  FN_TASK_ADD_COMMENT,
  FN_TASK_GET_BY_ID,
  FN_WORKFLOW_EXECUTE,
  FN_WORKFLOW_VALIDATE_RULES,
  FN_WORKFLOW_SIMULATE,
  FN_ESCALATION_EVALUATE,
  FN_LABEL_RESOLVE,
  FN_ROUTING_APPLY_RULES,
  FN_LABEL_CREATE_DEFINITION,
  FN_LABEL_APPLY_TO_ENTITY,

  /* Config, profiles & feature flags */
  FN_PROFILE_LOAD,
  FN_PROFILE_APPLY_DEFAULTS,
  FN_PROFILE_PREVIEW_DIFF,
  FN_CONFIG_GET_GLOBAL,
  FN_CONFIG_UPDATE_SERVICE_CONFIG,
  FN_CONFIG_IMPORT_BUNDLE,
  FN_FEATURE_FLAG_SET,
  FN_FEATURE_FLAG_EVALUATE,

  /* Interfaces */
  FN_API_LIST_TASKS,
  FN_API_GET_TASK,
  FN_API_CREATE_TASK,
  FN_API_UPDATE_TASK_STATUS,
  FN_API_LIST_CASES,
  FN_API_GET_CASE,
  FN_API_EXECUTE_WORKFLOW,
  FN_UI_ADMIN_TASK_OVERVIEW,
  FN_UI_ADMIN_CASE_OVERVIEW,
  FN_UI_ORG_PROFILE_SETTINGS,
  FN_NOTIFICATION_SEND_IN_APP,
  FN_NOTIFICATION_SEND_EMAIL,
  FN_GATEWAY_TASK_EVENTS_STREAM,

  /* Domain modules */
  FN_DOMAIN_MAINTENANCE_REGISTER_INCIDENT,
  FN_DOMAIN_MAINTENANCE_LIST_INCIDENTS,
  FN_DOMAIN_HR_REGISTER_REPORT,
  FN_DOMAIN_HR_LIST_CASES,
  FN_DOMAIN_EDUCATION_REGISTER_STUDENT_INCIDENT,
  FN_DOMAIN_EDUCATION_LIST_INCIDENTS,
  FN_DOMAIN_TASK_FACTORY_CREATE,
  FN_DOMAIN_WORKFLOW_APPLY_OVERRIDES,

  /* Insights & analytics */
  FN_REPORTS_GET_TASK_VOLUME,
  FN_REPORTS_GET_SLA_BREACHES,
  FN_REPORTS_GET_PROFILE_SCORE,
  FN_ANALYTICS_EXPORT_FACTS,
  FN_ANALYTICS_REFRESH_MATERIALIZED_VIEWS,
  FN_INSIGHTS_RUN_WEEKLY_PATTERNS,
  FN_INSIGHTS_RUN_MONTHLY_TRENDS,
  FN_INSIGHTS_RUN_YEARLY_SYSTEMIC_REVIEW,
  FN_INSIGHTS_CACHE_WARM_DASHBOARDS,
  FN_INSIGHTS_EXPORT_ANALYTICS,

  /* Infra, health, metrics, alerts */
  FN_HEALTH_GET,
  FN_WORKER_HEARTBEAT,
  FN_METRICS_RECORD_WORKFLOW_LATENCY,
  FN_METRICS_RECORD_QUEUE_DEPTH,
  FN_ALERT_ESCALATION_DELAY,
  FN_ALERT_ERROR_RATE,

  /* Security, privacy, compliance, logging */
  FN_AUTH_VALIDATE_ACCESS_TOKEN,
  FN_RBAC_CHECK_PERMISSION,
  FN_PRIVACY_ANONYMIZE_PAYLOAD,
  FN_AUDIT_RECORD_EVENT,
  FN_COMPLIANCE_EXPORT_AUDIT_LOG,
  FN_LOG_SYSTEM_EVENT,
  FN_LOG_SECURITY_EVENT,
  FN_LOG_ROTATE_LOGS,
  FN_LOG_QUERY_ENTITY_ACTIVITY,
  FN_CONFIG_VALIDATE_BUNDLE,
  FN_VALIDATE_API_PAYLOAD,
  FN_METADATA_NORMALIZE,
] as const;

/**
 * Union type of all known functional IDs.
 */
export type FunctionalId = (typeof ALL_FUNCTIONAL_IDS)[number];

/**
 * Type guard to validate whether a string is a known FunctionalId.
 */
export function isFunctionalId(value: string): value is FunctionalId {
  return (ALL_FUNCTIONAL_IDS as readonly string[]).includes(value);
}

===== END apps/api/src/orgo/core/functional-ids.ts =====


===== BEGIN apps/api/src/orgo/core/health/health.controller.ts =====
import { Controller, Get } from '@nestjs/common';
import { HealthService } from './health.service';

type HealthComponentState = 'up' | 'down' | 'degraded';
type HealthOverallStatus = 'ok' | 'degraded' | 'error';

export interface HealthComponentSnapshot {
  state: HealthComponentState;
  latencyMs?: number;
  error?: string;
  details?: Record<string, unknown>;
}

export interface HealthSnapshot {
  /**
   * Overall status of the Orgo backend.
   * - "ok"       → all core components are healthy
   * - "degraded" → at least one component is degraded but core is still functioning
   * - "error"    → at least one critical component is down
   */
  status: HealthOverallStatus;

  /**
   * Environment identifier ("dev" | "staging" | "prod" | "offline").
   */
  environment: string;

  /**
   * Optional version string for the running API (e.g. "3.0.1").
   */
  version?: string;

  /**
   * ISO 8601 timestamp (UTC) for when this snapshot was generated.
   */
  timestamp: string;

  /**
   * Component-level snapshots for the main dependencies.
   * Keys are stable identifiers that ops / monitoring can rely on.
   */
  components: {
    /**
     * Primary database / persistence layer.
     */
    database: HealthComponentSnapshot;

    /**
     * Task / background queues and workers.
     */
    queues: HealthComponentSnapshot;

    /**
     * Config loader and config validation status.
     */
    configLoader: HealthComponentSnapshot;

    /**
     * Domain modules discovery and basic self-checks.
     */
    domainModules: HealthComponentSnapshot;

    /**
     * Insights / analytics slice (warehouse + ETL).
     */
    insights: HealthComponentSnapshot;

    /**
     * Optional additional components (caches, external APIs, etc.).
     */
    [key: string]: HealthComponentSnapshot;
  };
}

export interface HealthError {
  code: string;
  message: string;
  details?: Record<string, unknown>;
}

/**
 * Standard result shape for API responses that can fail synchronously.
 */
export interface StandardResult<T> {
  ok: boolean;
  data: T | null;
  error: HealthError | null;
}

@Controller('health')
export class HealthController {
  constructor(private readonly healthService: HealthService) {}

  /**
   * GET /api/v3/health
   *
   * Returns an aggregated health snapshot for core Orgo dependencies:
   * - database
   * - queues
   * - config loader
   * - domain modules
   * - insights / analytics slice
   *
   * The HTTP status code is always 200; callers should inspect the payload:
   * - result.ok          → whether the health check itself ran successfully
   * - result.data.status → "ok" | "degraded" | "error" (overall system health)
   */
  @Get()
  async getHealth(): Promise<StandardResult<HealthSnapshot>> {
    try {
      const snapshot = await this.healthService.checkHealth();

      return {
        ok: true,
        data: snapshot,
        error: null,
      };
    } catch (err: unknown) {
      const error: HealthError =
        err instanceof Error
          ? {
              code: 'HEALTH_CHECK_FAILED',
              message: err.message,
              details: {
                name: err.name,
              },
            }
          : {
              code: 'HEALTH_CHECK_FAILED',
              message: 'Unknown error during health check',
              details: {
                error: String(err),
              },
            };

      return {
        ok: false,
        data: null,
        error,
      };
    }
  }
}

===== END apps/api/src/orgo/core/health/health.controller.ts =====


===== BEGIN apps/api/src/orgo/core/health/worker-health.service.ts =====
import { Injectable } from '@nestjs/common';
import { LogService } from '../logging/log.service';
import { FN_LOG_SYSTEM_EVENT } from '../functional-ids';

export type WorkerHealthStatus = 'healthy' | 'degraded' | 'unhealthy';

export interface WorkerQueueHeartbeat {
  name: string;
  activeJobs?: number;
  waitingJobs?: number;
  delayedJobs?: number;
  failedJobs?: number;
  /**
   * Queue lag in seconds (e.g. oldest waiting job age or schedule delay).
   */
  lagSeconds?: number | null;
  lastJobStartedAt?: string | Date | null;
  lastJobCompletedAt?: string | Date | null;
}

export interface WorkerHeartbeatPayload {
  /**
   * Stable worker identifier (pod name, instance id, etc.).
   */
  workerId: string;

  /**
   * Logical service / component id (`task_handler`, `email_gateway`, `insights_etl_worker`, etc.).
   * Should align with service identifiers from core services (`task_handler`, `email_gateway`, ...).
   */
  serviceId: string;

  /**
   * Environment, expected to match ENVIRONMENT enum (`dev` | `staging` | `prod` | `offline`).
   * If omitted, defaults from ORGO_ENVIRONMENT or `dev`.
   */
  environment?: string;

  /**
   * Hostname or node identifier.
   */
  hostname?: string;

  /**
   * OS process id, if applicable.
   */
  pid?: number;

  /**
   * When this worker instance started.
   */
  startedAt?: string | Date;

  /**
   * When this heartbeat was emitted. If omitted, "now" is assumed.
   */
  timestamp?: string | Date;

  /**
   * Per-queue metrics (email, workflow, task, etc.).
   */
  queues?: WorkerQueueHeartbeat[];

  /**
   * Optional numeric metrics for dashboards (CPU %, memory MB, etc.).
   */
  metrics?: Record<string, number>;

  /**
   * Free-form metadata for ops dashboards (labels, node role, region, etc.).
   */
  metadata?: Record<string, unknown>;
}

export interface WorkerHeartbeatAnomaly {
  type: 'HIGH_QUEUE_LAG' | 'HIGH_FAILED_JOBS';
  queueName?: string;
  severity: 'warning' | 'critical';
  message: string;
  details?: Record<string, unknown>;
}

export interface WorkerHeartbeatResult {
  workerId: string;
  serviceId: string;
  environment: string;
  status: WorkerHealthStatus;
  timestamp: string;
  anomalies: WorkerHeartbeatAnomaly[];
}

export interface StandardResult<T> {
  ok: boolean;
  data: T | null;
  error: { code: string; message: string; details?: Record<string, unknown> } | null;
}

@Injectable()
export class WorkerHealthService {
  private readonly maxLagSeconds: number;
  private readonly maxFailedJobs: number;

  constructor(private readonly logService: LogService) {
    // Basic, environment-driven thresholds for anomaly detection.
    this.maxLagSeconds = this.parsePositiveInt(
      process.env.ORGO_WORKER_MAX_LAG_SECONDS,
      300, // 5 minutes
    );
    this.maxFailedJobs = this.parsePositiveInt(
      process.env.ORGO_WORKER_MAX_FAILED_JOBS,
      10,
    );
  }

  /**
   * Core entry point for the `orgo.worker.heartbeat` job.
   *
   * Records a heartbeat for a worker instance, performs simple anomaly
   * detection on queue metrics, and logs the result as a SYSTEM-level event
   * for ops dashboards and observability pipelines.
   */
  async heartbeat(
    payload: WorkerHeartbeatPayload,
  ): Promise<StandardResult<WorkerHeartbeatResult>> {
    if (!payload || !payload.workerId || !payload.serviceId) {
      return {
        ok: false,
        data: null,
        error: {
          code: 'WORKER_HEARTBEAT_INVALID_PAYLOAD',
          message: 'workerId and serviceId are required for worker heartbeat.',
          details: { payload },
        },
      };
    }

    const environment =
      payload.environment ||
      process.env.ORGO_ENVIRONMENT ||
      process.env.NODE_ENV ||
      'dev';

    const now = this.normaliseDate(payload.timestamp) ?? new Date();

    const anomalies = this.detectAnomalies(payload);
    const status = this.deriveStatus(anomalies);

    const result: WorkerHeartbeatResult = {
      workerId: payload.workerId,
      serviceId: payload.serviceId,
      environment,
      status,
      timestamp: now.toISOString(),
      anomalies,
    };

    const logLevel = this.chooseLogLevel(anomalies);

    try {
      await this.logService.logEvent({
        category: 'SYSTEM',
        logLevel,
        message: `Worker heartbeat (${payload.serviceId}/${payload.workerId}) – ${status.toUpperCase()}`,
        identifier: `worker:${payload.serviceId}/${payload.workerId}`,
        metadata: {
          functionId: FN_LOG_SYSTEM_EVENT,
          job: 'orgo.worker.heartbeat',
          status,
          environment,
          heartbeat: {
            ...payload,
            timestamp: result.timestamp,
          },
          anomalies,
          thresholds: {
            maxLagSeconds: this.maxLagSeconds,
            maxFailedJobs: this.maxFailedJobs,
          },
        },
      });

      return {
        ok: true,
        data: result,
        error: null,
      };
    } catch (err: any) {
      return {
        ok: false,
        data: null,
        error: {
          code: 'WORKER_HEARTBEAT_LOG_FAILED',
          message: 'Failed to record worker heartbeat log event.',
          details: {
            error: err?.message ?? String(err),
            workerId: payload.workerId,
            serviceId: payload.serviceId,
          },
        },
      };
    }
  }

  /**
   * Inspects queue metrics to detect simple anomalies suitable for ops dashboards.
   */
  private detectAnomalies(payload: WorkerHeartbeatPayload): WorkerHeartbeatAnomaly[] {
    const anomalies: WorkerHeartbeatAnomaly[] = [];

    if (!payload.queues || payload.queues.length === 0) {
      return anomalies;
    }

    for (const queue of payload.queues) {
      const queueName = queue.name;

      if (queue.lagSeconds != null && queue.lagSeconds > this.maxLagSeconds) {
        const severity: 'warning' | 'critical' =
          queue.lagSeconds > this.maxLagSeconds * 2 ? 'critical' : 'warning';

        anomalies.push({
          type: 'HIGH_QUEUE_LAG',
          queueName,
          severity,
          message: `Queue "${queueName}" lag (${queue.lagSeconds}s) exceeds threshold (${this.maxLagSeconds}s).`,
          details: {
            lagSeconds: queue.lagSeconds,
            thresholdSeconds: this.maxLagSeconds,
            activeJobs: queue.activeJobs,
            waitingJobs: queue.waitingJobs,
            delayedJobs: queue.delayedJobs,
          },
        });
      }

      if (typeof queue.failedJobs === 'number' && queue.failedJobs > this.maxFailedJobs) {
        const severity: 'warning' | 'critical' =
          queue.failedJobs > this.maxFailedJobs * 2 ? 'critical' : 'warning';

        anomalies.push({
          type: 'HIGH_FAILED_JOBS',
          queueName,
          severity,
          message: `Queue "${queueName}" failed jobs (${queue.failedJobs}) exceeds threshold (${this.maxFailedJobs}).`,
          details: {
            failedJobs: queue.failedJobs,
            thresholdFailedJobs: this.maxFailedJobs,
            activeJobs: queue.activeJobs,
            waitingJobs: queue.waitingJobs,
          },
        });
      }
    }

    return anomalies;
  }

  private deriveStatus(anomalies: WorkerHeartbeatAnomaly[]): WorkerHealthStatus {
    if (anomalies.length === 0) {
      return 'healthy';
    }

    const hasCritical = anomalies.some((a) => a.severity === 'critical');
    if (hasCritical) {
      return 'unhealthy';
    }

    return 'degraded';
  }

  private chooseLogLevel(anomalies: WorkerHeartbeatAnomaly[]): 'DEBUG' | 'INFO' | 'WARNING' | 'ERROR' | 'CRITICAL' {
    if (anomalies.length === 0) {
      return 'INFO';
    }

    const hasCritical = anomalies.some((a) => a.severity === 'critical');
    return hasCritical ? 'ERROR' : 'WARNING';
  }

  private normaliseDate(value?: string | Date): Date | null {
    if (!value) {
      return null;
    }

    if (value instanceof Date) {
      return value;
    }

    const parsed = new Date(value);
    return Number.isNaN(parsed.getTime()) ? null : parsed;
  }

  private parsePositiveInt(raw: string | undefined, fallback: number): number {
    if (!raw) {
      return fallback;
    }

    const parsed = Number.parseInt(raw, 10);
    if (!Number.isFinite(parsed) || parsed <= 0) {
      return fallback;
    }

    return parsed;
  }
}

===== END apps/api/src/orgo/core/health/worker-health.service.ts =====


===== BEGIN apps/api/src/orgo/core/labels/label-routing.service.ts =====
import { Injectable } from '@nestjs/common';

/**
 * Domain-level representation of a canonical Orgo label:
 *   <BASE>.<CATEGORY><SUBCATEGORY>.<HORIZONTAL_ROLE?>
 */
export interface LabelParts {
  /** Vertical base (hierarchy level), e.g. 1, 11, 101, 1001. */
  base: number;
  /** Information category digit (1–9). */
  categoryDigit: number;
  /** Intent / subcategory digit (1–5). */
  subcategoryDigit: number;
  /** Optional horizontal role, e.g. "Ops.Maintenance". */
  horizontalRole?: string | null;
}

/**
 * Global Task.category values (Doc 3 / Doc 8).
 */
export type TaskCategory =
  | 'request'
  | 'incident'
  | 'update'
  | 'report'
  | 'distribution';

/**
 * Task severity enum (Doc 2).
 */
export type TaskSeverity = 'MINOR' | 'MODERATE' | 'MAJOR' | 'CRITICAL';

export interface ResolveLabelOptions {
  /**
   * Explicit label string to validate and normalize. When present, this
   * takes precedence over all other hint fields.
   */
  label?: string;

  /**
   * Optional organization identifier for future org‑specific routing.
   * Not used directly yet, but included so the contract remains stable
   * when org‑specific rules are introduced.
   */
  organizationId?: string;

  /**
   * When no explicit label is provided, these fields are used (together
   * with task hints) to construct a canonical label.
   */
  verticalBase?: number;
  infoCategoryDigit?: number;
  infoSubcategoryDigit?: number;
  horizontalRole?: string;

  /**
   * Task‑level hints used when deriving label parts.
   */
  taskType?: string;
  taskCategory?: TaskCategory;
  severity?: TaskSeverity;
}

export interface ResolvedLabelRouting {
  /**
   * Canonical label in the "<BASE>.<CATEGORY><SUBCATEGORY>[.<ROLE>]" form.
   */
  label: string;

  /**
   * Parsed structure of the canonical label.
   */
  parts: LabelParts;

  /**
   * Denormalised role label that can be written to `tasks.assignee_role`.
   * By default this is the horizontalRole part of the label, if present.
   */
  assigneeRole: string | null;

  /**
   * True when the base is one of the reserved broadcast bases (10, 100, 1000).
   */
  isBroadcast: boolean;
}

/**
 * Thrown when a label is syntactically invalid or violates the canonical
 * constraints (digit ranges).
 */
export class InvalidLabelException extends Error {
  constructor(message: string) {
    super(message);
    this.name = 'InvalidLabelException';
  }
}

@Injectable()
export class LabelRoutingService {
  /**
   * Matches labels of the form:
   *   "<BASE>.<CATEGORY><SUBCATEGORY>[.<HORIZONTAL_ROLE>]"
   *
   * Examples:
   *   "100.94.Operations.Safety"
   *   "11.11"
   */
  private readonly labelRegex = /^(\d+)\.(\d)(\d)(?:\.(.+))?$/;

  /**
   * Parse a canonical label string into its parts.
   *
   * Throws InvalidLabelException when the label does not conform to the
   * expected shape or digit ranges.
   */
  parseLabel(label: string): LabelParts {
    if (!label || !label.trim()) {
      throw new InvalidLabelException('Label must be a non-empty string');
    }

    const trimmed = label.trim();
    const match = this.labelRegex.exec(trimmed);

    if (!match) {
      throw new InvalidLabelException(
        `Label "${label}" is not in the canonical "<BASE>.<CATEGORY><SUBCATEGORY>[.<ROLE>]" format`,
      );
    }

    const base = Number(match[1]);
    const categoryDigit = Number(match[2]);
    const subcategoryDigit = Number(match[3]);
    const horizontalRole = match[4]?.trim() || null;

    this.assertBase(base);
    this.assertCategoryDigit(categoryDigit);
    this.assertSubcategoryDigit(subcategoryDigit);

    return {
      base,
      categoryDigit,
      subcategoryDigit,
      horizontalRole,
    };
  }

  /**
   * Format label parts into a canonical label string.
   *
   * Validation is applied to ensure base/category/subcategory are within
   * the allowed ranges. Horizontal role is optional.
   */
  formatLabel(parts: LabelParts): string {
    const { base, categoryDigit, subcategoryDigit } = parts;

    this.assertBase(base);
    this.assertCategoryDigit(categoryDigit);
    this.assertSubcategoryDigit(subcategoryDigit);

    const role = parts.horizontalRole?.trim();
    let label = `${base}.${categoryDigit}${subcategoryDigit}`;

    if (role) {
      label += `.${role}`;
    }

    return label;
  }

  /**
   * Resolve a canonical label and basic routing hints for a task or case.
   *
   * If `options.label` is provided, it is validated and normalized and all
   * other hints are ignored. Otherwise, the label is constructed from the
   * provided hints and reasonable defaults.
   */
  resolveLabel(options: ResolveLabelOptions): ResolvedLabelRouting {
    if (options.label) {
      const parts = this.parseLabel(options.label);
      const normalized = this.formatLabel(parts);

      return {
        label: normalized,
        parts,
        assigneeRole: parts.horizontalRole ?? null,
        isBroadcast: this.isBroadcastBase(parts.base),
      };
    }

    const severity: TaskSeverity = options.severity ?? 'MODERATE';
    const taskCategory: TaskCategory | undefined = options.taskCategory;

    const base =
      options.verticalBase ?? this.deriveBaseFromSeverity(severity);
    const categoryDigit =
      options.infoCategoryDigit ??
      this.deriveCategoryDigitFromTaskCategory(taskCategory);
    const subcategoryDigit =
      options.infoSubcategoryDigit ??
      this.deriveSubcategoryDigitFromTaskCategory(taskCategory);
    const horizontalRole =
      options.horizontalRole ?? this.deriveHorizontalRole(options.taskType);

    const parts: LabelParts = {
      base,
      categoryDigit,
      subcategoryDigit,
      horizontalRole,
    };

    const label = this.formatLabel(parts);

    return {
      label,
      parts,
      assigneeRole: horizontalRole ?? null,
      isBroadcast: this.isBroadcastBase(base),
    };
  }

  /**
   * Convenience helper that returns true when a label uses one of the
   * reserved broadcast bases (10, 100, 1000).
   */
  isBroadcastLabel(label: string): boolean {
    const parts = this.parseLabel(label);
    return this.isBroadcastBase(parts.base);
  }

  /**
   * Reserved broadcast bases are informational by default and must be
   * handled specially by higher‑level workflow/routing logic.
   */
  isBroadcastBase(base: number): boolean {
    return base === 10 || base === 100 || base === 1000;
  }

  /**
   * Derive a vertical base from severity, based on the examples in the spec:
   *
   *   1    – CEO level
   *   2    – C‑level
   *   11   – department head
   *   101  – team lead
   *   1001 – individual staff member
   *
   * Broadcast bases (10 / 100 / 1000) are intentionally not used here;
   * those must be assigned explicitly when the intent is to broadcast.
   */
  private deriveBaseFromSeverity(severity: TaskSeverity): number {
    switch (severity) {
      case 'CRITICAL':
        return 1;
      case 'MAJOR':
        return 11;
      case 'MODERATE':
        return 101;
      case 'MINOR':
      default:
        return 1001;
    }
  }

  /**
   * Map a Task.category to the information category digit (1–9).
   *
   * See Doc 8 §8.3.3 for semantics:
   *   1 – Operational information
   *   3 – Compliance & reporting
   *   6 – Communication & coordination
   *   9 – Crisis & emergency information
   */
  private deriveCategoryDigitFromTaskCategory(
    category?: TaskCategory,
  ): number {
    switch (category) {
      case 'incident':
        // Incidents are usually crisis / emergency.
        return 9;
      case 'update':
      case 'distribution':
        // Communication / coordination.
        return 6;
      case 'report':
        // Structured reports / compliance.
        return 3;
      case 'request':
      default:
        // Default: operational information.
        return 1;
    }
  }

  /**
   * Map a Task.category to the intent/subcategory digit (1–5) as in Doc 8 §8.3.4:
   *
   *   1 – Requests
   *   2 – Updates
   *   3 – Decisions
   *   4 – Reports
   *   5 – Distribution
   */
  private deriveSubcategoryDigitFromTaskCategory(
    category?: TaskCategory,
  ): number {
    switch (category) {
      case 'request':
        return 1;
      case 'update':
        return 2;
      case 'distribution':
        return 5;
      case 'incident':
      case 'report':
        // Incident flows usually surface as reports.
        return 4;
      default:
        return 1;
    }
  }

  /**
   * Derive a horizontal role string (functional axis) from a Task.type /
   * domain identifier.
   *
   * Domain modules can still supply a more specific horizontalRole via
   * ResolveLabelOptions when needed.
   */
  private deriveHorizontalRole(taskType?: string): string | undefined {
    switch (taskType) {
      case 'maintenance':
        return 'Ops.Maintenance';
      case 'hr_case':
      case 'hr':
        return 'HR.CaseManagement';
      case 'education_support':
      case 'education':
        return 'Education.Support';
      case 'it_support':
      case 'it':
        return 'IT.Support';
      case 'operations':
        return 'Ops.General';
      case 'generic':
        return 'Operations.General';
      default:
        return undefined;
    }
  }

  private assertBase(base: number): void {
    if (!Number.isInteger(base) || base <= 0) {
      throw new InvalidLabelException(
        `Label base must be a positive integer, got "${base}"`,
      );
    }
  }

  private assertCategoryDigit(categoryDigit: number): void {
    if (
      !Number.isInteger(categoryDigit) ||
      categoryDigit < 1 ||
      categoryDigit > 9
    ) {
      throw new InvalidLabelException(
        `Label category digit must be between 1 and 9, got "${categoryDigit}"`,
      );
    }
  }

  private assertSubcategoryDigit(subcategoryDigit: number): void {
    if (
      !Number.isInteger(subcategoryDigit) ||
      subcategoryDigit < 1 ||
      subcategoryDigit > 5
    ) {
      throw new InvalidLabelException(
        `Label subcategory digit must be between 1 and 5, got "${subcategoryDigit}"`,
      );
    }
  }
}

===== END apps/api/src/orgo/core/labels/label-routing.service.ts =====


===== BEGIN apps/api/src/orgo/core/labels/label.service.ts =====
import {
  BadRequestException,
  ConflictException,
  Injectable,
  NotFoundException,
} from '@nestjs/common';
import { Prisma, PrismaClient, LabelDefinition, EntityLabel } from '@prisma/client';
import { PrismaService } from '../../../persistence/prisma/prisma.service';

export interface CreateLabelDefinitionInput {
  /**
   * Owning organization. Omit or set to null for a global label.
   */
  organizationId?: string | null;
  /**
   * Stable machine-readable code, unique per org/global.
   * Examples: "self_harm_risk", "equipment_failure".
   */
  code: string;
  /**
   * Human-friendly name for the label.
   */
  displayName: string;
  /**
   * Description for admins / reviewers.
   */
  description: string;
  /**
   * High-level classification bucket.
   * Examples: "risk", "topic", "visibility".
   */
  category: string;
  /**
   * Optional color hint for UI (hex or named color).
   */
  colorHint?: string | null;
}

export interface UpdateLabelDefinitionInput {
  displayName?: string;
  description?: string;
  category?: string;
  colorHint?: string | null;
}

export interface AssignLabelToEntityInput {
  /**
   * Organization that owns the entity (tenant).
   */
  organizationId: string;
  /**
   * Classification label code; resolved against org + global definitions.
   */
  labelCode: string;
  /**
   * Target entity type (e.g. "task", "person", "learning_group", "case").
   */
  entityType: string;
  /**
   * Target entity id (UUID from the corresponding table).
   */
  entityId: string;
  /**
   * Optional user who applied the label.
   */
  appliedByUserId?: string | null;
}

export interface RemoveLabelFromEntityInput {
  organizationId: string;
  labelCode: string;
  entityType: string;
  entityId: string;
}

export type EntityLabelWithDefinition = EntityLabel & {
  label: LabelDefinition;
};

/**
 * LabelService
 *
 * Manages classification label definitions (`label_definitions`) and their
 * attachments to entities (`entity_labels`), separate from the single canonical
 * information label stored on Tasks/Cases.
 */
@Injectable()
export class LabelService {
  private readonly prisma: PrismaClient;

  constructor(private readonly prismaService: PrismaService) {
    this.prisma = prismaService;
  }

  /**
   * Create a new LabelDefinition for an org or globally.
   * Enforces uniqueness of (organizationId, code).
   */
  async createLabelDefinition(
    input: CreateLabelDefinitionInput,
  ): Promise<LabelDefinition> {
    const organizationId = input.organizationId ?? null;

    if (!input.code?.trim()) {
      throw new BadRequestException('Label code must be a non-empty string.');
    }
    if (!input.displayName?.trim()) {
      throw new BadRequestException('Label displayName must be a non-empty string.');
    }
    if (!input.description?.trim()) {
      throw new BadRequestException('Label description must be a non-empty string.');
    }
    if (!input.category?.trim()) {
      throw new BadRequestException('Label category must be a non-empty string.');
    }

    const existing = await this.prisma.labelDefinition.findFirst({
      where: {
        code: input.code,
        organizationId,
      },
    });

    if (existing) {
      throw new ConflictException(
        `LabelDefinition with code "${input.code}" already exists for this scope.`,
      );
    }

    try {
      return await this.prisma.labelDefinition.create({
        data: {
          organizationId,
          code: input.code,
          displayName: input.displayName,
          description: input.description,
          category: input.category,
          colorHint: input.colorHint ?? null,
        },
      });
    } catch (error) {
      if (
        error instanceof Prisma.PrismaClientKnownRequestError &&
        error.code === 'P2002'
      ) {
        // Unique constraint violation (e.g. on organizationId + code)
        throw new ConflictException(
          `LabelDefinition with code "${input.code}" already exists.`,
        );
      }
      throw error;
    }
  }

  /**
   * Update an existing LabelDefinition by id, scoped to an org (or global).
   */
  async updateLabelDefinition(
    id: string,
    organizationId: string | null,
    updates: UpdateLabelDefinitionInput,
  ): Promise<LabelDefinition> {
    const normalizedOrgId = organizationId ?? null;

    const label = await this.prisma.labelDefinition.findFirst({
      where: { id, organizationId: normalizedOrgId },
    });

    if (!label) {
      throw new NotFoundException(
        `LabelDefinition "${id}" not found for the specified organization scope.`,
      );
    }

    if (
      updates.displayName !== undefined &&
      !updates.displayName.trim()
    ) {
      throw new BadRequestException('displayName, if provided, must be non-empty.');
    }
    if (
      updates.description !== undefined &&
      !updates.description.trim()
    ) {
      throw new BadRequestException('description, if provided, must be non-empty.');
    }
    if (
      updates.category !== undefined &&
      !updates.category.trim()
    ) {
      throw new BadRequestException('category, if provided, must be non-empty.');
    }

    return this.prisma.labelDefinition.update({
      where: { id: label.id },
      data: {
        displayName: updates.displayName ?? label.displayName,
        description: updates.description ?? label.description,
        category: updates.category ?? label.category,
        colorHint:
          updates.colorHint !== undefined ? updates.colorHint : label.colorHint,
      },
    });
  }

  /**
   * Delete a LabelDefinition by id, scoped to an org (or global).
   *
   * Note: DB-level foreign keys decide whether delete cascades or fails if
   * EntityLabels still reference this label.
   */
  async deleteLabelDefinition(
    id: string,
    organizationId: string | null,
  ): Promise<void> {
    const normalizedOrgId = organizationId ?? null;

    const label = await this.prisma.labelDefinition.findFirst({
      where: { id, organizationId: normalizedOrgId },
    });

    if (!label) {
      throw new NotFoundException(
        `LabelDefinition "${id}" not found for the specified organization scope.`,
      );
    }

    await this.prisma.labelDefinition.delete({
      where: { id: label.id },
    });
  }

  /**
   * Return LabelDefinitions visible to an org:
   *   - Global labels (organizationId = null)
   *   - Org-specific labels (organizationId = <org>)
   * If the same code exists in both scopes, the org-specific one wins.
   */
  async getLabelDefinitionsForOrg(
    organizationId: string,
  ): Promise<LabelDefinition[]> {
    const [globalLabels, orgLabels] = await Promise.all([
      this.prisma.labelDefinition.findMany({
        where: { organizationId: null },
      }),
      this.prisma.labelDefinition.findMany({
        where: { organizationId },
      }),
    ]);

    const byCode = new Map<string, LabelDefinition>();

    for (const label of globalLabels) {
      byCode.set(label.code, label);
    }
    for (const label of orgLabels) {
      // Org-specific overrides global
      byCode.set(label.code, label);
    }

    return Array.from(byCode.values()).sort((a, b) =>
      a.code.localeCompare(b.code),
    );
  }

  /**
   * Resolve a LabelDefinition by code for a given org, with fallback to global.
   * Org-specific definitions override global ones when codes clash.
   */
  async getLabelDefinitionByCode(
    organizationId: string,
    code: string,
  ): Promise<LabelDefinition> {
    if (!code?.trim()) {
      throw new BadRequestException('Label code must be a non-empty string.');
    }

    const [orgSpecific, global] = await Promise.all([
      this.prisma.labelDefinition.findFirst({
        where: {
          organizationId,
          code,
        },
      }),
      this.prisma.labelDefinition.findFirst({
        where: {
          organizationId: null,
          code,
        },
      }),
    ]);

    const label = orgSpecific ?? global;

    if (!label) {
      throw new NotFoundException(
        `LabelDefinition with code "${code}" not found for organization or global scope.`,
      );
    }

    return label;
  }

  /**
   * Attach a classification label (by code) to an entity.
   * Respects org + global label definitions.
   */
  async assignLabelToEntity(
    input: AssignLabelToEntityInput,
  ): Promise<EntityLabel> {
    if (!input.entityType?.trim()) {
      throw new BadRequestException('entityType must be a non-empty string.');
    }
    if (!input.entityId?.trim()) {
      throw new BadRequestException('entityId must be a non-empty string.');
    }

    const label = await this.getLabelDefinitionByCode(
      input.organizationId,
      input.labelCode,
    );

    // Avoid duplicate attachments for the same (org, entity, label)
    const existing = await this.prisma.entityLabel.findFirst({
      where: {
        organizationId: input.organizationId,
        entityType: input.entityType,
        entityId: input.entityId,
        labelId: label.id,
      },
    });

    if (existing) {
      return existing;
    }

    return this.prisma.entityLabel.create({
      data: {
        organizationId: input.organizationId,
        labelId: label.id,
        entityType: input.entityType,
        entityId: input.entityId,
        appliedByUserId: input.appliedByUserId ?? null,
      },
    });
  }

  /**
   * Remove a classification label (by code) from an entity.
   * Returns the number of removed rows.
   */
  async removeLabelFromEntity(
    input: RemoveLabelFromEntityInput,
  ): Promise<number> {
    const label = await this.getLabelDefinitionByCode(
      input.organizationId,
      input.labelCode,
    );

    const result = await this.prisma.entityLabel.deleteMany({
      where: {
        organizationId: input.organizationId,
        entityType: input.entityType,
        entityId: input.entityId,
        labelId: label.id,
      },
    });

    if (result.count === 0) {
      throw new NotFoundException(
        `EntityLabel not found for entity "${input.entityType}:${input.entityId}" and label code "${input.labelCode}".`,
      );
    }

    return result.count;
  }

  /**
   * List all EntityLabels (with resolved LabelDefinition) for a given entity.
   */
  async getLabelsForEntity(
    organizationId: string,
    entityType: string,
    entityId: string,
  ): Promise<EntityLabelWithDefinition[]> {
    if (!entityType?.trim()) {
      throw new BadRequestException('entityType must be a non-empty string.');
    }
    if (!entityId?.trim()) {
      throw new BadRequestException('entityId must be a non-empty string.');
    }

    return this.prisma.entityLabel.findMany({
      where: {
        organizationId,
        entityType,
        entityId,
      },
      include: {
        label: true,
      },
    }) as Promise<EntityLabelWithDefinition[]>;
  }
}

===== END apps/api/src/orgo/core/labels/label.service.ts =====


===== BEGIN apps/api/src/orgo/core/labels/labels.module.ts =====
import { Module } from '@nestjs/common';
import { PersistenceModule } from '../../../persistence/persistence.module';
import { LabelService } from './label.service';
import { LabelRoutingService } from './label-routing.service';
import { RoutingRuleService } from './routing-rule.service';

@Module({
  imports: [PersistenceModule],
  providers: [LabelService, LabelRoutingService, RoutingRuleService],
  exports: [LabelService, LabelRoutingService, RoutingRuleService],
})
export class LabelsModule {}

===== END apps/api/src/orgo/core/labels/labels.module.ts =====


===== BEGIN apps/api/src/orgo/core/labels/routing-rule.service.ts =====
import { Injectable } from '@nestjs/common';
import { PrismaService } from '../../../persistence/prisma/prisma.service';
import { LogService } from '../logging/log.service';

export type TaskCategory =
  | 'request'
  | 'incident'
  | 'update'
  | 'report'
  | 'distribution';

export type TaskPriority = 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';

const PRIORITY_ORDER: TaskPriority[] = ['LOW', 'MEDIUM', 'HIGH', 'CRITICAL'];

export interface OrgoError {
  code: string;
  message: string;
  details?: Record<string, unknown>;
}

export interface StandardResult<T> {
  ok: boolean;
  data: T | null;
  error: OrgoError | null;
}

export interface ApplyRoutingRulesInput {
  /**
   * Tenant / organization that owns the task or signal.
   */
  organizationId: string;

  /**
   * Domain-level task type (maintenance, hr_case, it_support, etc.).
   */
  taskType?: string | null;

  /**
   * Canonical task category (“request” | “incident” | “update” | “report” | “distribution”).
   */
  taskCategory?: string | null;

  /**
   * Task priority. May be canonical enum casing or lower-case JSON form.
   */
  priority?: string | null;

  /**
   * Classification label codes attached to the task/signal
   * (e.g. ["anonymous", "equipment_failure"]).
   */
  labelCodes?: string[];

  /**
   * Optional task identifier (for logging correlation).
   */
  taskId?: string;
}

export interface RoutingDecision {
  /**
   * Organization that owns the chosen rule (may be null for global rules).
   */
  organizationId: string | null;

  /**
   * Target role that should initially own the task, if defined by the rule.
   */
  targetRoleId: string | null;

  /**
   * Target user that should initially own the task, if defined by the rule.
   * Used sparingly; routing should primarily be role-based.
   */
  targetUserId: string | null;

  /**
   * Identifier and name of the applied rule for auditability.
   */
  ruleId: string | null;
  ruleName: string | null;

  /**
   * Whether the selected rule is marked as a fallback.
   */
  isFallback: boolean;
}

/**
 * Internal normalized view of the routing context.
 */
interface NormalizedRoutingContext {
  organizationId: string;
  taskType?: string;
  taskCategory?: TaskCategory;
  priority?: TaskPriority;
  labelCodes: string[];
  taskId?: string;
}

/**
 * Internal normalized view of a routing rule record.
 * The physical table is `routing_rules` (Doc 1).
 */
interface NormalizedRoutingRule {
  id: string;
  organizationId: string | null;
  name: string;
  taskType?: string;
  taskCategory?: TaskCategory;
  labelCodes: string[];
  priorityMin?: TaskPriority;
  targetRoleId?: string | null;
  targetUserId?: string | null;
  isFallback: boolean;
  weight: number;
}

@Injectable()
export class RoutingRuleService {
  constructor(
    private readonly prisma: PrismaService,
    private readonly logService: LogService,
  ) {}

  /**
   * Applies routing_rules for the given context and returns the chosen
   * role/user assignment, following Core Services + Doc 1/2 semantics.
   *
   * Matching semantics:
   * - organization_id: prefer org-specific rules over global (NULL).
   * - task_type: must match if rule.task_type is not NULL (case-insensitive).
   * - task_category: must match if rule.task_category is not NULL (lower-case).
   * - label_codes: all rule.label_codes must be present in context.labelCodes.
   * - priority_min: context.priority must be >= rule.priority_min.
   *
   * Selection semantics:
   * - First prefer non-fallback rules; if none match, use fallback rules.
   * - Within that set, prefer org-specific rules.
   * - Within org/global scope, pick rule with highest weight.
   * - If still tied, pick rule with lexicographically smallest id
   *   to keep behaviour deterministic.
   */
  async applyRoutingRules(
    input: ApplyRoutingRulesInput,
  ): Promise<StandardResult<RoutingDecision>> {
    const context = this.normalizeContext(input);

    try {
      const rawRules = await this.prisma.routingRule.findMany({
        where: {
          OR: [
            { organizationId: context.organizationId },
            { organizationId: null },
          ],
        },
      });

      const normalizedRules = rawRules.map((rule) =>
        this.normalizeRule(rule as any),
      );
      const matchingRules = normalizedRules.filter((rule) =>
        this.matchesRule(rule, context),
      );

      const selectedRule = this.pickBestRule(
        matchingRules,
        context.organizationId,
      );

      if (!selectedRule) {
        this.logService.logEvent({
          category: 'WORKFLOW',
          logLevel: 'WARNING',
          message: 'No routing rule matched context',
          identifier: context.taskId
            ? `task_id:${context.taskId}`
            : undefined,
          metadata: {
            organizationId: context.organizationId,
            taskType: context.taskType,
            taskCategory: context.taskCategory,
            priority: context.priority,
            labelCodes: context.labelCodes,
          },
        });

        return {
          ok: false,
          data: null,
          error: {
            code: 'ROUTING_RULE_NOT_FOUND',
            message: 'No routing rule matched the provided context.',
            details: {
              organizationId: context.organizationId,
              taskType: context.taskType,
              taskCategory: context.taskCategory,
            },
          },
        };
      }

      const decision: RoutingDecision = {
        organizationId: selectedRule.organizationId,
        targetRoleId: selectedRule.targetRoleId ?? null,
        targetUserId: selectedRule.targetUserId ?? null,
        ruleId: selectedRule.id,
        ruleName: selectedRule.name,
        isFallback: selectedRule.isFallback,
      };

      this.logService.logEvent({
        category: 'WORKFLOW',
        logLevel: 'INFO',
        message: 'Routing rule applied',
        identifier: context.taskId ? `task_id:${context.taskId}` : undefined,
        metadata: {
          organizationId: context.organizationId,
          taskType: context.taskType,
          taskCategory: context.taskCategory,
          priority: context.priority,
          labelCodes: context.labelCodes,
          ruleId: decision.ruleId,
          ruleName: decision.ruleName,
          targetRoleId: decision.targetRoleId,
          targetUserId: decision.targetUserId,
          isFallback: decision.isFallback,
        },
      });

      return {
        ok: true,
        data: decision,
        error: null,
      };
    } catch (error) {
      this.logService.logEvent({
        category: 'SYSTEM',
        logLevel: 'ERROR',
        message: 'Failed to evaluate routing rules',
        identifier: input.taskId ? `task_id:${input.taskId}` : undefined,
        metadata: {
          error:
            error instanceof Error
              ? { name: error.name, message: error.message }
              : String(error),
        },
      });

      return {
        ok: false,
        data: null,
        error: {
          code: 'ROUTING_RULE_EVALUATION_ERROR',
          message: 'Failed to evaluate routing rules.',
          details: {},
        },
      };
    }
  }

  private normalizeContext(
    input: ApplyRoutingRulesInput,
  ): NormalizedRoutingContext {
    const labelCodes =
      input.labelCodes?.map((code) => code.trim().toLowerCase()).filter(Boolean) ??
      [];

    const taskType = input.taskType
      ? input.taskType.trim().toLowerCase()
      : undefined;

    const taskCategory = input.taskCategory
      ? (input.taskCategory.trim().toLowerCase() as TaskCategory)
      : undefined;

    const priority = this.normalizePriority(input.priority);

    return {
      organizationId: input.organizationId,
      taskType,
      taskCategory,
      priority: priority ?? undefined,
      labelCodes,
      taskId: input.taskId,
    };
  }

  private normalizeRule(rule: any): NormalizedRoutingRule {
    const labelCodes: string[] =
      (rule.labelCodes ?? rule.label_codes ?? []) as string[];

    const weightRaw: number | null | undefined =
      rule.weight !== undefined ? rule.weight : rule.weight ?? 0;

    return {
      id: String(rule.id),
      organizationId:
        (rule.organizationId ?? rule.organization_id) ?? null,
      name: rule.name,
      taskType: rule.taskType
        ? String(rule.taskType).trim().toLowerCase()
        : rule.task_type
        ? String(rule.task_type).trim().toLowerCase()
        : undefined,
      taskCategory: rule.taskCategory
        ? (String(rule.taskCategory).trim().toLowerCase() as TaskCategory)
        : rule.task_category
        ? (String(rule.task_category).trim().toLowerCase() as TaskCategory)
        : undefined,
      labelCodes: labelCodes.map((c) => c.trim().toLowerCase()).filter(Boolean),
      priorityMin: this.normalizePriority(
        rule.priorityMin ?? rule.priority_min ?? null,
      ) ?? undefined,
      targetRoleId:
        (rule.targetRoleId ?? rule.target_role_id) ?? null,
      targetUserId:
        (rule.targetUserId ?? rule.target_user_id) ?? null,
      isFallback: Boolean(rule.isFallback ?? rule.is_fallback),
      weight: typeof weightRaw === 'number' ? weightRaw : 0,
    };
  }

  private matchesRule(
    rule: NormalizedRoutingRule,
    ctx: NormalizedRoutingContext,
  ): boolean {
    if (rule.taskType && (!ctx.taskType || rule.taskType !== ctx.taskType)) {
      return false;
    }

    if (
      rule.taskCategory &&
      (!ctx.taskCategory || rule.taskCategory !== ctx.taskCategory)
    ) {
      return false;
    }

    if (rule.labelCodes.length > 0) {
      const ctxCodes = new Set(ctx.labelCodes);
      const hasAllLabels = rule.labelCodes.every((code) => ctxCodes.has(code));
      if (!hasAllLabels) {
        return false;
      }
    }

    if (rule.priorityMin) {
      if (!ctx.priority) {
        return false;
      }
      if (!this.hasRequiredPriority(ctx.priority, rule.priorityMin)) {
        return false;
      }
    }

    return true;
  }

  private pickBestRule(
    rules: NormalizedRoutingRule[],
    organizationId: string,
  ): NormalizedRoutingRule | null {
    if (rules.length === 0) {
      return null;
    }

    const nonFallback = rules.filter((r) => !r.isFallback);
    const pool = nonFallback.length > 0 ? nonFallback : rules.filter((r) => r.isFallback);

    if (pool.length === 0) {
      return null;
    }

    const orgSpecific = pool.filter((r) => r.organizationId === organizationId);
    const scopedPool = orgSpecific.length > 0 ? orgSpecific : pool;

    scopedPool.sort((a, b) => {
      if (b.weight !== a.weight) {
        return b.weight - a.weight;
      }
      return a.id.localeCompare(b.id);
    });

    return scopedPool[0] ?? null;
  }

  private normalizePriority(
    priority: string | null | undefined,
  ): TaskPriority | null {
    if (!priority) {
      return null;
    }

    const upper = priority.toString().trim().toUpperCase();

    switch (upper) {
      case 'LOW':
      case 'MEDIUM':
      case 'HIGH':
      case 'CRITICAL':
        return upper;
      default:
        return null;
    }
  }

  private hasRequiredPriority(
    contextPriority: TaskPriority,
    rulePriorityMin: TaskPriority,
  ): boolean {
    const contextIndex = PRIORITY_ORDER.indexOf(contextPriority);
    const ruleIndex = PRIORITY_ORDER.indexOf(rulePriorityMin);

    if (contextIndex === -1 || ruleIndex === -1) {
      return false;
    }

    return contextIndex >= ruleIndex;
  }
}

===== END apps/api/src/orgo/core/labels/routing-rule.service.ts =====


===== BEGIN apps/api/src/orgo/core/logging/log.service.ts =====
import {
  Injectable,
  Logger as NestLogger,
  OnModuleInit,
} from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { promises as fsp } from 'fs';
import * as path from 'path';

/**
 * Canonical log categories (must align with Orgo LOG_CATEGORY enum).
 */
export enum LogCategory {
  WORKFLOW = 'WORKFLOW',
  TASK = 'TASK',
  SYSTEM = 'SYSTEM',
  SECURITY = 'SECURITY',
  EMAIL = 'EMAIL',
}

/**
 * Canonical log levels (must align with Orgo LOG_LEVEL enum).
 */
export enum LogLevel {
  DEBUG = 'DEBUG',
  INFO = 'INFO',
  WARNING = 'WARNING',
  ERROR = 'ERROR',
  CRITICAL = 'CRITICAL',
}

export type LogFormat = 'json' | 'text';

export interface LoggingCategoryConfig {
  /**
   * File name for this category, relative to the configured logDir.
   * Example: "workflow_activity.log"
   */
  file: string;

  /**
   * How long to keep rotated files (in days) before deleting.
   */
  retentionDays: number;

  /**
   * Rotation strategy:
   * - "daily" / "weekly": intended for scheduled rotateLogs() calls.
   * - "size": rotate when file exceeds maxFileSizeMb.
   */
  rotation: 'daily' | 'weekly' | 'size';

  /**
   * Max file size in megabytes before size-based rotation.
   */
  maxFileSizeMb: number;
}

export interface LoggingConfig {
  /**
   * Minimum level to actually emit logs (DEBUG < INFO < WARNING < ERROR < CRITICAL).
   */
  level: LogLevel;

  /**
   * Output format for log lines.
   */
  format: LogFormat;

  /**
   * Root directory where category log files are written.
   */
  logDir: string;

  /**
   * Per-category file/retention/rotation configuration.
   */
  categories: Record<LogCategory, LoggingCategoryConfig>;
}

export interface StructuredLogEvent {
  timestamp: string; // ISO8601 UTC
  level: LogLevel;
  category: LogCategory;
  message: string;
  identifier?: string;
  metadata?: Record<string, unknown>;
}

export interface LogEventInput {
  /**
   * Category token; case-insensitive string or enum. Invalid values are normalised to SYSTEM.
   */
  category: LogCategory | string;

  /**
   * Level token; case-insensitive string or enum. "WARN" is treated as "WARNING".
   */
  level: LogLevel | string;

  /**
   * Human-readable message.
   */
  message: string;

  /**
   * Optional correlation identifier (e.g. "task_id:123").
   */
  identifier?: string;

  /**
   * Arbitrary structured metadata that will be serialised into the log line.
   */
  metadata?: Record<string, unknown>;

  /**
   * Optional timestamp; if omitted, current time (in UTC) is used.
   */
  timestamp?: Date;
}

/**
 * Numeric severity ranking for log levels (for threshold comparisons).
 */
const LOG_LEVEL_ORDER: Record<LogLevel, number> = {
  [LogLevel.DEBUG]: 10,
  [LogLevel.INFO]: 20,
  [LogLevel.WARNING]: 30,
  [LogLevel.ERROR]: 40,
  [LogLevel.CRITICAL]: 50,
};

/**
 * Default per-category logging configuration, aligned with the core logging spec.
 */
const DEFAULT_CATEGORY_CONFIG: Record<LogCategory, LoggingCategoryConfig> = {
  [LogCategory.WORKFLOW]: {
    file: 'workflow_activity.log',
    retentionDays: 180,
    rotation: 'weekly',
    maxFileSizeMb: 50,
  },
  [LogCategory.TASK]: {
    file: 'task_execution.log',
    retentionDays: 365,
    rotation: 'weekly',
    maxFileSizeMb: 50,
  },
  [LogCategory.SYSTEM]: {
    file: 'system_activity.log',
    retentionDays: 180,
    rotation: 'weekly',
    maxFileSizeMb: 50,
  },
  [LogCategory.SECURITY]: {
    file: 'security_events.log',
    retentionDays: 730,
    rotation: 'weekly',
    maxFileSizeMb: 20,
  },
  [LogCategory.EMAIL]: {
    file: 'email_events.log',
    retentionDays: 180,
    rotation: 'weekly',
    maxFileSizeMb: 50,
  },
};

/**
 * Core logging service for Orgo.
 *
 * Responsibilities:
 * - Provide a single structured logEvent entry point.
 * - Enforce canonical LOG_CATEGORY / LOG_LEVEL tokens.
 * - Honour a minimum log level threshold.
 * - Write structured JSON/text lines to per-category log files.
 * - Provide helpers for security events and log rotation.
 */
@Injectable()
export class LogService implements OnModuleInit {
  private readonly logger = new NestLogger(LogService.name);
  private readonly config: LoggingConfig;
  private readonly minLevel: LogLevel;

  constructor(private readonly configService: ConfigService) {
    this.config = this.buildConfigFromEnv();
    this.minLevel = this.config.level;
  }

  async onModuleInit(): Promise<void> {
    await this.ensureLogDirectoryExists();
  }

  /**
   * Main entry point: write a structured log event.
   *
   * This method is intentionally "fire-and-forget" from the caller’s perspective;
   * file I/O is performed asynchronously and errors are logged to the Nest logger.
   */
  logEvent(input: LogEventInput): void {
    const category = this.normalizeCategory(input.category);
    const level = this.normalizeLevel(input.level);

    if (!this.shouldLog(level)) {
      return;
    }

    const event: StructuredLogEvent = {
      timestamp: (input.timestamp ?? new Date()).toISOString(),
      level,
      category,
      message: input.message,
      identifier: input.identifier,
      metadata: input.metadata,
    };

    const line =
      this.config.format === 'json'
        ? JSON.stringify(event)
        : this.formatTextLine(event);

    this.logToNest(level, line);
    void this.writeToFile(category, line);
  }

  /**
   * Convenience helper for SECURITY-category events.
   *
   * Example usage:
   *   logSecurityEvent('User login failed', { identifier: `user_id:${id}`, metadata: {...} });
   */
  logSecurityEvent(
    message: string,
    options: Omit<LogEventInput, 'category' | 'level' | 'message'> & {
      level?: LogLevel | string;
    } = {},
  ): void {
    this.logEvent({
      category: LogCategory.SECURITY,
      level: options.level ?? LogLevel.WARNING,
      message,
      identifier: options.identifier,
      metadata: options.metadata,
      timestamp: options.timestamp,
    });
  }

  /**
   * Rotate all category log files according to their configured rotation strategy.
   *
   * This is intended to be called periodically (e.g. via a cron job).
   * - For rotation: "daily" / "weekly", the current file is always rotated on invocation.
   * - For rotation: "size", this method delegates to size-based rotation as a fallback
   *   (size-based rotation is also applied on each write).
   */
  async rotateLogs(referenceDate: Date = new Date()): Promise<void> {
    const tasks: Promise<void>[] = [];

    for (const [categoryKey, categoryConfig] of Object.entries(
      this.config.categories,
    )) {
      const category = categoryKey as LogCategory;
      tasks.push(
        this.rotateCategoryLogs(category, categoryConfig, referenceDate).catch(
          (error) => {
            this.logger.error(
              `Failed to rotate logs for category "${category}": ${
                (error as Error).message
              }`,
            );
          },
        ),
      );
    }

    await Promise.all(tasks);
  }

  // ---------------------------------------------------------------------------
  // Internal helpers
  // ---------------------------------------------------------------------------

  private buildConfigFromEnv(): LoggingConfig {
    const envLevel = this.configService.get<string>('ORGO_LOG_LEVEL');
    const envFormat = this.configService.get<string>('ORGO_LOG_FORMAT');
    const envDir = this.configService.get<string>('ORGO_LOG_DIR');

    const level =
      this.normalizeLevelToken(envLevel) ?? LogLevel.INFO; // default INFO

    const format: LogFormat =
      envFormat && envFormat.toLowerCase() === 'text' ? 'text' : 'json';

    const logDir =
      envDir && envDir.trim().length > 0
        ? path.resolve(envDir)
        : path.resolve(process.cwd(), 'logs');

    // Deep clone default category config so we can mutate per-instance safely
    const categories: Record<LogCategory, LoggingCategoryConfig> =
      {} as Record<LogCategory, LoggingCategoryConfig>;

    for (const [key, cfg] of Object.entries(DEFAULT_CATEGORY_CONFIG)) {
      const category = key as LogCategory;
      categories[category] = { ...cfg };
    }

    return {
      level,
      format,
      logDir,
      categories,
    };
  }

  private async ensureLogDirectoryExists(): Promise<void> {
    try {
      await fsp.mkdir(this.config.logDir, { recursive: true });
    } catch (error) {
      this.logger.error(
        `Failed to ensure log directory "${this.config.logDir}": ${
          (error as Error).message
        }`,
      );
    }
  }

  private normalizeLevelToken(token?: string | null): LogLevel | null {
    if (!token) {
      return null;
    }

    const upper = token.toUpperCase().trim();

    if (upper === 'WARN') {
      return LogLevel.WARNING;
    }

    const values = Object.values(LogLevel);
    if (values.includes(upper as LogLevel)) {
      return upper as LogLevel;
    }

    this.logger.warn(
      `Unknown ORGO_LOG_LEVEL "${token}", falling back to default level.`,
    );
    return null;
  }

  private normalizeLevel(level: LogLevel | string): LogLevel {
    if (Object.values(LogLevel).includes(level as LogLevel)) {
      return level as LogLevel;
    }
    const normalised = this.normalizeLevelToken(String(level));
    return normalised ?? LogLevel.INFO;
  }

  private normalizeCategory(category: LogCategory | string): LogCategory {
    if (Object.values(LogCategory).includes(category as LogCategory)) {
      return category as LogCategory;
    }

    const upper = String(category).toUpperCase().trim();
    const found = Object.values(LogCategory).find((c) => c === upper);

    if (found) {
      return found;
    }

    this.logger.warn(
      `Unknown log category "${category}", defaulting to SYSTEM.`,
    );
    return LogCategory.SYSTEM;
  }

  private shouldLog(level: LogLevel): boolean {
    return (
      LOG_LEVEL_ORDER[level] >= LOG_LEVEL_ORDER[this.minLevel as LogLevel]
    );
  }

  private formatTextLine(event: StructuredLogEvent): string {
    const parts: string[] = [
      event.timestamp,
      event.level,
      event.category,
      event.identifier ?? '-',
      event.message,
    ];

    if (event.metadata && Object.keys(event.metadata).length > 0) {
      parts.push(JSON.stringify(event.metadata));
    }

    return parts.join(' | ');
  }

  private logToNest(level: LogLevel, message: string): void {
    switch (level) {
      case LogLevel.DEBUG:
        this.logger.debug(message);
        break;
      case LogLevel.INFO:
        this.logger.log(message);
        break;
      case LogLevel.WARNING:
        this.logger.warn(message);
        break;
      case LogLevel.ERROR:
      case LogLevel.CRITICAL:
        this.logger.error(message);
        break;
      default:
        this.logger.log(message);
        break;
    }
  }

  private async writeToFile(
    category: LogCategory,
    line: string,
  ): Promise<void> {
    const categoryConfig = this.config.categories[category];
    if (!categoryConfig) {
      return;
    }

    const filePath = path.join(this.config.logDir, categoryConfig.file);

    try {
      // Size-based rotation is always enforced as a safeguard.
      await this.rotateIfNeededBySize(
        filePath,
        categoryConfig.maxFileSizeMb,
        categoryConfig.retentionDays,
      );

      await fsp.appendFile(filePath, line + '\n', { encoding: 'utf8' });
    } catch (error) {
      this.logger.error(
        `Failed to write log file "${filePath}": ${
          (error as Error).message
        }`,
      );
    }
  }

  private async rotateIfNeededBySize(
    filePath: string,
    maxFileSizeMb: number,
    retentionDays: number,
  ): Promise<void> {
    let stats;
    try {
      stats = await fsp.stat(filePath);
    } catch (error) {
      // ENOENT = file does not exist yet → nothing to rotate
      if ((error as NodeJS.ErrnoException).code === 'ENOENT') {
        return;
      }
      throw error;
    }

    const maxBytes = maxFileSizeMb * 1024 * 1024;
    if (stats.size <= maxBytes) {
      return;
    }

    await this.rotateSingleFile(filePath, retentionDays);
  }

  private async rotateCategoryLogs(
    category: LogCategory,
    categoryConfig: LoggingCategoryConfig,
    referenceDate: Date,
  ): Promise<void> {
    const filePath = path.join(this.config.logDir, categoryConfig.file);

    // For daily/weekly rotation, we simply rotate the current file if it exists.
    if (categoryConfig.rotation === 'daily') {
      await this.rotateIfExists(filePath, categoryConfig.retentionDays);
    } else if (categoryConfig.rotation === 'weekly') {
      await this.rotateIfExists(filePath, categoryConfig.retentionDays);
    } else if (categoryConfig.rotation === 'size') {
      await this.rotateIfNeededBySize(
        filePath,
        categoryConfig.maxFileSizeMb,
        categoryConfig.retentionDays,
      );
    } else {
      this.logger.warn(
        `Unknown rotation strategy "${
          categoryConfig.rotation as string
        }" for category "${category}".`,
      );
    }

    // referenceDate is currently unused, but kept for future time-based policies.
    void referenceDate;
  }

  private async rotateIfExists(
    filePath: string,
    retentionDays: number,
  ): Promise<void> {
    try {
      await fsp.stat(filePath);
    } catch (error) {
      if ((error as NodeJS.ErrnoException).code === 'ENOENT') {
        return; // nothing to rotate
      }
      throw error;
    }

    await this.rotateSingleFile(filePath, retentionDays);
  }

  private async rotateSingleFile(
    filePath: string,
    retentionDays: number,
  ): Promise<void> {
    const dir = path.dirname(filePath);
    const base = path.basename(filePath, path.extname(filePath));
    const ext = path.extname(filePath) || '.log';
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');

    const rotatedPath = path.join(dir, `${base}.${timestamp}${ext}`);

    try {
      await fsp.rename(filePath, rotatedPath);
    } catch (error) {
      this.logger.error(
        `Failed to rotate log file "${filePath}": ${
          (error as Error).message
        }`,
      );
      return;
    }

    await this.cleanupOldRotatedFiles(dir, base, ext, retentionDays);
  }

  private async cleanupOldRotatedFiles(
    dir: string,
    base: string,
    ext: string,
    retentionDays: number,
  ): Promise<void> {
    const retentionMs = retentionDays * 24 * 60 * 60 * 1000;
    const now = Date.now();

    let entries: string[];
    try {
      entries = await fsp.readdir(dir);
    } catch (error) {
      this.logger.error(
        `Failed to read log directory "${dir}" for cleanup: ${
          (error as Error).message
        }`,
      );
      return;
    }

    const prefix = `${base}.`;

    const candidates = entries.filter(
      (name) => name.startsWith(prefix) && name.endsWith(ext),
    );

    const deletions: Promise<void>[] = [];

    for (const name of candidates) {
      const fullPath = path.join(dir, name);
      deletions.push(
        (async () => {
          try {
            const stats = await fsp.stat(fullPath);
            const ageMs = now - stats.mtime.getTime();
            if (ageMs > retentionMs) {
              await fsp.unlink(fullPath);
            }
          } catch (error) {
            this.logger.error(
              `Failed to evaluate or delete rotated log file "${fullPath}": ${
                (error as Error).message
              }`,
            );
          }
        })(),
      );
    }

    await Promise.all(deletions);
  }
}

===== END apps/api/src/orgo/core/logging/log.service.ts =====


===== BEGIN apps/api/src/orgo/core/logging/logger.module.ts =====
import { Global, Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { LogService } from './log.service';
import { LogRotationService } from './log-rotation.service';
import { LogQueryService } from './log-query.service';

/**
 * Injection token for the core Orgo logger_service.
 *
 * This matches the logical service identifier used in the Orgo
 * Core Services specification and can be used with:
 *
 *   @Inject(LOGGER_SERVICE_TOKEN) private readonly logService: LogService
 */
export const LOGGER_SERVICE_TOKEN = 'logger_service';

@Global()
@Module({
  imports: [
    // Uses the global ConfigModule instance from AppModule.
    // LogService is responsible for reading logging_config.yaml or
    // equivalent configuration via ConfigService.
    ConfigModule,
  ],
  providers: [
    LogService,
    {
      // Provide LogService under the stable string token "logger_service"
      // so other modules can depend on the logical core service id
      // instead of the concrete class name.
      provide: LOGGER_SERVICE_TOKEN,
      useExisting: LogService,
    },
    LogRotationService,
    LogQueryService,
  ],
  exports: [
    // Export both the concrete class and the string token so that
    // consumers can choose either style of injection.
    LogService,
    LOGGER_SERVICE_TOKEN,
    LogRotationService,
    LogQueryService,
  ],
})
export class LoggerModule {}

===== END apps/api/src/orgo/core/logging/logger.module.ts =====


===== BEGIN apps/api/src/orgo/core/metrics/metrics.service.ts =====

===== END apps/api/src/orgo/core/metrics/metrics.service.ts =====


===== BEGIN apps/api/src/orgo/core/notifications/notification.controller.ts =====
import { Controller, Get, Post, Body, Query } from '@nestjs/common';
import { ApiTags, ApiOperation, ApiResponse, ApiProperty } from '@nestjs/swagger';

import { NotificationService } from './notification.service';

/**
 * Canonical notification channels and statuses as per Doc 1/Doc 2.
 * DB stores these as lower-case strings; API uses the same tokens.
 */
export enum NotificationChannel {
  EMAIL = 'email',
  SMS = 'sms',
  IN_APP = 'in_app',
  WEBHOOK = 'webhook',
}

export enum NotificationStatus {
  QUEUED = 'queued',
  SENT = 'sent',
  FAILED = 'failed',
  CANCELLED = 'cancelled',
}

/**
 * Query DTO for listing notifications for the current user.
 * Filtering is intentionally minimal; more filters can be added later
 * (e.g. by template code, task, date range).
 */
export class ListNotificationsQueryDto {
  @ApiProperty({
    required: false,
    enum: NotificationChannel,
    description: 'Filter by notification channel (email, sms, in_app, webhook).',
  })
  channel?: NotificationChannel;

  @ApiProperty({
    required: false,
    enum: NotificationStatus,
    description: 'Filter by delivery status (queued, sent, failed, cancelled).',
  })
  status?: NotificationStatus;

  @ApiProperty({
    required: false,
    minimum: 1,
    maximum: 200,
    default: 50,
    description: 'Maximum number of items to return (1–200). Defaults to 50.',
  })
  limit?: number;

  @ApiProperty({
    required: false,
    description:
      'Opaque cursor for pagination; use the value returned as nextCursor from a previous call.',
  })
  cursor?: string;
}

/**
 * Logical Notification view returned by the API.
 * Fields mirror the logical Notification model over the notifications table.
 */
export class NotificationDto {
  @ApiProperty({ format: 'uuid' })
  id!: string;

  @ApiProperty({ format: 'uuid', description: 'Tenant / organization identifier.' })
  organizationId!: string;

  @ApiProperty({ enum: NotificationChannel })
  channel!: NotificationChannel;

  @ApiProperty({ enum: NotificationStatus })
  status!: NotificationStatus;

  @ApiProperty({
    format: 'uuid',
    nullable: true,
    description: 'Recipient user id, if the notification is tied to a user account.',
  })
  recipientUserId!: string | null;

  @ApiProperty({
    nullable: true,
    description:
      'Recipient address (email/phone/webhook URL/device token) for non user-tied notifications.',
  })
  recipientAddress!: string | null;

  @ApiProperty({
    format: 'uuid',
    nullable: true,
    description: 'Related Task id, when the notification is tied to a Task lifecycle event.',
  })
  relatedTaskId!: string | null;

  @ApiProperty({
    type: 'object',
    description:
      'Channel-ready payload (for in_app: title/body + context; for email/webhook: rendered payload).',
    additionalProperties: true,
  })
  payload!: Record<string, unknown>;

  @ApiProperty({
    nullable: true,
    description: 'Time the notification was queued for delivery (ISO 8601, UTC).',
  })
  queuedAt!: string | null;

  @ApiProperty({
    nullable: true,
    description: 'Time the notification was sent successfully (ISO 8601, UTC).',
  })
  sentAt!: string | null;

  @ApiProperty({
    nullable: true,
    description: 'Time the notification failed permanently (ISO 8601, UTC).',
  })
  failedAt!: string | null;

  @ApiProperty({
    nullable: true,
    description: 'Error message captured when delivery fails.',
  })
  errorMessage!: string | null;
}

/**
 * Paginated notifications feed response.
 */
export class NotificationFeedResponseDto {
  @ApiProperty({ type: [NotificationDto] })
  items!: NotificationDto[];

  @ApiProperty({
    nullable: true,
    description:
      'Cursor to fetch the next page. Omitted/null when there are no more results.',
  })
  nextCursor?: string | null;
}

/**
 * DTO for sending an ad-hoc in-app notification.
 * This uses the NotificationService.sendInApp logical entrypoint from Doc 4.
 * Task-driven notifications (CREATED/ASSIGNED/ESCALATED/COMPLETED) are typically
 * triggered internally via sendTaskNotification, not via this controller.
 */
export class SendInAppNotificationDto {
  @ApiProperty({
    format: 'uuid',
    description: 'Recipient user id within the current organization.',
  })
  recipientUserId!: string;

  @ApiProperty({
    maxLength: 200,
    description: 'Short title used in in-app banners/toasts.',
  })
  title!: string;

  @ApiProperty({
    maxLength: 2000,
    description: 'Body text shown in the in-app notification.',
  })
  body!: string;

  @ApiProperty({
    required: false,
    format: 'uuid',
    description: 'Optional related Task id to deep-link from the notification.',
  })
  relatedTaskId?: string;

  @ApiProperty({
    required: false,
    type: 'object',
    additionalProperties: true,
    description:
      'Optional extra metadata to embed in the payload (e.g. label, domain info, deep-link params).',
  })
  metadata?: Record<string, unknown>;
}

@ApiTags('notifications')
@Controller('notifications')
export class NotificationController {
  constructor(private readonly notificationService: NotificationService) {}

  @Get()
  @ApiOperation({
    summary: 'List notifications for the current user',
    description:
      'Returns a paginated feed of notifications (email, sms, in_app, webhook) for the authenticated user, filtered by channel/status as needed.',
  })
  @ApiResponse({
    status: 200,
    type: NotificationFeedResponseDto,
  })
  async listNotifications(
    @Query() query: ListNotificationsQueryDto,
  ): Promise<NotificationFeedResponseDto> {
    // Basic, defensive normalization of limit without assuming any specific validation pipe.
    const rawLimit = (query as any).limit;
    const numericLimit = rawLimit !== undefined ? Number(rawLimit) : NaN;
    const effectiveLimit =
      Number.isFinite(numericLimit) && numericLimit > 0
        ? Math.min(Math.max(Math.floor(numericLimit), 1), 200)
        : 50;

    const filters: ListNotificationsQueryDto = {
      ...query,
      limit: effectiveLimit,
    };

    // Multi-tenant + user scoping is handled inside NotificationService,
    // using whatever auth/context mechanism is wired into the app.
    return this.notificationService.listNotificationsForCurrentUser(filters);
  }

  @Post('in-app')
  @ApiOperation({
    summary: 'Send an ad-hoc in-app notification',
    description:
      'Queues an in-app notification to a single user in the current organization. Task-driven lifecycle notifications should use Task/Workflow services instead.',
  })
  @ApiResponse({
    status: 201,
    type: NotificationDto,
  })
  async sendInApp(
    @Body() body: SendInAppNotificationDto,
  ): Promise<NotificationDto> {
    return this.notificationService.sendInApp(body);
  }
}

===== END apps/api/src/orgo/core/notifications/notification.controller.ts =====


===== BEGIN apps/api/src/orgo/core/notifications/notification.module.ts =====
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';

import { PersistenceModule } from '../../../persistence/persistence.module';
import { LoggerModule } from '../logging/logger.module';
import { ConfigModule as OrgoConfigModule } from '../../config/config.module';
import { NotificationService } from './notification.service';

/**
 * NotificationModule
 *
 * Exposes NotificationService and integrates it with:
 * - Nest env config (ConfigModule),
 * - Orgo YAML config (notification_config.yaml),
 * - Shared persistence layer,
 * - Structured logging.
 */
@Module({
  imports: [
    ConfigModule,
    OrgoConfigModule,
    PersistenceModule,
    LoggerModule,
  ],
  providers: [NotificationService],
  exports: [NotificationService],
})
export class NotificationModule {}

===== END apps/api/src/orgo/core/notifications/notification.module.ts =====


===== BEGIN apps/api/src/orgo/core/notifications/notification.service.ts =====
// apps/api/src/orgo/core/notifications/notification.service.ts

import { Inject, Injectable, Logger } from '@nestjs/common';
import { OrgoConfigService } from '../../config/config.service';
import { OrgProfileService } from '../../config/org-profile.service';
import { LogService } from '../logging/log.service';
import { EmailService } from '../email/email.service';

/**
 * Injection token for a pluggable recipient resolver.
 * A provider must be bound to this token in the NotificationsModule.
 */
export const NOTIFICATION_RECIPIENT_RESOLVER = 'NOTIFICATION_RECIPIENT_RESOLVER';

/**
 * Canonical notification channels (Doc 2 §2.8 / Doc 5 §7).
 */
export type NotificationChannel = 'EMAIL' | 'SMS' | 'IN_APP' | 'WEBHOOK';

/**
 * Canonical notification scopes (Doc 2 §2.8, Doc 7 profiles.notification_scope).
 */
export type NotificationScope = 'user' | 'team' | 'department' | 'org_wide';

/**
 * Supported task lifecycle notification events (Doc 5 §7.3).
 */
export type TaskNotificationEventType =
  | 'CREATED'
  | 'ASSIGNED'
  | 'ESCALATED'
  | 'COMPLETED';

/**
 * Canonical VISIBILITY enum (JSON / service form).
 */
export type TaskVisibility = 'PUBLIC' | 'INTERNAL' | 'RESTRICTED' | 'ANONYMISED';

/**
 * Standard service-level error shape (Doc 5 §2.4).
 */
export interface ServiceError {
  code: string;
  message: string;
  details?: Record<string, unknown>;
}

/**
 * Standard result shape (Doc 5 §2.4).
 */
export interface ServiceResult<T> {
  ok: boolean;
  data: T | null;
  error: ServiceError | null;
}

/**
 * Minimal Task payload required to send notifications.
 * This is a logical view aligned with the canonical Task model (Doc 5 §3.1 / Doc 8 §8.4.2).
 */
export interface NotifiableTask {
  taskId: string;
  organizationId: string;

  title: string;
  description: string;
  label: string;

  status: string;
  priority: string;
  severity: string;
  visibility: TaskVisibility;

  source: 'email' | 'api' | 'manual' | 'sync';

  ownerRoleId?: string | null;
  ownerUserId?: string | null;
  assigneeRole?: string | null;

  createdByUserId?: string | null;
  requesterPersonId?: string | null;

  metadata?: Record<string, unknown>;
}

/**
 * Recipient representation for notifications across channels.
 */
export interface NotificationRecipient {
  userId?: string;
  email?: string | null;
  displayName?: string | null;
  /**
   * Optional per-recipient channel override.
   * If omitted, all selected channels are used.
   */
  preferredChannels?: NotificationChannel[];
}

/**
 * Result of resolving recipients for a task notification.
 */
export interface ResolvedNotificationRecipients {
  primary: NotificationRecipient[];
  cc: NotificationRecipient[];
}

/**
 * Dispatch result for a single channel.
 */
export interface NotificationChannelDispatchResult {
  channel: NotificationChannel;
  success: boolean;
  recipients: string[]; // normalized recipient identifiers (typically emails or user IDs)
  cc?: string[];
  error?: string;
  providerMetadata?: Record<string, unknown>;
}

/**
 * Summary for a Task notification operation.
 */
export interface TaskNotificationDispatchSummary {
  taskId: string;
  organizationId: string;
  eventType: TaskNotificationEventType;
  scope: NotificationScope;
  suppressed: boolean;
  suppressionReason?: string;
  channels: NotificationChannelDispatchResult[];
}

/**
 * Normalised Notification configuration (Doc 5 §7.2), as exposed by OrgoConfigService.
 */
export interface NotificationConfig {
  defaultChannel: NotificationChannel;
  channels: {
    email: {
      enabled: boolean;
      senderName: string;
      senderAddress: string;
    };
    inApp: {
      enabled: boolean;
    };
    sms?: {
      enabled: boolean;
    };
    webhook?: {
      enabled: boolean;
      endpoint?: string;
    };
  };
  templates: {
    taskCreated: string;
    taskAssignment: string;
    taskEscalation: string;
    taskCompleted: string;
  };
}

/**
 * Minimal Org profile view used here (Doc 7).
 */
export interface OrgProfile {
  notification_scope: NotificationScope;
}

/**
 * Contract for a pluggable recipient resolver.
 * Implementation is responsible for mapping roles/users/profiles → concrete recipients.
 */
export interface NotificationRecipientResolver {
  resolveTaskRecipients(params: {
    task: NotifiableTask;
    eventType: TaskNotificationEventType;
    scope: NotificationScope;
  }): Promise<ResolvedNotificationRecipients>;
}

/**
 * NotificationService – orchestrates Task-driven notifications
 * across configured channels (email, in-app, etc.) (Doc 5 §7).
 */
@Injectable()
export class NotificationService {
  private readonly logger = new Logger(NotificationService.name);

  constructor(
    private readonly emailService: EmailService,
    private readonly orgProfileService: OrgProfileService,
    private readonly configService: OrgoConfigService,
    private readonly logService: LogService,
    @Inject(NOTIFICATION_RECIPIENT_RESOLVER)
    private readonly recipientResolver: NotificationRecipientResolver,
  ) {}

  /**
   * Public entry point: send notifications for a Task lifecycle event
   * (Doc 5 §7.3).
   */
  async sendTaskNotification(
    task: NotifiableTask,
    eventType: TaskNotificationEventType,
  ): Promise<ServiceResult<TaskNotificationDispatchSummary>> {
    if (!task || !task.taskId || !task.organizationId) {
      return {
        ok: false,
        data: null,
        error: {
          code: 'NOTIFICATION_INVALID_TASK',
          message: 'Task and its identifiers are required to send notifications',
        },
      };
    }

    try {
      const [notificationConfig, profile] = await Promise.all([
        this.loadNotificationConfig(task.organizationId),
        this.orgProfileService.loadProfile(
          task.organizationId,
        ) as Promise<OrgProfile>,
      ]);

      const scope: NotificationScope =
        (profile?.notification_scope as NotificationScope) || 'department';

      const channels = this.selectChannelsForEvent(
        notificationConfig,
        eventType,
      );

      if (channels.length === 0) {
        const summary: TaskNotificationDispatchSummary = {
          taskId: task.taskId,
          organizationId: task.organizationId,
          eventType,
          scope,
          suppressed: true,
          suppressionReason: 'No enabled notification channels for event',
          channels: [],
        };

        await this.logService.logEvent({
          category: 'TASK',
          logLevel: 'INFO',
          message: 'Notification suppressed: no enabled channels',
          identifier: `task_id:${task.taskId}`,
          metadata: { eventType, scope },
        });

        return {
          ok: true,
          data: summary,
          error: null,
        };
      }

      const recipients = await this.recipientResolver.resolveTaskRecipients({
        task,
        eventType,
        scope,
      });

      const hasAnyResolvedRecipient =
        recipients.primary.length > 0 || recipients.cc.length > 0;

      if (!hasAnyResolvedRecipient) {
        const summary: TaskNotificationDispatchSummary = {
          taskId: task.taskId,
          organizationId: task.organizationId,
          eventType,
          scope,
          suppressed: true,
          suppressionReason: 'No recipients resolved for notification',
          channels: [],
        };

        await this.logService.logEvent({
          category: 'TASK',
          logLevel: 'INFO',
          message: 'Notification suppressed: no recipients',
          identifier: `task_id:${task.taskId}`,
          metadata: { eventType, scope, visibility: task.visibility },
        });

        return {
          ok: true,
          data: summary,
          error: null,
        };
      }

      const recipientsByChannel = this.splitRecipientsByChannel(recipients);

      const hasRecipientsForAtLeastOneChannel = channels.some((channel) => {
        const channelRecipients = recipientsByChannel[channel];
        return (
          channelRecipients.primary.length > 0 ||
          channelRecipients.cc.length > 0
        );
      });

      if (!hasRecipientsForAtLeastOneChannel) {
        const summary: TaskNotificationDispatchSummary = {
          taskId: task.taskId,
          organizationId: task.organizationId,
          eventType,
          scope,
          suppressed: true,
          suppressionReason:
            'No recipients resolved for any of the selected notification channels',
          channels: [],
        };

        await this.logService.logEvent({
          category: 'TASK',
          logLevel: 'INFO',
          message:
            'Notification suppressed: recipients have no matching channel preferences',
          identifier: `task_id:${task.taskId}`,
          metadata: {
            eventType,
            scope,
            visibility: task.visibility,
            channels,
          },
        });

        return {
          ok: true,
          data: summary,
          error: null,
        };
      }

      const channelResults: NotificationChannelDispatchResult[] = [];

      for (const channel of channels) {
        const channelRecipients = recipientsByChannel[channel];

        switch (channel) {
          case 'EMAIL': {
            const to = this.extractEmails(channelRecipients.primary);
            const cc = this.extractEmails(channelRecipients.cc);

            const result = await this.sendEmailTaskNotification(
              task,
              eventType,
              notificationConfig,
              to,
              cc,
            );
            channelResults.push(result);
            break;
          }

          case 'IN_APP': {
            const recipientIdentifiers = this.extractInAppRecipientIdentifiers(
              channelRecipients.primary,
              channelRecipients.cc,
            );

            const result = await this.sendInAppTaskNotification(
              task,
              eventType,
              recipientIdentifiers,
            );
            channelResults.push(result);
            break;
          }

          default: {
            const normalised = this.normaliseRecipientIdentifiers(
              channelRecipients,
            );
            channelResults.push({
              channel,
              success: false,
              recipients: normalised.to,
              cc: normalised.cc,
              error: 'Channel not implemented',
            });
            break;
          }
        }
      }

      const summary: TaskNotificationDispatchSummary = {
        taskId: task.taskId,
        organizationId: task.organizationId,
        eventType,
        scope,
        suppressed: false,
        channels: channelResults,
      };

      await this.logService.logEvent({
        category: 'TASK',
        logLevel: 'INFO',
        message: 'Task notifications dispatched',
        identifier: `task_id:${task.taskId}`,
        metadata: {
          eventType,
          scope,
          channels: channelResults.map((c) => ({
            channel: c.channel,
            success: c.success,
          })),
        },
      });

      return {
        ok: true,
        data: summary,
        error: null,
      };
    } catch (err) {
      const error = err as Error;
      this.logger.error(
        `Failed to send notifications for task ${task.taskId} (${eventType}): ${error.message}`,
        error.stack,
      );

      await this.logService.logEvent({
        category: 'TASK',
        logLevel: 'ERROR',
        message: 'Task notification failed',
        identifier: `task_id:${task.taskId}`,
        metadata: {
          eventType,
          error: error.message,
        },
      });

      return {
        ok: false,
        data: null,
        error: {
          code: 'NOTIFICATION_ERROR',
          message: error.message,
        },
      };
    }
  }

  /**
   * Load and normalise notification configuration for an organization
   * (Doc 5 §7.2). Delegates to OrgoConfigService.
   */
  private async loadNotificationConfig(
    organizationId: string,
  ): Promise<NotificationConfig> {
    const config =
      await this.configService.getNotificationConfig(organizationId);

    if (!config) {
      throw new Error(
        `Notification configuration not found for organization ${organizationId}`,
      );
    }

    return config;
  }

  /**
   * Select channels to use for a given event, based on config.
   * At minimum, uses the default channel if enabled; also adds IN_APP
   * if enabled as a secondary channel.
   */
  private selectChannelsForEvent(
    config: NotificationConfig,
    eventType: TaskNotificationEventType,
  ): NotificationChannel[] {
    const channels: NotificationChannel[] = [];

    if (this.isChannelEnabled(config, config.defaultChannel)) {
      channels.push(config.defaultChannel);
    }

    // Enable IN_APP as a secondary channel for key lifecycle events if configured.
    if (
      this.isChannelEnabled(config, 'IN_APP') &&
      !channels.includes('IN_APP')
    ) {
      channels.push('IN_APP');
    }

    // Hook point: per-event channel routing could be added here.
    // For now, all events share the same channel selection logic.

    return channels;
  }

  private isChannelEnabled(
    config: NotificationConfig,
    channel: NotificationChannel,
  ): boolean {
    switch (channel) {
      case 'EMAIL':
        return !!config.channels.email?.enabled;
      case 'IN_APP':
        return !!config.channels.inApp?.enabled;
      case 'SMS':
        return !!config.channels.sms?.enabled;
      case 'WEBHOOK':
        return !!config.channels.webhook?.enabled;
      default:
        return false;
    }
  }

  /**
   * Check whether a recipient allows a given channel based on preferredChannels.
   * If preferredChannels is empty/undefined, all channels are allowed.
   */
  private doesRecipientAllowChannel(
    recipient: NotificationRecipient,
    channel: NotificationChannel,
  ): boolean {
    const { preferredChannels } = recipient;
    if (!preferredChannels || preferredChannels.length === 0) {
      return true;
    }
    return preferredChannels.includes(channel);
  }

  /**
   * Split resolved recipients into per-channel buckets, respecting
   * per-recipient preferredChannels.
   */
  private splitRecipientsByChannel(
    recipients: ResolvedNotificationRecipients,
  ): Record<
    NotificationChannel,
    { primary: NotificationRecipient[]; cc: NotificationRecipient[] }
  > {
    const result: Record<
      NotificationChannel,
      { primary: NotificationRecipient[]; cc: NotificationRecipient[] }
    > = {
      EMAIL: { primary: [], cc: [] },
      SMS: { primary: [], cc: [] },
      IN_APP: { primary: [], cc: [] },
      WEBHOOK: { primary: [], cc: [] },
    };

    const addRecipient = (
      recipient: NotificationRecipient,
      type: 'primary' | 'cc',
    ) => {
      (['EMAIL', 'SMS', 'IN_APP', 'WEBHOOK'] as NotificationChannel[]).forEach(
        (channel) => {
          if (this.doesRecipientAllowChannel(recipient, channel)) {
            result[channel][type].push(recipient);
          }
        },
      );
    };

    recipients.primary.forEach((recipient) => addRecipient(recipient, 'primary'));
    recipients.cc.forEach((recipient) => addRecipient(recipient, 'cc'));

    return result;
  }

  /**
   * Send email notification using EmailService (Doc 4 / Doc 5 §4.3).
   */
  private async sendEmailTaskNotification(
    task: NotifiableTask,
    eventType: TaskNotificationEventType,
    config: NotificationConfig,
    to: string[],
    cc: string[],
  ): Promise<NotificationChannelDispatchResult> {
    if (to.length === 0 && cc.length === 0) {
      return {
        channel: 'EMAIL',
        success: false,
        recipients: [],
        cc: [],
        error: 'No email recipients resolved',
      };
    }

    const templateId = this.getTemplateIdForEvent(config, eventType);
    const subject = this.buildEmailSubject(task, eventType);
    const variables = this.buildEmailTemplateVariables(task, eventType);

    const result = await this.emailService.sendEmail({
      to,
      cc,
      subject,
      templateId,
      variables,
      senderName: config.channels.email.senderName,
      senderAddress: config.channels.email.senderAddress,
    });

    if (!result.ok) {
      this.logger.warn(
        `Email notification failed for task ${task.taskId} (${eventType}): ${result.error?.message}`,
      );
    }

    return {
      channel: 'EMAIL',
      success: result.ok,
      recipients: to,
      cc,
      error: result.ok ? undefined : result.error?.message,
      providerMetadata: result.data ?? undefined,
    };
  }

  /**
   * Stub for in-app notifications. This should be wired to a persistence
   * layer and/or WebSocket gateway (e.g. TaskEventsGateway) later.
   */
  private async sendInAppTaskNotification(
    task: NotifiableTask,
    eventType: TaskNotificationEventType,
    recipientIdentifiers: string[],
  ): Promise<NotificationChannelDispatchResult> {
    if (recipientIdentifiers.length === 0) {
      return {
        channel: 'IN_APP',
        success: false,
        recipients: [],
        error: 'No in-app recipients resolved',
      };
    }

    // For now, we only log an in-app notification event.
    await this.logService.logEvent({
      category: 'TASK',
      logLevel: 'INFO',
      message: 'In-app notification emitted',
      identifier: `task_id:${task.taskId}`,
      metadata: {
        eventType,
        recipients: recipientIdentifiers,
      },
    });

    return {
      channel: 'IN_APP',
      success: true,
      recipients: recipientIdentifiers,
    };
  }

  private getTemplateIdForEvent(
    config: NotificationConfig,
    eventType: TaskNotificationEventType,
  ): string {
    switch (eventType) {
      case 'CREATED':
        return config.templates.taskCreated;
      case 'ASSIGNED':
        return config.templates.taskAssignment;
      case 'ESCALATED':
        return config.templates.taskEscalation;
      case 'COMPLETED':
        return config.templates.taskCompleted;
      default:
        // Fallback to created template for unknown events (should not occur).
        return config.templates.taskCreated;
    }
  }

  private buildEmailSubject(
    task: NotifiableTask,
    eventType: TaskNotificationEventType,
  ): string {
    const prefix = (() => {
      switch (eventType) {
        case 'CREATED':
          return '[Task Created]';
        case 'ASSIGNED':
          return '[Task Assigned]';
        case 'ESCALATED':
          return '[Task Escalated]';
        case 'COMPLETED':
          return '[Task Completed]';
        default:
          return '[Task Update]';
      }
    })();

    return `${prefix} ${task.title}`;
  }

  private buildEmailTemplateVariables(
    task: NotifiableTask,
    eventType: TaskNotificationEventType,
  ): Record<string, unknown> {
    return {
      taskId: task.taskId,
      organizationId: task.organizationId,
      title: task.title,
      description: task.description,
      label: task.label,
      status: task.status,
      priority: task.priority,
      severity: task.severity,
      visibility: task.visibility,
      source: task.source,
      ownerRoleId: task.ownerRoleId ?? null,
      ownerUserId: task.ownerUserId ?? null,
      assigneeRole: task.assigneeRole ?? null,
      createdByUserId: task.createdByUserId ?? null,
      requesterPersonId: task.requesterPersonId ?? null,
      metadata: task.metadata ?? {},
      eventType,
    };
  }

  /**
   * Normalise a single recipient identifier for logging / unimplemented channels.
   * Preference order: email → userId → displayName.
   */
  private normaliseRecipientIdentifier(
    recipient: NotificationRecipient,
  ): string | null {
    const email = (recipient.email || '').trim();
    if (email.length > 0) {
      return email;
    }

    const userId = (recipient.userId || '').trim();
    if (userId.length > 0) {
      return userId;
    }

    const displayName = (recipient.displayName || '').trim();
    if (displayName.length > 0) {
      return displayName;
    }

    return null;
  }

  private normaliseRecipientIdentifiers(recipients: {
    primary: NotificationRecipient[];
    cc: NotificationRecipient[];
  }): { to: string[]; cc: string[] } {
    const to = recipients.primary
      .map((recipient) => this.normaliseRecipientIdentifier(recipient))
      .filter((identifier): identifier is string => !!identifier);

    const cc = recipients.cc
      .map((recipient) => this.normaliseRecipientIdentifier(recipient))
      .filter((identifier): identifier is string => !!identifier);

    return { to, cc };
  }

  /**
   * Extract identifiers for IN_APP notifications.
   * Prefers userId; falls back to normalised identifiers if none present.
   */
  private extractInAppRecipientIdentifiers(
    primaryRecipients: NotificationRecipient[],
    ccRecipients: NotificationRecipient[],
  ): string[] {
    const byUserId = [...primaryRecipients, ...ccRecipients]
      .map((recipient) => (recipient.userId || '').trim())
      .filter((userId) => userId.length > 0);

    if (byUserId.length > 0) {
      return byUserId;
    }

    const normalised = this.normaliseRecipientIdentifiers({
      primary: primaryRecipients,
      cc: ccRecipients,
    });

    return [...normalised.to, ...normalised.cc];
  }

  private extractEmails(recipients: NotificationRecipient[]): string[] {
    return recipients
      .map((r) => (r.email || '').trim())
      .filter((email) => email.length > 0);
  }
}

===== END apps/api/src/orgo/core/notifications/notification.service.ts =====


===== BEGIN apps/api/src/orgo/core/offline/offline-sync.module.ts =====

===== END apps/api/src/orgo/core/offline/offline-sync.module.ts =====


===== BEGIN apps/api/src/orgo/core/offline/sync.service.ts =====
import { Injectable, Logger } from '@nestjs/common';
import { DatabaseService } from '../persistence/database.service';

export type SyncDirection = 'upload' | 'download' | 'bidirectional';

export interface OfflineTaskChange {
  /**
   * Operation performed on the offline node.
   * - insert: new task created on the offline node
   * - update: existing task updated on the offline node
   * - delete: task deleted/voided on the offline node (mapped to CANCELLED)
   */
  operation: 'insert' | 'update' | 'delete';

  /**
   * Task identifier as known on the server (tasks.id / task_id).
   * For inserts this can be omitted; for updates/deletes it should be provided
   * if the offline node already knows the server ID.
   */
  taskId?: string;

  /**
   * The client-side representation of the task after the operation.
   * This is stored/merged into the canonical tasks row.
   */
  data: Record<string, any>;

  /**
   * Snapshot of the server version that the client last saw when applying
   * this change. Used for optimistic concurrency / conflict detection.
   * If omitted, the change is applied with "last write wins" semantics.
   */
  serverVersion?: Record<string, any> | null;
}

export interface OfflineSyncPayload {
  /**
   * Tenant isolation key; this must match organizations.id.
   */
  organizationId: string;

  /**
   * Stable identifier for the offline node (e.g. device id / host slug).
   * Maps to offline_nodes.node_identifier.
   */
  nodeIdentifier: string;

  /**
   * Direction of sync:
   * - upload: client → server only
   * - download: server → client only
   * - bidirectional: upload then download in a single session
   */
  direction: SyncDirection;

  /**
   * Last successful sync timestamp as known by the client (ISO‑8601).
   * This is used as a hint when building the download snapshot.
   */
  clientLastSyncAt?: string | null;

  /**
   * Offline task changes to upload. Only used when direction includes "upload".
   */
  taskChanges?: OfflineTaskChange[];
}

export interface SyncSummary {
  uploadedTasks: number;
  createdTasks: number;
  updatedTasks: number;
  deletedTasks: number;
  conflicts: number;
  downloadedTasks: number;
}

export interface DownloadSnapshot {
  /**
   * Tasks changed on the server since last sync and relevant to this org.
   * Shape is the raw tasks rows; filtering/normalisation is handled by the client.
   */
  tasks: any[];
}

export interface SyncResult {
  sessionId: string;
  nodeId: string;
  direction: SyncDirection;
  summary: SyncSummary;
  /**
   * Optional download snapshot (only present when direction is "download"
   * or "bidirectional").
   */
  download?: DownloadSnapshot;
}

/**
 * SyncService
 *
 * Coordinates sync sessions between SQLite‑backed offline nodes and the
 * central Postgres database using:
 *  - offline_nodes
 *  - sync_sessions
 *  - sync_conflicts
 *  - tasks
 *
 * This service is intentionally generic and does not embed domain logic.
 * It works with the canonical Task model and multi‑tenant invariants.
 */
@Injectable()
export class SyncService {
  private readonly logger = new Logger(SyncService.name);

  constructor(private readonly db: DatabaseService) {}

  /**
   * High-level entry point for synchronising an offline node.
   *
   * 1. Ensures offline_nodes row exists for (organizationId, nodeIdentifier).
   * 2. Creates a sync_sessions row in "running" state.
   * 3. Applies uploaded changes (if direction === upload|bidirectional).
   * 4. Builds a download snapshot (if direction === download|bidirectional).
   * 5. Marks the sync_sessions row as completed/failed with summary + error.
   * 6. Updates offline_nodes.last_sync_at on success.
   */
  async syncOfflineNode(payload: OfflineSyncPayload): Promise<SyncResult> {
    const { organizationId, nodeIdentifier, direction } = payload;

    if (!organizationId) {
      throw new Error('organizationId is required for offline sync');
    }
    if (!nodeIdentifier) {
      throw new Error('nodeIdentifier is required for offline sync');
    }
    if (!direction) {
      throw new Error('direction is required for offline sync');
    }

    const prisma = this.getPrismaClient();

    const summary: SyncSummary = {
      uploadedTasks: 0,
      createdTasks: 0,
      updatedTasks: 0,
      deletedTasks: 0,
      conflicts: 0,
      downloadedTasks: 0,
    };

    // 1. Ensure offline_nodes row exists
    const offlineNode = await this.ensureOfflineNode(
      prisma,
      organizationId,
      nodeIdentifier,
    );

    // 2. Start sync session
    const session = await this.startSyncSession(
      prisma,
      offlineNode.id,
      direction,
    );

    let download: DownloadSnapshot | undefined;

    try {
      // 3. Apply upload changes
      if (direction === 'upload' || direction === 'bidirectional') {
        await this.applyTaskUploadChanges(
          prisma,
          session.id,
          organizationId,
          payload.taskChanges ?? [],
          summary,
        );
      }

      // 4. Build download snapshot
      if (direction === 'download' || direction === 'bidirectional') {
        download = await this.buildDownloadSnapshot(
          prisma,
          organizationId,
          offlineNode,
          payload.clientLastSyncAt,
          summary,
        );
      }

      // 5. Mark session as completed
      await this.completeSyncSession(prisma, session.id, 'completed', summary);

      // 6. Update offline_nodes.last_sync_at
      await prisma.offline_nodes.update({
        where: { id: offlineNode.id },
        data: { last_sync_at: new Date() },
      });

      this.logger.log(
        `Offline sync completed for node=${nodeIdentifier} org=${organizationId} direction=${direction}`,
      );

      return {
        sessionId: session.id,
        nodeId: offlineNode.id,
        direction,
        summary,
        download,
      };
    } catch (error) {
      this.logger.error(
        `Offline sync failed for node=${nodeIdentifier} org=${organizationId}: ${
          (error as Error).message
        }`,
        (error as Error).stack,
      );

      await this.completeSyncSession(
        prisma,
        session.id,
        'failed',
        summary,
        error,
      );

      throw error;
    }
  }

  /**
   * Convenience entry point for task‑only upload jobs (e.g. queue job
   * orgo.db.sync-offline). It simply delegates to syncOfflineNode with
   * direction "upload".
   */
  async syncOfflineTasks(payload: OfflineSyncPayload): Promise<SyncResult> {
    return this.syncOfflineNode({ ...payload, direction: 'upload' });
  }

  // ---------------------------------------------------------------------------
  // Internal helpers
  // ---------------------------------------------------------------------------

  /**
   * Obtain a PrismaClient from the DatabaseService. The DatabaseService in the
   * Orgo stack is expected to expose either:
   *  - getPrismaClient(): PrismaClient
   *  - prisma: PrismaClient
   *
   * This method handles both shapes and falls back to the raw service for
   * test/mocked implementations.
   */
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  private getPrismaClient(): any {
    const anyDb = this.db as any;

    if (typeof anyDb.getPrismaClient === 'function') {
      return anyDb.getPrismaClient();
    }

    if (anyDb.prisma) {
      return anyDb.prisma;
    }

    return anyDb;
  }

  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  private async ensureOfflineNode(
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    prisma: any,
    organizationId: string,
    nodeIdentifier: string,
  ): Promise<any> {
    const existing = await prisma.offline_nodes.findFirst({
      where: {
        organization_id: organizationId,
        node_identifier: nodeIdentifier,
      },
    });

    if (existing) {
      return existing;
    }

    this.logger.log(
      `Creating offline node for org=${organizationId}, node=${nodeIdentifier}`,
    );

    return prisma.offline_nodes.create({
      data: {
        organization_id: organizationId,
        node_identifier: nodeIdentifier,
        status: 'active', // offline_nodes.status enum: active | inactive | retired
        last_sync_at: null,
      },
    });
  }

  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  private async startSyncSession(
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    prisma: any,
    offlineNodeId: string,
    direction: SyncDirection,
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
  ): Promise<any> {
    return prisma.sync_sessions.create({
      data: {
        offline_node_id: offlineNodeId,
        direction,
        status: 'running', // sync_sessions.status enum: running | completed | failed
        started_at: new Date(),
        summary: {},
        error_message: null,
      },
    });
  }

  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  private async completeSyncSession(
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    prisma: any,
    sessionId: string,
    status: 'completed' | 'failed',
    summary: SyncSummary,
    error?: unknown,
  ): Promise<void> {
    await prisma.sync_sessions.update({
      where: { id: sessionId },
      data: {
        status,
        finished_at: new Date(),
        summary,
        error_message: error ? String((error as Error).message ?? error) : null,
      },
    });
  }

  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  private async applyTaskUploadChanges(
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    prisma: any,
    sessionId: string,
    organizationId: string,
    changes: OfflineTaskChange[],
    summary: SyncSummary,
  ): Promise<void> {
    if (!changes.length) {
      return;
    }

    summary.uploadedTasks += changes.length;

    for (const change of changes) {
      const baseTaskId =
        change.taskId ??
        (change.data.task_id as string | undefined) ??
        (change.data.id as string | undefined);

      switch (change.operation) {
        case 'insert': {
          await prisma.tasks.create({
            data: {
              ...change.data,
              organization_id: organizationId,
            },
          });
          summary.createdTasks += 1;
          break;
        }

        case 'update': {
          if (!baseTaskId) {
            this.logger.warn(
              'Skipping offline update without taskId or data.id',
            );
            continue;
          }

          const serverRow = await prisma.tasks.findUnique({
            where: { id: baseTaskId },
          });

          if (!serverRow) {
            // If server no longer has the row, treat as create.
            await prisma.tasks.create({
              data: {
                ...change.data,
                organization_id: organizationId,
              },
            });
            summary.createdTasks += 1;
            break;
          }

          if (this.hasVersionConflict(serverRow, change.serverVersion)) {
            await this.recordConflict(
              prisma,
              sessionId,
              'task',
              baseTaskId,
              serverRow,
              change.data,
            );
            summary.conflicts += 1;
            break;
          }

          await prisma.tasks.update({
            where: { id: baseTaskId },
            data: change.data,
          });
          summary.updatedTasks += 1;
          break;
        }

        case 'delete': {
          if (!baseTaskId) {
            this.logger.warn(
              'Skipping offline delete without taskId or data.id',
            );
            continue;
          }

          const serverRow = await prisma.tasks.findUnique({
            where: { id: baseTaskId },
          });

          if (!serverRow) {
            // Already deleted on the server; nothing to do.
            break;
          }

          if (this.hasVersionConflict(serverRow, change.serverVersion)) {
            await this.recordConflict(
              prisma,
              sessionId,
              'task',
              baseTaskId,
              serverRow,
              change.data,
            );
            summary.conflicts += 1;
            break;
          }

          // Map delete to a canonical CANCELLED transition; we do not hard‑delete
          // tasks because they are part of the audit trail.
          await prisma.tasks.update({
            where: { id: baseTaskId },
            data: {
              status: 'CANCELLED',
              closed_at: new Date(),
            },
          });
          summary.deletedTasks += 1;
          break;
        }

        default: {
          this.logger.warn(
            `Unknown offline task operation: ${(change as any).operation}`,
          );
          break;
        }
      }
    }
  }

  /**
   * Returns true if there is a conflict between the current server row and the
   * version the client claims to have seen.
   *
   * Conflict heuristic:
   *  - If client provided serverVersion.updated_at and it differs from the
   *    current server updated_at, treat as conflict.
   *  - If no version information is provided, no conflict is detected.
   */
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  private hasVersionConflict(
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    serverRow: any,
    clientServerVersion?: Record<string, any> | null,
  ): boolean {
    if (!clientServerVersion) {
      return false;
    }

    const serverUpdatedAt =
      serverRow.updated_at ?? serverRow.updatedAt ?? serverRow.updated_at_utc;
    const clientUpdatedAt =
      clientServerVersion.updated_at ??
      clientServerVersion.updatedAt ??
      clientServerVersion.updated_at_utc;

    if (!serverUpdatedAt || !clientUpdatedAt) {
      return false;
    }

    const serverTime = new Date(serverUpdatedAt).getTime();
    const clientTime = new Date(clientUpdatedAt).getTime();

    return serverTime !== clientTime;
  }

  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  private async recordConflict(
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    prisma: any,
    sessionId: string,
    entityType: string,
    entityId: string,
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    serverVersion: any,
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    clientVersion: any,
  ): Promise<void> {
    await prisma.sync_conflicts.create({
      data: {
        sync_session_id: sessionId,
        entity_type: entityType,
        entity_id: entityId,
        server_version: serverVersion,
        client_version: clientVersion,
        resolution_strategy: 'manual_review',
        resolved: false,
        resolved_at: null,
        resolved_by_user_id: null,
      },
    });

    this.logger.warn(
      `Recorded sync conflict for entity_type=${entityType} entity_id=${entityId} session_id=${sessionId}`,
    );
  }

  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  private async buildDownloadSnapshot(
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    prisma: any,
    organizationId: string,
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    offlineNode: any,
    clientLastSyncAt: string | null | undefined,
    summary: SyncSummary,
  ): Promise<DownloadSnapshot> {
    const lastSync =
      clientLastSyncAt ??
      (offlineNode.last_sync_at
        ? new Date(offlineNode.last_sync_at).toISOString()
        : null);

    const lastSyncDate = lastSync ? new Date(lastSync) : new Date(0);

    const tasks = await prisma.tasks.findMany({
      where: {
        organization_id: organizationId,
        updated_at: {
          gt: lastSyncDate,
        },
      },
    });

    summary.downloadedTasks = tasks.length;

    return { tasks };
  }
}

===== END apps/api/src/orgo/core/offline/sync.service.ts =====


===== BEGIN apps/api/src/orgo/core/signals/dto/create-signal.dto.ts =====
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';
import {
  IsUUID,
  IsString,
  IsOptional,
  IsNotEmpty,
  IsIn,
  IsObject,
} from 'class-validator';
import { Transform } from 'class-transformer';

export const TASK_CATEGORY_VALUES = [
  'request',
  'incident',
  'update',
  'report',
  'distribution',
] as const;

export type TaskCategory = (typeof TASK_CATEGORY_VALUES)[number];

export const TASK_PRIORITY_VALUES = ['LOW', 'MEDIUM', 'HIGH', 'CRITICAL'] as const;
export type TaskPriority = (typeof TASK_PRIORITY_VALUES)[number];

export const TASK_SEVERITY_VALUES = ['MINOR', 'MODERATE', 'MAJOR', 'CRITICAL'] as const;
export type TaskSeverity = (typeof TASK_SEVERITY_VALUES)[number];

export const VISIBILITY_VALUES = [
  'PUBLIC',
  'INTERNAL',
  'RESTRICTED',
  'ANONYMISED',
] as const;
export type Visibility = (typeof VISIBILITY_VALUES)[number];

export const TASK_SOURCE_VALUES = ['email', 'api', 'manual', 'sync'] as const;
export type TaskSource = (typeof TASK_SOURCE_VALUES)[number];

/**
 * DTO for ingesting a generic Signal via API / UI / webhooks.
 *
 * The goal is to capture enough structured information for the workflow engine
 * to decide whether to open a Case, create Task(s), or both.
 *
 * Many fields are optional hints; profiles + workflows can override them.
 */
export class CreateSignalDto {
  @ApiProperty({
    description: 'Organization this signal belongs to (tenant ID).',
    format: 'uuid',
  })
  @IsUUID('4')
  organizationId!: string;

  @ApiPropertyOptional({
    description:
      'Optional idempotency key or external correlation id from the source system.',
    example: 'ext-incident-12345',
  })
  @IsOptional()
  @IsString()
  externalId?: string;

  @ApiPropertyOptional({
    description:
      'Optional existing Case to attach this signal to (otherwise workflows may open a new Case).',
    format: 'uuid',
  })
  @IsOptional()
  @IsUUID('4')
  caseId?: string;

  @ApiProperty({
    description: 'Origin of this signal, reusing the task source enumeration.',
    enum: TASK_SOURCE_VALUES,
    example: 'api',
  })
  @IsString()
  @IsIn(TASK_SOURCE_VALUES)
  @Transform(({ value }) =>
    typeof value === 'string' ? value.toLowerCase() : value,
  )
  source!: TaskSource;

  @ApiProperty({
    description: 'Short human-readable summary for this signal.',
    example: 'Student slipped on wet floor in main lobby',
  })
  @IsString()
  @IsNotEmpty()
  title!: string;

  @ApiProperty({
    description: 'Free-text body or description of the signal.',
    example:
      'A student slipped on a wet floor near the main entrance. No visible injuries, but this has happened several times this month.',
  })
  @IsString()
  @IsNotEmpty()
  description!: string;

  @ApiPropertyOptional({
    description:
      'Domain type hint; should match Task.type / domain module name (e.g. "maintenance", "hr_case").',
    example: 'maintenance',
  })
  @IsOptional()
  @IsString()
  type?: string;

  @ApiPropertyOptional({
    description:
      'Optional Task.category hint. If omitted, workflows will derive it.',
    enum: TASK_CATEGORY_VALUES,
    example: 'incident',
  })
  @IsOptional()
  @IsString()
  @IsIn(TASK_CATEGORY_VALUES)
  @Transform(({ value }) =>
    typeof value === 'string' ? value.toLowerCase() : value,
  )
  category?: TaskCategory;

  @ApiPropertyOptional({
    description:
      'Domain-specific subtype hint; must be valid for the chosen domain module (e.g. "ticket", "harassment").',
    example: 'ticket',
  })
  @IsOptional()
  @IsString()
  subtype?: string;

  @ApiPropertyOptional({
    description:
      'Optional canonical label hint ("<base>.<category><subcategory>.<horizontal_role>").',
    example: '100.94.Operations.Safety',
  })
  @IsOptional()
  @IsString()
  label?: string;

  @ApiPropertyOptional({
    description:
      'Optional priority hint; defaults are derived from org profile and workflows.',
    enum: TASK_PRIORITY_VALUES,
    example: 'HIGH',
  })
  @IsOptional()
  @IsString()
  @IsIn(TASK_PRIORITY_VALUES)
  @Transform(({ value }) =>
    typeof value === 'string' ? value.toUpperCase() : value,
  )
  priority?: TaskPriority;

  @ApiPropertyOptional({
    description:
      'Optional severity hint; defaults are derived from org profile and workflows.',
    enum: TASK_SEVERITY_VALUES,
    example: 'MAJOR',
  })
  @IsOptional()
  @IsString()
  @IsIn(TASK_SEVERITY_VALUES)
  @Transform(({ value }) =>
    typeof value === 'string' ? value.toUpperCase() : value,
  )
  severity?: TaskSeverity;

  @ApiPropertyOptional({
    description:
      'Optional visibility hint for any Task/Case created from this signal. Guardrails may override this.',
    enum: VISIBILITY_VALUES,
    example: 'INTERNAL',
  })
  @IsOptional()
  @IsString()
  @IsIn(VISIBILITY_VALUES)
  @Transform(({ value }) =>
    typeof value === 'string' ? value.toUpperCase() : value,
  )
  visibility?: Visibility;

  @ApiPropertyOptional({
    description:
      'If set, the Person profile this signal is primarily about (subject of the Case/Task).',
    format: 'uuid',
  })
  @IsOptional()
  @IsUUID('4')
  requesterPersonId?: string;

  @ApiPropertyOptional({
    description:
      'If set, the Orgo user who submitted this signal (mapped to created_by_user_id on Tasks).',
    format: 'uuid',
  })
  @IsOptional()
  @IsUUID('4')
  createdByUserId?: string;

  @ApiPropertyOptional({
    description:
      'Optional external reference or URL related to the signal (ticket id, form submission id, etc.).',
    example: 'JIRA-1234',
  })
  @IsOptional()
  @IsString()
  sourceReference?: string;

  @ApiPropertyOptional({
    description:
      'Arbitrary structured payload for domain-specific context (location, group ids, tags, raw form data, etc.). Must not duplicate canonical Task fields.',
    type: Object,
  })
  @IsOptional()
  @IsObject()
  metadata?: Record<string, any>;
}

===== END apps/api/src/orgo/core/signals/dto/create-signal.dto.ts =====


===== BEGIN apps/api/src/orgo/core/signals/signal-ingest.service.ts =====

===== END apps/api/src/orgo/core/signals/signal-ingest.service.ts =====


===== BEGIN apps/api/src/orgo/core/signals/signal.controller.ts =====
import {
  Body,
  Controller,
  HttpCode,
  HttpStatus,
  Post,
} from '@nestjs/common';
import { IsEnum, IsNotEmpty, IsObject, IsOptional, IsString, IsUUID } from 'class-validator';
import { SignalIngestService } from './signal-ingest.service';

/**
 * Canonical signal source values, aligned with task_source_enum:
 * 'email' | 'api' | 'manual' | 'sync'.
 */
export enum SignalSource {
  EMAIL = 'email',
  API = 'api',
  MANUAL = 'manual',
  SYNC = 'sync',
}

/**
 * DTO for ingesting a generic "signal" into Orgo.
 *
 * A signal is a normalized input that Core Services can route into
 * Tasks and/or Cases via the workflow engine. It is intentionally
 * flexible while still enforcing core invariants:
 *
 * - organization_id is always required (multi‑tenant key).
 * - source maps to the canonical task_source_enum.
 * - type may hint at the target Task.type (maintenance, hr_case, etc.).
 * - title/description are optional summaries for human‑readable context.
 * - label can carry a canonical information label if already known.
 * - created_by_user_id / requester_person_id link the signal to actors.
 * - payload carries any additional, domain‑specific JSON.
 */
export class CreateSignalDto {
  @IsUUID()
  organization_id!: string;

  @IsEnum(SignalSource)
  source!: SignalSource;

  /**
   * Optional domain type hint, e.g. "maintenance", "hr_case",
   * "education_support", "generic". This is expected to map to Task.type.
   */
  @IsString()
  @IsOptional()
  type?: string;

  @IsString()
  @IsOptional()
  @IsNotEmpty()
  title?: string;

  @IsString()
  @IsOptional()
  @IsNotEmpty()
  description?: string;

  /**
   * Optional canonical information label:
   * "<BASE>.<CATEGORY><SUBCATEGORY>.<HORIZONTAL_ROLE>"
   * (see Doc 2/8 label semantics).
   */
  @IsString()
  @IsOptional()
  label?: string;

  /**
   * Optional linkage to the Orgo user that is submitting the signal.
   * In many deployments this will be derived from auth context instead
   * of being sent explicitly; this field exists for explicit overrides
   * and non‑user API clients.
   */
  @IsUUID()
  @IsOptional()
  created_by_user_id?: string;

  /**
   * Optional linkage to the Person the signal is about (student, employee,
   * player, community member, etc.).
   */
  @IsUUID()
  @IsOptional()
  requester_person_id?: string;

  /**
   * Optional arbitrary JSON payload carrying domain‑specific content
   * (form fields, structured metadata, attachments references, etc.).
   * Core Services and domain handlers are responsible for interpreting
   * this payload and mapping it into Task/Case metadata.
   */
  @IsObject()
  @IsOptional()
  payload?: Record<string, unknown>;
}

/**
 * SignalController
 *
 * HTTP entrypoint for ingesting generic signals (non‑email) into Orgo.
 * Typical route: POST /api/v3/signals
 *
 * This controller is intentionally thin: it validates the incoming DTO
 * and delegates to SignalIngestService.ingest, which implements the
 * standard result shape { ok, data, error } and is responsible for
 * mapping the signal into Tasks/Cases via the workflow engine.
 */
@Controller('signals')
export class SignalController {
  constructor(private readonly signalIngestService: SignalIngestService) {}

  /**
   * Ingest a new signal.
   *
   * The service is expected to:
   * - normalise the signal into the internal representation,
   * - invoke the workflow engine,
   * - create any resulting Tasks/Cases,
   * - and return a standard result shape.
   */
  @Post()
  @HttpCode(HttpStatus.OK)
  async createSignal(@Body() dto: CreateSignalDto): Promise<any> {
    return this.signalIngestService.ingest(dto);
  }
}

===== END apps/api/src/orgo/core/signals/signal.controller.ts =====


===== BEGIN apps/api/src/orgo/core/signals/signals.module.ts =====
import { Module } from '@nestjs/common';
import { SignalController } from './signal.controller';
import { SignalIngestService } from './signal-ingest.service';

/**
 * Core API / Signals module.
 *
 * Exposes SignalIngestService.ingest via SignalController.createSignal to
 * normalize non-email signals (REST, UI forms, webhooks) into a common
 * signal shape that downstream workflows can turn into Cases/Tasks.
 */
@Module({
  imports: [],
  controllers: [SignalController],
  providers: [SignalIngestService],
  exports: [SignalIngestService],
})
export class SignalsModule {}

===== END apps/api/src/orgo/core/signals/signals.module.ts =====


===== BEGIN apps/api/src/orgo/core/tasks/dto/create-task.dto.ts =====
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';
import {
  IsUUID,
  IsString,
  IsNotEmpty,
  IsEnum,
  IsOptional,
  MaxLength,
  IsDateString,
  IsObject,
} from 'class-validator';

/**
 * JSON-level enums for Task fields.
 * These reflect the canonical API representations (lower-case),
 * which are mapped to DB enums in the service layer.
 */

export enum TaskCategory {
  REQUEST = 'request',
  INCIDENT = 'incident',
  UPDATE = 'update',
  REPORT = 'report',
  DISTRIBUTION = 'distribution',
}

export enum TaskPriority {
  LOW = 'low',
  MEDIUM = 'medium',
  HIGH = 'high',
  CRITICAL = 'critical',
}

export enum TaskSeverity {
  MINOR = 'minor',
  MODERATE = 'moderate',
  MAJOR = 'major',
  CRITICAL = 'critical',
}

export enum TaskVisibility {
  PUBLIC = 'public',
  INTERNAL = 'internal',
  RESTRICTED = 'restricted',
  ANONYMISED = 'anonymised', // always with an "s"
}

export enum TaskSource {
  EMAIL = 'email',
  API = 'api',
  MANUAL = 'manual',
  SYNC = 'sync',
}

/**
 * DTO for creating a Task.
 *
 * This models the canonical create_task payload:
 * - Includes all writable, non-derived fields.
 * - Excludes DB-/service-owned fields such as:
 *   task_id, status, reactivity_time, reactivity_deadline_at,
 *   escalation_level, created_at, updated_at, closed_at.
 */
export class CreateTaskDto {
  @ApiProperty({
    description: 'Tenant / organization identifier (UUID).',
    format: 'uuid',
  })
  @IsUUID()
  @IsNotEmpty()
  organization_id!: string;

  @ApiProperty({
    description:
      'Domain-level task type (e.g. "maintenance", "hr_case", "education_support", "generic").',
    example: 'maintenance',
  })
  @IsString()
  @IsNotEmpty()
  type!: string;

  @ApiProperty({
    description:
      'Global task category. Must match the canonical category enum.',
    enum: TaskCategory,
    example: TaskCategory.REQUEST,
  })
  @IsEnum(TaskCategory)
  category!: TaskCategory;

  @ApiProperty({
    description: 'Canonical information label code.',
    example: '100.94.Operations.Safety',
  })
  @IsString()
  @IsNotEmpty()
  label!: string;

  @ApiProperty({
    description: 'Short human-readable title of the task.',
    maxLength: 512,
  })
  @IsString()
  @IsNotEmpty()
  @MaxLength(512)
  title!: string;

  @ApiProperty({
    description: 'Detailed description / body of the task.',
  })
  @IsString()
  @IsNotEmpty()
  description!: string;

  @ApiProperty({
    description:
      'Priority of the task. JSON uses lower-case values mapping to DB enum.',
    enum: TaskPriority,
    example: TaskPriority.MEDIUM,
  })
  @IsEnum(TaskPriority)
  priority!: TaskPriority;

  @ApiProperty({
    description:
      'Severity of the task. JSON uses lower-case values mapping to DB enum.',
    enum: TaskSeverity,
    example: TaskSeverity.MINOR,
  })
  @IsEnum(TaskSeverity)
  severity!: TaskSeverity;

  @ApiProperty({
    description:
      'Visibility of the task. Controls who can see it within the organization.',
    enum: TaskVisibility,
    example: TaskVisibility.INTERNAL,
  })
  @IsEnum(TaskVisibility)
  visibility!: TaskVisibility;

  @ApiProperty({
    description:
      'Source through which the task entered the system (email, api, manual, sync).',
    enum: TaskSource,
    example: TaskSource.API,
  })
  @IsEnum(TaskSource)
  source!: TaskSource;

  @ApiProperty({
    description:
      'Domain-specific metadata. Must not duplicate core fields (type, category, severity, etc.).',
    type: 'object',
    additionalProperties: true,
    example: { asset_id: 'ASSET-123', location: 'Building A' },
  })
  @IsObject()
  metadata!: Record<string, unknown>;

  // -------------------------
  // Optional linkage fields
  // -------------------------

  @ApiPropertyOptional({
    description: 'Optional Case this Task belongs to (UUID).',
    format: 'uuid',
    nullable: true,
  })
  @IsOptional()
  @IsUUID()
  case_id?: string | null;

  @ApiPropertyOptional({
    description:
      'Domain-specific subtype (e.g. "plumbing", "harassment", "attendance").',
    nullable: true,
    example: 'plumbing',
  })
  @IsOptional()
  @IsString()
  subtype?: string | null;

  // -------------------------
  // Optional ownership fields
  // -------------------------

  @ApiPropertyOptional({
    description: 'User that created the task (UUID).',
    format: 'uuid',
    nullable: true,
  })
  @IsOptional()
  @IsUUID()
  created_by_user_id?: string | null;

  @ApiPropertyOptional({
    description: 'Person the work is for (UUID).',
    format: 'uuid',
    nullable: true,
  })
  @IsOptional()
  @IsUUID()
  requester_person_id?: string | null;

  @ApiPropertyOptional({
    description: 'Primary owning role (UUID).',
    format: 'uuid',
    nullable: true,
  })
  @IsOptional()
  @IsUUID()
  owner_role_id?: string | null;

  @ApiPropertyOptional({
    description: 'Primary owning user (UUID).',
    format: 'uuid',
    nullable: true,
  })
  @IsOptional()
  @IsUUID()
  owner_user_id?: string | null;

  @ApiPropertyOptional({
    description:
      'Denormalised routing role label, aligned with label system (e.g. "Ops.Maintenance").',
    nullable: true,
    example: 'Ops.Maintenance',
  })
  @IsOptional()
  @IsString()
  assignee_role?: string | null;

  // -------------------------
  // Optional scheduling fields
  // -------------------------

  @ApiPropertyOptional({
    description: 'Optional due date/time for the task (ISO 8601).',
    format: 'date-time',
    nullable: true,
  })
  @IsOptional()
  @IsDateString()
  due_at?: string | null;
}

===== END apps/api/src/orgo/core/tasks/dto/create-task.dto.ts =====


===== BEGIN apps/api/src/orgo/core/tasks/dto/update-task-status.dto.ts =====
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';
import {
  IsIn,
  IsNotEmpty,
  IsOptional,
  IsString,
  MaxLength,
} from 'class-validator';
import { Transform } from 'class-transformer';

/**
 * Canonical TASK_STATUS values (Doc 2 / Doc 5 / Doc 8).
 */
export const TASK_STATUS_VALUES = [
  'PENDING',
  'IN_PROGRESS',
  'ON_HOLD',
  'COMPLETED',
  'FAILED',
  'ESCALATED',
  'CANCELLED',
] as const;

export type TaskStatus = (typeof TASK_STATUS_VALUES)[number];

export class UpdateTaskStatusDto {
  @ApiProperty({
    description:
      'New status for the task. Uses the canonical TASK_STATUS enum; lower-case forms will be normalised.',
    enum: TASK_STATUS_VALUES,
    example: 'IN_PROGRESS',
  })
  @Transform(({ value }) =>
    typeof value === 'string' ? value.trim().toUpperCase() : value,
  )
  @IsString()
  @IsNotEmpty()
  @IsIn(TASK_STATUS_VALUES)
  status!: TaskStatus;

  @ApiPropertyOptional({
    description:
      'Optional human-readable reason explaining the status change; used for audit/task events.',
    maxLength: 2048,
    example: 'Work completed and verified on site.',
  })
  @IsOptional()
  @IsString()
  @MaxLength(2048)
  reason?: string;
}

===== END apps/api/src/orgo/core/tasks/dto/update-task-status.dto.ts =====


===== BEGIN apps/api/src/orgo/core/tasks/task-events.gateway.ts =====
import {
  ConnectedSocket,
  MessageBody,
  OnGatewayConnection,
  OnGatewayDisconnect,
  OnGatewayInit,
  SubscribeMessage,
  WebSocketGateway,
  WebSocketServer,
} from '@nestjs/websockets';
import { Logger } from '@nestjs/common';
import { Server, Socket } from 'socket.io';

/**
 * Canonical Task enums (aligned with Orgo v3 specs).
 */
export type TaskStatus =
  | 'PENDING'
  | 'IN_PROGRESS'
  | 'ON_HOLD'
  | 'COMPLETED'
  | 'FAILED'
  | 'ESCALATED'
  | 'CANCELLED';

export type TaskPriority = 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';

export type TaskSeverity = 'MINOR' | 'MODERATE' | 'MAJOR' | 'CRITICAL';

export type TaskVisibility = 'PUBLIC' | 'INTERNAL' | 'RESTRICTED' | 'ANONYMISED';

/**
 * Canonical Task JSON snapshot used in task events.
 * Field names match the Task JSON contract (API boundary) rather than DB column names.
 */
export interface TaskJsonSnapshot {
  task_id: string;
  organization_id: string;
  case_id?: string | null;

  source: 'email' | 'api' | 'manual' | 'sync';

  type: string;
  category: 'request' | 'incident' | 'update' | 'report' | 'distribution';
  subtype?: string | null;

  label: string;
  title: string;
  description: string;

  status: TaskStatus;
  priority: TaskPriority;
  severity: TaskSeverity;
  visibility: TaskVisibility;

  assignee_role?: string | null;
  created_by_user_id?: string | null;
  requester_person_id?: string | null;
  owner_role_id?: string | null;
  owner_user_id?: string | null;

  due_at?: string | null;
  reactivity_time?: string | null;
  reactivity_deadline_at?: string | null;
  escalation_level: number;
  closed_at?: string | null;

  metadata?: Record<string, unknown>;

  created_at: string;
  updated_at: string;
}

/**
 * Event types sent over the task event stream.
 */
export type TaskEventType =
  | 'TASK_CREATED'
  | 'TASK_UPDATED'
  | 'TASK_STATUS_CHANGED'
  | 'TASK_ESCALATED'
  | 'TASK_COMMENT_ADDED';

/**
 * Payload for a single task event delivered over WebSocket.
 *
 * Notes:
 * - `task` is a canonical Task JSON snapshot.
 * - `visibility` is duplicated from `task.visibility` for quick filtering.
 * - For RESTRICTED/ANONYMISED tasks, `recipient_user_ids` should be set so
 *   the gateway can restrict delivery to specific users.
 */
export interface TaskEventPayload {
  event_id: string;
  event_type: TaskEventType;
  organization_id: string;
  task_id: string;
  task: TaskJsonSnapshot;

  visibility: TaskVisibility;

  actor_user_id?: string | null;
  occurred_at: string; // ISO-8601 string (UTC)

  /**
   * Optional list of user IDs that are explicitly allowed to receive this event.
   * Used for RESTRICTED / ANONYMISED visibility.
   */
  recipient_user_ids?: string[];

  /**
   * Optional additional metadata about the event (non-PII).
   */
  meta?: Record<string, unknown>;
}

/**
 * Message name used by the gateway when pushing task events to clients.
 * Clients should subscribe to this message name.
 */
export const TASK_EVENTS_MESSAGE = 'task.events';

/**
 * Internal structure used for tracking a connected client.
 */
interface ConnectedClientInfo {
  organizationId: string;
  userId?: string;
}

/**
 * WebSocket gateway for streaming live Task events to web clients.
 *
 * Namespace:
 *   - `/task-events`
 *
 * Connection:
 *   - Clients SHOULD pass `organizationId` and (optionally) `userId` as query
 *     parameters in the WebSocket handshake:
 *
 *       io('/task-events', {
 *         query: { organizationId, userId },
 *       });
 *
 *   - `organizationId` is required; connections without it are rejected.
 *
 * Delivery rules:
 *   - PUBLIC / INTERNAL tasks → delivered to all clients in the organization room.
 *   - RESTRICTED / ANONYMISED tasks → delivered only to `recipient_user_ids`
 *     if provided; otherwise dropped (to avoid accidental leakage).
 */
@WebSocketGateway({
  namespace: '/task-events',
  cors: {
    origin: true,
    credentials: true,
  },
})
export class TaskEventsGateway
  implements OnGatewayInit, OnGatewayConnection, OnGatewayDisconnect
{
  @WebSocketServer()
  public server!: Server;

  private readonly logger = new Logger(TaskEventsGateway.name);

  /**
   * Map of socket.id → ConnectedClientInfo.
   */
  private readonly clients = new Map<string, ConnectedClientInfo>();

  /**
   * Reverse index of user_id → Set<socket.id>.
   * Used to target RESTRICTED / ANONYMISED events to specific users.
   */
  private readonly userIndex = new Map<string, Set<string>>();

  afterInit(): void {
    this.logger.log('TaskEventsGateway initialized');
  }

  async handleConnection(client: Socket): Promise<void> {
    const organizationId =
      this.extractString(client.handshake.query.organizationId) ??
      this.extractString(client.handshake.query.organization_id);

    const userId =
      this.extractString(client.handshake.query.userId) ??
      this.extractString(client.handshake.query.user_id);

    if (!organizationId) {
      this.logger.warn(
        `Rejecting connection ${client.id}: missing organizationId in handshake query`,
      );
      client.disconnect(true);
      return;
    }

    this.registerClient(client, {
      organizationId,
      userId,
    });

    this.logger.debug(
      `Client ${client.id} connected for org ${organizationId}` +
        (userId ? ` (user ${userId})` : ''),
    );
  }

  async handleDisconnect(client: Socket): Promise<void> {
    this.unregisterClient(client.id);
  }

  /**
   * Optional explicit identify message. This can be used to update the
   * organization/user binding after the initial handshake, for example
   * after a token-based authentication flow.
   *
   * Payload:
   *   { organizationId: string; userId?: string }
   */
  @SubscribeMessage('identify')
  handleIdentify(
    @MessageBody()
    data: { organizationId?: string; userId?: string },
    @ConnectedSocket() client: Socket,
  ): void {
    const current = this.clients.get(client.id);

    const organizationId = data.organizationId ?? current?.organizationId;
    const userId = data.userId ?? current?.userId;

    if (!organizationId) {
      this.logger.warn(
        `identify message from ${client.id} missing organizationId; ignoring`,
      );
      return;
    }

    this.registerClient(client, { organizationId, userId });

    this.logger.debug(
      `Client ${client.id} identified for org ${organizationId}` +
        (userId ? ` (user ${userId})` : ''),
    );
  }

  /**
   * Optional ping/pong to keep connections alive and for simple diagnostics.
   */
  @SubscribeMessage('ping')
  handlePing(@ConnectedSocket() client: Socket): { type: 'pong' } {
    this.logger.debug(`Received ping from ${client.id}`);
    return { type: 'pong' };
  }

  /**
   * Broadcast a Task event to the appropriate set of clients.
   *
   * This method is intended to be called from TaskService / domain services
   * whenever a relevant Task lifecycle event occurs.
   */
  public broadcastTaskEvent(event: TaskEventPayload): void {
    const {
      organization_id: organizationId,
      visibility,
      recipient_user_ids: recipientUserIds,
      event_type: eventType,
      task_id: taskId,
    } = event;

    if (!organizationId) {
      this.logger.warn(
        `Dropping task event without organization_id (task_id=${taskId}, type=${eventType})`,
      );
      return;
    }

    if (visibility === 'RESTRICTED' || visibility === 'ANONYMISED') {
      if (!recipientUserIds || recipientUserIds.length === 0) {
        this.logger.warn(
          `Dropping ${visibility} task event with no recipient_user_ids (task_id=${taskId}, type=${eventType})`,
        );
        return;
      }

      for (const userId of recipientUserIds) {
        this.emitToUser(userId, event);
      }

      return;
    }

    // PUBLIC / INTERNAL – broadcast to all clients in the organization room.
    const roomName = this.getOrganizationRoom(organizationId);
    this.server.to(roomName).emit(TASK_EVENTS_MESSAGE, event);
  }

  /**
   * Register or update a connected client and place it in the appropriate
   * organization room and user index.
   */
  private registerClient(client: Socket, info: ConnectedClientInfo): void {
    // Remove any previous registration first.
    this.unregisterClient(client.id);

    this.clients.set(client.id, info);

    // Join per-organization room.
    const roomName = this.getOrganizationRoom(info.organizationId);
    client.join(roomName);

    // Index by user, if available.
    if (info.userId) {
      let sockets = this.userIndex.get(info.userId);
      if (!sockets) {
        sockets = new Set<string>();
        this.userIndex.set(info.userId, sockets);
      }
      sockets.add(client.id);
    }
  }

  /**
   * Remove a client from all tracking structures.
   */
  private unregisterClient(clientId: string): void {
    const info = this.clients.get(clientId);
    if (!info) {
      return;
    }

    this.clients.delete(clientId);

    if (info.userId) {
      const sockets = this.userIndex.get(info.userId);
      if (sockets) {
        sockets.delete(clientId);
        if (sockets.size === 0) {
          this.userIndex.delete(info.userId);
        }
      }
    }

    this.logger.debug(
      `Client ${clientId} disconnected from org ${info.organizationId}` +
        (info.userId ? ` (user ${info.userId})` : ''),
    );
  }

  /**
   * Emit an event to all sockets associated with a given user ID.
   */
  private emitToUser(userId: string, event: TaskEventPayload): void {
    const sockets = this.userIndex.get(userId);
    if (!sockets || sockets.size === 0) {
      this.logger.debug(
        `No active sockets for user ${userId}; task event not delivered`,
      );
      return;
    }

    for (const socketId of sockets) {
      this.server.to(socketId).emit(TASK_EVENTS_MESSAGE, event);
    }
  }

  /**
   * Derive the room name for a given organization.
   */
  private getOrganizationRoom(organizationId: string): string {
    return `org:${organizationId}`;
  }

  /**
   * Helper to normalize a value from the WebSocket handshake query into a string.
   */
  private extractString(value: unknown): string | undefined {
    if (typeof value === 'string' && value.trim().length > 0) {
      return value.trim();
    }

    if (Array.isArray(value)) {
      const first = value[0];
      if (typeof first === 'string' && first.trim().length > 0) {
        return first.trim();
      }
    }

    return undefined;
  }
}

===== END apps/api/src/orgo/core/tasks/task-events.gateway.ts =====


===== BEGIN apps/api/src/orgo/core/tasks/task-events.service.ts =====
// apps/api/src/orgo/core/tasks/task-events.service.ts

import { Injectable } from '@nestjs/common';
import { Observable, Subject } from 'rxjs';
import { Prisma, TaskEvent as TaskEventModel } from '@prisma/client';

import { DatabaseService } from '../database/database.service';
import { LogService } from '../logging/log.service';

export type TaskEventType =
  | 'created'
  | 'status_changed'
  | 'priority_changed'
  | 'ownership_changed'
  | 'comment_added'
  | 'email_linked'
  | 'escalated'
  | 'deadline_updated'
  | 'metadata_updated';

export type TaskEventOrigin = 'ui' | 'api' | 'email' | 'system_rule';

export interface StandardResultError {
  code: string;
  message: string;
  details?: Record<string, unknown>;
}

export interface StandardResult<T> {
  ok: boolean;
  data: T | null;
  error: StandardResultError | null;
}

export interface TaskEventPayload {
  taskId: string;
  organizationId: string;
  eventType: TaskEventType;
  origin: TaskEventOrigin;
  oldValue?: Prisma.JsonValue | null;
  newValue?: Prisma.JsonValue | null;
  actorUserId?: string | null;
  actorRoleId?: string | null;
}

/**
 * Shape of messages pushed to the live event stream (for WebSocket gateway).
 * This is intentionally compact and UI‑oriented.
 */
export interface TaskEventStreamMessage {
  eventId: string;
  taskId: string;
  organizationId: string;
  eventType: TaskEventType;
  origin: TaskEventOrigin;
  oldValue: Prisma.JsonValue | null;
  newValue: Prisma.JsonValue | null;
  actorUserId: string | null;
  actorRoleId: string | null;
  createdAt: Date;
}

/**
 * TaskEventsService
 *
 * Responsibilities:
 * - Append append‑only rows into task_events.
 * - Provide convenience helpers for common event types.
 * - Expose an RxJS stream used by TaskEventsGateway for live updates.
 * - Emit structured log entries via LogService.
 */
@Injectable()
export class TaskEventsService {
  private readonly eventsSubject = new Subject<TaskEventStreamMessage>();

  constructor(
    private readonly database: DatabaseService,
    private readonly logService: LogService,
  ) {}

  /**
   * Observable stream of task events for WebSocket gateway or other subscribers.
   */
  get events$(): Observable<TaskEventStreamMessage> {
    return this.eventsSubject.asObservable();
  }

  /**
   * Low‑level primitive to append a TaskEvent row.
   * All convenience helpers delegate to this.
   */
  async appendEvent(
    payload: TaskEventPayload,
  ): Promise<StandardResult<TaskEventModel>> {
    const { taskId, organizationId, eventType, origin } = payload;

    if (!taskId || !organizationId || !eventType || !origin) {
      return {
        ok: false,
        data: null,
        error: {
          code: 'TASK_EVENT_VALIDATION_ERROR',
          message:
            'taskId, organizationId, eventType and origin are required to append a task event.',
          details: { taskId, organizationId, eventType, origin },
        },
      };
    }

    try {
      const prisma = this.database.getPrismaClient();

      const created = await prisma.taskEvent.create({
        data: {
          taskId,
          organizationId,
          eventType,
          origin,
          oldValue:
            typeof payload.oldValue === 'undefined' ? null : payload.oldValue,
          newValue:
            typeof payload.newValue === 'undefined' ? null : payload.newValue,
          actorUserId:
            typeof payload.actorUserId === 'undefined'
              ? null
              : payload.actorUserId,
          actorRoleId:
            typeof payload.actorRoleId === 'undefined'
              ? null
              : payload.actorRoleId,
          // createdAt is assumed to be defaulted by the DB.
        },
      });

      const streamMessage: TaskEventStreamMessage = {
        eventId: created.id,
        taskId: created.taskId,
        organizationId: created.organizationId,
        eventType: created.eventType as TaskEventType,
        origin: created.origin as TaskEventOrigin,
        oldValue: created.oldValue,
        newValue: created.newValue,
        actorUserId: created.actorUserId,
        actorRoleId: created.actorRoleId,
        createdAt: created.createdAt,
      };

      this.eventsSubject.next(streamMessage);

      this.logService.logEvent({
        category: 'TASK',
        logLevel: 'INFO',
        message: `Task event recorded: ${created.eventType}`,
        identifier: `task_id:${created.taskId}`,
        metadata: {
          organizationId: created.organizationId,
          eventType: created.eventType,
          origin: created.origin,
          eventId: created.id,
        },
      });

      return {
        ok: true,
        data: created,
        error: null,
      };
    } catch (err) {
      this.logService.logEvent({
        category: 'SYSTEM',
        logLevel: 'ERROR',
        message: 'Failed to append task event',
        identifier: `task_id:${taskId}`,
        metadata: {
          eventType,
          origin,
          error:
            err instanceof Error ? err.message : 'Unknown error in appendEvent',
        },
      });

      return {
        ok: false,
        data: null,
        error: {
          code: 'TASK_EVENT_PERSISTENCE_ERROR',
          message: 'Failed to persist task event.',
          details: {
            taskId,
            organizationId,
            eventType,
            origin,
          },
        },
      };
    }
  }

  /**
   * Fetch full event history for a task, ordered by createdAt ascending.
   */
  async getEventsForTask(
    taskId: string,
    organizationId: string,
  ): Promise<StandardResult<TaskEventModel[]>> {
    if (!taskId || !organizationId) {
      return {
        ok: false,
        data: null,
        error: {
          code: 'TASK_EVENT_VALIDATION_ERROR',
          message: 'taskId and organizationId are required.',
          details: { taskId, organizationId },
        },
      };
    }

    try {
      const prisma = this.database.getPrismaClient();

      const events = await prisma.taskEvent.findMany({
        where: {
          taskId,
          organizationId,
        },
        orderBy: {
          createdAt: 'asc',
        },
      });

      return {
        ok: true,
        data: events,
        error: null,
      };
    } catch (err) {
      this.logService.logEvent({
        category: 'SYSTEM',
        logLevel: 'ERROR',
        message: 'Failed to fetch task events',
        identifier: `task_id:${taskId}`,
        metadata: {
          error:
            err instanceof Error
              ? err.message
              : 'Unknown error in getEventsForTask',
        },
      });

      return {
        ok: false,
        data: null,
        error: {
          code: 'TASK_EVENT_QUERY_ERROR',
          message: 'Failed to fetch task events.',
          details: { taskId, organizationId },
        },
      };
    }
  }

  /**
   * Convenience: record `created` event.
   * Typically called immediately after Task creation.
   */
  async recordTaskCreated(params: {
    taskId: string;
    organizationId: string;
    origin: TaskEventOrigin;
    actorUserId?: string | null;
    actorRoleId?: string | null;
    snapshot?: Prisma.JsonValue; // optional full Task snapshot
  }): Promise<StandardResult<TaskEventModel>> {
    const { snapshot, ...rest } = params;
    return this.appendEvent({
      ...rest,
      eventType: 'created',
      oldValue: null,
      newValue: snapshot ?? null,
    });
  }

  /**
   * Convenience: record `status_changed` event.
   */
  async recordStatusChanged(params: {
    taskId: string;
    organizationId: string;
    origin: TaskEventOrigin;
    previousStatus: string;
    nextStatus: string;
    actorUserId?: string | null;
    actorRoleId?: string | null;
    reason?: string;
  }): Promise<StandardResult<TaskEventModel>> {
    const { previousStatus, nextStatus, reason, ...base } = params;

    return this.appendEvent({
      ...base,
      eventType: 'status_changed',
      oldValue: {
        status: previousStatus,
      },
      newValue: {
        status: nextStatus,
        reason: reason ?? null,
      },
    });
  }

  /**
   * Convenience: record `priority_changed` event.
   */
  async recordPriorityChanged(params: {
    taskId: string;
    organizationId: string;
    origin: TaskEventOrigin;
    previousPriority: string;
    nextPriority: string;
    actorUserId?: string | null;
    actorRoleId?: string | null;
  }): Promise<StandardResult<TaskEventModel>> {
    const { previousPriority, nextPriority, ...base } = params;

    return this.appendEvent({
      ...base,
      eventType: 'priority_changed',
      oldValue: {
        priority: previousPriority,
      },
      newValue: {
        priority: nextPriority,
      },
    });
  }

  /**
   * Convenience: record `ownership_changed` event.
   * Used for assignments / reassignments.
   */
  async recordOwnershipChanged(params: {
    taskId: string;
    organizationId: string;
    origin: TaskEventOrigin;
    previousOwnerRoleId?: string | null;
    previousOwnerUserId?: string | null;
    previousAssigneeRole?: string | null;
    nextOwnerRoleId?: string | null;
    nextOwnerUserId?: string | null;
    nextAssigneeRole?: string | null;
    actorUserId?: string | null;
    actorRoleId?: string | null;
    reason?: string;
  }): Promise<StandardResult<TaskEventModel>> {
    const {
      previousOwnerRoleId,
      previousOwnerUserId,
      previousAssigneeRole,
      nextOwnerRoleId,
      nextOwnerUserId,
      nextAssigneeRole,
      reason,
      ...base
    } = params;

    return this.appendEvent({
      ...base,
      eventType: 'ownership_changed',
      oldValue: {
        owner_role_id: previousOwnerRoleId ?? null,
        owner_user_id: previousOwnerUserId ?? null,
        assignee_role: previousAssigneeRole ?? null,
      },
      newValue: {
        owner_role_id: nextOwnerRoleId ?? null,
        owner_user_id: nextOwnerUserId ?? null,
        assignee_role: nextAssigneeRole ?? null,
        reason: reason ?? null,
      },
    });
  }

  /**
   * Convenience: record `comment_added` event.
   * Comment body itself lives in task_comments; this logs metadata.
   */
  async recordCommentAdded(params: {
    taskId: string;
    organizationId: string;
    origin: TaskEventOrigin;
    commentId: string;
    visibility: string;
    actorUserId?: string | null;
    actorRoleId?: string | null;
  }): Promise<StandardResult<TaskEventModel>> {
    const { commentId, visibility, ...base } = params;

    return this.appendEvent({
      ...base,
      eventType: 'comment_added',
      oldValue: null,
      newValue: {
        comment_id: commentId,
        visibility,
      },
    });
  }

  /**
   * Convenience: record `email_linked` event.
   */
  async recordEmailLinked(params: {
    taskId: string;
    organizationId: string;
    origin: TaskEventOrigin;
    emailMessageId: string;
    actorUserId?: string | null;
    actorRoleId?: string | null;
  }): Promise<StandardResult<TaskEventModel>> {
    const { emailMessageId, ...base } = params;

    return this.appendEvent({
      ...base,
      eventType: 'email_linked',
      oldValue: null,
      newValue: {
        email_message_id: emailMessageId,
      },
    });
  }

  /**
   * Convenience: record `escalated` event.
   */
  async recordEscalated(params: {
    taskId: string;
    organizationId: string;
    origin: TaskEventOrigin;
    previousEscalationLevel: number;
    nextEscalationLevel: number;
    actorUserId?: string | null;
    actorRoleId?: string | null;
    reason: string;
  }): Promise<StandardResult<TaskEventModel>> {
    const {
      previousEscalationLevel,
      nextEscalationLevel,
      reason,
      ...base
    } = params;

    return this.appendEvent({
      ...base,
      eventType: 'escalated',
      oldValue: {
        escalation_level: previousEscalationLevel,
      },
      newValue: {
        escalation_level: nextEscalationLevel,
        reason,
      },
    });
  }

  /**
   * Convenience: record `deadline_updated` event.
   */
  async recordDeadlineUpdated(params: {
    taskId: string;
    organizationId: string;
    origin: TaskEventOrigin;
    previousDeadlineAt: string | null;
    nextDeadlineAt: string | null;
    actorUserId?: string | null;
    actorRoleId?: string | null;
    reason?: string;
  }): Promise<StandardResult<TaskEventModel>> {
    const { previousDeadlineAt, nextDeadlineAt, reason, ...base } = params;

    return this.appendEvent({
      ...base,
      eventType: 'deadline_updated',
      oldValue: {
        reactivity_deadline_at: previousDeadlineAt,
      },
      newValue: {
        reactivity_deadline_at: nextDeadlineAt,
        reason: reason ?? null,
      },
    });
  }

  /**
   * Convenience: record `metadata_updated` event.
   * Accepts arbitrary old/new shape and leaves semantics to caller.
   */
  async recordMetadataUpdated(params: {
    taskId: string;
    organizationId: string;
    origin: TaskEventOrigin;
    oldMetadata: Prisma.JsonValue | null;
    newMetadata: Prisma.JsonValue | null;
    actorUserId?: string | null;
    actorRoleId?: string | null;
  }): Promise<StandardResult<TaskEventModel>> {
    const { oldMetadata, newMetadata, ...base } = params;

    return this.appendEvent({
      ...base,
      eventType: 'metadata_updated',
      oldValue: oldMetadata,
      newValue: newMetadata,
    });
  }
}

===== END apps/api/src/orgo/core/tasks/task-events.service.ts =====


===== BEGIN apps/api/src/orgo/core/tasks/task.controller.ts =====
import { Body, Controller, Get, Param, Post, Query } from '@nestjs/common';
import {
  ApiCreatedResponse,
  ApiOkResponse,
  ApiOperation,
  ApiTags,
} from '@nestjs/swagger';
import { TaskService } from './task.service';

/**
 * Canonical Task enums (DB-level tokens).
 */
export type TaskStatus =
  | 'PENDING'
  | 'IN_PROGRESS'
  | 'ON_HOLD'
  | 'COMPLETED'
  | 'FAILED'
  | 'ESCALATED'
  | 'CANCELLED';

export type TaskPriority = 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';

export type TaskSeverity = 'MINOR' | 'MODERATE' | 'MAJOR' | 'CRITICAL';

export type TaskVisibility =
  | 'PUBLIC'
  | 'INTERNAL'
  | 'RESTRICTED'
  | 'ANONYMISED';

export type TaskSource = 'email' | 'api' | 'manual' | 'sync';

export type TaskCategory =
  | 'request'
  | 'incident'
  | 'update'
  | 'report'
  | 'distribution';

/**
 * JSON-facing variants (allowing lower-case tokens as per docs).
 */
export type TaskStatusJson = TaskStatus | Lowercase<TaskStatus>;
export type TaskPriorityJson = TaskPriority | Lowercase<TaskPriority>;
export type TaskSeverityJson = TaskSeverity | Lowercase<TaskSeverity>;
export type TaskVisibilityJson = TaskVisibility | Lowercase<TaskVisibility>;

/**
 * Standard result envelope for Core Services (locked for v3).
 */
export interface OrgoError {
  code: string;
  message: string;
  details?: Record<string, unknown>;
}

export interface OrgoResult<T> {
  ok: boolean;
  data: T | null;
  error: OrgoError | null;
}

/**
 * Canonical Task JSON DTO (API boundary).
 * Mirrors Doc 2.10 + Doc 8.4.2.
 */
export interface TaskDto {
  task_id: string;
  organization_id: string;
  case_id: string | null;

  // Classification / routing
  source: TaskSource;
  type: string;
  category: TaskCategory;
  subtype: string | null;
  label: string;

  // Human-facing
  title: string;
  description: string;

  // Lifecycle / enums
  status: TaskStatusJson;
  priority: TaskPriorityJson;
  severity: TaskSeverityJson;
  visibility: TaskVisibilityJson;

  // Ownership / actors
  assignee_role: string | null;
  created_by_user_id: string | null;
  requester_person_id: string | null;
  owner_role_id: string | null;
  owner_user_id: string | null;

  // SLA / timing
  due_at: string | null;
  reactivity_time: string | null;
  reactivity_deadline_at: string | null;
  escalation_level: number;
  closed_at: string | null;

  // Arbitrary domain metadata
  metadata: Record<string, unknown>;

  // Audit
  created_at: string;
  updated_at: string;
}

/**
 * Query parameters for GET /api/v3/tasks.
 * Filters match the functional inventory (status, label, domain/type, assignee, severity, visibility).
 * Pagination fields are intentionally minimal and can be extended later.
 */
export class ListTasksQueryDto {
  /**
   * Tenant isolation key (organization_id).
   * In most real calls this should be required, but left optional at DTO level
   * to allow auth middleware / guards to inject it.
   */
  organization_id?: string;

  /**
   * Filter by canonical status (PENDING, IN_PROGRESS, etc.) or lower-case JSON form.
   */
  status?: TaskStatusJson;

  /**
   * Filter by canonical label code (e.g. "100.11.Ops.Maintenance").
   */
  label?: string;

  /**
   * Domain-level type (e.g. "maintenance", "hr_case", "education_support").
   */
  type?: string;

  /**
   * Filter by current assignee routing role (e.g. "Ops.Maintenance").
   */
  assignee_role?: string;

  /**
   * Filter by severity (MINOR/MODERATE/MAJOR/CRITICAL or lower-case JSON form).
   */
  severity?: TaskSeverityJson;

  /**
   * Filter by visibility (PUBLIC/INTERNAL/RESTRICTED/ANONYMISED or lower-case JSON form).
   */
  visibility?: TaskVisibilityJson;

  /**
   * Optional priority filter (LOW/MEDIUM/HIGH/CRITICAL or lower-case JSON form).
   */
  priority?: TaskPriorityJson;

  /**
   * 1-based page index for pagination.
   */
  page?: number;

  /**
   * Page size for pagination.
   */
  page_size?: number;
}

/**
 * Request body for POST /api/v3/tasks (Create Task via API).
 * Required fields match Core Services spec for create_task.
 */
export class CreateTaskRequestDto {
  // Required core fields
  organization_id!: string;
  type!: string;
  category!: TaskCategory;
  title!: string;
  description!: string;
  priority!: TaskPriorityJson;
  severity!: TaskSeverityJson;
  visibility!: TaskVisibilityJson;
  label!: string;
  source!: TaskSource;
  metadata!: Record<string, unknown>;

  // Optional fields
  case_id?: string | null;
  subtype?: string | null;
  created_by_user_id?: string | null;
  requester_person_id?: string | null;
  owner_role_id?: string | null;
  owner_user_id?: string | null;
  assignee_role?: string | null;
  due_at?: string | null;
}

/**
 * TaskController – Public API interface for Tasks.
 *
 * Routes (locked by functional inventory):
 *  - GET  /api/v3/tasks        → listTasks
 *  - GET  /api/v3/tasks/:id    → getTask
 *  - POST /api/v3/tasks        → createTask
 */
@ApiTags('tasks')
@Controller('api/v3/tasks')
export class TaskController {
  constructor(private readonly taskService: TaskService) {}

  @Get()
  @ApiOperation({
    summary: 'Get Tasks (list)',
    description:
      'Returns a list of Tasks filtered by status, label, domain/type, assignee, severity, and visibility.',
  })
  @ApiOkResponse({
    description: 'List of Tasks wrapped in the standard ok/data/error envelope.',
    type: Object,
  })
  async listTasks(
    @Query() query: ListTasksQueryDto,
  ): Promise<OrgoResult<TaskDto[]>> {
    return this.taskService.listTasks(query);
  }

  @Get(':id')
  @ApiOperation({
    summary: 'Get single Task',
    description:
      'Returns a single Task by its task_id, using the canonical Task JSON schema.',
  })
  @ApiOkResponse({
    description: 'Single Task wrapped in the standard ok/data/error envelope.',
    type: Object,
  })
  async getTask(@Param('id') taskId: string): Promise<OrgoResult<TaskDto>> {
    return this.taskService.getTask(taskId);
  }

  @Post()
  @ApiOperation({
    summary: 'Create Task via API',
    description:
      'Creates a new Task using the canonical Task model and enums. Status, SLA fields and escalation_level are derived by Core Services.',
  })
  @ApiCreatedResponse({
    description: 'Created Task wrapped in the standard ok/data/error envelope.',
    type: Object,
  })
  async createTask(
    @Body() body: CreateTaskRequestDto,
  ): Promise<OrgoResult<TaskDto>> {
    return this.taskService.createTask(body);
  }
}

===== END apps/api/src/orgo/core/tasks/task.controller.ts =====


===== BEGIN apps/api/src/orgo/core/tasks/task.module.ts =====
import { Module } from '@nestjs/common';
import { PersistenceModule } from '../../../persistence/persistence.module';
import { TaskService } from './task.service';
import { TaskController } from './task.controller';

@Module({
  imports: [PersistenceModule],
  controllers: [TaskController],
  providers: [TaskService],
  exports: [TaskService],
})
export class TaskModule {}

===== END apps/api/src/orgo/core/tasks/task.module.ts =====


===== BEGIN apps/api/src/orgo/core/tasks/task.service.ts =====
import { Injectable, Logger } from '@nestjs/common';
import { PrismaService } from '../../../persistence/prisma/prisma.service';

/**
 * Canonical enums (logical view)
 * These mirror the enums described in the Orgo v3 spec (Docs 2, 5, 8).
 */

export type TaskStatus =
  | 'PENDING'
  | 'IN_PROGRESS'
  | 'ON_HOLD'
  | 'COMPLETED'
  | 'FAILED'
  | 'ESCALATED'
  | 'CANCELLED';

export type TaskPriority = 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';

export type TaskSeverity = 'MINOR' | 'MODERATE' | 'MAJOR' | 'CRITICAL';

export type TaskVisibility = 'PUBLIC' | 'INTERNAL' | 'RESTRICTED' | 'ANONYMISED';

export type TaskSource = 'email' | 'api' | 'manual' | 'sync';

export type TaskCategory =
  | 'request'
  | 'incident'
  | 'update'
  | 'report'
  | 'distribution';

export type TaskCommentVisibility =
  | 'internal_only'
  | 'requester_visible'
  | 'org_wide';

/**
 * Input types accepted by the TaskService.
 * These are internal TS types, designed to map cleanly to the canonical
 * Task JSON contract and the underlying Prisma models.
 */

type StatusInput = TaskStatus | Lowercase<TaskStatus>;
type PriorityInput = TaskPriority | Lowercase<TaskPriority>;
type SeverityInput = TaskSeverity | Lowercase<TaskSeverity>;
type VisibilityInput = TaskVisibility | Lowercase<TaskVisibility>;
type SourceInput = TaskSource | Lowercase<TaskSource>;

export interface CreateTaskInput {
  organizationId: string;
  type: string;
  category: TaskCategory;
  title: string;
  description: string;
  priority: PriorityInput;
  severity: SeverityInput;
  visibility: VisibilityInput;
  label: string;
  source: SourceInput;

  caseId?: string | null;
  subtype?: string | null;
  dueAt?: string | Date | null;
  createdByUserId?: string | null;
  requesterPersonId?: string | null;
  ownerRoleId?: string | null;
  ownerUserId?: string | null;
  assigneeRole?: string | null;
  metadata?: Record<string, any> | null;

  /**
   * Reactivity configuration.
   * In a later iteration this should be derived from OrgProfileService +
   * workflow rules. For now we support direct overrides plus a default.
   */
  reactivitySeconds?: number | null;
  reactivityTimeIso?: string | null;
  reactivityDeadlineAt?: string | Date | null;
}

export interface UpdateTaskStatusInput {
  organizationId: string;
  taskId: string;
  newStatus: StatusInput;
  reason?: string;
  actorUserId?: string | null;
}

export interface EscalateTaskInput {
  organizationId: string;
  taskId: string;
  reason: string;
  actorUserId?: string | null;
}

export interface AssignTaskInput {
  organizationId: string;
  taskId: string;
  assigneeRole?: string | null;
  assigneeUserId?: string | null;
  actorUserId?: string | null;
}

export interface AddTaskCommentInput {
  organizationId: string;
  taskId: string;
  comment: string;
  authorUserId: string;
  visibility?: TaskCommentVisibility;
}

/**
 * DTOs returned by the service.
 * These are camelCase for internal TS usage; controllers can remap to
 * snake_case / canonical JSON property names as needed.
 */

export interface TaskDto {
  taskId: string;
  organizationId: string;
  caseId: string | null;

  type: string;
  category: TaskCategory;
  subtype: string | null;

  label: string;
  title: string;
  description: string;

  status: TaskStatus;
  priority: TaskPriority;
  severity: TaskSeverity;

  visibility: TaskVisibility;
  source: TaskSource;

  createdByUserId: string | null;
  requesterPersonId: string | null;
  ownerRoleId: string | null;
  ownerUserId: string | null;
  assigneeRole: string | null;

  dueAt: string | null;
  reactivityDeadlineAt: string | null;
  escalationLevel: number;
  closedAt: string | null;

  metadata: Record<string, any>;

  createdAt: string;
  updatedAt: string;
}

export interface TaskCommentDto {
  id: string;
  taskId: string;
  organizationId: string;
  authorUserId: string;
  visibility: TaskCommentVisibility;
  comment: string;
  createdAt: string;
}

/**
 * Standard result shape for all Core Services:
 *
 *   { ok: true, data, error: null }
 *   { ok: false, data: null, error: { code, message, details? } }
 */

export interface ServiceError {
  code: string;
  message: string;
  details?: Record<string, any>;
}

export interface ServiceResult<T> {
  ok: boolean;
  data: T | null;
  error: ServiceError | null;
}

/**
 * Internal helpers and constants.
 */

const TASK_STATE_TRANSITIONS: Record<TaskStatus, TaskStatus[]> = {
  PENDING: ['IN_PROGRESS', 'CANCELLED'],
  IN_PROGRESS: ['ON_HOLD', 'COMPLETED', 'FAILED', 'ESCALATED'],
  ON_HOLD: ['IN_PROGRESS', 'CANCELLED'],
  ESCALATED: ['IN_PROGRESS', 'COMPLETED', 'FAILED'],
  COMPLETED: [],
  FAILED: [],
  CANCELLED: [],
};

const TERMINAL_STATUSES: ReadonlySet<TaskStatus> = new Set([
  'COMPLETED',
  'FAILED',
  'CANCELLED',
]);

const ALLOWED_CATEGORIES: ReadonlySet<TaskCategory> = new Set([
  'request',
  'incident',
  'update',
  'report',
  'distribution',
]);

const DEFAULT_REACTIVITY_SECONDS = 43_200; // 12h, aligned with default profile


type TaskEventType =
  | 'task_created'
  | 'task_status_changed'
  | 'task_escalated'
  | 'task_assigned'
  | 'task_comment_added';

@Injectable()
export class TaskService {
  private readonly logger = new Logger(TaskService.name);

  constructor(private readonly prisma: PrismaService) {}

  /**
   * Create Task from event / workflow / API input.
   */
  async createTask(input: CreateTaskInput): Promise<ServiceResult<TaskDto>> {
    const validationError = this.validateCreateTaskInput(input);
    if (validationError) {
      return this.fail<TaskDto>(validationError);
    }

    try {
      const now = new Date();
      const reactivityDeadline = this.computeReactivityDeadline(now, input);
      const status: TaskStatus = 'PENDING';

      const data: any = {
        // identity / linkage
        organization_id: input.organizationId,
        case_id: input.caseId ?? null,

        // classification
        type: input.type,
        category: input.category,
        subtype: input.subtype ?? null,
        label: input.label,

        // content
        title: input.title,
        description: input.description,

        // enums
        status,
        priority: this.normalizePriority(input.priority),
        severity: this.normalizeSeverity(input.severity),
        visibility: this.normalizeVisibility(input.visibility),
        source: this.normalizeSource(input.source),

        // actors
        created_by_user_id: input.createdByUserId ?? null,
        requester_person_id: input.requesterPersonId ?? null,
        owner_role_id: input.ownerRoleId ?? null,
        owner_user_id: input.ownerUserId ?? null,
        assignee_role: input.assigneeRole ?? null,

        // timing
        due_at: input.dueAt ? new Date(input.dueAt) : null,
        reactivity_deadline_at: reactivityDeadline,
        escalation_level: 0,
        closed_at: null,

        // metadata
        metadata: input.metadata ?? {},

        // audit columns (these may be handled by DB defaults; we set them defensively)
        created_at: now,
        updated_at: now,
      };

      // Note: we cast prisma to any here to decouple from the current Prisma schema.
      // Once the `Task` model is added to schema.prisma, this can be made fully typed.
      const created = await (this.prisma as any).task.create({ data });
      const dto = this.mapTaskModelToDto(created);

      await this.recordTaskEvent('task_created', dto.taskId, dto.organizationId, {
        status: dto.status,
        priority: dto.priority,
        severity: dto.severity,
      });

      return this.ok(dto);
    } catch (err: any) {
      this.logger.error('Failed to create task', err?.stack || err?.message);
      return this.fail<TaskDto>({
        code: 'TASK_CREATION_FAILED',
        message: 'Failed to create task',
        details: { cause: err?.message },
      });
    }
  }

  /**
   * Update Task status (enforces canonical state machine).
   */
  async updateTaskStatus(
    input: UpdateTaskStatusInput,
  ): Promise<ServiceResult<TaskDto>> {
    const normalizedStatus = this.normalizeStatus(input.newStatus);
    if (!normalizedStatus) {
      return this.fail<TaskDto>({
        code: 'TASK_VALIDATION_ERROR',
        message: `Invalid status value: ${input.newStatus}`,
        details: { field: 'newStatus' },
      });
    }

    try {
      const taskModel = await this.getTaskModelForOrg(
        input.organizationId,
        input.taskId,
      );

      if (!taskModel) {
        return this.fail<TaskDto>({
          code: 'TASK_NOT_FOUND',
          message: 'Task not found',
          details: {
            taskId: input.taskId,
            organizationId: input.organizationId,
          },
        });
      }

      const currentStatus = this.normalizeStatus(taskModel.status);
      if (!currentStatus) {
        return this.fail<TaskDto>({
          code: 'TASK_STATE_CORRUPTED',
          message: 'Task has invalid current status',
          details: { taskId: input.taskId, status: taskModel.status },
        });
      }

      if (!this.isTransitionAllowed(currentStatus, normalizedStatus)) {
        return this.fail<TaskDto>({
          code: 'INVALID_TASK_STATE_TRANSITION',
          message: `Transition ${currentStatus} → ${normalizedStatus} is not allowed`,
          details: {
            from: currentStatus,
            to: normalizedStatus,
            taskId: input.taskId,
          },
        });
      }

      const now = new Date();

      const updateData: any = {
        status: normalizedStatus,
        updated_at: now,
      };

      if (TERMINAL_STATUSES.has(normalizedStatus)) {
        updateData.closed_at = now;
      } else if (TERMINAL_STATUSES.has(currentStatus)) {
        // Moving from terminal to non‑terminal should not normally happen,
        // but if it does, closed_at must be cleared.
        updateData.closed_at = null;
      }

      const updated = await (this.prisma as any).task.update({
        where: { id: taskModel.id },
        data: updateData,
      });

      const dto = this.mapTaskModelToDto(updated);

      await this.recordTaskEvent(
        'task_status_changed',
        dto.taskId,
        dto.organizationId,
        {
          from: currentStatus,
          to: normalizedStatus,
          reason: input.reason,
          actorUserId: input.actorUserId,
        },
      );

      return this.ok(dto);
    } catch (err: any) {
      this.logger.error('Failed to update task status', err?.stack || err?.message);
      return this.fail<TaskDto>({
        code: 'TASK_STATUS_UPDATE_FAILED',
        message: 'Failed to update task status',
        details: { cause: err?.message },
      });
    }
  }

  /**
   * Escalate a Task: increments escalation_level and sets status = ESCALATED.
   * This enforces that the current status allows an ESCALATED transition.
   */
  async escalateTask(
    input: EscalateTaskInput,
  ): Promise<ServiceResult<TaskDto>> {
    try {
      const taskModel = await this.getTaskModelForOrg(
        input.organizationId,
        input.taskId,
      );

      if (!taskModel) {
        return this.fail<TaskDto>({
          code: 'TASK_NOT_FOUND',
          message: 'Task not found',
          details: {
            taskId: input.taskId,
            organizationId: input.organizationId,
          },
        });
      }

      const currentStatus = this.normalizeStatus(taskModel.status);
      if (!currentStatus) {
        return this.fail<TaskDto>({
          code: 'TASK_STATE_CORRUPTED',
          message: 'Task has invalid current status',
          details: { taskId: input.taskId, status: taskModel.status },
        });
      }

      if (!this.isTransitionAllowed(currentStatus, 'ESCALATED')) {
        return this.fail<TaskDto>({
          code: 'TASK_ESCALATION_INVALID_STATE',
          message: `Cannot escalate task from state ${currentStatus}`,
          details: { taskId: input.taskId },
        });
      }

      const now = new Date();
      const currentLevel =
        typeof taskModel.escalation_level === 'number'
          ? taskModel.escalation_level
          : 0;

      const updated = await (this.prisma as any).task.update({
        where: { id: taskModel.id },
        data: {
          status: 'ESCALATED',
          escalation_level: currentLevel + 1,
          updated_at: now,
        },
      });

      const dto = this.mapTaskModelToDto(updated);

      await this.recordTaskEvent('task_escalated', dto.taskId, dto.organizationId, {
        from: currentStatus,
        to: 'ESCALATED',
        previousEscalationLevel: currentLevel,
        newEscalationLevel: currentLevel + 1,
        reason: input.reason,
        actorUserId: input.actorUserId,
      });

      return this.ok(dto);
    } catch (err: any) {
      this.logger.error('Failed to escalate task', err?.stack || err?.message);
      return this.fail<TaskDto>({
        code: 'TASK_ESCALATION_FAILED',
        message: 'Failed to escalate task',
        details: { cause: err?.message },
      });
    }
  }

  /**
   * Assign / reassign a Task to a role and/or user.
   */
  async assignTask(
    input: AssignTaskInput,
  ): Promise<ServiceResult<TaskDto>> {
    if (!input.assigneeRole && !input.assigneeUserId) {
      return this.fail<TaskDto>({
        code: 'TASK_VALIDATION_ERROR',
        message: 'Either assigneeRole or assigneeUserId must be provided',
        details: { field: 'assigneeRole/assigneeUserId' },
      });
    }

    try {
      const taskModel = await this.getTaskModelForOrg(
        input.organizationId,
        input.taskId,
      );

      if (!taskModel) {
        return this.fail<TaskDto>({
          code: 'TASK_NOT_FOUND',
          message: 'Task not found',
          details: {
            taskId: input.taskId,
            organizationId: input.organizationId,
          },
        });
      }

      const now = new Date();

      const data: any = {
        updated_at: now,
      };

      if (input.assigneeRole !== undefined) {
        data.assignee_role = input.assigneeRole;
      }

      // For now we only update routing-level fields in tasks;
      // per spec, full assignment history would be stored in a separate table.
      if (input.assigneeUserId !== undefined) {
        data.owner_user_id = input.assigneeUserId;
      }

      const updated = await (this.prisma as any).task.update({
        where: { id: taskModel.id },
        data,
      });

      const dto = this.mapTaskModelToDto(updated);

      await this.recordTaskEvent('task_assigned', dto.taskId, dto.organizationId, {
        assigneeRole: dto.assigneeRole,
        assigneeUserId: input.assigneeUserId,
        actorUserId: input.actorUserId,
      });

      return this.ok(dto);
    } catch (err: any) {
      this.logger.error('Failed to assign task', err?.stack || err?.message);
      return this.fail<TaskDto>({
        code: 'TASK_ASSIGNMENT_FAILED',
        message: 'Failed to assign task',
        details: { cause: err?.message },
      });
    }
  }

  /**
   * Add a comment to a Task.
   */
  async addComment(
    input: AddTaskCommentInput,
  ): Promise<ServiceResult<TaskCommentDto>> {
    if (!input.comment || !input.comment.trim()) {
      return this.fail<TaskCommentDto>({
        code: 'TASK_VALIDATION_ERROR',
        message: 'Comment must not be empty',
        details: { field: 'comment' },
      });
    }

    const visibility: TaskCommentVisibility =
      input.visibility ?? 'internal_only';

    try {
      const taskModel = await this.getTaskModelForOrg(
        input.organizationId,
        input.taskId,
      );

      if (!taskModel) {
        return this.fail<TaskCommentDto>({
          code: 'TASK_NOT_FOUND',
          message: 'Task not found',
          details: {
            taskId: input.taskId,
            organizationId: input.organizationId,
          },
        });
      }

      const now = new Date();

      const commentModel = await (this.prisma as any).taskComment.create({
        data: {
          organization_id: input.organizationId,
          task_id: taskModel.id,
          author_user_id: input.authorUserId,
          visibility,
          comment: input.comment,
          created_at: now,
        },
      });

      const dto: TaskCommentDto = {
        id: String(commentModel.id),
        taskId: String(commentModel.task_id ?? taskModel.id),
        organizationId: String(
          commentModel.organization_id ?? input.organizationId,
        ),
        authorUserId: String(commentModel.author_user_id),
        visibility: commentModel.visibility as TaskCommentVisibility,
        comment: String(commentModel.comment),
        createdAt: (commentModel.created_at ?? now).toISOString(),
      };

      await this.recordTaskEvent(
        'task_comment_added',
        dto.taskId,
        dto.organizationId,
        {
          authorUserId: dto.authorUserId,
          visibility: dto.visibility,
        },
      );

      return this.ok(dto);
    } catch (err: any) {
      this.logger.error('Failed to add task comment', err?.stack || err?.message);
      return this.fail<TaskCommentDto>({
        code: 'TASK_COMMENT_FAILED',
        message: 'Failed to add comment to task',
        details: { cause: err?.message },
      });
    }
  }

  /**
   * Fetch Task details by id for a given organization.
   */
  async getTaskById(
    organizationId: string,
    taskId: string,
  ): Promise<ServiceResult<TaskDto>> {
    try {
      const taskModel = await this.getTaskModelForOrg(organizationId, taskId);

      if (!taskModel) {
        return this.fail<TaskDto>({
          code: 'TASK_NOT_FOUND',
          message: 'Task not found',
          details: { organizationId, taskId },
        });
      }

      const dto = this.mapTaskModelToDto(taskModel);
      return this.ok(dto);
    } catch (err: any) {
      this.logger.error('Failed to fetch task by id', err?.stack || err?.message);
      return this.fail<TaskDto>({
        code: 'TASK_FETCH_FAILED',
        message: 'Failed to fetch task',
        details: { cause: err?.message },
      });
    }
  }

  // ---------------------------------------------------------------------------
  // Internal helpers
  // ---------------------------------------------------------------------------

  private validateCreateTaskInput(
    input: CreateTaskInput,
  ): ServiceError | null {
    const requiredStringFields: Array<keyof CreateTaskInput> = [
      'organizationId',
      'type',
      'category',
      'title',
      'description',
      'priority',
      'severity',
      'visibility',
      'label',
      'source',
    ];

    for (const field of requiredStringFields) {
      const value = input[field] as any;
      if (
        value === undefined ||
        value === null ||
        (typeof value === 'string' && !value.trim())
      ) {
        return {
          code: 'TASK_VALIDATION_ERROR',
          message: `Missing required field '${String(field)}'`,
          details: { field },
        };
      }
    }

    if (!ALLOWED_CATEGORIES.has(input.category)) {
      return {
        code: 'TASK_VALIDATION_ERROR',
        message: `Invalid task category: ${input.category}`,
        details: {
          field: 'category',
          allowed: Array.from(ALLOWED_CATEGORIES),
        },
      };
    }

    // Basic sanity check for label: must contain at least one dot.
    if (!input.label.includes('.')) {
      return {
        code: 'TASK_VALIDATION_ERROR',
        message: 'Label must contain at least one dot ("<BASE>.<CATEGORY><SUBCATEGORY>...")',
        details: { field: 'label' },
      };
    }

    // Validate enum-like fields via the normalizers
    if (!this.normalizePriority(input.priority)) {
      return {
        code: 'TASK_VALIDATION_ERROR',
        message: `Invalid priority: ${input.priority}`,
        details: { field: 'priority' },
      };
    }

    if (!this.normalizeSeverity(input.severity)) {
      return {
        code: 'TASK_VALIDATION_ERROR',
        message: `Invalid severity: ${input.severity}`,
        details: { field: 'severity' },
      };
    }

    if (!this.normalizeVisibility(input.visibility)) {
      return {
        code: 'TASK_VALIDATION_ERROR',
        message: `Invalid visibility: ${input.visibility}`,
        details: { field: 'visibility' },
      };
    }

    if (!this.normalizeSource(input.source)) {
      return {
        code: 'TASK_VALIDATION_ERROR',
        message: `Invalid source: ${input.source}`,
        details: { field: 'source' },
      };
    }

    return null;
  }

  private computeReactivityDeadline(
    createdAt: Date,
    input: CreateTaskInput,
  ): Date | null {
    // Absolute override wins
    if (input.reactivityDeadlineAt) {
      return new Date(input.reactivityDeadlineAt);
    }

    let seconds: number | null = null;

    if (typeof input.reactivitySeconds === 'number') {
      seconds = input.reactivitySeconds;
    } else if (input.reactivityTimeIso) {
      seconds = this.parseIsoDurationToSeconds(input.reactivityTimeIso);
    }

    if (seconds == null || !Number.isFinite(seconds) || seconds <= 0) {
      // Fallback to profile-like default (aligned with "default" profile).
      seconds = DEFAULT_REACTIVITY_SECONDS;
    }

    return new Date(createdAt.getTime() + seconds * 1000);
  }

  private parseIsoDurationToSeconds(value: string): number | null {
    // Very small subset of ISO‑8601 duration: P[nD]T[nH][nM][nS]
    const trimmed = value.trim().toUpperCase();
    const match = /^P(?:(\d+)D)?(?:T(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?)?$/.exec(
      trimmed,
    );
    if (!match) {
      return null;
    }

    const days = match[1] ? parseInt(match[1], 10) : 0;
    const hours = match[2] ? parseInt(match[2], 10) : 0;
    const minutes = match[3] ? parseInt(match[3], 10) : 0;
    const seconds = match[4] ? parseInt(match[4], 10) : 0;

    return (
      days * 24 * 3600 +
      hours * 3600 +
      minutes * 60 +
      seconds
    );
  }

  private normalizeStatus(input: string): TaskStatus | null {
    if (!input) return null;
    const upper = input.toUpperCase() as TaskStatus;
    if (upper in TASK_STATE_TRANSITIONS || TERMINAL_STATUSES.has(upper)) {
      return upper;
    }
    return null;
  }

  private normalizePriority(input: PriorityInput): TaskPriority | null {
    if (!input) return null;
    const upper = input.toUpperCase() as TaskPriority;
    if (['LOW', 'MEDIUM', 'HIGH', 'CRITICAL'].includes(upper)) {
      return upper;
    }
    return null;
  }

  private normalizeSeverity(input: SeverityInput): TaskSeverity | null {
    if (!input) return null;
    const upper = input.toUpperCase() as TaskSeverity;
    if (['MINOR', 'MODERATE', 'MAJOR', 'CRITICAL'].includes(upper)) {
      return upper;
    }
    return null;
  }

  private normalizeVisibility(input: VisibilityInput): TaskVisibility | null {
    if (!input) return null;
    const upper = input.toUpperCase() as TaskVisibility;
    if (['PUBLIC', 'INTERNAL', 'RESTRICTED', 'ANONYMISED'].includes(upper)) {
      return upper;
    }
    return null;
  }

  private normalizeSource(input: SourceInput): TaskSource | null {
    if (!input) return null;
    const lower = input.toLowerCase() as TaskSource;
    if (['email', 'api', 'manual', 'sync'].includes(lower)) {
      return lower;
    }
    return null;
  }

  private isTransitionAllowed(
    from: TaskStatus,
    to: TaskStatus,
  ): boolean {
    const allowed = TASK_STATE_TRANSITIONS[from] ?? [];
    return allowed.includes(to);
  }

  private async getTaskModelForOrg(
    organizationId: string,
    taskId: string,
  ): Promise<any | null> {
    const model = await (this.prisma as any).task.findUnique({
      where: { id: taskId },
    });

    if (!model) {
      return null;
    }

    const orgId =
      model.organization_id ?? model.organizationId ?? model.org_id;
    if (orgId !== organizationId) {
      this.logger.warn(
        `Attempt to access task ${taskId} from wrong organization ${organizationId}`,
      );
      return null;
    }

    return model;
  }

  private mapTaskModelToDto(model: any): TaskDto {
    const get = (...keys: string[]) => {
      for (const key of keys) {
        if (key in model && model[key] !== undefined) {
          return model[key];
        }
      }
      return undefined;
    };

    const id = get('id', 'task_id');
    const organizationId = get('organization_id', 'organizationId');
    const caseId = get('case_id', 'caseId') ?? null;

    const status = this.normalizeStatus(get('status')) ?? 'PENDING';
    const priority =
      (this.normalizePriority(get('priority')) ?? 'MEDIUM');
    const severity =
      (this.normalizeSeverity(get('severity')) ?? 'MINOR');
    const visibility =
      (this.normalizeVisibility(get('visibility')) ?? 'INTERNAL');
    const source = this.normalizeSource(get('source')) ?? 'manual';

    const escalationLevel = get('escalation_level', 'escalationLevel');
    const meta = get('metadata') ?? {};

    const toIso = (value: any | null | undefined): string | null => {
      if (!value) return null;
      if (value instanceof Date) return value.toISOString();
      const asDate = new Date(value);
      return Number.isNaN(asDate.getTime()) ? null : asDate.toISOString();
    };

    return {
      taskId: String(id),
      organizationId: String(organizationId),
      caseId: caseId ? String(caseId) : null,

      type: String(get('type') ?? ''),
      category: get('category') as TaskCategory,
      subtype: get('subtype') ?? null,

      label: String(get('label') ?? ''),
      title: String(get('title') ?? ''),
      description: String(get('description') ?? ''),

      status,
      priority,
      severity,

      visibility,
      source,

      createdByUserId: get('created_by_user_id', 'createdByUserId') ?? null,
      requesterPersonId:
        get('requester_person_id', 'requesterPersonId') ?? null,
      ownerRoleId: get('owner_role_id', 'ownerRoleId') ?? null,
      ownerUserId: get('owner_user_id', 'ownerUserId') ?? null,
      assigneeRole: get('assignee_role', 'assigneeRole') ?? null,

      dueAt: toIso(get('due_at', 'dueAt')),
      reactivityDeadlineAt: toIso(
        get('reactivity_deadline_at', 'reactivityDeadlineAt'),
      ),
      escalationLevel:
        typeof escalationLevel === 'number' ? escalationLevel : 0,
      closedAt: toIso(get('closed_at', 'closedAt')),

      metadata: typeof meta === 'object' && meta !== null ? meta : {},

      createdAt: toIso(get('created_at', 'createdAt')) ?? new Date().toISOString(),
      updatedAt: toIso(get('updated_at', 'updatedAt')) ?? new Date().toISOString(),
    };
  }

  private async recordTaskEvent(
    type: TaskEventType,
    taskId: string,
    organizationId: string,
    metadata?: Record<string, any>,
  ): Promise<void> {
    // For now we only log via NestJS Logger.
    // Later this can be wired into a dedicated LogService + task_events table.
    this.logger.log(
      JSON.stringify({
        type,
        taskId,
        organizationId,
        metadata: metadata ?? {},
      }),
      'TaskEvent',
    );
  }

  private ok<T>(data: T): ServiceResult<T> {
    return { ok: true, data, error: null };
  }

  private fail<T>(error: ServiceError): ServiceResult<T> {
    return { ok: false, data: null, error };
  }
}

===== END apps/api/src/orgo/core/tasks/task.service.ts =====


===== BEGIN apps/api/src/orgo/core/validation/config-validation.service.ts =====
import { Injectable, Logger } from '@nestjs/common';

type OrgoEnvironment = 'dev' | 'staging' | 'prod' | 'offline';

const ORGO_ENVIRONMENTS: OrgoEnvironment[] = [
  'dev',
  'staging',
  'prod',
  'offline',
];

export interface ConfigMetadata {
  config_name: string;
  version: string;
  environment: OrgoEnvironment;
  last_updated: string;
  owner?: string;
  organization_id?: string;
  // Allow additional metadata keys without forcing a strict schema here
  // (domain modules and other services may extend this).
  [key: string]: unknown;
}

export interface ConfigValidationErrorDetail {
  /**
   * JSON-style path to the offending value, e.g. "metadata.version" or "smtp.host".
   * Empty string ("") refers to the root object.
   */
  path: string;
  message: string;
}

export interface StandardError {
  code: string;
  message: string;
  details?: {
    errors?: ConfigValidationErrorDetail[];
    [key: string]: unknown;
  };
}

export interface ValidationResult<T> {
  ok: boolean;
  data: T | null;
  error: StandardError | null;
}

/**
 * Represents one config entry in a bundle (e.g., email_config, database_connection).
 */
export interface ConfigBundleItem<TConfig = any> {
  name: string;
  config: TConfig;
  requiredKeys: string[];
}

/**
 * ConfigValidatorService (validation_core)
 *
 * Cross-cutting configuration validation utilities used by Core Services and modules.
 * Implements the standard result shape and metadata/env/version checks.
 */
@Injectable()
export class ConfigValidatorService {
  private readonly logger = new Logger(ConfigValidatorService.name);

  /**
   * Validates a single configuration object against:
   * - Common metadata rules (Doc 2 §3.2, Doc 5 §10.2).
   * - Presence and basic non-null checks for required keys.
   *
   * Returns the standard result shape:
   *   { ok: true, data: config, error: null } on success
   *   { ok: false, data: null, error: { code: "CONFIG_VALIDATION_ERROR", ... } } on failure
   */
  validateConfig<T extends Record<string, any>>(
    config: T | null | undefined,
    requiredKeys: string[] = [],
  ): ValidationResult<T> {
    const errors: ConfigValidationErrorDetail[] = [];

    if (!config || typeof config !== 'object' || Array.isArray(config)) {
      errors.push({
        path: '',
        message: 'Config must be a non-null object.',
      });

      return this.buildFailure<T>(
        'Configuration is not a valid object.',
        errors,
      );
    }

    this.validateMetadata(config as Record<string, any>, errors);
    this.validateRequiredKeys(config as Record<string, any>, requiredKeys, errors);

    if (errors.length > 0) {
      return this.buildFailure<T>(
        'One or more configuration validation errors occurred.',
        errors,
      );
    }

    return {
      ok: true,
      data: config as T,
      error: null,
    };
  }

  /**
   * Validates a bundle (set) of configuration objects.
   *
   * Each item is validated independently using validateConfig; any error in any
   * item produces a single CONFIG_VALIDATION_ERROR result containing all errors
   * with namespaced paths ("<configName>.<path>").
   *
   * On success, returns only the items that validated successfully in `data`.
   */
  validateConfigBundle(
    items: ConfigBundleItem[],
  ): ValidationResult<ConfigBundleItem[]> {
    const errors: ConfigValidationErrorDetail[] = [];
    const validItems: ConfigBundleItem[] = [];

    for (const item of items) {
      const result = this.validateConfig(item.config, item.requiredKeys);

      if (!result.ok && result.error && result.error.details?.errors) {
        for (const err of result.error.details.errors) {
          errors.push({
            path: item.name
              ? `${item.name}${err.path ? `.${err.path}` : ''}`
              : err.path,
            message: err.message,
          });
        }
      } else if (result.ok) {
        validItems.push(item);
      }
    }

    if (errors.length > 0) {
      return this.buildFailure<ConfigBundleItem[]>(
        'One or more configuration bundle validation errors occurred.',
        errors,
      );
    }

    return {
      ok: true,
      data: validItems,
      error: null,
    };
  }

  /**
   * Validates common metadata for all YAML/JSON configs under /config.
   *
   * Enforces:
   * - metadata exists and is an object
   * - metadata.config_name is non-empty
   * - metadata.environment ∈ ENVIRONMENT = { dev, staging, prod, offline }
   * - metadata.version matches ^3\.[0-9]+$ (Orgo v3 configs)
   * - metadata.last_updated is a valid YYYY-MM-DD date
   * - metadata.organization_id is "default" or a slug-like identifier
   */
  private validateMetadata(
    config: Record<string, any>,
    errors: ConfigValidationErrorDetail[],
  ): void {
    const meta = config.metadata;

    if (!meta || typeof meta !== 'object' || Array.isArray(meta)) {
      errors.push({
        path: 'metadata',
        message: 'Metadata object is required on all configuration files.',
      });
      return;
    }

    const {
      config_name: configName,
      environment,
      version,
      last_updated: lastUpdated,
      organization_id: organizationId,
    } = meta as Record<string, any>;

    if (typeof configName !== 'string' || configName.trim().length === 0) {
      errors.push({
        path: 'metadata.config_name',
        message: 'metadata.config_name must be a non-empty string.',
      });
    }

    if (
      typeof environment !== 'string' ||
      !ORGO_ENVIRONMENTS.includes(environment as OrgoEnvironment)
    ) {
      errors.push({
        path: 'metadata.environment',
        message: `metadata.environment must be one of: ${ORGO_ENVIRONMENTS.join(
          ', ',
        )}.`,
      });
    }

    if (typeof version !== 'string' || !/^3\.\d+$/.test(version)) {
      errors.push({
        path: 'metadata.version',
        message:
          'metadata.version must match the pattern ^3\\.[0-9]+$ for Orgo v3 configs.',
      });
    }

    if (typeof lastUpdated !== 'string' || !this.isValidIsoDate(lastUpdated)) {
      errors.push({
        path: 'metadata.last_updated',
        message:
          'metadata.last_updated must be a valid date string in YYYY-MM-DD format.',
      });
    }

    if (organizationId !== undefined) {
      if (
        typeof organizationId !== 'string' ||
        organizationId.trim().length === 0
      ) {
        errors.push({
          path: 'metadata.organization_id',
          message:
            'metadata.organization_id, if provided, must be a non-empty string.',
        });
      } else if (
        organizationId !== 'default' &&
        !/^[a-zA-Z0-9_-]+$/.test(organizationId)
      ) {
        errors.push({
          path: 'metadata.organization_id',
          message:
            'metadata.organization_id must be "default" or a slug/identifier containing only letters, numbers, underscore or dash.',
        });
      }
    }
  }

  /**
   * Ensures required top-level keys exist and are not null/undefined/empty-string.
   */
  private validateRequiredKeys(
    config: Record<string, any>,
    requiredKeys: string[],
    errors: ConfigValidationErrorDetail[],
  ): void {
    for (const key of requiredKeys) {
      if (!(key in config)) {
        errors.push({
          path: key,
          message: `Missing required configuration key "${key}".`,
        });
        continue;
      }

      const value = config[key];

      if (
        value === null ||
        value === undefined ||
        (typeof value === 'string' && value.trim().length === 0)
      ) {
        errors.push({
          path: key,
          message: `Configuration key "${key}" must not be null, undefined or an empty string.`,
        });
      }
    }
  }

  /**
   * Basic YYYY-MM-DD validator using a regex + Date.parse.
   */
  private isValidIsoDate(value: string): boolean {
    if (!/^\d{4}-\d{2}-\d{2}$/.test(value)) {
      return false;
    }

    const timestamp = Date.parse(value);
    return Number.isFinite(timestamp);
  }

  /**
   * Builds a CONFIG_VALIDATION_ERROR result and logs it using Nest's Logger.
   */
  private buildFailure<T>(
    message: string,
    errors: ConfigValidationErrorDetail[],
  ): ValidationResult<T> {
    const error: StandardError = {
      code: 'CONFIG_VALIDATION_ERROR',
      message,
      details: {
        errors,
      },
    };

    this.logger.error(
      `[CONFIG_VALIDATION_ERROR] ${message}`,
      errors.map((e) => `${e.path || '<root>'}: ${e.message}`).join('; '),
    );

    return {
      ok: false,
      data: null,
      error,
    };
  }
}

===== END apps/api/src/orgo/core/validation/config-validation.service.ts =====


===== BEGIN apps/api/src/orgo/core/validation/metadata.service.ts =====
import { Injectable, Logger } from '@nestjs/common';

export type MetadataEntity = 'task' | 'case';

export interface NormalizeMetadataResult {
  /**
   * Sanitized metadata object that is safe to persist in tasks.metadata / cases.metadata.
   */
  metadata: Record<string, unknown>;
  /**
   * Top-level keys that were removed during normalization.
   */
  removedKeys: string[];
  /**
   * Human-readable explanations of normalization steps that dropped or changed values.
   */
  warnings: string[];
}

/**
 * Keys that must never be accepted from external payloads because they can
 * mutate Object.prototype or otherwise cause prototype pollution.
 */
const PROTOTYPE_POLLUTION_KEYS = new Set<string>(['__proto__', 'constructor', 'prototype']);

/**
 * Canonical Task fields and common aliases that must not appear inside tasks.metadata.
 * Based on the canonical Task JSON contract and DB schema.
 */
const TASK_RESERVED_METADATA_KEYS = new Set<string>([
  // Identifiers
  'task_id',
  'id',
  'taskId',
  'organization_id',
  'organizationId',
  'org_id',
  'orgId',
  'case_id',
  'caseId',

  // Timestamps
  'created_at',
  'createdAt',
  'updated_at',
  'updatedAt',

  // Classification
  'type',
  'category',
  'subtype',
  'label',

  // Core state
  'status',
  'priority',
  'severity',
  'visibility',
  'source',

  // Actors / routing
  'title',
  'description',
  'created_by_user_id',
  'createdByUserId',
  'requester_person_id',
  'requesterPersonId',
  'owner_role_id',
  'ownerRoleId',
  'owner_user_id',
  'ownerUserId',
  'assignee_role',
  'assigneeRole',

  // SLA / escalation
  'due_at',
  'dueAt',
  'reactivity_time',
  'reactivityTime',
  'reactivity_deadline_at',
  'reactivityDeadlineAt',
  'escalation_level',
  'escalationLevel',
  'closed_at',
  'closedAt',

  // Nested metadata container itself
  'metadata',
]);

/**
 * Canonical Case fields and common aliases that must not appear inside cases.metadata.
 * Based on the canonical Case JSON contract and DB schema.
 */
const CASE_RESERVED_METADATA_KEYS = new Set<string>([
  // Identifiers
  'case_id',
  'id',
  'caseId',
  'organization_id',
  'organizationId',
  'org_id',
  'orgId',

  // Source
  'source_type',
  'sourceType',
  'source_reference',
  'sourceReference',

  // Core fields
  'label',
  'title',
  'description',
  'status',
  'severity',

  // SLA / routing
  'reactivity_time',
  'reactivityTime',
  'origin_vertical_level',
  'originVerticalLevel',
  'origin_role',
  'originRole',

  // Collections
  'tags',
  'location',

  // Nested metadata container itself
  'metadata',

  // Timestamps
  'created_at',
  'createdAt',
  'updated_at',
  'updatedAt',
]);

@Injectable()
export class MetadataService {
  private readonly logger = new Logger(MetadataService.name);

  /**
   * Normalizes free-form metadata to a JSON-safe, canonical shape and strips
   * out any fields that would conflict with canonical Task/Case fields
   * or introduce unsafe keys.
   *
   * Default entity is "task" to match the primary use in Core Services.
   */
  normalizeMetadata(
    raw: unknown,
    entity: MetadataEntity = 'task',
  ): NormalizeMetadataResult {
    const removedKeys: string[] = [];
    const warnings: string[] = [];

    if (raw == null) {
      // Nothing to normalize.
      return { metadata: {}, removedKeys, warnings };
    }

    if (Array.isArray(raw) || typeof raw !== 'object') {
      warnings.push(
        `Expected metadata to be an object for ${entity}, received ${
          Array.isArray(raw) ? 'array' : typeof raw
        }; dropping value.`,
      );
      this.logDiagnostics(entity, removedKeys, warnings);
      return { metadata: {}, removedKeys, warnings };
    }

    const input = raw as Record<string, unknown>;
    const metadata = this.normalizeMetadataObject(input, entity, 0, removedKeys, warnings);

    this.logDiagnostics(entity, removedKeys, warnings);
    return { metadata, removedKeys, warnings };
  }

  private normalizeMetadataObject(
    input: Record<string, unknown>,
    entity: MetadataEntity,
    depth: number,
    removedKeys: string[],
    warnings: string[],
  ): Record<string, unknown> {
    const result: Record<string, unknown> = {};
    const reservedKeys = this.getReservedKeys(entity);

    for (const [key, value] of Object.entries(input)) {
      if (!key) {
        removedKeys.push(key);
        warnings.push('Removed empty metadata key.');
        continue;
      }

      if (this.isPrototypePollutionKey(key)) {
        removedKeys.push(key);
        warnings.push(
          `Removed unsafe metadata key "${key}" to prevent prototype pollution.`,
        );
        continue;
      }

      // Only enforce canonical field conflicts at the top level of metadata.
      if (depth === 0 && reservedKeys.has(key)) {
        removedKeys.push(key);
        warnings.push(
          `Removed metadata key "${key}" because it conflicts with a canonical ${entity} field.`,
        );
        continue;
      }

      const normalizedValue = this.normalizeMetadataValue(
        value,
        entity,
        depth + 1,
        removedKeys,
        warnings,
      );

      if (normalizedValue !== undefined) {
        result[key] = normalizedValue;
      }
    }

    return result;
  }

  private normalizeMetadataValue(
    value: unknown,
    entity: MetadataEntity,
    depth: number,
    removedKeys: string[],
    warnings: string[],
  ): unknown {
    if (value === undefined) {
      // undefined is not valid JSON; drop it.
      return undefined;
    }

    if (value === null) {
      return null;
    }

    const valueType = typeof value;

    if (valueType === 'string' || valueType === 'number' || valueType === 'boolean') {
      return value;
    }

    if (value instanceof Date) {
      return value.toISOString();
    }

    if (Array.isArray(value)) {
      const normalizedArray: unknown[] = [];

      for (const item of value) {
        const normalizedItem = this.normalizeMetadataValue(
          item,
          entity,
          depth + 1,
          removedKeys,
          warnings,
        );

        if (normalizedItem !== undefined) {
          normalizedArray.push(normalizedItem);
        }
      }

      return normalizedArray;
    }

    if (valueType === 'object') {
      return this.normalizeMetadataObject(
        value as Record<string, unknown>,
        entity,
        depth,
        removedKeys,
        warnings,
      );
    }

    // Drop functions, symbols, bigint, etc.
    warnings.push(
      `Dropping non-serializable metadata value of type "${typeof value}" at depth ${depth}.`,
    );
    return undefined;
  }

  private getReservedKeys(entity: MetadataEntity): ReadonlySet<string> {
    return entity === 'case' ? CASE_RESERVED_METADATA_KEYS : TASK_RESERVED_METADATA_KEYS;
  }

  private isPrototypePollutionKey(key: string): boolean {
    return PROTOTYPE_POLLUTION_KEYS.has(key);
  }

  private logDiagnostics(
    entity: MetadataEntity,
    removedKeys: string[],
    warnings: string[],
  ): void {
    if (!removedKeys.length && !warnings.length) {
      return;
    }

    const summaryParts: string[] = [];

    if (removedKeys.length) {
      summaryParts.push(`removedKeys=[${removedKeys.join(', ')}]`);
    }

    if (warnings.length) {
      summaryParts.push(`warnings=${warnings.length}`);
    }

    this.logger.debug(
      `Metadata normalization for ${entity}: ${summaryParts.join(' ')}.`,
    );

    for (const warning of warnings) {
      this.logger.debug(`Metadata normalization warning: ${warning}`);
    }
  }
}

===== END apps/api/src/orgo/core/validation/metadata.service.ts =====


===== BEGIN apps/api/src/orgo/core/validation/payload-validation.pipe.ts =====
// apps/api/src/orgo/core/validation/payload-validation.pipe.ts

import {
  ArgumentMetadata,
  BadRequestException,
  Injectable,
  Logger,
  PipeTransform,
} from '@nestjs/common';
import * as Joi from 'joi';

type ObjectSchema = Joi.ObjectSchema;

export type LogicalPayloadType =
  | 'task'
  | 'case'
  | 'email'
  | 'workflow_rule'
  | 'notification'
  | 'config'
  | 'generic';

export interface PayloadValidationOptions {
  /**
   * Logical payload type to drive default schemas and enum normalisation.
   * If a custom schema is provided, this is only used for error codes and enum mapping.
   */
  logicalType?: LogicalPayloadType;

  /**
   * Allow unknown keys when validating with Joi.
   * Defaults to true (unknown keys are allowed).
   */
  allowUnknown?: boolean;

  /**
   * Strip unknown keys from the validated payload.
   * Defaults to true (unknown keys are removed).
   */
  stripUnknown?: boolean;

  /**
   * Optional custom error code to emit instead of the default type‑specific one.
   */
  customErrorCode?: string;
}

/**
 * Canonical enum values (service‑side) – aligned with Docs 2, 5 and 8.
 * JSON inputs may use lower‑case variants; this pipe normalises to these tokens.
 */
const TASK_STATUS_VALUES = [
  'PENDING',
  'IN_PROGRESS',
  'ON_HOLD',
  'COMPLETED',
  'FAILED',
  'ESCALATED',
  'CANCELLED',
] as const;

const TASK_PRIORITY_VALUES = ['LOW', 'MEDIUM', 'HIGH', 'CRITICAL'] as const;

const TASK_SEVERITY_VALUES = ['MINOR', 'MODERATE', 'MAJOR', 'CRITICAL'] as const;

const VISIBILITY_VALUES = ['PUBLIC', 'INTERNAL', 'RESTRICTED', 'ANONYMISED'] as const;

const CASE_STATUS_VALUES = [
  'open',
  'in_progress',
  'resolved',
  'archived',
] as const;

const TASK_SOURCE_VALUES = ['email', 'api', 'manual', 'sync'] as const;

const ENVIRONMENT_VALUES = ['dev', 'staging', 'prod', 'offline'] as const;

/**
 * Default Joi schema for canonical Task JSON payloads
 * (Doc 5 – Task Handler, Doc 8 – Task JSON schema).
 *
 * This is intentionally focused on core fields; domain‑specific metadata
 * lives under `metadata` and is validated separately if needed.
 */
const TASK_PAYLOAD_SCHEMA: ObjectSchema = Joi.object({
  task_id: Joi.string().optional(), // usually set by the system
  organization_id: Joi.string().required(),
  case_id: Joi.string().optional().allow(null),

  source: Joi.string()
    .valid(...TASK_SOURCE_VALUES)
    .required(),

  type: Joi.string().required(), // e.g. "maintenance", "hr_case"
  category: Joi.string()
    .valid('request', 'incident', 'update', 'report', 'distribution')
    .required(),
  subtype: Joi.string().optional().allow(null),

  label: Joi.string().required(), // "<BASE>.<CATEGORY><SUBCATEGORY>.<HORIZONTAL_ROLE>"
  title: Joi.string().max(512).required(),
  description: Joi.string().required(),

  status: Joi.string()
    .valid(...TASK_STATUS_VALUES)
    .optional(), // default = PENDING inside the Task handler

  priority: Joi.string()
    .valid(...TASK_PRIORITY_VALUES)
    .required(),
  severity: Joi.string()
    .valid(...TASK_SEVERITY_VALUES)
    .required(),
  visibility: Joi.string()
    .valid(...VISIBILITY_VALUES)
    .required(),

  assignee_role: Joi.string().optional().allow(null),
  created_by_user_id: Joi.string().optional().allow(null),
  requester_person_id: Joi.string().optional().allow(null),
  owner_role_id: Joi.string().optional().allow(null),
  owner_user_id: Joi.string().optional().allow(null),

  due_at: Joi.string().optional().allow(null),
  reactivity_time: Joi.string().optional().allow(null),
  reactivity_deadline_at: Joi.string().optional().allow(null),
  escalation_level: Joi.number().integer().min(0).optional(),
  closed_at: Joi.string().optional().allow(null),

  metadata: Joi.object().default({}),
});

/**
 * Default Joi schema for canonical Case JSON payloads
 * (Doc 8 – Case JSON schema).
 */
const CASE_PAYLOAD_SCHEMA: ObjectSchema = Joi.object({
  case_id: Joi.string().optional(), // usually set by the system
  organization_id: Joi.string().required(),

  source_type: Joi.string()
    .valid(...TASK_SOURCE_VALUES)
    .required(),
  source_reference: Joi.string().optional().allow(null),

  label: Joi.string().required(),
  title: Joi.string().max(512).required(),
  description: Joi.string().required(),

  status: Joi.string()
    .valid(...CASE_STATUS_VALUES)
    .optional(), // default = "open" in the Case service

  // Uses the same severity enum as Tasks, but normalised to uppercase internally.
  severity: Joi.string()
    .valid(...TASK_SEVERITY_VALUES)
    .required(),

  reactivity_time: Joi.string().optional().allow(null),
  origin_vertical_level: Joi.number().integer().optional().allow(null),
  origin_role: Joi.string().optional().allow(null),

  tags: Joi.array().items(Joi.string()).optional().allow(null),
  location: Joi.object().optional().allow(null),
  metadata: Joi.object().required(),

  created_at: Joi.string().optional().allow(null),
  updated_at: Joi.string().optional().allow(null),
});

@Injectable()
export class PayloadValidationPipe implements PipeTransform {
  private readonly logger = new Logger(PayloadValidationPipe.name);

  constructor(
    private readonly schema?: ObjectSchema,
    private readonly options: PayloadValidationOptions = {},
  ) {}

  /**
   * Factory for Task payload validation.
   */
  static forTaskPayload(
    options: Omit<PayloadValidationOptions, 'logicalType'> = {},
  ): PayloadValidationPipe {
    return new PayloadValidationPipe(TASK_PAYLOAD_SCHEMA, {
      logicalType: 'task',
      ...options,
    });
  }

  /**
   * Factory for Case payload validation.
   */
  static forCasePayload(
    options: Omit<PayloadValidationOptions, 'logicalType'> = {},
  ): PayloadValidationPipe {
    return new PayloadValidationPipe(CASE_PAYLOAD_SCHEMA, {
      logicalType: 'case',
      ...options,
    });
  }

  transform(value: unknown, metadata: ArgumentMetadata): any {
    // Only validate request bodies by default; params/query can use other pipes.
    if (metadata.type && metadata.type !== 'body') {
      return value;
    }

    if (value === null || value === undefined) {
      throw this.buildException('Request body must be a JSON object', []);
    }

    if (typeof value !== 'object') {
      throw this.buildException('Request body must be a JSON object', []);
    }

    const logicalType = this.options.logicalType ?? 'generic';

    // Clone & normalise enums and other canonical fields.
    const normalised = this.normalisePayload(
      Array.isArray(value) ? [...value] : { ...(value as Record<string, any>) },
    );

    const schemaToUse = this.schema ?? this.getDefaultSchema(logicalType);

    if (!schemaToUse) {
      // No schema configured – still return the normalised payload.
      return normalised;
    }

    const allowUnknown =
      this.options.allowUnknown !== undefined ? this.options.allowUnknown : true;
    const stripUnknown =
      this.options.stripUnknown !== undefined ? this.options.stripUnknown : true;

    const { error, value: validated } = schemaToUse.validate(normalised, {
      abortEarly: false,
      allowUnknown,
      stripUnknown,
    });

    if (error) {
      this.logger.error(
        `Payload validation failed for type "${logicalType}": ${error.message}`,
      );
      throw this.buildException('Payload validation failed', error.details);
    }

    return validated;
  }

  /**
   * Returns a default schema for a given logical payload type
   * when no explicit schema is provided in the constructor.
   */
  private getDefaultSchema(type: LogicalPayloadType): ObjectSchema | undefined {
    switch (type) {
      case 'task':
        return TASK_PAYLOAD_SCHEMA;
      case 'case':
        return CASE_PAYLOAD_SCHEMA;
      default:
        return undefined;
    }
  }

  /**
   * Normalise canonical enums and structurally relevant fields
   * according to Docs 2, 5 and 8.
   *
   * It is safe to call recursively on nested objects/arrays.
   */
  private normalisePayload<T = any>(payload: T): T {
    if (payload === null || payload === undefined) {
      return payload;
    }

    if (Array.isArray(payload)) {
      return payload.map((item) => this.normalisePayload(item)) as unknown as T;
    }

    if (typeof payload !== 'object') {
      return payload;
    }

    const obj = payload as Record<string, any>;

    for (const key of Object.keys(obj)) {
      const value = obj[key];

      if (value === null || value === undefined) {
        continue;
      }

      if (Array.isArray(value) || typeof value === 'object') {
        obj[key] = this.normalisePayload(value);
        continue;
      }

      if (typeof value === 'string') {
        obj[key] = this.normaliseScalarByKey(key, value);
      }
    }

    return obj as T;
  }

  /**
   * Field‑aware normalisation for scalar string values.
   * Handles enum casing, environment values and label trimming.
   */
  private normaliseScalarByKey(key: string, raw: string): string {
    const value = raw.trim();

    switch (key) {
      case 'status': {
        const upper = value.toUpperCase();
        if (TASK_STATUS_VALUES.includes(upper as any)) {
          return upper;
        }
        const lower = value.toLowerCase();
        if (CASE_STATUS_VALUES.includes(lower as any)) {
          return lower;
        }
        return value;
      }

      case 'priority': {
        const upper = value.toUpperCase();
        if (TASK_PRIORITY_VALUES.includes(upper as any)) {
          return upper;
        }
        return value;
      }

      case 'severity': {
        const upper = value.toUpperCase();
        if (TASK_SEVERITY_VALUES.includes(upper as any)) {
          return upper;
        }
        return value;
      }

      case 'visibility': {
        const upper = value.toUpperCase();
        if (VISIBILITY_VALUES.includes(upper as any)) {
          return upper;
        }
        return value;
      }

      case 'environment': {
        const lower = value.toLowerCase();
        if (ENVIRONMENT_VALUES.includes(lower as any)) {
          return lower;
        }
        return value;
      }

      case 'source':
      case 'source_type': {
        const lower = value.toLowerCase();
        if (TASK_SOURCE_VALUES.includes(lower as any)) {
          return lower;
        }
        return value;
      }

      case 'label': {
        // Canonical labels must be whitespace‑trimmed; we do not alter structure here.
        return value;
      }

      default:
        return value;
    }
  }

  /**
   * Build a BadRequestException using the standard result shape
   * (`ok` / `data` / `error`) expected by Core Services.
   */
  private buildException(message: string, details: Joi.ValidationErrorItem[]): BadRequestException {
    const logicalType = this.options.logicalType ?? 'generic';

    const defaultErrorCode = (() => {
      switch (logicalType) {
        case 'task':
          return 'TASK_VALIDATION_ERROR';
        case 'case':
          return 'CASE_VALIDATION_ERROR';
        case 'email':
          return 'EMAIL_VALIDATION_ERROR';
        case 'workflow_rule':
          return 'WORKFLOW_RULE_VALIDATION_ERROR';
        case 'notification':
          return 'NOTIFICATION_PAYLOAD_VALIDATION_ERROR';
        case 'config':
          return 'CONFIG_VALIDATION_ERROR';
        default:
          return 'PAYLOAD_VALIDATION_ERROR';
      }
    })();

    const errorCode = this.options.customErrorCode ?? defaultErrorCode;

    const formattedDetails = details.map((d) => ({
      path: d.path.join('.'),
      message: d.message,
      type: d.type,
      context: d.context,
    }));

    const responseBody = {
      ok: false,
      data: null,
      error: {
        code: errorCode,
        message,
        details: formattedDetails,
      },
    };

    return new BadRequestException(responseBody);
  }
}

===== END apps/api/src/orgo/core/validation/payload-validation.pipe.ts =====


===== BEGIN apps/api/src/orgo/core/workflow/escalation.service.ts =====
import { Injectable } from '@nestjs/common';

import { PrismaService } from '../../../persistence/prisma/prisma.service';
import { TaskService } from '../tasks/task.service';
import { NotifierService } from '../notifications/notification.service';
import { LogService } from '../logging/log.service';
import { FN_ESCALATION_EVALUATE } from '../functional-ids';

/**
 * Standard result shape for core services.
 */
export interface Result<T> {
  ok: boolean;
  data?: T;
  error?: {
    code: string;
    message: string;
    details?: unknown;
  };
}

/**
 * Options for running escalation evaluation.
 */
export interface EvaluateEscalationsOptions {
  organizationId?: string;
  /**
   * Optional override for "now", mainly for tests.
   */
  now?: Date;
  /**
   * Max number of overdue tasks to process in one run.
   */
  limitTasks?: number;
  /**
   * Max number of escalation instances to process in one run.
   */
  limitInstances?: number;
}

/**
 * Summary of what the escalation evaluation did.
 */
export interface EscalationEvaluationResult {
  processedTasks: number;
  escalatedTasks: number;
  processedInstances: number;
  advancedInstances: number;
}

/**
 * Unresolved task statuses: eligible for escalation.
 */
const UNRESOLVED_STATUSES: readonly string[] = [
  'PENDING',
  'IN_PROGRESS',
  'ON_HOLD',
  'ESCALATED',
];

/**
 * Escalation instance runtime status.
 */
export type EscalationInstanceStatus =
  | 'idle'
  | 'scheduled'
  | 'in_progress'
  | 'completed'
  | 'cancelled';

/**
 * Escalation actions that can be taken at each step.
 */
export type EscalationActionType =
  | 'notify_role'
  | 'notify_user'
  | 'auto_reassign'
  | 'auto_close'
  | 'raise_severity';

export interface EscalationStepAction {
  type: EscalationActionType;
  targetRoleId?: string;
  targetUserId?: string;
  /**
   * Notification channel when notifying.
   */
  channel?: 'email' | 'in_app';
  /**
   * For raise_severity.
   */
  newSeverity?: string;
  /**
   * Arbitrary additional payload for the action.
   */
  payload?: Record<string, unknown>;
}

export interface EscalationStep {
  /**
   * Relative delay (seconds) from when this step is executed to the next one.
   */
  delaySeconds: number;
  actions: EscalationStepAction[];
}

export interface EscalationPolicyDefinition {
  steps: EscalationStep[];
}

/**
 * Workflow escalation service.
 *
 * Invoked by background job "orgo.workflow.check-escalations".
 * Responsibilities:
 * - Escalate overdue tasks based on reactivity_deadline_at.
 * - Advance multi-step escalation instances backed by escalation_policies.
 * - Record escalation events and log structured entries.
 */
@Injectable()
export class EscalationService {
  constructor(
    private readonly prisma: PrismaService,
    private readonly taskService: TaskService,
    private readonly notifier: NotifierService,
    private readonly logService: LogService,
  ) {}

  async evaluateEscalations(
    options: EvaluateEscalationsOptions = {},
  ): Promise<Result<EscalationEvaluationResult>> {
    const now = options.now ?? new Date();
    const limitTasks = options.limitTasks ?? 500;
    const limitInstances = options.limitInstances ?? 500;

    try {
      const overdueTasks = await this.findOverdueTasks(
        now,
        options.organizationId,
        limitTasks,
      );

      let escalatedTasks = 0;

      for (const task of overdueTasks) {
        const escalated = await this.handleOverdueTask(task, now);
        if (escalated) {
          escalatedTasks += 1;
        }
      }

      const dueInstances = await this.findDueEscalationInstances(
        now,
        options.organizationId,
        limitInstances,
      );

      let advancedInstances = 0;

      for (const instance of dueInstances) {
        const advanced = await this.handleEscalationInstance(instance, now);
        if (advanced) {
          advancedInstances += 1;
        }
      }

      const result: EscalationEvaluationResult = {
        processedTasks: overdueTasks.length,
        escalatedTasks,
        processedInstances: dueInstances.length,
        advancedInstances,
      };

      await this.logService.logEvent({
        category: 'WORKFLOW',
        level: 'INFO',
        message: 'Escalation evaluation completed',
        identifier: FN_ESCALATION_EVALUATE,
        metadata: {
          ...result,
          organizationId: options.organizationId ?? null,
        },
      });

      return { ok: true, data: result };
    } catch (error) {
      await this.logService.logEvent({
        category: 'WORKFLOW',
        level: 'ERROR',
        message: 'Escalation evaluation failed',
        identifier: FN_ESCALATION_EVALUATE,
        metadata: {
          organizationId: options.organizationId ?? null,
          error:
            error instanceof Error
              ? { name: error.name, message: error.message }
              : String(error),
        },
      });

      return {
        ok: false,
        error: {
          code: 'ESCALATION_EVALUATION_ERROR',
          message: 'Failed to evaluate escalations',
          details:
            error instanceof Error
              ? { name: error.name, message: error.message }
              : String(error),
        },
      };
    }
  }

  /**
   * Find unresolved tasks whose reactivity_deadline_at has passed.
   */
  private async findOverdueTasks(
    now: Date,
    organizationId?: string,
    limit = 500,
  ) {
    return this.prisma.task.findMany({
      where: {
        ...(organizationId ? { organizationId } : {}),
        status: { in: UNRESOLVED_STATUSES as string[] },
        reactivityDeadlineAt: {
          lte: now,
        },
      },
      take: limit,
    });
  }

  /**
   * Escalate a single overdue task via TaskService and notify stakeholders.
   */
  private async handleOverdueTask(task: any, now: Date): Promise<boolean> {
    if (!task.reactivityDeadlineAt || task.reactivityDeadlineAt > now) {
      return false;
    }
    if (!UNRESOLVED_STATUSES.includes(task.status)) {
      return false;
    }

    const result = await this.taskService.escalateTask(task.id, {
      reason: 'Reactivity deadline exceeded',
      triggeredAt: now,
    });

    if (!result?.ok) {
      await this.logService.logEvent({
        category: 'WORKFLOW',
        level: 'ERROR',
        message: 'Failed to escalate overdue task',
        identifier: FN_ESCALATION_EVALUATE,
        metadata: {
          taskId: task.id,
          organizationId: task.organizationId,
          error: result?.error ?? null,
        },
      });
      return false;
    }

    await this.notifier.sendTaskNotification({
      taskId: task.id,
      organizationId: task.organizationId,
      eventType: 'ESCALATED',
      payload: {
        source: 'reactivity_deadline',
        triggeredAt: now.toISOString(),
      },
    });

    return true;
  }

  /**
   * Find escalation instances whose next step is due.
   */
  private async findDueEscalationInstances(
    now: Date,
    organizationId?: string,
    limit = 500,
  ) {
    return this.prisma.escalationInstance.findMany({
      where: {
        status: { in: ['scheduled', 'in_progress'] as EscalationInstanceStatus[] },
        nextFireAt: {
          lte: now,
        },
        ...(organizationId
          ? {
              task: {
                organizationId,
              },
            }
          : {}),
      },
      take: limit,
      include: {
        task: true,
        policy: true,
      },
    });
  }

  /**
   * Advance a single escalation instance according to its policy definition.
   */
  private async handleEscalationInstance(
    instance: any,
    now: Date,
  ): Promise<boolean> {
    const { task, policy } = instance;

    if (!task) {
      return false;
    }

    // If task is no longer unresolved, cancel the instance.
    if (!UNRESOLVED_STATUSES.includes(task.status)) {
      await this.markInstanceCompleted(instance.id, 'cancelled', now);
      return false;
    }

    if (!policy || !policy.definition) {
      // No policy definition → nothing to do; mark as completed to avoid loops.
      await this.markInstanceCompleted(instance.id, 'completed', now);
      return false;
    }

    const definition = policy.definition as EscalationPolicyDefinition;
    const steps: EscalationStep[] = definition.steps ?? [];
    const nextIndex: number = (instance.currentStepIndex ?? -1) + 1;

    if (nextIndex >= steps.length) {
      await this.markInstanceCompleted(instance.id, 'completed', now);
      return false;
    }

    const step = steps[nextIndex];
    let anyActionSucceeded = false;

    for (const action of step.actions ?? []) {
      const success = await this.executeEscalationAction(
        action,
        task,
        instance,
        now,
        nextIndex,
      );
      anyActionSucceeded = anyActionSucceeded || success;

      await this.prisma.escalationEvent.create({
        data: {
          escalationInstanceId: instance.id,
          taskId: task.id,
          stepIndex: nextIndex,
          actionType: action.type,
          actionPayload: action,
          executedAt: now,
          success,
          errorMessage: success ? null : 'Escalation action failed',
        },
      });
    }

    const hasMoreSteps = nextIndex + 1 < steps.length;
    await this.prisma.escalationInstance.update({
      where: { id: instance.id },
      data: {
        currentStepIndex: nextIndex,
        status: hasMoreSteps ? ('scheduled' as EscalationInstanceStatus) : 'completed',
        nextFireAt: hasMoreSteps
          ? new Date(now.getTime() + steps[nextIndex + 1].delaySeconds * 1000)
          : null,
        completedAt: hasMoreSteps ? null : now,
      },
    });

    return anyActionSucceeded;
  }

  private async markInstanceCompleted(
    id: string,
    status: 'completed' | 'cancelled',
    at: Date,
  ): Promise<void> {
    await this.prisma.escalationInstance.update({
      where: { id },
      data: {
        status,
        completedAt: at,
        nextFireAt: null,
      },
    });
  }

  /**
   * Execute one escalation action against a task.
   */
  private async executeEscalationAction(
    action: EscalationStepAction,
    task: any,
    instance: any,
    now: Date,
    stepIndex: number,
  ): Promise<boolean> {
    try {
      switch (action.type) {
        case 'notify_role':
        case 'notify_user': {
          await this.notifier.sendTaskNotification({
            taskId: task.id,
            organizationId: task.organizationId,
            eventType: 'ESCALATED',
            payload: {
              escalationInstanceId: instance.id,
              stepIndex,
              targetRoleId: action.targetRoleId,
              targetUserId: action.targetUserId,
              channel: action.channel,
              payload: action.payload ?? {},
            },
          });
          break;
        }

        case 'auto_reassign': {
          if (action.targetRoleId || action.targetUserId) {
            await this.taskService.reassignTask(task.id, {
              targetRoleId: action.targetRoleId,
              targetUserId: action.targetUserId,
              reason: 'Escalation auto_reassign',
              triggeredAt: now,
            });
          }
          break;
        }

        case 'auto_close': {
          await this.taskService.updateTaskStatus(task.id, 'COMPLETED', {
            reason: 'Escalation auto_close',
            triggeredAt: now,
          });
          break;
        }

        case 'raise_severity': {
          if (action.newSeverity) {
            await this.taskService.updateTaskSeverity(task.id, action.newSeverity, {
              reason: 'Escalation raise_severity',
              triggeredAt: now,
            });
          }
          break;
        }

        default: {
          await this.logService.logEvent({
            category: 'WORKFLOW',
            level: 'WARNING',
            message: 'Unknown escalation action type',
            identifier: FN_ESCALATION_EVALUATE,
            metadata: {
              taskId: task.id,
              action,
            },
          });
          break;
        }
      }

      return true;
    } catch (error) {
      await this.logService.logEvent({
        category: 'WORKFLOW',
        level: 'ERROR',
        message: 'Escalation action execution failed',
        identifier: FN_ESCALATION_EVALUATE,
        metadata: {
          taskId: task.id,
          action,
          error:
            error instanceof Error
              ? { name: error.name, message: error.message }
              : String(error),
        },
      });
      return false;
    }
  }
}

===== END apps/api/src/orgo/core/workflow/escalation.service.ts =====


===== BEGIN apps/api/src/orgo/core/workflow/workflow-engine.service.ts =====
import { Injectable, Logger, OnModuleInit } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import * as fs from 'fs';
import * as path from 'path';
import * as yaml from 'js-yaml';

const fsPromises = fs.promises;

const TASK_CATEGORIES = ['request', 'incident', 'update', 'report', 'distribution'] as const;
type TaskCategory = (typeof TASK_CATEGORIES)[number];

const TASK_SEVERITIES = ['MINOR', 'MODERATE', 'MAJOR', 'CRITICAL'] as const;
type TaskSeverity = (typeof TASK_SEVERITIES)[number];

const WORKFLOW_EVENT_SOURCES = ['EMAIL', 'API', 'SYSTEM', 'TIMER'] as const;
type WorkflowEventSource = (typeof WORKFLOW_EVENT_SOURCES)[number];

const WORKFLOW_ACTION_TYPES = [
  'CREATE_TASK',
  'UPDATE_TASK',
  'ROUTE',
  'ESCALATE',
  'ATTACH_TEMPLATE',
  'SET_METADATA',
  'NOTIFY',
] as const;
type WorkflowActionType = (typeof WORKFLOW_ACTION_TYPES)[number];

export interface WorkflowMatchCriteria {
  source?: WorkflowEventSource;
  /**
   * Domain-level type, e.g. "maintenance", "hr_case" (maps to Task.type)
   */
  type?: string;
  /**
   * Global Task.category (request | incident | update | report | distribution)
   */
  category?: TaskCategory;
  /**
   * Canonical severity enum (MINOR | MODERATE | MAJOR | CRITICAL)
   */
  severity?: TaskSeverity;
  /**
   * Numeric base of canonical label (e.g. 10, 100, 1000, 11, 101, ...)
   */
  labelBase?: number;
  /**
   * String prefix for label matching (e.g. "100.94.")
   */
  labelPrefix?: string;
  /**
   * At least one of these must appear in searchable text (case-insensitive)
   */
  keywordsAny?: string[];
  /**
   * All of these must appear in searchable text (case-insensitive)
   */
  keywordsAll?: string[];
  /**
   * Reserved for future metadata-based matching
   */
  metadata?: Record<string, unknown>;
}

export interface WorkflowAction {
  /**
   * Action type (CREATE_TASK, UPDATE_TASK, ROUTE, ESCALATE, ATTACH_TEMPLATE, SET_METADATA, NOTIFY)
   */
  type: WorkflowActionType | string;
  /**
   * Other keys depend on action type (set, to_role, channel, template_id, etc.)
   */
  [key: string]: any;
}

export interface WorkflowRule {
  id: string;
  version: string;
  description?: string;
  /**
   * Matching criteria; any unspecified field is treated as "no constraint"
   */
  match: WorkflowMatchCriteria;
  /**
   * Ordered list of actions to emit when rule matches
   */
  actions: WorkflowAction[];
  /**
   * Disabled rules are ignored at runtime
   */
  enabled: boolean;
  /**
   * Source file on disk (for debugging and validation reporting)
   */
  sourceFile?: string;
}

export interface WorkflowContext {
  organizationId: string;
  /**
   * Workflow event source: EMAIL | API | SYSTEM | TIMER
   * (This is distinct from task_source_enum: email | api | manual | sync.)
   */
  source: WorkflowEventSource;

  /**
   * Domain-level type (Task.type), e.g. "maintenance", "hr_case"
   */
  type?: string;

  /**
   * Global Task.category (request | incident | update | report | distribution)
   */
  category?: string;

  /**
   * Severity string; normalised against TASK_SEVERITY (MINOR | MODERATE | MAJOR | CRITICAL)
   */
  severity?: string;

  /**
   * Canonical label for Case/Task, e.g. "100.94.Operations.Safety"
   */
  label?: string;

  /**
   * Human title / summary (Task.title / Case.title / email subject)
   */
  title?: string;

  /**
   * Human description/body (Task.description / Case.description)
   */
  description?: string;

  /**
   * Parsed email subject (for EMAIL sources)
   */
  emailSubject?: string;

  /**
   * Parsed plain-text email body (for EMAIL sources)
   */
  emailTextBody?: string;

  /**
   * Arbitrary metadata associated with the event/context
   */
  metadata?: Record<string, unknown>;

  /**
   * Raw payload for the event (email envelope, API body, etc.)
   */
  payload?: Record<string, unknown>;
}

export interface ResolvedWorkflowAction {
  ruleId: string;
  ruleVersion: string;
  actionIndex: number;
  action: WorkflowAction;
}

export interface WorkflowExecutionResultData {
  context: WorkflowContext;
  matchedRules: WorkflowRule[];
  actions: ResolvedWorkflowAction[];
}

export interface WorkflowRuleValidationError {
  ruleId: string;
  sourceFile?: string;
  message: string;
  /**
   * JSONPath-like hint into the rule, e.g. "match.category", "actions[0].type"
   */
  path?: string;
}

export interface WorkflowEngineError {
  code: string;
  message: string;
  details?: Record<string, unknown>;
}

export interface WorkflowEngineResult<T> {
  ok: boolean;
  data: T | null;
  error: WorkflowEngineError | null;
}

/**
 * WorkflowEngineService
 *
 * Core service that:
 * - Loads workflow rule definitions from the filesystem.
 * - Validates rule structure and canonical enum usage.
 * - Evaluates rules against a WorkflowContext and emits an ordered list of actions.
 *
 * Side effects (creating tasks, routing, notifications, etc.) are performed by callers
 * using the returned actions; this service is intentionally pure in that sense.
 */
@Injectable()
export class WorkflowEngineService implements OnModuleInit {
  private readonly logger = new Logger(WorkflowEngineService.name);
  private readonly rulesDirectory: string;

  private rules: WorkflowRule[] = [];
  private loadedAt: Date | null = null;

  constructor(private readonly configService: ConfigService) {
    // Allow override via env; default to ../../config/workflows relative to apps/api
    const envDir =
      this.configService.get<string>('WORKFLOW_RULES_DIR') ??
      this.configService.get<string>('ORGO_WORKFLOW_RULES_DIR');

    const defaultDir = path.resolve(process.cwd(), '..', '..', 'config', 'workflows');

    this.rulesDirectory = envDir || defaultDir;
  }

  async onModuleInit(): Promise<void> {
    await this.reloadRules();
  }

  /**
   * Reload rules from disk and validate them.
   * Intended for startup and for administrative hot-reload.
   */
  async reloadRules(): Promise<void> {
    try {
      const rules = await this.loadRulesFromDisk();
      this.rules = rules;
      this.loadedAt = new Date();

      const validation = this.internalValidateRules(rules);

      if (!validation.valid) {
        this.logger.error(
          `Workflow rules loaded with ${validation.ruleErrors.length} validation error(s).`,
        );
        for (const err of validation.ruleErrors) {
          this.logger.error(
            `[${err.ruleId}] ${err.message}` +
              (err.path ? ` (path: ${err.path})` : '') +
              (err.sourceFile ? ` [${err.sourceFile}]` : ''),
          );
        }
      } else {
        this.logger.log(
          `Workflow rules loaded successfully (${rules.length} rule(s)) from ${this.rulesDirectory}.`,
        );
      }
    } catch (error: any) {
      this.logger.error(
        `Failed to load workflow rules from ${this.rulesDirectory}: ${
          error?.message ?? error
        }`,
        error?.stack,
      );
      this.rules = [];
      this.loadedAt = null;
    }
  }

  /**
   * Execute workflow rules for a given context and return the resolved actions.
   */
  async executeWorkflow(
    context: WorkflowContext,
  ): Promise<WorkflowEngineResult<WorkflowExecutionResultData>> {
    try {
      if (!this.loadedAt) {
        await this.reloadRules();
      }

      const matchedRules: WorkflowRule[] = [];
      const resolvedActions: ResolvedWorkflowAction[] = [];

      for (const rule of this.rules) {
        if (!rule.enabled) {
          continue;
        }
        if (!this.ruleMatches(rule, context)) {
          continue;
        }

        matchedRules.push(rule);

        rule.actions.forEach((action, index) => {
          resolvedActions.push({
            ruleId: rule.id,
            ruleVersion: rule.version,
            actionIndex: index,
            action,
          });
        });
      }

      this.logger.debug(
        `Workflow executed for org=${context.organizationId}, source=${context.source}. ` +
          `Matched ${matchedRules.length} rule(s), produced ${resolvedActions.length} action(s).`,
      );

      return {
        ok: true,
        data: {
          context,
          matchedRules,
          actions: resolvedActions,
        },
        error: null,
      };
    } catch (error: any) {
      this.logger.error(
        `Workflow execution failed: ${error?.message ?? error}`,
        error?.stack,
      );

      return {
        ok: false,
        data: null,
        error: {
          code: 'WORKFLOW_EXECUTION_ERROR',
          message: 'Workflow execution failed',
          details: {
            error: String(error?.message ?? error),
          },
        },
      };
    }
  }

  /**
   * Validate currently loaded rules and return structured errors.
   * Does not reload from disk by itself.
   */
  async validateWorkflowRules(): Promise<
    WorkflowEngineResult<{
      valid: boolean;
      ruleErrors: WorkflowRuleValidationError[];
    }>
  > {
    try {
      if (!this.loadedAt) {
        await this.reloadRules();
      }

      const validation = this.internalValidateRules(this.rules);

      return {
        ok: true,
        data: validation,
        error: null,
      };
    } catch (error: any) {
      this.logger.error(
        `Workflow rule validation failed: ${error?.message ?? error}`,
        error?.stack,
      );

      return {
        ok: false,
        data: null,
        error: {
          code: 'WORKFLOW_VALIDATION_ERROR',
          message: 'Workflow rule validation failed',
          details: {
            error: String(error?.message ?? error),
          },
        },
      };
    }
  }

  /**
   * Load workflow rule files from disk and normalise them to WorkflowRule objects.
   * Supports .yaml/.yml (YAML) and .json files. Files may contain a single rule
   * object or an array of rule objects.
   */
  private async loadRulesFromDisk(): Promise<WorkflowRule[]> {
    const rules: WorkflowRule[] = [];

    try {
      const dirEntries = await fsPromises.readdir(this.rulesDirectory, {
        withFileTypes: true,
      });

      const files = dirEntries.filter(
        (entry) =>
          entry.isFile() &&
          (entry.name.endsWith('.yaml') ||
            entry.name.endsWith('.yml') ||
            entry.name.endsWith('.json')),
      );

      let ruleIndex = 0;

      for (const entry of files) {
        const fullPath = path.join(this.rulesDirectory, entry.name);
        const rawContent = await fsPromises.readFile(fullPath, 'utf8');

        if (!rawContent.trim()) {
          continue;
        }

        let parsed: unknown;

        try {
          if (entry.name.endsWith('.json')) {
            parsed = JSON.parse(rawContent);
          } else {
            parsed = yaml.load(rawContent);
          }
        } catch (parseError: any) {
          this.logger.error(
            `Failed to parse workflow file ${fullPath}: ${
              parseError?.message ?? parseError
            }`,
          );
          continue;
        }

        const rawRules = Array.isArray(parsed) ? parsed : [parsed];

        for (const rawRule of rawRules) {
          if (!rawRule || typeof rawRule !== 'object') {
            continue;
          }

          const normalised = this.normaliseRawRule(
            rawRule as Record<string, unknown>,
            fullPath,
            ruleIndex++,
          );

          rules.push(normalised);
        }
      }
    } catch (error: any) {
      const code = (error as NodeJS.ErrnoException).code;
      if (code === 'ENOENT') {
        this.logger.warn(
          `Workflow rules directory does not exist: ${this.rulesDirectory}. No workflow rules loaded.`,
        );
        return [];
      }
      throw error;
    }

    return rules;
  }

  /**
   * Normalise a raw rule object (as parsed from YAML/JSON) into a WorkflowRule.
   */
  private normaliseRawRule(
    raw: Record<string, unknown>,
    sourceFile: string,
    index: number,
  ): WorkflowRule {
    const rawId = typeof raw.id === 'string' ? raw.id.trim() : '';
    const id = rawId || `${path.basename(sourceFile)}#${index}`;

    const rawVersion = typeof raw.version === 'string' ? raw.version.trim() : '';
    const version = rawVersion || '0.0.0';

    const description =
      typeof raw.description === 'string' ? raw.description.trim() : undefined;

    const enabled =
      typeof raw.enabled === 'boolean' ? raw.enabled : true;

    const rawMatch = (raw.match ?? {}) as Record<string, unknown>;
    const match = this.normaliseMatchCriteria(rawMatch);

    const rawActions = Array.isArray(raw.actions)
      ? (raw.actions as unknown[])
      : [];
    const actions = rawActions.map((a) => this.normaliseAction(a));

    return {
      id,
      version,
      description,
      enabled,
      match,
      actions,
      sourceFile,
    };
  }

  private normaliseMatchCriteria(
    raw: Record<string, unknown>,
  ): WorkflowMatchCriteria {
    const source = this.normaliseEventSource(raw.source);

    const type =
      typeof raw.type === 'string' && raw.type.trim().length > 0
        ? raw.type.trim()
        : undefined;

    const category = this.normaliseCategory(raw.category);
    const severity = this.normaliseSeverity(raw.severity);
    const labelBase = this.normaliseLabelBase(raw.label_base ?? raw.labelBase);

    const labelPrefix =
      typeof (raw.label_prefix ?? raw.labelPrefix) === 'string'
        ? String(raw.label_prefix ?? raw.labelPrefix)
        : undefined;

    const keywordsAny = this.normaliseStringArray(
      (raw.keywords_any ?? raw.keywordsAny) as unknown,
    );
    const keywordsAll = this.normaliseStringArray(
      (raw.keywords_all ?? raw.keywordsAll) as unknown,
    );

    const metadata =
      raw.metadata && typeof raw.metadata === 'object'
        ? (raw.metadata as Record<string, unknown>)
        : undefined;

    return {
      source,
      type,
      category,
      severity,
      labelBase,
      labelPrefix,
      keywordsAny,
      keywordsAll,
      metadata,
    };
  }

  private normaliseAction(raw: unknown): WorkflowAction {
    if (!raw || typeof raw !== 'object') {
      return { type: 'UNKNOWN' };
    }

    const obj = raw as Record<string, unknown>;
    const rawType = typeof obj.type === 'string' ? obj.type : 'UNKNOWN';
    const type = rawType.toUpperCase();

    return {
      ...obj,
      type,
    };
  }

  private normaliseStringArray(value: unknown): string[] | undefined {
    if (!Array.isArray(value)) {
      return undefined;
    }

    const result = value
      .map((v) => (typeof v === 'string' ? v.trim() : ''))
      .filter((v) => v.length > 0);

    return result.length > 0 ? result : undefined;
  }

  private normaliseLabelBase(value: unknown): number | undefined {
    if (typeof value === 'number' && Number.isFinite(value)) {
      return value;
    }

    const asString =
      typeof value === 'string' && value.trim().length > 0
        ? value.trim()
        : undefined;

    if (!asString) {
      return undefined;
    }

    const parsed = Number.parseInt(asString, 10);
    return Number.isFinite(parsed) ? parsed : undefined;
  }

  private normaliseEventSource(value: unknown): WorkflowEventSource | undefined {
    if (typeof value !== 'string') {
      return undefined;
    }

    const upper = value.toUpperCase();
    const match = WORKFLOW_EVENT_SOURCES.find(
      (s) => s.toUpperCase() === upper,
    );

    return match;
  }

  private normaliseCategory(value: unknown): TaskCategory | undefined {
    if (typeof value !== 'string') {
      return undefined;
    }

    const lower = value.toLowerCase();
    const match = TASK_CATEGORIES.find((c) => c.toLowerCase() === lower);

    return match;
  }

  private normaliseSeverity(value: unknown): TaskSeverity | undefined {
    if (typeof value !== 'string') {
      return undefined;
    }

    const upper = value.toUpperCase();
    const match = TASK_SEVERITIES.find((s) => s === upper);

    return match;
  }

  /**
   * Core matching logic for a single rule against a given context.
   */
  private ruleMatches(rule: WorkflowRule, context: WorkflowContext): boolean {
    const { match } = rule;

    if (match.source) {
      const ctxSource = this.normaliseEventSource(context.source);
      if (!ctxSource || ctxSource !== match.source) {
        return false;
      }
    }

    if (match.type) {
      if (!context.type || context.type !== match.type) {
        return false;
      }
    }

    if (match.category) {
      const ctxCategory = this.normaliseCategory(context.category);
      if (!ctxCategory || ctxCategory !== match.category) {
        return false;
      }
    }

    if (match.severity) {
      const ctxSeverity = this.normaliseSeverity(context.severity);
      if (!ctxSeverity || ctxSeverity !== match.severity) {
        return false;
      }
    }

    if (typeof match.labelBase === 'number') {
      const ctxLabelBase = this.extractLabelBase(context.label);
      if (ctxLabelBase === undefined || ctxLabelBase !== match.labelBase) {
        return false;
      }
    }

    if (match.labelPrefix) {
      if (!context.label || !context.label.startsWith(match.labelPrefix)) {
        return false;
      }
    }

    const haystack = this.buildSearchableText(context);

    if (match.keywordsAny && match.keywordsAny.length > 0) {
      const anyMatched = match.keywordsAny.some((kw) =>
        haystack.includes(kw.toLowerCase()),
      );
      if (!anyMatched) {
        return false;
      }
    }

    if (match.keywordsAll && match.keywordsAll.length > 0) {
      const allMatched = match.keywordsAll.every((kw) =>
        haystack.includes(kw.toLowerCase()),
      );
      if (!allMatched) {
        return false;
      }
    }

    // metadata-based matching can be added here in future without changing the public API.
    return true;
  }

  private extractLabelBase(label: string | undefined): number | undefined {
    if (!label) {
      return undefined;
    }

    const [basePart] = label.split('.', 1);
    const parsed = Number.parseInt(basePart, 10);

    return Number.isFinite(parsed) ? parsed : undefined;
  }

  /**
   * Build a lowercase concatenated text representation used for keyword matching.
   */
  private buildSearchableText(context: WorkflowContext): string {
    const parts: string[] = [];

    if (context.title) {
      parts.push(context.title);
    }

    if (context.description) {
      parts.push(context.description);
    }

    if (context.emailSubject) {
      parts.push(context.emailSubject);
    }

    if (context.emailTextBody) {
      parts.push(context.emailTextBody);
    }

    if (context.metadata) {
      try {
        parts.push(JSON.stringify(context.metadata));
      } catch {
        // ignore serialization errors
      }
    }

    if (context.payload) {
      try {
        parts.push(JSON.stringify(context.payload));
      } catch {
        // ignore serialization errors
      }
    }

    return parts.join(' ').toLowerCase();
  }

  /**
   * Internal validator for WorkflowRule objects.
   */
  private internalValidateRules(
    rules: WorkflowRule[],
  ): { valid: boolean; ruleErrors: WorkflowRuleValidationError[] } {
    const errors: WorkflowRuleValidationError[] = [];

    for (const rule of rules) {
      if (!rule.id || rule.id.trim().length === 0) {
        errors.push({
          ruleId: rule.id,
          sourceFile: rule.sourceFile,
          message: 'Rule id is required',
          path: 'id',
        });
      }

      if (!rule.version || rule.version.trim().length === 0) {
        errors.push({
          ruleId: rule.id,
          sourceFile: rule.sourceFile,
          message: 'Rule version is required',
          path: 'version',
        });
      }

      if (!rule.actions || rule.actions.length === 0) {
        errors.push({
          ruleId: rule.id,
          sourceFile: rule.sourceFile,
          message: 'Rule must have at least one action',
          path: 'actions',
        });
      }

      if (rule.match.category && !TASK_CATEGORIES.includes(rule.match.category)) {
        errors.push({
          ruleId: rule.id,
          sourceFile: rule.sourceFile,
          message: `Invalid category '${rule.match.category}'`,
          path: 'match.category',
        });
      }

      if (rule.match.severity && !TASK_SEVERITIES.includes(rule.match.severity)) {
        errors.push({
          ruleId: rule.id,
          sourceFile: rule.sourceFile,
          message: `Invalid severity '${rule.match.severity}'`,
          path: 'match.severity',
        });
      }

      if (rule.match.source && !WORKFLOW_EVENT_SOURCES.includes(rule.match.source)) {
        errors.push({
          ruleId: rule.id,
          sourceFile: rule.sourceFile,
          message: `Invalid source '${rule.match.source}'`,
          path: 'match.source',
        });
      }

      rule.actions.forEach((action, index) => {
        const type = typeof action.type === 'string' ? action.type : 'UNKNOWN';

        if (!WORKFLOW_ACTION_TYPES.includes(type as WorkflowActionType)) {
          errors.push({
            ruleId: rule.id,
            sourceFile: rule.sourceFile,
            message: `Unknown action type '${type}'`,
            path: `actions[${index}].type`,
          });
        }

        if (type === 'CREATE_TASK') {
          if (typeof action.set !== 'object' || action.set === null) {
            errors.push({
              ruleId: rule.id,
              sourceFile: rule.sourceFile,
              message: 'CREATE_TASK action must have a non-empty "set" object',
              path: `actions[${index}].set`,
            });
          }
        }

        if (type === 'ROUTE') {
          if (
            typeof action.to_role !== 'string' &&
            typeof (action as any).toRole !== 'string'
          ) {
            errors.push({
              ruleId: rule.id,
              sourceFile: rule.sourceFile,
              message:
                'ROUTE action must specify "to_role" (or "toRole") as a string',
              path: `actions[${index}].to_role`,
            });
          }
        }

        if (type === 'NOTIFY') {
          if (typeof action.channel !== 'string') {
            errors.push({
              ruleId: rule.id,
              sourceFile: rule.sourceFile,
              message: 'NOTIFY action must specify "channel" as a string',
              path: `actions[${index}].channel`,
            });
          }
        }
      });
    }

    return {
      valid: errors.length === 0,
      ruleErrors: errors,
    };
  }
}

===== END apps/api/src/orgo/core/workflow/workflow-engine.service.ts =====


===== BEGIN apps/api/src/orgo/core/workflow/workflow.controller.ts =====
import {
  Body,
  Controller,
  HttpCode,
  HttpStatus,
  Param,
  Post,
} from '@nestjs/common';
import {
  ApiBadRequestResponse,
  ApiBody,
  ApiOkResponse,
  ApiOperation,
  ApiParam,
  ApiTags,
} from '@nestjs/swagger';
import { WorkflowEngineService } from './workflow-engine.service';

/**
 * Standard result shape used across Core Services.
 * Mirrors the spec in Core Services doc (ok / data / error).
 */
export interface StandardResult<TData> {
  ok: boolean;
  data: TData | null;
  error: {
    code: string;
    message: string;
    // Extra details (validation errors, offending fields, etc.)
    details?: Record<string, unknown>;
  } | null;
}

/**
 * Allowed workflow event sources (NOT the task_source_enum).
 * Matches spec: EMAIL | API | SYSTEM | TIMER.
 */
export type WorkflowExecutionSource = 'EMAIL' | 'API' | 'SYSTEM' | 'TIMER';

/**
 * Context passed to the workflow engine from the controller.
 * This is the “logical context” described in the Core Services spec:
 * includes organization_id, source and any additional data needed
 * to evaluate rules (task/case references, signal payloads, etc.).
 */
export interface WorkflowExecuteContext {
  workflowId: string;
  organizationId: string;
  source: WorkflowExecutionSource;
  /**
   * Arbitrary context for the workflow:
   * - task / case JSON
   * - signal payload
   * - email envelope
   * - domain-specific hints
   */
  context?: Record<string, unknown>;
}

/**
 * Body of POST /api/v3/workflows/:workflowId/execute.
 * `workflowId` itself is taken from the route param; the body supplies
 * the organization, source and arbitrary context.
 */
export interface ExecuteWorkflowDto {
  /**
   * Tenant identifier; all workflow evaluation is scoped to an organization.
   */
  organizationId: string;

  /**
   * Workflow event source (EMAIL | API | SYSTEM | TIMER).
   * This is the workflow-engine source, not the DB task_source_enum.
   */
  source: WorkflowExecutionSource;

  /**
   * Optional free-form context object consumed by the workflow engine.
   * This may include task/case JSON, signal payloads, domain hints, etc.
   */
  context?: Record<string, unknown>;

  /**
   * When true, the workflow engine is invoked in “dry run” mode
   * (simulation) and must not persist side-effects.
   */
  dryRun?: boolean;
}

/**
 * Controller responsible for public Workflow API endpoints.
 *
 * Interface mapping (from Orgo v3 specs):
 * - Trigger workflow execution → WorkflowController.execute
 *   POST /api/v3/workflows/:id/execute
 */
@ApiTags('workflows')
@Controller('api/v3/workflows')
export class WorkflowController {
  constructor(
    private readonly workflowEngineService: WorkflowEngineService,
  ) {}

  /**
   * Manually trigger a workflow execution for a given workflow ID.
   *
   * Route:
   *   POST /api/v3/workflows/:workflowId/execute
   *
   * Behaviour:
   *   - When dryRun = true: calls WorkflowEngineService.simulate(...)
   *     and returns the preview of actions without side-effects.
   *   - When dryRun = false or omitted: calls
   *     WorkflowEngineService.executeWorkflow(...) and returns its result.
   *
   * Both service calls are expected to return the standard
   * { ok, data, error } result shape.
   */
  @Post(':workflowId/execute')
  @HttpCode(HttpStatus.OK)
  @ApiOperation({
    summary: 'Trigger workflow execution',
    description:
      'Manually executes a workflow definition for the given workflowId within an organization. ' +
      'Set dryRun=true to simulate without applying side-effects.',
  })
  @ApiParam({
    name: 'workflowId',
    type: String,
    description:
      'Identifier of the workflow definition to execute (as defined in workflow config).',
  })
  @ApiBody({
    description: 'Workflow execution context',
    schema: {
      type: 'object',
      required: ['organizationId', 'source'],
      properties: {
        organizationId: {
          type: 'string',
          format: 'uuid',
          description: 'Tenant / organization identifier.',
        },
        source: {
          type: 'string',
          enum: ['EMAIL', 'API', 'SYSTEM', 'TIMER'],
          description: 'Workflow event source (not the DB task_source_enum).',
        },
        context: {
          type: 'object',
          additionalProperties: true,
          nullable: true,
          description:
            'Arbitrary context object (task/case JSON, signal payload, domain hints, etc.).',
        },
        dryRun: {
          type: 'boolean',
          nullable: true,
          default: false,
          description:
            'When true, runs the workflow in simulation mode without side-effects.',
        },
      },
    },
  })
  @ApiOkResponse({
    description:
      'Workflow executed successfully. Payload shape follows the standard { ok, data, error } result format.',
  })
  @ApiBadRequestResponse({
    description:
      'Invalid input, unknown workflow, or violation of workflow validation rules. ' +
      'Error payload uses the standard { ok: false, error: { code, message, details } } shape.',
  })
  async execute(
    @Param('workflowId') workflowId: string,
    @Body() body: ExecuteWorkflowDto,
  ): Promise<StandardResult<unknown>> {
    const { organizationId, source, context, dryRun = false } = body;

    const execContext: WorkflowExecuteContext = {
      workflowId,
      organizationId,
      source,
      context,
    };

    if (dryRun) {
      // Simulation / dry-run path (no side-effects).
      return this.workflowEngineService.simulate(execContext);
    }

    // Normal execution path (caller applies side-effects according
    // to the workflow engine’s returned actions).
    return this.workflowEngineService.executeWorkflow(execContext);
  }
}

===== END apps/api/src/orgo/core/workflow/workflow.controller.ts =====


===== BEGIN apps/api/src/orgo/core/workflow/workflow.module.ts =====
import { Module, forwardRef } from '@nestjs/common';
import { PersistenceModule } from '../../../persistence/persistence.module';
import { TaskModule } from '../tasks/task.module';
import { WorkflowEngineService } from './workflow-engine.service';
import { EscalationService } from './escalation.service';
import { WorkflowController } from './workflow.controller';

@Module({
  imports: [
    PersistenceModule,
    forwardRef(() => TaskModule),
  ],
  controllers: [WorkflowController],
  providers: [WorkflowEngineService, EscalationService],
  exports: [WorkflowEngineService, EscalationService],
})
export class WorkflowModule {}

===== END apps/api/src/orgo/core/workflow/workflow.module.ts =====


===== BEGIN apps/api/src/orgo/domain/education/education.module.ts =====
import { Module } from '@nestjs/common';
import { EducationModuleService } from './education-module.service';
import { EducationController } from './education.controller';

@Module({
  controllers: [EducationController],
  providers: [EducationModuleService],
  exports: [EducationModuleService],
})
export class EducationModule {}

===== END apps/api/src/orgo/domain/education/education.module.ts =====


===== BEGIN apps/api/src/orgo/domain/hr/hr.module.ts =====
import { Module } from '@nestjs/common';
import { HrModuleService } from './hr.service';
import { HrModuleController } from './hr.controller';

/**
 * Canonical domain type used for HR Tasks (`Task.type` = "hr_case").
 * This must stay aligned with the hr_case domain module config (hr_case_module.yaml)
 * and the global domain module specification.
 */
export const HR_DOMAIN_TYPE = 'hr_case';

@Module({
  controllers: [HrModuleController],
  providers: [HrModuleService],
  exports: [HrModuleService],
})
export class HrModule {}

===== END apps/api/src/orgo/domain/hr/hr.module.ts =====


===== BEGIN apps/api/src/orgo/domain/hr/hr.service.ts =====
import { BadRequestException, Injectable } from '@nestjs/common';
import { Prisma, PrismaClient } from '@prisma/client';

/**
 * Canonical enums (aligned with Doc 2 / Doc 8)
 */
export type TaskStatus =
  | 'PENDING'
  | 'IN_PROGRESS'
  | 'ON_HOLD'
  | 'COMPLETED'
  | 'FAILED'
  | 'ESCALATED'
  | 'CANCELLED';

export type TaskPriority = 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';

export type TaskSeverity = 'MINOR' | 'MODERATE' | 'MAJOR' | 'CRITICAL';

export type Visibility = 'PUBLIC' | 'INTERNAL' | 'RESTRICTED' | 'ANONYMISED';

export type TaskSource = 'email' | 'api' | 'manual' | 'sync';

export type HrCaseStatus = 'open' | 'under_review' | 'resolved' | 'dismissed';

export type HrCaseConfidentialityLevel = 'sensitive' | 'highly_sensitive';

export type HrCaseParticipantRole =
  | 'complainant'
  | 'respondent'
  | 'witness'
  | 'advocate'
  | 'other';

/**
 * Minimal row shapes used for mapping raw SQL results.
 * These reflect the Doc 1 schema (key columns only).
 */
export interface CaseRow {
  id: string;
  organization_id: string;
  label: string;
  title: string;
  description: string;
  status: 'open' | 'in_progress' | 'resolved' | 'archived';
  severity: TaskSeverity;
  origin_vertical_level: number | null;
  origin_role: string | null;
  created_at: Date;
  updated_at: Date;
}

export interface HrCaseRow {
  id: string;
  organization_id: string;
  case_id: string;
  case_code: string;
  title: string;
  description: string;
  status: HrCaseStatus;
  confidentiality_level: HrCaseConfidentialityLevel;
  case_owner_role_id: string | null;
  case_owner_user_id: string | null;
  primary_task_id: string | null;
  opened_at: Date;
  closed_at: Date | null;
}

export interface TaskRow {
  id: string;
  organization_id: string;
  case_id: string | null;
  type: string;
  category: 'request' | 'incident' | 'update' | 'report' | 'distribution';
  subtype: string | null;
  label: string;
  title: string;
  description: string;
  status: TaskStatus;
  priority: TaskPriority;
  severity: TaskSeverity;
  visibility: Visibility;
  source: TaskSource;
  created_by_user_id: string | null;
  requester_person_id: string | null;
  owner_role_id: string | null;
  owner_user_id: string | null;
  assignee_role: string | null;
  due_at: Date | null;
  reactivity_deadline_at: Date | null;
  escalation_level: number;
  closed_at: Date | null;
}

export interface HrCaseParticipantRow {
  id: string;
  hr_case_id: string;
  person_id: string;
  role_in_case: HrCaseParticipantRole;
  notes: string | null;
}

/**
 * Input DTO for registering a new HR report.
 * This is a service-level DTO; controller-level DTOs can extend/validate this shape.
 */
export interface RegisterHrReportInput {
  organizationId: string;

  /**
   * Human-facing title and description of the report.
   */
  title: string;
  description: string;

  /**
   * Canonical enums (JSON inputs may be lower-case; normalization happens in service).
   */
  severity?: TaskSeverity | string;
  priority?: TaskPriority | string;
  visibility?: Visibility | string;

  /**
   * Task category & subtype (domain-specific for HR).
   * Category must be one of: request | incident | update | report | distribution.
   */
  category?: 'request' | 'incident' | 'update' | 'report' | 'distribution';
  subtype?: string; // e.g. "onboarding" | "offboarding" | "harassment" | "policy_question"

  /**
   * Canonical information label; if omitted, a sane HR default is used.
   * Example: "100.94.HR.CaseOfficer"
   */
  label?: string;

  /**
   * Signal/source metadata (aligned with task_source_enum / cases.source_type).
   */
  sourceType?: TaskSource;
  sourceReference?: string | null;

  /**
   * Ownership / routing hints.
   */
  caseOwnerRoleId?: string | null;
  caseOwnerUserId?: string | null;
  assigneeRole?: string | null;

  /**
   * HR participants (mapped into hr_case_participants).
   */
  reporterPersonId?: string | null;
  respondentPersonId?: string | null;
  otherParticipantIds?: string[];
  reporterNotes?: string | null;
  respondentNotes?: string | null;
  otherParticipantsRoleInCase?: HrCaseParticipantRole; // default: "witness"

  /**
   * Additional context.
   */
  tags?: string[];
  location?: unknown;
  caseMetadata?: Record<string, unknown> | null;
  taskMetadata?: Record<string, unknown> | null;

  /**
   * Explicit confidentiality hint (in addition to severity/subtype-based derivation).
   */
  requiresHighConfidentiality?: boolean;

  /**
   * Due date for the primary task.
   */
  dueAt?: string | Date | null;

  /**
   * Actor who is creating the report (user account).
   */
  createdByUserId?: string | null;

  /**
   * Optional HR-specific title/description overrides for the HR case record.
   */
  hrTitleOverride?: string | null;
  hrDescriptionOverride?: string | null;
}

/**
 * Summary shape returned from listCases().
 */
export interface HrCaseSummary {
  id: string; // hr_cases.id
  caseId: string;
  caseCode: string;
  title: string;
  status: HrCaseStatus;
  severity: TaskSeverity;
  confidentialityLevel: HrCaseConfidentialityLevel;
  openedAt: string;
  closedAt?: string;
  primaryTaskId?: string;
}

/**
 * Paginated list wrapper for HR case summaries.
 */
export interface PaginatedHrCaseSummary {
  items: HrCaseSummary[];
  total: number;
  limit: number;
  offset: number;
}

/**
 * Options for listing HR cases.
 */
export interface ListHrCasesOptions {
  organizationId: string;
  status?: HrCaseStatus | HrCaseStatus[];
  search?: string;
  limit?: number;
  offset?: number;
}

/**
 * Detailed result of a newly registered HR report.
 */
export interface HrCaseWithPrimaryTask {
  case: CaseRow;
  hrCase: HrCaseRow;
  primaryTask: TaskRow;
  participants: HrCaseParticipantRow[];
}

/**
 * TxClient type alias for use inside Prisma transactions.
 */
type TxClient = Prisma.TransactionClient;

@Injectable()
export class HrModuleService {
  /**
   * Default canonical label for HR case work (Doc 8 example).
   * 100  = broadcast base (department head level)
   * .9   = crisis/emergency information
   * .4   = report
   * HR.CaseOfficer = horizontal functional role
   */
  private static readonly DEFAULT_HR_LABEL = '100.94.HR.CaseOfficer';

  private readonly prisma: PrismaClient;

  constructor() {
    // Note: if you already have a shared PrismaService / DatabaseService,
    // inject it here instead of instantiating PrismaClient directly.
    this.prisma = new PrismaClient();
  }

  /**
   * Register a new HR report:
   * - Creates a generic Case (`cases`)
   * - Creates an HR Case (`hr_cases`) linked 1:1 with the Case
   * - Creates a primary Task (`tasks`) of type "hr_case"
   * - Creates hr_case_participants for reporter/respondent/others
   * - Creates a primary hr_case_task_links entry
   */
  async registerReport(input: RegisterHrReportInput): Promise<HrCaseWithPrimaryTask> {
    this.ensureRequiredFields(input);

    const severity = this.normalizeSeverity(input.severity);
    const priority = this.normalizePriority(input.priority ?? this.derivePriorityFromSeverity(severity));
    const visibility = this.normalizeVisibility(input.visibility ?? 'RESTRICTED');
    const sourceType: TaskSource = (input.sourceType ?? 'manual') as TaskSource;
    const category: 'request' | 'incident' | 'update' | 'report' | 'distribution' =
      input.category ?? 'request';

    const label = input.label?.trim() || HrModuleService.DEFAULT_HR_LABEL;
    const { verticalBase, horizontalRole } = this.parseLabel(label);

    const now = new Date();
    const organizationId = input.organizationId;
    const originVerticalLevel = verticalBase;
    const originRole = horizontalRole;

    const confidentialityLevel = this.deriveConfidentialityLevel({
      severity,
      subtype: input.subtype,
      requiresHighConfidentiality: input.requiresHighConfidentiality,
    });

    const dueAt = this.normalizeOptionalDate(input.dueAt);

    const tags = input.tags ?? [];
    const locationJson = input.location != null ? JSON.stringify(input.location) : 'null';
    const caseMetadataJson = JSON.stringify(input.caseMetadata ?? {});
    const taskMetadataJson = JSON.stringify(
      input.taskMetadata ?? {
        domain: 'hr_case',
        subtype: input.subtype ?? null,
        reporter_person_id: input.reporterPersonId ?? null,
        respondent_person_id: input.respondentPersonId ?? null,
      },
    );

    return this.prisma.$transaction(async (tx: TxClient) => {
      // 1. Insert into cases
      const [caseRow] = await tx.$queryRaw<CaseRow[]>`
        INSERT INTO cases (
          organization_id,
          source_type,
          source_reference,
          label,
          title,
          description,
          status,
          severity,
          reactivity_time,
          origin_vertical_level,
          origin_role,
          tags,
          location,
          metadata
        ) VALUES (
          ${organizationId},
          ${sourceType},
          ${input.sourceReference ?? null},
          ${label},
          ${input.title},
          ${input.description},
          ${'open'},
          ${severity},
          ${null},
          ${originVerticalLevel},
          ${originRole},
          ${tags},
          ${locationJson}::jsonb,
          ${caseMetadataJson}::jsonb
        )
        RETURNING
          id,
          organization_id,
          label,
          title,
          description,
          status,
          severity,
          origin_vertical_level,
          origin_role,
          created_at,
          updated_at
      `;

      if (!caseRow) {
        throw new Error('Failed to create Case for HR report');
      }

      // 2. Generate a human-readable HR case code (e.g. HR-2025-0001)
      const caseCode = await this.generateCaseCode(tx, organizationId, now);

      // 3. Insert into hr_cases
      const hrTitle = input.hrTitleOverride?.trim() || input.title;
      const hrDescription = input.hrDescriptionOverride?.trim() || input.description;

      const [hrCaseRow] = await tx.$queryRaw<HrCaseRow[]>`
        INSERT INTO hr_cases (
          organization_id,
          case_id,
          case_code,
          title,
          description,
          status,
          confidentiality_level,
          case_owner_role_id,
          case_owner_user_id,
          primary_task_id,
          opened_at,
          closed_at
        ) VALUES (
          ${organizationId},
          ${caseRow.id},
          ${caseCode},
          ${hrTitle},
          ${hrDescription},
          ${'open'},
          ${confidentialityLevel},
          ${input.caseOwnerRoleId ?? null},
          ${input.caseOwnerUserId ?? null},
          ${null},
          ${now},
          ${null}
        )
        RETURNING
          id,
          organization_id,
          case_id,
          case_code,
          title,
          description,
          status,
          confidentiality_level,
          case_owner_role_id,
          case_owner_user_id,
          primary_task_id,
          opened_at,
          closed_at
      `;

      if (!hrCaseRow) {
        throw new Error('Failed to create HrCase for HR report');
      }

      // 4. Insert primary Task
      const [taskRow] = await tx.$queryRaw<TaskRow[]>`
        INSERT INTO tasks (
          organization_id,
          case_id,
          type,
          category,
          subtype,
          label,
          title,
          description,
          status,
          priority,
          severity,
          visibility,
          source,
          created_by_user_id,
          requester_person_id,
          owner_role_id,
          owner_user_id,
          assignee_role,
          due_at,
          reactivity_time,
          reactivity_deadline_at,
          escalation_level,
          closed_at,
          metadata
        ) VALUES (
          ${organizationId},
          ${caseRow.id},
          ${'hr_case'},
          ${category},
          ${input.subtype ?? null},
          ${label},
          ${`HR case: ${hrTitle}`},
          ${hrDescription},
          ${'PENDING'},
          ${priority},
          ${severity},
          ${visibility},
          ${sourceType},
          ${input.createdByUserId ?? null},
          ${input.reporterPersonId ?? null},
          ${input.caseOwnerRoleId ?? null},
          ${input.caseOwnerUserId ?? null},
          ${input.assigneeRole ?? 'HR.CaseOfficer'},
          ${dueAt},
          ${null},
          ${null},
          ${0},
          ${null},
          ${taskMetadataJson}::jsonb
        )
        RETURNING
          id,
          organization_id,
          case_id,
          type,
          category,
          subtype,
          label,
          title,
          description,
          status,
          priority,
          severity,
          visibility,
          source,
          created_by_user_id,
          requester_person_id,
          owner_role_id,
          owner_user_id,
          assignee_role,
          due_at,
          reactivity_deadline_at,
          escalation_level,
          closed_at
      `;

      if (!taskRow) {
        throw new Error('Failed to create primary Task for HR report');
      }

      // 5. Update HrCase with primary_task_id
      const [updatedHrCaseRow] = await tx.$queryRaw<HrCaseRow[]>`
        UPDATE hr_cases
        SET primary_task_id = ${taskRow.id}
        WHERE id = ${hrCaseRow.id}
        RETURNING
          id,
          organization_id,
          case_id,
          case_code,
          title,
          description,
          status,
          confidentiality_level,
          case_owner_role_id,
          case_owner_user_id,
          primary_task_id,
          opened_at,
          closed_at
      `;

      const finalHrCaseRow = updatedHrCaseRow ?? hrCaseRow;

      // 6. Insert hr_case_participants rows
      const participants: HrCaseParticipantRow[] = [];

      if (input.reporterPersonId) {
        const [p] = await tx.$queryRaw<HrCaseParticipantRow[]>`
          INSERT INTO hr_case_participants (
            hr_case_id,
            person_id,
            role_in_case,
            notes
          ) VALUES (
            ${finalHrCaseRow.id},
            ${input.reporterPersonId},
            ${'complainant'},
            ${input.reporterNotes ?? null}
          )
          RETURNING
            id,
            hr_case_id,
            person_id,
            role_in_case,
            notes
        `;
        if (p) {
          participants.push(p);
        }
      }

      if (input.respondentPersonId) {
        const [p] = await tx.$queryRaw<HrCaseParticipantRow[]>`
          INSERT INTO hr_case_participants (
            hr_case_id,
            person_id,
            role_in_case,
            notes
          ) VALUES (
            ${finalHrCaseRow.id},
            ${input.respondentPersonId},
            ${'respondent'},
            ${input.respondentNotes ?? null}
          )
          RETURNING
            id,
            hr_case_id,
            person_id,
            role_in_case,
            notes
        `;
        if (p) {
          participants.push(p);
        }
      }

      if (input.otherParticipantIds?.length) {
        const roleForOthers: HrCaseParticipantRole =
          input.otherParticipantsRoleInCase ?? 'witness';

        for (const personId of input.otherParticipantIds) {
          const [p] = await tx.$queryRaw<HrCaseParticipantRow[]>`
            INSERT INTO hr_case_participants (
              hr_case_id,
              person_id,
              role_in_case,
              notes
            ) VALUES (
              ${finalHrCaseRow.id},
              ${personId},
              ${roleForOthers},
              ${null}
            )
            RETURNING
              id,
              hr_case_id,
              person_id,
              role_in_case,
              notes
          `;
          if (p) {
            participants.push(p);
          }
        }
      }

      // 7. Link HrCase and Task in hr_case_task_links (link_type "primary")
      await tx.$queryRaw`
        INSERT INTO hr_case_task_links (
          hr_case_id,
          task_id,
          link_type
        ) VALUES (
          ${finalHrCaseRow.id},
          ${taskRow.id},
          ${'primary'}
        )
      `;

      return {
        case: caseRow,
        hrCase: finalHrCaseRow,
        primaryTask: taskRow,
        participants,
      };
    });
  }

  /**
   * List HR cases for an organization with basic filtering and pagination.
   */
  async listCases(options: ListHrCasesOptions): Promise<PaginatedHrCaseSummary> {
    const { organizationId } = options;
    if (!organizationId || !organizationId.trim()) {
      throw new BadRequestException('organizationId is required');
    }

    const statuses = this.normalizeHrCaseStatusFilter(options.status);
    const search = options.search?.trim() || null;

    const limit = this.normalizeLimit(options.limit);
    const offset = this.normalizeOffset(options.offset);

    const statusCondition: Prisma.Sql = statuses.length
      ? Prisma.sql`AND hc.status = ANY(${statuses})`
      : Prisma.sql``;

    const searchCondition: Prisma.Sql = search
      ? Prisma.sql`AND (
          hc.title ILIKE ${`%${search}%`}
          OR c.title ILIKE ${`%${search}%`}
          OR c.description ILIKE ${`%${search}%`}
        )`
      : Prisma.sql``;

    const rows = await this.prisma.$queryRaw<
      Array<{
        id: string;
        case_id: string;
        case_code: string;
        title: string;
        status: HrCaseStatus;
        confidentiality_level: HrCaseConfidentialityLevel;
        opened_at: Date;
        closed_at: Date | null;
        primary_task_id: string | null;
        severity: TaskSeverity;
      }>
    >`
      SELECT
        hc.id,
        hc.case_id,
        hc.case_code,
        hc.title,
        hc.status,
        hc.confidentiality_level,
        hc.opened_at,
        hc.closed_at,
        hc.primary_task_id,
        c.severity
      FROM hr_cases hc
      JOIN cases c ON hc.case_id = c.id
      WHERE hc.organization_id = ${organizationId}
      ${statusCondition}
      ${searchCondition}
      ORDER BY hc.opened_at DESC
      LIMIT ${limit}
      OFFSET ${offset}
    `;

    const [countRow] = await this.prisma.$queryRaw<{ total: bigint }[]>`
      SELECT COUNT(*)::bigint AS total
      FROM hr_cases hc
      JOIN cases c ON hc.case_id = c.id
      WHERE hc.organization_id = ${organizationId}
      ${statusCondition}
      ${searchCondition}
    `;

    const total = countRow ? Number(countRow.total) : 0;

    const items: HrCaseSummary[] = rows.map((r) => ({
      id: r.id,
      caseId: r.case_id,
      caseCode: r.case_code,
      title: r.title,
      status: r.status,
      severity: r.severity,
      confidentialityLevel: r.confidentiality_level,
      openedAt: r.opened_at.toISOString(),
      closedAt: r.closed_at ? r.closed_at.toISOString() : undefined,
      primaryTaskId: r.primary_task_id ?? undefined,
    }));

    return {
      items,
      total,
      limit,
      offset,
    };
  }

  // ---------------------------------------------------------------------------
  // Helpers
  // ---------------------------------------------------------------------------

  private ensureRequiredFields(input: RegisterHrReportInput): void {
    if (!input.organizationId || !input.organizationId.trim()) {
      throw new BadRequestException('organizationId is required');
    }
    if (!input.title || !input.title.trim()) {
      throw new BadRequestException('title is required');
    }
    if (!input.description || !input.description.trim()) {
      throw new BadRequestException('description is required');
    }
  }

  private normalizeSeverity(severity?: TaskSeverity | string): TaskSeverity {
    if (!severity) {
      return 'MODERATE';
    }
    const raw = severity.toString().trim();
    const upper = raw.toUpperCase();

    if (upper === 'INFO') {
      // Historical mapping rule: treat "info" as MINOR
      return 'MINOR';
    }

    const allowed: TaskSeverity[] = ['MINOR', 'MODERATE', 'MAJOR', 'CRITICAL'];

    if (!allowed.includes(upper as TaskSeverity)) {
      throw new BadRequestException(
        `Invalid severity "${severity}". Expected one of: ${allowed.join(', ')}`,
      );
    }

    return upper as TaskSeverity;
  }

  private normalizePriority(priority?: TaskPriority | string): TaskPriority {
    if (!priority) {
      return 'MEDIUM';
    }
    const upper = priority.toString().trim().toUpperCase();
    const allowed: TaskPriority[] = ['LOW', 'MEDIUM', 'HIGH', 'CRITICAL'];

    if (!allowed.includes(upper as TaskPriority)) {
      throw new BadRequestException(
        `Invalid priority "${priority}". Expected one of: ${allowed.join(', ')}`,
      );
    }

    return upper as TaskPriority;
  }

  private normalizeVisibility(visibility?: Visibility | string): Visibility {
    if (!visibility) {
      return 'RESTRICTED';
    }
    const upper = visibility.toString().trim().toUpperCase();
    const allowed: Visibility[] = ['PUBLIC', 'INTERNAL', 'RESTRICTED', 'ANONYMISED'];

    if (!allowed.includes(upper as Visibility)) {
      throw new BadRequestException(
        `Invalid visibility "${visibility}". Expected one of: ${allowed.join(', ')}`,
      );
    }

    return upper as Visibility;
  }

  private derivePriorityFromSeverity(severity: TaskSeverity): TaskPriority {
    switch (severity) {
      case 'CRITICAL':
        return 'CRITICAL';
      case 'MAJOR':
        return 'HIGH';
      case 'MODERATE':
        return 'MEDIUM';
      case 'MINOR':
      default:
        return 'LOW';
    }
  }

  private deriveConfidentialityLevel(opts: {
    severity: TaskSeverity;
    subtype?: string;
    requiresHighConfidentiality?: boolean;
  }): HrCaseConfidentialityLevel {
    if (opts.requiresHighConfidentiality) {
      return 'highly_sensitive';
    }

    const subtype = (opts.subtype ?? '').toLowerCase().trim();

    if (subtype === 'harassment') {
      return 'highly_sensitive';
    }

    if (opts.severity === 'MAJOR' || opts.severity === 'CRITICAL') {
      return 'highly_sensitive';
    }

    return 'sensitive';
  }

  private normalizeOptionalDate(value?: string | Date | null): Date | null {
    if (!value) {
      return null;
    }
    if (value instanceof Date) {
      if (Number.isNaN(value.getTime())) {
        throw new BadRequestException('Invalid Date instance for dueAt');
      }
      return value;
    }
    const d = new Date(value);
    if (Number.isNaN(d.getTime())) {
      throw new BadRequestException(`Invalid ISO date string for dueAt: "${value}"`);
    }
    return d;
  }

  private parseLabel(label: string): { verticalBase: number | null; horizontalRole: string | null } {
    const trimmed = label.trim();
    if (!trimmed) {
      return { verticalBase: null, horizontalRole: null };
    }

    const parts = trimmed.split('.');
    if (parts.length < 2) {
      return { verticalBase: null, horizontalRole: null };
    }

    const verticalBase = Number.parseInt(parts[0]!, 10);
    const horizontalRole = parts.length > 2 ? parts.slice(2).join('.') : null;

    return {
      verticalBase: Number.isFinite(verticalBase) ? verticalBase : null,
      horizontalRole,
    };
  }

  private async generateCaseCode(
    tx: TxClient,
    organizationId: string,
    openedAt: Date,
  ): Promise<string> {
    const year = openedAt.getUTCFullYear();

    const [row] = await tx.$queryRaw<{ count: number }[]>`
      SELECT COUNT(*)::int AS count
      FROM hr_cases
      WHERE organization_id = ${organizationId}
        AND date_part('year', opened_at) = ${year}
    `;

    const sequence = (row?.count ?? 0) + 1;
    const sequenceStr = String(sequence).padStart(4, '0');

    return `HR-${year}-${sequenceStr}`;
  }

  private normalizeHrCaseStatusFilter(
    status?: HrCaseStatus | HrCaseStatus[],
  ): HrCaseStatus[] {
    if (!status) {
      return [];
    }
    const allowed: HrCaseStatus[] = ['open', 'under_review', 'resolved', 'dismissed'];

    const arr: string[] = Array.isArray(status) ? status : [status];

    const normalized: HrCaseStatus[] = arr.map((s) => {
      const val = s.toString().trim() as HrCaseStatus;
      if (!allowed.includes(val)) {
        throw new BadRequestException(
          `Invalid hrCase status "${s}". Expected one of: ${allowed.join(', ')}`,
        );
      }
      return val;
    });

    return normalized;
  }

  private normalizeLimit(limit?: number): number {
    if (limit == null) {
      return 50;
    }
    if (!Number.isFinite(limit) || limit <= 0) {
      throw new BadRequestException('limit must be a positive number');
    }
    return Math.min(Math.floor(limit), 500);
  }

  private normalizeOffset(offset?: number): number {
    if (offset == null) {
      return 0;
    }
    if (!Number.isFinite(offset) || offset < 0) {
      throw new BadRequestException('offset must be a non-negative number');
    }
    return Math.floor(offset);
  }
}

===== END apps/api/src/orgo/domain/hr/hr.service.ts =====


===== BEGIN apps/api/src/orgo/insights/cache/insights-cache-warmup.service.ts =====
// apps/api/src/orgo/insights/cache/insights-cache-warmup.service.ts

import { Injectable, Logger } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { ReportsService } from '../reports/reports.service';

export const INSIGHTS_CACHE_WARMUP_JOB_ID = 'orgo.insights.cache-warmup-dashboards';

/**
 * Options for a cache warmup run.
 *
 * In most cases callers will just invoke `warmDashboards()` with no arguments
 * and let this service derive organization IDs from configuration. Passing
 * explicit organization IDs is useful for targeted warmups in tests or tools.
 */
export interface InsightsCacheWarmupOptions {
  /**
   * One or more organization IDs whose dashboards should be pre‑warmed.
   * If omitted, the service will try to read `INSIGHTS_CACHE_WARMUP_ORG_IDS`
   * (comma‑separated UUIDs) from configuration.
   */
  organizationIds?: string[];

  /**
   * Optional subset of dashboards to warm. If omitted, all known high‑traffic
   * dashboards are warmed.
   */
  dashboards?: Array<'taskVolume' | 'slaBreaches' | 'profileScore'>;
}

/**
 * Pre‑warms Redis caches for high‑traffic insights dashboards by issuing the
 * same queries the UI uses, letting the reporting layer cache the results
 * using the TTLs defined in the insights configuration. :contentReference[oaicite:1]{index=1}
 *
 * This service is typically invoked by a scheduled worker tied to the
 * `orgo.insights.cache-warmup-dashboards` queue/job ID. 
 */
@Injectable()
export class InsightsCacheWarmupService {
  private readonly logger = new Logger(InsightsCacheWarmupService.name);

  // Only staging + prod are configured to run this job by default.
  private static readonly ENABLED_ENVIRONMENTS = new Set(['staging', 'prod']);

  constructor(
    private readonly reportsService: ReportsService,
    private readonly configService: ConfigService,
  ) {}

  /**
   * Entry point used by the background job handler.
   *
   * Behaviour:
   * - Skips execution entirely when INSIGHTS_ENV is not one of
   *   ["staging", "prod"] (or is set to "offline").
   * - Determines the set of organizations to warm from the options or from
   *   `INSIGHTS_CACHE_WARMUP_ORG_IDS` (comma‑separated UUIDs).
   * - For each organization, calls the main high‑traffic reporting endpoints
   *   so that their results are cached for upcoming dashboard requests.
   */
  async warmDashboards(options: InsightsCacheWarmupOptions = {}): Promise<void> {
    const env = this.getInsightsEnvironment();

    if (!InsightsCacheWarmupService.ENABLED_ENVIRONMENTS.has(env)) {
      this.logger.debug(
        `Insights cache warmup skipped: INSIGHTS_ENV=${env} is not in enabled environments ${Array.from(
          InsightsCacheWarmupService.ENABLED_ENVIRONMENTS,
        ).join(', ')}`,
      );
      return;
    }

    if (env === 'offline') {
      this.logger.debug('Insights cache warmup skipped: offline environment');
      return;
    }

    const organizationIds =
      (options.organizationIds && options.organizationIds.length > 0
        ? options.organizationIds
        : this.getConfiguredOrganizationIds()) || [];

    if (organizationIds.length === 0) {
      this.logger.warn(
        'Insights cache warmup skipped: no organization IDs provided and INSIGHTS_CACHE_WARMUP_ORG_IDS is not configured',
      );
      return;
    }

    const dashboards =
      options.dashboards && options.dashboards.length > 0
        ? options.dashboards
        : (['taskVolume', 'slaBreaches', 'profileScore'] as const);

    this.logger.log(
      `Starting insights cache warmup (env=${env}, orgs=${organizationIds.length}, dashboards=${dashboards.join(
        ', ',
      )})`,
    );

    const startedAt = Date.now();

    const results = await Promise.allSettled(
      organizationIds.map((organizationId) =>
        this.warmDashboardsForOrganization(organizationId, dashboards),
      ),
    );

    const failed = results.filter((r) => r.status === 'rejected').length;
    const durationMs = Date.now() - startedAt;

    if (failed > 0) {
      this.logger.warn(
        `Insights cache warmup finished with ${failed} failures out of ${organizationIds.length} organizations in ${durationMs} ms`,
      );
    } else {
      this.logger.log(
        `Insights cache warmup finished successfully for ${organizationIds.length} organizations in ${durationMs} ms`,
      );
    }
  }

  /**
   * Warm the configured set of dashboards for a single organization.
   *
   * This delegates to the reporting service, which is responsible for:
   * - honouring analytics cache TTLs from the insights config;
   * - applying access‑control and visibility rules;
   * - performing any internal caching through Redis.
   */
  private async warmDashboardsForOrganization(
    organizationId: string,
    dashboards: Array<'taskVolume' | 'slaBreaches' | 'profileScore'>,
  ): Promise<void> {
    this.logger.debug(
      `Warming insights dashboards for organization ${organizationId} (${dashboards.join(
        ', ',
      )})`,
    );

    const tasks: Promise<unknown>[] = [];

    if (dashboards.includes('taskVolume')) {
      tasks.push(
        this.reportsService
          // Typical dashboards show "recent activity" for an org; the reporting
          // service can interpret an organization‑only payload as "default range".
          .getTaskVolumeReport({ organizationId })
          .catch((error) =>
            this.logDashboardError(
              organizationId,
              'taskVolume',
              error as Error,
            ),
          ),
      );
    }

    if (dashboards.includes('slaBreaches')) {
      tasks.push(
        this.reportsService
          .getSlaBreaches({ organizationId })
          .catch((error) =>
            this.logDashboardError(
              organizationId,
              'slaBreaches',
              error as Error,
            ),
          ),
      );
    }

    if (dashboards.includes('profileScore')) {
      tasks.push(
        this.reportsService
          .getProfileScore({ organizationId })
          .catch((error) =>
            this.logDashboardError(
              organizationId,
              'profileScore',
              error as Error,
            ),
          ),
      );
    }

    // Run all dashboard warmups for this org in parallel; errors are handled
    // per‑dashboard above so we do not reject the entire org on a single failure.
    await Promise.all(tasks);
  }

  /**
   * Derives the current insights environment.
   *
   * Prefers the explicit INSIGHTS_ENV (as defined in the insights module
   * config) and falls back to the global ENVIRONMENT when not set. 
   */
  private getInsightsEnvironment(): string {
    const fromInsightsEnv =
      this.configService.get<string>('INSIGHTS_ENV') ||
      this.configService.get<string>('insights.environment');
    const fromGlobalEnv =
      this.configService.get<string>('ENVIRONMENT') ||
      this.configService.get<string>('environment');

    return (fromInsightsEnv || fromGlobalEnv || 'dev').toLowerCase();
  }

  /**
   * Reads the default set of organization IDs to warm from configuration.
   *
   * By convention this is supplied via the environment variable
   * `INSIGHTS_CACHE_WARMUP_ORG_IDS` as a comma‑separated list of UUIDs, e.g.:
   *
   *   INSIGHTS_CACHE_WARMUP_ORG_IDS=org-uuid-1,org-uuid-2
   */
  private getConfiguredOrganizationIds(): string[] {
    const raw =
      this.configService.get<string>('INSIGHTS_CACHE_WARMUP_ORG_IDS') || '';

    return raw
      .split(',')
      .map((value) => value.trim())
      .filter((value) => value.length > 0);
  }

  private logDashboardError(
    organizationId: string,
    dashboard: string,
    error: Error,
  ): void {
    this.logger.error(
      `Failed to warm insights dashboard "${dashboard}" for organization ${organizationId}: ${error.message}`,
      error.stack,
    );
  }
}

===== END apps/api/src/orgo/insights/cache/insights-cache-warmup.service.ts =====


===== BEGIN apps/api/src/orgo/insights/export/analytics-export.service.ts =====
import {
  BadRequestException,
  Inject,
  Injectable,
  Logger,
  Optional,
} from '@nestjs/common';
import { ConfigService } from '@nestjs/config';

import {
  EmailService,
  EmailAddress,
} from '../../core/email/email.service';

export type AnalyticsExportFormat = 'csv' | 'json';

export interface AnalyticsExportFilters {
  orgId?: string;
  projectId?: string;
  userId?: string;
  from?: Date | string;
  to?: Date | string;
  eventTypes?: string[];
  [key: string]: unknown;
}

export interface AnalyticsExportRequest {
  /**
   * Export format. Defaults to "csv" if omitted.
   */
  format?: AnalyticsExportFormat;

  /**
   * Filters for the analytics query.
   */
  filters: AnalyticsExportFilters;

  /**
   * Timezone identifier for interpreting date filters (e.g. "UTC", "America/New_York").
   * If omitted, a default can be provided via configuration.
   */
  timezone?: string;

  /**
   * ID of the user requesting the export. Used for logging/auditing and storage metadata.
   */
  requestedByUserId: string;

  /**
   * Optional human‑readable label for the export, used in filenames and logs.
   */
  label?: string;
}

export interface AnalyticsExportResult {
  fileName: string;
  mimeType: string;
  size: number;
  rowCount: number;
  truncated: boolean;
  buffer: Buffer;
  url?: string;
  storageKey?: string;
}

export interface AnalyticsExportEmailOptions {
  to: EmailAddress | EmailAddress[];
  subject?: string;
  text?: string;
  html?: string;
}

export type AnalyticsDataRow = Record<string, unknown>;

export interface AnalyticsExportQuery {
  filters: AnalyticsExportFilters;
  timezone?: string;
}

export interface AnalyticsQueryService {
  /**
   * Returns rows suitable for export, already filtered/aggregated according to the query.
   */
  queryForExport(query: AnalyticsExportQuery): Promise<AnalyticsDataRow[]>;
}

export interface AnalyticsExportStoragePayload {
  fileName: string;
  mimeType: string;
  buffer: Buffer;
  metadata?: Record<string, unknown>;
}

export interface AnalyticsExportStorageResult {
  url?: string;
  storageKey?: string;
}

export interface AnalyticsExportStorage {
  /**
   * Persist an export file and return its storage location.
   */
  saveExport(
    payload: AnalyticsExportStoragePayload,
  ): Promise<AnalyticsExportStorageResult>;
}

export const ANALYTICS_QUERY_SERVICE = Symbol('ANALYTICS_QUERY_SERVICE');
export const ANALYTICS_EXPORT_STORAGE = Symbol('ANALYTICS_EXPORT_STORAGE');

@Injectable()
export class AnalyticsExportService {
  private readonly logger = new Logger(AnalyticsExportService.name);
  private readonly maxRows: number;
  private readonly defaultFormat: AnalyticsExportFormat;
  private readonly defaultTimezone: string;

  constructor(
    @Inject(ANALYTICS_QUERY_SERVICE)
    private readonly analyticsQueryService: AnalyticsQueryService,
    private readonly configService: ConfigService,
    @Optional()
    @Inject(ANALYTICS_EXPORT_STORAGE)
    private readonly storage?: AnalyticsExportStorage,
    @Optional()
    private readonly emailService?: EmailService,
  ) {
    const fromConfig = this.configService.get<number>(
      'INSIGHTS_EXPORT_MAX_ROWS',
    );
    const fromEnv = process.env.INSIGHTS_EXPORT_MAX_ROWS
      ? parseInt(process.env.INSIGHTS_EXPORT_MAX_ROWS, 10)
      : undefined;

    this.maxRows =
      (fromConfig && fromConfig > 0 && fromConfig) ||
      (fromEnv && fromEnv > 0 && fromEnv) ||
      100_000;

    const defaultFormat =
      this.configService.get<AnalyticsExportFormat>(
        'INSIGHTS_EXPORT_DEFAULT_FORMAT',
      ) ?? 'csv';
    this.defaultFormat = defaultFormat === 'json' ? 'json' : 'csv';

    this.defaultTimezone =
      this.configService.get<string>('INSIGHTS_DEFAULT_TIMEZONE') ??
      'UTC';
  }

  /**
   * Generate an analytics export and return the file contents and metadata.
   *
   * If a storage implementation is configured, the generated file is also persisted,
   * and its URL / storage key returned in the result.
   */
  async export(
    request: AnalyticsExportRequest,
  ): Promise<AnalyticsExportResult> {
    this.validateRequest(request);

    const format = request.format ?? this.defaultFormat;
    const timezone = request.timezone ?? this.defaultTimezone;

    const rows =
      (await this.analyticsQueryService.queryForExport({
        filters: request.filters ?? {},
        timezone,
      })) ?? [];

    let truncated = false;
    let limitedRows = rows;

    if (this.maxRows && rows.length > this.maxRows) {
      truncated = true;
      limitedRows = rows.slice(0, this.maxRows);
    }

    const { buffer, mimeType } = this.formatRows(limitedRows, format);
    const fileName = this.buildFileName(request, format);

    let url: string | undefined;
    let storageKey: string | undefined;

    if (this.storage) {
      try {
        const stored = await this.storage.saveExport({
          fileName,
          mimeType,
          buffer,
          metadata: {
            orgId: request.filters.orgId,
            projectId: request.filters.projectId,
            userId: request.filters.userId,
            requestedByUserId: request.requestedByUserId,
            label: request.label,
            format,
            rowCount: limitedRows.length,
            truncated,
            timezone,
          },
        });

        url = stored.url;
        storageKey = stored.storageKey;
      } catch (err) {
        const error = err as Error;
        this.logger.error(
          `Failed to persist analytics export "${fileName}": ${error.message}`,
        );
        // Continue and return the in‑memory file even if storage fails.
      }
    }

    const size = buffer.byteLength;

    this.logger.debug(
      `Generated analytics export "${fileName}" for user "${request.requestedByUserId}" with ${limitedRows.length} row(s)${
        truncated ? ' (truncated)' : ''
      }.`,
    );

    return {
      fileName,
      mimeType,
      size,
      rowCount: limitedRows.length,
      truncated,
      buffer,
      url,
      storageKey,
    };
  }

  /**
   * Generate an analytics export and email it to the specified recipient(s).
   *
   * If a storage backend is configured and returns a URL, the email body will
   * refer to the download link. Otherwise, the file is attached directly.
   */
  async exportAndEmail(
    request: AnalyticsExportRequest,
    emailOptions: AnalyticsExportEmailOptions,
  ): Promise<AnalyticsExportResult> {
    if (!this.emailService) {
      throw new Error(
        'EmailService is not configured for AnalyticsExportService.',
      );
    }

    const result = await this.export(request);

    const subject =
      emailOptions.subject ??
      `Your analytics export "${result.fileName}" is ready`;

    const defaultTextParts: string[] = [];

    defaultTextParts.push(
      `Your analytics export "${result.fileName}" is ready.`,
    );

    if (result.url) {
      defaultTextParts.push('');
      defaultTextParts.push(`Download link: ${result.url}`);
    } else {
      defaultTextParts.push('');
      defaultTextParts.push(
        'The export file is attached to this email.',
      );
    }

    const text =
      emailOptions.text ?? defaultTextParts.join('\n');

    const attachments =
      result.url != null
        ? undefined
        : [
            {
              filename: result.fileName,
              content: result.buffer,
              contentType: result.mimeType,
            },
          ];

    await this.emailService.send({
      to: emailOptions.to,
      subject,
      text,
      html: emailOptions.html,
      attachments,
    });

    return result;
  }

  private validateRequest(request: AnalyticsExportRequest): void {
    if (!request) {
      throw new BadRequestException('Export request is required.');
    }

    if (!request.requestedByUserId?.toString().trim()) {
      throw new BadRequestException(
        'requestedByUserId is required for analytics export.',
      );
    }

    if (!request.filters || typeof request.filters !== 'object') {
      throw new BadRequestException(
        'filters are required for analytics export.',
      );
    }

    if (
      request.format &&
      request.format !== 'csv' &&
      request.format !== 'json'
    ) {
      throw new BadRequestException(
        `Unsupported export format "${request.format}".`,
      );
    }
  }

  private formatRows(
    rows: AnalyticsDataRow[],
    format: AnalyticsExportFormat,
  ): { buffer: Buffer; mimeType: string } {
    if (format === 'json') {
      const json = this.formatAsJson(rows);
      return {
        buffer: Buffer.from(json, 'utf8'),
        mimeType: 'application/json',
      };
    }

    const csv = this.formatAsCsv(rows);
    return {
      buffer: Buffer.from(csv, 'utf8'),
      mimeType: 'text/csv',
    };
  }

  private formatAsJson(rows: AnalyticsDataRow[]): string {
    if (!rows.length) {
      return '[]';
    }

    return JSON.stringify(rows);
  }

  private formatAsCsv(rows: AnalyticsDataRow[]): string {
    if (!rows.length) {
      return '';
    }

    const headerSet = new Set<string>();

    for (const row of rows) {
      Object.keys(row || {}).forEach((key) => headerSet.add(key));
    }

    const headers = Array.from(headerSet);
    const lines: string[] = [];

    lines.push(headers.join(','));

    for (const row of rows) {
      const values = headers.map((header) =>
        this.escapeCsvValue((row as any)[header]),
      );
      lines.push(values.join(','));
    }

    return lines.join('\n');
  }

  private escapeCsvValue(value: unknown): string {
    if (value === null || value === undefined) {
      return '';
    }

    const str = String(value);
    if (
      str.includes('"') ||
      str.includes(',') ||
      str.includes('\n') ||
      str.includes('\r')
    ) {
      const escaped = str.replace(/"/g, '""');
      return `"${escaped}"`;
    }

    return str;
  }

  private buildFileName(
    request: AnalyticsExportRequest,
    format: AnalyticsExportFormat,
  ): string {
    const labelPart = request.label
      ? request.label.toString().trim().toLowerCase().replace(/[^a-z0-9]+/g, '-')
      : request.filters.orgId
      ? String(request.filters.orgId)
      : 'analytics';

    const timestamp = new Date()
      .toISOString()
      .replace(/[:.]/g, '-');

    const safeLabel = labelPart.replace(/^-+|-+$/g, '') || 'analytics';

    return `analytics-export-${safeLabel}-${timestamp}.${format}`;
  }
}

===== END apps/api/src/orgo/insights/export/analytics-export.service.ts =====


===== BEGIN apps/api/src/orgo/insights/insights.module.ts =====
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';

import { ReportsController } from './reports.controller';
import { ReportsService } from './reports.service';
import { AnalyticsExportService } from './analytics-export.service';
import { PatternDetectionService } from './pattern-detection.service';
import { InsightsCacheWarmupService } from './insights-cache-warmup.service';

/**
 * InsightsModule
 *
 * Wires up the reporting / analytics slice of Orgo over the `insights.*`
 * star schema (see Orgo v3 Docs 4 & 6 for functional + config contracts).
 */
@Module({
  imports: [
    // Provides ConfigService so insights services can read ENV / config.yaml
    ConfigModule,
  ],
  controllers: [
    // HTTP reporting API (task volume, SLA breaches, profile scores, etc.)
    ReportsController,
  ],
  providers: [
    // Read-only reporting over the insights star schema
    ReportsService,
    // Export and materialized-view refresh hooks (used by jobs / queues)
    AnalyticsExportService,
    // Weekly / monthly / yearly pattern detection orchestration
    PatternDetectionService,
    // Cache warmup for high-traffic dashboards
    InsightsCacheWarmupService,
  ],
  exports: [
    ReportsService,
    AnalyticsExportService,
    PatternDetectionService,
    InsightsCacheWarmupService,
  ],
})
export class InsightsModule {}

===== END apps/api/src/orgo/insights/insights.module.ts =====


===== BEGIN apps/api/src/orgo/insights/patterns/pattern-detection.service.ts =====

===== END apps/api/src/orgo/insights/patterns/pattern-detection.service.ts =====


===== BEGIN apps/api/src/orgo/insights/reports/reports.controller.ts =====
import { Controller, Get, Query } from '@nestjs/common';
import { Type } from 'class-transformer';
import {
  IsBoolean,
  IsEnum,
  IsISO8601,
  IsOptional,
  IsString,
  IsUUID,
} from 'class-validator';
import { ReportsService } from './reports.service';

/**
 * Canonical task enums (mirroring Doc 2 / Doc 1).
 */
export enum TaskStatus {
  PENDING = 'PENDING',
  IN_PROGRESS = 'IN_PROGRESS',
  ON_HOLD = 'ON_HOLD',
  COMPLETED = 'COMPLETED',
  FAILED = 'FAILED',
  ESCALATED = 'ESCALATED',
  CANCELLED = 'CANCELLED',
}

export enum TaskPriority {
  LOW = 'LOW',
  MEDIUM = 'MEDIUM',
  HIGH = 'HIGH',
  CRITICAL = 'CRITICAL',
}

export enum TaskSeverity {
  MINOR = 'MINOR',
  MODERATE = 'MODERATE',
  MAJOR = 'MAJOR',
  CRITICAL = 'CRITICAL',
}

/**
 * Reporting‑specific enums.
 */
export enum TaskVolumeGranularity {
  DAY = 'day',
  WEEK = 'week',
  MONTH = 'month',
}

export enum TaskVolumeGroupBy {
  STATUS = 'status',
  TYPE = 'type',
  PRIORITY = 'priority',
  SEVERITY = 'severity',
  LABEL = 'label',
}

/**
 * Query DTO for the task‑volume report endpoint.
 *
 * This maps to aggregations over insights.fact_tasks (by date and dimension).
 */
export class TaskVolumeReportQueryDto {
  /**
   * Tenant / organization identifier (required).
   */
  @IsUUID('4')
  organizationId!: string;

  /**
   * Inclusive start of the reporting window (ISO‑8601).
   * If omitted, the service will use its own default window.
   */
  @IsOptional()
  @IsISO8601()
  startDate?: string;

  /**
   * Inclusive end of the reporting window (ISO‑8601).
   */
  @IsOptional()
  @IsISO8601()
  endDate?: string;

  /**
   * Time bucket size for aggregation (day/week/month).
   */
  @IsOptional()
  @IsEnum(TaskVolumeGranularity)
  granularity?: TaskVolumeGranularity;

  /**
   * Primary dimension to group by (status/type/priority/severity/label).
   */
  @IsOptional()
  @IsEnum(TaskVolumeGroupBy)
  groupBy?: TaskVolumeGroupBy;

  /**
   * Optional status filter; if present, only these statuses are counted.
   */
  @IsOptional()
  @IsEnum(TaskStatus, { each: true })
  @Type(() => String)
  statuses?: TaskStatus[];

  /**
   * Optional priority filter.
   */
  @IsOptional()
  @IsEnum(TaskPriority, { each: true })
  @Type(() => String)
  priorities?: TaskPriority[];

  /**
   * Optional severity filter.
   */
  @IsOptional()
  @IsEnum(TaskSeverity, { each: true })
  @Type(() => String)
  severities?: TaskSeverity[];
}

/**
 * Query DTO for the SLA‑breach report endpoint.
 *
 * This focuses on tasks whose reactivity/completion deadlines were exceeded.
 */
export class SlaBreachesReportQueryDto {
  @IsUUID('4')
  organizationId!: string;

  @IsOptional()
  @IsISO8601()
  startDate?: string;

  @IsOptional()
  @IsISO8601()
  endDate?: string;

  /**
   * Minimum severity to include (e.g. only MAJOR/CRITICAL).
   */
  @IsOptional()
  @IsEnum(TaskSeverity)
  minSeverity?: TaskSeverity;

  /**
   * Optional status filter; defaults to unresolved states in the service layer.
   */
  @IsOptional()
  @IsEnum(TaskStatus, { each: true })
  @Type(() => String)
  statuses?: TaskStatus[];

  /**
   * When true (default), only unresolved/open tasks are considered breaches.
   */
  @IsOptional()
  @Type(() => Boolean)
  @IsBoolean()
  onlyOpen?: boolean;
}

/**
 * Query DTO for the profile‑effectiveness score endpoint.
 *
 * This compares actual behaviour vs profile expectations (reactivity, SLAs, etc.).
 */
export class ProfileScoreReportQueryDto {
  @IsUUID('4')
  organizationId!: string;

  /**
   * Optional explicit profile key (e.g. "hospital", "advocacy_group").
   * If omitted, the org’s active profile is used.
   */
  @IsOptional()
  @IsString()
  profileKey?: string;

  @IsOptional()
  @IsISO8601()
  startDate?: string;

  @IsOptional()
  @IsISO8601()
  endDate?: string;
}

@Controller('insights/reports')
export class ReportsController {
  constructor(private readonly reportsService: ReportsService) {}

  /**
   * GET /insights/reports/tasks/volume
   *
   * Returns aggregated task volume over time, grouped by a primary dimension.
   */
  @Get('tasks/volume')
  getTaskVolumeReport(@Query() query: TaskVolumeReportQueryDto) {
    const {
      organizationId,
      startDate,
      endDate,
      granularity,
      groupBy,
      statuses,
      priorities,
      severities,
    } = query;

    return this.reportsService.getTaskVolumeReport({
      organizationId,
      startDate,
      endDate,
      granularity: granularity ?? TaskVolumeGranularity.DAY,
      groupBy: groupBy ?? TaskVolumeGroupBy.STATUS,
      statuses,
      priorities,
      severities,
    });
  }

  /**
   * GET /insights/reports/tasks/sla-breaches
   *
   * Returns tasks that breached SLAs (reactivity or completion), with optional
   * severity and status filters.
   */
  @Get('tasks/sla-breaches')
  getSlaBreachesReport(@Query() query: SlaBreachesReportQueryDto) {
    const {
      organizationId,
      startDate,
      endDate,
      minSeverity,
      statuses,
      onlyOpen,
    } = query;

    return this.reportsService.getSlaBreaches({
      organizationId,
      startDate,
      endDate,
      minSeverity,
      statuses,
      onlyOpen: onlyOpen !== undefined ? onlyOpen : true,
    });
  }

  /**
   * GET /insights/reports/profiles/score
   *
   * Returns an effectiveness score for the organization’s behavioural profile
   * over the selected time window.
   */
  @Get('profiles/score')
  getProfileScore(@Query() query: ProfileScoreReportQueryDto) {
    const { organizationId, profileKey, startDate, endDate } = query;

    return this.reportsService.getProfileScore({
      organizationId,
      profileKey,
      startDate,
      endDate,
    });
  }
}

===== END apps/api/src/orgo/insights/reports/reports.controller.ts =====


===== BEGIN apps/api/src/orgo/insights/reports/reports.service.ts =====
// apps/api/src/orgo/insights/reports/reports.service.ts

import { Injectable, Logger } from '@nestjs/common';
import { DataSource } from 'typeorm';

/**
 * Canonical task enums (string unions) aligned with Doc 2 / TASK_STATUS,
 * TASK_PRIORITY and TASK_SEVERITY. These mirror the DB enums and JSON
 * contracts but are kept local to the reports service so it can type
 * its responses without importing additional dependencies.
 */
export type TaskStatus =
  | 'PENDING'
  | 'IN_PROGRESS'
  | 'ON_HOLD'
  | 'COMPLETED'
  | 'FAILED'
  | 'ESCALATED'
  | 'CANCELLED';

export type TaskPriority = 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';

export type TaskSeverity = 'MINOR' | 'MODERATE' | 'MAJOR' | 'CRITICAL';

/**
 * Parameters for the task volume report.
 * All date values are interpreted as UTC and truncated to a date key
 * (YYYY-MM-DD) to match insights.dim_dates / insights.fact_tasks.
 */
export interface TaskVolumeReportParams {
  organizationId: string;
  fromDate?: Date | string;
  toDate?: Date | string;
  /**
   * Optional filter for current_status (TASK_STATUS).
   * If omitted, all statuses are included.
   */
  status?: TaskStatus[];
  /**
   * Optional filter for Task.type / domain;
   * this is resolved via insights.dim_tasks.type.
   */
  type?: string;
}

/**
 * One bucket in the task volume report – counts per day and status.
 */
export interface TaskVolumeBucket {
  /**
   * ISO date (YYYY-MM-DD), matching insights.dim_dates.date_key.
   */
  date: string;
  status: TaskStatus;
  count: number;
}

/**
 * Parameters used for SLA breach reporting. Thresholds are provided
 * by the caller (typically derived from organization profiles and
 * global config).
 */
export interface SlaBreachesParams {
  organizationId: string;
  fromDate?: Date | string;
  toDate?: Date | string;
  /**
   * Threshold (seconds) for time_to_first_response_seconds beyond
   * which a task is considered to have breached the reactivity SLA.
   */
  reactivitySecondsThreshold: number;
  /**
   * Threshold (seconds) for time_to_completion_seconds beyond
   * which a task is considered to have breached the completion SLA.
   */
  completionSecondsThreshold: number;
  /**
   * Optional filter for Task.type / domain.
   */
  type?: string;
}

/**
 * Aggregated SLA breach data per domain (Task.type).
 */
export interface SlaBreachRow {
  /**
   * Task.type from insights.dim_tasks.type (e.g. "maintenance", "hr_case").
   */
  domainType: string;
  /**
   * Total tasks considered for this domain within the date window.
   */
  totalTasks: number;
  /**
   * Tasks that breached either the reactivity or completion SLA.
   */
  breachedTasks: number;
  /**
   * breachedTasks / totalTasks, in [0, 1]. 0 when totalTasks == 0.
   */
  breachRate: number;
}

/**
 * Profile score parameters – equivalent to SLA breach parameters,
 * since the score is derived from the same aggregates.
 */
export interface ProfileScoreParams extends SlaBreachesParams {}

/**
 * Overall profile effectiveness score plus per-domain breakdown.
 */
export interface ProfileScore {
  organizationId: string;
  fromDate: string;
  toDate: string;
  /**
   * Total tasks considered across all domains.
   */
  overallTasks: number;
  /**
   * Total tasks that breached SLA across all domains.
   */
  overallBreachedTasks: number;
  /**
   * Score in [0, 100]. 100 means no breaches, 0 means all breached.
   */
  overallScore: number;
  /**
   * Per-domain SLA breach breakdown.
   */
  perDomain: SlaBreachRow[];
}

/**
 * Utility: normalize a Date or date-like string to a YYYY-MM-DD string in UTC.
 * Throws if the input cannot be parsed as a date.
 */
function toDateKey(input: Date | string): string {
  const d = typeof input === 'string' ? new Date(input) : input;
  const time = d.getTime();

  if (Number.isNaN(time)) {
    throw new Error(`Invalid date value: ${String(input)}`);
  }

  const year = d.getUTCFullYear();
  const month = (d.getUTCMonth() + 1).toString().padStart(2, '0');
  const day = d.getUTCDate().toString().padStart(2, '0');

  return `${year}-${month}-${day}`;
}

/**
 * Default lookback window for date ranges when none is provided.
 * This is intentionally conservative and can be overridden by callers.
 */
const DEFAULT_LOOKBACK_DAYS = 30;

/**
 * ReportsService
 *
 * Read-only service over the analytics star-schema (insights.*),
 * providing high-level reporting aggregates used by dashboards:
 *
 * - getTaskVolumeReport: task counts by day and status.
 * - getSlaBreaches: SLA breach rates per domain.
 * - getProfileScore: aggregate profile effectiveness score derived
 *   from SLA breaches.
 *
 * The DataSource injected here should be configured to talk to the
 * analytics database that hosts the `insights` schema. If the same
 * Postgres instance is used for OLTP and analytics, this service can
 * use the default application DataSource.
 */
@Injectable()
export class ReportsService {
  private readonly logger = new Logger(ReportsService.name);

  constructor(private readonly dataSource: DataSource) {}

  /**
   * Returns task volume buckets grouped by created_date_key and
   * current_status for a given organization and date window.
   *
   * Data source:
   *   - insights.fact_tasks (created_date_key, current_status, organization_id)
   *   - optional join to insights.dim_tasks when filtering by Task.type.
   */
  async getTaskVolumeReport(
    params: TaskVolumeReportParams,
  ): Promise<TaskVolumeBucket[]> {
    const { organizationId, status, type } = params;
    const { fromKey, toKey } = this.normalizeDateRange(
      params.fromDate,
      params.toDate,
    );

    const conditions: string[] = [];
    const values: any[] = [];

    // 1) organization_id filter
    values.push(organizationId);
    let paramIndex = 1;
    conditions.push(`ft.organization_id = $${paramIndex++}`);

    // 2) date window (created_date_key is a DATE)
    values.push(fromKey);
    conditions.push(`ft.created_date_key >= $${paramIndex++}`);

    values.push(toKey);
    conditions.push(`ft.created_date_key <= $${paramIndex++}`);

    // 3) optional status filter
    if (status && status.length > 0) {
      values.push(status);
      conditions.push(`ft.current_status = ANY($${paramIndex++})`);
    }

    // 4) optional domain type filter (requires dim_tasks join)
    if (type) {
      values.push(type);
      conditions.push(`dt.type = $${paramIndex++}`);
    }

    const whereClause =
      conditions.length > 0 ? `WHERE ${conditions.join(' AND ')}` : '';

    const sql = `
      SELECT
        ft.created_date_key AS date,
        ft.current_status AS status,
        COUNT(*)::int AS count
      FROM insights.fact_tasks ft
      LEFT JOIN insights.dim_tasks dt
        ON dt.task_id = ft.task_id
      ${whereClause}
      GROUP BY ft.created_date_key, ft.current_status
      ORDER BY ft.created_date_key ASC, ft.current_status ASC;
    `;

    try {
      const rows: Array<{
        date: string | Date;
        status: TaskStatus;
        count: string | number;
      }> = await this.dataSource.query(sql, values);

      return rows.map((row) => ({
        date:
          row.date instanceof Date
            ? row.date.toISOString().slice(0, 10)
            : String(row.date),
        status: row.status,
        count: typeof row.count === 'string' ? parseInt(row.count, 10) : row.count,
      }));
    } catch (error) {
      this.logger.error(
        `Failed to compute task volume report for org=${organizationId}`,
        (error as Error).stack ?? String(error),
      );
      throw error;
    }
  }

  /**
   * Returns SLA breach statistics per domain (Task.type) for a given
   * organization and date window.
   *
   * A task is counted as "breached" if either:
   *   - time_to_first_response_seconds > reactivitySecondsThreshold, OR
   *   - time_to_completion_seconds > completionSecondsThreshold.
   *
   * Data source:
   *   - insights.fact_tasks (metrics & dates)
   *   - insights.dim_tasks (domain type, organization)
   */
  async getSlaBreaches(params: SlaBreachesParams): Promise<SlaBreachRow[]> {
    const {
      organizationId,
      reactivitySecondsThreshold,
      completionSecondsThreshold,
      type,
    } = params;

    const { fromKey, toKey } = this.normalizeDateRange(
      params.fromDate,
      params.toDate,
    );

    if (
      reactivitySecondsThreshold == null ||
      Number.isNaN(reactivitySecondsThreshold)
    ) {
      throw new Error(
        'reactivitySecondsThreshold is required and must be a number',
      );
    }

    if (
      completionSecondsThreshold == null ||
      Number.isNaN(completionSecondsThreshold)
    ) {
      throw new Error(
        'completionSecondsThreshold is required and must be a number',
      );
    }

    const conditions: string[] = [];
    const values: any[] = [];

    // 1) organization filter (from fact_tasks)
    values.push(organizationId);
    let paramIndex = 1;
    conditions.push(`ft.organization_id = $${paramIndex++}`);

    // 2) date window
    values.push(fromKey);
    conditions.push(`ft.created_date_key >= $${paramIndex++}`);

    values.push(toKey);
    conditions.push(`ft.created_date_key <= $${paramIndex++}`);

    // 3) optional type filter (dim_tasks.type)
    if (type) {
      values.push(type);
      conditions.push(`dt.type = $${paramIndex++}`);
    }

    // 4) SLA thresholds – added as parameters used in FILTER clause
    const reactivityIndex = paramIndex++;
    const completionIndex = paramIndex++;

    values.push(reactivitySecondsThreshold);
    values.push(completionSecondsThreshold);

    const whereClause =
      conditions.length > 0 ? `WHERE ${conditions.join(' AND ')}` : '';

    const sql = `
      SELECT
        dt.type AS domain_type,
        COUNT(*)::int AS total_tasks,
        COUNT(*) FILTER (
          WHERE
            (ft.time_to_first_response_seconds IS NOT NULL
             AND ft.time_to_first_response_seconds > $${reactivityIndex})
            OR
            (ft.time_to_completion_seconds IS NOT NULL
             AND ft.time_to_completion_seconds > $${completionIndex})
        )::int AS breached_tasks
      FROM insights.fact_tasks ft
      JOIN insights.dim_tasks dt
        ON dt.task_id = ft.task_id
      ${whereClause}
      GROUP BY dt.type
      ORDER BY dt.type;
    `;

    try {
      const rows: Array<{
        domain_type: string;
        total_tasks: string | number;
        breached_tasks: string | number;
      }> = await this.dataSource.query(sql, values);

      return rows.map((row) => {
        const total =
          typeof row.total_tasks === 'string'
            ? parseInt(row.total_tasks, 10)
            : row.total_tasks;
        const breached =
          typeof row.breached_tasks === 'string'
            ? parseInt(row.breached_tasks, 10)
            : row.breached_tasks;
        const breachRate = total > 0 ? breached / total : 0;

        return {
          domainType: row.domain_type,
          totalTasks: total,
          breachedTasks: breached,
          breachRate,
        };
      });
    } catch (error) {
      this.logger.error(
        `Failed to compute SLA breaches for org=${organizationId}`,
        (error as Error).stack ?? String(error),
      );
      throw error;
    }
  }

  /**
   * Computes an overall "profile effectiveness" score for an organization
   * over a date window, based on SLA breaches, and returns that score plus
   * the per-domain breakdown.
   *
   * The score is currently defined as:
   *
   *   overallScore = round((1 - breachRate) * 100),
   *
   * where breachRate = overallBreachedTasks / overallTasks.
   *
   * Callers are responsible for providing the SLA thresholds; this service
   * focuses purely on analytics aggregation.
   */
  async getProfileScore(params: ProfileScoreParams): Promise<ProfileScore> {
    const { organizationId } = params;
    const { fromKey, toKey } = this.normalizeDateRange(
      params.fromDate,
      params.toDate,
    );

    try {
      const perDomain = await this.getSlaBreaches({
        ...params,
        fromDate: fromKey,
        toDate: toKey,
      });

      const overallTasks = perDomain.reduce(
        (sum, row) => sum + row.totalTasks,
        0,
      );
      const overallBreachedTasks = perDomain.reduce(
        (sum, row) => sum + row.breachedTasks,
        0,
      );

      const breachRate =
        overallTasks > 0 ? overallBreachedTasks / overallTasks : 0;
      const overallScore = Math.round((1 - breachRate) * 100);

      return {
        organizationId,
        fromDate: fromKey,
        toDate: toKey,
        overallTasks,
        overallBreachedTasks,
        overallScore,
        perDomain,
      };
    } catch (error) {
      this.logger.error(
        `Failed to compute profile score for org=${organizationId}`,
        (error as Error).stack ?? String(error),
      );
      throw error;
    }
  }

  /**
   * Normalizes any provided from/to dates to UTC date keys (YYYY-MM-DD).
   * If either is missing, default to a rolling window ending "today"
   * (UTC) with DEFAULT_LOOKBACK_DAYS lookback.
   */
  private normalizeDateRange(
    fromDate?: Date | string,
    toDate?: Date | string,
  ): { fromKey: string; toKey: string } {
    const now = new Date();

    const to =
      toDate != null
        ? toDateKey(toDate)
        : toDateKey(now);

    const defaultFromDate = new Date(
      now.getTime() - DEFAULT_LOOKBACK_DAYS * 24 * 60 * 60 * 1000,
    );

    const from =
      fromDate != null
        ? toDateKey(fromDate)
        : toDateKey(defaultFromDate);

    return { fromKey: from, toKey: to };
  }
}

===== END apps/api/src/orgo/insights/reports/reports.service.ts =====


===== BEGIN apps/api/src/orgo/orgo.module.ts =====
// apps/api/src/orgo/orgo.module.ts

import { Module } from '@nestjs/common';
import { APP_PIPE } from '@nestjs/core';

import { PersistenceModule } from '../persistence/persistence.module';

import { LoggerModule } from './core/logging/logger.module';
import { PayloadValidationPipe } from './core/validation/payload-validation.pipe';
import { ConfigValidationService } from './core/validation/config-validation.service';

import { TaskModule } from './core/tasks/task.module';
import { CaseModule } from './core/cases/case.module';
import { WorkflowModule } from './core/workflow/workflow.module';
import { LabelsModule } from './core/labels/labels.module';
import { OrgoConfigModule } from './config/config.module';

@Module({
  imports: [
    // DB / Prisma access
    PersistenceModule,

    // Cross-cutting infrastructure
    LoggerModule,
    OrgoConfigModule,

    // Core Orgo services
    TaskModule,
    CaseModule,
    WorkflowModule,
    LabelsModule,
  ],
  providers: [
    // Validate Orgo YAML/config bundles at startup
    ConfigValidationService,

    // Global payload validation (DTO + enum enforcement)
    {
      provide: APP_PIPE,
      useClass: PayloadValidationPipe,
    },
  ],
  exports: [
    // Re-export key feature modules so consumers can just import OrgoModule
    LoggerModule,
    OrgoConfigModule,
    TaskModule,
    CaseModule,
    WorkflowModule,
    LabelsModule,
  ],
})
export class OrgoModule {}

===== END apps/api/src/orgo/orgo.module.ts =====


===== BEGIN apps/api/src/orgo/security/audit/audit-trail.service.ts =====
import { Injectable, Logger } from '@nestjs/common';
import { Prisma } from '@prisma/client';
import { DatabaseService } from '../../core/database/database.service';

export type AuditEventType =
  | 'failed_login'
  | 'permission_escalation'
  | 'api_abuse'
  | 'data_export'
  | 'config_change';

export type AuditEventSeverity = 'low' | 'medium' | 'high' | 'critical';
export type AuditActorType = 'user' | 'system';

export interface AuditActivityMetadata {
  /**
   * Logical action name for the audit/activity log.
   * Examples: "config_updated", "permission_changed", "report_exported".
   */
  action: string;

  /**
   * What kind of entity this action is about.
   * Examples: "security_event", "role", "permission", "report".
   */
  targetType?: string;

  /**
   * ID of the target entity, if any (Task, Case, Role, etc.).
   * For security events this typically defaults to the security_events.id row.
   */
  targetId?: string | null;

  /**
   * Optional login/session context.
   */
  sessionId?: string | null;

  /**
   * Actor type stored in activity_logs.actor_type.
   * Defaults to "user" if userId is present, otherwise "system".
   */
  actorType?: AuditActorType;

  /**
   * Additional JSON details specific to the activity log row.
   * This will be merged on top of the base security event details.
   */
  activityDetails?: Record<string, unknown>;
}

export interface RecordAuditEventInput {
  /**
   * Tenant scope for the event. May be null for global/system-wide events in security_events.
   * Required if an activity_logs row should be created.
   */
  organizationId?: string | null;

  /**
   * User responsible for the event, if any.
   */
  userId?: string | null;

  /**
   * Network and client context (optional).
   */
  ipAddress?: string | null;
  userAgent?: string | null;

  /**
   * Security event classification and severity.
   */
  eventType: AuditEventType;
  severity: AuditEventSeverity;

  /**
   * Arbitrary structured details to store in security_events.details.
   */
  details?: Record<string, unknown>;

  /**
   * Optional activity log metadata. When provided (and organizationId is non-null),
   * an activity_logs entry will be created alongside the security_events row.
   */
  activity?: AuditActivityMetadata;
}

export interface RecordAuditEventSuccessData {
  securityEventId: string;
  activityLogId?: string | null;
}

export interface RecordAuditEventError {
  code: string;
  message: string;
  details?: Record<string, unknown>;
}

export interface RecordAuditEventResult {
  ok: boolean;
  data: RecordAuditEventSuccessData | null;
  error: RecordAuditEventError | null;
}

@Injectable()
export class AuditTrailService {
  private readonly logger = new Logger(AuditTrailService.name);

  constructor(private readonly databaseService: DatabaseService) {}

  /**
   * Generate an audit trail entry for a security‑relevant operation.
   *
   * Primary persistence:
   *   - security_events (always, if insert succeeds)
   * Optional secondary persistence:
   *   - activity_logs (only when organizationId and activity metadata are provided)
   *
   * Returns the standard { ok, data, error } result shape.
   */
  async recordAuditEvent(input: RecordAuditEventInput): Promise<RecordAuditEventResult> {
    const prisma = this.databaseService.getPrismaClient();

    // 1. Write canonical security_events row
    let securityEventId: string;

    try {
      const securityRows = await prisma.$queryRaw<{ id: string }[]>(
        Prisma.sql`
          INSERT INTO security_events (
            organization_id,
            user_id,
            event_type,
            ip_address,
            user_agent,
            details,
            severity
          ) VALUES (
            ${input.organizationId ?? null},
            ${input.userId ?? null},
            ${input.eventType},
            ${input.ipAddress ?? null},
            ${input.userAgent ?? null},
            ${input.details ?? {}},
            ${input.severity}
          )
          RETURNING id
        `,
      );

      if (!securityRows || securityRows.length === 0) {
        this.logger.error('security_events insert returned no rows');
        return {
          ok: false,
          data: null,
          error: {
            code: 'AUDIT_EVENT_WRITE_FAILED',
            message: 'Failed to record audit event (no row returned from security_events)',
          },
        };
      }

      securityEventId = securityRows[0].id;
    } catch (err) {
      const error = err as Error;
      this.logger.error(
        `Failed to record security event: ${error.message}`,
        error.stack,
      );

      return {
        ok: false,
        data: null,
        error: {
          code: 'AUDIT_EVENT_WRITE_FAILED',
          message: 'Failed to record audit event',
          details: {
            originalError: error.message,
          },
        },
      };
    }

    // 2. Optionally write a linked activity_logs row
    let activityLogId: string | null = null;

    if (input.activity && input.organizationId) {
      const activity = input.activity;

      const actorType: AuditActorType =
        activity.actorType ?? (input.userId ? 'user' : 'system');

      const targetType = activity.targetType ?? 'security_event';
      const targetId = activity.targetId ?? securityEventId;

      const activityDetails: Record<string, unknown> = {
        event_type: input.eventType,
        severity: input.severity,
        ip_address: input.ipAddress,
        user_agent: input.userAgent,
        security_event_id: securityEventId,
        ...(input.details ?? {}),
        ...(activity.activityDetails ?? {}),
      };

      try {
        const activityRows = await prisma.$queryRaw<{ id: string }[]>(
          Prisma.sql`
            INSERT INTO activity_logs (
              organization_id,
              user_id,
              session_id,
              actor_type,
              action,
              target_type,
              target_id,
              details
            ) VALUES (
              ${input.organizationId},
              ${input.userId ?? null},
              ${activity.sessionId ?? null},
              ${actorType},
              ${activity.action},
              ${targetType},
              ${targetId},
              ${activityDetails}
            )
            RETURNING id
          `,
        );

        if (activityRows && activityRows.length > 0) {
          activityLogId = activityRows[0].id;
        } else {
          this.logger.error(
            'activity_logs insert returned no rows for audit event',
          );
        }
      } catch (err) {
        const error = err as Error;
        this.logger.error(
          `Failed to record activity log for audit event: ${error.message}`,
          error.stack,
        );
        // Non‑fatal: we still return ok=true as the primary security event is persisted.
      }
    }

    // 3. Return standard result shape
    return {
      ok: true,
      data: {
        securityEventId,
        activityLogId,
      },
      error: null,
    };
  }
}

===== END apps/api/src/orgo/security/audit/audit-trail.service.ts =====


===== BEGIN apps/api/src/orgo/security/auth/auth.guard.ts =====

===== END apps/api/src/orgo/security/auth/auth.guard.ts =====


===== BEGIN apps/api/src/orgo/security/auth/auth.module.ts =====
import { Module } from '@nestjs/common';
import { ConfigModule, ConfigService } from '@nestjs/config';
import { JwtModule, JwtModuleOptions } from '@nestjs/jwt';
import { PassportModule } from '@nestjs/passport';

import { RbacModule } from '../../backbone/rbac/rbac.module';
import { AuthService } from './auth.service';
import { JwtStrategy } from './jwt.strategy';
import { AuthGuard } from './auth.guard';

/**
 * AuthModule
 *
 * Responsibilities:
 *  - Configure JWT- and Passport-based authentication.
 *  - Expose AuthService for validating credentials and tokens.
 *  - Register JwtStrategy for attaching user/org context to requests.
 *  - Integrate with RBAC (RbacModule) for permission checks.
 */
@Module({
  imports: [
    // Make environment/config available (ENVIRONMENT, secrets, etc.).
    ConfigModule,

    // Configure Passport to use JWT as the default strategy.
    PassportModule.register({
      defaultStrategy: 'jwt',
      session: false,
      property: 'user', // request.user
    }),

    // JWT configuration is driven by env/config via ConfigService.
    JwtModule.registerAsync({
      imports: [ConfigModule],
      inject: [ConfigService],
      useFactory: (config: ConfigService): JwtModuleOptions => {
        const secret =
          config.get<string>('ORGO_JWT_SECRET') ||
          config.get<string>('security.jwt.secret') ||
          'change-me-in-prod';

        const expiresInEnv =
          config.get<string | number>('ORGO_ACCESS_TOKEN_TTL_SECONDS') ||
          config.get<string | number>('security.jwt.accessTokenTtlSeconds') ||
          3600;

        // Ensure expiresIn is a number or string acceptable to @nestjs/jwt
        const expiresIn =
          typeof expiresInEnv === 'number'
            ? expiresInEnv
            : parseInt(String(expiresInEnv), 10) || 3600;

        return {
          secret,
          signOptions: {
            expiresIn,
          },
        };
      },
    }),

    // RBAC services (role/permission checks).
    RbacModule,
  ],
  providers: [
    AuthService,
    JwtStrategy,
    AuthGuard,
  ],
  exports: [
    AuthService,
    JwtModule,
    PassportModule,
    AuthGuard,
  ],
})
export class AuthModule {}

===== END apps/api/src/orgo/security/auth/auth.module.ts =====


===== BEGIN apps/api/src/orgo/security/auth/auth.service.ts =====
import {
  BadRequestException,
  ForbiddenException,
  Injectable,
  Logger,
  Optional,
  UnauthorizedException,
} from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { JwtService, JwtSignOptions, JwtVerifyOptions } from '@nestjs/jwt';
import { ConfigService } from '@nestjs/config';
import { Repository } from 'typeorm';
import * as bcrypt from 'bcrypt';

import { User } from '../../backbone/user/user.entity';
import { EmailService } from '../../core/email/email.service';
import {
  NotificationService,
  NotificationChannel,
} from '../../core/notifications/notification.service';

export interface AuthTokens {
  accessToken: string;
  refreshToken: string;
}

export interface AuthenticatedUser {
  id: string | number;
  email?: string | null;
  [key: string]: any;
}

export interface AuthResult {
  user: AuthenticatedUser;
  tokens: AuthTokens;
}

@Injectable()
export class AuthService {
  private readonly logger = new Logger(AuthService.name);

  private readonly accessTokenTtl: string | number;
  private readonly refreshTokenTtl: string | number;
  private readonly emailVerificationTtl: string | number;
  private readonly passwordResetTtl: string | number;
  private readonly passwordSaltRounds: number;
  private readonly frontendBaseUrl: string;

  constructor(
    @InjectRepository(User)
    private readonly userRepository: Repository<User>,
    private readonly jwtService: JwtService,
    private readonly configService: ConfigService,
    private readonly emailService: EmailService,
    @Optional()
    private readonly notificationService?: NotificationService,
  ) {
    this.accessTokenTtl =
      this.configService.get<string | number>('AUTH_ACCESS_TOKEN_TTL') ??
      '15m';
    this.refreshTokenTtl =
      this.configService.get<string | number>('AUTH_REFRESH_TOKEN_TTL') ??
      '7d';
    this.emailVerificationTtl =
      this.configService.get<string | number>('AUTH_EMAIL_VERIFICATION_TTL') ??
      '2d';
    this.passwordResetTtl =
      this.configService.get<string | number>('AUTH_PASSWORD_RESET_TTL') ??
      '1h';

    const saltConfig =
      this.configService.get<number>('AUTH_PASSWORD_SALT_ROUNDS') ??
      parseInt(process.env.AUTH_PASSWORD_SALT_ROUNDS || '', 10);
    this.passwordSaltRounds = Number.isFinite(saltConfig) && saltConfig > 0
      ? saltConfig
      : 12;

    this.frontendBaseUrl =
      this.configService.get<string>('APP_FRONTEND_BASE_URL') ??
      process.env.APP_FRONTEND_BASE_URL ??
      'http://localhost:3000';
  }

  /**
   * Login with email and password, returning the authenticated user and tokens.
   */
  async loginWithEmailAndPassword(
    email: string,
    password: string,
  ): Promise<AuthResult> {
    if (!email?.trim() || !password?.trim()) {
      throw new BadRequestException('Email and password are required.');
    }

    const user = await this.findUserByEmail(email);
    if (!user) {
      throw new UnauthorizedException('Invalid credentials.');
    }

    await this.ensureUserIsActive(user);
    await this.verifyPassword(user, password);

    await this.markLastLogin(user);

    const tokens = await this.issueTokens(user);
    const safeUser = this.toSafeUser(user);

    return { user: safeUser, tokens };
  }

  /**
   * Register a new user with email and password.
   * Returns the newly created user and their tokens.
   * Optionally sends an email verification link.
   */
  async register(params: {
    email: string;
    password: string;
    metadata?: Record<string, any>;
  }): Promise<AuthResult> {
    const email = params.email?.trim().toLowerCase();
    const password = params.password?.trim();

    if (!email) {
      throw new BadRequestException('Email is required.');
    }

    if (!password) {
      throw new BadRequestException('Password is required.');
    }

    await this.ensureEmailIsAvailable(email);

    const passwordHash = await this.hashPassword(password);

    const user = this.userRepository.create({
      email,
      passwordHash,
      ...(params.metadata ?? {}),
    } as Partial<User>);

    const saved = await this.userRepository.save(user);

    // Fire-and-forget; do not block registration on email issues.
    this.sendVerificationEmailSafe(saved).catch((err) => {
      this.logger.warn(
        `Failed to send verification email for user "${saved.id}": ${err.message}`,
      );
    });

    const tokens = await this.issueTokens(saved);
    const safeUser = this.toSafeUser(saved);

    return { user: safeUser, tokens };
  }

  /**
   * Refreshes access and refresh tokens using a valid refresh token.
   */
  async refreshTokens(refreshToken: string): Promise<AuthResult> {
    if (!refreshToken?.trim()) {
      throw new BadRequestException('Refresh token is required.');
    }

    let payload: any;

    try {
      payload = await this.jwtService.verifyAsync(
        refreshToken,
        this.getJwtVerifyOptions(),
      );
    } catch (err) {
      this.logger.debug(`Invalid refresh token: ${(err as Error).message}`);
      throw new UnauthorizedException('Invalid refresh token.');
    }

    if (payload?.type !== 'refresh' || !payload?.sub) {
      throw new UnauthorizedException('Invalid refresh token.');
    }

    const user = await this.userRepository.findOne({
      where: { id: payload.sub },
    });

    if (!user) {
      throw new UnauthorizedException('User not found for this token.');
    }

    await this.ensureUserIsActive(user);

    const tokens = await this.issueTokens(user);
    const safeUser = this.toSafeUser(user);

    return { user: safeUser, tokens };
  }

  /**
   * Initiates a password reset by sending a reset email.
   * Does not reveal whether the email exists to avoid user enumeration.
   */
  async requestPasswordReset(email: string): Promise<void> {
    const normalizedEmail = email?.trim().toLowerCase();
    if (!normalizedEmail) {
      throw new BadRequestException('Email is required.');
    }

    const user = await this.userRepository.findOne({
      where: { email: normalizedEmail },
    });

    if (!user) {
      // Do not reveal existence; log internally.
      this.logger.debug(
        `Password reset requested for non-existent email "${normalizedEmail}".`,
      );
      return;
    }

    const token = await this.jwtService.signAsync(
      {
        sub: user.id,
        email: user.email,
        purpose: 'reset-password',
      },
      {
        ...this.getJwtBaseOptions(),
        expiresIn: this.passwordResetTtl,
      },
    );

    const resetUrl = `${this.frontendBaseUrl}/auth/reset-password?token=${encodeURIComponent(
      token,
    )}`;

    await this.emailService.sendTemplate({
      to: user.email!,
      template: 'auth.password-reset',
      context: {
        userId: user.id,
        email: user.email,
        token,
        url: resetUrl,
      },
    });
  }

  /**
   * Resets a user's password using a previously issued reset token.
   */
  async resetPassword(token: string, newPassword: string): Promise<void> {
    if (!token?.trim()) {
      throw new BadRequestException('Reset token is required.');
    }

    if (!newPassword?.trim()) {
      throw new BadRequestException('New password is required.');
    }

    let payload: any;

    try {
      payload = await this.jwtService.verifyAsync(
        token,
        this.getJwtVerifyOptions(),
      );
    } catch (err) {
      this.logger.debug(`Invalid reset token: ${(err as Error).message}`);
      throw new BadRequestException('Invalid or expired reset token.');
    }

    if (payload?.purpose !== 'reset-password' || !payload?.sub) {
      throw new BadRequestException('Invalid reset token.');
    }

    const user = await this.userRepository.findOne({
      where: { id: payload.sub },
    });

    if (!user) {
      throw new BadRequestException('Invalid reset token.');
    }

    await this.ensureUserIsActive(user);

    const passwordHash = await this.hashPassword(newPassword);
    user.passwordHash = passwordHash as any;

    await this.userRepository.save(user);

    // Optional security notification
    this.notificationService
      ?.notify({
        userId: String(user.id),
        type: 'auth.password-changed',
        channels: [NotificationChannel.IN_APP, NotificationChannel.EMAIL],
        title: 'Your password was changed',
        body: 'If you did not perform this change, please contact support immediately.',
        data: { userId: user.id },
        email: user.email
          ? {
              to: user.email,
              subject: 'Your password was changed',
              template: 'auth.password-changed',
              context: {
                userId: user.id,
                email: user.email,
              },
            }
          : undefined,
      })
      .catch((err) => {
        this.logger.warn(
          `Failed to send password-changed notification for user "${user.id}": ${err.message}`,
        );
      });
  }

  /**
   * Sends an email verification link to a user.
   */
  async sendVerificationEmail(userId: string | number): Promise<void> {
    const user = await this.userRepository.findOne({
      where: { id: userId },
    });

    if (!user) {
      throw new BadRequestException('User not found.');
    }

    await this.sendVerificationEmailSafe(user);
  }

  /**
   * Verifies a user's email using a verification token.
   */
  async verifyEmail(token: string): Promise<void> {
    if (!token?.trim()) {
      throw new BadRequestException('Verification token is required.');
    }

    let payload: any;

    try {
      payload = await this.jwtService.verifyAsync(
        token,
        this.getJwtVerifyOptions(),
      );
    } catch (err) {
      this.logger.debug(`Invalid verification token: ${(err as Error).message}`);
      throw new BadRequestException('Invalid or expired verification token.');
    }

    if (payload?.purpose !== 'verify-email' || !payload?.sub) {
      throw new BadRequestException('Invalid verification token.');
    }

    const user = await this.userRepository.findOne({
      where: { id: payload.sub },
    });

    if (!user) {
      throw new BadRequestException('Invalid verification token.');
    }

    await this.ensureUserIsActive(user);

    // If already verified, do nothing.
    if ((user as any).isEmailVerified === true) {
      return;
    }

    (user as any).isEmailVerified = true;
    await this.userRepository.save(user);
  }

  /**
   * Validates credentials and returns the user if valid. Throws otherwise.
   * This is suitable for use by Passport strategies.
   */
  async validateUser(
    email: string,
    password: string,
  ): Promise<AuthenticatedUser> {
    const result = await this.loginWithEmailAndPassword(email, password);
    return result.user;
  }

  /**
   * Ensures the user is active (not disabled/locked).
   * Adjust this to match your actual user status fields.
   */
  private async ensureUserIsActive(user: User): Promise<void> {
    const status = (user as any).status;
    if (status && status !== 'active') {
      throw new ForbiddenException('User account is not active.');
    }
  }

  private async findUserByEmail(email: string): Promise<User | null> {
    const normalized = email.trim().toLowerCase();
    return this.userRepository.findOne({ where: { email: normalized } });
  }

  private async ensureEmailIsAvailable(email: string): Promise<void> {
    const existing = await this.userRepository.findOne({
      where: { email },
    });

    if (existing) {
      throw new BadRequestException('Email is already in use.');
    }
  }

  private async verifyPassword(user: User, password: string): Promise<void> {
    const hash = (user as any).passwordHash;
    if (!hash) {
      throw new UnauthorizedException('Invalid credentials.');
    }

    const match = await bcrypt.compare(password, hash);
    if (!match) {
      throw new UnauthorizedException('Invalid credentials.');
    }
  }

  private async hashPassword(password: string): Promise<string> {
    return bcrypt.hash(password, this.passwordSaltRounds);
  }

  private async markLastLogin(user: User): Promise<void> {
    if (!('lastLoginAt' in user)) {
      return;
    }

    (user as any).lastLoginAt = new Date();
    await this.userRepository.save(user);
  }

  private async issueTokens(user: User): Promise<AuthTokens> {
    const payloadBase = {
      sub: user.id,
      email: (user as any).email,
    };

    const accessToken = await this.jwtService.signAsync(
      {
        ...payloadBase,
        type: 'access',
      },
      {
        ...this.getJwtBaseOptions(),
        expiresIn: this.accessTokenTtl,
      },
    );

    const refreshToken = await this.jwtService.signAsync(
      {
        ...payloadBase,
        type: 'refresh',
      },
      {
        ...this.getJwtBaseOptions(),
        expiresIn: this.refreshTokenTtl,
      },
    );

    return { accessToken, refreshToken };
  }

  private toSafeUser(user: User): AuthenticatedUser {
    const { passwordHash, ...rest } = user as any;
    return rest as AuthenticatedUser;
  }

  private getJwtBaseOptions(): JwtSignOptions {
    const issuer =
      this.configService.get<string>('AUTH_JWT_ISSUER') ??
      process.env.AUTH_JWT_ISSUER;
    const audience =
      this.configService.get<string>('AUTH_JWT_AUDIENCE') ??
      process.env.AUTH_JWT_AUDIENCE;

    const options: JwtSignOptions = {};
    if (issuer) {
      options.issuer = issuer;
    }
    if (audience) {
      options.audience = audience;
    }
    return options;
  }

  private getJwtVerifyOptions(): JwtVerifyOptions {
    const base = this.getJwtBaseOptions();
    const options: JwtVerifyOptions = {
      issuer: base.issuer,
      audience: base.audience,
    };
    return options;
  }

  private async sendVerificationEmailSafe(user: User): Promise<void> {
    const email = (user as any).email;
    if (!email) {
      return;
    }

    const token = await this.jwtService.signAsync(
      {
        sub: user.id,
        email,
        purpose: 'verify-email',
      },
      {
        ...this.getJwtBaseOptions(),
        expiresIn: this.emailVerificationTtl,
      },
    );

    const verifyUrl = `${this.frontendBaseUrl}/auth/verify-email?token=${encodeURIComponent(
      token,
    )}`;

    await this.emailService.sendTemplate({
      to: email,
      template: 'auth.verify-email',
      context: {
        userId: user.id,
        email,
        token,
        url: verifyUrl,
      },
    });
  }
}

===== END apps/api/src/orgo/security/auth/auth.service.ts =====


===== BEGIN apps/api/src/orgo/security/compliance/compliance-export.service.ts =====
import { Injectable, Logger } from '@nestjs/common';
import { Prisma, PrismaClient } from '@prisma/client';
import { v4 as uuidv4 } from 'uuid';

import { DatabaseService } from '../../core/database/database.service';

export type ComplianceAuditLogSource = 'activity_log' | 'security_event';

export interface ComplianceAuditLogExportOptions {
  /**
   * Organization to scope the export to.
   * If null/undefined, all organizations are included (restricted to caller's RBAC elsewhere).
   */
  organizationId?: string | null;

  /**
   * Inclusive lower bound for log timestamps.
   */
  from: Date;

  /**
   * Inclusive upper bound for log timestamps.
   */
  to: Date;

  /**
   * Whether to include rows from activity_logs.
   * Defaults to true.
   */
  includeActivityLogs?: boolean;

  /**
   * Whether to include rows from security_events.
   * Defaults to true.
   */
  includeSecurityEvents?: boolean;

  /**
   * Maximum number of rows to return.
   * This is further clamped by the hard upper bound.
   */
  maxRows?: number;

  /**
   * If false (default), PII and sensitive fields are masked.
   * If true, raw values are returned (caller must ensure appropriate RBAC).
   */
  includeSensitiveFields?: boolean;

  /**
   * Optional identity of the user requesting the export.
   * Used only for the security_events audit row.
   */
  requestedByUserId?: string | null;

  /**
   * Optional IP address of the requester (for audit trail).
   */
  requestIp?: string | null;

  /**
   * Optional user agent of the requester (for audit trail).
   */
  requestUserAgent?: string | null;
}

export interface ComplianceAuditLogExportRow {
  /**
   * ISO-8601 timestamp of the original log row (created_at).
   */
  timestamp: string;
  source: ComplianceAuditLogSource;

  organizationId: string | null;
  userId: string | null;
  sessionId: string | null;

  /**
   * For activity_logs: action.
   * For security_events: event_type.
   */
  eventType: string;

  /**
   * For security_events only; null for activity_logs.
   */
  severity: string | null;

  ipAddress: string | null;
  userAgent: string | null;

  /**
   * For activity_logs only; null for security_events.
   */
  targetType: string | null;
  targetId: string | null;

  /**
   * JSON payload from details column (possibly masked).
   */
  details: Record<string, unknown> | null;
}

export interface ComplianceAuditLogExportResult {
  exportId: string;
  generatedAt: Date;

  from: Date;
  to: Date;
  organizationId: string | null;

  /**
   * Number of rows actually returned (after masking and truncation).
   */
  rowCount: number;

  /**
   * True if more rows exist in the given window than were returned
   * (i.e. export was truncated at maxRows).
   */
  hasMore: boolean;

  rows: ComplianceAuditLogExportRow[];
}

/**
 * Local view of the activity_logs row shape.
 * Mirrors the schema in the database; not all columns are included.
 */
type ActivityLogRow = {
  id: string;
  organization_id: string;
  user_id: string | null;
  session_id: string | null;
  actor_type: 'user' | 'system';
  action: string;
  target_type: string | null;
  target_id: string | null;
  details: Prisma.JsonValue | null;
  created_at: Date;
};

/**
 * Local view of the security_events row shape.
 * Mirrors the schema in the database; not all columns are included.
 */
type SecurityEventRow = {
  id: string;
  organization_id: string | null;
  user_id: string | null;
  event_type: 'failed_login' | 'permission_escalation' | 'api_abuse' | 'data_export' | 'config_change';
  ip_address: string | null;
  user_agent: string | null;
  details: Prisma.JsonValue | null;
  severity: 'low' | 'medium' | 'high' | 'critical';
  created_at: Date;
};

/**
 * Service responsible for preparing audit-log exports (activity_logs + security_events)
 * for compliance and regulatory review. Exports are:
 *
 * - Scoped by organization and time window.
 * - Row-limited to protect the system.
 * - Optionally PII-masked, depending on includeSensitiveFields.
 *
 * RBAC / visibility checks are enforced at the controller/guard layer;
 * this service only implements the data shaping and audit logging.
 */
@Injectable()
export class ComplianceExportService {
  /**
   * Hard upper bound for any single export, regardless of config.
   * This should stay aligned with analytics/export limits.
   */
  private static readonly HARD_ROW_LIMIT = 100_000;

  /**
   * Default soft limit when no explicit maxRows is provided.
   * This is aligned with the production analytics export default (50k rows).
   */
  private static readonly DEFAULT_SOFT_ROW_LIMIT = 50_000;

  private readonly logger = new Logger(ComplianceExportService.name);

  constructor(private readonly databaseService: DatabaseService) {}

  private get prisma(): PrismaClient {
    return this.databaseService.getPrismaClient();
  }

  async exportAuditLog(
    options: ComplianceAuditLogExportOptions,
  ): Promise<ComplianceAuditLogExportResult> {
    const from = new Date(options.from);
    const to = new Date(options.to);

    if (Number.isNaN(from.getTime()) || Number.isNaN(to.getTime())) {
      throw new Error('Invalid from/to date supplied to ComplianceExportService.exportAuditLog');
    }

    if (from > to) {
      throw new Error('"from" must be less than or equal to "to" in ComplianceExportService.exportAuditLog');
    }

    const includeActivityLogs = options.includeActivityLogs ?? true;
    const includeSecurityEvents = options.includeSecurityEvents ?? true;

    if (!includeActivityLogs && !includeSecurityEvents) {
      throw new Error('At least one of includeActivityLogs/includeSecurityEvents must be true');
    }

    const maxRows = this.resolveMaxRows(options.maxRows);
    const includeSensitive = options.includeSensitiveFields === true;

    this.logger.log(
      `Preparing compliance audit log export from ${from.toISOString()} to ${to.toISOString()} ` +
        `(org=${options.organizationId ?? 'ALL'}, maxRows=${maxRows}, includeSensitive=${includeSensitive})`,
    );

    const [activityLogs, securityEvents] = await Promise.all([
      includeActivityLogs ? this.fetchActivityLogs(options.organizationId, from, to, maxRows) : Promise.resolve([]),
      includeSecurityEvents ? this.fetchSecurityEvents(options.organizationId, from, to, maxRows) : Promise.resolve([]),
    ]);

    const combined: ComplianceAuditLogExportRow[] = [
      ...activityLogs.map((row) => this.mapActivityLogRow(row)),
      ...securityEvents.map((row) => this.mapSecurityEventRow(row)),
    ];

    combined.sort(
      (a, b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime(),
    );

    const hasMore = combined.length > maxRows;
    let rows = hasMore ? combined.slice(0, maxRows) : combined;

    if (!includeSensitive) {
      rows = rows.map((row) => this.maskRow(row));
    }

    const exportId = uuidv4();
    const generatedAt = new Date();

    await this.recordComplianceSecurityEvent(exportId, options, rows.length, hasMore, from, to);

    this.logger.log(
      `Compliance audit log export ${exportId} prepared with ${rows.length} rows (hasMore=${hasMore})`,
    );

    return {
      exportId,
      generatedAt,
      from,
      to,
      organizationId: options.organizationId ?? null,
      rowCount: rows.length,
      hasMore,
      rows,
    };
  }

  private resolveMaxRows(requested?: number): number {
    const envLimitRaw = process.env.COMPLIANCE_EXPORT_MAX_ROWS;
    const envLimit =
      envLimitRaw && !Number.isNaN(Number(envLimitRaw)) ? Number(envLimitRaw) : undefined;

    const base =
      requested && requested > 0
        ? requested
        : envLimit && envLimit > 0
        ? envLimit
        : ComplianceExportService.DEFAULT_SOFT_ROW_LIMIT;

    return Math.min(base, ComplianceExportService.HARD_ROW_LIMIT);
  }

  private async fetchActivityLogs(
    organizationId: string | null | undefined,
    from: Date,
    to: Date,
    maxRows: number,
  ): Promise<ActivityLogRow[]> {
    const where: Prisma.activity_logsWhereInput = {
      created_at: {
        gte: from,
        lte: to,
      },
      ...(organizationId ? { organization_id: organizationId } : {}),
    };

    return (this.prisma.activity_logs.findMany({
      where,
      orderBy: { created_at: 'asc' },
      take: maxRows,
    }) as unknown) as ActivityLogRow[];
  }

  private async fetchSecurityEvents(
    organizationId: string | null | undefined,
    from: Date,
    to: Date,
    maxRows: number,
  ): Promise<SecurityEventRow[]> {
    const where: Prisma.security_eventsWhereInput = {
      created_at: {
        gte: from,
        lte: to,
      },
      ...(organizationId ? { organization_id: organizationId } : {}),
    };

    return (this.prisma.security_events.findMany({
      where,
      orderBy: { created_at: 'asc' },
      take: maxRows,
    }) as unknown) as SecurityEventRow[];
  }

  private mapActivityLogRow(row: ActivityLogRow): ComplianceAuditLogExportRow {
    return {
      timestamp: row.created_at.toISOString(),
      source: 'activity_log',
      organizationId: row.organization_id,
      userId: row.user_id,
      sessionId: row.session_id,
      eventType: row.action,
      severity: null,
      ipAddress: null,
      userAgent: null,
      targetType: row.target_type,
      targetId: row.target_id,
      details: (row.details as Record<string, unknown> | null) ?? null,
    };
  }

  private mapSecurityEventRow(row: SecurityEventRow): ComplianceAuditLogExportRow {
    return {
      timestamp: row.created_at.toISOString(),
      source: 'security_event',
      organizationId: row.organization_id,
      userId: row.user_id,
      sessionId: null,
      eventType: row.event_type,
      severity: row.severity,
      ipAddress: row.ip_address,
      userAgent: row.user_agent,
      targetType: null,
      targetId: null,
      details: (row.details as Record<string, unknown> | null) ?? null,
    };
  }

  private maskRow(row: ComplianceAuditLogExportRow): ComplianceAuditLogExportRow {
    return {
      ...row,
      userId: row.userId ? this.hashIdentifier(row.userId) : null,
      sessionId: row.sessionId ? this.hashIdentifier(row.sessionId) : null,
      ipAddress: row.ipAddress ? this.maskIp(row.ipAddress) : null,
      details: row.details ? (this.maskDetails(row.details) as Record<string, unknown>) : null,
    };
  }

  private maskDetails(value: unknown): unknown {
    if (value === null || value === undefined) {
      return value;
    }

    if (Array.isArray(value)) {
      return value.map((v) => this.maskDetails(v));
    }

    if (typeof value !== 'object') {
      return value;
    }

    const piiKeys = new Set([
      'email',
      'email_address',
      'phone',
      'phone_number',
      'ssn',
      'national_id',
      'nationalInsuranceNumber',
    ]);

    const masked: Record<string, unknown> = {};
    for (const [key, raw] of Object.entries(value as Record<string, unknown>)) {
      if (piiKeys.has(key)) {
        masked[key] = raw == null ? raw : '***REDACTED***';
      } else if (key.toLowerCase().includes('ip')) {
        masked[key] = raw == null ? raw : this.maskIp(String(raw));
      } else if (key.toLowerCase().endsWith('_id')) {
        masked[key] = raw == null ? raw : this.hashIdentifier(String(raw));
      } else if (typeof raw === 'object') {
        masked[key] = this.maskDetails(raw);
      } else {
        masked[key] = raw;
      }
    }

    return masked;
  }

  private maskIp(ip: string): string {
    const ipv4Parts = ip.split('.');
    if (ipv4Parts.length === 4) {
      return `${ipv4Parts[0]}.${ipv4Parts[1]}.${ipv4Parts[2]}.x`;
    }

    if (ip.includes(':')) {
      const parts = ip.split(':');
      if (parts.length > 2) {
        return [...parts.slice(0, parts.length - 2), 'xxxx', 'xxxx'].join(':');
      }
    }

    return '***REDACTED***';
  }

  private hashIdentifier(value: string): string {
    // Lightweight, deterministic hash suitable for masking IDs in exports.
    // Not intended as a cryptographic guarantee.
    let hash = 0;
    for (let i = 0; i < value.length; i += 1) {
      hash = (hash << 5) - hash + value.charCodeAt(i);
      hash |= 0; // Convert to 32-bit int
    }
    return `hash_${Math.abs(hash).toString(16)}`;
  }

  private async recordComplianceSecurityEvent(
    exportId: string,
    options: ComplianceAuditLogExportOptions,
    rowCount: number,
    hasMore: boolean,
    from: Date,
    to: Date,
  ): Promise<void> {
    try {
      await this.prisma.security_events.create({
        data: {
          organization_id: options.organizationId ?? null,
          user_id: options.requestedByUserId ?? null,
          event_type: 'data_export',
          ip_address: options.requestIp ?? null,
          user_agent: options.requestUserAgent ?? null,
          severity: 'medium',
          details: {
            exportId,
            kind: 'compliance_audit_log_export',
            rowCount,
            hasMore,
            from: from.toISOString(),
            to: to.toISOString(),
          } as Prisma.JsonObject,
        },
      });
    } catch (error) {
      this.logger.error(
        `Failed to record compliance export security event for ${exportId}`,
        (error as Error)?.stack,
      );
    }
  }
}

===== END apps/api/src/orgo/security/compliance/compliance-export.service.ts =====


===== BEGIN apps/api/src/orgo/security/logging/log-query.service.ts =====

===== END apps/api/src/orgo/security/logging/log-query.service.ts =====


===== BEGIN apps/api/src/orgo/security/privacy/privacy.service.ts =====
import { Injectable } from '@nestjs/common';

/**
 * Canonical VISIBILITY values (DB enum visibility_enum).
 *
 * See Orgo v3 foundations doc for semantics:
 *   PUBLIC      – visible across the org (subject to RBAC)
 *   INTERNAL    – limited to org-internal teams/roles
 *   RESTRICTED  – minimal set of users/roles
 *   ANONYMISED  – pseudonymised or fully anonymised content
 */
export type Visibility = 'PUBLIC' | 'INTERNAL' | 'RESTRICTED' | 'ANONYMISED';

/**
 * Options controlling how anonymisation is applied.
 *
 * - piiFieldPaths / strongPiiFieldPaths:
 *     Dot-separated path selectors (e.g. "metadata.person.email").
 *     These are matched in a case-insensitive, punctuation-insensitive way.
 * - maskStrategy:
 *     "redact" – replace value with a redaction marker (default).
 *     "hash"   – replace value with a deterministic non-cryptographic hash.
 *     "drop"   – remove the field entirely from the payload.
 * - customRedactionText:
 *     Custom marker to use instead of "[redacted]" when maskStrategy = "redact".
 */
export interface AnonymizeOptions {
  piiFieldPaths?: string[];
  strongPiiFieldPaths?: string[];
  maskStrategy?: 'redact' | 'hash' | 'drop';
  customRedactionText?: string;
}

/**
 * Options for export-time masking.
 *
 * - allowedVisibilities:
 *     VISIBILITY values that may appear in raw exports.
 *     If omitted, defaults to ["PUBLIC","INTERNAL"] (per Insights export guardrails).
 * - dropIfVisibilityDisallowed:
 *     If true (default), entities with disallowed visibility are dropped (return null).
 *     If false, entities with disallowed visibility are anonymised instead.
 *
 * All other fields are forwarded to anonymisation logic if masking is needed.
 */
export interface ExportPrivacyOptions extends AnonymizeOptions {
  allowedVisibilities?: Visibility[];
  dropIfVisibilityDisallowed?: boolean;
}

/**
 * PrivacyService centralises anonymisation and export-time masking rules.
 *
 * Typical usage:
 *   - When persisting highly sensitive records with visibility = ANONYMISED,
 *     call anonymizePayloadForVisibility before writing to the DB.
 *   - When preparing exports, call maskForExport on each record to enforce
 *     allowedVisibilities and PII masking.
 */
@Injectable()
export class PrivacyService {
  /**
   * Default visibilities allowed for raw exports from analytics/reporting.
   * This mirrors the default ["PUBLIC","INTERNAL"] configuration for
   * analytics exports.
   */
  public static readonly DEFAULT_EXPORT_ALLOWED_VISIBILITIES: readonly Visibility[] = [
    'PUBLIC',
    'INTERNAL',
  ] as const;

  /**
   * Default text used when maskStrategy = "redact".
   */
  private static readonly DEFAULT_REDACTION_TEXT = '[redacted]';

  /**
   * Field-name heuristics for PII. Keys are stored in a normalised form:
   *   - lower-cased
   *   - all non-alphanumeric characters removed
   *
   * Example:
   *   "full_name"   → "fullname"
   *   "emailAddress" → "emailaddress"
   */
  private readonly defaultPiiKeys: Set<string> = new Set<string>([
    // Names
    'name',
    'fullname',
    'firstname',
    'lastname',
    // Emails
    'email',
    'emailaddress',
    'primarycontactemail',
    // Phones
    'phone',
    'phonenumber',
    'primarycontactphone',
    // Dates of birth
    'dateofbirth',
    'dob',
    // Addresses
    'address',
    'homeaddress',
    'postaladdress',
    // Identity / reference IDs
    'personid',
    'employeeid',
    'studentid',
    'subjectid',
    'hrcaseid',
  ]);

  /**
   * Field-name heuristics for strong PII (national IDs, sensitive identifiers).
   * These are treated the same as defaultPiiKeys by this service, but are
   * separated to allow more aggressive strategies in the future if needed.
   */
  private readonly defaultStrongPiiKeys: Set<string> = new Set<string>([
    'nationalid',
    'ssn',
    'socialsecuritynumber',
    'passportnumber',
  ]);

  /**
   * Normalises a VISIBILITY token from API/JSON/config form into the canonical
   * upper-case enum used in the DB.
   *
   * Throws if the token is not recognised.
   */
  public normalizeVisibilityToken(visibility: string | Visibility): Visibility {
    const upper = String(visibility).toUpperCase().trim();

    switch (upper) {
      case 'PUBLIC':
      case 'INTERNAL':
      case 'RESTRICTED':
      case 'ANONYMISED':
        return upper;
      default:
        throw new Error(`Unknown visibility token: "${visibility}"`);
    }
  }

  /**
   * Apply anonymisation according to a target VISIBILITY.
   *
   * Currently:
   *   - For ANONYMISED: deep-clone and anonymise using the provided options.
   *   - For PUBLIC / INTERNAL / RESTRICTED: payload is returned unchanged.
   *
   * This method is intended to be used when creating/updating entities where
   * the persisted visibility is known (e.g. HR cases with ANONYMISED visibility).
   */
  public anonymizePayloadForVisibility<T>(
    payload: T,
    visibility: Visibility | string,
    options?: AnonymizeOptions,
  ): T {
    const normalised = this.normalizeVisibilityToken(visibility);

    if (normalised !== 'ANONYMISED') {
      // Non-anonymised visibilities are passed through unchanged here.
      // Access control and visibility enforcement are handled elsewhere.
      return payload;
    }

    return this.anonymizePayload(payload, options);
  }

  /**
   * Deep-clone and anonymise a payload using a combination of:
   *   - builtin PII heuristics (field-name based), and
   *   - explicit piiFieldPaths / strongPiiFieldPaths.
   *
   * The original payload is never mutated.
   */
  public anonymizePayload<T>(payload: T, options?: AnonymizeOptions): T {
    const merged = this.mergeOptions(options);
    return this.deepCloneAndAnonymize(payload as unknown, merged) as T;
  }

  /**
   * Apply export-time visibility and PII rules to a single record.
   *
   * Behaviour:
   *   1. Normalises the record's visibility token.
   *   2. If visibility is not in allowedVisibilities:
   *        - If dropIfVisibilityDisallowed (default true): returns null.
   *        - Otherwise: returns an anonymised version of the payload.
   *   3. If visibility is allowed:
   *        - If no masking options are provided, returns payload unchanged.
   *        - If piiFieldPaths / strongPiiFieldPaths are provided (and/or
   *          maskStrategy is set), returns an anonymised clone of the payload.
   */
  public maskForExport<T>(
    payload: T,
    visibility: Visibility | string,
    options?: ExportPrivacyOptions,
  ): T | null {
    const normalisedVisibility = this.normalizeVisibilityToken(visibility);
    const allowed =
      options?.allowedVisibilities ??
      (PrivacyService.DEFAULT_EXPORT_ALLOWED_VISIBILITIES.slice() as Visibility[]);
    const dropIfDisallowed = options?.dropIfVisibilityDisallowed ?? true;

    if (!allowed.includes(normalisedVisibility)) {
      if (dropIfDisallowed) {
        return null;
      }

      // Visibility is disallowed for raw export, but caller opted to keep the
      // record in anonymised form.
      return this.anonymizePayload(payload, options);
    }

    // Visibility is allowed. If caller provided no masking-related options,
    // return the payload unchanged.
    const hasExplicitMaskingConfig =
      (options?.piiFieldPaths && options.piiFieldPaths.length > 0) ||
      (options?.strongPiiFieldPaths && options.strongPiiFieldPaths.length > 0) ||
      typeof options?.maskStrategy === 'string';

    if (!hasExplicitMaskingConfig) {
      return payload;
    }

    // Caller requested masking even though visibility is allowed.
    return this.anonymizePayload(payload, options);
  }

  /**
   * Merge user-provided options with service defaults.
   */
  private mergeOptions(options?: AnonymizeOptions): Required<AnonymizeOptions> {
    return {
      piiFieldPaths: options?.piiFieldPaths ?? [],
      strongPiiFieldPaths: options?.strongPiiFieldPaths ?? [],
      maskStrategy: options?.maskStrategy ?? 'redact',
      customRedactionText:
        options?.customRedactionText ?? PrivacyService.DEFAULT_REDACTION_TEXT,
    };
  }

  /**
   * Deep-clone and anonymise a value (object/array/primitive) according to the
   * provided options. Objects and arrays are cloned; primitives are returned as-is.
   */
  private deepCloneAndAnonymize(
    value: unknown,
    options: Required<AnonymizeOptions>,
    path: string[] = [],
  ): unknown {
    if (Array.isArray(value)) {
      return value.map((item, index) =>
        this.deepCloneAndAnonymize(item, options, path.concat(String(index))),
      );
    }

    if (this.isPlainObject(value)) {
      const clone: Record<string, unknown> = {};

      for (const [key, child] of Object.entries(value)) {
        const nextPath = path.concat(key);

        if (this.shouldMaskKey(key, nextPath, options)) {
          // Apply masking strategy at this field.
          if (options.maskStrategy === 'drop') {
            // Field is omitted entirely from the clone.
            continue;
          }

          if (options.maskStrategy === 'hash') {
            clone[key] = this.hashValue(child);
          } else {
            // "redact" or anything unknown falls back to redaction text.
            clone[key] = options.customRedactionText;
          }
        } else {
          clone[key] = this.deepCloneAndAnonymize(child, options, nextPath);
        }
      }

      return clone;
    }

    // Primitives are returned unchanged unless specifically targeted via paths,
    // which is handled at the object level above.
    return value;
  }

  /**
   * Decide whether a field should be treated as PII and masked, based on:
   *   - known PII key heuristics, and
   *   - configured piiFieldPaths / strongPiiFieldPaths.
   */
  private shouldMaskKey(
    key: string,
    path: string[],
    options: Required<AnonymizeOptions>,
  ): boolean {
    const normalisedKey = this.normalizeToken(key);

    if (
      this.defaultPiiKeys.has(normalisedKey) ||
      this.defaultStrongPiiKeys.has(normalisedKey)
    ) {
      return true;
    }

    const pathStr = path.map((segment) => this.normalizeToken(segment)).join('.');

    if (
      options.piiFieldPaths.some((configuredPath) =>
        this.isPathMatch(configuredPath, pathStr),
      )
    ) {
      return true;
    }

    if (
      options.strongPiiFieldPaths.some((configuredPath) =>
        this.isPathMatch(configuredPath, pathStr),
      )
    ) {
      return true;
    }

    return false;
  }

  /**
   * Compare a configured path (dot-separated string) with a concrete path,
   * using the same token normalisation as for field names.
   *
   * No wildcards are supported here; matching is exact after normalisation.
   */
  private isPathMatch(configuredPath: string, actualPath: string): boolean {
    const normalisedConfigured = configuredPath
      .split('.')
      .map((segment) => this.normalizeToken(segment))
      .join('.');

    return normalisedConfigured === actualPath;
  }

  /**
   * Normalise a token (field name or path segment) by:
   *   - removing non-alphanumeric characters
   *   - lowercasing the result
   */
  private normalizeToken(token: string): string {
    return token.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
  }

  /**
   * Simple deterministic, non-cryptographic hash for masking purposes.
   *
   * This is intentionally lightweight and NOT suitable for cryptographic use
   * cases. For strong privacy requirements, a cryptographic hash (e.g. SHA-256)
   * should be implemented at the infrastructure level and wired in here.
   */
  private hashValue(value: unknown): string {
    const str = value == null ? '' : String(value);
    let hash = 0;

    for (let i = 0; i < str.length; i += 1) {
      const chr = str.charCodeAt(i);
      hash = (hash << 5) - hash + chr;
      hash |= 0; // Convert to 32-bit integer
    }

    const hex = (hash >>> 0).toString(16);
    return `hash:${hex}`;
  }

  /**
   * Detect whether a value is a plain object (i.e. `{}` or an object with
   * prototype Object.prototype or null). This avoids treating class instances,
   * Dates, etc. as generic records.
   */
  private isPlainObject(value: unknown): value is Record<string, unknown> {
    if (Object.prototype.toString.call(value) !== '[object Object]') {
      return false;
    }

    const proto = Object.getPrototypeOf(value);
    return proto === Object.prototype || proto === null;
  }
}

===== END apps/api/src/orgo/security/privacy/privacy.service.ts =====


===== BEGIN apps/api/src/orgo/security/rbac/rbac.service.ts =====
import { ForbiddenException, Injectable, Logger } from '@nestjs/common';
import { DatabaseService } from '../../core/database/database.service';

/**
 * Identity for which permissions are being evaluated.
 *
 * One of `userId` or `apiTokenId` must be present. `organizationId` is required
 * and enforces multi‑tenant scoping as per Docs 1–2.
 */
export interface RbacSubject {
  organizationId: string;
  userId?: string;
  apiTokenId?: string;
}

/**
 * Optional resource context. This is intentionally minimal for now but leaves
 * room for richer, resource‑aware policies (task/case visibility, ownership, etc.).
 */
export interface RbacResourceContext {
  type: 'task' | 'case' | 'workflow' | 'config' | string;
  id?: string;
  organizationId?: string;
  ownerUserId?: string;
  ownerRoleId?: string;
  visibility?: 'PUBLIC' | 'INTERNAL' | 'RESTRICTED' | 'ANONYMISED' | string;
  // Domain‑specific details can be added as needed.
  [key: string]: unknown;
}

export interface CheckPermissionOptions {
  /**
   * Optional resource for more advanced policies. Currently only used
   * to enforce same‑org access when `requireSameOrg` is true.
   */
  resource?: RbacResourceContext;

  /**
   * Enforce that the subject org must match the resource org (if provided).
   * Defaults to true to respect multi‑tenant isolation.
   */
  requireSameOrg?: boolean;

  /**
   * When true, the method throws `ForbiddenException` instead of returning `false`.
   * Defaults to false (boolean result only).
   */
  throwOnError?: boolean;

  /**
   * Optional free‑form reason, useful for logging / diagnostics.
   */
  reason?: string;
}

export type RequirePermissionOptions = Omit<CheckPermissionOptions, 'throwOnError'>;

@Injectable()
export class RbacService {
  private readonly logger = new Logger(RbacService.name);

  constructor(private readonly databaseService: DatabaseService) {}

  /**
   * Convenience accessor to the Prisma client. The client type is deliberately
   * `any` here so that schema evolution / mapping does not make this service
   * brittle; the actual Prisma model names are defined in the schema.
   */
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  private get prisma(): any {
    return this.databaseService.getPrismaClient();
  }

  /**
   * Main enforcement hook used by guards/controllers.
   *
   * Returns true if the subject has the requested permission in the given
   * organization (via roles and/or API token scopes), otherwise false.
   *
   * If `options.throwOnError` is true, throws `ForbiddenException` instead
   * of returning false.
   */
  async checkPermission(
    subject: RbacSubject,
    permissionCode: string,
    options: CheckPermissionOptions = {},
  ): Promise<boolean> {
    const { requireSameOrg = true, resource, throwOnError = false, reason } = options;

    if (!subject.organizationId) {
      this.logger.warn('RBAC check without organizationId; denying.', {
        permissionCode,
        subject,
        reason,
      });

      if (throwOnError) {
        throw new ForbiddenException('Missing organization context for permission check.');
      }
      return false;
    }

    if (!subject.userId && !subject.apiTokenId) {
      this.logger.warn('RBAC check without userId/apiTokenId; denying.', {
        permissionCode,
        subject,
        reason,
      });

      if (throwOnError) {
        throw new ForbiddenException('Missing subject identity for permission check.');
      }
      return false;
    }

    if (
      requireSameOrg &&
      resource?.organizationId &&
      resource.organizationId !== subject.organizationId
    ) {
      this.logger.warn('Cross‑organization resource access attempted; denying.', {
        permissionCode,
        subjectOrg: subject.organizationId,
        resourceOrg: resource.organizationId,
        reason,
      });

      if (throwOnError) {
        throw new ForbiddenException('Cross‑organization access is not allowed.');
      }
      return false;
    }

    const effectivePermissions = await this.getEffectivePermissionsForSubject(subject);

    const allowed = this.isPermissionGranted(permissionCode, effectivePermissions);

    if (!allowed) {
      this.logger.debug('Permission denied.', {
        permissionCode,
        subject,
        resource,
        reason,
      });

      if (throwOnError) {
        throw new ForbiddenException('You do not have permission to perform this action.');
      }
    }

    return allowed;
  }

  /**
   * Variant of `checkPermission` that always throws on failure.
   *
   * Intended for use in service methods where a missing permission is an error
   * rather than a branching condition.
   */
  async requirePermission(
    subject: RbacSubject,
    permissionCode: string,
    options: RequirePermissionOptions = {},
  ): Promise<void> {
    await this.checkPermission(subject, permissionCode, { ...options, throwOnError: true });
  }

  /**
   * Returns a de‑duplicated list of all permission codes that currently apply
   * to a subject (roles + API token scopes).
   *
   * This is useful for attaching to a request context or debugging RBAC issues.
   */
  async getEffectivePermissionsForSubject(subject: RbacSubject): Promise<Set<string>> {
    const permissionCodes = new Set<string>();

    if (subject.userId) {
      const rolePermissions = await this.getUserPermissionCodes(subject.organizationId, subject.userId);
      for (const code of rolePermissions) {
        permissionCodes.add(code);
      }
    }

    if (subject.apiTokenId) {
      const tokenPermissions = await this.getApiTokenPermissionCodes(
        subject.organizationId,
        subject.apiTokenId,
      );
      for (const code of tokenPermissions) {
        permissionCodes.add(code);
      }
    }

    return permissionCodes;
  }

  /**
   * Helper returning a plain array to make it convenient for controllers/guards
   * that want to serialise permissions into request context.
   */
  async listEffectivePermissionsForSubject(subject: RbacSubject): Promise<string[]> {
    const set = await this.getEffectivePermissionsForSubject(subject);
    return Array.from(set);
  }

  /**
   * Fetch permission codes granted to a user via role assignments in the given org.
   *
   * This respects:
   *  - user_role_assignments scoped by organization_id and not revoked,
   *  - roles that are either global (organization_id IS NULL) or match the org,
   *  - role_permissions linking roles to permissions.
   */
  private async getUserPermissionCodes(
    organizationId: string,
    userId: string,
  ): Promise<Set<string>> {
    const result = new Set<string>();

    // NOTE: Model/field names here assume a conventional Prisma mapping from
    // the Doc 1 schema; adapt them to your actual Prisma schema as needed.
    const assignments = await this.prisma.userRoleAssignment.findMany({
      where: {
        userId,
        organizationId,
        revokedAt: null,
      },
      include: {
        role: {
          include: {
            rolePermissions: {
              include: {
                permission: true,
              },
            },
          },
        },
      },
    });

    for (const assignment of assignments ?? []) {
      const role = assignment.role;
      if (!role) {
        continue;
      }

      // Allow global/system roles (organizationId null) and org‑local roles.
      if (role.organizationId && role.organizationId !== organizationId) {
        continue;
      }

      for (const rp of role.rolePermissions ?? []) {
        const permission = rp.permission;
        if (permission?.code) {
          result.add(permission.code);
        }
      }
    }

    return result;
  }

  /**
   * Fetch permission codes granted directly via an API token's scopes.
   *
   * This respects:
   *  - token organization_id matching the subject organization,
   *  - revoked_at being null,
   *  - expires_at not in the past.
   *
   * `scopes` is assumed to be a JSONB field holding an array of permission codes
   * or patterns (e.g. `["task.view", "task.edit", "task.*"]`).
   */
  private async getApiTokenPermissionCodes(
    organizationId: string,
    apiTokenId: string,
  ): Promise<Set<string>> {
    const result = new Set<string>();

    const token = await this.prisma.apiToken.findFirst({
      where: {
        id: apiTokenId,
        organizationId,
        revokedAt: null,
      },
    });

    if (!token) {
      return result;
    }

    const now = new Date();
    if (token.expiresAt && token.expiresAt <= now) {
      return result;
    }

    const scopes = this.normalizeScopes(token.scopes);
    for (const scope of scopes) {
      result.add(scope);
    }

    return result;
  }

  /**
   * Normalises the `scopes` JSONB field on `api_tokens` into an array of
   * string permission codes.
   */
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  private normalizeScopes(scopes: any): string[] {
    if (!scopes) {
      return [];
    }

    if (Array.isArray(scopes)) {
      return scopes.filter((s): s is string => typeof s === 'string');
    }

    if (typeof scopes === 'object' && Array.isArray(scopes.codes)) {
      return scopes.codes.filter((s: unknown): s is string => typeof s === 'string');
    }

    return [];
  }

  /**
   * Evaluates whether `permissionCode` is granted given a set of effective
   * permissions. Supports:
   *
   *  - exact matches, e.g. `task.view_sensitive`,
   *  - global wildcard `*`,
   *  - prefix wildcards like `task.*` or `workflow.edit_*` (treated as simple
   *    `<prefix>.*` matches on dot‑separated segments).
   */
  private isPermissionGranted(permissionCode: string, effective: Set<string>): boolean {
    if (effective.has(permissionCode)) {
      return true;
    }

    // Global wildcard: everything is allowed.
    if (effective.has('*')) {
      return true;
    }

    // Support simple dotted prefix wildcards: "task.*", "workflow.*", etc.
    const segments = permissionCode.split('.');
    if (segments.length > 1) {
      let prefix = '';
      for (let i = 0; i < segments.length - 1; i += 1) {
        prefix = i === 0 ? segments[0] : `${prefix}.${segments[i]}`;
        const wildcard = `${prefix}.*`;
        if (effective.has(wildcard)) {
          return true;
        }
      }
    }

    return false;
  }
}

===== END apps/api/src/orgo/security/rbac/rbac.service.ts =====


===== BEGIN apps/api/src/persistence/persistence.module.ts =====
import { Module } from '@nestjs/common';
import { PrismaService } from './prisma/prisma.service';

@Module({
  providers: [PrismaService],
  exports: [PrismaService],
})
export class PersistenceModule {}

===== END apps/api/src/persistence/persistence.module.ts =====


===== BEGIN apps/api/src/persistence/prisma/prisma.service.spec.ts =====
import { Test, TestingModule } from '@nestjs/testing';
import { PrismaService } from './prisma.service';

describe('PrismaService', () => {
  let service: PrismaService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [PrismaService],
    }).compile();

    service = module.get<PrismaService>(PrismaService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });
});

===== END apps/api/src/persistence/prisma/prisma.service.spec.ts =====


===== BEGIN apps/api/src/persistence/prisma/prisma.service.ts =====
import { Injectable, OnModuleInit } from '@nestjs/common';
import { PrismaClient } from '@prisma/client';

@Injectable()
export class PrismaService extends PrismaClient implements OnModuleInit {
  async onModuleInit() {
    await this.$connect();
  }
}

===== END apps/api/src/persistence/prisma/prisma.service.ts =====


===== BEGIN apps/api/test/app.e2e-spec.ts =====
import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication } from '@nestjs/common';
import * as request from 'supertest';
import { AppModule } from './../src/app.module';

describe('AppController (e2e)', () => {
  let app: INestApplication;

  beforeEach(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    await app.init();
  });

  it('/ (GET)', () => {
    return request(app.getHttpServer())
      .get('/')
      .expect(200)
      .expect('Hello World!');
  });
});

===== END apps/api/test/app.e2e-spec.ts =====


===== BEGIN apps/api/test/jest-e2e.json =====
{
  "moduleFileExtensions": ["js", "json", "ts"],
  "rootDir": ".",
  "testEnvironment": "node",
  "testRegex": ".e2e-spec.ts$",
  "transform": {
    "^.+\\.(t|j)s$": "ts-jest"
  }
}

===== END apps/api/test/jest-e2e.json =====


===== BEGIN apps/api/tsconfig.build.json =====
{
  "extends": "./tsconfig.json",
  "exclude": [
    "node_modules",
    "../../node_modules",
    "test",
    "dist",
    "**/*spec.ts"
  ]
}

===== END apps/api/tsconfig.build.json =====


===== BEGIN apps/api/tsconfig.json =====
{
  "extends": "tsconfig/nestjs.json",
  "compilerOptions": {
    "outDir": "./dist",
    "baseUrl": "./"
  }
}

===== END apps/api/tsconfig.json =====


===== BEGIN apps/api/webpack-hmr.config.js =====
/* eslint-disable @typescript-eslint/no-var-requires */
const nodeExternals = require('webpack-node-externals');
const { RunScriptWebpackPlugin } = require('run-script-webpack-plugin');

module.exports = function (options, webpack) {
  return {
    ...options,
    entry: ['webpack/hot/poll?100', options.entry],
    externals: [
      nodeExternals({
        allowlist: ['webpack/hot/poll?100'],
        modulesDir: '../../node_modules',
      }),
    ],
    plugins: [
      ...options.plugins,
      new webpack.HotModuleReplacementPlugin(),
      new webpack.WatchIgnorePlugin({
        paths: [/\.js$/, /\.d\.ts$/],
      }),
      new RunScriptWebpackPlugin({ name: options.output.filename }),
    ],
  };
};

===== END apps/api/webpack-hmr.config.js =====


===== BEGIN apps/web/.env.example =====

===== END apps/web/.env.example =====


===== BEGIN apps/web/.eslintrc.js =====
module.exports = require("config/eslint-preset");

===== END apps/web/.eslintrc.js =====


===== BEGIN apps/web/Dockerfile =====
FROM node:16-alpine AS builder
RUN apk update
# Set working directory
WORKDIR /app
RUN yarn global add turbo
COPY . .
# Only Take packages that are needed to compile this app
RUN turbo prune --scope=web --docker

# Add lockfile and package.json's of isolated subworkspace
FROM node:16-alpine AS installer
RUN apk update
RUN apk add --no-cache libc6-compat
WORKDIR /app
COPY --from=builder /app/out/json/ .
COPY --from=builder /app/out/yarn.lock ./yarn.lock
COPY --from=builder /app/turbo.json ./turbo.json
RUN yarn install --frozen-lockfile


FROM node:16-alpine AS sourcer
RUN apk update
WORKDIR /app
COPY --from=installer /app/ .
COPY --from=builder /app/out/full/ .
COPY .gitignore .gitignore
RUN yarn turbo run build --scope=web --include-dependencies --no-deps

FROM node:16-alpine as runner
WORKDIR /app
COPY --from=sourcer /app/ .
WORKDIR /app/apps/web/
CMD [ "npm", "start" ]

===== END apps/web/Dockerfile =====


===== BEGIN apps/web/jest.config.js =====
const nextJest = require("next/jest");

const createJestConfig = nextJest({
  // Provide the path to your Next.js app to load next.config.js and .env files in your test environment
  dir: "./",
});

// Add any custom config to be passed to Jest
const customJestConfig = {
  // Add more setup options before each test is run
  // setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
  // if using TypeScript with a baseUrl set to the root directory then you need the below for alias' to work
  moduleDirectories: ["node_modules", "<rootDir>/"],
  testEnvironment: "jest-environment-jsdom",
};

// createJestConfig is exported this way to ensure that next/jest can load the Next.js config which is async
module.exports = createJestConfig(customJestConfig);

===== END apps/web/jest.config.js =====


===== BEGIN apps/web/jest.setup.js =====
// Optional: configure or set up a testing framework before each test.
// If you delete this file, remove `setupFilesAfterEnv` from `jest.config.js`

// Used for __tests__/testing-library.js
// Learn more: https://github.com/testing-library/jest-dom
import "@testing-library/jest-dom/extend-expect";

===== END apps/web/jest.setup.js =====


===== BEGIN apps/web/next-env.d.ts =====
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/basic-features/typescript for more information.

===== END apps/web/next-env.d.ts =====


===== BEGIN apps/web/next.config.js =====
const withTM = require("next-transpile-modules")(["ui"]);

module.exports = withTM({
  reactStrictMode: true,
});

===== END apps/web/next.config.js =====


===== BEGIN apps/web/package.json =====
{
  "name": "web",
  "version": "0.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:ci": "jest --ci"
  },
  "dependencies": {
    "@reduxjs/toolkit": "^1.9.5",
    "next": "13.4.12",
    "react": "18.2.0",
    "react-dom": "18.2.0",
    "react-redux": "^8.1.2",
    "ui": "*"
  },
  "devDependencies": {
    "@testing-library/jest-dom": "^5.17.0",
    "@testing-library/react": "^14.0.0",
    "@testing-library/user-event": "14.4.3",
    "@types/node": "^20.4.5",
    "@types/react": "18.2.18",
    "autoprefixer": "^10.4.14",
    "config": "*",
    "eslint": "8.46.0",
    "jest": "^29.6.2",
    "jest-environment-jsdom": "^29.6.2",
    "next-transpile-modules": "10.0.1",
    "postcss": "^8.4.27",
    "tailwindcss": "^3.3.3",
    "tsconfig": "*",
    "typescript": "^5.1.6"
  }
}

===== END apps/web/package.json =====


===== BEGIN apps/web/pages/_app.tsx =====
import type { AppProps } from "next/app";
import { Provider } from "react-redux";
import store from "../src/store";
import "../src/styles/global.css";

function MyApp({ Component, pageProps }: AppProps) {
  return (
    <Provider store={store}>
      <Component {...pageProps} />;
    </Provider>
  );
}

export default MyApp;

===== END apps/web/pages/_app.tsx =====


===== BEGIN apps/web/pages/index.tsx =====
import { Button } from "ui";
import { useHelloQuery } from "../src/store/services/api";

export default function Web() {
  const { data } = useHelloQuery();

  return (
    <div>
      <h1>{data?.message}</h1>
      <Button />
    </div>
  );
}

===== END apps/web/pages/index.tsx =====


===== BEGIN apps/web/postcss.config.js =====
module.exports = require("config/postcss.config");

===== END apps/web/postcss.config.js =====


===== BEGIN apps/web/README.md =====
## Getting Started

First, run the development server:

```bash
yarn dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `pages/index.js`. The page auto-updates as you edit the file.

[API routes](https://nextjs.org/docs/api-routes/introduction) can be accessed on [http://localhost:3000/api/hello](http://localhost:3000/api/hello). This endpoint can be edited in `pages/api/hello.js`.

The `pages/api` directory is mapped to `/api/*`. Files in this directory are treated as [API routes](https://nextjs.org/docs/api-routes/introduction) instead of React pages.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js/) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_source=github.com&utm_medium=referral&utm_campaign=turborepo-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/deployment) for more details.

===== END apps/web/README.md =====


===== BEGIN apps/web/src/common/.gitkeep =====

===== END apps/web/src/common/.gitkeep =====


===== BEGIN apps/web/src/orgo/core/functional-ids.ts =====
/**
 * Shared stable functional IDs used across Orgo v3 for logging, analytics,
 * configuration references, etc.
 *
 * This file is mirrored by `apps/api/src/orgo/core/functional-ids.ts`.
 */
export const FUNCTIONAL_ID_VALUES = [
  // Backbone – organizations, users & persons
  "FN_ORG_CREATE",
  "FN_ORG_UPDATE",
  "FN_PERSON_PROFILE_UPSERT",
  "FN_ROLE_CREATE",
  "FN_RBAC_PERMISSION_ASSIGN",
  "FN_IDENTITY_LINK_USER_TO_PERSON",

  // Signals & ingestion (email, API, offline, sync)
  "FN_EMAIL_SEND",
  "FN_EMAIL_FETCH_INCOMING",
  "FN_EMAIL_PARSE_INCOMING",
  "FN_EMAIL_VALIDATE_PAYLOAD",
  "FN_EMAIL_POLL_MAILBOX",
  "FN_EMAIL_ROUTE_TO_WORKFLOW",
  "FN_EMAIL_IMPORT_ARCHIVE",
  "FN_SIGNAL_INGEST",
  "FN_SYNC_OFFLINE_NODE",
  "FN_SYNC_OFFLINE_TASKS",

  // Cases & cyclic review
  "FN_CASE_CREATE_FROM_SIGNAL",
  "FN_CASE_GET_WITH_TASKS",
  "FN_CASE_RUN_CYCLIC_REVIEW",

  // Workflow engine & escalation
  "FN_WORKFLOW_EXECUTE",
  "FN_WORKFLOW_VALIDATE_RULES",
  "FN_WORKFLOW_SIMULATE",
  "FN_WORKFLOW_EVALUATE_ESCALATIONS",

  // Task management
  "FN_TASK_CREATE",
  "FN_TASK_UPDATE_STATUS",
  "FN_TASK_ESCALATE",
  "FN_TASK_ASSIGN",
  "FN_TASK_ADD_COMMENT",
  "FN_TASK_GET_BY_ID",

  // Label & routing
  "FN_ROUTING_RESOLVE_LABEL",
  "FN_ROUTING_APPLY_RULES",
  "FN_LABEL_CREATE_DEFINITION",

  // Database / persistence
  "FN_DB_CONNECT",
  "FN_DB_GET_CLIENT",
  "FN_DB_FETCH_RECORDS",
  "FN_DB_INSERT_RECORD",
  "FN_DB_UPDATE_RECORD",
  "FN_DB_REPOSITORY_OPERATION",

  // Profiles, configuration & feature flags
  "FN_PROFILE_LOAD",
  "FN_PROFILE_APPLY_DEFAULTS",
  "FN_PROFILE_PREVIEW_DIFF",
  "FN_CONFIG_GET_GLOBAL",
  "FN_CONFIG_UPDATE_SERVICE",
  "FN_CONFIG_IMPORT_BUNDLE",
  "FN_CONFIG_VALIDATE",
  "FN_CONFIG_VALIDATE_BUNDLE",
  "FN_FEATURE_FLAG_SET",

  // Public API controllers
  "FN_API_TASK_LIST",
  "FN_API_TASK_GET",
  "FN_API_TASK_CREATE",
  "FN_API_CASE_LIST",
  "FN_API_CASE_GET",
  "FN_API_WORKFLOW_EXECUTE",

  // Admin UI / screens
  "FN_UI_ADMIN_TASK_OVERVIEW",
  "FN_UI_ADMIN_CASE_OVERVIEW",
  "FN_UI_ADMIN_PROFILE_SETTINGS",

  // Notifications & live updates
  "FN_NOTIFICATION_SEND_IN_APP",
  "FN_WS_TASK_EVENTS_STREAM",

  // Domain modules
  "FN_DOMAIN_MAINTENANCE_REGISTER_INCIDENT",
  "FN_DOMAIN_MAINTENANCE_LIST_INCIDENTS",
  "FN_DOMAIN_HR_REGISTER_REPORT",
  "FN_DOMAIN_HR_LIST_CASES",
  "FN_DOMAIN_EDUCATION_REGISTER_STUDENT_INCIDENT",
  "FN_DOMAIN_EDUCATION_LIST_INCIDENTS",
  "FN_DOMAIN_TASK_FACTORY_CREATE",
  "FN_DOMAIN_WORKFLOW_APPLY_OVERRIDES",

  // Insights & reporting
  "FN_INSIGHTS_GET_TASK_VOLUME_REPORT",
  "FN_INSIGHTS_GET_SLA_BREACHES",
  "FN_INSIGHTS_GET_PROFILE_SCORE",
  "FN_INSIGHTS_EXPORT_FACTS",
  "FN_INSIGHTS_REFRESH_VIEWS",
  "FN_INSIGHTS_PATTERN_RUN_WEEKLY",
  "FN_INSIGHTS_PATTERN_RUN_MONTHLY",
  "FN_INSIGHTS_PATTERN_RUN_YEARLY",
  "FN_INSIGHTS_CACHE_WARM_DASHBOARDS",
  "FN_INSIGHTS_EXPORT_ANALYTICS",
  "FN_UI_INSIGHTS_OVERVIEW",

  // Infrastructure, health, metrics & alerts
  "FN_INFRA_HEALTHCHECK",
  "FN_INFRA_WORKER_HEARTBEAT",
  "FN_INFRA_METRICS_RECORD_WORKFLOW_LATENCY",
  "FN_INFRA_METRICS_RECORD_QUEUE_DEPTH",
  "FN_ALERT_ESCALATION_DELAY",
  "FN_ALERT_ERROR_RATE",

  // Security & compliance
  "FN_SECURITY_AUTH_VALIDATE_ACCESS_TOKEN",
  "FN_SECURITY_RBAC_CHECK_PERMISSION",
  "FN_SECURITY_PRIVACY_ANONYMIZE_PAYLOAD",
  "FN_SECURITY_AUDIT_RECORD_EVENT",
  "FN_SECURITY_COMPLIANCE_EXPORT_AUDIT_LOG",

  // Logging
  "FN_LOG_SYSTEM_EVENT",
  "FN_LOG_SECURITY_EVENT",
  "FN_LOG_ROTATE",
  "FN_LOG_GET_ACTIVITY_FOR_ENTITY",

  // Validation & metadata
  "FN_VALIDATION_VALIDATE_PAYLOAD",
  "FN_VALIDATION_NORMALIZE_METADATA",
] as const;

export type FunctionalId = (typeof FUNCTIONAL_ID_VALUES)[number];

export const FunctionalIds: Record<FunctionalId, FunctionalId> =
  FUNCTIONAL_ID_VALUES.reduce(
    (acc, id) => {
      acc[id] = id;
      return acc;
    },
    {} as Record<FunctionalId, FunctionalId>,
  );

export function isFunctionalId(value: string): value is FunctionalId {
  return (FUNCTIONAL_ID_VALUES as readonly string[]).includes(value);
}

===== END apps/web/src/orgo/core/functional-ids.ts =====


===== BEGIN apps/web/src/orgo/hooks/useTaskEventStream.ts =====
// apps/web/src/orgo/hooks/useTaskEventStream.ts
import { useCallback, useEffect, useRef, useState } from "react";

export type TaskEventType =
  | "created"
  | "status_changed"
  | "priority_changed"
  | "ownership_changed"
  | "comment_added"
  | "email_linked"
  | "escalated"
  | "deadline_updated"
  | "metadata_updated"
  | string;

export interface TaskEvent {
  id?: string;
  taskId: string;
  organizationId?: string;
  eventType: TaskEventType;
  oldValue?: unknown;
  newValue?: unknown;
  actorUserId?: string | null;
  actorRoleId?: string | null;
  origin?: string;
  createdAt: string;
  // Allow extra fields from backend without losing them
  [key: string]: unknown;
}

export interface UseTaskEventStreamOptions {
  /**
   * Optional task filter. If provided, the client will request
   * events only for this task (server must support this convention).
   */
  taskId?: string;

  /**
   * Optional organization filter. Can be used by the server to scope events.
   */
  organizationId?: string;

  /**
   * Whether the WebSocket connection should be active.
   * Defaults to true.
   */
  enabled?: boolean;

  /**
   * Whether the hook should try to automatically reconnect on unexpected close.
   * Defaults to true.
   */
  autoReconnect?: boolean;

  /**
   * Optional callback invoked for every normalized TaskEvent.
   */
  onEvent?: (event: TaskEvent) => void;

  /**
   * Optional callback invoked when the WebSocket errors.
   */
  onError?: (error: Error) => void;
}

export interface UseTaskEventStreamResult {
  /**
   * All TaskEvents received during the lifetime of this hook instance.
   */
  events: TaskEvent[];

  /**
   * The most recently received TaskEvent, or null if none.
   */
  lastEvent: TaskEvent | null;

  /**
   * True while the WebSocket connection is open.
   */
  isConnected: boolean;

  /**
   * True while we are in the process of establishing a connection.
   */
  isConnecting: boolean;

  /**
   * Last error encountered by the WebSocket, if any.
   */
  error: Error | null;

  /**
   * Manually close the WebSocket and stop auto‑reconnect.
   */
  disconnect: () => void;

  /**
   * Force a reconnect (will reopen the WebSocket with current options).
   */
  reconnect: () => void;

  /**
   * Clear the in‑memory list of events and lastEvent.
   */
  clearEvents: () => void;
}

/**
 * Derive the WebSocket URL used for TaskEventsGateway.
 *
 * Priority:
 * 1. NEXT_PUBLIC_ORGO_TASK_EVENTS_WS_URL (full ws:// or wss:// URL)
 * 2. window.location.origin + /api/v3/task-events/stream (converted to ws:// or wss://)
 *
 * Optional filters (task_id, organization_id) are appended as query parameters.
 */
function resolveTaskEventsWsUrl(params: {
  taskId?: string;
  organizationId?: string;
}): string | null {
  if (typeof window === "undefined") {
    return null;
  }

  const explicit = process.env.NEXT_PUBLIC_ORGO_TASK_EVENTS_WS_URL;
  const httpUrl =
    explicit && explicit.length > 0
      ? explicit
      : `${window.location.origin}/api/v3/task-events/stream`;

  let url: URL;
  try {
    url = new URL(httpUrl, window.location.origin);
  } catch {
    return null;
  }

  // Ensure WebSocket protocol
  url.protocol = url.protocol === "https:" ? "wss:" : "ws:";

  if (params.taskId) {
    url.searchParams.set("task_id", params.taskId);
  }

  if (params.organizationId) {
    url.searchParams.set("organization_id", params.organizationId);
  }

  return url.toString();
}

function extractTaskEventPayload(raw: unknown): any {
  if (!raw || typeof raw !== "object") {
    return raw;
  }

  const obj = raw as any;

  // Common wrapping patterns: { event: {...} }, { data: {...} }, { payload: {...} }
  if (obj.event) return obj.event;
  if (obj.payload) return obj.payload;
  if (obj.data) return obj.data;

  return obj;
}

function normalizeTaskEvent(raw: unknown): TaskEvent | null {
  if (!raw) return null;

  const envelope = extractTaskEventPayload(raw);
  if (!envelope || typeof envelope !== "object") {
    return null;
  }

  const obj = envelope as any;

  const taskId = obj.task_id ?? obj.taskId;
  if (!taskId || typeof taskId !== "string") {
    // Not a task‑scoped event we understand
    return null;
  }

  const organizationId =
    obj.organization_id ??
    obj.organizationId ??
    (raw as any)?.organization_id ??
    (raw as any)?.organizationId;

  const eventType: TaskEventType =
    obj.event_type ??
    obj.eventType ??
    (raw as any)?.event_type ??
    (raw as any)?.eventType ??
    (raw as any)?.type ??
    "unknown";

  const createdAt: string =
    obj.created_at ??
    obj.createdAt ??
    (raw as any)?.created_at ??
    (raw as any)?.createdAt ??
    new Date().toISOString();

  const oldValue = obj.old_value ?? obj.oldValue;
  const newValue = obj.new_value ?? obj.newValue;

  const actorUserId =
    obj.actor_user_id ?? obj.actorUserId ?? (raw as any)?.actor_user_id;
  const actorRoleId =
    obj.actor_role_id ?? obj.actorRoleId ?? (raw as any)?.actor_role_id;

  const origin = obj.origin ?? (raw as any)?.origin;

  const id = obj.id ?? (raw as any)?.id;

  const event: TaskEvent = {
    id: typeof id === "string" ? id : undefined,
    taskId,
    organizationId:
      typeof organizationId === "string" ? organizationId : undefined,
    eventType,
    oldValue,
    newValue,
    actorUserId:
      typeof actorUserId === "string" || actorUserId === null
        ? actorUserId
        : undefined,
    actorRoleId:
      typeof actorRoleId === "string" || actorRoleId === null
        ? actorRoleId
        : undefined,
    origin: typeof origin === "string" ? origin : undefined,
    createdAt,
    // keep full raw payload attached for inspection if needed
    raw,
  };

  return event;
}

export function useTaskEventStream(
  options: UseTaskEventStreamOptions = {}
): UseTaskEventStreamResult {
  const {
    taskId,
    organizationId,
    enabled = true,
    autoReconnect = true,
    onEvent,
    onError,
  } = options;

  const [events, setEvents] = useState<TaskEvent[]>([]);
  const [lastEvent, setLastEvent] = useState<TaskEvent | null>(null);
  const [isConnected, setIsConnected] = useState(false);
  const [isConnecting, setIsConnecting] = useState(false);
  const [error, setError] = useState<Error | null>(null);

  const wsRef = useRef<WebSocket | null>(null);
  const reconnectTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(
    null
  );
  const manuallyDisconnectedRef = useRef(false);
  const isMountedRef = useRef(false);
  const [reconnectCounter, setReconnectCounter] = useState(0);

  const clearEvents = useCallback(() => {
    setEvents([]);
    setLastEvent(null);
  }, []);

  const disconnect = useCallback(() => {
    manuallyDisconnectedRef.current = true;

    if (reconnectTimeoutRef.current) {
      clearTimeout(reconnectTimeoutRef.current);
      reconnectTimeoutRef.current = null;
    }

    if (wsRef.current) {
      wsRef.current.close();
      wsRef.current = null;
    }

    if (isMountedRef.current) {
      setIsConnected(false);
      setIsConnecting(false);
    }
  }, []);

  const reconnect = useCallback(() => {
    manuallyDisconnectedRef.current = false;
    // Trigger effect to re-establish connection
    setReconnectCounter((prev) => prev + 1);
  }, []);

  useEffect(() => {
    if (!enabled || typeof window === "undefined") {
      return;
    }

    const url = resolveTaskEventsWsUrl({ taskId, organizationId });

    if (!url) {
      const err = new Error("Unable to resolve TaskEvents WebSocket URL");
      setError(err);
      if (onError) {
        onError(err);
      }
      return;
    }

    isMountedRef.current = true;
    manuallyDisconnectedRef.current = false;

    const ws = new WebSocket(url);
    wsRef.current = ws;

    setIsConnecting(true);
    setError(null);

    ws.onopen = () => {
      if (!isMountedRef.current) return;
      setIsConnecting(false);
      setIsConnected(true);
    };

    ws.onmessage = (event: MessageEvent) => {
      if (!isMountedRef.current) return;

      let payload: unknown = event.data;
      if (typeof event.data === "string") {
        try {
          payload = JSON.parse(event.data);
        } catch {
          // keep as raw string if it is not valid JSON
          payload = event.data;
        }
      }

      const normalized = normalizeTaskEvent(payload);
      if (!normalized) {
        return;
      }

      setLastEvent(normalized);
      setEvents((prev) => [...prev, normalized]);

      if (onEvent) {
        onEvent(normalized);
      }
    };

    ws.onerror = () => {
      if (!isMountedRef.current) return;

      const err = new Error("TaskEvents WebSocket error");
      setError(err);
      if (onError) {
        onError(err);
      }
    };

    ws.onclose = () => {
      if (!isMountedRef.current) return;

      setIsConnected(false);
      setIsConnecting(false);
      wsRef.current = null;

      if (autoReconnect && !manuallyDisconnectedRef.current) {
        reconnectTimeoutRef.current = setTimeout(() => {
          if (
            !isMountedRef.current ||
            manuallyDisconnectedRef.current ||
            !autoReconnect
          ) {
            return;
          }
          setReconnectCounter((prev) => prev + 1);
        }, 3000);
      }
    };

    return () => {
      isMountedRef.current = false;

      if (reconnectTimeoutRef.current) {
        clearTimeout(reconnectTimeoutRef.current);
        reconnectTimeoutRef.current = null;
      }

      if (wsRef.current) {
        wsRef.current.close();
        wsRef.current = null;
      }
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [
    enabled,
    autoReconnect,
    taskId,
    organizationId,
    onEvent,
    onError,
    reconnectCounter,
  ]);

  return {
    events,
    lastEvent,
    isConnected,
    isConnecting,
    error,
    disconnect,
    reconnect,
    clearEvents,
  };
}

===== END apps/web/src/orgo/hooks/useTaskEventStream.ts =====


===== BEGIN apps/web/src/orgo/types/case.ts =====
// apps/web/src/orgo/types/case.ts

// Canonical enums for Case, aligned with Docs 1, 2 and 8.

/**
 * CASE_STATUS
 * - open
 * - in_progress
 * - resolved
 * - archived
 */
export const CASE_STATUSES = [
  'open',
  'in_progress',
  'resolved',
  'archived',
] as const;
export type CaseStatus = (typeof CASE_STATUSES)[number];

/**
 * JSON form of TASK_SEVERITY for Cases
 * - minor
 * - moderate
 * - major
 * - critical
 */
export const CASE_SEVERITIES = [
  'minor',
  'moderate',
  'major',
  'critical',
] as const;
export type CaseSeverity = (typeof CASE_SEVERITIES)[number];

/**
 * Case source_type / task_source_enum (JSON form)
 * - email
 * - api
 * - manual
 * - sync
 */
export const CASE_SOURCE_TYPES = ['email', 'api', 'manual', 'sync'] as const;
export type CaseSourceType = (typeof CASE_SOURCE_TYPES)[number];

// Common scalar aliases used across Orgo types
export type UUID = string;
export type IsoDateTimeString = string; // e.g. "2025-11-18T10:30:00Z"
export type IsoDurationString = string; // e.g. "PT2H"
export type LabelCode = string; // "<BASE>.<CATEGORY><SUBCATEGORY>.<HORIZONTAL_ROLE>"

/**
 * Canonical Case JSON contract for the web app, matching Doc 2 §2.11
 * and Doc 8 §8.4.1.
 *
 * This represents the shape returned by the public Case API
 * (GET /api/v3/cases, GET /api/v3/cases/:id) for the Case fields.
 */
export interface Case {
  case_id: UUID;
  organization_id: UUID;

  source_type: CaseSourceType;
  source_reference: string | null;

  label: LabelCode;
  title: string;
  description: string;

  status: CaseStatus;
  severity: CaseSeverity;

  /**
   * ISO‑8601 duration (e.g. "PT2H"); derived from profiles/workflows.
   * Null if no explicit SLA window is set for this Case.
   */
  reactivity_time: IsoDurationString | null;

  /**
   * Base part of the original label (e.g. 100, 1001).
   */
  origin_vertical_level: number | null;

  /**
   * Horizontal role of origin (e.g. "Ops.Maintenance").
   */
  origin_role: string | null;

  /**
   * High‑level tags (e.g. ["safety","wet_floor"]).
   */
  tags: string[] | null;

  /**
   * Structured location (site, building, GPS, etc.).
   */
  location: Record<string, unknown> | null;

  /**
   * Case‑level metadata (pattern_sensitivity, review settings, profile_id, etc.).
   */
  metadata: Record<string, unknown>;

  /**
   * Timestamps are ISO‑8601 in UTC.
   */
  created_at: IsoDateTimeString;
  updated_at: IsoDateTimeString;
}

/**
 * Optional extension used by Case details endpoints that include linked Tasks.
 *
 * TTask is generic so this file does not need to depend on a specific Task type;
 * callers can specialise it as CaseWithTasks<Task>.
 */
export interface CaseWithTasks<TTask = unknown> extends Case {
  tasks: TTask[];
}

===== END apps/web/src/orgo/types/case.ts =====


===== BEGIN apps/web/src/orgo/types/insights.ts =====
/**
 * Orgo v3 – Insights / Analytics Type Definitions
 *
 * This file models:
 * - Canonical enums reused in the Insights slice
 * - The /config/insights/config.yaml structure
 * - Star-schema dimensions and fact tables in the `insights.*` schema
 *
 * All enums and shapes are aligned with the v3 spec documents.
 */

/* -------------------------------------------------------------------------- */
/*  Common primitive aliases                                                   */
/* -------------------------------------------------------------------------- */

export type UUID = string;

/**
 * ISO-8601 timestamp in UTC, e.g. "2025-11-18T10:30:00Z".
 */
export type IsoDateTimeString = string;

/**
 * ISO-8601 calendar date, e.g. "2025-03-14".
 */
export type IsoDateString = string;

/* -------------------------------------------------------------------------- */
/*  Core enums used by Insights (mirroring canonical enums)                   */
/* -------------------------------------------------------------------------- */

/**
 * Global deployment environments.
 */
export type Environment = 'dev' | 'staging' | 'prod' | 'offline';

/**
 * Task lifecycle status in analytics and operational views.
 */
export type TaskStatus =
  | 'PENDING'
  | 'IN_PROGRESS'
  | 'ON_HOLD'
  | 'COMPLETED'
  | 'FAILED'
  | 'ESCALATED'
  | 'CANCELLED';

/**
 * Task priority.
 */
export type TaskPriority = 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';

/**
 * Task / Case severity.
 */
export type TaskSeverity = 'MINOR' | 'MODERATE' | 'MAJOR' | 'CRITICAL';

/**
 * Visibility of a task/case/event.
 */
export type Visibility = 'PUBLIC' | 'INTERNAL' | 'RESTRICTED' | 'ANONYMISED';

/**
 * Operational source of a task/case.
 */
export type TaskSource = 'email' | 'api' | 'manual' | 'sync';

/**
 * Case lifecycle status used in analytics.
 */
export type CaseStatus = 'open' | 'in_progress' | 'resolved' | 'archived';

/**
 * Notification channel enum values as used in analytics/export config.
 */
export type NotificationChannel = 'email' | 'sms' | 'in_app' | 'webhook';

/**
 * Notification scope, as used in profiles and reporting.
 */
export type NotificationScope = 'user' | 'team' | 'department' | 'org_wide';

/* -------------------------------------------------------------------------- */
/*  Profile keys (as referenced from Insights patterns config)                */
/* -------------------------------------------------------------------------- */

/**
 * Known profile keys from the profiles YAML.
 *
 * Additional profile keys may be added in the YAML; consumers should still
 * accept arbitrary strings where forward compatibility is needed.
 */
export type ProfileKey =
  | 'default'
  | 'friend_group'
  | 'hospital'
  | 'advocacy_group'
  | 'retail_chain'
  | 'military_organization'
  | 'environmental_group'
  | 'artist_collective';

/* -------------------------------------------------------------------------- */
/*  Insights config: /config/insights/config.yaml (insights: subtree)         */
/* -------------------------------------------------------------------------- */

/**
 * Warehouse types supported by the Insights slice.
 */
export type InsightsWarehouseType = 'postgres' | 'bigquery' | 'snowflake';

export interface InsightsWarehouseConfig {
  type: InsightsWarehouseType;
  connection_url: string;
  schema: string;
  read_only_user: string;
  write_user: string;
}

export interface InsightsEtlConfig {
  owner_email: string;
  default_batch_size: number;
  max_batch_size: number;
  concurrency: number;
}

export interface InsightsCacheTtlSeconds {
  dashboard_default: number;
  dashboard_slow: number;
  streaming_like: number;
}

export interface InsightsCacheMaxKeysPerDashboard {
  dev?: number;
  staging?: number;
  prod?: number;
  offline?: number;
}

export interface InsightsCacheConfig {
  backend: 'redis';
  url: string;
  ttl_seconds: InsightsCacheTtlSeconds;
  max_keys_per_dashboard: InsightsCacheMaxKeysPerDashboard;
}

/**
 * Per-environment numeric config slice, where not all environments
 * must be explicitly defined in YAML.
 */
export type PerEnvironmentNumber = Partial<Record<Exclude<Environment, 'offline'>, number>>;

export interface InsightsRetentionConfig {
  raw_event_retention_days: PerEnvironmentNumber;
  aggregated_retention_days: PerEnvironmentNumber;
  pattern_result_retention_days: PerEnvironmentNumber;
}

export interface InsightsBackupSlice {
  rpo_minutes: PerEnvironmentNumber;
  rto_minutes: PerEnvironmentNumber;
}

export interface InsightsExportLimitsPerEnvironment {
  dev?: number;
  staging?: number;
  prod?: number;
}

export interface InsightsExportConfig {
  max_rows_per_export: InsightsExportLimitsPerEnvironment;
  max_parallel_exports_per_user: InsightsExportLimitsPerEnvironment;
  pii_masking_enabled: boolean;
  allowed_visibilities: Visibility[];
}

/**
 * Sliding-window settings for pattern detection at a given cadence
 * (weekly / monthly / yearly).
 */
export interface InsightsPatternWindowConfig {
  window_days: number;
  min_events: number;
  min_distinct_sources: number;
}

/**
 * Pattern configuration, including profile selection by domain.
 */
export interface InsightsPatternsConfig {
  /**
   * Profile key to use when no domain-specific override applies.
   */
  default_profile_key: ProfileKey | string;

  /**
   * Mapping from Task.type (e.g. "maintenance", "hr_case") to profile key.
   */
  overrides_by_domain?: Record<string, ProfileKey | string>;

  weekly: InsightsPatternWindowConfig;
  monthly: InsightsPatternWindowConfig;
  yearly: InsightsPatternWindowConfig;
}

/**
 * Root of the /config/insights/config.yaml "insights" subtree.
 *
 * Note: some deployments may wrap this under a top-level `{ insights: InsightsConfig }`.
 */
export interface InsightsConfig {
  environment: Environment;
  warehouse: InsightsWarehouseConfig;
  etl: InsightsEtlConfig;
  cache: InsightsCacheConfig;
  retention: InsightsRetentionConfig;
  backups: InsightsBackupSlice;
  exports: InsightsExportConfig;
  patterns: InsightsPatternsConfig;
}

/* -------------------------------------------------------------------------- */
/*  Star-schema dimensions: insights.dim_*                                    */
/* -------------------------------------------------------------------------- */

/**
 * Calendar/date dimension row.
 */
export interface InsightsDimDate {
  date_key: IsoDateString; // e.g. "2025-03-14"
  year: number;
  quarter: number; // 1–4
  month: number; // 1–12
  month_name: string;
  week_of_year: number;
  day_of_week: number; // 1=Monday–7=Sunday
  day_name: string;
  is_weekend: boolean;
}

/**
 * Organization dimension row (analytics view over organizations).
 */
export interface InsightsDimOrganization {
  organization_id: UUID;
  slug: string;
  display_name: string;
  org_type: string | null;
  timezone: string;
  active_from: IsoDateString;
  active_to: IsoDateString | null;
}

/**
 * Task dimension row (denormalized task view).
 */
export interface InsightsDimTask {
  task_id: UUID;
  organization_id: UUID;
  case_id: UUID | null;

  label: string;
  type: string;
  category: string;
  subtype: string | null;

  priority: TaskPriority;
  severity: TaskSeverity;
  visibility: Visibility;
  source: TaskSource;

  assignee_role: string | null;

  created_at: IsoDateTimeString;
  closed_at: IsoDateTimeString | null;

  current_status: TaskStatus;
}

/**
 * Case dimension row (denormalized case view).
 */
export interface InsightsDimCase {
  case_id: UUID;
  organization_id: UUID;

  label: string;
  title: string;
  status: CaseStatus;
  severity: TaskSeverity;

  origin_vertical_level: number;
  origin_role: string;

  opened_at: IsoDateTimeString;
  closed_at: IsoDateTimeString | null;
}

/**
 * Person dimension row (analytics view over person_profiles).
 */
export type PersonConfidentialityLevel = 'normal' | 'sensitive' | 'highly_sensitive';

export interface InsightsDimPerson {
  person_id: UUID;
  organization_id: UUID;
  full_name: string;
  external_reference: string | null;
  confidentiality_level: PersonConfidentialityLevel;
}

/**
 * Learning group (class/team/group) dimension row.
 */
export interface InsightsDimLearningGroup {
  learning_group_id: UUID;
  organization_id: UUID;
  code: string;
  name: string;
  category: string;
}

/* -------------------------------------------------------------------------- */
/*  Star-schema fact tables: insights.fact_*                                  */
/* -------------------------------------------------------------------------- */

/**
 * Task fact row – core lifecycle metrics used in reporting.
 */
export interface InsightsFactTask {
  id: number; // bigserial in DB
  task_id: UUID;
  organization_id: UUID;

  created_date_key: IsoDateString;
  closed_date_key: IsoDateString | null;

  current_status: TaskStatus;
  priority: TaskPriority;
  severity: TaskSeverity;
  source: TaskSource;

  time_to_first_response_seconds: number | null;
  time_to_completion_seconds: number | null;

  escalation_count: number;
  comment_count: number;
}

/**
 * Case fact row – lifecycle metrics and link counts.
 */
export interface InsightsFactCase {
  id: number; // bigserial
  case_id: UUID;
  organization_id: UUID;

  opened_date_key: IsoDateString;
  closed_date_key: IsoDateString | null;

  status: CaseStatus;
  severity: TaskSeverity;

  linked_task_count: number;
  escalation_count: number;
  review_count: number;
}

/**
 * Wellbeing check-in fact row.
 */
export interface InsightsFactWellbeingCheckin {
  id: number; // bigserial
  checkin_id: UUID;
  organization_id: UUID;

  person_id: UUID | null;
  learning_group_id: UUID | null;

  date_key: IsoDateString;
  score: number;
  tags: string[];

  related_case_id: UUID | null;
  related_task_id: UUID | null;
}

/* -------------------------------------------------------------------------- */
/*  Generic helpers for UI/reporting                                         */
/* -------------------------------------------------------------------------- */

/**
 * Generic time-series point used by insights dashboards.
 */
export interface InsightsTimeSeriesPoint<TExtra = unknown> {
  /**
   * Calendar date for this bucket (usually mapped from dim_dates.date_key).
   */
  date_key: IsoDateString;

  /**
   * Primary value for this bucket (e.g. count of tasks).
   */
  value: number;

  /**
   * Optional extra payload per point (e.g. breakdowns).
   */
  extra?: TExtra;
}

/**
 * Simple grouped aggregate row, e.g. "tasks by status" or "cases by label".
 */
export interface InsightsGroupedAggregateRow<TKey = string> {
  key: TKey;
  count: number;
}

/**
 * Standard shape for "SLA breach" listings in analytics reports.
 * This does not directly map to a single table, but is a convenient
 * projection over tasks + fact_tasks + profiles.
 */
export interface InsightsSlaBreachRow {
  task_id: UUID;
  organization_id: UUID;
  title: string;
  type: string;
  category: string;
  priority: TaskPriority;
  severity: TaskSeverity;
  visibility: Visibility;
  source: TaskSource;

  status: TaskStatus;
  created_at: IsoDateTimeString;
  reactivity_deadline_at: IsoDateTimeString | null;
  closed_at: IsoDateTimeString | null;

  /**
   * Positive number of seconds the task is/was beyond its SLA, if applicable.
   */
  breach_seconds: number;
}

===== END apps/web/src/orgo/types/insights.ts =====


===== BEGIN apps/web/src/orgo/types/organization.ts =====
// apps/web/src/orgo/types/organization.ts

/**
 * Organization and organization-profile related types used in the Orgo web app.
 *
 * These types mirror:
 * - The Orgo v3 database schema for `organizations` and `organization_profiles`.
 * - The profiles YAML behaviour schema (profile codes and behavioural knobs).
 */

/**
 * Canonical environment keys (ENVIRONMENT).
 */
export type EnvironmentKey = 'dev' | 'staging' | 'prod' | 'offline';

/**
 * Simple aliases for commonly used primitives.
 */
export type UUID = string;
export type ISO8601String = string;

/**
 * Status of an organization (organizations.status).
 * Backed by `organization_status_enum` in the database.
 */
export type OrganizationStatus = 'active' | 'suspended' | 'archived';

/**
 * Core Organization shape as exposed to the web app.
 *
 * Matches the `organizations` table logical fields:
 * - id (UUID PK)
 * - slug, display_name, legal_name, primary_domain
 * - status, timezone, default_locale
 * - created_at / updated_at (standard audit columns)
 */
export interface Organization {
  id: UUID;
  slug: string;
  display_name: string;
  legal_name: string | null;
  primary_domain: string | null;
  status: OrganizationStatus;
  /**
   * IANA timezone, e.g. "America/New_York".
   */
  timezone: string;
  /**
   * Locale code, e.g. "en", "fr-CA".
   */
  default_locale: string;
  /**
   * Standard audit timestamps (UTC ISO-8601).
   * Optional in case some APIs omit them.
   */
  created_at?: ISO8601String;
  updated_at?: ISO8601String;
}

/**
 * Known profile codes from the profiles YAML plus a string
 * extension point for custom / future profiles.
 *
 * These values correspond to `organization_profiles.profile_code`.
 */
export type OrganizationProfileKey =
  | 'default'
  | 'friend_group'
  | 'hospital'
  | 'advocacy_group'
  | 'retail_chain'
  | 'military_organization'
  | 'environmental_group'
  | 'artist_collective'
  | (string & {}); // allow custom codes while keeping string literal narrowing

/**
 * Behaviour profile primitives from the profiles YAML.
 */

export type TransparencyLevel = 'full' | 'balanced' | 'restricted' | 'private';

export type EscalationGranularity =
  | 'relaxed'
  | 'moderate'
  | 'detailed'
  | 'aggressive';

export type ReviewFrequency =
  | 'real_time'
  | 'daily'
  | 'weekly'
  | 'monthly'
  | 'quarterly'
  | 'yearly'
  | 'ad_hoc';

export type NotificationScope = 'user' | 'team' | 'department' | 'org_wide';

export type PatternSensitivity = 'low' | 'medium' | 'high' | 'critical';

export type SeverityThreshold = 'very_high' | 'high' | 'medium' | 'low';

export type LoggingLevel = 'minimal' | 'standard' | 'detailed' | 'audit';

export type AutomationLevel = 'manual' | 'low' | 'medium' | 'high' | 'full';

export type ProfileVisibilityDefault =
  | 'public'
  | 'internal'
  | 'restricted'
  | 'anonymised';

export type ProfilePriorityDefault = 'low' | 'medium' | 'high' | 'critical';

/**
 * Metadata block used in the profiles YAML.
 */
export interface BehaviorProfileMetadata {
  version: string;
  last_updated: string; // "YYYY-MM-DD"
  environment: EnvironmentKey;
}

/**
 * Severity policy section from the profiles YAML.
 */
export interface BehaviorProfileSeverityPolicyEntry {
  immediate_escalation: boolean;
}

export interface BehaviorProfileSeverityPolicy {
  critical: BehaviorProfileSeverityPolicyEntry;
  major: BehaviorProfileSeverityPolicyEntry;
  minor: BehaviorProfileSeverityPolicyEntry;
}

/**
 * Default task metadata section from the profiles YAML.
 * Values map to canonical TASK_PRIORITY and VISIBILITY enums.
 */
export interface BehaviorProfileDefaultTaskMetadata {
  visibility: ProfileVisibilityDefault;
  default_priority: ProfilePriorityDefault;
  /**
   * Default SLA window (in seconds) for tasks created under this profile.
   */
  default_reactivity_seconds: number;
}

/**
 * Cyclic overview / pattern detection configuration from the profiles YAML.
 */

export interface BehaviorProfileCyclicIncidentFrequency {
  min_events: number;
  window_days: number;
}

export interface BehaviorProfileCyclicThresholdTriggers {
  incident_frequency: BehaviorProfileCyclicIncidentFrequency;
  cross_departmental_trends: boolean;
  high_risk_indicators: boolean;
}

export interface BehaviorProfileCyclicSchedule {
  weekly: boolean;
  monthly: boolean;
  yearly: boolean;
}

export interface BehaviorProfileCyclicOverviewConfig {
  enabled: boolean;
  schedule: BehaviorProfileCyclicSchedule;
  threshold_triggers: BehaviorProfileCyclicThresholdTriggers;
}

/**
 * Behaviour profile as loaded from the profiles YAML
 * (one entry under `profiles:`).
 *
 * This describes how intense/urgent/private an org is:
 * reactivity, escalation, transparency, pattern sensitivity, logging, etc.
 */
export interface BehaviorProfile {
  description: string;
  metadata: BehaviorProfileMetadata;

  // 1. Reactivity / Escalation timing
  reactivity_seconds: number;
  max_escalation_seconds: number;

  // 2. Information visibility
  transparency_level: TransparencyLevel;

  // 3. Escalation structure
  escalation_granularity: EscalationGranularity;

  // 4. Review cadence
  review_frequency: ReviewFrequency;

  // 5. Who gets notified
  notification_scope: NotificationScope;

  // 6. Pattern detection
  pattern_sensitivity: PatternSensitivity;
  pattern_window_days: number;
  pattern_min_events: number;

  // 7. Severity / auto-escalation
  severity_threshold: SeverityThreshold;
  severity_policy: BehaviorProfileSeverityPolicy;

  // 8. Logging & traceability
  logging_level: LoggingLevel;
  log_retention_days: number;

  // 9. Automation level
  automation_level: AutomationLevel;

  // 10. Defaults for task metadata
  default_task_metadata: BehaviorProfileDefaultTaskMetadata;

  // 11. Cyclic Overview settings
  cyclic_overview: BehaviorProfileCyclicOverviewConfig;
}

/**
 * Mapping from profile code → behaviour profile.
 * Mirrors the `profiles:` top-level map in the YAML.
 */
export type BehaviorProfilesMap = Record<OrganizationProfileKey, BehaviorProfile>;

/**
 * Database-level link between an organization and a profile code,
 * plus per-organization overrides for reactivity / transparency /
 * pattern sensitivity / retention.
 *
 * Mirrors the `organization_profiles` table.
 */
export interface OrganizationProfile {
  id: UUID;
  organization_id: UUID;
  profile_code: OrganizationProfileKey;

  /**
   * Per-task-type SLA targets, minutes for LOW/MEDIUM/HIGH/CRITICAL
   * or a similar structure. Kept generic here because the concrete
   * shape is configuration-driven.
   */
  reactivity_profile: unknown;

  /**
   * Defaults for who can see what; configuration-driven structure.
   */
  transparency_profile: unknown;

  /**
   * Thresholds for insights/alerts; configuration-driven structure.
   */
  pattern_sensitivity_profile: unknown;

  /**
   * Log & data retention periods per category; configuration-driven structure.
   */
  retention_profile: unknown;

  /**
   * Incremented on profile changes.
   */
  version: number;

  created_at?: ISO8601String;
  updated_at?: ISO8601String;
}

/**
 * Convenience view used by the frontend when an organization is loaded
 * together with its profile linkage and the resolved behaviour profile
 * (from the profiles YAML).
 */
export interface OrganizationWithProfile {
  organization: Organization;
  organization_profile: OrganizationProfile | null;
  /**
   * Fully-resolved behavioural profile (e.g. "hospital", "friend_group"),
   * if it could be loaded for the given profile_code.
   */
  behavior_profile: BehaviorProfile | null;
}

===== END apps/web/src/orgo/types/organization.ts =====


===== BEGIN apps/web/src/orgo/types/permission.ts =====
/**
 * Permission types for the Orgo web app.
 *
 * These mirror the backend `permissions` table:
 *   - id: UUID primary key
 *   - code: stable string identifier (e.g. "task.view_sensitive")
 *   - description: human-readable explanation
 *
 * Only a subset of permission codes is explicitly enumerated here; the type
 * remains open to any additional codes the backend defines.
 */

/**
 * Canonical permission codes that are explicitly referenced
 * in the Orgo v3 specification and UI.
 *
 * NOTE: This list is not exhaustive. New permissions added on the backend
 * will still be representable via `PermissionCode`.
 */
export const KNOWN_PERMISSIONS = [
  'task.view_sensitive',
  'workflow.edit_rules',
] as const;

/**
 * Narrow type for the explicitly-known permission codes.
 */
export type KnownPermissionCode = (typeof KNOWN_PERMISSIONS)[number];

/**
 * Canonical permission code used across the web app.
 *
 * `KnownPermissionCode` captures well-known, spec-documented codes, while the
 * `string & {}` intersection keeps the type open to any additional codes
 * defined in the backend without breaking type checking.
 */
export type PermissionCode = KnownPermissionCode | (string & {});

/**
 * Permission record as exposed by the Orgo API.
 *
 * This mirrors the logical shape of the `permissions` table:
 *   - id: UUID primary key
 *   - code: stable permission identifier
 *   - description: human-readable explanation
 */
export interface Permission {
  id: string;
  code: PermissionCode;
  description: string;
}

/**
 * A collection of permission codes, typically representing
 * the effective permission set for the current user.
 */
export type PermissionSet = ReadonlyArray<PermissionCode>;

/**
 * A lookup/map representation of permissions where a present key
 * means the permission is granted.
 */
export type PermissionLookup = Readonly<Record<string, true>>;

/**
 * Union type for any permission collection representation
 * this module knows how to check.
 */
export type PermissionCollection = PermissionSet | PermissionLookup;

/**
 * Convert a list of permission codes into a lookup map suitable
 * for fast, repeated permission checks.
 */
export function toPermissionLookup(set: PermissionSet): PermissionLookup {
  const lookup: Record<string, true> = {};

  for (const code of set) {
    // Using string index here keeps this tolerant of unknown codes.
    lookup[code] = true;
  }

  return lookup;
}

/**
 * Check whether a given permission is present in the provided
 * collection (array or lookup map).
 */
export function hasPermission(
  permissions: PermissionCollection,
  code: PermissionCode,
): boolean {
  if (Array.isArray(permissions)) {
    return permissions.includes(code);
  }

  return permissions[code] === true;
}

/**
 * Check whether at least one of the given permission codes
 * is present in the collection.
 */
export function hasAnyPermission(
  permissions: PermissionCollection,
  codes: ReadonlyArray<PermissionCode>,
): boolean {
  for (const code of codes) {
    if (hasPermission(permissions, code)) {
      return true;
    }
  }
  return false;
}

/**
 * Check whether all of the given permission codes are present
 * in the collection.
 */
export function hasAllPermissions(
  permissions: PermissionCollection,
  codes: ReadonlyArray<PermissionCode>,
): boolean {
  for (const code of codes) {
    if (!hasPermission(permissions, code)) {
      return false;
    }
  }
  return true;
}

===== END apps/web/src/orgo/types/permission.ts =====


===== BEGIN apps/web/src/orgo/types/person.ts =====
// apps/web/src/orgo/types/person.ts

/**
 * Person-related types for the Orgo web application.
 *
 * These map to the `person_profiles` table and related enums in the Orgo v3
 * specification. Field names follow the JSON/API contract.
 */

/**
 * Canonical confidentiality levels for person profiles.
 *
 * DB / spec values:
 *   - normal
 *   - sensitive
 *   - highly_sensitive
 */
export type PersonConfidentialityLevel =
  | 'normal'
  | 'sensitive'
  | 'highly_sensitive';

/**
 * Stable identifier type alias for persons.
 *
 * Maps to:
 *   - DB: person_profiles.id
 *   - API/JSON: person_id
 */
export type PersonId = string;

/**
 * Core Person / PersonProfile representation as exposed via the API.
 *
 * This is a direct mapping of the `person_profiles` schema plus default
 * audit columns. Timestamps are ISO‑8601 strings in UTC.
 */
export interface Person {
  /**
   * Stable identifier for the person.
   * DB: person_profiles.id
   */
  person_id: PersonId;

  /**
   * Owning organization (tenant).
   * DB: person_profiles.organization_id
   */
  organization_id: string;

  /**
   * Optional linked user account if this person also has an Orgo login.
   * DB: person_profiles.linked_user_id
   */
  linked_user_id: string | null;

  /**
   * External reference such as student ID or employee number.
   * DB: person_profiles.external_reference
   */
  external_reference: string | null;

  /**
   * Full human name.
   * DB: person_profiles.full_name
   */
  full_name: string;

  /**
   * Date of birth in ISO‑8601 date format (YYYY‑MM‑DD), if known.
   * DB: person_profiles.date_of_birth
   */
  date_of_birth: string | null;

  /**
   * Primary contact email address, if any.
   * DB: person_profiles.primary_contact_email
   */
  primary_contact_email: string | null;

  /**
   * Primary contact phone number, if any.
   * DB: person_profiles.primary_contact_phone
   */
  primary_contact_phone: string | null;

  /**
   * Confidentiality level for this person, used by higher‑level
   * visibility and guardrail logic.
   * DB: person_profiles.confidentiality_level
   */
  confidentiality_level: PersonConfidentialityLevel;

  /**
   * Creation timestamp (UTC, ISO‑8601).
   * DB: person_profiles.created_at
   */
  created_at: string;

  /**
   * Last update timestamp (UTC, ISO‑8601).
   * DB: person_profiles.updated_at
   */
  updated_at: string;
}

/**
 * Alias for compatibility with code that prefers the PersonProfile name.
 * Both refer to the same underlying shape.
 */
export type PersonProfile = Person;

===== END apps/web/src/orgo/types/person.ts =====


===== BEGIN apps/web/src/orgo/types/profile.ts =====

===== END apps/web/src/orgo/types/profile.ts =====


===== BEGIN apps/web/src/orgo/types/role.ts =====

===== END apps/web/src/orgo/types/role.ts =====


===== BEGIN apps/web/src/orgo/types/task.ts =====
// Canonical Orgo Task types for the web app.
// This mirrors the Task JSON contract exposed by the API.

/**
 * Simple ID aliases for clarity.
 */
export type TaskId = string;
export type OrganizationId = string;
export type CaseId = string;

/**
 * Task status values (JSON-level).
 * Back-end maps these to DB enums.
 */
export type TaskStatus =
  | 'pending'
  | 'in_progress'
  | 'on_hold'
  | 'completed'
  | 'failed'
  | 'escalated'
  | 'cancelled';

/**
 * Task priority values (JSON-level).
 */
export type TaskPriority = 'low' | 'medium' | 'high' | 'critical';

/**
 * Task severity values (JSON-level).
 */
export type TaskSeverity = 'minor' | 'moderate' | 'major' | 'critical';

/**
 * Visibility values (JSON-level).
 */
export type Visibility = 'public' | 'internal' | 'restricted' | 'anonymised';

/**
 * Task source/channel values (JSON-level).
 */
export type TaskSource = 'email' | 'api' | 'manual' | 'sync';

/**
 * Global task category values (JSON-level).
 */
export type TaskCategory =
  | 'request'
  | 'incident'
  | 'update'
  | 'report'
  | 'distribution';

/**
 * Arbitrary domain metadata attached to a Task.
 * Must not duplicate core fields (status, severity, etc.).
 */
export type TaskMetadata = Record<string, unknown>;

/**
 * Canonical Task object as returned by the Orgo API.
 * All timestamps are ISO-8601 strings (UTC).
 */
export interface Task {
  // Identity and tenancy
  task_id: TaskId;
  organization_id: OrganizationId;
  case_id: CaseId | null;

  // Classification
  type: string;
  category: TaskCategory;
  subtype: string | null;
  label: string;

  // Core text
  title: string;
  description: string;

  // State and enums
  status: TaskStatus;
  priority: TaskPriority;
  severity: TaskSeverity;
  visibility: Visibility;
  source: TaskSource;

  // Ownership / actors
  created_by_user_id: string | null;
  requester_person_id: string | null;
  owner_role_id: string | null;
  owner_user_id: string | null;
  assignee_role: string | null;

  // Timing / SLA
  due_at: string | null;
  created_at: string;
  updated_at: string;
  closed_at: string | null;
  reactivity_time: string | null;
  reactivity_deadline_at: string | null;
  escalation_level: number;

  // Domain-specific payload
  metadata: TaskMetadata;
}

===== END apps/web/src/orgo/types/task.ts =====


===== BEGIN apps/web/src/screens/admin/.gitkeep =====

===== END apps/web/src/screens/admin/.gitkeep =====


===== BEGIN apps/web/src/screens/admin/cases/AdminCaseOverviewPage.tsx =====
import React from "react";
import { useAdminCaseOverviewQuery } from "../../../store/services/orgoApi";

type CaseStatus = "open" | "in_progress" | "resolved" | "archived";

type CaseSeverity = "minor" | "moderate" | "major" | "critical";

type TimeFilter = "all" | "7d" | "30d" | "90d" | "180d" | "365d";

export interface AdminCaseOverviewCase {
  case_id: string;
  organization_id: string;
  title: string;
  description?: string | null;
  label: string;
  status: CaseStatus;
  severity: CaseSeverity;
  source_type: "email" | "api" | "manual" | "sync";
  reactivity_time?: string | null;
  reactivity_deadline_at?: string | null;
  created_at: string;
  updated_at: string;
  open_tasks_count?: number;
  overdue_tasks_count?: number;
  profile_key?: string;
}

export interface AdminCaseOverviewResponse {
  cases: AdminCaseOverviewCase[];
  totalCount: number;
}

export interface AdminCaseOverviewQueryArgs {
  status?: CaseStatus;
  severity?: CaseSeverity;
  search?: string;
  profileKey?: string;
  windowDays?: number;
}

interface SummaryCounts {
  total: number;
  unresolved: number;
  overdue: number;
  critical: number;
}

const unresolvedStatuses: CaseStatus[] = [
  "open",
  "in_progress",
];

function timeFilterToDays(value: TimeFilter): number | undefined {
  switch (value) {
    case "7d":
      return 7;
    case "30d":
      return 30;
    case "90d":
      return 90;
    case "180d":
      return 180;
    case "365d":
      return 365;
    case "all":
    default:
      return undefined;
  }
}

function formatDate(dateString?: string | null): string {
  if (!dateString) {
    return "—";
  }
  const date = new Date(dateString);
  if (Number.isNaN(date.getTime())) {
    return dateString;
  }
  return date.toLocaleString();
}

function formatStatusLabel(status: CaseStatus): string {
  if (status === "in_progress") {
    return "in progress";
  }
  return status;
}

function getStatusBadgeClasses(status: CaseStatus): string {
  switch (status) {
    case "open":
      return "bg-yellow-100 text-yellow-800";
    case "in_progress":
      return "bg-blue-100 text-blue-800";
    case "resolved":
      return "bg-green-100 text-green-800";
    case "archived":
      return "bg-gray-100 text-gray-700";
    default:
      return "bg-gray-100 text-gray-800";
  }
}

function getSeverityBadgeClasses(severity: CaseSeverity): string {
  switch (severity) {
    case "critical":
      return "bg-red-100 text-red-800";
    case "major":
      return "bg-orange-100 text-orange-800";
    case "moderate":
      return "bg-yellow-100 text-yellow-800";
    case "minor":
    default:
      return "bg-blue-100 text-blue-800";
  }
}

type TableCellProps = React.PropsWithChildren<{ className?: string }>;

function Th({ children, className = "" }: TableCellProps) {
  return (
    <th
      scope="col"
      className={`px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-gray-500 ${className}`}
    >
      {children}
    </th>
  );
}

function Td({ children, className = "" }: TableCellProps) {
  return (
    <td className={`px-4 py-3 align-top text-sm text-gray-900 ${className}`}>
      {children}
    </td>
  );
}

const Badge: React.FC<{ className?: string }> = ({
  className = "",
  children,
}) => (
  <span
    className={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${className}`}
  >
    {children}
  </span>
);

function buildSummary(cases: AdminCaseOverviewCase[]): SummaryCounts {
  const now = Date.now();

  let total = 0;
  let unresolved = 0;
  let overdue = 0;
  let critical = 0;

  for (const c of cases) {
    total += 1;

    const isUnresolved = unresolvedStatuses.includes(c.status);
    if (isUnresolved) {
      unresolved += 1;
    }

    if (c.severity === "critical") {
      critical += 1;
    }

    if (isUnresolved && c.reactivity_deadline_at) {
      const deadline = new Date(c.reactivity_deadline_at).getTime();
      if (!Number.isNaN(deadline) && deadline < now) {
        overdue += 1;
      }
    }
  }

  return { total, unresolved, overdue, critical };
}

export function AdminCaseOverviewPage() {
  const [statusFilter, setStatusFilter] = React.useState<
    "all" | CaseStatus
  >("open");
  const [severityFilter, setSeverityFilter] = React.useState<
    "all" | CaseSeverity
  >("all");
  const [timeFilter, setTimeFilter] =
    React.useState<TimeFilter>("30d");
  const [searchTerm, setSearchTerm] = React.useState("");

  const queryArgs: AdminCaseOverviewQueryArgs =
    React.useMemo(() => {
      const args: AdminCaseOverviewQueryArgs = {};

      if (statusFilter !== "all") {
        args.status = statusFilter;
      }

      if (severityFilter !== "all") {
        args.severity = severityFilter;
      }

      const trimmedSearch = searchTerm.trim();
      if (trimmedSearch.length > 0) {
        args.search = trimmedSearch;
      }

      const windowDays = timeFilterToDays(timeFilter);
      if (typeof windowDays === "number") {
        args.windowDays = windowDays;
      }

      return args;
    }, [statusFilter, severityFilter, timeFilter, searchTerm]);

  const { data, isLoading, isFetching, isError, refetch } =
    useAdminCaseOverviewQuery(queryArgs);

  const cases: AdminCaseOverviewCase[] = (
    data?.cases ?? []
  ) as AdminCaseOverviewCase[];

  const summary = React.useMemo(
    () => buildSummary(cases),
    [cases]
  );

  const totalCount =
    typeof data?.totalCount === "number"
      ? data.totalCount
      : cases.length;

  return (
    <div className="px-6 py-4">
      <header className="mb-4 flex flex-col items-start justify-between gap-4 md:flex-row md:items-center">
        <div>
          <h1 className="text-2xl font-semibold text-gray-900">
            Case overview
          </h1>
          <p className="mt-1 text-sm text-gray-600">
            High-level view of Cases for cyclic reviews and
            systemic follow-up.
          </p>
        </div>
        <button
          type="button"
          onClick={() => refetch()}
          className="inline-flex items-center rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-medium shadow-sm hover:bg-gray-50"
        >
          Refresh
        </button>
      </header>

      <section
        aria-label="Case overview summary"
        className="mb-4 grid gap-3 md:grid-cols-4"
      >
        <div className="rounded-md border border-gray-200 bg-white p-4">
          <div className="text-xs font-medium uppercase text-gray-500">
            Total cases
          </div>
          <div className="mt-1 text-2xl font-semibold text-gray-900">
            {summary.total}
          </div>
          <div className="mt-1 text-xs text-gray-500">
            Across all profiles and labels
          </div>
        </div>
        <div className="rounded-md border border-yellow-100 bg-yellow-50 p-4">
          <div className="text-xs font-medium uppercase text-yellow-800">
            Unresolved
          </div>
          <div className="mt-1 text-2xl font-semibold text-yellow-900">
            {summary.unresolved}
          </div>
          <div className="mt-1 text-xs text-yellow-900">
            Open or in progress
          </div>
        </div>
        <div className="rounded-md border border-red-100 bg-red-50 p-4">
          <div className="text-xs font-medium uppercase text-red-800">
            Overdue (by reactivity)
          </div>
          <div className="mt-1 text-2xl font-semibold text-red-900">
            {summary.overdue}
          </div>
          <div className="mt-1 text-xs text-red-900">
            Past reactivity deadline and unresolved
          </div>
        </div>
        <div className="rounded-md border border-gray-200 bg-white p-4">
          <div className="text-xs font-medium uppercase text-gray-500">
            Critical severity
          </div>
          <div className="mt-1 text-2xl font-semibold text-gray-900">
            {summary.critical}
          </div>
          <div className="mt-1 text-xs text-gray-500">
            Cases marked as critical
          </div>
        </div>
      </section>

      <section
        aria-label="Filters"
        className="mb-4 grid gap-3 rounded-md border border-gray-200 bg-white p-4 md:grid-cols-4"
      >
        <div className="flex flex-col gap-1">
          <label
            htmlFor="case-search"
            className="text-xs font-medium text-gray-700"
          >
            Search
          </label>
          <input
            id="case-search"
            type="search"
            placeholder="Title, label, ID…"
            value={searchTerm}
            onChange={(event) =>
              setSearchTerm(event.target.value)
            }
            className="rounded-md border border-gray-300 px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          />
        </div>

        <div className="flex flex-col gap-1">
          <label
            htmlFor="case-status-filter"
            className="text-xs font-medium text-gray-700"
          >
            Status
          </label>
          <select
            id="case-status-filter"
            value={statusFilter}
            onChange={(event) =>
              setStatusFilter(
                event.target
                  .value as "all" | CaseStatus
              )
            }
            className="rounded-md border border-gray-300 px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="all">All statuses</option>
            <option value="open">Open</option>
            <option value="in_progress">In progress</option>
            <option value="resolved">Resolved</option>
            <option value="archived">Archived</option>
          </select>
        </div>

        <div className="flex flex-col gap-1">
          <label
            htmlFor="case-severity-filter"
            className="text-xs font-medium text-gray-700"
          >
            Severity
          </label>
          <select
            id="case-severity-filter"
            value={severityFilter}
            onChange={(event) =>
              setSeverityFilter(
                event.target
                  .value as "all" | CaseSeverity
              )
            }
            className="rounded-md border border-gray-300 px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="all">All severities</option>
            <option value="minor">Minor</option>
            <option value="moderate">Moderate</option>
            <option value="major">Major</option>
            <option value="critical">Critical</option>
          </select>
        </div>

        <div className="flex flex-col gap-1">
          <label
            htmlFor="case-window-filter"
            className="text-xs font-medium text-gray-700"
          >
            Time window
          </label>
          <select
            id="case-window-filter"
            value={timeFilter}
            onChange={(event) =>
              setTimeFilter(
                event.target.value as TimeFilter
              )
            }
            className="rounded-md border border-gray-300 px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          >
            <option value="30d">
              Last 30 days
            </option>
            <option value="7d">Last 7 days</option>
            <option value="90d">
              Last 90 days
            </option>
            <option value="180d">
              Last 180 days
            </option>
            <option value="365d">
              Last 365 days
            </option>
            <option value="all">All time</option>
          </select>
        </div>
      </section>

      <section className="overflow-hidden rounded-md border border-gray-200 bg-white">
        {isLoading ? (
          <div className="p-6 text-sm text-gray-600">
            Loading cases…
          </div>
        ) : isError ? (
          <div className="flex items-center justify-between gap-4 p-6 text-sm text-red-700">
            <span>
              Unable to load cases. Please try again.
            </span>
            <button
              type="button"
              onClick={() => refetch()}
              className="inline-flex items-center rounded-md border border-red-300 bg-white px-3 py-1 text-xs font-medium hover:bg-red-50"
            >
              Retry
            </button>
          </div>
        ) : cases.length === 0 ? (
          <div className="p-6 text-sm text-gray-600">
            No cases match your filters.
          </div>
        ) : (
          <>
            <div className="flex items-center justify-between border-b border-gray-200 px-4 py-2 text-xs text-gray-600">
              <span>
                Showing{" "}
                <span className="font-medium">
                  {cases.length}
                </span>{" "}
                of{" "}
                <span className="font-medium">
                  {totalCount}
                </span>{" "}
                cases
              </span>
            </div>
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200 text-sm">
                <thead className="bg-gray-50">
                  <tr>
                    <Th>Case</Th>
                    <Th>Label</Th>
                    <Th>Status</Th>
                    <Th>Severity</Th>
                    <Th>Open / overdue tasks</Th>
                    <Th>Created</Th>
                    <Th>Last updated</Th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-100 bg-white">
                  {cases.map((c) => (
                    <tr key={c.case_id}>
                      <Td className="max-w-xs">
                        <div className="flex flex-col">
                          <span className="truncate text-sm font-medium text-gray-900">
                            {c.title}
                          </span>
                          <span className="mt-0.5 text-xs text-gray-500">
                            #{c.case_id.slice(0, 8)} ·{" "}
                            {c.source_type}
                          </span>
                        </div>
                      </Td>
                      <Td className="max-w-xs">
                        <div className="flex flex-col">
                          <span className="truncate text-xs text-gray-700">
                            {c.label}
                          </span>
                          {c.profile_key && (
                            <span className="mt-0.5 text-xs text-gray-400">
                              Profile: {c.profile_key}
                            </span>
                          )}
                        </div>
                      </Td>
                      <Td>
                        <Badge
                          className={getStatusBadgeClasses(
                            c.status
                          )}
                        >
                          {formatStatusLabel(c.status)}
                        </Badge>
                      </Td>
                      <Td>
                        <Badge
                          className={getSeverityBadgeClasses(
                            c.severity
                          )}
                        >
                          {c.severity}
                        </Badge>
                      </Td>
                      <Td>
                        <div className="flex flex-col text-xs">
                          <span>
                            Open:{" "}
                            {typeof c.open_tasks_count ===
                            "number"
                              ? c.open_tasks_count
                              : "—"}
                          </span>
                          <span>
                            Overdue:{" "}
                            {typeof c.overdue_tasks_count ===
                            "number"
                              ? c.overdue_tasks_count
                              : "—"}
                          </span>
                        </div>
                      </Td>
                      <Td>
                        <span className="text-xs text-gray-700">
                          {formatDate(c.created_at)}
                        </span>
                      </Td>
                      <Td>
                        <span className="text-xs text-gray-700">
                          {formatDate(c.updated_at)}
                        </span>
                      </Td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </>
        )}
        {isFetching && !isLoading && (
          <div className="border-t border-gray-100 bg-gray-50 px-4 py-2 text-xs text-gray-500">
            Updating…
          </div>
        )}
      </section>
    </div>
  );
}

export default AdminCaseOverviewPage;

===== END apps/web/src/screens/admin/cases/AdminCaseOverviewPage.tsx =====


===== BEGIN apps/web/src/screens/admin/profiles/OrgProfileSettingsPage.tsx =====
import React, { useEffect, useMemo, useState } from "react";
import {
  // Assumed RTK Query hooks defined in apps/web/src/store/services/orgoApi.ts
  useOrgProfilesQuery,
  useProfilePreviewMutation,
  useUpdateServiceConfigMutation,
} from "../../../store/services/orgoApi";

export type OrgProfileCode =
  | "default"
  | "friend_group"
  | "hospital"
  | "advocacy_group"
  | "retail_chain"
  | "military_organization"
  | "environmental_group"
  | "artist_collective";

const PROFILE_OPTIONS: { code: OrgProfileCode; label: string; description: string }[] = [
  {
    code: "default",
    label: "Default",
    description: "Balanced defaults for reactivity, transparency, logging and pattern detection.",
  },
  {
    code: "friend_group",
    label: "Friend group",
    description: "Low‑stakes group with relaxed timing and light logging.",
  },
  {
    code: "hospital",
    label: "Hospital",
    description: "Safety‑critical environment with fast escalation and strict privacy.",
  },
  {
    code: "advocacy_group",
    label: "Advocacy group",
    description: "Mission‑driven NGO with responsive handling and strong traceability.",
  },
  {
    code: "retail_chain",
    label: "Retail chain",
    description: "Distributed operations, store‑level incidents, mixed urgency and retention.",
  },
  {
    code: "military_organization",
    label: "Military organization",
    description: "Highly sensitive context with aggressive escalation and full audit logging.",
  },
  {
    code: "environmental_group",
    label: "Environmental group",
    description: "Campaign‑driven work with high pattern sensitivity and wide signalling.",
  },
  {
    code: "artist_collective",
    label: "Artist collective",
    description: "Creative group; relaxed timing, minimal logging, low pattern sensitivity.",
  },
];

interface OrgProfileSnapshot {
  organization_id: string;
  organization_slug?: string;
  organization_display_name?: string;
  profile_code: OrgProfileCode | string;
  version?: number;
  // Shape mirrors the profiles YAML (Doc 7), using snake_case keys.
  profile: {
    description?: string;
    reactivity_seconds?: number;
    max_escalation_seconds?: number;
    transparency_level?: string;
    escalation_granularity?: string;
    review_frequency?: string;
    notification_scope?: string;
    pattern_sensitivity?: string;
    pattern_window_days?: number;
    pattern_min_events?: number;
    severity_threshold?: string;
    logging_level?: string;
    log_retention_days?: number;
    automation_level?: string;
    default_task_metadata?: {
      visibility?: string;
      default_priority?: string;
      default_reactivity_seconds?: number;
    };
    cyclic_overview?: {
      enabled?: boolean;
      schedule?: {
        weekly?: boolean;
        monthly?: boolean;
        yearly?: boolean;
      };
      threshold_triggers?: {
        incident_frequency?: {
          min_events?: number;
          window_days?: number;
        };
        cross_departmental_trends?: boolean;
        high_risk_indicators?: boolean;
      };
    };
  };
}

interface ProfilePreviewDiff {
  summary?: string;
  impact_bullets?: string[];
}

/**
 * Format seconds into a coarse human‑readable duration.
 */
function formatSeconds(value?: number): string {
  if (value == null) return "—";
  if (value < 60) return `${value}s`;
  const minutes = Math.round(value / 60);
  if (minutes < 60) return `${minutes} min`;
  const hours = Math.round(minutes / 60);
  if (hours < 24) return `${hours} h`;
  const days = Math.round(hours / 24);
  return `${days} d`;
}

/**
 * Small badge component for enum‑like values.
 */
function Pill(props: { children: React.ReactNode }) {
  return (
    <span className="inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-medium">
      {props.children}
    </span>
  );
}

/**
 * Admin view to inspect and edit organization profiles and preview their impact.
 *
 * Assumptions (to be matched by the API implementation):
 * - useOrgProfilesQuery() returns either:
 *   - the active OrgProfileSnapshot for the current organization, or
 *   - an array of OrgProfileSnapshot, where index 0 is the active one.
 * - useProfilePreviewMutation() accepts:
 *     { organizationId, currentProfileCode, proposedProfileCode }
 *   and returns { summary, impact_bullets }.
 * - useUpdateServiceConfigMutation() accepts:
 *     { module: "org_profiles", organizationId, profileCode }
 *   and persists the change with audit logging.
 */
export const OrgProfileSettingsPage: React.FC = () => {
  const { data, isLoading, isError, refetch } = useOrgProfilesQuery();

  const activeProfile: OrgProfileSnapshot | undefined = useMemo(() => {
    if (!data) return undefined;
    if (Array.isArray(data)) {
      return (data[0] ?? null) as OrgProfileSnapshot | null || undefined;
    }
    return data as OrgProfileSnapshot;
  }, [data]);

  const [selectedProfileCode, setSelectedProfileCode] = useState<OrgProfileCode | "">("");
  const [triggerPreview, { data: previewData, isLoading: isPreviewLoading }] =
    useProfilePreviewMutation();
  const [updateConfig, { isLoading: isSaving, isSuccess: isSaveSuccess, error: saveError }] =
    useUpdateServiceConfigMutation();

  const preview: ProfilePreviewDiff | undefined = previewData as ProfilePreviewDiff | undefined;

  useEffect(() => {
    if (activeProfile?.profile_code) {
      setSelectedProfileCode(activeProfile.profile_code as OrgProfileCode);
    }
  }, [activeProfile?.profile_code]);

  const organizationName =
    activeProfile?.organization_display_name ||
    activeProfile?.organization_slug ||
    "Current organization";

  const currentProfileOption = PROFILE_OPTIONS.find(
    (opt) => opt.code === activeProfile?.profile_code
  );
  const selectedProfileOption = PROFILE_OPTIONS.find((opt) => opt.code === selectedProfileCode);

  const hasChanges =
    !!activeProfile &&
    !!selectedProfileCode &&
    selectedProfileCode !== (activeProfile.profile_code as OrgProfileCode);

  const handlePreview = () => {
    if (!activeProfile || !hasChanges) return;
    triggerPreview({
      organizationId: activeProfile.organization_id,
      currentProfileCode: activeProfile.profile_code,
      proposedProfileCode: selectedProfileCode,
    });
  };

  const handleSave = () => {
    if (!activeProfile || !selectedProfileCode) return;
    updateConfig({
      module: "org_profiles",
      organizationId: activeProfile.organization_id,
      profileCode: selectedProfileCode,
    });
  };

  if (isLoading) {
    return (
      <div className="p-6">
        <h1 className="mb-4 text-2xl font-semibold">Organization profile</h1>
        <p className="text-sm text-gray-600">Loading profile…</p>
      </div>
    );
  }

  if (isError || !activeProfile) {
    return (
      <div className="p-6">
        <h1 className="mb-4 text-2xl font-semibold">Organization profile</h1>
        <div className="rounded-md border border-red-200 bg-red-50 p-4 text-sm text-red-800">
          <p className="mb-2">Could not load the organization profile.</p>
          <button
            type="button"
            onClick={() => refetch()}
            className="rounded border px-3 py-1 text-xs font-medium"
          >
            Retry
          </button>
        </div>
      </div>
    );
  }

  const p = activeProfile.profile;

  return (
    <div className="p-6">
      <header className="mb-6 space-y-2">
        <h1 className="text-2xl font-semibold">Organization profile</h1>
        <p className="max-w-2xl text-sm text-gray-600">
          Profiles control how quickly work escalates, who can see it, how long records are kept,
          and how sensitive pattern detection is for{" "}
          <span className="font-medium">{organizationName}</span>.
        </p>
      </header>

      <div className="grid gap-6 lg:grid-cols-3">
        {/* Current profile summary */}
        <section className="lg:col-span-2 space-y-4 rounded-lg border bg-white p-4">
          <div className="flex items-start justify-between gap-4">
            <div>
              <p className="text-xs font-medium uppercase text-gray-500">
                Active profile archetype
              </p>
              <div className="mt-1 flex items-center gap-2">
                <span className="text-lg font-semibold">
                  {currentProfileOption?.label || activeProfile.profile_code}
                </span>
                <Pill>{activeProfile.profile_code}</Pill>
                {typeof activeProfile.version === "number" && (
                  <span className="text-xs text-gray-500">v{activeProfile.version}</span>
                )}
              </div>
              {p.description && (
                <p className="mt-1 max-w-xl text-sm text-gray-600">{p.description}</p>
              )}
            </div>
          </div>

          <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Reactivity</p>
              <p className="mt-1 text-sm">
                First escalation in{" "}
                <span className="font-medium">{formatSeconds(p.reactivity_seconds)}</span>
              </p>
              <p className="text-xs text-gray-500">
                Max escalation: {formatSeconds(p.max_escalation_seconds)}
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Transparency</p>
              <p className="mt-1 text-sm">
                <Pill>{p.transparency_level || "—"}</Pill>
              </p>
              <p className="text-xs text-gray-500">
                Escalation granularity: {p.escalation_granularity || "—"}
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Reviews</p>
              <p className="mt-1 text-sm">
                <Pill>{p.review_frequency || "—"}</Pill>
              </p>
              <p className="text-xs text-gray-500">
                Notification scope: {p.notification_scope || "—"}
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Patterns</p>
              <p className="mt-1 text-sm">
                Sensitivity: <Pill>{p.pattern_sensitivity || "—"}</Pill>
              </p>
              <p className="text-xs text-gray-500">
                Window: {p.pattern_window_days ?? "—"} days, min events:{" "}
                {p.pattern_min_events ?? "—"}
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Logging & retention</p>
              <p className="mt-1 text-sm">
                Logging: <Pill>{p.logging_level || "—"}</Pill>
              </p>
              <p className="text-xs text-gray-500">
                Log retention: {p.log_retention_days != null ? `${p.log_retention_days} days` : "—"}
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Automation</p>
              <p className="mt-1 text-sm">
                Level: <Pill>{p.automation_level || "—"}</Pill>
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Default Task metadata</p>
              <p className="mt-1 text-sm">
                Visibility:{" "}
                <Pill>{p.default_task_metadata?.visibility?.toLowerCase() || "—"}</Pill>
              </p>
              <p className="text-xs text-gray-500">
                Priority: {p.default_task_metadata?.default_priority || "—"},{" "}
                reactivity:{" "}
                {formatSeconds(p.default_task_metadata?.default_reactivity_seconds ?? undefined)}
              </p>
            </div>

            <div>
              <p className="text-xs font-medium uppercase text-gray-500">Cyclic overview</p>
              <p className="mt-1 text-sm">
                {p.cyclic_overview?.enabled ? (
                  <Pill>enabled</Pill>
                ) : (
                  <Pill>disabled</Pill>
                )}
              </p>
              <p className="text-xs text-gray-500">
                Schedule:{" "}
                {[
                  p.cyclic_overview?.schedule?.weekly && "weekly",
                  p.cyclic_overview?.schedule?.monthly && "monthly",
                  p.cyclic_overview?.schedule?.yearly && "yearly",
                ]
                  .filter(Boolean)
                  .join(", ") || "—"}
              </p>
            </div>
          </div>
        </section>

        {/* Edit + preview column */}
        <section className="space-y-4 rounded-lg border bg-white p-4">
          <div>
            <p className="text-xs font-medium uppercase text-gray-500">Select profile archetype</p>
            <label className="mt-2 block text-sm">
              <span className="mb-1 block text-gray-700">Archetype</span>
              <select
                value={selectedProfileCode}
                onChange={(e) => setSelectedProfileCode(e.target.value as OrgProfileCode)}
                className="mt-1 block w-full rounded-md border px-3 py-2 text-sm"
              >
                {PROFILE_OPTIONS.map((option) => (
                  <option key={option.code} value={option.code}>
                    {option.label}
                  </option>
                ))}
              </select>
            </label>
            {selectedProfileOption && (
              <p className="mt-2 text-xs text-gray-500">{selectedProfileOption.description}</p>
            )}
          </div>

          <div className="flex flex-col gap-2 border-t pt-4 text-sm">
            <div className="flex flex-wrap items-center gap-2">
              <button
                type="button"
                onClick={handlePreview}
                disabled={!hasChanges || isPreviewLoading}
                className="rounded-md border px-3 py-1 text-xs font-medium disabled:opacity-60"
              >
                {isPreviewLoading ? "Previewing…" : "Preview impact"}
              </button>
              <button
                type="button"
                onClick={handleSave}
                disabled={!hasChanges || isSaving}
                className="rounded-md bg-black px-3 py-1 text-xs font-medium text-white disabled:opacity-60"
              >
                {isSaving ? "Saving…" : "Apply change"}
              </button>
            </div>

            {isSaveSuccess && (
              <p className="text-xs text-green-700">Profile updated. New defaults will apply to future Tasks and Cases.</p>
            )}
            {saveError && (
              <p className="text-xs text-red-700">
                Failed to save changes. Please try again or check configuration logs.
              </p>
            )}
          </div>

          <div className="border-t pt-4">
            <p className="mb-2 text-xs font-medium uppercase text-gray-500">Preview</p>
            {!preview && !isPreviewLoading && (
              <p className="text-xs text-gray-500">
                Choose a different profile and click &ldquo;Preview impact&rdquo; to see how escalation,
                visibility, retention and patterns would change.
              </p>
            )}

            {preview && (
              <div className="space-y-2 text-xs">
                {preview.summary && <p className="text-gray-700">{preview.summary}</p>}
                {preview.impact_bullets && preview.impact_bullets.length > 0 && (
                  <ul className="list-disc space-y-1 pl-4 text-gray-700">
                    {preview.impact_bullets.map((item, index) => (
                      <li key={index}>{item}</li>
                    ))}
                  </ul>
                )}
              </div>
            )}
          </div>
        </section>
      </div>
    </div>
  );
};

export default OrgProfileSettingsPage;

===== END apps/web/src/screens/admin/profiles/OrgProfileSettingsPage.tsx =====


===== BEGIN apps/web/src/screens/admin/tasks/AdminTaskOverviewPage.tsx =====
import { useMemo, useState, ChangeEvent } from "react";
import { useAdminTaskOverviewQuery } from "../../../store/services/orgoApi";

type TaskStatus =
  | "PENDING"
  | "IN_PROGRESS"
  | "ON_HOLD"
  | "COMPLETED"
  | "FAILED"
  | "ESCALATED"
  | "CANCELLED";

type TaskPriority = "LOW" | "MEDIUM" | "HIGH" | "CRITICAL";

type TaskSeverity = "MINOR" | "MODERATE" | "MAJOR" | "CRITICAL";

type TaskCategory = "request" | "incident" | "update" | "report" | "distribution";

type FilterStatusOption = TaskStatus | "ALL";
type FilterPriorityOption = TaskPriority | "ALL";
type FilterSeverityOption = TaskSeverity | "ALL";
type FilterCategoryOption = TaskCategory | "ALL";

interface AdminTaskOverviewFilters {
  status: FilterStatusOption;
  priority: FilterPriorityOption;
  severity: FilterSeverityOption;
  category: FilterCategoryOption;
  type: string; // domain type, e.g. "maintenance", "hr_case"
  role: string; // assignee/owner role label
  labelSearch: string; // free‑text search over label/title
}

interface AdminTaskOverviewTask {
  task_id: string;
  organization_id: string;
  case_id: string | null;
  source: "email" | "api" | "manual" | "sync";
  type: string;
  category: TaskCategory;
  label: string;
  title: string;
  status: TaskStatus;
  priority: TaskPriority;
  severity: TaskSeverity;
  visibility: "PUBLIC" | "INTERNAL" | "RESTRICTED" | "ANONYMISED";
  assignee_role: string | null;
  owner_role_id: string | null;
  owner_user_id: string | null;
  reactivity_deadline_at: string | null;
  created_at: string;
}

interface AdminTaskOverviewResponse {
  tasks: AdminTaskOverviewTask[];
  total: number;
  page: number;
  pageSize: number;
}

/**
 * Query args passed to useAdminTaskOverviewQuery.
 * The orgoApi slice should accept this shape and translate it
 * to the backend /api/v3/tasks admin listing with filters.
 */
interface AdminTaskOverviewQueryArgs {
  page: number;
  pageSize: number;
  status?: TaskStatus;
  priority?: TaskPriority;
  severity?: TaskSeverity;
  category?: TaskCategory;
  type?: string;
  role?: string;
  labelSearch?: string;
}

const DEFAULT_PAGE_SIZE = 25;

const STATUS_OPTIONS: FilterStatusOption[] = [
  "ALL",
  "PENDING",
  "IN_PROGRESS",
  "ON_HOLD",
  "ESCALATED",
  "COMPLETED",
  "FAILED",
  "CANCELLED",
];

const PRIORITY_OPTIONS: FilterPriorityOption[] = ["ALL", "LOW", "MEDIUM", "HIGH", "CRITICAL"];

const SEVERITY_OPTIONS: FilterSeverityOption[] = ["ALL", "MINOR", "MODERATE", "MAJOR", "CRITICAL"];

const CATEGORY_OPTIONS: FilterCategoryOption[] = [
  "ALL",
  "request",
  "incident",
  "update",
  "report",
  "distribution",
];

function getStatusBadgeClasses(status: TaskStatus): string {
  switch (status) {
    case "PENDING":
      return "bg-gray-100 text-gray-800";
    case "IN_PROGRESS":
      return "bg-blue-100 text-blue-800";
    case "ON_HOLD":
      return "bg-yellow-100 text-yellow-800";
    case "ESCALATED":
      return "bg-red-100 text-red-800 border border-red-300";
    case "COMPLETED":
      return "bg-green-100 text-green-800";
    case "FAILED":
      return "bg-red-100 text-red-800";
    case "CANCELLED":
      return "bg-gray-200 text-gray-700";
    default:
      return "bg-gray-100 text-gray-800";
  }
}

function getPriorityBadgeClasses(priority: TaskPriority): string {
  switch (priority) {
    case "LOW":
      return "bg-gray-100 text-gray-800";
    case "MEDIUM":
      return "bg-sky-100 text-sky-800";
    case "HIGH":
      return "bg-orange-100 text-orange-800";
    case "CRITICAL":
      return "bg-red-100 text-red-800";
    default:
      return "bg-gray-100 text-gray-800";
  }
}

function getSeverityBadgeClasses(severity: TaskSeverity): string {
  switch (severity) {
    case "MINOR":
      return "bg-gray-100 text-gray-800";
    case "MODERATE":
      return "bg-amber-100 text-amber-800";
    case "MAJOR":
      return "bg-orange-100 text-orange-800";
    case "CRITICAL":
      return "bg-red-100 text-red-800";
    default:
      return "bg-gray-100 text-gray-800";
  }
}

function isUnresolvedStatus(status: TaskStatus): boolean {
  return ["PENDING", "IN_PROGRESS", "ON_HOLD", "ESCALATED"].includes(status);
}

function isOverdue(task: AdminTaskOverviewTask): boolean {
  if (!task.reactivity_deadline_at) return false;
  if (!isUnresolvedStatus(task.status)) return false;
  const deadline = new Date(task.reactivity_deadline_at).getTime();
  if (Number.isNaN(deadline)) return false;
  return Date.now() > deadline;
}

function formatDate(value: string | null | undefined): string {
  if (!value) return "—";
  const d = new Date(value);
  if (Number.isNaN(d.getTime())) return "—";
  return d.toLocaleString();
}

function truncateLabel(label: string, max = 40): string {
  if (label.length <= max) return label;
  return `${label.slice(0, max - 1)}…`;
}

const AdminTaskOverviewPage = () => {
  const [filters, setFilters] = useState<AdminTaskOverviewFilters>({
    status: "ALL",
    priority: "ALL",
    severity: "ALL",
    category: "ALL",
    type: "",
    role: "",
    labelSearch: "",
  });

  const [page, setPage] = useState(1);

  const queryArgs: AdminTaskOverviewQueryArgs = useMemo(() => {
    const args: AdminTaskOverviewQueryArgs = {
      page,
      pageSize: DEFAULT_PAGE_SIZE,
    };

    if (filters.status !== "ALL") {
      args.status = filters.status;
    }

    if (filters.priority !== "ALL") {
      args.priority = filters.priority;
    }

    if (filters.severity !== "ALL") {
      args.severity = filters.severity;
    }

    if (filters.category !== "ALL") {
      args.category = filters.category;
    }

    if (filters.type.trim()) {
      args.type = filters.type.trim();
    }

    if (filters.role.trim()) {
      args.role = filters.role.trim();
    }

    if (filters.labelSearch.trim()) {
      args.labelSearch = filters.labelSearch.trim();
    }

    return args;
  }, [filters, page]);

  // Cast to the expected response type for local usage; the orgoApi slice
  // should be implemented so that this cast matches the real response.
  const {
    data,
    isLoading,
    isError,
    refetch,
    isFetching,
  } = useAdminTaskOverviewQuery(queryArgs) as {
    data?: AdminTaskOverviewResponse;
    isLoading: boolean;
    isError: boolean;
    isFetching: boolean;
    refetch: () => void;
  };

  const tasks = data?.tasks ?? [];
  const total = data?.total ?? 0;
  const pageSize = data?.pageSize ?? DEFAULT_PAGE_SIZE;
  const totalPages = total > 0 ? Math.max(1, Math.ceil(total / pageSize)) : 1;

  const { openCount, overdueCount } = useMemo(() => {
    let open = 0;
    let overdue = 0;
    for (const t of tasks) {
      if (isUnresolvedStatus(t.status)) {
        open += 1;
        if (isOverdue(t)) {
          overdue += 1;
        }
      }
    }
    return { openCount: open, overdueCount: overdue };
  }, [tasks]);

  const handleSelectChange =
    <K extends keyof AdminTaskOverviewFilters>(key: K) =>
    (event: ChangeEvent<HTMLSelectElement>) => {
      const value = event.target.value as AdminTaskOverviewFilters[K];
      setPage(1);
      setFilters((prev) => ({
        ...prev,
        [key]: value,
      }));
    };

  const handleInputChange =
    <K extends keyof AdminTaskOverviewFilters>(key: K) =>
    (event: ChangeEvent<HTMLInputElement>) => {
      const value = event.target.value as AdminTaskOverviewFilters[K];
      setPage(1);
      setFilters((prev) => ({
        ...prev,
        [key]: value,
      }));
    };

  const canGoPrev = page > 1;
  const canGoNext = page < totalPages;

  return (
    <div className="min-h-screen bg-gray-50 px-4 py-6 sm:px-6 lg:px-8">
      <div className="mb-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h1 className="text-2xl font-semibold text-gray-900">Admin Task Overview</h1>
          <p className="mt-1 text-sm text-gray-600">
            Cross-domain task queues with filters by status, domain type, label, role, priority, and
            severity.
          </p>
        </div>
        <button
          type="button"
          onClick={() => refetch()}
          className="inline-flex items-center justify-center rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50"
        >
          {isFetching ? "Refreshing…" : "Refresh"}
        </button>
      </div>

      <div className="mb-4 grid gap-3 md:grid-cols-3 lg:grid-cols-6">
        <div className="flex flex-col">
          <label className="mb-1 text-xs font-medium text-gray-700" htmlFor="status">
            Status
          </label>
          <select
            id="status"
            className="block w-full rounded-md border border-gray-300 bg-white px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            value={filters.status}
            onChange={handleSelectChange("status")}
          >
            {STATUS_OPTIONS.map((option) => (
              <option key={option} value={option}>
                {option === "ALL" ? "All statuses" : option.replace("_", " ")}
              </option>
            ))}
          </select>
        </div>

        <div className="flex flex-col">
          <label className="mb-1 text-xs font-medium text-gray-700" htmlFor="priority">
            Priority
          </label>
          <select
            id="priority"
            className="block w-full rounded-md border border-gray-300 bg-white px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            value={filters.priority}
            onChange={handleSelectChange("priority")}
          >
            {PRIORITY_OPTIONS.map((option) => (
              <option key={option} value={option}>
                {option === "ALL" ? "All priorities" : option}
              </option>
            ))}
          </select>
        </div>

        <div className="flex flex-col">
          <label className="mb-1 text-xs font-medium text-gray-700" htmlFor="severity">
            Severity
          </label>
          <select
            id="severity"
            className="block w-full rounded-md border border-gray-300 bg-white px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            value={filters.severity}
            onChange={handleSelectChange("severity")}
          >
            {SEVERITY_OPTIONS.map((option) => (
              <option key={option} value={option}>
                {option === "ALL" ? "All severities" : option}
              </option>
            ))}
          </select>
        </div>

        <div className="flex flex-col">
          <label className="mb-1 text-xs font-medium text-gray-700" htmlFor="category">
            Category
          </label>
          <select
            id="category"
            className="block w-full rounded-md border border-gray-300 bg-white px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            value={filters.category}
            onChange={handleSelectChange("category")}
          >
            {CATEGORY_OPTIONS.map((option) => (
              <option key={option} value={option}>
                {option === "ALL"
                  ? "All categories"
                  : option.charAt(0).toUpperCase() + option.slice(1)}
              </option>
            ))}
          </select>
        </div>

        <div className="flex flex-col">
          <label className="mb-1 text-xs font-medium text-gray-700" htmlFor="type">
            Domain type
          </label>
          <input
            id="type"
            type="text"
            placeholder="e.g. maintenance, hr_case"
            className="block w-full rounded-md border border-gray-300 bg-white px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            value={filters.type}
            onChange={handleInputChange("type")}
          />
        </div>

        <div className="flex flex-col">
          <label className="mb-1 text-xs font-medium text-gray-700" htmlFor="role">
            Role or label search
          </label>
          <input
            id="role"
            type="text"
            placeholder="role or label fragment"
            className="block w-full rounded-md border border-gray-300 bg-white px-2 py-1.5 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            value={filters.labelSearch}
            onChange={handleInputChange("labelSearch")}
          />
        </div>
      </div>

      <div className="mb-4 flex flex-wrap items-center gap-3 text-sm text-gray-700">
        <span>
          <span className="font-medium">{total}</span> tasks
        </span>
        <span className="hidden text-gray-400 sm:inline">•</span>
        <span>
          <span className="font-medium">{openCount}</span> unresolved
        </span>
        <span className="hidden text-gray-400 sm:inline">•</span>
        <span>
          <span className="font-medium">{overdueCount}</span> overdue by reactivity deadline
        </span>
        {isLoading && <span className="ml-auto text-xs text-gray-500">Loading…</span>}
        {isError && !isLoading && (
          <span className="ml-auto text-xs text-red-600">
            Error loading tasks. Try adjusting filters or refreshing.
          </span>
        )}
      </div>

      <div className="overflow-x-auto rounded-lg border border-gray-200 bg-white shadow-sm">
        <table className="min-w-full divide-y divide-gray-200 text-left text-sm">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-4 py-3 font-medium text-gray-700">Status</th>
              <th className="px-4 py-3 font-medium text-gray-700">Priority</th>
              <th className="px-4 py-3 font-medium text-gray-700">Severity</th>
              <th className="px-4 py-3 font-medium text-gray-700">Title</th>
              <th className="px-4 py-3 font-medium text-gray-700">Type / Category</th>
              <th className="px-4 py-3 font-medium text-gray-700">Label</th>
              <th className="px-4 py-3 font-medium text-gray-700">Assignee role</th>
              <th className="px-4 py-3 font-medium text-gray-700">React. deadline</th>
              <th className="px-4 py-3 font-medium text-gray-700">Created</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-100 bg-white">
            {isLoading && tasks.length === 0 ? (
              <tr>
                <td className="px-4 py-6 text-center text-sm text-gray-500" colSpan={9}>
                  Loading tasks…
                </td>
              </tr>
            ) : tasks.length === 0 ? (
              <tr>
                <td className="px-4 py-6 text-center text-sm text-gray-500" colSpan={9}>
                  No tasks match the current filters.
                </td>
              </tr>
            ) : (
              tasks.map((task) => {
                const overdue = isOverdue(task);
                return (
                  <tr key={task.task_id} className={overdue ? "bg-red-50" : undefined}>
                    <td className="whitespace-nowrap px-4 py-3">
                      <span
                        className={`inline-flex rounded-full px-2.5 py-0.5 text-xs font-medium ${getStatusBadgeClasses(
                          task.status
                        )}`}
                      >
                        {task.status.replace("_", " ")}
                      </span>
                    </td>
                    <td className="whitespace-nowrap px-4 py-3">
                      <span
                        className={`inline-flex rounded-full px-2.5 py-0.5 text-xs font-medium ${getPriorityBadgeClasses(
                          task.priority
                        )}`}
                      >
                        {task.priority}
                      </span>
                    </td>
                    <td className="whitespace-nowrap px-4 py-3">
                      <span
                        className={`inline-flex rounded-full px-2.5 py-0.5 text-xs font-medium ${getSeverityBadgeClasses(
                          task.severity
                        )}`}
                      >
                        {task.severity}
                      </span>
                    </td>
                    <td className="max-w-xs px-4 py-3">
                      <div className="truncate text-sm text-gray-900">{task.title}</div>
                    </td>
                    <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-700">
                      <div className="flex flex-col">
                        <span className="font-medium">{task.type}</span>
                        <span className="text-xs text-gray-500">{task.category}</span>
                      </div>
                    </td>
                    <td className="max-w-xs px-4 py-3 text-sm text-gray-700">
                      <span title={task.label} className="block truncate">
                        {truncateLabel(task.label)}
                      </span>
                    </td>
                    <td className="max-w-xs px-4 py-3 text-sm text-gray-700">
                      {task.assignee_role ? (
                        <span className="block truncate">{task.assignee_role}</span>
                      ) : (
                        <span className="text-gray-400">Unassigned</span>
                      )}
                    </td>
                    <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-700">
                      <div className="flex flex-col">
                        <span>{formatDate(task.reactivity_deadline_at)}</span>
                        {overdue && (
                          <span className="text-xs font-medium text-red-600">Overdue</span>
                        )}
                      </div>
                    </td>
                    <td className="whitespace-nowrap px-4 py-3 text-sm text-gray-700">
                      {formatDate(task.created_at)}
                    </td>
                  </tr>
                );
              })
            )}
          </tbody>
        </table>
      </div>

      <div className="mt-4 flex flex-col items-center justify-between gap-3 text-sm text-gray-700 sm:flex-row">
        <div>
          Page{" "}
          <span className="font-medium">
            {Math.min(page, totalPages)} / {totalPages}
          </span>
          {total > 0 && (
            <span className="ml-2 text-gray-500">
              • Showing {(page - 1) * pageSize + 1}–
              {Math.min(page * pageSize, total)} of {total}
            </span>
          )}
        </div>
        <div className="inline-flex items-center gap-2">
          <button
            type="button"
            disabled={!canGoPrev}
            onClick={() => canGoPrev && setPage((p) => p - 1)}
            className="inline-flex items-center rounded-md border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:cursor-not-allowed disabled:bg-gray-100 disabled:text-gray-400"
          >
            Previous
          </button>
          <button
            type="button"
            disabled={!canGoNext}
            onClick={() => canGoNext && setPage((p) => p + 1)}
            className="inline-flex items-center rounded-md border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:cursor-not-allowed disabled:bg-gray-100 disabled:text-gray-400"
          >
            Next
          </button>
        </div>
      </div>
    </div>
  );
};

export default AdminTaskOverviewPage;

===== END apps/web/src/screens/admin/tasks/AdminTaskOverviewPage.tsx =====


===== BEGIN apps/web/src/screens/auth/login/login.test.tsx =====
import { render } from "@testing-library/react";
import { LoginScreen } from "./login";

test("render login component", () => {
  render(<LoginScreen />);
});

===== END apps/web/src/screens/auth/login/login.test.tsx =====


===== BEGIN apps/web/src/screens/auth/login/login.tsx =====
import { Button } from "ui";

export function LoginScreen() {
  return (
    <div>
      Login Screen <Button />
    </div>
  );
}

===== END apps/web/src/screens/auth/login/login.tsx =====


===== BEGIN apps/web/src/screens/common/.gitkeep =====

===== END apps/web/src/screens/common/.gitkeep =====


===== BEGIN apps/web/src/screens/employee/.gitkeep =====

===== END apps/web/src/screens/employee/.gitkeep =====


===== BEGIN apps/web/src/screens/insights/InsightsOverviewPage.tsx =====

===== END apps/web/src/screens/insights/InsightsOverviewPage.tsx =====


===== BEGIN apps/web/src/store/index.ts =====
import { configureStore } from "@reduxjs/toolkit";
import { TypedUseSelectorHook, useDispatch, useSelector } from "react-redux";

import { api } from "./services/api";

export function makeStore() {
  return configureStore({
    reducer: {
      [api.reducerPath]: api.reducer,
    },

    middleware: (getDefaultMiddleware) =>
      getDefaultMiddleware().concat(api.middleware),
  });
}

const store = makeStore();

export type RootState = ReturnType<typeof store.getState>;

export type AppDispatch = typeof store.dispatch;

export const useAppDispatch = () => useDispatch<AppDispatch>();

export const useAppSelector: TypedUseSelectorHook<RootState> = useSelector;

export default store;

===== END apps/web/src/store/index.ts =====


===== BEGIN apps/web/src/store/services/api.ts =====
import { createApi, fetchBaseQuery } from "@reduxjs/toolkit/query/react";

export const api = createApi({
  reducerPath: "baseApi",
  baseQuery: fetchBaseQuery({
    baseUrl: "api",
  }),
  tagTypes: [],
  endpoints: (builder) => ({
    hello: builder.query<{ message: string }, void>({
      query: () => ({
        url: "/",
      }),
    }),
  }),
});

export const { useHelloQuery } = api;

===== END apps/web/src/store/services/api.ts =====


===== BEGIN apps/web/src/store/services/orgoApi.ts =====
import { api } from "./api";

/**
 * Canonical enums & core types mirrored from Orgo docs (Docs 2 & 8).
 */

export type TaskStatus =
  | "PENDING"
  | "IN_PROGRESS"
  | "ON_HOLD"
  | "COMPLETED"
  | "FAILED"
  | "ESCALATED"
  | "CANCELLED";

export type TaskPriority = "LOW" | "MEDIUM" | "HIGH" | "CRITICAL";

export type TaskSeverity = "MINOR" | "MODERATE" | "MAJOR" | "CRITICAL";

export type TaskCategory =
  | "request"
  | "incident"
  | "update"
  | "report"
  | "distribution";

export type Visibility = "PUBLIC" | "INTERNAL" | "RESTRICTED" | "ANONYMISED";

export type TaskSource = "email" | "api" | "manual" | "sync";

export type CaseStatus = "open" | "in_progress" | "resolved" | "archived";

export type CaseSeverity = "minor" | "moderate" | "major" | "critical";

/**
 * Generic helper types.
 */

export interface PaginatedResult<T> {
  items: T[];
  total: number;
  page: number;
  pageSize: number;
}

export interface StandardResponse<T> {
  ok: boolean;
  data: T | null;
  error: {
    code: string;
    message: string;
    details?: Record<string, unknown>;
  } | null;
}

/**
 * Canonical Task JSON shape (aligned with Doc 8 §8.4.2).
 */
export interface OrgoTask {
  task_id: string;
  organization_id: string;
  case_id?: string | null;

  source: TaskSource;
  type: string;
  category: TaskCategory;
  subtype?: string | null;

  label: string;
  title: string;
  description: string;

  status: TaskStatus;
  priority: TaskPriority;
  severity: TaskSeverity;

  visibility: Visibility;

  assignee_role?: string | null;
  created_by_user_id?: string | null;
  requester_person_id?: string | null;
  owner_role_id?: string | null;
  owner_user_id?: string | null;

  due_at?: string | null;
  reactivity_time?: string | null;
  reactivity_deadline_at?: string | null;
  escalation_level: number;
  closed_at?: string | null;

  metadata: Record<string, unknown>;

  created_at: string;
  updated_at: string;
}

/**
 * Canonical Case JSON shape (aligned with Doc 8 §8.4.1).
 */
export interface OrgoCase {
  case_id: string;
  organization_id: string;

  source_type: TaskSource;
  source_reference?: string | null;

  label: string;
  title: string;
  description: string;

  status: CaseStatus;
  severity: CaseSeverity;

  reactivity_time?: string | null;

  origin_vertical_level?: number | null;
  origin_role?: string | null;

  tags?: string[] | null;
  location?: Record<string, unknown> | null;
  metadata: Record<string, unknown>;

  created_at: string;
  updated_at: string;
}

/**
 * DTOs for list endpoints.
 */

export interface ListTasksParams {
  page?: number;
  pageSize?: number;
  status?: TaskStatus;
  type?: string;
  category?: TaskCategory;
  label?: string;
  severity?: TaskSeverity;
  assigneeRole?: string;
  ownerUserId?: string;
  search?: string;
}

export interface ListCasesParams {
  page?: number;
  pageSize?: number;
  status?: CaseStatus;
  label?: string;
  severity?: CaseSeverity;
  search?: string;
}

/**
 * DTOs for create/update payloads.
 */

export interface CreateTaskInput {
  organization_id: string;
  type: string;
  category: TaskCategory;
  title: string;
  description: string;
  priority: TaskPriority;
  severity: TaskSeverity;
  visibility: Visibility;
  label: string;
  source: TaskSource;
  subtype?: string | null;
  case_id?: string | null;
  due_at?: string | null;
  metadata?: Record<string, unknown>;
}

export interface UpdateTaskStatusInput {
  taskId: string;
  status: TaskStatus;
  reason?: string;
}

export interface CreateCaseInput {
  organization_id: string;
  source_type: TaskSource;
  label: string;
  title: string;
  description: string;
  severity: CaseSeverity;
  reactivity_time?: string | null;
  origin_vertical_level?: number | null;
  origin_role?: string | null;
  tags?: string[];
  location?: Record<string, unknown>;
  metadata?: Record<string, unknown>;
}

/**
 * Workflow DTOs (aligned with Doc 5/Doc 4 naming).
 */

export interface WorkflowExecutionContext {
  organization_id: string;
  task_id?: string;
  case_id?: string;
  email_message_id?: string;
  [key: string]: unknown;
}

export interface ExecuteWorkflowInput {
  workflowId: string;
  context: WorkflowExecutionContext;
}

export interface WorkflowAction {
  type: string;
  [key: string]: unknown;
}

export interface WorkflowExecutionResult {
  workflowId: string;
  actions: WorkflowAction[];
}

/**
 * Helper to unwrap the standard { ok / data / error } envelope
 * if the backend chooses to use it. If not, it just returns the payload.
 */
function unwrapStandardResponse<T>(
  response: T | StandardResponse<T>,
): T {
  if (
    response &&
    typeof response === "object" &&
    "ok" in response &&
    "data" in response
  ) {
    const standard = response as StandardResponse<T>;
    if (!standard.ok) {
      const error = new Error(
        standard.error?.message ?? "Request failed",
      );
      // Optionally attach code/details if needed later
      throw error;
    }
    return (standard.data ?? (null as unknown as T)) as T;
  }

  return response as T;
}

/**
 * Extend the base API slice with Orgo-specific tag types.
 */
const baseOrgoApi = api.enhanceEndpoints({
  addTagTypes: ["Task", "Case", "Workflow"] as const,
});

/**
 * Orgo API slice – all Orgo v3 RTK Query endpoints live here.
 *
 * Base URL comes from ./api.ts (`baseUrl: "api"`), so all URLs here
 * are relative to `/api`, e.g. `/v3/tasks` → `/api/v3/tasks`.
 */
export const orgoApi = baseOrgoApi.injectEndpoints({
  overrideExisting: false,
  endpoints: (build) => ({
    /**
     * GET /api/v3/tasks
     * Returns a paginated list of Tasks.
     */
    tasks: build.query<
      PaginatedResult<OrgoTask>,
      ListTasksParams | void
    >({
      query: (params) => ({
        url: "/v3/tasks",
        params,
      }),
      transformResponse: (
        response: PaginatedResult<OrgoTask> | StandardResponse<PaginatedResult<OrgoTask>>,
      ) => unwrapStandardResponse(response),
      providesTags: (result) =>
        result
          ? [
              ...result.items.map((task) => ({
                type: "Task" as const,
                id: task.task_id,
              })),
              { type: "Task" as const, id: "LIST" },
            ]
          : [{ type: "Task" as const, id: "LIST" }],
    }),

    /**
     * GET /api/v3/tasks/:id
     * Returns a single Task.
     */
    taskDetails: build.query<OrgoTask, string>({
      query: (taskId) => ({
        url: `/v3/tasks/${encodeURIComponent(taskId)}`,
      }),
      transformResponse: (
        response: OrgoTask | StandardResponse<OrgoTask>,
      ) => unwrapStandardResponse(response),
      providesTags: (_result, _error, taskId) => [
        { type: "Task" as const, id: taskId },
      ],
    }),

    /**
     * POST /api/v3/tasks
     * Creates a new Task.
     */
    createTask: build.mutation<OrgoTask, CreateTaskInput>({
      query: (body) => ({
        url: "/v3/tasks",
        method: "POST",
        body,
      }),
      transformResponse: (
        response: OrgoTask | StandardResponse<OrgoTask>,
      ) => unwrapStandardResponse(response),
      invalidatesTags: [{ type: "Task" as const, id: "LIST" }],
    }),

    /**
     * PATCH /api/v3/tasks/:id/status
     * Updates only the Task status (canonical state machine).
     */
    updateTaskStatus: build.mutation<OrgoTask, UpdateTaskStatusInput>({
      query: ({ taskId, status, reason }) => ({
        url: `/v3/tasks/${encodeURIComponent(taskId)}/status`,
        method: "PATCH",
        body: { status, reason },
      }),
      transformResponse: (
        response: OrgoTask | StandardResponse<OrgoTask>,
      ) => unwrapStandardResponse(response),
      invalidatesTags: (_result, _error, { taskId }) => [
        { type: "Task" as const, id: taskId },
        { type: "Task" as const, id: "LIST" },
      ],
    }),

    /**
     * GET /api/v3/cases
     * Returns a paginated list of Cases.
     */
    cases: build.query<
      PaginatedResult<OrgoCase>,
      ListCasesParams | void
    >({
      query: (params) => ({
        url: "/v3/cases",
        params,
      }),
      transformResponse: (
        response: PaginatedResult<OrgoCase> | StandardResponse<PaginatedResult<OrgoCase>>,
      ) => unwrapStandardResponse(response),
      providesTags: (result) =>
        result
          ? [
              ...result.items.map((caze) => ({
                type: "Case" as const,
                id: caze.case_id,
              })),
              { type: "Case" as const, id: "LIST" },
            ]
          : [{ type: "Case" as const, id: "LIST" }],
    }),

    /**
     * GET /api/v3/cases/:id
     * Returns a single Case.
     */
    caseDetails: build.query<OrgoCase, string>({
      query: (caseId) => ({
        url: `/v3/cases/${encodeURIComponent(caseId)}`,
      }),
      transformResponse: (
        response: OrgoCase | StandardResponse<OrgoCase>,
      ) => unwrapStandardResponse(response),
      providesTags: (_result, _error, caseId) => [
        { type: "Case" as const, id: caseId },
      ],
    }),

    /**
     * POST /api/v3/cases
     * Creates a new Case.
     */
    createCase: build.mutation<OrgoCase, CreateCaseInput>({
      query: (body) => ({
        url: "/v3/cases",
        method: "POST",
        body,
      }),
      transformResponse: (
        response: OrgoCase | StandardResponse<OrgoCase>,
      ) => unwrapStandardResponse(response),
      invalidatesTags: [{ type: "Case" as const, id: "LIST" }],
    }),

    /**
     * POST /api/v3/workflows/:id/execute
     * Triggers workflow execution for a given context.
     */
    executeWorkflow: build.mutation<
      WorkflowExecutionResult,
      ExecuteWorkflowInput
    >({
      query: ({ workflowId, context }) => ({
        url: `/v3/workflows/${encodeURIComponent(workflowId)}/execute`,
        method: "POST",
        body: { context },
      }),
      transformResponse: (
        response:
          | WorkflowExecutionResult
          | StandardResponse<WorkflowExecutionResult>,
      ) => unwrapStandardResponse(response),
      invalidatesTags: (_result, _error, { context }) => {
        const tags: { type: "Task" | "Case" | "Workflow"; id: string }[] =
          [];

        if (context.task_id) {
          tags.push({ type: "Task", id: context.task_id });
        }
        if (context.case_id) {
          tags.push({ type: "Case", id: context.case_id });
        }

        return [
          ...tags,
          { type: "Workflow" as const, id: "LIST" },
        ];
      },
    }),

    /**
     * POST /api/v3/workflows/:id/simulate
     * Simulates workflow execution without side-effects.
     */
    workflowSimulation: build.mutation<
      WorkflowExecutionResult,
      ExecuteWorkflowInput
    >({
      query: ({ workflowId, context }) => ({
        url: `/v3/workflows/${encodeURIComponent(workflowId)}/simulate`,
        method: "POST",
        body: { context },
      }),
      transformResponse: (
        response:
          | WorkflowExecutionResult
          | StandardResponse<WorkflowExecutionResult>,
      ) => unwrapStandardResponse(response),
    }),
  }),
});

/**
 * Export typed hooks (names follow Doc 4 conventions).
 */
export const {
  useTasksQuery,
  useTaskDetailsQuery,
  useCreateTaskMutation,
  useUpdateTaskStatusMutation,
  useCasesQuery,
  useCaseDetailsQuery,
  useCreateCaseMutation,
  useExecuteWorkflowMutation,
  useWorkflowSimulationMutation,
} = orgoApi;

export default orgoApi;

===== END apps/web/src/store/services/orgoApi.ts =====


===== BEGIN apps/web/src/styles/global.css =====
@tailwind base;
@tailwind components;
@tailwind utilities;

===== END apps/web/src/styles/global.css =====


===== BEGIN apps/web/tailwind.config.js =====
module.exports = require("config/tailwind.config");

===== END apps/web/tailwind.config.js =====


===== BEGIN apps/web/tsconfig.json =====
{
  "extends": "tsconfig/nextjs.json",
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", "jest.setup.js"],
  "exclude": ["node_modules"]
}

===== END apps/web/tsconfig.json =====


===== BEGIN concat_orgo.py =====
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
concat_orgo.py

Concatène tous les fichiers texte/code du repo Orgo en un seul .txt, avec :
  - TOC en tête (liste de tous les fichiers inclus, en chemin absolu)
  - Blocs par fichier, encadrés par:
        ===== BEGIN chemin/relatif =====
        ... contenu ...
        ===== END chemin/relatif =====

Règles par défaut :
  - Racine = dossier contenant ce script (mettez-le à la racine de C:\MyCode\Orgo)
  - Exclut automatiquement les répertoires :
        .git, .github, Documentation,
        node_modules, .next, dist, build, out, coverage, .cache, .venv, venv, __pycache__, target, bin, obj
  - Ignore les fichiers manifestement binaires
  - Respecte une taille max par fichier (par défaut 2 Mo)
  - N’écrase pas le fichier de sortie

Usage typique (depuis C:\MyCode\Orgo) :
  python concat_orgo.py
    -> crée Code_Orgo_<timestamp>.txt

Options utiles :
  python concat_orgo.py --out MyOrgoDump.txt
  python concat_orgo.py --include "apps/api/**" --include "apps/web/**"
  python concat_orgo.py --exclude "packages/ui/**"
"""

from __future__ import annotations
import argparse
import fnmatch
import os
from pathlib import Path
from typing import Set, List, Optional
from datetime import datetime

# ====== Extensions et noms pris en charge ======
DEFAULT_EXTS: Set[str] = {
    ".txt", ".tx", ".md", ".markdown",
    ".json", ".yaml", ".yml", ".xml", ".toml", ".ini", ".cfg", ".conf", ".properties",
    ".html", ".htm", ".css", ".scss", ".less",
    ".js", ".jsx", ".ts", ".tsx", ".mjs", ".cjs",
    ".py", ".pyi",
    ".java", ".kt", ".swift", ".rb", ".php", ".go", ".rs",
    ".c", ".h", ".cpp", ".cc", ".hpp", ".cs",
    ".sql",
    ".sh", ".bash", ".zsh", ".fish", ".ps1", ".bat",
    ".graphql", ".gql",
    ".gradle",
    ".pl", ".lua", ".r",
    ".env",
    ".svg",
    ".ndjson",
}
NAMES_WITHOUT_EXT: Set[str] = {
    "Dockerfile", "Makefile", "CMakeLists.txt",
    ".gitignore", ".gitattributes", ".editorconfig",
    ".all-contributorsrc", ".prettierignore", ".releaserc", "LICENSE",
    "package.json", "package-lock.json", "yarn.lock", "pnpm-lock.yaml",
    "tsconfig.json", "eslint.config.js", "eslint.config.mjs", ".eslintrc",
    ".prettierrc", "prettier.config.js", "postcss.config.js",
    "routes.json",
}

# ====== Exclusions ======
DEFAULT_EXCLUDE_DIRS: Set[str] = {
    # VCS / infra
    ".git", ".github", ".hg", ".svn",
    # Builds / caches
    "node_modules", ".next",
    "dist", "build", "out", "coverage", ".cache",
    ".venv", "venv", "__pycache__",
    "target", "bin", "obj",
    # Orgo-specific
    "Documentation",
}

BINARY_EXTS: Set[str] = {
    ".zip", ".gz", ".bz2", ".xz", ".7z", ".rar",
    ".png", ".jpg", ".jpeg", ".webp", ".ico", ".gif", ".pdf", ".ttf", ".woff", ".woff2"
}

# On évite de ré-intégrer des sorties précédentes
OUT_EXCLUDES: List[str] = [
    "Code_*.txt",
]

# ====== CLI ======
def parse_args() -> argparse.Namespace:
    p = argparse.ArgumentParser(
        description="Concatène les fichiers texte/code du repo Orgo en un seul fichier texte structuré."
    )
    p.add_argument(
        "-o", "--out", default=None,
        help="Nom du fichier de sortie (par défaut: Code_<nom-dossier>_<timestamp>.txt)"
    )
    p.add_argument(
        "--ext",
        help="Extensions additionnelles ou personnalisées, CSV (par ex: js,ts,tsx,md)"
    )
    p.add_argument(
        "--include", action="append", default=[],
        help="Glob d'inclusion relatif (répétable). Si fourni, seul ce qui matche est pris."
    )
    p.add_argument(
        "--exclude", action="append", default=[],
        help="Glob d'exclusion relatif (répétable) en plus des exclusions par défaut."
    )
    p.add_argument(
        "--max-size", type=int, default=2_000_000,
        help="Taille max par fichier en octets (défaut: 2_000_000)."
    )
    p.add_argument(
        "--no-headers", action="store_true",
        help="Supprime les en-têtes BEGIN/END par fichier (seule la TOC reste)."
    )
    return p.parse_args()

def normalize_exts(exts_csv: Optional[str]) -> Set[str]:
    if not exts_csv:
        return set(DEFAULT_EXTS)
    parts = [e.strip().lower() for e in exts_csv.split(",") if e.strip()]
    out = set()
    for e in parts:
        if not e.startswith("."):
            e = "." + e
        out.add(e)
    return out

# ====== Heuristiques texte ======
def is_probably_text(sample: bytes) -> bool:
    if not sample:
        return True
    if b"\x00" in sample:
        return False
    try:
        sample.decode("utf-8")
        return True
    except UnicodeDecodeError:
        pass
    ctrl = sum(1 for b in sample if b < 32 and b not in (9, 10, 13))
    return (ctrl / max(1, len(sample))) < 0.01

def pick_encoding(path: Path) -> Optional[str]:
    try:
        with path.open("rb") as f:
            sample = f.read(32768)
    except Exception:
        return None
    if not is_probably_text(sample):
        return None
    for enc in ("utf-8", "utf-8-sig", "utf-16", "cp1252", "latin-1"):
        try:
            sample.decode(enc)
            return enc
        except UnicodeDecodeError:
            continue
    return "latin-1"

# ====== Utilitaires ======
def relpath(base: Path, p: Path) -> str:
    try:
        r = p.relative_to(base)
    except Exception:
        r = p
    return str(r).replace("\\", "/")

def should_include_file(
    base: Path,
    file_path: Path,
    allowed_exts: Set[str],
    include_globs: List[str],
    exclude_globs: List[str],
    max_size: int,
    out_path: Path,
) -> bool:
    if not file_path.is_file():
        return False

    # Exclut les extensions manifestement binaires
    if file_path.suffix.lower() in BINARY_EXTS:
        return False

    # Ne pas se reprendre soi-même
    try:
        if file_path.resolve() == out_path.resolve():
            return False
    except Exception:
        pass

    # Taille max
    try:
        if file_path.stat().st_size > max_size:
            return False
    except Exception:
        return False

    rel = relpath(base, file_path)

    # Glob d'exclusion supplémentaires
    for pat in exclude_globs:
        if fnmatch.fnmatch(rel, pat):
            return False

    # Si on a des includes, on les respecte strictement
    if include_globs:
        ok = any(fnmatch.fnmatch(rel, pat) for pat in include_globs)
        if not ok:
            return False

    # Extensions connues ou noms spéciaux
    if file_path.suffix.lower() in allowed_exts or file_path.name in NAMES_WITHOUT_EXT:
        return True

    # Sinon, heuristique: texte probable ?
    enc = pick_encoding(file_path)
    return enc is not None

def walk_select(
    base_dir: Path,
    allowed_exts: Set[str],
    include_globs: List[str],
    exclude_globs: List[str],
    max_size: int,
    out_path: Path,
) -> List[Path]:
    selected: List[Path] = []
    for root, dirs, files in os.walk(base_dir, followlinks=False):
        # Filtrage de répertoires par nom (DEFAULT_EXCLUDE_DIRS)
        dirs[:] = [d for d in dirs if d not in DEFAULT_EXCLUDE_DIRS]

        root_path = Path(root)
        for name in files:
            fp = root_path / name
            try:
                if fp.resolve() == out_path.resolve():
                    continue
            except Exception:
                pass
            if should_include_file(
                base_dir, fp, allowed_exts, include_globs, exclude_globs, max_size, out_path
            ):
                selected.append(fp)

    selected.sort(key=lambda p: relpath(base_dir, p).lower())
    return selected

# ====== Écriture avec TOC ======
def write_concat(
    base_dir: Path,
    files: List[Path],
    out_path: Path,
    no_headers: bool,
) -> int:
    out_path.parent.mkdir(parents=True, exist_ok=True)
    abs_paths: List[str] = []
    for p in files:
        try:
            abs_paths.append(str(p.resolve()))
        except Exception:
            abs_paths.append(str(p))

    count = 0
    with out_path.open("w", encoding="utf-8", newline="\n") as out:
        # TOC
        out.write(f"===== TOC ({len(files)} fichiers) =====\n")
        for i, ap in enumerate(abs_paths, 1):
            out.write(f"{i}. {ap}\n")
        out.write("===== END TOC =====\n\n")

        # Contenus
        for p in files:
            enc = pick_encoding(p) or "utf-8"
            rel = relpath(base_dir, p)

            if not no_headers:
                out.write(f"\n===== BEGIN {rel} =====\n")

            try:
                with p.open("r", encoding=enc, errors="strict") as f:
                    for line in f:
                        out.write(line)
            except UnicodeDecodeError:
                # Fallback si encodage foireux
                with p.open("r", encoding="latin-1", errors="replace") as f:
                    for line in f:
                        out.write(line)

            if not no_headers:
                out.write(f"\n===== END {rel} =====\n")

            out.write("\n")
            count += 1

    return count

# ====== Exécution mono-fichier ======
def run_single_output(base_dir: Path, args: argparse.Namespace) -> None:
    if args.out:
        out_path = (base_dir / args.out).resolve()
    else:
        stamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        out_name = f"Code_{base_dir.name}_{stamp}.txt"
        out_path = (base_dir / out_name).resolve()

    allowed_exts = normalize_exts(args.ext)
    include_globs = list(args.include or [])
    # Ajout des patterns d'exclusion de sorties générées
    exclude_globs = list(args.exclude or []) + list(OUT_EXCLUDES)

    files = walk_select(
        base_dir,
        allowed_exts,
        include_globs,
        exclude_globs,
        args.max_size,
        out_path,
    )
    n = write_concat(base_dir, files, out_path, args.no_headers)
    print(f"{n} fichier(s) concaténé(s) -> {out_path.name}")

def main() -> None:
    args = parse_args()
    # Racine = dossier contenant ce script (mettez-le à C:\MyCode\Orgo)
    base_dir = Path(__file__).resolve().parent
    run_single_output(base_dir, args)

if __name__ == "__main__":
    main()

===== END concat_orgo.py =====


===== BEGIN docker-compose.yml =====
version: "3.8"

services:
  reverse-proxy:
    image: nginx:latest
    container_name: nginx_container
    ports:
      - 80:80
    depends_on:
      - postgres
    volumes:
      - ./packages/config/nginx.conf:/etc/nginx/nginx.conf
    extra_hosts:
      - "host.docker.internal:host-gateway"

  postgres:
    image: postgres:15
    environment:
      - POSTGRES_DB=mydb
      - POSTGRES_USER=test
      - POSTGRES_PASSWORD=test
    volumes:
      - db_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

volumes:
  db_data:

===== END docker-compose.yml =====


===== BEGIN LICENSE =====
MIT License

Copyright (c) 2022 Ejaz Ahmed

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

===== END LICENSE =====


===== BEGIN package-scripts.js =====
const path = require("path");

const apiPath = path.resolve(__dirname, "apps/api");
const webPath = path.resolve(__dirname, "apps/web");

const ciApiPath = path.resolve(__dirname, "out/apps/api");
const ciWebPath = path.resolve(__dirname, "out/apps/web");

module.exports = {
  scripts: {
    prepare: {
      default: `nps prepare.web prepare.api`,
      web: `yarn`,
      api: `nps prepare.docker prisma.migrate.dev`,
      docker: "docker compose up -d",
      ci: {
        web: `npx turbo prune --scope=web && cd out && yarn install --frozen-lockfile`,
        api: `npx turbo prune --scope=api && cd out && yarn install --frozen-lockfile && nps prisma.generate`,
      },
    },
    test: {
      default: `nps test.web test.api`,
      web: `cd ${webPath} && yarn test`,
      api: `cd ${apiPath} && yarn test`,
      ci: {
        default: `nps test.ci.web test.ci.api`,
        web: `cd ${ciWebPath} && yarn test:ci`,
        api: `cd ${ciApiPath} && yarn test:ci`,
      },
      watch: {
        default: `nps test.watch.web test.watch.api`,
        web: `cd ${webPath} && yarn test:watch`,
        api: `cd ${apiPath} && yarn test:watch`,
      },
    },
    prisma: {
      generate: `cd ${apiPath} && npx prisma generate`,
      studio: `cd ${apiPath} && npx prisma studio`,
      migrate: {
        dev: `cd ${apiPath} && npx prisma migrate dev`,
      },
    },
    build: {
      default: "npx turbo run build",
      ci: {
        web: "cd out && npm run build",
        api: "cd out && npm run build",
      },
    },
    docker: {
      build: {
        default: "nps docker.build.web docker.build.api",
        web: `docker build -t web . -f ${webPath}/Dockerfile`,
        api: `docker build -t api . -f ${apiPath}/Dockerfile`,
      },
    },
    dev: "npx turbo run dev",
  },
};

===== END package-scripts.js =====


===== BEGIN package.json =====
{
  "name": "turborepo-basic-shared",
  "version": "0.0.0",
  "private": true,
  "workspaces": [
    "apps/*",
    "packages/*"
  ],
  "scripts": {
    "build": "turbo run build",
    "dev": "turbo run dev --parallel",
    "lint": "turbo run lint",
    "format": "prettier --write \"**/*.{ts,tsx,md}\""
  },
  "devDependencies": {
    "prettier": "^3.0.0",
    "prisma": "^5.1.0",
    "turbo": "1.10.12"
  },
  "engines": {
    "npm": ">=7.0.0",
    "node": ">=14.0.0"
  },
  "packageManager": "yarn@1.22.17"
}

===== END package.json =====


===== BEGIN packages/config/eslint-preset.js =====
module.exports = {
  extends: ["next", "prettier"],
  settings: {
    next: {
      rootDir: ["apps/*/", "packages/*/"],
    },
  },
  rules: {
    "@next/next/no-html-link-for-pages": "off",
    "react/jsx-key": "off",
  },
};

===== END packages/config/eslint-preset.js =====


===== BEGIN packages/config/nginx.conf =====
events {

}

http {

    server {
        listen 80;
        server_name localhost;

        location /api/ {
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_pass http://host.docker.internal:5002/;

            proxy_http_version 1.1;
            proxy_set_header Connection "upgrade";
            proxy_set_header Upgrade $http_upgrade;
        }

        location /_next/webpack-hmr {
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Host $host;


            proxy_pass http://host.docker.internal:3000;

            proxy_http_version 1.1;
            proxy_set_header Connection "upgrade";
            proxy_set_header Upgrade $http_upgrade;
        }

        location / {
            proxy_pass http://host.docker.internal:3000;
        }

    }

}

===== END packages/config/nginx.conf =====


===== BEGIN packages/config/package.json =====
{
  "name": "config",
  "version": "0.0.0",
  "main": "index.js",
  "license": "MIT",
  "files": [
    "eslint-preset.js"
  ],
  "dependencies": {
    "eslint-config-next": "^13.4.12",
    "eslint-config-prettier": "^8.9.0",
    "eslint-plugin-react": "7.33.1"
  }
}

===== END packages/config/package.json =====


===== BEGIN packages/config/postcss.config.js =====
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};

===== END packages/config/postcss.config.js =====


===== BEGIN packages/config/tailwind.config.js =====
module.exports = {
  content: [
    "../../packages/ui/**/*.{js,ts,jsx,tsx}",
    "./pages/**/*.{js,ts,jsx,tsx}",
    "./components/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {},
  },
  plugins: [],
};

===== END packages/config/tailwind.config.js =====


===== BEGIN packages/tsconfig/base.json =====
{
  "$schema": "https://json.schemastore.org/tsconfig",
  "display": "Default",
  "compilerOptions": {
    "composite": false,
    "declaration": true,
    "declarationMap": true,
    "esModuleInterop": true,
    "forceConsistentCasingInFileNames": true,
    "inlineSources": false,
    "isolatedModules": true,
    "moduleResolution": "node",
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "preserveWatchOutput": true,
    "skipLibCheck": true,
    "strict": true
  },
  "exclude": ["node_modules"]
}

===== END packages/tsconfig/base.json =====


===== BEGIN packages/tsconfig/nestjs.json =====
{
  "$schema": "https://json.schemastore.org/tsconfig",
  "extends": "./base.json",
  "compilerOptions": {
    "module": "commonjs",
    "declaration": true,
    "removeComments": true,
    "emitDecoratorMetadata": true,
    "experimentalDecorators": true,
    "allowSyntheticDefaultImports": true,
    "target": "es2017",
    "sourceMap": true,
    "incremental": true,
    "skipLibCheck": true,
    "strictNullChecks": false,
    "noImplicitAny": false,
    "strictBindCallApply": false,
    "forceConsistentCasingInFileNames": false,
    "noFallthroughCasesInSwitch": false
  }
}

===== END packages/tsconfig/nestjs.json =====


===== BEGIN packages/tsconfig/nextjs.json =====
{
  "$schema": "https://json.schemastore.org/tsconfig",
  "display": "Next.js",
  "extends": "./base.json",
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": false,
    "forceConsistentCasingInFileNames": true,
    "noEmit": true,
    "incremental": true,
    "esModuleInterop": true,
    "module": "esnext",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve"
  },
  "include": ["src", "next-env.d.ts"],
  "exclude": ["node_modules"]
}

===== END packages/tsconfig/nextjs.json =====


===== BEGIN packages/tsconfig/package.json =====
{
  "name": "tsconfig",
  "version": "0.0.0",
  "private": true,
  "main": "index.js",
  "files": [
    "base.json",
    "nextjs.json",
    "react-library.json"
  ]
}

===== END packages/tsconfig/package.json =====


===== BEGIN packages/tsconfig/react-library.json =====
{
  "$schema": "https://json.schemastore.org/tsconfig",
  "display": "React Library",
  "extends": "./base.json",
  "compilerOptions": {
    "lib": ["ES2015"],
    "module": "ESNext",
    "target": "ES6",
    "jsx": "react-jsx"
  }
}

===== END packages/tsconfig/react-library.json =====


===== BEGIN packages/tsconfig/README.md =====
# `tsconfig`

These are base shared `tsconfig.json`s from which all other `tsconfig.json`'s inherit from.

===== END packages/tsconfig/README.md =====


===== BEGIN packages/ui/components/Button/Button.tsx =====
export const Button = () => {
  return <button className="text-lg bg-red-500">boo</button>;
};

===== END packages/ui/components/Button/Button.tsx =====


===== BEGIN packages/ui/index.tsx =====
export * from "./components/Button/Button";

===== END packages/ui/index.tsx =====


===== BEGIN packages/ui/package.json =====
{
  "name": "ui",
  "version": "0.0.0",
  "main": "./index.tsx",
  "types": "./index.tsx",
  "license": "MIT",
  "devDependencies": {
    "@types/react": "^18.2.18",
    "@types/react-dom": "^18.2.7",
    "config": "*",
    "tsconfig": "*",
    "typescript": "^5.1.6"
  }
}

===== END packages/ui/package.json =====


===== BEGIN packages/ui/tsconfig.json =====
{
  "extends": "tsconfig/react-library.json",
  "include": ["."],
  "exclude": ["dist", "build", "node_modules"]
}

===== END packages/ui/tsconfig.json =====


===== BEGIN README.md =====
## What is Orgo?

Orgo is a multi‑tenant “nervous system” for organizations.

It:

* **Ingests signals** from email, APIs, UIs and offline imports
* **Normalizes them into Cases and Tasks** with a strict, shared schema
* **Routes work to the right roles** using a structured label system
* **Tracks execution and escalation** across any domain (maintenance, HR, education, NGOs, etc.)
* **Continuously scans for patterns and risks** through an Insights module and cyclic reviews

The goal is a single, schema‑driven backbone that different organizations and domains can “plug into” without each reinventing ticketing, routing, and oversight.

---

## Core concepts

### Multi‑tenant backbone

Orgo is built for many organizations on one install:

* **Organizations (tenants)** with `organization_id`, profile, timezone, etc.
* **User accounts** (who logs in) vs **Person profiles** (who the work is *about* – students, employees, players, residents, etc.).
* **Roles and permissions** for RBAC.

Everything – emails, tasks, cases, analytics – is scoped by `organization_id`.

---

### Signals → Cases & Tasks

Orgo’s job is to capture messy real‑world signals and turn them into structured work.

**Signals in:**

* **Email**: via IMAP/SMTP into `email_messages` + threads, with attachments, flags, spam/sensitivity hints.
* **APIs / UIs**: REST endpoints and internal UIs that call into `create_task` / case creation.
* **Offline imports / sync**: e.g. PST/mbox imports, offline nodes syncing via SQLite.

Signals go through the **workflow engine** and **email gateway**, which decide:

* Do we open a **Case**?
* Do we create a **Task**?
* For which **domain** (maintenance, HR, education, etc.) and which **role**?

**Task = central unit of work**

* Global schema: `type` (domain), `category` (request / incident / update / report / distribution), subtype, `priority`, `severity`, `visibility`, `label`, assignee, due dates, escalation level, metadata, etc.
* Canonical lifecycle (simplified):
  `PENDING → IN_PROGRESS → ON_HOLD / COMPLETED / FAILED / ESCALATED / CANCELLED`.

**Case = long‑lived container**

* Groups tasks, tags, severity, location, participants, and related signals.
* Used for incidents, themes, investigations, audits, etc.
* Participates in weekly / monthly / yearly review cycles.

---

### Label system (how Orgo routes and contextualizes)

Orgo uses a structured “label” to encode **where** in the organization something lives and **what kind of information** it is:

```text
<base>.<category><subcategory>.<horizontal_role?>
```

Example: `100.94.Operations.Safety`

* `100`  → broadcast level (e.g. department heads)
* `.9`   → Crisis & emergency information
* `.4`   → Report
* `Operations.Safety` → horizontal role / functional area

The label drives:

* **Routing** – which queue / role receives the work
* **Visibility** – how sensitive it is by default
* **Analytics** – how incidents and patterns are grouped

Special bases like `10 / 100 / 1000` are **broadcast levels**: they are informational by default (no auto‑tasks) unless a workflow rule explicitly says “create work from this broadcast”.

---

### Domain modules: one engine, many domains

Domains (maintenance, HR, education, etc.) do **not** get their own task tables or lifecycles. They plug into a shared engine:

* **Config** (`<domain>_module.yaml`):

  * Which task categories the domain uses
  * Domain‑specific subtypes
  * Email patterns and routing hints
* **Handler module** (`<domain>_handler.py`):

  * Hooks like `on_task_create`, `on_task_update` for domain‑specific behavior

“Maintenance”, “HR”, “Education”, etc. all share the same Case/Task core and differ only via metadata + rules.

---

### Profiles: tuning Orgo to “type of organization”

A **Profile** describes how “intense” or “formal” an organization is (friend group vs hospital vs NGO vs retail chain). Per profile you can configure:

* **Reactivity & escalation timings**
* **Transparency model** (full / balanced / restricted / private)
* **Review cadence** (real‑time, weekly, monthly, yearly)
* **Notification scope** (assignee / team / department / org‑wide)
* **Pattern sensitivity** and time windows
* **Severity policy** (which severities escalate immediately)
* **Logging depth & retention**
* **Automation level** (manual to fully automated)

The same codebase can therefore behave like:

* A lightweight coordinator for a small group
* A high‑stakes incident system for a hospital
* A compliance‑heavy tracker for an NGO
* An ops platform for a multi‑site retail chain

without changing schemas or services – only configuration.

---

### Insights & cyclic overview

On top of the operational database, Orgo has an **Insights** layer:

* Star schema (`insights.dim_*`, `insights.fact_*`) for tasks, cases, persons, groups, wellbeing check‑ins, etc.
* ETL / DAGs to hydrate analytics tables.
* Reporting API + caching for dashboards and exports.

The **cyclic overview** system then:

* Reviews cases/tasks on **weekly / monthly / yearly** cycles
* Applies thresholds like “N similar incidents in X days” to open new **audit/review Cases**
* Surfaces patterns (recurring safety issues, repeated harassment in one team, drops in wellbeing scores) as *work items*, not just charts

Patterns and systemic risks get turned back into Cases and Tasks, closing the loop between operations and oversight.

---

### Guardrails: visibility, audit, compliance

Orgo is designed to be safe for sensitive domains (e.g. hospitals, HR) by default:

* **Visibility enum** (e.g. `PUBLIC`, `INTERNAL`, `RESTRICTED`, `ANONYMISED`) on Cases/Tasks drives who can see what, and what can be exported.
* **Logging** is normalized into categories (workflow, task, system, security, email) with per‑profile retention policies.
* **Security events & audit logs** cover sensitive changes and exports, with PII masking enforced in the Insights layer based on visibility rules.

---

### What Orgo is *not*

Orgo is **not**:

* A generic CRM / ERP / accounting system
* A simple kanban board or to‑do app

It is:

* A **unified, schema‑driven case & task platform** that many org types plug into
* With strong emphasis on **routing, escalation, and pattern detection over time**, across domains and organizations.

===== END README.md =====


===== BEGIN turbo.json =====
{
  "pipeline": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**", ".next/**"]
    },
    "lint": {
      "outputs": []
    },
    "dev": {
      "cache": false
    },
    "test:ci": {
      "cache": false
    }
  }
}

===== END turbo.json =====


===== BEGIN yarn.lock =====
# THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
# yarn lockfile v1


"@aashutoshrathi/word-wrap@^1.2.3":
  version "1.2.6"
  resolved "https://registry.yarnpkg.com/@aashutoshrathi/word-wrap/-/word-wrap-1.2.6.tgz#bd9154aec9983f77b3a034ecaa015c2e4201f6cf"
  integrity sha512-1Yjs2SvM8TflER/OD3cOjhWWOZb58A2t7wpE2S9XfBYTiIl+XFhQG2bjy4Pu1I+EAlCNUzRDYDdFwFYUKvXcIA==

"@adobe/css-tools@^4.0.1":
  version "4.0.1"
  resolved "https://registry.yarnpkg.com/@adobe/css-tools/-/css-tools-4.0.1.tgz#b38b444ad3aa5fedbb15f2f746dcd934226a12dd"
  integrity sha512-+u76oB43nOHrF4DDWRLWDCtci7f3QJoEBigemIdIeTi1ODqjx6Tad9NCVnPRwewWlKkVab5PlK8DCtPTyX7S8g==

"@alloc/quick-lru@^5.2.0":
  version "5.2.0"
  resolved "https://registry.yarnpkg.com/@alloc/quick-lru/-/quick-lru-5.2.0.tgz#7bf68b20c0a350f936915fcae06f58e32007ce30"
  integrity sha512-UrcABB+4bUrFABwbluTIBErXwvbsU/V7TZWfmbgJfbkwiBuziS9gxdODUyuiecfdGQ85jglMW6juS3+z5TsKLw==

"@ampproject/remapping@^2.1.0":
  version "2.2.0"
  resolved "https://registry.yarnpkg.com/@ampproject/remapping/-/remapping-2.2.0.tgz#56c133824780de3174aed5ab6834f3026790154d"
  integrity sha512-qRmjj8nj9qmLTQXXmaR1cck3UXSRMPrbsLJAasZpF+t3riI71BXed5ebIOYwQntykeZuhjsdweEc9BxH5Jc26w==
  dependencies:
    "@jridgewell/gen-mapping" "^0.1.0"
    "@jridgewell/trace-mapping" "^0.3.9"

"@angular-devkit/core@16.1.0":
  version "16.1.0"
  resolved "https://registry.yarnpkg.com/@angular-devkit/core/-/core-16.1.0.tgz#cb56b19e88fc936fb0b26c5ae62591f1e8906961"
  integrity sha512-mrWpuDvttmhrCGcLc68RIXKtTzUhkBTsE5ZZFZNO1+FSC+vO/ZpyCpPd6C+6coM68NfXYjHlms5XF6KbxeGn/Q==
  dependencies:
    ajv "8.12.0"
    ajv-formats "2.1.1"
    jsonc-parser "3.2.0"
    rxjs "7.8.1"
    source-map "0.7.4"

"@angular-devkit/core@16.1.4":
  version "16.1.4"
  resolved "https://registry.yarnpkg.com/@angular-devkit/core/-/core-16.1.4.tgz#033ff3ab4d024ee3d8f4c6f809eed10d716ad0ab"
  integrity sha512-WCAzNi9LxpFIi2WVPaJQd2kHPqCnCexWzUZN05ltJuBGCQL1O+LgRHGwnQ4WZoqmrF5tcWt2a3GFtJ3DgMc1hw==
  dependencies:
    ajv "8.12.0"
    ajv-formats "2.1.1"
    jsonc-parser "3.2.0"
    rxjs "7.8.1"
    source-map "0.7.4"

"@angular-devkit/schematics-cli@16.1.4":
  version "16.1.4"
  resolved "https://registry.yarnpkg.com/@angular-devkit/schematics-cli/-/schematics-cli-16.1.4.tgz#5f626e9c50aa6d567a99569dbb74bd4f3a95f9c6"
  integrity sha512-/m05+9jCV6jYcQZhDoQXo8neusE1HGU5oM+Jw2xtl3oube8vzbymhwq1SoDeMlnhMnhnxg4rMsghEgRROAq4bA==
  dependencies:
    "@angular-devkit/core" "16.1.4"
    "@angular-devkit/schematics" "16.1.4"
    ansi-colors "4.1.3"
    inquirer "8.2.4"
    symbol-observable "4.0.0"
    yargs-parser "21.1.1"

"@angular-devkit/schematics@16.1.0":
  version "16.1.0"
  resolved "https://registry.yarnpkg.com/@angular-devkit/schematics/-/schematics-16.1.0.tgz#a0235ba402c9dfb38b7dedbf59bbcda667e8ec2f"
  integrity sha512-LM35PH9DT3eQRSZgrkk2bx1ZQjjVh8BCByTlr37/c+FnF9mNbeBsa1YkxrlsN/CwO+045OwEwRHnkM9Zcx0U/A==
  dependencies:
    "@angular-devkit/core" "16.1.0"
    jsonc-parser "3.2.0"
    magic-string "0.30.0"
    ora "5.4.1"
    rxjs "7.8.1"

"@angular-devkit/schematics@16.1.4":
  version "16.1.4"
  resolved "https://registry.yarnpkg.com/@angular-devkit/schematics/-/schematics-16.1.4.tgz#91d4d82ee273dd7f24c17b9c7fbbfff11d7cab63"
  integrity sha512-yjRgwHAfFaeuimgbQtjwSUyXzEHpMSdTRb2zg+TOp6skoGvHOG8xXFJ7DjBkSMeAQdFF0fkxhPS9YmlxqNc+7A==
  dependencies:
    "@angular-devkit/core" "16.1.4"
    jsonc-parser "3.2.0"
    magic-string "0.30.0"
    ora "5.4.1"
    rxjs "7.8.1"

"@babel/code-frame@^7.0.0", "@babel/code-frame@^7.10.4", "@babel/code-frame@^7.12.13", "@babel/code-frame@^7.16.7", "@babel/code-frame@^7.18.6":
  version "7.18.6"
  resolved "https://registry.yarnpkg.com/@babel/code-frame/-/code-frame-7.18.6.tgz#3b25d38c89600baa2dcc219edfa88a74eb2c427a"
  integrity sha512-TDCmlK5eOvH+eH7cdAFlNXeVJqWIQ7gW9tY1GJIpUtFb6CmjVyq2VM3u71bOyR8CRihcCgMUYoDNyLXao3+70Q==
  dependencies:
    "@babel/highlight" "^7.18.6"

"@babel/compat-data@^7.20.0":
  version "7.20.5"
  resolved "https://registry.yarnpkg.com/@babel/compat-data/-/compat-data-7.20.5.tgz#86f172690b093373a933223b4745deeb6049e733"
  integrity sha512-KZXo2t10+/jxmkhNXc7pZTqRvSOIvVv/+lJwHS+B2rErwOyjuVRh60yVpb7liQ1U5t7lLJ1bz+t8tSypUZdm0g==

"@babel/core@^7.11.6", "@babel/core@^7.12.3":
  version "7.20.5"
  resolved "https://registry.yarnpkg.com/@babel/core/-/core-7.20.5.tgz#45e2114dc6cd4ab167f81daf7820e8fa1250d113"
  integrity sha512-UdOWmk4pNWTm/4DlPUl/Pt4Gz4rcEMb7CY0Y3eJl5Yz1vI8ZJGmHWaVE55LoxRjdpx0z259GE9U5STA9atUinQ==
  dependencies:
    "@ampproject/remapping" "^2.1.0"
    "@babel/code-frame" "^7.18.6"
    "@babel/generator" "^7.20.5"
    "@babel/helper-compilation-targets" "^7.20.0"
    "@babel/helper-module-transforms" "^7.20.2"
    "@babel/helpers" "^7.20.5"
    "@babel/parser" "^7.20.5"
    "@babel/template" "^7.18.10"
    "@babel/traverse" "^7.20.5"
    "@babel/types" "^7.20.5"
    convert-source-map "^1.7.0"
    debug "^4.1.0"
    gensync "^1.0.0-beta.2"
    json5 "^2.2.1"
    semver "^6.3.0"

"@babel/generator@^7.20.5", "@babel/generator@^7.7.2":
  version "7.20.5"
  resolved "https://registry.yarnpkg.com/@babel/generator/-/generator-7.20.5.tgz#cb25abee3178adf58d6814b68517c62bdbfdda95"
  integrity sha512-jl7JY2Ykn9S0yj4DQP82sYvPU+T3g0HFcWTqDLqiuA9tGRNIj9VfbtXGAYTTkyNEnQk1jkMGOdYka8aG/lulCA==
  dependencies:
    "@babel/types" "^7.20.5"
    "@jridgewell/gen-mapping" "^0.3.2"
    jsesc "^2.5.1"

"@babel/helper-compilation-targets@^7.20.0":
  version "7.20.0"
  resolved "https://registry.yarnpkg.com/@babel/helper-compilation-targets/-/helper-compilation-targets-7.20.0.tgz#6bf5374d424e1b3922822f1d9bdaa43b1a139d0a"
  integrity sha512-0jp//vDGp9e8hZzBc6N/KwA5ZK3Wsm/pfm4CrY7vzegkVxc65SgSn6wYOnwHe9Js9HRQ1YTCKLGPzDtaS3RoLQ==
  dependencies:
    "@babel/compat-data" "^7.20.0"
    "@babel/helper-validator-option" "^7.18.6"
    browserslist "^4.21.3"
    semver "^6.3.0"

"@babel/helper-environment-visitor@^7.18.9":
  version "7.18.9"
  resolved "https://registry.yarnpkg.com/@babel/helper-environment-visitor/-/helper-environment-visitor-7.18.9.tgz#0c0cee9b35d2ca190478756865bb3528422f51be"
  integrity sha512-3r/aACDJ3fhQ/EVgFy0hpj8oHyHpQc+LPtJoY9SzTThAsStm4Ptegq92vqKoE3vD706ZVFWITnMnxucw+S9Ipg==

"@babel/helper-function-name@^7.19.0":
  version "7.19.0"
  resolved "https://registry.yarnpkg.com/@babel/helper-function-name/-/helper-function-name-7.19.0.tgz#941574ed5390682e872e52d3f38ce9d1bef4648c"
  integrity sha512-WAwHBINyrpqywkUH0nTnNgI5ina5TFn85HKS0pbPDfxFfhyR/aNQEn4hGi1P1JyT//I0t4OgXUlofzWILRvS5w==
  dependencies:
    "@babel/template" "^7.18.10"
    "@babel/types" "^7.19.0"

"@babel/helper-hoist-variables@^7.18.6":
  version "7.18.6"
  resolved "https://registry.yarnpkg.com/@babel/helper-hoist-variables/-/helper-hoist-variables-7.18.6.tgz#d4d2c8fb4baeaa5c68b99cc8245c56554f926678"
  integrity sha512-UlJQPkFqFULIcyW5sbzgbkxn2FKRgwWiRexcuaR8RNJRy8+LLveqPjwZV/bwrLZCN0eUHD/x8D0heK1ozuoo6Q==
  dependencies:
    "@babel/types" "^7.18.6"

"@babel/helper-module-imports@^7.18.6":
  version "7.18.6"
  resolved "https://registry.yarnpkg.com/@babel/helper-module-imports/-/helper-module-imports-7.18.6.tgz#1e3ebdbbd08aad1437b428c50204db13c5a3ca6e"
  integrity sha512-0NFvs3VkuSYbFi1x2Vd6tKrywq+z/cLeYC/RJNFrIX/30Bf5aiGYbtvGXolEktzJH8o5E5KJ3tT+nkxuuZFVlA==
  dependencies:
    "@babel/types" "^7.18.6"

"@babel/helper-module-transforms@^7.20.2":
  version "7.20.2"
  resolved "https://registry.yarnpkg.com/@babel/helper-module-transforms/-/helper-module-transforms-7.20.2.tgz#ac53da669501edd37e658602a21ba14c08748712"
  integrity sha512-zvBKyJXRbmK07XhMuujYoJ48B5yvvmM6+wcpv6Ivj4Yg6qO7NOZOSnvZN9CRl1zz1Z4cKf8YejmCMh8clOoOeA==
  dependencies:
    "@babel/helper-environment-visitor" "^7.18.9"
    "@babel/helper-module-imports" "^7.18.6"
    "@babel/helper-simple-access" "^7.20.2"
    "@babel/helper-split-export-declaration" "^7.18.6"
    "@babel/helper-validator-identifier" "^7.19.1"
    "@babel/template" "^7.18.10"
    "@babel/traverse" "^7.20.1"
    "@babel/types" "^7.20.2"

"@babel/helper-plugin-utils@^7.0.0", "@babel/helper-plugin-utils@^7.10.4", "@babel/helper-plugin-utils@^7.12.13", "@babel/helper-plugin-utils@^7.14.5", "@babel/helper-plugin-utils@^7.18.6", "@babel/helper-plugin-utils@^7.19.0", "@babel/helper-plugin-utils@^7.8.0":
  version "7.20.2"
  resolved "https://registry.yarnpkg.com/@babel/helper-plugin-utils/-/helper-plugin-utils-7.20.2.tgz#d1b9000752b18d0877cff85a5c376ce5c3121629"
  integrity sha512-8RvlJG2mj4huQ4pZ+rU9lqKi9ZKiRmuvGuM2HlWmkmgOhbs6zEAw6IEiJ5cQqGbDzGZOhwuOQNtZMi/ENLjZoQ==

"@babel/helper-simple-access@^7.20.2":
  version "7.20.2"
  resolved "https://registry.yarnpkg.com/@babel/helper-simple-access/-/helper-simple-access-7.20.2.tgz#0ab452687fe0c2cfb1e2b9e0015de07fc2d62dd9"
  integrity sha512-+0woI/WPq59IrqDYbVGfshjT5Dmk/nnbdpcF8SnMhhXObpTq2KNBdLFRFrkVdbDOyUmHBCxzm5FHV1rACIkIbA==
  dependencies:
    "@babel/types" "^7.20.2"

"@babel/helper-split-export-declaration@^7.18.6":
  version "7.18.6"
  resolved "https://registry.yarnpkg.com/@babel/helper-split-export-declaration/-/helper-split-export-declaration-7.18.6.tgz#7367949bc75b20c6d5a5d4a97bba2824ae8ef075"
  integrity sha512-bde1etTx6ZyTmobl9LLMMQsaizFVZrquTEHOqKeQESMKo4PlObf+8+JA25ZsIpZhT/WEd39+vOdLXAFG/nELpA==
  dependencies:
    "@babel/types" "^7.18.6"

"@babel/helper-string-parser@^7.19.4":
  version "7.19.4"
  resolved "https://registry.yarnpkg.com/@babel/helper-string-parser/-/helper-string-parser-7.19.4.tgz#38d3acb654b4701a9b77fb0615a96f775c3a9e63"
  integrity sha512-nHtDoQcuqFmwYNYPz3Rah5ph2p8PFeFCsZk9A/48dPc/rGocJ5J3hAAZ7pb76VWX3fZKu+uEr/FhH5jLx7umrw==

"@babel/helper-validator-identifier@^7.18.6", "@babel/helper-validator-identifier@^7.19.1":
  version "7.19.1"
  resolved "https://registry.yarnpkg.com/@babel/helper-validator-identifier/-/helper-validator-identifier-7.19.1.tgz#7eea834cf32901ffdc1a7ee555e2f9c27e249ca2"
  integrity sha512-awrNfaMtnHUr653GgGEs++LlAvW6w+DcPrOliSMXWCKo597CwL5Acf/wWdNkf/tfEQE3mjkeD1YOVZOUV/od1w==

"@babel/helper-validator-option@^7.18.6":
  version "7.18.6"
  resolved "https://registry.yarnpkg.com/@babel/helper-validator-option/-/helper-validator-option-7.18.6.tgz#bf0d2b5a509b1f336099e4ff36e1a63aa5db4db8"
  integrity sha512-XO7gESt5ouv/LRJdrVjkShckw6STTaB7l9BrpBaAHDeF5YZT+01PCwmR0SJHnkW6i8OwW/EVWRShfi4j2x+KQw==

"@babel/helpers@^7.20.5":
  version "7.20.6"
  resolved "https://registry.yarnpkg.com/@babel/helpers/-/helpers-7.20.6.tgz#e64778046b70e04779dfbdf924e7ebb45992c763"
  integrity sha512-Pf/OjgfgFRW5bApskEz5pvidpim7tEDPlFtKcNRXWmfHGn9IEI2W2flqRQXTFb7gIPTyK++N6rVHuwKut4XK6w==
  dependencies:
    "@babel/template" "^7.18.10"
    "@babel/traverse" "^7.20.5"
    "@babel/types" "^7.20.5"

"@babel/highlight@^7.18.6":
  version "7.18.6"
  resolved "https://registry.yarnpkg.com/@babel/highlight/-/highlight-7.18.6.tgz#81158601e93e2563795adcbfbdf5d64be3f2ecdf"
  integrity sha512-u7stbOuYjaPezCuLj29hNW1v64M2Md2qupEKP1fHc7WdOA3DgLh37suiSrZYY7haUB7iBeQZ9P1uiRF359do3g==
  dependencies:
    "@babel/helper-validator-identifier" "^7.18.6"
    chalk "^2.0.0"
    js-tokens "^4.0.0"

"@babel/parser@^7.1.0", "@babel/parser@^7.14.7", "@babel/parser@^7.18.10", "@babel/parser@^7.20.5":
  version "7.20.5"
  resolved "https://registry.yarnpkg.com/@babel/parser/-/parser-7.20.5.tgz#7f3c7335fe417665d929f34ae5dceae4c04015e8"
  integrity sha512-r27t/cy/m9uKLXQNWWebeCUHgnAZq0CpG1OwKRxzJMP1vpSU4bSIK2hq+/cp0bQxetkXx38n09rNu8jVkcK/zA==

"@babel/plugin-syntax-async-generators@^7.8.4":
  version "7.8.4"
  resolved "https://registry.yarnpkg.com/@babel/plugin-syntax-async-generators/-/plugin-syntax-async-generators-7.8.4.tgz#a983fb1aeb2ec3f6ed042a210f640e90e786fe0d"
  integrity sha512-tycmZxkGfZaxhMRbXlPXuVFpdWlXpir2W4AMhSJgRKzk/eDlIXOhb2LHWoLpDF7TEHylV5zNhykX6KAgHJmTNw==
  dependencies:
    "@babel/helper-plugin-utils" "^7.8.0"

"@babel/plugin-syntax-bigint@^7.8.3":
  version "7.8.3"
  resolved "https://registry.yarnpkg.com/@babel/plugin-syntax-bigint/-/plugin-syntax-bigint-7.8.3.tgz#4c9a6f669f5d0cdf1b90a1671e9a146be5300cea"
  integrity sha512-wnTnFlG+YxQm3vDxpGE57Pj0srRU4sHE/mDkt1qv2YJJSeUAec2ma4WLUnUPeKjyrfntVwe/N6dCXpU+zL3Npg==
  dependencies:
    "@babel/helper-plugin-utils" "^7.8.0"

"@babel/plugin-syntax-class-properties@^7.8.3":
  version "7.12.13"
  resolved "https://registry.yarnpkg.com/@babel/plugin-syntax-class-properties/-/plugin-syntax-class-properties-7.12.13.tgz#b5c987274c4a3a82b89714796931a6b53544ae10"
  integrity sha512-fm4idjKla0YahUNgFNLCB0qySdsoPiZP3iQE3rky0mBUtMZ23yDJ9SJdg6dXTSDnulOVqiF3Hgr9nbXvXTQZYA==
  dependencies:
    "@babel/helper-plugin-utils" "^7.12.13"

"@babel/plugin-syntax-import-meta@^7.8.3":
  version "7.10.4"
  resolved "https://registry.yarnpkg.com/@babel/plugin-syntax-import-meta/-/plugin-syntax-import-meta-7.10.4.tgz#ee601348c370fa334d2207be158777496521fd51"
  integrity sha512-Yqfm+XDx0+Prh3VSeEQCPU81yC+JWZ2pDPFSS4ZdpfZhp4MkFMaDC1UqseovEKwSUpnIL7+vK+Clp7bfh0iD7g==
  dependencies:
    "@babel/helper-plugin-utils" "^7.10.4"

"@babel/plugin-syntax-json-strings@^7.8.3":
  version "7.8.3"
  resolved "https://registry.yarnpkg.com/@babel/plugin-syntax-json-strings/-/plugin-syntax-json-strings-7.8.3.tgz#01ca21b668cd8218c9e640cb6dd88c5412b2c96a"
  integrity sha512-lY6kdGpWHvjoe2vk4WrAapEuBR69EMxZl+RoGRhrFGNYVK8mOPAW8VfbT/ZgrFbXlDNiiaxQnAtgVCZ6jv30EA==
  dependencies:
    "@babel/helper-plugin-utils" "^7.8.0"

"@babel/plugin-syntax-jsx@^7.7.2":
  version "7.18.6"
  resolved "https://registry.yarnpkg.com/@babel/plugin-syntax-jsx/-/plugin-syntax-jsx-7.18.6.tgz#a8feef63b010150abd97f1649ec296e849943ca0"
  integrity sha512-6mmljtAedFGTWu2p/8WIORGwy+61PLgOMPOdazc7YoJ9ZCWUyFy3A6CpPkRKLKD1ToAesxX8KGEViAiLo9N+7Q==
  dependencies:
    "@babel/helper-plugin-utils" "^7.18.6"

"@babel/plugin-syntax-logical-assignment-operators@^7.8.3":
  version "7.10.4"
  resolved "https://registry.yarnpkg.com/@babel/plugin-syntax-logical-assignment-operators/-/plugin-syntax-logical-assignment-operators-7.10.4.tgz#ca91ef46303530448b906652bac2e9fe9941f699"
  integrity sha512-d8waShlpFDinQ5MtvGU9xDAOzKH47+FFoney2baFIoMr952hKOLp1HR7VszoZvOsV/4+RRszNY7D17ba0te0ig==
  dependencies:
    "@babel/helper-plugin-utils" "^7.10.4"

"@babel/plugin-syntax-nullish-coalescing-operator@^7.8.3":
  version "7.8.3"
  resolved "https://registry.yarnpkg.com/@babel/plugin-syntax-nullish-coalescing-operator/-/plugin-syntax-nullish-coalescing-operator-7.8.3.tgz#167ed70368886081f74b5c36c65a88c03b66d1a9"
  integrity sha512-aSff4zPII1u2QD7y+F8oDsz19ew4IGEJg9SVW+bqwpwtfFleiQDMdzA/R+UlWDzfnHFCxxleFT0PMIrR36XLNQ==
  dependencies:
    "@babel/helper-plugin-utils" "^7.8.0"

"@babel/plugin-syntax-numeric-separator@^7.8.3":
  version "7.10.4"
  resolved "https://registry.yarnpkg.com/@babel/plugin-syntax-numeric-separator/-/plugin-syntax-numeric-separator-7.10.4.tgz#b9b070b3e33570cd9fd07ba7fa91c0dd37b9af97"
  integrity sha512-9H6YdfkcK/uOnY/K7/aA2xpzaAgkQn37yzWUMRK7OaPOqOpGS1+n0H5hxT9AUw9EsSjPW8SVyMJwYRtWs3X3ug==
  dependencies:
    "@babel/helper-plugin-utils" "^7.10.4"

"@babel/plugin-syntax-object-rest-spread@^7.8.3":
  version "7.8.3"
  resolved "https://registry.yarnpkg.com/@babel/plugin-syntax-object-rest-spread/-/plugin-syntax-object-rest-spread-7.8.3.tgz#60e225edcbd98a640332a2e72dd3e66f1af55871"
  integrity sha512-XoqMijGZb9y3y2XskN+P1wUGiVwWZ5JmoDRwx5+3GmEplNyVM2s2Dg8ILFQm8rWM48orGy5YpI5Bl8U1y7ydlA==
  dependencies:
    "@babel/helper-plugin-utils" "^7.8.0"

"@babel/plugin-syntax-optional-catch-binding@^7.8.3":
  version "7.8.3"
  resolved "https://registry.yarnpkg.com/@babel/plugin-syntax-optional-catch-binding/-/plugin-syntax-optional-catch-binding-7.8.3.tgz#6111a265bcfb020eb9efd0fdfd7d26402b9ed6c1"
  integrity sha512-6VPD0Pc1lpTqw0aKoeRTMiB+kWhAoT24PA+ksWSBrFtl5SIRVpZlwN3NNPQjehA2E/91FV3RjLWoVTglWcSV3Q==
  dependencies:
    "@babel/helper-plugin-utils" "^7.8.0"

"@babel/plugin-syntax-optional-chaining@^7.8.3":
  version "7.8.3"
  resolved "https://registry.yarnpkg.com/@babel/plugin-syntax-optional-chaining/-/plugin-syntax-optional-chaining-7.8.3.tgz#4f69c2ab95167e0180cd5336613f8c5788f7d48a"
  integrity sha512-KoK9ErH1MBlCPxV0VANkXW2/dw4vlbGDrFgz8bmUsBGYkFRcbRwMh6cIJubdPrkxRwuGdtCk0v/wPTKbQgBjkg==
  dependencies:
    "@babel/helper-plugin-utils" "^7.8.0"

"@babel/plugin-syntax-top-level-await@^7.8.3":
  version "7.14.5"
  resolved "https://registry.yarnpkg.com/@babel/plugin-syntax-top-level-await/-/plugin-syntax-top-level-await-7.14.5.tgz#c1cfdadc35a646240001f06138247b741c34d94c"
  integrity sha512-hx++upLv5U1rgYfwe1xBQUhRmU41NEvpUvrp8jkrSCdvGSnM5/qdRMtylJ6PG5OFkBaHkbTAKTnd3/YyESRHFw==
  dependencies:
    "@babel/helper-plugin-utils" "^7.14.5"

"@babel/plugin-syntax-typescript@^7.7.2":
  version "7.20.0"
  resolved "https://registry.yarnpkg.com/@babel/plugin-syntax-typescript/-/plugin-syntax-typescript-7.20.0.tgz#4e9a0cfc769c85689b77a2e642d24e9f697fc8c7"
  integrity sha512-rd9TkG+u1CExzS4SM1BlMEhMXwFLKVjOAFFCDx9PbX5ycJWDoWMcwdJH9RhkPu1dOgn5TrxLot/Gx6lWFuAUNQ==
  dependencies:
    "@babel/helper-plugin-utils" "^7.19.0"

"@babel/runtime-corejs3@^7.10.2":
  version "7.20.6"
  resolved "https://registry.yarnpkg.com/@babel/runtime-corejs3/-/runtime-corejs3-7.20.6.tgz#63dae945963539ab0ad578efbf3eff271e7067ae"
  integrity sha512-tqeujPiuEfcH067mx+7otTQWROVMKHXEaOQcAeNV5dDdbPWvPcFA8/W9LXw2NfjNmOetqLl03dfnG2WALPlsRQ==
  dependencies:
    core-js-pure "^3.25.1"
    regenerator-runtime "^0.13.11"

"@babel/runtime@^7.10.2", "@babel/runtime@^7.12.1", "@babel/runtime@^7.12.5", "@babel/runtime@^7.18.9", "@babel/runtime@^7.9.2":
  version "7.20.6"
  resolved "https://registry.yarnpkg.com/@babel/runtime/-/runtime-7.20.6.tgz#facf4879bfed9b5326326273a64220f099b0fce3"
  integrity sha512-Q+8MqP7TiHMWzSfwiJwXCjyf4GYA4Dgw3emg/7xmwsdLJOZUp+nMqcOwOzzYheuM1rhDu8FSj2l0aoMygEuXuA==
  dependencies:
    regenerator-runtime "^0.13.11"

"@babel/template@^7.18.10", "@babel/template@^7.3.3":
  version "7.18.10"
  resolved "https://registry.yarnpkg.com/@babel/template/-/template-7.18.10.tgz#6f9134835970d1dbf0835c0d100c9f38de0c5e71"
  integrity sha512-TI+rCtooWHr3QJ27kJxfjutghu44DLnasDMwpDqCXVTal9RLp3RSYNh4NdBrRP2cQAoG9A8juOQl6P6oZG4JxA==
  dependencies:
    "@babel/code-frame" "^7.18.6"
    "@babel/parser" "^7.18.10"
    "@babel/types" "^7.18.10"

"@babel/traverse@^7.20.1", "@babel/traverse@^7.20.5":
  version "7.20.5"
  resolved "https://registry.yarnpkg.com/@babel/traverse/-/traverse-7.20.5.tgz#78eb244bea8270fdda1ef9af22a5d5e5b7e57133"
  integrity sha512-WM5ZNN3JITQIq9tFZaw1ojLU3WgWdtkxnhM1AegMS+PvHjkM5IXjmYEGY7yukz5XS4sJyEf2VzWjI8uAavhxBQ==
  dependencies:
    "@babel/code-frame" "^7.18.6"
    "@babel/generator" "^7.20.5"
    "@babel/helper-environment-visitor" "^7.18.9"
    "@babel/helper-function-name" "^7.19.0"
    "@babel/helper-hoist-variables" "^7.18.6"
    "@babel/helper-split-export-declaration" "^7.18.6"
    "@babel/parser" "^7.20.5"
    "@babel/types" "^7.20.5"
    debug "^4.1.0"
    globals "^11.1.0"

"@babel/types@^7.0.0", "@babel/types@^7.18.10", "@babel/types@^7.18.6", "@babel/types@^7.19.0", "@babel/types@^7.20.2", "@babel/types@^7.20.5", "@babel/types@^7.3.0", "@babel/types@^7.3.3":
  version "7.20.5"
  resolved "https://registry.yarnpkg.com/@babel/types/-/types-7.20.5.tgz#e206ae370b5393d94dfd1d04cd687cace53efa84"
  integrity sha512-c9fst/h2/dcF7H+MJKZ2T0KjEQ8hY/BNnDk/H3XY8C4Aw/eWQXWn/lWntHF9ooUBnGmEvbfGrTgLWc+um0YDUg==
  dependencies:
    "@babel/helper-string-parser" "^7.19.4"
    "@babel/helper-validator-identifier" "^7.19.1"
    to-fast-properties "^2.0.0"

"@bcoe/v8-coverage@^0.2.3":
  version "0.2.3"
  resolved "https://registry.yarnpkg.com/@bcoe/v8-coverage/-/v8-coverage-0.2.3.tgz#75a2e8b51cb758a7553d6804a5932d7aace75c39"
  integrity sha512-0hYQ8SB4Db5zvZB4axdMHGwEaQjkZzFjQiN9LVYvIFB2nSUHW9tYpxWriPrWDASIxiaXax83REcLxuSdnGPZtw==

"@colors/colors@1.5.0":
  version "1.5.0"
  resolved "https://registry.yarnpkg.com/@colors/colors/-/colors-1.5.0.tgz#bb504579c1cae923e6576a4f5da43d25f97bdbd9"
  integrity sha512-ooWCrlZP11i8GImSjTHYHLkvFDP48nS4+204nGb1RiX/WXYHmJA2III9/e2DWVabCESdW7hBAEzHRqUn9OUVvQ==

"@cspotcode/source-map-support@^0.8.0":
  version "0.8.1"
  resolved "https://registry.yarnpkg.com/@cspotcode/source-map-support/-/source-map-support-0.8.1.tgz#00629c35a688e05a88b1cda684fb9d5e73f000a1"
  integrity sha512-IchNf6dN4tHoMFIn/7OE8LWZ19Y6q/67Bmf6vnGREv8RSbBVb9LPJxEcnwrcwX6ixSvaiGoomAUvu4YSxXrVgw==
  dependencies:
    "@jridgewell/trace-mapping" "0.3.9"

"@eslint-community/eslint-utils@^4.2.0", "@eslint-community/eslint-utils@^4.4.0":
  version "4.4.0"
  resolved "https://registry.yarnpkg.com/@eslint-community/eslint-utils/-/eslint-utils-4.4.0.tgz#a23514e8fb9af1269d5f7788aa556798d61c6b59"
  integrity sha512-1/sA4dwrzBAyeUoQ6oxahHKmrZvsnLCg4RfxW3ZFGGmQkSNQPFNLV9CUEFQP1x9EYXHTo5p6xdhZM1Ne9p/AfA==
  dependencies:
    eslint-visitor-keys "^3.3.0"

"@eslint-community/regexpp@^4.5.1", "@eslint-community/regexpp@^4.6.1":
  version "4.6.2"
  resolved "https://registry.yarnpkg.com/@eslint-community/regexpp/-/regexpp-4.6.2.tgz#1816b5f6948029c5eaacb0703b850ee0cb37d8f8"
  integrity sha512-pPTNuaAG3QMH+buKyBIGJs3g/S5y0caxw0ygM3YyE6yJFySwiGGSzA+mM3KJ8QQvzeLh3blwgSonkFjgQdxzMw==

"@eslint/eslintrc@^2.1.1":
  version "2.1.1"
  resolved "https://registry.yarnpkg.com/@eslint/eslintrc/-/eslintrc-2.1.1.tgz#18d635e24ad35f7276e8a49d135c7d3ca6a46f93"
  integrity sha512-9t7ZA7NGGK8ckelF0PQCfcxIUzs1Md5rrO6U/c+FIQNanea5UZC0wqKXH4vHBccmu4ZJgZ2idtPeW7+Q2npOEA==
  dependencies:
    ajv "^6.12.4"
    debug "^4.3.2"
    espree "^9.6.0"
    globals "^13.19.0"
    ignore "^5.2.0"
    import-fresh "^3.2.1"
    js-yaml "^4.1.0"
    minimatch "^3.1.2"
    strip-json-comments "^3.1.1"

"@eslint/js@^8.46.0":
  version "8.46.0"
  resolved "https://registry.yarnpkg.com/@eslint/js/-/js-8.46.0.tgz#3f7802972e8b6fe3f88ed1aabc74ec596c456db6"
  integrity sha512-a8TLtmPi8xzPkCbp/OGFUo5yhRkHM2Ko9kOWP4znJr0WAhWyThaw3PnwX4vOTWOAMsV2uRt32PPDcEz63esSaA==

"@hapi/hoek@^9.0.0":
  version "9.3.0"
  resolved "https://registry.yarnpkg.com/@hapi/hoek/-/hoek-9.3.0.tgz#8368869dcb735be2e7f5cb7647de78e167a251fb"
  integrity sha512-/c6rf4UJlmHlC9b5BaNvzAcFv7HZ2QHaV0D4/HNlBdvFnvQq8RI4kYdhyPCl7Xj+oWvTWQ8ujhqS53LIgAe6KQ==

"@hapi/topo@^5.0.0":
  version "5.1.0"
  resolved "https://registry.yarnpkg.com/@hapi/topo/-/topo-5.1.0.tgz#dc448e332c6c6e37a4dc02fd84ba8d44b9afb012"
  integrity sha512-foQZKJig7Ob0BMAYBfcJk8d77QtOe7Wo4ox7ff1lQYoNNAb6jwcY1ncdoy2e9wQZzvNy7ODZCYJkK8kzmcAnAg==
  dependencies:
    "@hapi/hoek" "^9.0.0"

"@humanwhocodes/config-array@^0.11.10":
  version "0.11.10"
  resolved "https://registry.yarnpkg.com/@humanwhocodes/config-array/-/config-array-0.11.10.tgz#5a3ffe32cc9306365fb3fd572596cd602d5e12d2"
  integrity sha512-KVVjQmNUepDVGXNuoRRdmmEjruj0KfiGSbS8LVc12LMsWDQzRXJ0qdhN8L8uUigKpfEHRhlaQFY0ib1tnUbNeQ==
  dependencies:
    "@humanwhocodes/object-schema" "^1.2.1"
    debug "^4.1.1"
    minimatch "^3.0.5"

"@humanwhocodes/module-importer@^1.0.1":
  version "1.0.1"
  resolved "https://registry.yarnpkg.com/@humanwhocodes/module-importer/-/module-importer-1.0.1.tgz#af5b2691a22b44be847b0ca81641c5fb6ad0172c"
  integrity sha512-bxveV4V8v5Yb4ncFTT3rPSgZBOpCkjfK0y4oVVVJwIuDVBRMDXrPyXRL988i5ap9m9bnyEEjWfm5WkBmtffLfA==

"@humanwhocodes/object-schema@^1.2.1":
  version "1.2.1"
  resolved "https://registry.yarnpkg.com/@humanwhocodes/object-schema/-/object-schema-1.2.1.tgz#b520529ec21d8e5945a1851dfd1c32e94e39ff45"
  integrity sha512-ZnQMnLV4e7hDlUvw8H+U8ASL02SS2Gn6+9Ac3wGGLIe7+je2AeAOxPY+izIPJDfFDb7eDjev0Us8MO1iFRN8hA==

"@isaacs/cliui@^8.0.2":
  version "8.0.2"
  resolved "https://registry.yarnpkg.com/@isaacs/cliui/-/cliui-8.0.2.tgz#b37667b7bc181c168782259bab42474fbf52b550"
  integrity sha512-O8jcjabXaleOG9DQ0+ARXWZBTfnP4WNAqzuiJK7ll44AmxGKv/J2M4TPjxjY3znBCfvBXFzucm1twdyFybFqEA==
  dependencies:
    string-width "^5.1.2"
    string-width-cjs "npm:string-width@^4.2.0"
    strip-ansi "^7.0.1"
    strip-ansi-cjs "npm:strip-ansi@^6.0.1"
    wrap-ansi "^8.1.0"
    wrap-ansi-cjs "npm:wrap-ansi@^7.0.0"

"@istanbuljs/load-nyc-config@^1.0.0":
  version "1.1.0"
  resolved "https://registry.yarnpkg.com/@istanbuljs/load-nyc-config/-/load-nyc-config-1.1.0.tgz#fd3db1d59ecf7cf121e80650bb86712f9b55eced"
  integrity sha512-VjeHSlIzpv/NyD3N0YuHfXOPDIixcA1q2ZV98wsMqcYlPmv2n3Yb2lYP9XMElnaFVXg5A7YLTeLu6V84uQDjmQ==
  dependencies:
    camelcase "^5.3.1"
    find-up "^4.1.0"
    get-package-type "^0.1.0"
    js-yaml "^3.13.1"
    resolve-from "^5.0.0"

"@istanbuljs/schema@^0.1.2":
  version "0.1.3"
  resolved "https://registry.yarnpkg.com/@istanbuljs/schema/-/schema-0.1.3.tgz#e45e384e4b8ec16bce2fd903af78450f6bf7ec98"
  integrity sha512-ZXRY4jNvVgSVQ8DL3LTcakaAtXwTVUxE81hslsyD2AtoXW/wVob10HkOJ1X/pAlcI7D+2YoZKg5do8G/w6RYgA==

"@jest/console@^29.6.2":
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/@jest/console/-/console-29.6.2.tgz#bf1d4101347c23e07c029a1b1ae07d550f5cc541"
  integrity sha512-0N0yZof5hi44HAR2pPS+ikJ3nzKNoZdVu8FffRf3wy47I7Dm7etk/3KetMdRUqzVd16V4O2m2ISpNTbnIuqy1w==
  dependencies:
    "@jest/types" "^29.6.1"
    "@types/node" "*"
    chalk "^4.0.0"
    jest-message-util "^29.6.2"
    jest-util "^29.6.2"
    slash "^3.0.0"

"@jest/core@^29.6.2":
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/@jest/core/-/core-29.6.2.tgz#6f2d1dbe8aa0265fcd4fb8082ae1952f148209c8"
  integrity sha512-Oj+5B+sDMiMWLhPFF+4/DvHOf+U10rgvCLGPHP8Xlsy/7QxS51aU/eBngudHlJXnaWD5EohAgJ4js+T6pa+zOg==
  dependencies:
    "@jest/console" "^29.6.2"
    "@jest/reporters" "^29.6.2"
    "@jest/test-result" "^29.6.2"
    "@jest/transform" "^29.6.2"
    "@jest/types" "^29.6.1"
    "@types/node" "*"
    ansi-escapes "^4.2.1"
    chalk "^4.0.0"
    ci-info "^3.2.0"
    exit "^0.1.2"
    graceful-fs "^4.2.9"
    jest-changed-files "^29.5.0"
    jest-config "^29.6.2"
    jest-haste-map "^29.6.2"
    jest-message-util "^29.6.2"
    jest-regex-util "^29.4.3"
    jest-resolve "^29.6.2"
    jest-resolve-dependencies "^29.6.2"
    jest-runner "^29.6.2"
    jest-runtime "^29.6.2"
    jest-snapshot "^29.6.2"
    jest-util "^29.6.2"
    jest-validate "^29.6.2"
    jest-watcher "^29.6.2"
    micromatch "^4.0.4"
    pretty-format "^29.6.2"
    slash "^3.0.0"
    strip-ansi "^6.0.0"

"@jest/environment@^29.6.2":
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/@jest/environment/-/environment-29.6.2.tgz#794c0f769d85e7553439d107d3f43186dc6874a9"
  integrity sha512-AEcW43C7huGd/vogTddNNTDRpO6vQ2zaQNrttvWV18ArBx9Z56h7BIsXkNFJVOO4/kblWEQz30ckw0+L3izc+Q==
  dependencies:
    "@jest/fake-timers" "^29.6.2"
    "@jest/types" "^29.6.1"
    "@types/node" "*"
    jest-mock "^29.6.2"

"@jest/expect-utils@^29.3.1":
  version "29.3.1"
  resolved "https://registry.yarnpkg.com/@jest/expect-utils/-/expect-utils-29.3.1.tgz#531f737039e9b9e27c42449798acb5bba01935b6"
  integrity sha512-wlrznINZI5sMjwvUoLVk617ll/UYfGIZNxmbU+Pa7wmkL4vYzhV9R2pwVqUh4NWWuLQWkI8+8mOkxs//prKQ3g==
  dependencies:
    jest-get-type "^29.2.0"

"@jest/expect-utils@^29.6.2":
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/@jest/expect-utils/-/expect-utils-29.6.2.tgz#1b97f290d0185d264dd9fdec7567a14a38a90534"
  integrity sha512-6zIhM8go3RV2IG4aIZaZbxwpOzz3ZiM23oxAlkquOIole+G6TrbeXnykxWYlqF7kz2HlBjdKtca20x9atkEQYg==
  dependencies:
    jest-get-type "^29.4.3"

"@jest/expect@^29.6.2":
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/@jest/expect/-/expect-29.6.2.tgz#5a2ad58bb345165d9ce0a1845bbf873c480a4b28"
  integrity sha512-m6DrEJxVKjkELTVAztTLyS/7C92Y2b0VYqmDROYKLLALHn8T/04yPs70NADUYPrV3ruI+H3J0iUIuhkjp7vkfg==
  dependencies:
    expect "^29.6.2"
    jest-snapshot "^29.6.2"

"@jest/fake-timers@^29.6.2":
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/@jest/fake-timers/-/fake-timers-29.6.2.tgz#fe9d43c5e4b1b901168fe6f46f861b3e652a2df4"
  integrity sha512-euZDmIlWjm1Z0lJ1D0f7a0/y5Kh/koLFMUBE5SUYWrmy8oNhJpbTBDAP6CxKnadcMLDoDf4waRYCe35cH6G6PA==
  dependencies:
    "@jest/types" "^29.6.1"
    "@sinonjs/fake-timers" "^10.0.2"
    "@types/node" "*"
    jest-message-util "^29.6.2"
    jest-mock "^29.6.2"
    jest-util "^29.6.2"

"@jest/globals@^29.6.2":
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/@jest/globals/-/globals-29.6.2.tgz#74af81b9249122cc46f1eb25793617eec69bf21a"
  integrity sha512-cjuJmNDjs6aMijCmSa1g2TNG4Lby/AeU7/02VtpW+SLcZXzOLK2GpN2nLqcFjmhy3B3AoPeQVx7BnyOf681bAw==
  dependencies:
    "@jest/environment" "^29.6.2"
    "@jest/expect" "^29.6.2"
    "@jest/types" "^29.6.1"
    jest-mock "^29.6.2"

"@jest/reporters@^29.6.2":
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/@jest/reporters/-/reporters-29.6.2.tgz#524afe1d76da33d31309c2c4a2c8062d0c48780a"
  integrity sha512-sWtijrvIav8LgfJZlrGCdN0nP2EWbakglJY49J1Y5QihcQLfy7ovyxxjJBRXMNltgt4uPtEcFmIMbVshEDfFWw==
  dependencies:
    "@bcoe/v8-coverage" "^0.2.3"
    "@jest/console" "^29.6.2"
    "@jest/test-result" "^29.6.2"
    "@jest/transform" "^29.6.2"
    "@jest/types" "^29.6.1"
    "@jridgewell/trace-mapping" "^0.3.18"
    "@types/node" "*"
    chalk "^4.0.0"
    collect-v8-coverage "^1.0.0"
    exit "^0.1.2"
    glob "^7.1.3"
    graceful-fs "^4.2.9"
    istanbul-lib-coverage "^3.0.0"
    istanbul-lib-instrument "^5.1.0"
    istanbul-lib-report "^3.0.0"
    istanbul-lib-source-maps "^4.0.0"
    istanbul-reports "^3.1.3"
    jest-message-util "^29.6.2"
    jest-util "^29.6.2"
    jest-worker "^29.6.2"
    slash "^3.0.0"
    string-length "^4.0.1"
    strip-ansi "^6.0.0"
    v8-to-istanbul "^9.0.1"

"@jest/schemas@^29.0.0":
  version "29.0.0"
  resolved "https://registry.yarnpkg.com/@jest/schemas/-/schemas-29.0.0.tgz#5f47f5994dd4ef067fb7b4188ceac45f77fe952a"
  integrity sha512-3Ab5HgYIIAnS0HjqJHQYZS+zXc4tUmTmBH3z83ajI6afXp8X3ZtdLX+nXx+I7LNkJD7uN9LAVhgnjDgZa2z0kA==
  dependencies:
    "@sinclair/typebox" "^0.24.1"

"@jest/schemas@^29.6.0":
  version "29.6.0"
  resolved "https://registry.yarnpkg.com/@jest/schemas/-/schemas-29.6.0.tgz#0f4cb2c8e3dca80c135507ba5635a4fd755b0040"
  integrity sha512-rxLjXyJBTL4LQeJW3aKo0M/+GkCOXsO+8i9Iu7eDb6KwtP65ayoDsitrdPBtujxQ88k4wI2FNYfa6TOGwSn6cQ==
  dependencies:
    "@sinclair/typebox" "^0.27.8"

"@jest/source-map@^29.6.0":
  version "29.6.0"
  resolved "https://registry.yarnpkg.com/@jest/source-map/-/source-map-29.6.0.tgz#bd34a05b5737cb1a99d43e1957020ac8e5b9ddb1"
  integrity sha512-oA+I2SHHQGxDCZpbrsCQSoMLb3Bz547JnM+jUr9qEbuw0vQlWZfpPS7CO9J7XiwKicEz9OFn/IYoLkkiUD7bzA==
  dependencies:
    "@jridgewell/trace-mapping" "^0.3.18"
    callsites "^3.0.0"
    graceful-fs "^4.2.9"

"@jest/test-result@^29.6.2":
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/@jest/test-result/-/test-result-29.6.2.tgz#fdd11583cd1608e4db3114e8f0cce277bf7a32ed"
  integrity sha512-3VKFXzcV42EYhMCsJQURptSqnyjqCGbtLuX5Xxb6Pm6gUf1wIRIl+mandIRGJyWKgNKYF9cnstti6Ls5ekduqw==
  dependencies:
    "@jest/console" "^29.6.2"
    "@jest/types" "^29.6.1"
    "@types/istanbul-lib-coverage" "^2.0.0"
    collect-v8-coverage "^1.0.0"

"@jest/test-sequencer@^29.6.2":
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/@jest/test-sequencer/-/test-sequencer-29.6.2.tgz#585eff07a68dd75225a7eacf319780cb9f6b9bf4"
  integrity sha512-GVYi6PfPwVejO7slw6IDO0qKVum5jtrJ3KoLGbgBWyr2qr4GaxFV6su+ZAjdTX75Sr1DkMFRk09r2ZVa+wtCGw==
  dependencies:
    "@jest/test-result" "^29.6.2"
    graceful-fs "^4.2.9"
    jest-haste-map "^29.6.2"
    slash "^3.0.0"

"@jest/transform@^29.6.2":
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/@jest/transform/-/transform-29.6.2.tgz#522901ebbb211af08835bc3bcdf765ab778094e3"
  integrity sha512-ZqCqEISr58Ce3U+buNFJYUktLJZOggfyvR+bZMaiV1e8B1SIvJbwZMrYz3gx/KAPn9EXmOmN+uB08yLCjWkQQg==
  dependencies:
    "@babel/core" "^7.11.6"
    "@jest/types" "^29.6.1"
    "@jridgewell/trace-mapping" "^0.3.18"
    babel-plugin-istanbul "^6.1.1"
    chalk "^4.0.0"
    convert-source-map "^2.0.0"
    fast-json-stable-stringify "^2.1.0"
    graceful-fs "^4.2.9"
    jest-haste-map "^29.6.2"
    jest-regex-util "^29.4.3"
    jest-util "^29.6.2"
    micromatch "^4.0.4"
    pirates "^4.0.4"
    slash "^3.0.0"
    write-file-atomic "^4.0.2"

"@jest/types@^29.3.1":
  version "29.3.1"
  resolved "https://registry.yarnpkg.com/@jest/types/-/types-29.3.1.tgz#7c5a80777cb13e703aeec6788d044150341147e3"
  integrity sha512-d0S0jmmTpjnhCmNpApgX3jrUZgZ22ivKJRvL2lli5hpCRoNnp1f85r2/wpKfXuYu8E7Jjh1hGfhPyup1NM5AmA==
  dependencies:
    "@jest/schemas" "^29.0.0"
    "@types/istanbul-lib-coverage" "^2.0.0"
    "@types/istanbul-reports" "^3.0.0"
    "@types/node" "*"
    "@types/yargs" "^17.0.8"
    chalk "^4.0.0"

"@jest/types@^29.6.1":
  version "29.6.1"
  resolved "https://registry.yarnpkg.com/@jest/types/-/types-29.6.1.tgz#ae79080278acff0a6af5eb49d063385aaa897bf2"
  integrity sha512-tPKQNMPuXgvdOn2/Lg9HNfUvjYVGolt04Hp03f5hAk878uwOLikN+JzeLY0HcVgKgFl9Hs3EIqpu3WX27XNhnw==
  dependencies:
    "@jest/schemas" "^29.6.0"
    "@types/istanbul-lib-coverage" "^2.0.0"
    "@types/istanbul-reports" "^3.0.0"
    "@types/node" "*"
    "@types/yargs" "^17.0.8"
    chalk "^4.0.0"

"@jridgewell/gen-mapping@^0.1.0":
  version "0.1.1"
  resolved "https://registry.yarnpkg.com/@jridgewell/gen-mapping/-/gen-mapping-0.1.1.tgz#e5d2e450306a9491e3bd77e323e38d7aff315996"
  integrity sha512-sQXCasFk+U8lWYEe66WxRDOE9PjVz4vSM51fTu3Hw+ClTpUSQb718772vH3pyS5pShp6lvQM7SxgIDXXXmOX7w==
  dependencies:
    "@jridgewell/set-array" "^1.0.0"
    "@jridgewell/sourcemap-codec" "^1.4.10"

"@jridgewell/gen-mapping@^0.3.0", "@jridgewell/gen-mapping@^0.3.2":
  version "0.3.2"
  resolved "https://registry.yarnpkg.com/@jridgewell/gen-mapping/-/gen-mapping-0.3.2.tgz#c1aedc61e853f2bb9f5dfe6d4442d3b565b253b9"
  integrity sha512-mh65xKQAzI6iBcFzwv28KVWSmCkdRBWoOh+bYQGW3+6OZvbbN3TqMGo5hqYxQniRcH9F2VZIoJCm4pa3BPDK/A==
  dependencies:
    "@jridgewell/set-array" "^1.0.1"
    "@jridgewell/sourcemap-codec" "^1.4.10"
    "@jridgewell/trace-mapping" "^0.3.9"

"@jridgewell/resolve-uri@3.1.0", "@jridgewell/resolve-uri@^3.0.3":
  version "3.1.0"
  resolved "https://registry.yarnpkg.com/@jridgewell/resolve-uri/-/resolve-uri-3.1.0.tgz#2203b118c157721addfe69d47b70465463066d78"
  integrity sha512-F2msla3tad+Mfht5cJq7LSXcdudKTWCVYUgw6pLFOOHSTtZlj6SWNYAp+AhuqLmWdBO2X5hPrLcu8cVP8fy28w==

"@jridgewell/set-array@^1.0.0", "@jridgewell/set-array@^1.0.1":
  version "1.1.2"
  resolved "https://registry.yarnpkg.com/@jridgewell/set-array/-/set-array-1.1.2.tgz#7c6cf998d6d20b914c0a55a91ae928ff25965e72"
  integrity sha512-xnkseuNADM0gt2bs+BvhO0p78Mk762YnZdsuzFV018NoG1Sj1SCQvpSqa7XUaTam5vAGasABV9qXASMKnFMwMw==

"@jridgewell/source-map@^0.3.3":
  version "0.3.5"
  resolved "https://registry.yarnpkg.com/@jridgewell/source-map/-/source-map-0.3.5.tgz#a3bb4d5c6825aab0d281268f47f6ad5853431e91"
  integrity sha512-UTYAUj/wviwdsMfzoSJspJxbkH5o1snzwX0//0ENX1u/55kkZZkcTZP6u9bwKGkv+dkk9at4m1Cpt0uY80kcpQ==
  dependencies:
    "@jridgewell/gen-mapping" "^0.3.0"
    "@jridgewell/trace-mapping" "^0.3.9"

"@jridgewell/sourcemap-codec@1.4.14", "@jridgewell/sourcemap-codec@^1.4.10":
  version "1.4.14"
  resolved "https://registry.yarnpkg.com/@jridgewell/sourcemap-codec/-/sourcemap-codec-1.4.14.tgz#add4c98d341472a289190b424efbdb096991bb24"
  integrity sha512-XPSJHWmi394fuUuzDnGz1wiKqWfo1yXecHQMRf2l6hztTO+nPru658AyDngaBe7isIxEkRsPR3FZh+s7iVa4Uw==

"@jridgewell/sourcemap-codec@^1.4.13":
  version "1.4.15"
  resolved "https://registry.yarnpkg.com/@jridgewell/sourcemap-codec/-/sourcemap-codec-1.4.15.tgz#d7c6e6755c78567a951e04ab52ef0fd26de59f32"
  integrity sha512-eF2rxCRulEKXHTRiDrDy6erMYWqNw4LPdQ8UQA4huuxaQsVeRPFl2oM8oDGxMFhJUWZf9McpLtJasDDZb/Bpeg==

"@jridgewell/trace-mapping@0.3.9":
  version "0.3.9"
  resolved "https://registry.yarnpkg.com/@jridgewell/trace-mapping/-/trace-mapping-0.3.9.tgz#6534fd5933a53ba7cbf3a17615e273a0d1273ff9"
  integrity sha512-3Belt6tdc8bPgAtbcmdtNJlirVoTmEb5e2gC94PnkwEW9jI6CAHUeoG85tjWP5WquqfavoMtMwiG4P926ZKKuQ==
  dependencies:
    "@jridgewell/resolve-uri" "^3.0.3"
    "@jridgewell/sourcemap-codec" "^1.4.10"

"@jridgewell/trace-mapping@^0.3.12", "@jridgewell/trace-mapping@^0.3.9":
  version "0.3.17"
  resolved "https://registry.yarnpkg.com/@jridgewell/trace-mapping/-/trace-mapping-0.3.17.tgz#793041277af9073b0951a7fe0f0d8c4c98c36985"
  integrity sha512-MCNzAp77qzKca9+W/+I0+sEpaUnZoeasnghNeVc41VZCEKaCH73Vq3BZZ/SzWIgrqE4H4ceI+p+b6C0mHf9T4g==
  dependencies:
    "@jridgewell/resolve-uri" "3.1.0"
    "@jridgewell/sourcemap-codec" "1.4.14"

"@jridgewell/trace-mapping@^0.3.17", "@jridgewell/trace-mapping@^0.3.18":
  version "0.3.18"
  resolved "https://registry.yarnpkg.com/@jridgewell/trace-mapping/-/trace-mapping-0.3.18.tgz#25783b2086daf6ff1dcb53c9249ae480e4dd4cd6"
  integrity sha512-w+niJYzMHdd7USdiH2U6869nqhD2nbfZXND5Yp93qIbEmnDNk7PD48o+YchRVpzMU7M6jVCbenTR7PA1FLQ9pA==
  dependencies:
    "@jridgewell/resolve-uri" "3.1.0"
    "@jridgewell/sourcemap-codec" "1.4.14"

"@lukeed/csprng@^1.0.0":
  version "1.1.0"
  resolved "https://registry.yarnpkg.com/@lukeed/csprng/-/csprng-1.1.0.tgz#1e3e4bd05c1cc7a0b2ddbd8a03f39f6e4b5e6cfe"
  integrity sha512-Z7C/xXCiGWsg0KuKsHTKJxbWhpI3Vs5GwLfOean7MGyVFGqdRgBbAjOCh6u4bbjPc/8MJ2pZmK/0DLdCbivLDA==

"@nestjs/cli@^10.1.11":
  version "10.1.11"
  resolved "https://registry.yarnpkg.com/@nestjs/cli/-/cli-10.1.11.tgz#1e67131a7f88ac6fcc5d2afaa237352bf2de4451"
  integrity sha512-ORkpVFQvcPYtvkLfa0I9dMSPIppkqTOyLqPvJV0wiZofp8iR1+VEVzJVi+PMj53gOkly8TV9+6iy/dBA5Ssrog==
  dependencies:
    "@angular-devkit/core" "16.1.4"
    "@angular-devkit/schematics" "16.1.4"
    "@angular-devkit/schematics-cli" "16.1.4"
    "@nestjs/schematics" "^10.0.1"
    chalk "4.1.2"
    chokidar "3.5.3"
    cli-table3 "0.6.3"
    commander "4.1.1"
    fork-ts-checker-webpack-plugin "8.0.0"
    inquirer "8.2.5"
    node-emoji "1.11.0"
    ora "5.4.1"
    os-name "4.0.1"
    rimraf "4.4.1"
    shelljs "0.8.5"
    source-map-support "0.5.21"
    tree-kill "1.2.2"
    tsconfig-paths "4.2.0"
    tsconfig-paths-webpack-plugin "4.1.0"
    typescript "5.1.6"
    webpack "5.88.1"
    webpack-node-externals "3.0.0"

"@nestjs/common@^10.1.3":
  version "10.1.3"
  resolved "https://registry.yarnpkg.com/@nestjs/common/-/common-10.1.3.tgz#7f80d7c011e94bfb2177100cc8862e4fc65a6630"
  integrity sha512-xSyXBwgcmiFwQqek1Urw/AL3pRPq9bp/tpgfTxmnJg3gP6XNUbx1fDr0de50irXgZYzFKfVFo9ptC3b2du5YKA==
  dependencies:
    uid "2.0.2"
    iterare "1.2.1"
    tslib "2.6.1"

"@nestjs/config@^3.0.0":
  version "3.0.0"
  resolved "https://registry.yarnpkg.com/@nestjs/config/-/config-3.0.0.tgz#154ddbaf2b97201a94a3c84757c352c405718cb4"
  integrity sha512-fzASk1Uv6AjdE6uA1na8zpqRCXAhRpcfgpCVv3SAKlgJ3VR3bEjcI4G17WHLgLBsmPzI1ofdkSI451WLD1F1Rw==
  dependencies:
    dotenv "16.1.4"
    dotenv-expand "10.0.0"
    lodash "4.17.21"
    uuid "9.0.0"

"@nestjs/core@^10.1.3":
  version "10.1.3"
  resolved "https://registry.yarnpkg.com/@nestjs/core/-/core-10.1.3.tgz#6f74ac04695847976dd84836d8063624a793c127"
  integrity sha512-VzK54TuacC3Vmq3b5xTyMVTlDNJeKbjpKfV9fNqm4TbIBm8ZPo3FC0osJAbAK4XwbVvv2Flq1yA3CutasupVjw==
  dependencies:
    uid "2.0.2"
    "@nuxtjs/opencollective" "0.3.2"
    fast-safe-stringify "2.1.1"
    iterare "1.2.1"
    path-to-regexp "3.2.0"
    tslib "2.6.1"

"@nestjs/mapped-types@2.0.2":
  version "2.0.2"
  resolved "https://registry.yarnpkg.com/@nestjs/mapped-types/-/mapped-types-2.0.2.tgz#c8a090a8d22145b85ed977414c158534210f2e4f"
  integrity sha512-V0izw6tWs6fTp9+KiiPUbGHWALy563Frn8X6Bm87ANLRuE46iuBMD5acKBDP5lKL/75QFvrzSJT7HkCbB0jTpg==

"@nestjs/platform-express@^10.1.3":
  version "10.1.3"
  resolved "https://registry.yarnpkg.com/@nestjs/platform-express/-/platform-express-10.1.3.tgz#d1f644e86f2bc45c7529b9eed7669613f4392e99"
  integrity sha512-RSf7ooCrxiWJlWl3CLfpaYmAf3U0tRsN7pJakujWdvzVJU2EzVZTLcy1MtnSg/HBm9/Rvg98VI5QI6oOhOpt+A==
  dependencies:
    body-parser "1.20.2"
    cors "2.8.5"
    express "4.18.2"
    multer "1.4.4-lts.1"
    tslib "2.6.1"

"@nestjs/schematics@^10.0.1":
  version "10.0.1"
  resolved "https://registry.yarnpkg.com/@nestjs/schematics/-/schematics-10.0.1.tgz#c44f763186de621ec8b3974891bbb27d3c6df04b"
  integrity sha512-buxpYtSwOmWyf0nUJWJCkCkYITwbOfIEKHTnGS7sDbcfaajrOFXb5pPAGD2E1CUb3C1+NkQIURPKzs0IouZTQg==
  dependencies:
    "@angular-devkit/core" "16.1.0"
    "@angular-devkit/schematics" "16.1.0"
    comment-json "4.2.3"
    jsonc-parser "3.2.0"
    pluralize "8.0.0"

"@nestjs/swagger@^7.1.6":
  version "7.1.6"
  resolved "https://registry.yarnpkg.com/@nestjs/swagger/-/swagger-7.1.6.tgz#3e4cc28195d36d7f2e023c4b6b761c3f181189e2"
  integrity sha512-YK5MSIuI2s76tg5W+fZSEVAmnlRe3ZVbb7/AYKi1Cs7exuzNjMgWIsnYxY2VCXhWaiT/ykeTFS9wcBdI54LeFA==
  dependencies:
    "@nestjs/mapped-types" "2.0.2"
    js-yaml "4.1.0"
    lodash "4.17.21"
    path-to-regexp "3.2.0"
    swagger-ui-dist "5.1.0"

"@nestjs/testing@^10.1.3":
  version "10.1.3"
  resolved "https://registry.yarnpkg.com/@nestjs/testing/-/testing-10.1.3.tgz#596a1dc580373b3b0b070ac73bf70e45f80197dd"
  integrity sha512-zMrO9xLPYnKtC6q1diWubuMshIp0v2aGHa58jcIfZaAlJlU/6RKsgCOiFQ42aFzxUEBRWF0LBF0aiwt04LKMyQ==
  dependencies:
    tslib "2.6.1"

"@next/env@13.4.12":
  version "13.4.12"
  resolved "https://registry.yarnpkg.com/@next/env/-/env-13.4.12.tgz#0b88115ab817f178bf9dc0c5e7b367277595b58d"
  integrity sha512-RmHanbV21saP/6OEPBJ7yJMuys68cIf8OBBWd7+uj40LdpmswVAwe1uzeuFyUsd6SfeITWT3XnQfn6wULeKwDQ==

"@next/eslint-plugin-next@13.4.12":
  version "13.4.12"
  resolved "https://registry.yarnpkg.com/@next/eslint-plugin-next/-/eslint-plugin-next-13.4.12.tgz#e75c4fedd0324d4f8fa8be2eb446270a462d3092"
  integrity sha512-6rhK9CdxEgj/j1qvXIyLTWEaeFv7zOK8yJMulz3Owel0uek0U9MJCGzmKgYxM3aAUBo3gKeywCZKyQnJKto60A==
  dependencies:
    glob "7.1.7"

"@next/swc-darwin-arm64@13.4.12":
  version "13.4.12"
  resolved "https://registry.yarnpkg.com/@next/swc-darwin-arm64/-/swc-darwin-arm64-13.4.12.tgz#326c830b111de8a1a51ac0cbc3bcb157c4c4f92c"
  integrity sha512-deUrbCXTMZ6ZhbOoloqecnUeNpUOupi8SE2tx4jPfNS9uyUR9zK4iXBvH65opVcA/9F5I/p8vDXSYbUlbmBjZg==

"@next/swc-darwin-x64@13.4.12":
  version "13.4.12"
  resolved "https://registry.yarnpkg.com/@next/swc-darwin-x64/-/swc-darwin-x64-13.4.12.tgz#dd5c49fc092a8ffe4f30b7aa9bf6c5d2e40bbfa1"
  integrity sha512-WRvH7RxgRHlC1yb5oG0ZLx8F7uci9AivM5/HGGv9ZyG2Als8Ij64GC3d+mQ5sJhWjusyU6T6V1WKTUoTmOB0zQ==

"@next/swc-linux-arm64-gnu@13.4.12":
  version "13.4.12"
  resolved "https://registry.yarnpkg.com/@next/swc-linux-arm64-gnu/-/swc-linux-arm64-gnu-13.4.12.tgz#816cbe9d26ce4670ea99d95b66041e483ed122d6"
  integrity sha512-YEKracAWuxp54tKiAvvq73PUs9lok57cc8meYRibTWe/VdPB2vLgkTVWFcw31YDuRXdEhdX0fWS6Q+ESBhnEig==

"@next/swc-linux-arm64-musl@13.4.12":
  version "13.4.12"
  resolved "https://registry.yarnpkg.com/@next/swc-linux-arm64-musl/-/swc-linux-arm64-musl-13.4.12.tgz#670c8aee221628f65e5b299ee84db746e6c778b0"
  integrity sha512-LhJR7/RAjdHJ2Isl2pgc/JaoxNk0KtBgkVpiDJPVExVWA1c6gzY57+3zWuxuyWzTG+fhLZo2Y80pLXgIJv7g3g==

"@next/swc-linux-x64-gnu@13.4.12":
  version "13.4.12"
  resolved "https://registry.yarnpkg.com/@next/swc-linux-x64-gnu/-/swc-linux-x64-gnu-13.4.12.tgz#54c64e689f007ae463698dddc1c6637491c99cb4"
  integrity sha512-1DWLL/B9nBNiQRng+1aqs3OaZcxC16Nf+mOnpcrZZSdyKHek3WQh6j/fkbukObgNGwmCoVevLUa/p3UFTTqgqg==

"@next/swc-linux-x64-musl@13.4.12":
  version "13.4.12"
  resolved "https://registry.yarnpkg.com/@next/swc-linux-x64-musl/-/swc-linux-x64-musl-13.4.12.tgz#9cbddf4e542ef3d32284e0c36ce102facc015f8b"
  integrity sha512-kEAJmgYFhp0VL+eRWmUkVxLVunn7oL9Mdue/FS8yzRBVj7Z0AnIrHpTIeIUl1bbdQq1VaoOztnKicAjfkLTRCQ==

"@next/swc-win32-arm64-msvc@13.4.12":
  version "13.4.12"
  resolved "https://registry.yarnpkg.com/@next/swc-win32-arm64-msvc/-/swc-win32-arm64-msvc-13.4.12.tgz#3467a4b25429ccf49fd416388c9d19c80a4f6465"
  integrity sha512-GMLuL/loR6yIIRTnPRY6UGbLL9MBdw2anxkOnANxvLvsml4F0HNIgvnU3Ej4BjbqMTNjD4hcPFdlEow4XHPdZA==

"@next/swc-win32-ia32-msvc@13.4.12":
  version "13.4.12"
  resolved "https://registry.yarnpkg.com/@next/swc-win32-ia32-msvc/-/swc-win32-ia32-msvc-13.4.12.tgz#73494cd167191946833c680b28d6a42435d383a8"
  integrity sha512-PhgNqN2Vnkm7XaMdRmmX0ZSwZXQAtamBVSa9A/V1dfKQCV1rjIZeiy/dbBnVYGdj63ANfsOR/30XpxP71W0eww==

"@next/swc-win32-x64-msvc@13.4.12":
  version "13.4.12"
  resolved "https://registry.yarnpkg.com/@next/swc-win32-x64-msvc/-/swc-win32-x64-msvc-13.4.12.tgz#4a497edc4e8c5ee3c3eb27cf0eb39dfadff70874"
  integrity sha512-Z+56e/Ljt0bUs+T+jPjhFyxYBcdY2RIq9ELFU+qAMQMteHo7ymbV7CKmlcX59RI9C4YzN8PgMgLyAoi916b5HA==

"@nodelib/fs.scandir@2.1.5":
  version "2.1.5"
  resolved "https://registry.yarnpkg.com/@nodelib/fs.scandir/-/fs.scandir-2.1.5.tgz#7619c2eb21b25483f6d167548b4cfd5a7488c3d5"
  integrity sha512-vq24Bq3ym5HEQm2NKCr3yXDwjc7vTsEThRDnkp2DK9p1uqLR+DHurm/NOTo0KG7HYHU7eppKZj3MyqYuMBf62g==
  dependencies:
    "@nodelib/fs.stat" "2.0.5"
    run-parallel "^1.1.9"

"@nodelib/fs.stat@2.0.5", "@nodelib/fs.stat@^2.0.2":
  version "2.0.5"
  resolved "https://registry.yarnpkg.com/@nodelib/fs.stat/-/fs.stat-2.0.5.tgz#5bd262af94e9d25bd1e71b05deed44876a222e8b"
  integrity sha512-RkhPPp2zrqDAQA/2jNhnztcPAlv64XdhIp7a7454A5ovI7Bukxgt7MX7udwAu3zg1DcpPU0rz3VV1SeaqvY4+A==

"@nodelib/fs.walk@^1.2.3", "@nodelib/fs.walk@^1.2.8":
  version "1.2.8"
  resolved "https://registry.yarnpkg.com/@nodelib/fs.walk/-/fs.walk-1.2.8.tgz#e95737e8bb6746ddedf69c556953494f196fe69a"
  integrity sha512-oGB+UxlgWcgQkgwo8GcEGwemoTFt3FIO9ababBmaGwXIoBKZ+GTy0pP185beGg7Llih/NSHSV2XAs1lnznocSg==
  dependencies:
    "@nodelib/fs.scandir" "2.1.5"
    fastq "^1.6.0"

"@nuxtjs/opencollective@0.3.2":
  version "0.3.2"
  resolved "https://registry.yarnpkg.com/@nuxtjs/opencollective/-/opencollective-0.3.2.tgz#620ce1044f7ac77185e825e1936115bb38e2681c"
  integrity sha512-um0xL3fO7Mf4fDxcqx9KryrB7zgRM5JSlvGN5AGkP6JLM5XEKyjeAiPbNxdXVXQ16isuAhYpvP88NgL2BGd6aA==
  dependencies:
    chalk "^4.1.0"
    consola "^2.15.0"
    node-fetch "^2.6.1"

"@pkgjs/parseargs@^0.11.0":
  version "0.11.0"
  resolved "https://registry.yarnpkg.com/@pkgjs/parseargs/-/parseargs-0.11.0.tgz#a77ea742fab25775145434eb1d2328cf5013ac33"
  integrity sha512-+1VkjdD0QBLPodGrJUeqarH8VAIvQODIbwh9XpP5Syisf7YoQgsJKPNFoqqLQlu+VQ/tVSshMR6loPMn8U+dPg==

"@pkgr/utils@^2.3.1":
  version "2.3.1"
  resolved "https://registry.yarnpkg.com/@pkgr/utils/-/utils-2.3.1.tgz#0a9b06ffddee364d6642b3cd562ca76f55b34a03"
  integrity sha512-wfzX8kc1PMyUILA+1Z/EqoE4UCXGy0iRGMhPwdfae1+f0OXlLqCk+By+aMzgJBzR9AzS4CDizioG6Ss1gvAFJw==
  dependencies:
    cross-spawn "^7.0.3"
    is-glob "^4.0.3"
    open "^8.4.0"
    picocolors "^1.0.0"
    tiny-glob "^0.2.9"
    tslib "^2.4.0"

"@prisma/client@^5.1.0":
  version "5.1.0"
  resolved "https://registry.yarnpkg.com/@prisma/client/-/client-5.1.0.tgz#6c378a2b7ecdeab6b3f24179484980257beac25d"
  integrity sha512-aIxuXlH3p3Vy91buodQhYgAD9m0yuxJzpXMhc1ejQ/WN3pNNWzBA0iDcBObLq8DMdszcXmoLAk3hiRq/ZwBsOw==
  dependencies:
    "@prisma/engines-version" "5.1.0-28.a9b7003df90aa623086e4d6f4e43c72468e6339b"

"@prisma/engines-version@5.1.0-28.a9b7003df90aa623086e4d6f4e43c72468e6339b":
  version "5.1.0-28.a9b7003df90aa623086e4d6f4e43c72468e6339b"
  resolved "https://registry.yarnpkg.com/@prisma/engines-version/-/engines-version-5.1.0-28.a9b7003df90aa623086e4d6f4e43c72468e6339b.tgz#0a6400d709a64cc43b076f0567715f459fadd5bc"
  integrity sha512-jTwE2oy1yjICmTfnCR0ASIpuMZXZ18sUzQXB7V0RMbrM9OlcmbUwXPuYhnxXuWN8XwRmujeIhsXs/Zeh+fjPOQ==

"@prisma/engines@5.1.0":
  version "5.1.0"
  resolved "https://registry.yarnpkg.com/@prisma/engines/-/engines-5.1.0.tgz#4ccf7f344eaeee08ca1e4a1bb2dc14e36ff1d5ec"
  integrity sha512-HqaFsnPmZOdMWkPq6tT2eTVTQyaAXEDdKszcZ4yc7DGMBIYRP6j/zAJTtZUG9SsMV8FaucdL5vRyxY/p5Ni28g==

"@reduxjs/toolkit@^1.9.5":
  version "1.9.5"
  resolved "https://registry.yarnpkg.com/@reduxjs/toolkit/-/toolkit-1.9.5.tgz#d3987849c24189ca483baa7aa59386c8e52077c4"
  integrity sha512-Rt97jHmfTeaxL4swLRNPD/zV4OxTes4la07Xc4hetpUW/vc75t5m1ANyxG6ymnEQ2FsLQsoMlYB2vV1sO3m8tQ==
  dependencies:
    immer "^9.0.21"
    redux "^4.2.1"
    redux-thunk "^2.4.2"
    reselect "^4.1.8"

"@rushstack/eslint-patch@^1.1.3":
  version "1.2.0"
  resolved "https://registry.yarnpkg.com/@rushstack/eslint-patch/-/eslint-patch-1.2.0.tgz#8be36a1f66f3265389e90b5f9c9962146758f728"
  integrity sha512-sXo/qW2/pAcmT43VoRKOJbDOfV3cYpq3szSVfIThQXNt+E4DfKj361vaAt3c88U5tPUxzEswam7GW48PJqtKAg==

"@sideway/address@^4.1.3":
  version "4.1.4"
  resolved "https://registry.yarnpkg.com/@sideway/address/-/address-4.1.4.tgz#03dccebc6ea47fdc226f7d3d1ad512955d4783f0"
  integrity sha512-7vwq+rOHVWjyXxVlR76Agnvhy8I9rpzjosTESvmhNeXOXdZZB15Fl+TI9x1SiHZH5Jv2wTGduSxFDIaq0m3DUw==
  dependencies:
    "@hapi/hoek" "^9.0.0"

"@sideway/formula@^3.0.1":
  version "3.0.1"
  resolved "https://registry.yarnpkg.com/@sideway/formula/-/formula-3.0.1.tgz#80fcbcbaf7ce031e0ef2dd29b1bfc7c3f583611f"
  integrity sha512-/poHZJJVjx3L+zVD6g9KgHfYnb443oi7wLu/XKojDviHy6HOEOA6z1Trk5aR1dGcmPenJEgb2sK2I80LeS3MIg==

"@sideway/pinpoint@^2.0.0":
  version "2.0.0"
  resolved "https://registry.yarnpkg.com/@sideway/pinpoint/-/pinpoint-2.0.0.tgz#cff8ffadc372ad29fd3f78277aeb29e632cc70df"
  integrity sha512-RNiOoTPkptFtSVzQevY/yWtZwf/RxyVnPy/OcA9HBM3MlGDnBEYL5B41H0MTn0Uec8Hi+2qUtTfG2WWZBmMejQ==

"@sinclair/typebox@^0.24.1":
  version "0.24.51"
  resolved "https://registry.yarnpkg.com/@sinclair/typebox/-/typebox-0.24.51.tgz#645f33fe4e02defe26f2f5c0410e1c094eac7f5f"
  integrity sha512-1P1OROm/rdubP5aFDSZQILU0vrLCJ4fvHt6EoqHEM+2D/G5MK3bIaymUKLit8Js9gbns5UyJnkP/TZROLw4tUA==

"@sinclair/typebox@^0.27.8":
  version "0.27.8"
  resolved "https://registry.yarnpkg.com/@sinclair/typebox/-/typebox-0.27.8.tgz#6667fac16c436b5434a387a34dedb013198f6e6e"
  integrity sha512-+Fj43pSMwJs4KRrH/938Uf+uAELIgVBmQzg/q1YG10djyfA3TnrU8N8XzqCh/okZdszqBQTZf96idMfE5lnwTA==

"@sinonjs/commons@^3.0.0":
  version "3.0.0"
  resolved "https://registry.yarnpkg.com/@sinonjs/commons/-/commons-3.0.0.tgz#beb434fe875d965265e04722ccfc21df7f755d72"
  integrity sha512-jXBtWAF4vmdNmZgD5FoKsVLv3rPgDnLgPbU84LIJ3otV44vJlDRokVng5v8NFJdCf/da9legHcKaRuZs4L7faA==
  dependencies:
    type-detect "4.0.8"

"@sinonjs/fake-timers@^10.0.2":
  version "10.3.0"
  resolved "https://registry.yarnpkg.com/@sinonjs/fake-timers/-/fake-timers-10.3.0.tgz#55fdff1ecab9f354019129daf4df0dd4d923ea66"
  integrity sha512-V4BG07kuYSUkTCSBHG8G8TNhM+F19jXFWnQtzj+we8DrkpSBCee9Z3Ms8yiGer/dlmhe35/Xdgyo3/0rQKg7YA==
  dependencies:
    "@sinonjs/commons" "^3.0.0"

"@swc/helpers@0.5.1":
  version "0.5.1"
  resolved "https://registry.yarnpkg.com/@swc/helpers/-/helpers-0.5.1.tgz#e9031491aa3f26bfcc974a67f48bd456c8a5357a"
  integrity sha512-sJ902EfIzn1Fa+qYmjdQqh8tPsoxyBz+8yBKC2HKUxyezKJFwPGOn7pv4WY6QuQW//ySQi5lJjA/ZT9sNWWNTg==
  dependencies:
    tslib "^2.4.0"

"@testing-library/dom@^9.0.0":
  version "9.3.1"
  resolved "https://registry.yarnpkg.com/@testing-library/dom/-/dom-9.3.1.tgz#8094f560e9389fb973fe957af41bf766937a9ee9"
  integrity sha512-0DGPd9AR3+iDTjGoMpxIkAsUihHZ3Ai6CneU6bRRrffXMgzCdlNk43jTrD2/5LT6CBb3MWTP8v510JzYtahD2w==
  dependencies:
    "@babel/code-frame" "^7.10.4"
    "@babel/runtime" "^7.12.5"
    "@types/aria-query" "^5.0.1"
    aria-query "5.1.3"
    chalk "^4.1.0"
    dom-accessibility-api "^0.5.9"
    lz-string "^1.5.0"
    pretty-format "^27.0.2"

"@testing-library/jest-dom@^5.17.0":
  version "5.17.0"
  resolved "https://registry.yarnpkg.com/@testing-library/jest-dom/-/jest-dom-5.17.0.tgz#5e97c8f9a15ccf4656da00fecab505728de81e0c"
  integrity sha512-ynmNeT7asXyH3aSVv4vvX4Rb+0qjOhdNHnO/3vuZNqPmhDpV/+rCSGwQ7bLcmU2cJ4dvoheIO85LQj0IbJHEtg==
  dependencies:
    "@adobe/css-tools" "^4.0.1"
    "@babel/runtime" "^7.9.2"
    "@types/testing-library__jest-dom" "^5.9.1"
    aria-query "^5.0.0"
    chalk "^3.0.0"
    css.escape "^1.5.1"
    dom-accessibility-api "^0.5.6"
    lodash "^4.17.15"
    redent "^3.0.0"

"@testing-library/react@^14.0.0":
  version "14.0.0"
  resolved "https://registry.yarnpkg.com/@testing-library/react/-/react-14.0.0.tgz#59030392a6792450b9ab8e67aea5f3cc18d6347c"
  integrity sha512-S04gSNJbYE30TlIMLTzv6QCTzt9AqIF5y6s6SzVFILNcNvbV/jU96GeiTPillGQo+Ny64M/5PV7klNYYgv5Dfg==
  dependencies:
    "@babel/runtime" "^7.12.5"
    "@testing-library/dom" "^9.0.0"
    "@types/react-dom" "^18.0.0"

"@testing-library/user-event@14.4.3":
  version "14.4.3"
  resolved "https://registry.yarnpkg.com/@testing-library/user-event/-/user-event-14.4.3.tgz#af975e367743fa91989cd666666aec31a8f50591"
  integrity sha512-kCUc5MEwaEMakkO5x7aoD+DLi02ehmEM2QCGWvNqAS1dV/fAvORWEjnjsEIvml59M7Y5kCkWN6fCCyPOe8OL6Q==

"@tootallnate/once@2":
  version "2.0.0"
  resolved "https://registry.yarnpkg.com/@tootallnate/once/-/once-2.0.0.tgz#f544a148d3ab35801c1f633a7441fd87c2e484bf"
  integrity sha512-XCuKFP5PS55gnMVu3dty8KPatLqUoy/ZYzDzAGCQ8JNFCkLXzmI7vNHCR+XpbZaMWQK/vQubr7PkYq8g470J/A==

"@tsconfig/node10@^1.0.7":
  version "1.0.9"
  resolved "https://registry.yarnpkg.com/@tsconfig/node10/-/node10-1.0.9.tgz#df4907fc07a886922637b15e02d4cebc4c0021b2"
  integrity sha512-jNsYVVxU8v5g43Erja32laIDHXeoNvFEpX33OK4d6hljo3jDhCBDhx5dhCCTMWUojscpAagGiRkBKxpdl9fxqA==

"@tsconfig/node12@^1.0.7":
  version "1.0.11"
  resolved "https://registry.yarnpkg.com/@tsconfig/node12/-/node12-1.0.11.tgz#ee3def1f27d9ed66dac6e46a295cffb0152e058d"
  integrity sha512-cqefuRsh12pWyGsIoBKJA9luFu3mRxCA+ORZvA4ktLSzIuCUtWVxGIuXigEwO5/ywWFMZ2QEGKWvkZG1zDMTag==

"@tsconfig/node14@^1.0.0":
  version "1.0.3"
  resolved "https://registry.yarnpkg.com/@tsconfig/node14/-/node14-1.0.3.tgz#e4386316284f00b98435bf40f72f75a09dabf6c1"
  integrity sha512-ysT8mhdixWK6Hw3i1V2AeRqZ5WfXg1G43mqoYlM2nc6388Fq5jcXyr5mRsqViLx/GJYdoL0bfXD8nmF+Zn/Iow==

"@tsconfig/node16@^1.0.2":
  version "1.0.3"
  resolved "https://registry.yarnpkg.com/@tsconfig/node16/-/node16-1.0.3.tgz#472eaab5f15c1ffdd7f8628bd4c4f753995ec79e"
  integrity sha512-yOlFc+7UtL/89t2ZhjPvvB/DeAr3r+Dq58IgzsFkOAvVC6NMJXmCGjbptdXdR9qsX7pKcTL+s87FtYREi2dEEQ==

"@types/aria-query@^5.0.1":
  version "5.0.1"
  resolved "https://registry.yarnpkg.com/@types/aria-query/-/aria-query-5.0.1.tgz#3286741fb8f1e1580ac28784add4c7a1d49bdfbc"
  integrity sha512-XTIieEY+gvJ39ChLcB4If5zHtPxt3Syj5rgZR+e1ctpmK8NjPf0zFqsz4JpLJT0xla9GFDKjy8Cpu331nrmE1Q==

"@types/babel__core@^7.1.14":
  version "7.1.20"
  resolved "https://registry.yarnpkg.com/@types/babel__core/-/babel__core-7.1.20.tgz#e168cdd612c92a2d335029ed62ac94c95b362359"
  integrity sha512-PVb6Bg2QuscZ30FvOU7z4guG6c926D9YRvOxEaelzndpMsvP+YM74Q/dAFASpg2l6+XLalxSGxcq/lrgYWZtyQ==
  dependencies:
    "@babel/parser" "^7.1.0"
    "@babel/types" "^7.0.0"
    "@types/babel__generator" "*"
    "@types/babel__template" "*"
    "@types/babel__traverse" "*"

"@types/babel__generator@*":
  version "7.6.4"
  resolved "https://registry.yarnpkg.com/@types/babel__generator/-/babel__generator-7.6.4.tgz#1f20ce4c5b1990b37900b63f050182d28c2439b7"
  integrity sha512-tFkciB9j2K755yrTALxD44McOrk+gfpIpvC3sxHjRawj6PfnQxrse4Clq5y/Rq+G3mrBurMax/lG8Qn2t9mSsg==
  dependencies:
    "@babel/types" "^7.0.0"

"@types/babel__template@*":
  version "7.4.1"
  resolved "https://registry.yarnpkg.com/@types/babel__template/-/babel__template-7.4.1.tgz#3d1a48fd9d6c0edfd56f2ff578daed48f36c8969"
  integrity sha512-azBFKemX6kMg5Io+/rdGT0dkGreboUVR0Cdm3fz9QJWpaQGJRQXl7C+6hOTCZcMll7KFyEQpgbYI2lHdsS4U7g==
  dependencies:
    "@babel/parser" "^7.1.0"
    "@babel/types" "^7.0.0"

"@types/babel__traverse@*", "@types/babel__traverse@^7.0.6":
  version "7.18.3"
  resolved "https://registry.yarnpkg.com/@types/babel__traverse/-/babel__traverse-7.18.3.tgz#dfc508a85781e5698d5b33443416b6268c4b3e8d"
  integrity sha512-1kbcJ40lLB7MHsj39U4Sh1uTd2E7rLEa79kmDpI6cy+XiXsteB3POdQomoq4FxszMrO3ZYchkhYJw7A2862b3w==
  dependencies:
    "@babel/types" "^7.3.0"

"@types/body-parser@*":
  version "1.19.2"
  resolved "https://registry.yarnpkg.com/@types/body-parser/-/body-parser-1.19.2.tgz#aea2059e28b7658639081347ac4fab3de166e6f0"
  integrity sha512-ALYone6pm6QmwZoAgeyNksccT9Q4AWZQ6PvfwR37GT6r6FWUPguq6sUmNGSMV2Wr761oQoBxwGGa6DR5o1DC9g==
  dependencies:
    "@types/connect" "*"
    "@types/node" "*"

"@types/connect@*":
  version "3.4.35"
  resolved "https://registry.yarnpkg.com/@types/connect/-/connect-3.4.35.tgz#5fcf6ae445e4021d1fc2219a4873cc73a3bb2ad1"
  integrity sha512-cdeYyv4KWoEgpBISTxWvqYsVy444DOqehiF3fM3ne10AmJ62RSyNkUnxMJXHQWRQQX2eR94m5y1IZyDwBjV9FQ==
  dependencies:
    "@types/node" "*"

"@types/cookiejar@*":
  version "2.1.2"
  resolved "https://registry.yarnpkg.com/@types/cookiejar/-/cookiejar-2.1.2.tgz#66ad9331f63fe8a3d3d9d8c6e3906dd10f6446e8"
  integrity sha512-t73xJJrvdTjXrn4jLS9VSGRbz0nUY3cl2DMGDU48lKl+HR9dbbjW2A9r3g40VA++mQpy6uuHg33gy7du2BKpog==

"@types/eslint-scope@^3.7.3":
  version "3.7.4"
  resolved "https://registry.yarnpkg.com/@types/eslint-scope/-/eslint-scope-3.7.4.tgz#37fc1223f0786c39627068a12e94d6e6fc61de16"
  integrity sha512-9K4zoImiZc3HlIp6AVUDE4CWYx22a+lhSZMYNpbjW04+YF0KWj4pJXnEMjdnFTiQibFFmElcsasJXDbdI/EPhA==
  dependencies:
    "@types/eslint" "*"
    "@types/estree" "*"

"@types/eslint@*":
  version "8.4.10"
  resolved "https://registry.yarnpkg.com/@types/eslint/-/eslint-8.4.10.tgz#19731b9685c19ed1552da7052b6f668ed7eb64bb"
  integrity sha512-Sl/HOqN8NKPmhWo2VBEPm0nvHnu2LL3v9vKo8MEq0EtbJ4eVzGPl41VNPvn5E1i5poMk4/XD8UriLHpJvEP/Nw==
  dependencies:
    "@types/estree" "*"
    "@types/json-schema" "*"

"@types/estree@*":
  version "1.0.0"
  resolved "https://registry.yarnpkg.com/@types/estree/-/estree-1.0.0.tgz#5fb2e536c1ae9bf35366eed879e827fa59ca41c2"
  integrity sha512-WulqXMDUTYAXCjZnk6JtIHPigp55cVtDgDrO2gHRwhyJto21+1zbVCtOYB2L1F9w4qCQ0rOGWBnBe0FNTiEJIQ==

"@types/estree@^1.0.0":
  version "1.0.1"
  resolved "https://registry.yarnpkg.com/@types/estree/-/estree-1.0.1.tgz#aa22750962f3bf0e79d753d3cc067f010c95f194"
  integrity sha512-LG4opVs2ANWZ1TJoKc937iMmNstM/d0ae1vNbnBvBhqCSezgVUOzcLCqbI5elV8Vy6WKwKjaqR+zO9VKirBBCA==

"@types/express-serve-static-core@^4.17.33":
  version "4.17.35"
  resolved "https://registry.yarnpkg.com/@types/express-serve-static-core/-/express-serve-static-core-4.17.35.tgz#c95dd4424f0d32e525d23812aa8ab8e4d3906c4f"
  integrity sha512-wALWQwrgiB2AWTT91CB62b6Yt0sNHpznUXeZEcnPU3DRdlDIz74x8Qg1UUYKSVFi+va5vKOLYRBI1bRKiLLKIg==
  dependencies:
    "@types/node" "*"
    "@types/qs" "*"
    "@types/range-parser" "*"
    "@types/send" "*"

"@types/express@^4.17.17":
  version "4.17.17"
  resolved "https://registry.yarnpkg.com/@types/express/-/express-4.17.17.tgz#01d5437f6ef9cfa8668e616e13c2f2ac9a491ae4"
  integrity sha512-Q4FmmuLGBG58btUnfS1c1r/NQdlp3DMfGDGig8WhfpA2YRUtEkxAjkZb0yvplJGYdF1fsQ81iMDcH24sSCNC/Q==
  dependencies:
    "@types/body-parser" "*"
    "@types/express-serve-static-core" "^4.17.33"
    "@types/qs" "*"
    "@types/serve-static" "*"

"@types/graceful-fs@^4.1.3":
  version "4.1.5"
  resolved "https://registry.yarnpkg.com/@types/graceful-fs/-/graceful-fs-4.1.5.tgz#21ffba0d98da4350db64891f92a9e5db3cdb4e15"
  integrity sha512-anKkLmZZ+xm4p8JWBf4hElkM4XR+EZeA2M9BAkkTldmcyDY4mbdIJnRghDJH3Ov5ooY7/UAoENtmdMSkaAd7Cw==
  dependencies:
    "@types/node" "*"

"@types/hoist-non-react-statics@^3.3.1":
  version "3.3.1"
  resolved "https://registry.yarnpkg.com/@types/hoist-non-react-statics/-/hoist-non-react-statics-3.3.1.tgz#1124aafe5118cb591977aeb1ceaaed1070eb039f"
  integrity sha512-iMIqiko6ooLrTh1joXodJK5X9xeEALT1kM5G3ZLhD3hszxBdIEd5C75U834D9mLcINgD4OyZf5uQXjkuYydWvA==
  dependencies:
    "@types/react" "*"
    hoist-non-react-statics "^3.3.0"

"@types/istanbul-lib-coverage@*", "@types/istanbul-lib-coverage@^2.0.0", "@types/istanbul-lib-coverage@^2.0.1":
  version "2.0.4"
  resolved "https://registry.yarnpkg.com/@types/istanbul-lib-coverage/-/istanbul-lib-coverage-2.0.4.tgz#8467d4b3c087805d63580480890791277ce35c44"
  integrity sha512-z/QT1XN4K4KYuslS23k62yDIDLwLFkzxOuMplDtObz0+y7VqJCaO2o+SPwHCvLFZh7xazvvoor2tA/hPz9ee7g==

"@types/istanbul-lib-report@*":
  version "3.0.0"
  resolved "https://registry.yarnpkg.com/@types/istanbul-lib-report/-/istanbul-lib-report-3.0.0.tgz#c14c24f18ea8190c118ee7562b7ff99a36552686"
  integrity sha512-plGgXAPfVKFoYfa9NpYDAkseG+g6Jr294RqeqcqDixSbU34MZVJRi/P+7Y8GDpzkEwLaGZZOpKIEmeVZNtKsrg==
  dependencies:
    "@types/istanbul-lib-coverage" "*"

"@types/istanbul-reports@^3.0.0":
  version "3.0.1"
  resolved "https://registry.yarnpkg.com/@types/istanbul-reports/-/istanbul-reports-3.0.1.tgz#9153fe98bba2bd565a63add9436d6f0d7f8468ff"
  integrity sha512-c3mAZEuK0lvBp8tmuL74XRKn1+y2dcwOUpH7x4WrF6gk1GIgiluDRgMYQtw2OFcBvAJWlt6ASU3tSqxp0Uu0Aw==
  dependencies:
    "@types/istanbul-lib-report" "*"

"@types/jest@*":
  version "29.2.4"
  resolved "https://registry.yarnpkg.com/@types/jest/-/jest-29.2.4.tgz#9c155c4b81c9570dbd183eb8604aa0ae80ba5a5b"
  integrity sha512-PipFB04k2qTRPePduVLTRiPzQfvMeLwUN3Z21hsAKaB/W9IIzgB2pizCL466ftJlcyZqnHoC9ZHpxLGl3fS86A==
  dependencies:
    expect "^29.0.0"
    pretty-format "^29.0.0"

"@types/jest@^29.5.3":
  version "29.5.3"
  resolved "https://registry.yarnpkg.com/@types/jest/-/jest-29.5.3.tgz#7a35dc0044ffb8b56325c6802a4781a626b05777"
  integrity sha512-1Nq7YrO/vJE/FYnqYyw0FS8LdrjExSgIiHyKg7xPpn+yi8Q4huZryKnkJatN1ZRH89Kw2v33/8ZMB7DuZeSLlA==
  dependencies:
    expect "^29.0.0"
    pretty-format "^29.0.0"

"@types/jsdom@^20.0.0":
  version "20.0.1"
  resolved "https://registry.yarnpkg.com/@types/jsdom/-/jsdom-20.0.1.tgz#07c14bc19bd2f918c1929541cdaacae894744808"
  integrity sha512-d0r18sZPmMQr1eG35u12FZfhIXNrnsPU/g5wvRKCUf/tOGilKKwYMYGqh33BNR6ba+2gkHw1EUiHoN3mn7E5IQ==
  dependencies:
    "@types/node" "*"
    "@types/tough-cookie" "*"
    parse5 "^7.0.0"

"@types/json-schema@*", "@types/json-schema@^7.0.8":
  version "7.0.11"
  resolved "https://registry.yarnpkg.com/@types/json-schema/-/json-schema-7.0.11.tgz#d421b6c527a3037f7c84433fd2c4229e016863d3"
  integrity sha512-wOuvG1SN4Us4rez+tylwwwCV1psiNVOkJeM3AUWUNWg/jDQY2+HE/444y5gc+jBmRqASOm2Oeh5c1axHobwRKQ==

"@types/json-schema@^7.0.12":
  version "7.0.12"
  resolved "https://registry.yarnpkg.com/@types/json-schema/-/json-schema-7.0.12.tgz#d70faba7039d5fca54c83c7dbab41051d2b6f6cb"
  integrity sha512-Hr5Jfhc9eYOQNPYO5WLDq/n4jqijdHNlDXjuAQkkt+mWdQR+XJToOHrsD4cPaMXpn6KO7y2+wM8AZEs8VpBLVA==

"@types/json5@^0.0.29":
  version "0.0.29"
  resolved "https://registry.yarnpkg.com/@types/json5/-/json5-0.0.29.tgz#ee28707ae94e11d2b827bcbe5270bcea7f3e71ee"
  integrity sha512-dRLjCWHYg4oaA77cxO64oO+7JwCwnIzkZPdrrC71jQmQtlhM556pwKo5bUzqvZndkVbeFLIIi+9TC40JNF5hNQ==

"@types/mime@*":
  version "3.0.1"
  resolved "https://registry.yarnpkg.com/@types/mime/-/mime-3.0.1.tgz#5f8f2bca0a5863cb69bc0b0acd88c96cb1d4ae10"
  integrity sha512-Y4XFY5VJAuw0FgAqPNd6NNoV44jbq9Bz2L7Rh/J6jLTiHBSBJa9fxqQIvkIld4GsoDOcCbvzOUAbLPsSKKg+uA==

"@types/mime@^1":
  version "1.3.2"
  resolved "https://registry.yarnpkg.com/@types/mime/-/mime-1.3.2.tgz#93e25bf9ee75fe0fd80b594bc4feb0e862111b5a"
  integrity sha512-YATxVxgRqNH6nHEIsvg6k2Boc1JHI9ZbH5iWFFv/MTkchz3b1ieGDa5T0a9RznNdI0KhVbdbWSN+KWWrQZRxTw==

"@types/node@*":
  version "18.11.15"
  resolved "https://registry.yarnpkg.com/@types/node/-/node-18.11.15.tgz#de0e1fbd2b22b962d45971431e2ae696643d3f5d"
  integrity sha512-VkhBbVo2+2oozlkdHXLrb3zjsRkpdnaU2bXmX8Wgle3PUi569eLRaHGlgETQHR7lLL1w7GiG3h9SnePhxNDecw==

"@types/node@^20.4.5":
  version "20.4.5"
  resolved "https://registry.yarnpkg.com/@types/node/-/node-20.4.5.tgz#9dc0a5cb1ccce4f7a731660935ab70b9c00a5d69"
  integrity sha512-rt40Nk13II9JwQBdeYqmbn2Q6IVTA5uPhvSO+JVqdXw/6/4glI6oR9ezty/A9Hg5u7JH4OmYmuQ+XvjKm0Datg==

"@types/parse-json@^4.0.0":
  version "4.0.0"
  resolved "https://registry.yarnpkg.com/@types/parse-json/-/parse-json-4.0.0.tgz#2f8bb441434d163b35fb8ffdccd7138927ffb8c0"
  integrity sha512-//oorEZjL6sbPcKUaCdIGlIUeH26mgzimjBB77G6XRgnDl/L5wOnpyBGRe/Mmf5CVW3PwEBE1NjiMZ/ssFh4wA==

"@types/prop-types@*":
  version "15.7.5"
  resolved "https://registry.yarnpkg.com/@types/prop-types/-/prop-types-15.7.5.tgz#5f19d2b85a98e9558036f6a3cacc8819420f05cf"
  integrity sha512-JCB8C6SnDoQf0cNycqd/35A7MjcnK+ZTqE7judS6o7utxUCg6imJg3QK2qzHKszlTjcj2cn+NwMB2i96ubpj7w==

"@types/qs@*":
  version "6.9.7"
  resolved "https://registry.yarnpkg.com/@types/qs/-/qs-6.9.7.tgz#63bb7d067db107cc1e457c303bc25d511febf6cb"
  integrity sha512-FGa1F62FT09qcrueBA6qYTrJPVDzah9a+493+o2PCXsesWHIn27G98TsSMs3WPNbZIEj4+VJf6saSFpvD+3Zsw==

"@types/range-parser@*":
  version "1.2.4"
  resolved "https://registry.yarnpkg.com/@types/range-parser/-/range-parser-1.2.4.tgz#cd667bcfdd025213aafb7ca5915a932590acdcdc"
  integrity sha512-EEhsLsD6UsDM1yFhAvy0Cjr6VwmpMWqFBCb9w07wVugF7w9nfajxLuVmngTIpgS6svCnm6Vaw+MZhoDCKnOfsw==

"@types/react-dom@^18.0.0":
  version "18.0.9"
  resolved "https://registry.yarnpkg.com/@types/react-dom/-/react-dom-18.0.9.tgz#ffee5e4bfc2a2f8774b15496474f8e7fe8d0b504"
  integrity sha512-qnVvHxASt/H7i+XG1U1xMiY5t+IHcPGUK7TDMDzom08xa7e86eCeKOiLZezwCKVxJn6NEiiy2ekgX8aQssjIKg==
  dependencies:
    "@types/react" "*"

"@types/react-dom@^18.2.7":
  version "18.2.7"
  resolved "https://registry.yarnpkg.com/@types/react-dom/-/react-dom-18.2.7.tgz#67222a08c0a6ae0a0da33c3532348277c70abb63"
  integrity sha512-GRaAEriuT4zp9N4p1i8BDBYmEyfo+xQ3yHjJU4eiK5NDa1RmUZG+unZABUTK4/Ox/M+GaHwb6Ow8rUITrtjszA==
  dependencies:
    "@types/react" "*"

"@types/react@*":
  version "18.0.26"
  resolved "https://registry.yarnpkg.com/@types/react/-/react-18.0.26.tgz#8ad59fc01fef8eaf5c74f4ea392621749f0b7917"
  integrity sha512-hCR3PJQsAIXyxhTNSiDFY//LhnMZWpNNr5etoCqx/iUfGc5gXWtQR2Phl908jVR6uPXacojQWTg4qRpkxTuGug==
  dependencies:
    "@types/prop-types" "*"
    "@types/scheduler" "*"
    csstype "^3.0.2"

"@types/react@18.2.18", "@types/react@^18.2.18":
  version "18.2.18"
  resolved "https://registry.yarnpkg.com/@types/react/-/react-18.2.18.tgz#c8b233919eef1bdc294f6f34b37f9727ad677516"
  integrity sha512-da4NTSeBv/P34xoZPhtcLkmZuJ+oYaCxHmyHzwaDQo9RQPBeXV+06gEk2FpqEcsX9XrnNLvRpVh6bdavDSjtiQ==
  dependencies:
    "@types/prop-types" "*"
    "@types/scheduler" "*"
    csstype "^3.0.2"

"@types/scheduler@*":
  version "0.16.2"
  resolved "https://registry.yarnpkg.com/@types/scheduler/-/scheduler-0.16.2.tgz#1a62f89525723dde24ba1b01b092bf5df8ad4d39"
  integrity sha512-hppQEBDmlwhFAXKJX2KnWLYu5yMfi91yazPb2l+lbJiwW+wdo1gNeRA+3RgNSO39WYX2euey41KEwnqesU2Jew==

"@types/semver@^7.5.0":
  version "7.5.0"
  resolved "https://registry.yarnpkg.com/@types/semver/-/semver-7.5.0.tgz#591c1ce3a702c45ee15f47a42ade72c2fd78978a"
  integrity sha512-G8hZ6XJiHnuhQKR7ZmysCeJWE08o8T0AXtk5darsCaTVsYZhhgUrq53jizaR2FvsoeCwJhlmwTjkXBY5Pn/ZHw==

"@types/send@*":
  version "0.17.1"
  resolved "https://registry.yarnpkg.com/@types/send/-/send-0.17.1.tgz#ed4932b8a2a805f1fe362a70f4e62d0ac994e301"
  integrity sha512-Cwo8LE/0rnvX7kIIa3QHCkcuF21c05Ayb0ZfxPiv0W8VRiZiNW/WuRupHKpqqGVGf7SUA44QSOUKaEd9lIrd/Q==
  dependencies:
    "@types/mime" "^1"
    "@types/node" "*"

"@types/serve-static@*":
  version "1.15.0"
  resolved "https://registry.yarnpkg.com/@types/serve-static/-/serve-static-1.15.0.tgz#c7930ff61afb334e121a9da780aac0d9b8f34155"
  integrity sha512-z5xyF6uh8CbjAu9760KDKsH2FcDxZ2tFCsA4HIMWE6IkiYMXfVoa+4f9KX+FN0ZLsaMw1WNG2ETLA6N+/YA+cg==
  dependencies:
    "@types/mime" "*"
    "@types/node" "*"

"@types/stack-utils@^2.0.0":
  version "2.0.1"
  resolved "https://registry.yarnpkg.com/@types/stack-utils/-/stack-utils-2.0.1.tgz#20f18294f797f2209b5f65c8e3b5c8e8261d127c"
  integrity sha512-Hl219/BT5fLAaz6NDkSuhzasy49dwQS/DSdu4MdggFB8zcXv7vflBI3xp7FEmkmdDkBUI2bPUNeMttp2knYdxw==

"@types/superagent@*":
  version "4.1.16"
  resolved "https://registry.yarnpkg.com/@types/superagent/-/superagent-4.1.16.tgz#12c9c16f232f9d89beab91d69368f96ce8e2d881"
  integrity sha512-tLfnlJf6A5mB6ddqF159GqcDizfzbMUB1/DeT59/wBNqzRTNNKsaw79A/1TZ84X+f/EwWH8FeuSkjlCLyqS/zQ==
  dependencies:
    "@types/cookiejar" "*"
    "@types/node" "*"

"@types/supertest@^2.0.12":
  version "2.0.12"
  resolved "https://registry.yarnpkg.com/@types/supertest/-/supertest-2.0.12.tgz#ddb4a0568597c9aadff8dbec5b2e8fddbe8692fc"
  integrity sha512-X3HPWTwXRerBZS7Mo1k6vMVR1Z6zmJcDVn5O/31whe0tnjE4te6ZJSJGq1RiqHPjzPdMTfjCFogDJmwng9xHaQ==
  dependencies:
    "@types/superagent" "*"

"@types/testing-library__jest-dom@^5.9.1":
  version "5.14.5"
  resolved "https://registry.yarnpkg.com/@types/testing-library__jest-dom/-/testing-library__jest-dom-5.14.5.tgz#d113709c90b3c75fdb127ec338dad7d5f86c974f"
  integrity sha512-SBwbxYoyPIvxHbeHxTZX2Pe/74F/tX2/D3mMvzabdeJ25bBojfW0TyB8BHrbq/9zaaKICJZjLP+8r6AeZMFCuQ==
  dependencies:
    "@types/jest" "*"

"@types/tough-cookie@*":
  version "4.0.2"
  resolved "https://registry.yarnpkg.com/@types/tough-cookie/-/tough-cookie-4.0.2.tgz#6286b4c7228d58ab7866d19716f3696e03a09397"
  integrity sha512-Q5vtl1W5ue16D+nIaW8JWebSSraJVlK+EthKn7e7UcD4KWsaSJ8BqGPXNaPghgtcn/fhvrN17Tv8ksUsQpiplw==

"@types/use-sync-external-store@^0.0.3":
  version "0.0.3"
  resolved "https://registry.yarnpkg.com/@types/use-sync-external-store/-/use-sync-external-store-0.0.3.tgz#b6725d5f4af24ace33b36fafd295136e75509f43"
  integrity sha512-EwmlvuaxPNej9+T4v5AuBPJa2x2UOJVdjCtDHgcDqitUeOtjnJKJ+apYjVcAoBEMjKW1VVFGZLUb5+qqa09XFA==

"@types/yargs-parser@*":
  version "21.0.0"
  resolved "https://registry.yarnpkg.com/@types/yargs-parser/-/yargs-parser-21.0.0.tgz#0c60e537fa790f5f9472ed2776c2b71ec117351b"
  integrity sha512-iO9ZQHkZxHn4mSakYV0vFHAVDyEOIJQrV2uZ06HxEPcx+mt8swXoZHIbaaJ2crJYFfErySgktuTZ3BeLz+XmFA==

"@types/yargs@^17.0.8":
  version "17.0.17"
  resolved "https://registry.yarnpkg.com/@types/yargs/-/yargs-17.0.17.tgz#5672e5621f8e0fca13f433a8017aae4b7a2a03e7"
  integrity sha512-72bWxFKTK6uwWJAVT+3rF6Jo6RTojiJ27FQo8Rf60AL+VZbzoVPnMFhKsUnbjR8A3BTCYQ7Mv3hnl8T0A+CX9g==
  dependencies:
    "@types/yargs-parser" "*"

"@typescript-eslint/eslint-plugin@^6.2.1":
  version "6.2.1"
  resolved "https://registry.yarnpkg.com/@typescript-eslint/eslint-plugin/-/eslint-plugin-6.2.1.tgz#41b79923fee46a745a3a50cba1c33c622aa3c79a"
  integrity sha512-iZVM/ALid9kO0+I81pnp1xmYiFyqibAHzrqX4q5YvvVEyJqY+e6rfTXSCsc2jUxGNqJqTfFSSij/NFkZBiBzLw==
  dependencies:
    "@eslint-community/regexpp" "^4.5.1"
    "@typescript-eslint/scope-manager" "6.2.1"
    "@typescript-eslint/type-utils" "6.2.1"
    "@typescript-eslint/utils" "6.2.1"
    "@typescript-eslint/visitor-keys" "6.2.1"
    debug "^4.3.4"
    graphemer "^1.4.0"
    ignore "^5.2.4"
    natural-compare "^1.4.0"
    natural-compare-lite "^1.4.0"
    semver "^7.5.4"
    ts-api-utils "^1.0.1"

"@typescript-eslint/parser@^5.42.0":
  version "5.46.1"
  resolved "https://registry.yarnpkg.com/@typescript-eslint/parser/-/parser-5.46.1.tgz#1fc8e7102c1141eb64276c3b89d70da8c0ba5699"
  integrity sha512-RelQ5cGypPh4ySAtfIMBzBGyrNerQcmfA1oJvPj5f+H4jI59rl9xxpn4bonC0tQvUKOEN7eGBFWxFLK3Xepneg==
  dependencies:
    "@typescript-eslint/scope-manager" "5.46.1"
    "@typescript-eslint/types" "5.46.1"
    "@typescript-eslint/typescript-estree" "5.46.1"
    debug "^4.3.4"

"@typescript-eslint/parser@^6.2.1":
  version "6.2.1"
  resolved "https://registry.yarnpkg.com/@typescript-eslint/parser/-/parser-6.2.1.tgz#e18a31eea1cca8841a565f1701960c8123ed07f9"
  integrity sha512-Ld+uL1kYFU8e6btqBFpsHkwQ35rw30IWpdQxgOqOh4NfxSDH6uCkah1ks8R/RgQqI5hHPXMaLy9fbFseIe+dIg==
  dependencies:
    "@typescript-eslint/scope-manager" "6.2.1"
    "@typescript-eslint/types" "6.2.1"
    "@typescript-eslint/typescript-estree" "6.2.1"
    "@typescript-eslint/visitor-keys" "6.2.1"
    debug "^4.3.4"

"@typescript-eslint/scope-manager@5.46.1":
  version "5.46.1"
  resolved "https://registry.yarnpkg.com/@typescript-eslint/scope-manager/-/scope-manager-5.46.1.tgz#70af8425c79bbc1178b5a63fb51102ddf48e104a"
  integrity sha512-iOChVivo4jpwUdrJZyXSMrEIM/PvsbbDOX1y3UCKjSgWn+W89skxWaYXACQfxmIGhPVpRWK/VWPYc+bad6smIA==
  dependencies:
    "@typescript-eslint/types" "5.46.1"
    "@typescript-eslint/visitor-keys" "5.46.1"

"@typescript-eslint/scope-manager@6.2.1":
  version "6.2.1"
  resolved "https://registry.yarnpkg.com/@typescript-eslint/scope-manager/-/scope-manager-6.2.1.tgz#b6f43a867b84e5671fe531f2b762e0b68f7cf0c4"
  integrity sha512-UCqBF9WFqv64xNsIEPfBtenbfodPXsJ3nPAr55mGPkQIkiQvgoWNo+astj9ZUfJfVKiYgAZDMnM6dIpsxUMp3Q==
  dependencies:
    "@typescript-eslint/types" "6.2.1"
    "@typescript-eslint/visitor-keys" "6.2.1"

"@typescript-eslint/type-utils@6.2.1":
  version "6.2.1"
  resolved "https://registry.yarnpkg.com/@typescript-eslint/type-utils/-/type-utils-6.2.1.tgz#8eb8a2cccdf39cd7cf93e02bd2c3782dc90b0525"
  integrity sha512-fTfCgomBMIgu2Dh2Or3gMYgoNAnQm3RLtRp+jP7A8fY+LJ2+9PNpi5p6QB5C4RSP+U3cjI0vDlI3mspAkpPVbQ==
  dependencies:
    "@typescript-eslint/typescript-estree" "6.2.1"
    "@typescript-eslint/utils" "6.2.1"
    debug "^4.3.4"
    ts-api-utils "^1.0.1"

"@typescript-eslint/types@5.46.1":
  version "5.46.1"
  resolved "https://registry.yarnpkg.com/@typescript-eslint/types/-/types-5.46.1.tgz#4e9db2107b9a88441c4d5ecacde3bb7a5ebbd47e"
  integrity sha512-Z5pvlCaZgU+93ryiYUwGwLl9AQVB/PQ1TsJ9NZ/gHzZjN7g9IAn6RSDkpCV8hqTwAiaj6fmCcKSQeBPlIpW28w==

"@typescript-eslint/types@6.2.1":
  version "6.2.1"
  resolved "https://registry.yarnpkg.com/@typescript-eslint/types/-/types-6.2.1.tgz#7fcdeceb503aab601274bf5e210207050d88c8ab"
  integrity sha512-528bGcoelrpw+sETlyM91k51Arl2ajbNT9L4JwoXE2dvRe1yd8Q64E4OL7vHYw31mlnVsf+BeeLyAZUEQtqahQ==

"@typescript-eslint/typescript-estree@5.46.1":
  version "5.46.1"
  resolved "https://registry.yarnpkg.com/@typescript-eslint/typescript-estree/-/typescript-estree-5.46.1.tgz#5358088f98a8f9939355e0996f9c8f41c25eced2"
  integrity sha512-j9W4t67QiNp90kh5Nbr1w92wzt+toiIsaVPnEblB2Ih2U9fqBTyqV9T3pYWZBRt6QoMh/zVWP59EpuCjc4VRBg==
  dependencies:
    "@typescript-eslint/types" "5.46.1"
    "@typescript-eslint/visitor-keys" "5.46.1"
    debug "^4.3.4"
    globby "^11.1.0"
    is-glob "^4.0.3"
    semver "^7.3.7"
    tsutils "^3.21.0"

"@typescript-eslint/typescript-estree@6.2.1":
  version "6.2.1"
  resolved "https://registry.yarnpkg.com/@typescript-eslint/typescript-estree/-/typescript-estree-6.2.1.tgz#2af6e90c1e91cb725a5fe1682841a3f74549389e"
  integrity sha512-G+UJeQx9AKBHRQBpmvr8T/3K5bJa485eu+4tQBxFq0KoT22+jJyzo1B50JDT9QdC1DEmWQfdKsa8ybiNWYsi0Q==
  dependencies:
    "@typescript-eslint/types" "6.2.1"
    "@typescript-eslint/visitor-keys" "6.2.1"
    debug "^4.3.4"
    globby "^11.1.0"
    is-glob "^4.0.3"
    semver "^7.5.4"
    ts-api-utils "^1.0.1"

"@typescript-eslint/utils@6.2.1":
  version "6.2.1"
  resolved "https://registry.yarnpkg.com/@typescript-eslint/utils/-/utils-6.2.1.tgz#2aa4279ec13053d05615bcbde2398e1e8f08c334"
  integrity sha512-eBIXQeupYmxVB6S7x+B9SdBeB6qIdXKjgQBge2J+Ouv8h9Cxm5dHf/gfAZA6dkMaag+03HdbVInuXMmqFB/lKQ==
  dependencies:
    "@eslint-community/eslint-utils" "^4.4.0"
    "@types/json-schema" "^7.0.12"
    "@types/semver" "^7.5.0"
    "@typescript-eslint/scope-manager" "6.2.1"
    "@typescript-eslint/types" "6.2.1"
    "@typescript-eslint/typescript-estree" "6.2.1"
    semver "^7.5.4"

"@typescript-eslint/visitor-keys@5.46.1":
  version "5.46.1"
  resolved "https://registry.yarnpkg.com/@typescript-eslint/visitor-keys/-/visitor-keys-5.46.1.tgz#126cc6fe3c0f83608b2b125c5d9daced61394242"
  integrity sha512-jczZ9noovXwy59KjRTk1OftT78pwygdcmCuBf8yMoWt/8O8l+6x2LSEze0E4TeepXK4MezW3zGSyoDRZK7Y9cg==
  dependencies:
    "@typescript-eslint/types" "5.46.1"
    eslint-visitor-keys "^3.3.0"

"@typescript-eslint/visitor-keys@6.2.1":
  version "6.2.1"
  resolved "https://registry.yarnpkg.com/@typescript-eslint/visitor-keys/-/visitor-keys-6.2.1.tgz#442e7c09fe94b715a54ebe30e967987c3c41fbf4"
  integrity sha512-iTN6w3k2JEZ7cyVdZJTVJx2Lv7t6zFA8DCrJEHD2mwfc16AEvvBWVhbFh34XyG2NORCd0viIgQY1+u7kPI0WpA==
  dependencies:
    "@typescript-eslint/types" "6.2.1"
    eslint-visitor-keys "^3.4.1"

"@webassemblyjs/ast@1.11.6", "@webassemblyjs/ast@^1.11.5":
  version "1.11.6"
  resolved "https://registry.yarnpkg.com/@webassemblyjs/ast/-/ast-1.11.6.tgz#db046555d3c413f8966ca50a95176a0e2c642e24"
  integrity sha512-IN1xI7PwOvLPgjcf180gC1bqn3q/QaOCwYUahIOhbYUu8KA/3tw2RT/T0Gidi1l7Hhj5D/INhJxiICObqpMu4Q==
  dependencies:
    "@webassemblyjs/helper-numbers" "1.11.6"
    "@webassemblyjs/helper-wasm-bytecode" "1.11.6"

"@webassemblyjs/floating-point-hex-parser@1.11.6":
  version "1.11.6"
  resolved "https://registry.yarnpkg.com/@webassemblyjs/floating-point-hex-parser/-/floating-point-hex-parser-1.11.6.tgz#dacbcb95aff135c8260f77fa3b4c5fea600a6431"
  integrity sha512-ejAj9hfRJ2XMsNHk/v6Fu2dGS+i4UaXBXGemOfQ/JfQ6mdQg/WXtwleQRLLS4OvfDhv8rYnVwH27YJLMyYsxhw==

"@webassemblyjs/helper-api-error@1.11.6":
  version "1.11.6"
  resolved "https://registry.yarnpkg.com/@webassemblyjs/helper-api-error/-/helper-api-error-1.11.6.tgz#6132f68c4acd59dcd141c44b18cbebbd9f2fa768"
  integrity sha512-o0YkoP4pVu4rN8aTJgAyj9hC2Sv5UlkzCHhxqWj8butaLvnpdc2jOwh4ewE6CX0txSfLn/UYaV/pheS2Txg//Q==

"@webassemblyjs/helper-buffer@1.11.6":
  version "1.11.6"
  resolved "https://registry.yarnpkg.com/@webassemblyjs/helper-buffer/-/helper-buffer-1.11.6.tgz#b66d73c43e296fd5e88006f18524feb0f2c7c093"
  integrity sha512-z3nFzdcp1mb8nEOFFk8DrYLpHvhKC3grJD2ardfKOzmbmJvEf/tPIqCY+sNcwZIY8ZD7IkB2l7/pqhUhqm7hLA==

"@webassemblyjs/helper-numbers@1.11.6":
  version "1.11.6"
  resolved "https://registry.yarnpkg.com/@webassemblyjs/helper-numbers/-/helper-numbers-1.11.6.tgz#cbce5e7e0c1bd32cf4905ae444ef64cea919f1b5"
  integrity sha512-vUIhZ8LZoIWHBohiEObxVm6hwP034jwmc9kuq5GdHZH0wiLVLIPcMCdpJzG4C11cHoQ25TFIQj9kaVADVX7N3g==
  dependencies:
    "@webassemblyjs/floating-point-hex-parser" "1.11.6"
    "@webassemblyjs/helper-api-error" "1.11.6"
    "@xtuc/long" "4.2.2"

"@webassemblyjs/helper-wasm-bytecode@1.11.6":
  version "1.11.6"
  resolved "https://registry.yarnpkg.com/@webassemblyjs/helper-wasm-bytecode/-/helper-wasm-bytecode-1.11.6.tgz#bb2ebdb3b83aa26d9baad4c46d4315283acd51e9"
  integrity sha512-sFFHKwcmBprO9e7Icf0+gddyWYDViL8bpPjJJl0WHxCdETktXdmtWLGVzoHbqUcY4Be1LkNfwTmXOJUFZYSJdA==

"@webassemblyjs/helper-wasm-section@1.11.6":
  version "1.11.6"
  resolved "https://registry.yarnpkg.com/@webassemblyjs/helper-wasm-section/-/helper-wasm-section-1.11.6.tgz#ff97f3863c55ee7f580fd5c41a381e9def4aa577"
  integrity sha512-LPpZbSOwTpEC2cgn4hTydySy1Ke+XEu+ETXuoyvuyezHO3Kjdu90KK95Sh9xTbmjrCsUwvWwCOQQNta37VrS9g==
  dependencies:
    "@webassemblyjs/ast" "1.11.6"
    "@webassemblyjs/helper-buffer" "1.11.6"
    "@webassemblyjs/helper-wasm-bytecode" "1.11.6"
    "@webassemblyjs/wasm-gen" "1.11.6"

"@webassemblyjs/ieee754@1.11.6":
  version "1.11.6"
  resolved "https://registry.yarnpkg.com/@webassemblyjs/ieee754/-/ieee754-1.11.6.tgz#bb665c91d0b14fffceb0e38298c329af043c6e3a"
  integrity sha512-LM4p2csPNvbij6U1f19v6WR56QZ8JcHg3QIJTlSwzFcmx6WSORicYj6I63f9yU1kEUtrpG+kjkiIAkevHpDXrg==
  dependencies:
    "@xtuc/ieee754" "^1.2.0"

"@webassemblyjs/leb128@1.11.6":
  version "1.11.6"
  resolved "https://registry.yarnpkg.com/@webassemblyjs/leb128/-/leb128-1.11.6.tgz#70e60e5e82f9ac81118bc25381a0b283893240d7"
  integrity sha512-m7a0FhE67DQXgouf1tbN5XQcdWoNgaAuoULHIfGFIEVKA6tu/edls6XnIlkmS6FrXAquJRPni3ZZKjw6FSPjPQ==
  dependencies:
    "@xtuc/long" "4.2.2"

"@webassemblyjs/utf8@1.11.6":
  version "1.11.6"
  resolved "https://registry.yarnpkg.com/@webassemblyjs/utf8/-/utf8-1.11.6.tgz#90f8bc34c561595fe156603be7253cdbcd0fab5a"
  integrity sha512-vtXf2wTQ3+up9Zsg8sa2yWiQpzSsMyXj0qViVP6xKGCUT8p8YJ6HqI7l5eCnWx1T/FYdsv07HQs2wTFbbof/RA==

"@webassemblyjs/wasm-edit@^1.11.5":
  version "1.11.6"
  resolved "https://registry.yarnpkg.com/@webassemblyjs/wasm-edit/-/wasm-edit-1.11.6.tgz#c72fa8220524c9b416249f3d94c2958dfe70ceab"
  integrity sha512-Ybn2I6fnfIGuCR+Faaz7YcvtBKxvoLV3Lebn1tM4o/IAJzmi9AWYIPWpyBfU8cC+JxAO57bk4+zdsTjJR+VTOw==
  dependencies:
    "@webassemblyjs/ast" "1.11.6"
    "@webassemblyjs/helper-buffer" "1.11.6"
    "@webassemblyjs/helper-wasm-bytecode" "1.11.6"
    "@webassemblyjs/helper-wasm-section" "1.11.6"
    "@webassemblyjs/wasm-gen" "1.11.6"
    "@webassemblyjs/wasm-opt" "1.11.6"
    "@webassemblyjs/wasm-parser" "1.11.6"
    "@webassemblyjs/wast-printer" "1.11.6"

"@webassemblyjs/wasm-gen@1.11.6":
  version "1.11.6"
  resolved "https://registry.yarnpkg.com/@webassemblyjs/wasm-gen/-/wasm-gen-1.11.6.tgz#fb5283e0e8b4551cc4e9c3c0d7184a65faf7c268"
  integrity sha512-3XOqkZP/y6B4F0PBAXvI1/bky7GryoogUtfwExeP/v7Nzwo1QLcq5oQmpKlftZLbT+ERUOAZVQjuNVak6UXjPA==
  dependencies:
    "@webassemblyjs/ast" "1.11.6"
    "@webassemblyjs/helper-wasm-bytecode" "1.11.6"
    "@webassemblyjs/ieee754" "1.11.6"
    "@webassemblyjs/leb128" "1.11.6"
    "@webassemblyjs/utf8" "1.11.6"

"@webassemblyjs/wasm-opt@1.11.6":
  version "1.11.6"
  resolved "https://registry.yarnpkg.com/@webassemblyjs/wasm-opt/-/wasm-opt-1.11.6.tgz#d9a22d651248422ca498b09aa3232a81041487c2"
  integrity sha512-cOrKuLRE7PCe6AsOVl7WasYf3wbSo4CeOk6PkrjS7g57MFfVUF9u6ysQBBODX0LdgSvQqRiGz3CXvIDKcPNy4g==
  dependencies:
    "@webassemblyjs/ast" "1.11.6"
    "@webassemblyjs/helper-buffer" "1.11.6"
    "@webassemblyjs/wasm-gen" "1.11.6"
    "@webassemblyjs/wasm-parser" "1.11.6"

"@webassemblyjs/wasm-parser@1.11.6", "@webassemblyjs/wasm-parser@^1.11.5":
  version "1.11.6"
  resolved "https://registry.yarnpkg.com/@webassemblyjs/wasm-parser/-/wasm-parser-1.11.6.tgz#bb85378c527df824004812bbdb784eea539174a1"
  integrity sha512-6ZwPeGzMJM3Dqp3hCsLgESxBGtT/OeCvCZ4TA1JUPYgmhAx38tTPR9JaKy0S5H3evQpO/h2uWs2j6Yc/fjkpTQ==
  dependencies:
    "@webassemblyjs/ast" "1.11.6"
    "@webassemblyjs/helper-api-error" "1.11.6"
    "@webassemblyjs/helper-wasm-bytecode" "1.11.6"
    "@webassemblyjs/ieee754" "1.11.6"
    "@webassemblyjs/leb128" "1.11.6"
    "@webassemblyjs/utf8" "1.11.6"

"@webassemblyjs/wast-printer@1.11.6":
  version "1.11.6"
  resolved "https://registry.yarnpkg.com/@webassemblyjs/wast-printer/-/wast-printer-1.11.6.tgz#a7bf8dd7e362aeb1668ff43f35cb849f188eff20"
  integrity sha512-JM7AhRcE+yW2GWYaKeHL5vt4xqee5N2WcezptmgyhNS+ScggqcT1OtXykhAb13Sn5Yas0j2uv9tHgrjwvzAP4A==
  dependencies:
    "@webassemblyjs/ast" "1.11.6"
    "@xtuc/long" "4.2.2"

"@xtuc/ieee754@^1.2.0":
  version "1.2.0"
  resolved "https://registry.yarnpkg.com/@xtuc/ieee754/-/ieee754-1.2.0.tgz#eef014a3145ae477a1cbc00cd1e552336dceb790"
  integrity sha512-DX8nKgqcGwsc0eJSqYt5lwP4DH5FlHnmuWWBRy7X0NcaGR0ZtuyeESgMwTYVEtxmsNGY+qit4QYT/MIYTOTPeA==

"@xtuc/long@4.2.2":
  version "4.2.2"
  resolved "https://registry.yarnpkg.com/@xtuc/long/-/long-4.2.2.tgz#d291c6a4e97989b5c61d9acf396ae4fe133a718d"
  integrity sha512-NuHqBY1PB/D8xU6s/thBgOAiAP7HOYDQ32+BFZILJ8ivkUkAHQnWfn6WhL79Owj1qmUnoN/YPhktdIoucipkAQ==

abab@^2.0.6:
  version "2.0.6"
  resolved "https://registry.yarnpkg.com/abab/-/abab-2.0.6.tgz#41b80f2c871d19686216b82309231cfd3cb3d291"
  integrity sha512-j2afSsaIENvHZN2B8GOpF566vZ5WVk5opAiMTvWgaQT8DkbOqsTfvNAvHoRGU2zzP8cPoqys+xHTRDWW8L+/BA==

accepts@~1.3.8:
  version "1.3.8"
  resolved "https://registry.yarnpkg.com/accepts/-/accepts-1.3.8.tgz#0bf0be125b67014adcb0b0921e62db7bffe16b2e"
  integrity sha512-PYAthTa2m2VKxuvSD3DPC/Gy+U+sOA1LAuT8mkmRuvw+NACSaeXEQ+NHcVF7rONl6qcaxV3Uuemwawk+7+SJLw==
  dependencies:
    mime-types "~2.1.34"
    negotiator "0.6.3"

acorn-globals@^7.0.0:
  version "7.0.1"
  resolved "https://registry.yarnpkg.com/acorn-globals/-/acorn-globals-7.0.1.tgz#0dbf05c44fa7c94332914c02066d5beff62c40c3"
  integrity sha512-umOSDSDrfHbTNPuNpC2NSnnA3LUrqpevPb4T9jRx4MagXNS0rs+gwiTcAvqCRmsD6utzsrzNt+ebm00SNWiC3Q==
  dependencies:
    acorn "^8.1.0"
    acorn-walk "^8.0.2"

acorn-import-assertions@^1.9.0:
  version "1.9.0"
  resolved "https://registry.yarnpkg.com/acorn-import-assertions/-/acorn-import-assertions-1.9.0.tgz#507276249d684797c84e0734ef84860334cfb1ac"
  integrity sha512-cmMwop9x+8KFhxvKrKfPYmN6/pKTYYHBqLa0DfvVZcKMJWNyWLnaqND7dx/qn66R7ewM1UX5XMaDVP5wlVTaVA==

acorn-jsx@^5.3.2:
  version "5.3.2"
  resolved "https://registry.yarnpkg.com/acorn-jsx/-/acorn-jsx-5.3.2.tgz#7ed5bb55908b3b2f1bc55c6af1653bada7f07937"
  integrity sha512-rq9s+JNhf0IChjtDXxllJ7g41oZk5SlXtp0LHwyA5cejwn7vKmKp4pPri6YEePv2PU65sAsegbXtIinmDFDXgQ==

acorn-walk@^8.0.2, acorn-walk@^8.1.1:
  version "8.2.0"
  resolved "https://registry.yarnpkg.com/acorn-walk/-/acorn-walk-8.2.0.tgz#741210f2e2426454508853a2f44d0ab83b7f69c1"
  integrity sha512-k+iyHEuPgSw6SbuDpGQM+06HQUa04DZ3o+F6CSzXMvvI5KMvnaEqXe+YVe555R9nn6GPt404fos4wcgpw12SDA==

acorn@^8.1.0, acorn@^8.4.1, acorn@^8.7.1, acorn@^8.8.1:
  version "8.8.1"
  resolved "https://registry.yarnpkg.com/acorn/-/acorn-8.8.1.tgz#0a3f9cbecc4ec3bea6f0a80b66ae8dd2da250b73"
  integrity sha512-7zFpHzhnqYKrkYdUjF1HI1bzd0VygEGX8lFk4k5zVMqHEoES+P+7TKI+EvLO9WVMJ8eekdO0aDEK044xTXwPPA==

acorn@^8.8.2, acorn@^8.9.0:
  version "8.10.0"
  resolved "https://registry.yarnpkg.com/acorn/-/acorn-8.10.0.tgz#8be5b3907a67221a81ab23c7889c4c5526b62ec5"
  integrity sha512-F0SAmZ8iUtS//m8DmCTA0jlh6TDKkHQyK6xc6V4KDTyZKA9dnvX9/3sRTVQrWm79glUAZbnmmNcdYwUIHWVybw==

agent-base@6:
  version "6.0.2"
  resolved "https://registry.yarnpkg.com/agent-base/-/agent-base-6.0.2.tgz#49fff58577cfee3f37176feab4c22e00f86d7f77"
  integrity sha512-RZNwNclF7+MS/8bDg70amg32dyeZGZxiDuQmZxKLAlQjr3jGyLx+4Kkk58UO7D2QdgFIQCovuSuZESne6RG6XQ==
  dependencies:
    debug "4"

ajv-formats@2.1.1:
  version "2.1.1"
  resolved "https://registry.yarnpkg.com/ajv-formats/-/ajv-formats-2.1.1.tgz#6e669400659eb74973bbf2e33327180a0996b520"
  integrity sha512-Wx0Kx52hxE7C18hkMEggYlEifqWZtYaRgouJor+WMdPnQyEK13vgEWyVNup7SoeeoLMsr4kf5h6dOW11I15MUA==
  dependencies:
    ajv "^8.0.0"

ajv-keywords@^3.5.2:
  version "3.5.2"
  resolved "https://registry.yarnpkg.com/ajv-keywords/-/ajv-keywords-3.5.2.tgz#31f29da5ab6e00d1c2d329acf7b5929614d5014d"
  integrity sha512-5p6WTN0DdTGVQk6VjcEju19IgaHudalcfabD7yhDGeA6bcQnmL+CpveLJq/3hvfwd1aof6L386Ougkx6RfyMIQ==

ajv@8.12.0:
  version "8.12.0"
  resolved "https://registry.yarnpkg.com/ajv/-/ajv-8.12.0.tgz#d1a0527323e22f53562c567c00991577dfbe19d1"
  integrity sha512-sRu1kpcO9yLtYxBKvqfTeh9KzZEwO3STyX1HT+4CaDzC6HpTGYhIhPIzj9XuKU7KYDwnaeh5hcOwjy1QuJzBPA==
  dependencies:
    fast-deep-equal "^3.1.1"
    json-schema-traverse "^1.0.0"
    require-from-string "^2.0.2"
    uri-js "^4.2.2"

ajv@^6.12.4, ajv@^6.12.5:
  version "6.12.6"
  resolved "https://registry.yarnpkg.com/ajv/-/ajv-6.12.6.tgz#baf5a62e802b07d977034586f8c3baf5adf26df4"
  integrity sha512-j3fVLgvTo527anyYyJOGTYJbG+vnnQYvE0m5mmkc1TK+nxAppkCLMIL0aZ4dblVCNoGShhm+kzE4ZUykBoMg4g==
  dependencies:
    fast-deep-equal "^3.1.1"
    fast-json-stable-stringify "^2.0.0"
    json-schema-traverse "^0.4.1"
    uri-js "^4.2.2"

ajv@^8.0.0:
  version "8.11.2"
  resolved "https://registry.yarnpkg.com/ajv/-/ajv-8.11.2.tgz#aecb20b50607acf2569b6382167b65a96008bb78"
  integrity sha512-E4bfmKAhGiSTvMfL1Myyycaub+cUEU2/IvpylXkUu7CHBkBj1f/ikdzbD7YQ6FKUbixDxeYvB/xY4fvyroDlQg==
  dependencies:
    fast-deep-equal "^3.1.1"
    json-schema-traverse "^1.0.0"
    require-from-string "^2.0.2"
    uri-js "^4.2.2"

ansi-colors@4.1.3:
  version "4.1.3"
  resolved "https://registry.yarnpkg.com/ansi-colors/-/ansi-colors-4.1.3.tgz#37611340eb2243e70cc604cad35d63270d48781b"
  integrity sha512-/6w/C21Pm1A7aZitlI5Ni/2J6FFQN8i1Cvz3kHABAAbw93v/NlvKdVOqz7CCWz/3iv/JplRSEEZ83XION15ovw==

ansi-escapes@^4.2.1:
  version "4.3.2"
  resolved "https://registry.yarnpkg.com/ansi-escapes/-/ansi-escapes-4.3.2.tgz#6b2291d1db7d98b6521d5f1efa42d0f3a9feb65e"
  integrity sha512-gKXj5ALrKWQLsYG9jlTRmR/xKluxHV+Z9QEwNIgCfM1/uwPMCuzVVnh5mwTd+OuBZcwSIMbqssNWRm1lE51QaQ==
  dependencies:
    type-fest "^0.21.3"

ansi-regex@^5.0.1:
  version "5.0.1"
  resolved "https://registry.yarnpkg.com/ansi-regex/-/ansi-regex-5.0.1.tgz#082cb2c89c9fe8659a311a53bd6a4dc5301db304"
  integrity sha512-quJQXlTSUGL2LH9SUXo8VwsY4soanhgo6LNSm84E1LBcE8s3O0wpdiRzyR9z/ZZJMlMWv37qOOb9pdJlMUEKFQ==

ansi-regex@^6.0.1:
  version "6.0.1"
  resolved "https://registry.yarnpkg.com/ansi-regex/-/ansi-regex-6.0.1.tgz#3183e38fae9a65d7cb5e53945cd5897d0260a06a"
  integrity sha512-n5M855fKb2SsfMIiFFoVrABHJC8QtHwVx+mHWP3QcEqBHYienj5dHSgjbxtC0WEZXYt4wcD6zrQElDPhFuZgfA==

ansi-styles@^3.2.1:
  version "3.2.1"
  resolved "https://registry.yarnpkg.com/ansi-styles/-/ansi-styles-3.2.1.tgz#41fbb20243e50b12be0f04b8dedbf07520ce841d"
  integrity sha512-VT0ZI6kZRdTh8YyJw3SMbYm/u+NqfsAxEpWO0Pf9sq8/e94WxxOpPKx9FR1FlyCtOVDNOQ+8ntlqFxiRc+r5qA==
  dependencies:
    color-convert "^1.9.0"

ansi-styles@^4.0.0, ansi-styles@^4.1.0:
  version "4.3.0"
  resolved "https://registry.yarnpkg.com/ansi-styles/-/ansi-styles-4.3.0.tgz#edd803628ae71c04c85ae7a0906edad34b648937"
  integrity sha512-zbB9rCJAT1rbjiVDb2hqKFHNYLxgtk8NURxZ3IZwD3F6NtxbXZQCnnSi1Lkx+IDohdPlFp222wVALIheZJQSEg==
  dependencies:
    color-convert "^2.0.1"

ansi-styles@^5.0.0:
  version "5.2.0"
  resolved "https://registry.yarnpkg.com/ansi-styles/-/ansi-styles-5.2.0.tgz#07449690ad45777d1924ac2abb2fc8895dba836b"
  integrity sha512-Cxwpt2SfTzTtXcfOlzGEee8O+c+MmUgGrNiBcXnuWxuFJHe6a5Hz7qwhwe5OgaSYI0IJvkLqWX1ASG+cJOkEiA==

ansi-styles@^6.1.0:
  version "6.2.1"
  resolved "https://registry.yarnpkg.com/ansi-styles/-/ansi-styles-6.2.1.tgz#0e62320cf99c21afff3b3012192546aacbfb05c5"
  integrity sha512-bN798gFfQX+viw3R7yrGWRqnrN2oRkEkUjjl4JNn4E8GxxbjtG3FbrEIIY3l8/hrwUwIeCZvi4QuOTP4MErVug==

any-promise@^1.0.0:
  version "1.3.0"
  resolved "https://registry.yarnpkg.com/any-promise/-/any-promise-1.3.0.tgz#abc6afeedcea52e809cdc0376aed3ce39635d17f"
  integrity sha512-7UvmKalWRt1wgjL1RrGxoSJW/0QZFIegpeGvZG9kjp8vrRu55XTHbwnqq2GpXm9uLbcuhxm3IqX9OB4MZR1b2A==

anymatch@^3.0.3, anymatch@~3.1.2:
  version "3.1.3"
  resolved "https://registry.yarnpkg.com/anymatch/-/anymatch-3.1.3.tgz#790c58b19ba1720a84205b57c618d5ad8524973e"
  integrity sha512-KMReFUr0B4t+D+OBkjR3KYqvocp2XaSzO55UcB6mgQMd3KbcE+mWTyvVV7D/zsdEbNnV6acZUutkiHQXvTr1Rw==
  dependencies:
    normalize-path "^3.0.0"
    picomatch "^2.0.4"

append-field@^1.0.0:
  version "1.0.0"
  resolved "https://registry.yarnpkg.com/append-field/-/append-field-1.0.0.tgz#1e3440e915f0b1203d23748e78edd7b9b5b43e56"
  integrity sha512-klpgFSWLW1ZEs8svjfb7g4qWY0YS5imI82dTg+QahUvJ8YqAY0P10Uk8tTyh9ZGuYEZEMaeJYCF5BFuX552hsw==

arg@^4.1.0:
  version "4.1.3"
  resolved "https://registry.yarnpkg.com/arg/-/arg-4.1.3.tgz#269fc7ad5b8e42cb63c896d5666017261c144089"
  integrity sha512-58S9QDqG0Xx27YwPSt9fJxivjYl432YCwfDMfZ+71RAqUrZef7LrKQZ3LHLOwCS4FLNBplP533Zx895SeOCHvA==

arg@^5.0.2:
  version "5.0.2"
  resolved "https://registry.yarnpkg.com/arg/-/arg-5.0.2.tgz#c81433cc427c92c4dcf4865142dbca6f15acd59c"
  integrity sha512-PYjyFOLKQ9y57JvQ6QLo8dAgNqswh8M1RMJYdQduT6xbWSgK36P/Z/v+p888pM69jMMfS8Xd8F6I1kQ/I9HUGg==

argparse@^1.0.7:
  version "1.0.10"
  resolved "https://registry.yarnpkg.com/argparse/-/argparse-1.0.10.tgz#bcd6791ea5ae09725e17e5ad988134cd40b3d911"
  integrity sha512-o5Roy6tNG4SL/FOkCAN6RzjiakZS25RLYFrcMttJqbdd8BWrnA+fGz57iN5Pb06pvBGvl5gQ0B48dJlslXvoTg==
  dependencies:
    sprintf-js "~1.0.2"

argparse@^2.0.1:
  version "2.0.1"
  resolved "https://registry.yarnpkg.com/argparse/-/argparse-2.0.1.tgz#246f50f3ca78a3240f6c997e8a9bd1eac49e4b38"
  integrity sha512-8+9WqebbFzpX9OR+Wa6O29asIogeRMzcGtAINdpMHHyAg10f05aSFVBbcEqGf/PXw1EjAZ+q2/bEBg3DvurK3Q==

aria-query@5.1.3, aria-query@^5.0.0:
  version "5.1.3"
  resolved "https://registry.yarnpkg.com/aria-query/-/aria-query-5.1.3.tgz#19db27cd101152773631396f7a95a3b58c22c35e"
  integrity sha512-R5iJ5lkuHybztUfuOAznmboyjWq8O6sqNqtK7CLOqdydi54VNbORp49mb14KbWgG1QD3JFO9hJdZ+y4KutfdOQ==
  dependencies:
    deep-equal "^2.0.5"

aria-query@^4.2.2:
  version "4.2.2"
  resolved "https://registry.yarnpkg.com/aria-query/-/aria-query-4.2.2.tgz#0d2ca6c9aceb56b8977e9fed6aed7e15bbd2f83b"
  integrity sha512-o/HelwhuKpTj/frsOsbNLNgnNGVIFsVP/SW2BSF14gVl7kAfMOJ6/8wUAUvG1R1NHKrfG+2sHZTu0yauT1qBrA==
  dependencies:
    "@babel/runtime" "^7.10.2"
    "@babel/runtime-corejs3" "^7.10.2"

array-flatten@1.1.1:
  version "1.1.1"
  resolved "https://registry.yarnpkg.com/array-flatten/-/array-flatten-1.1.1.tgz#9a5f699051b1e7073328f2a008968b64ea2955d2"
  integrity sha512-PCVAQswWemu6UdxsDFFX/+gVeYqKAod3D3UVm91jHwynguOwAvYPhx8nNlM++NqRcK6CxxpUafjmhIdKiHibqg==

array-includes@^3.1.4, array-includes@^3.1.5, array-includes@^3.1.6:
  version "3.1.6"
  resolved "https://registry.yarnpkg.com/array-includes/-/array-includes-3.1.6.tgz#9e9e720e194f198266ba9e18c29e6a9b0e4b225f"
  integrity sha512-sgTbLvL6cNnw24FnbaDyjmvddQ2ML8arZsgaJhoABMoplz/4QRhtrYS+alr1BUM1Bwp6dhx8vVCBSLG+StwOFw==
  dependencies:
    call-bind "^1.0.2"
    define-properties "^1.1.4"
    es-abstract "^1.20.4"
    get-intrinsic "^1.1.3"
    is-string "^1.0.7"

array-timsort@^1.0.3:
  version "1.0.3"
  resolved "https://registry.yarnpkg.com/array-timsort/-/array-timsort-1.0.3.tgz#3c9e4199e54fb2b9c3fe5976396a21614ef0d926"
  integrity sha512-/+3GRL7dDAGEfM6TseQk/U+mi18TU2Ms9I3UlLdUMhz2hbvGNTKdj9xniwXfUqgYhHxRx0+8UnKkvlNwVU+cWQ==

array-union@^2.1.0:
  version "2.1.0"
  resolved "https://registry.yarnpkg.com/array-union/-/array-union-2.1.0.tgz#b798420adbeb1de828d84acd8a2e23d3efe85e8d"
  integrity sha512-HGyxoOTYUyCM6stUe6EJgnd4EoewAI7zMdfqO+kGjnlZmBDz/cR5pf8r/cR4Wq60sL/p0IkcjUEEPwS3GFrIyw==

array.prototype.flat@^1.2.5:
  version "1.3.1"
  resolved "https://registry.yarnpkg.com/array.prototype.flat/-/array.prototype.flat-1.3.1.tgz#ffc6576a7ca3efc2f46a143b9d1dda9b4b3cf5e2"
  integrity sha512-roTU0KWIOmJ4DRLmwKd19Otg0/mT3qPNt0Qb3GWW8iObuZXxrjB/pzn0R3hqpRSWg4HCwqx+0vwOnWnvlOyeIA==
  dependencies:
    call-bind "^1.0.2"
    define-properties "^1.1.4"
    es-abstract "^1.20.4"
    es-shim-unscopables "^1.0.0"

array.prototype.flatmap@^1.3.1:
  version "1.3.1"
  resolved "https://registry.yarnpkg.com/array.prototype.flatmap/-/array.prototype.flatmap-1.3.1.tgz#1aae7903c2100433cb8261cd4ed310aab5c4a183"
  integrity sha512-8UGn9O1FDVvMNB0UlLv4voxRMze7+FpHyF5mSMRjWHUMlpoDViniy05870VlxhfgTnLbpuwTzvD76MTtWxB/mQ==
  dependencies:
    call-bind "^1.0.2"
    define-properties "^1.1.4"
    es-abstract "^1.20.4"
    es-shim-unscopables "^1.0.0"

array.prototype.tosorted@^1.1.1:
  version "1.1.1"
  resolved "https://registry.yarnpkg.com/array.prototype.tosorted/-/array.prototype.tosorted-1.1.1.tgz#ccf44738aa2b5ac56578ffda97c03fd3e23dd532"
  integrity sha512-pZYPXPRl2PqWcsUs6LOMn+1f1532nEoPTYowBtqLwAW+W8vSVhkIGnmOX1t/UQjD6YGI0vcD2B1U7ZFGQH9jnQ==
  dependencies:
    call-bind "^1.0.2"
    define-properties "^1.1.4"
    es-abstract "^1.20.4"
    es-shim-unscopables "^1.0.0"
    get-intrinsic "^1.1.3"

asap@^2.0.0:
  version "2.0.6"
  resolved "https://registry.yarnpkg.com/asap/-/asap-2.0.6.tgz#e50347611d7e690943208bbdafebcbc2fb866d46"
  integrity sha512-BSHWgDSAiKs50o2Re8ppvp3seVHXSRM44cdSsT9FfNEUUZLOGWVCsiWaRPWM1Znn+mqZ1OfVZ3z3DWEzSp7hRA==

ast-types-flow@^0.0.7:
  version "0.0.7"
  resolved "https://registry.yarnpkg.com/ast-types-flow/-/ast-types-flow-0.0.7.tgz#f70b735c6bca1a5c9c22d982c3e39e7feba3bdad"
  integrity sha512-eBvWn1lvIApYMhzQMsu9ciLfkBY499mFZlNqG+/9WR7PVlroQw0vG30cOQQbaKz3sCEc44TAOu2ykzqXSNnwag==

asynckit@^0.4.0:
  version "0.4.0"
  resolved "https://registry.yarnpkg.com/asynckit/-/asynckit-0.4.0.tgz#c79ed97f7f34cb8f2ba1bc9790bcc366474b4b79"
  integrity sha512-Oei9OH4tRh0YqU3GxhX79dM/mwVgvbZJaSNaRk+bshkj0S5cfHcgYakreBjrHwatXKbz+IoIdYLxrKim2MjW0Q==

autoprefixer@^10.4.14:
  version "10.4.14"
  resolved "https://registry.yarnpkg.com/autoprefixer/-/autoprefixer-10.4.14.tgz#e28d49902f8e759dd25b153264e862df2705f79d"
  integrity sha512-FQzyfOsTlwVzjHxKEqRIAdJx9niO6VCBCoEwax/VLSoQF29ggECcPuBqUMZ+u8jCZOPSy8b8/8KnuFbp0SaFZQ==
  dependencies:
    browserslist "^4.21.5"
    caniuse-lite "^1.0.30001464"
    fraction.js "^4.2.0"
    normalize-range "^0.1.2"
    picocolors "^1.0.0"
    postcss-value-parser "^4.2.0"

available-typed-arrays@^1.0.5:
  version "1.0.5"
  resolved "https://registry.yarnpkg.com/available-typed-arrays/-/available-typed-arrays-1.0.5.tgz#92f95616501069d07d10edb2fc37d3e1c65123b7"
  integrity sha512-DMD0KiN46eipeziST1LPP/STfDU0sufISXmjSgvVsoU2tqxctQeASejWcfNtxYKqETM1UxQ8sp2OrSBWpHY6sw==

axe-core@^4.4.3:
  version "4.6.0"
  resolved "https://registry.yarnpkg.com/axe-core/-/axe-core-4.6.0.tgz#1d07514866fa51262734b3357932fcf86961383a"
  integrity sha512-L3ZNbXPTxMrl0+qTXAzn9FBRvk5XdO56K8CvcCKtlxv44Aw2w2NCclGuvCWxHPw1Riiq3ncP/sxFYj2nUqdoTw==

axobject-query@^2.2.0:
  version "2.2.0"
  resolved "https://registry.yarnpkg.com/axobject-query/-/axobject-query-2.2.0.tgz#943d47e10c0b704aa42275e20edf3722648989be"
  integrity sha512-Td525n+iPOOyUQIeBfcASuG6uJsDOITl7Mds5gFyerkWiX7qhUTdYUBlSgNMyVqtSJqwpt1kXGLdUt6SykLMRA==

babel-jest@^29.6.2:
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/babel-jest/-/babel-jest-29.6.2.tgz#cada0a59e07f5acaeb11cbae7e3ba92aec9c1126"
  integrity sha512-BYCzImLos6J3BH/+HvUCHG1dTf2MzmAB4jaVxHV+29RZLjR29XuYTmsf2sdDwkrb+FczkGo3kOhE7ga6sI0P4A==
  dependencies:
    "@jest/transform" "^29.6.2"
    "@types/babel__core" "^7.1.14"
    babel-plugin-istanbul "^6.1.1"
    babel-preset-jest "^29.5.0"
    chalk "^4.0.0"
    graceful-fs "^4.2.9"
    slash "^3.0.0"

babel-plugin-istanbul@^6.1.1:
  version "6.1.1"
  resolved "https://registry.yarnpkg.com/babel-plugin-istanbul/-/babel-plugin-istanbul-6.1.1.tgz#fa88ec59232fd9b4e36dbbc540a8ec9a9b47da73"
  integrity sha512-Y1IQok9821cC9onCx5otgFfRm7Lm+I+wwxOx738M/WLPZ9Q42m4IG5W0FNX8WLL2gYMZo3JkuXIH2DOpWM+qwA==
  dependencies:
    "@babel/helper-plugin-utils" "^7.0.0"
    "@istanbuljs/load-nyc-config" "^1.0.0"
    "@istanbuljs/schema" "^0.1.2"
    istanbul-lib-instrument "^5.0.4"
    test-exclude "^6.0.0"

babel-plugin-jest-hoist@^29.5.0:
  version "29.5.0"
  resolved "https://registry.yarnpkg.com/babel-plugin-jest-hoist/-/babel-plugin-jest-hoist-29.5.0.tgz#a97db437936f441ec196990c9738d4b88538618a"
  integrity sha512-zSuuuAlTMT4mzLj2nPnUm6fsE6270vdOfnpbJ+RmruU75UhLFvL0N2NgI7xpeS7NaB6hGqmd5pVpGTDYvi4Q3w==
  dependencies:
    "@babel/template" "^7.3.3"
    "@babel/types" "^7.3.3"
    "@types/babel__core" "^7.1.14"
    "@types/babel__traverse" "^7.0.6"

babel-preset-current-node-syntax@^1.0.0:
  version "1.0.1"
  resolved "https://registry.yarnpkg.com/babel-preset-current-node-syntax/-/babel-preset-current-node-syntax-1.0.1.tgz#b4399239b89b2a011f9ddbe3e4f401fc40cff73b"
  integrity sha512-M7LQ0bxarkxQoN+vz5aJPsLBn77n8QgTFmo8WK0/44auK2xlCXrYcUxHFxgU7qW5Yzw/CjmLRK2uJzaCd7LvqQ==
  dependencies:
    "@babel/plugin-syntax-async-generators" "^7.8.4"
    "@babel/plugin-syntax-bigint" "^7.8.3"
    "@babel/plugin-syntax-class-properties" "^7.8.3"
    "@babel/plugin-syntax-import-meta" "^7.8.3"
    "@babel/plugin-syntax-json-strings" "^7.8.3"
    "@babel/plugin-syntax-logical-assignment-operators" "^7.8.3"
    "@babel/plugin-syntax-nullish-coalescing-operator" "^7.8.3"
    "@babel/plugin-syntax-numeric-separator" "^7.8.3"
    "@babel/plugin-syntax-object-rest-spread" "^7.8.3"
    "@babel/plugin-syntax-optional-catch-binding" "^7.8.3"
    "@babel/plugin-syntax-optional-chaining" "^7.8.3"
    "@babel/plugin-syntax-top-level-await" "^7.8.3"

babel-preset-jest@^29.5.0:
  version "29.5.0"
  resolved "https://registry.yarnpkg.com/babel-preset-jest/-/babel-preset-jest-29.5.0.tgz#57bc8cc88097af7ff6a5ab59d1cd29d52a5916e2"
  integrity sha512-JOMloxOqdiBSxMAzjRaH023/vvcaSaec49zvg+2LmNsktC7ei39LTJGw02J+9uUtTZUq6xbLyJ4dxe9sSmIuAg==
  dependencies:
    babel-plugin-jest-hoist "^29.5.0"
    babel-preset-current-node-syntax "^1.0.0"

balanced-match@^1.0.0:
  version "1.0.2"
  resolved "https://registry.yarnpkg.com/balanced-match/-/balanced-match-1.0.2.tgz#e83e3a7e3f300b34cb9d87f615fa0cbf357690ee"
  integrity sha512-3oSeUO0TMV67hN1AmbXsK4yaqU7tjiHlbxRDZOpH0KW9+CeX4bRAaX0Anxt0tx2MrpRpWwQaPwIlISEJhYU5Pw==

base64-js@^1.3.1:
  version "1.5.1"
  resolved "https://registry.yarnpkg.com/base64-js/-/base64-js-1.5.1.tgz#1b1b440160a5bf7ad40b650f095963481903930a"
  integrity sha512-AKpaYlHn8t4SVbOHCy+b5+KKgvR4vrsD8vbvrbiQJps7fKDTkjkDry6ji0rUJjC0kzbNePLwzxq8iypo41qeWA==

binary-extensions@^2.0.0:
  version "2.2.0"
  resolved "https://registry.yarnpkg.com/binary-extensions/-/binary-extensions-2.2.0.tgz#75f502eeaf9ffde42fc98829645be4ea76bd9e2d"
  integrity sha512-jDctJ/IVQbZoJykoeHbhXpOlNBqGNcwXJKJog42E5HDPUwQTSdjCHdihjj0DlnheQ7blbT6dHOafNAiS8ooQKA==

bl@^4.1.0:
  version "4.1.0"
  resolved "https://registry.yarnpkg.com/bl/-/bl-4.1.0.tgz#451535264182bec2fbbc83a62ab98cf11d9f7b3a"
  integrity sha512-1W07cM9gS6DcLperZfFSj+bWLtaPGSOHWhPiGzXmvVJbRLdG82sH/Kn8EtW1VqWVA54AKf2h5k5BbnIbwF3h6w==
  dependencies:
    buffer "^5.5.0"
    inherits "^2.0.4"
    readable-stream "^3.4.0"

body-parser@1.20.1:
  version "1.20.1"
  resolved "https://registry.yarnpkg.com/body-parser/-/body-parser-1.20.1.tgz#b1812a8912c195cd371a3ee5e66faa2338a5c668"
  integrity sha512-jWi7abTbYwajOytWCQc37VulmWiRae5RyTpaCyDcS5/lMdtwSz5lOpDE67srw/HYe35f1z3fDQw+3txg7gNtWw==
  dependencies:
    bytes "3.1.2"
    content-type "~1.0.4"
    debug "2.6.9"
    depd "2.0.0"
    destroy "1.2.0"
    http-errors "2.0.0"
    iconv-lite "0.4.24"
    on-finished "2.4.1"
    qs "6.11.0"
    raw-body "2.5.1"
    type-is "~1.6.18"
    unpipe "1.0.0"

body-parser@1.20.2:
  version "1.20.2"
  resolved "https://registry.yarnpkg.com/body-parser/-/body-parser-1.20.2.tgz#6feb0e21c4724d06de7ff38da36dad4f57a747fd"
  integrity sha512-ml9pReCu3M61kGlqoTm2umSXTlRTuGTx0bfYj+uIUKKYycG5NtSbeetV3faSU6R7ajOPw0g/J1PvK4qNy7s5bA==
  dependencies:
    bytes "3.1.2"
    content-type "~1.0.5"
    debug "2.6.9"
    depd "2.0.0"
    destroy "1.2.0"
    http-errors "2.0.0"
    iconv-lite "0.4.24"
    on-finished "2.4.1"
    qs "6.11.0"
    raw-body "2.5.2"
    type-is "~1.6.18"
    unpipe "1.0.0"

brace-expansion@^1.1.7:
  version "1.1.11"
  resolved "https://registry.yarnpkg.com/brace-expansion/-/brace-expansion-1.1.11.tgz#3c7fcbf529d87226f3d2f52b966ff5271eb441dd"
  integrity sha512-iCuPHDFgrHX7H2vEI/5xpz07zSHB00TpugqhmYtVmMO6518mCuRMoOYFldEBl0g187ufozdaHgWKcYFb61qGiA==
  dependencies:
    balanced-match "^1.0.0"
    concat-map "0.0.1"

brace-expansion@^2.0.1:
  version "2.0.1"
  resolved "https://registry.yarnpkg.com/brace-expansion/-/brace-expansion-2.0.1.tgz#1edc459e0f0c548486ecf9fc99f2221364b9a0ae"
  integrity sha512-XnAIvQ8eM+kC6aULx6wuQiwVsnzsi9d3WxzV3FpWTGA19F621kwdbsAcFKXgKUHZWsy+mY6iL1sHTxWEFCytDA==
  dependencies:
    balanced-match "^1.0.0"

braces@^3.0.2, braces@~3.0.2:
  version "3.0.2"
  resolved "https://registry.yarnpkg.com/braces/-/braces-3.0.2.tgz#3454e1a462ee8d599e236df336cd9ea4f8afe107"
  integrity sha512-b8um+L1RzM3WDSzvhm6gIz1yfTbBt6YTlcEKAvsmqCZZFw46z626lVj9j1yEPW33H5H+lBQpZMP1k8l+78Ha0A==
  dependencies:
    fill-range "^7.0.1"

browserslist@^4.14.5, browserslist@^4.21.3:
  version "4.21.4"
  resolved "https://registry.yarnpkg.com/browserslist/-/browserslist-4.21.4.tgz#e7496bbc67b9e39dd0f98565feccdcb0d4ff6987"
  integrity sha512-CBHJJdDmgjl3daYjN5Cp5kbTf1mUhZoS+beLklHIvkOWscs83YAhLlF3Wsh/lciQYAcbBJgTOD44VtG31ZM4Hw==
  dependencies:
    caniuse-lite "^1.0.30001400"
    electron-to-chromium "^1.4.251"
    node-releases "^2.0.6"
    update-browserslist-db "^1.0.9"

browserslist@^4.21.5:
  version "4.21.10"
  resolved "https://registry.yarnpkg.com/browserslist/-/browserslist-4.21.10.tgz#dbbac576628c13d3b2231332cb2ec5a46e015bb0"
  integrity sha512-bipEBdZfVH5/pwrvqc+Ub0kUPVfGUhlKxbvfD+z1BDnPEO/X98ruXGA1WP5ASpAFKan7Qr6j736IacbZQuAlKQ==
  dependencies:
    caniuse-lite "^1.0.30001517"
    electron-to-chromium "^1.4.477"
    node-releases "^2.0.13"
    update-browserslist-db "^1.0.11"

bs-logger@0.x:
  version "0.2.6"
  resolved "https://registry.yarnpkg.com/bs-logger/-/bs-logger-0.2.6.tgz#eb7d365307a72cf974cc6cda76b68354ad336bd8"
  integrity sha512-pd8DCoxmbgc7hyPKOvxtqNcjYoOsABPQdcCUjGp3d42VR2CX1ORhk2A87oqqu5R1kk+76nsxZupkmyd+MVtCog==
  dependencies:
    fast-json-stable-stringify "2.x"

bser@2.1.1:
  version "2.1.1"
  resolved "https://registry.yarnpkg.com/bser/-/bser-2.1.1.tgz#e6787da20ece9d07998533cfd9de6f5c38f4bc05"
  integrity sha512-gQxTNE/GAfIIrmHLUE3oJyp5FO6HRBfhjnw4/wMmA63ZGDJnWBmgY/lyQBpnDUkGmAhbSe39tx2d/iTOAfglwQ==
  dependencies:
    node-int64 "^0.4.0"

buffer-from@^1.0.0:
  version "1.1.2"
  resolved "https://registry.yarnpkg.com/buffer-from/-/buffer-from-1.1.2.tgz#2b146a6fd72e80b4f55d255f35ed59a3a9a41bd5"
  integrity sha512-E+XQCRwSbaaiChtv6k6Dwgc+bx+Bs6vuKJHHl5kox/BaKbhiXzqQOwK4cO22yElGp2OCmjwVhT3HmxgyPGnJfQ==

buffer@^5.5.0:
  version "5.7.1"
  resolved "https://registry.yarnpkg.com/buffer/-/buffer-5.7.1.tgz#ba62e7c13133053582197160851a8f648e99eed0"
  integrity sha512-EHcyIPBQ4BSGlvjB16k5KgAJ27CIsHY/2JBmCRReo48y9rQ3MaUzWX3KVlBa4U7MyX02HdVj0K7C3WaB3ju7FQ==
  dependencies:
    base64-js "^1.3.1"
    ieee754 "^1.1.13"

busboy@1.6.0, busboy@^1.0.0:
  version "1.6.0"
  resolved "https://registry.yarnpkg.com/busboy/-/busboy-1.6.0.tgz#966ea36a9502e43cdb9146962523b92f531f6893"
  integrity sha512-8SFQbg/0hQ9xy3UNTB0YEnsNBbWfhf7RtnzpL7TkBiTBRfrQ9Fxcnz7VJsleJpyp6rVLvXiuORqjlHi5q+PYuA==
  dependencies:
    streamsearch "^1.1.0"

bytes@3.1.2:
  version "3.1.2"
  resolved "https://registry.yarnpkg.com/bytes/-/bytes-3.1.2.tgz#8b0beeb98605adf1b128fa4386403c009e0221a5"
  integrity sha512-/Nf7TyzTx6S3yRJObOAV7956r8cr2+Oj8AC5dt8wSP3BQAoeX58NoHyCU8P8zGkNXStjTSi6fzO6F0pBdcYbEg==

call-bind@^1.0.0, call-bind@^1.0.2:
  version "1.0.2"
  resolved "https://registry.yarnpkg.com/call-bind/-/call-bind-1.0.2.tgz#b1d4e89e688119c3c9a903ad30abb2f6a919be3c"
  integrity sha512-7O+FbCihrB5WGbFYesctwmTKae6rOiIzmz1icreWJ+0aA7LJfuqhEso2T9ncpcFtzMQtzXf2QGGueWJGTYsqrA==
  dependencies:
    function-bind "^1.1.1"
    get-intrinsic "^1.0.2"

callsites@^3.0.0:
  version "3.1.0"
  resolved "https://registry.yarnpkg.com/callsites/-/callsites-3.1.0.tgz#b3630abd8943432f54b3f0519238e33cd7df2f73"
  integrity sha512-P8BjAsXvZS+VIDUI11hHCQEv74YT67YUi5JJFNWIqL235sBmjX4+qx9Muvls5ivyNENctx46xQLQ3aTuE7ssaQ==

camelcase-css@^2.0.1:
  version "2.0.1"
  resolved "https://registry.yarnpkg.com/camelcase-css/-/camelcase-css-2.0.1.tgz#ee978f6947914cc30c6b44741b6ed1df7f043fd5"
  integrity sha512-QOSvevhslijgYwRx6Rv7zKdMF8lbRmx+uQGx2+vDc+KI/eBnsy9kit5aj23AgGu3pa4t9AgwbnXWqS+iOY+2aA==

camelcase@^5.3.1:
  version "5.3.1"
  resolved "https://registry.yarnpkg.com/camelcase/-/camelcase-5.3.1.tgz#e3c9b31569e106811df242f715725a1f4c494320"
  integrity sha512-L28STB170nwWS63UjtlEOE3dldQApaJXZkOI1uMFfzf3rRuPegHaHesyee+YxQ+W6SvRDQV6UrdOdRiR153wJg==

camelcase@^6.2.0:
  version "6.3.0"
  resolved "https://registry.yarnpkg.com/camelcase/-/camelcase-6.3.0.tgz#5685b95eb209ac9c0c177467778c9c84df58ba9a"
  integrity sha512-Gmy6FhYlCY7uOElZUSbxo2UCDH8owEk996gkbrpsgGtrJLM3J7jGxl9Ic7Qwwj4ivOE5AWZWRMecDdF7hqGjFA==

caniuse-lite@^1.0.30001400, caniuse-lite@^1.0.30001406:
  version "1.0.30001439"
  resolved "https://registry.yarnpkg.com/caniuse-lite/-/caniuse-lite-1.0.30001439.tgz#ab7371faeb4adff4b74dad1718a6fd122e45d9cb"
  integrity sha512-1MgUzEkoMO6gKfXflStpYgZDlFM7M/ck/bgfVCACO5vnAf0fXoNVHdWtqGU+MYca+4bL9Z5bpOVmR33cWW9G2A==

caniuse-lite@^1.0.30001464, caniuse-lite@^1.0.30001517:
  version "1.0.30001518"
  resolved "https://registry.yarnpkg.com/caniuse-lite/-/caniuse-lite-1.0.30001518.tgz#b3ca93904cb4699c01218246c4d77a71dbe97150"
  integrity sha512-rup09/e3I0BKjncL+FesTayKtPrdwKhUufQFd3riFw1hHg8JmIFoInYfB102cFcY/pPgGmdyl/iy+jgiDi2vdA==

chalk@4.1.2, chalk@^4.0.0, chalk@^4.1.0, chalk@^4.1.1, chalk@^4.1.2:
  version "4.1.2"
  resolved "https://registry.yarnpkg.com/chalk/-/chalk-4.1.2.tgz#aac4e2b7734a740867aeb16bf02aad556a1e7a01"
  integrity sha512-oKnbhFyRIXpUuez8iBMmyEa4nbj4IOQyuhc/wy9kY7/WVPcwIO9VA668Pu8RkO7+0G76SLROeyw9CpQ061i4mA==
  dependencies:
    ansi-styles "^4.1.0"
    supports-color "^7.1.0"

chalk@^2.0.0:
  version "2.4.2"
  resolved "https://registry.yarnpkg.com/chalk/-/chalk-2.4.2.tgz#cd42541677a54333cf541a49108c1432b44c9424"
  integrity sha512-Mti+f9lpJNcwF4tWV8/OrTTtF1gZi+f8FqlyAdouralcFWFQWF2+NgCHShjkCb+IFBLq9buZwE1xckQU4peSuQ==
  dependencies:
    ansi-styles "^3.2.1"
    escape-string-regexp "^1.0.5"
    supports-color "^5.3.0"

chalk@^3.0.0:
  version "3.0.0"
  resolved "https://registry.yarnpkg.com/chalk/-/chalk-3.0.0.tgz#3f73c2bf526591f574cc492c51e2456349f844e4"
  integrity sha512-4D3B6Wf41KOYRFdszmDqMCGq5VV/uMAB273JILmO+3jAlh8X4qDtdtgCR3fxtbLEMzSx22QdhnDcJvu2u1fVwg==
  dependencies:
    ansi-styles "^4.1.0"
    supports-color "^7.1.0"

char-regex@^1.0.2:
  version "1.0.2"
  resolved "https://registry.yarnpkg.com/char-regex/-/char-regex-1.0.2.tgz#d744358226217f981ed58f479b1d6bcc29545dcf"
  integrity sha512-kWWXztvZ5SBQV+eRgKFeh8q5sLuZY2+8WUIzlxWVTg+oGwY14qylx1KbKzHd8P6ZYkAg0xyIDU9JMHhyJMZ1jw==

chardet@^0.7.0:
  version "0.7.0"
  resolved "https://registry.yarnpkg.com/chardet/-/chardet-0.7.0.tgz#90094849f0937f2eedc2425d0d28a9e5f0cbad9e"
  integrity sha512-mT8iDcrh03qDGRRmoA2hmBJnxpllMR+0/0qlzjqZES6NdiWDcZkCNAk4rPFZ9Q85r27unkiNNg8ZOiwZXBHwcA==

chokidar@3.5.3, chokidar@^3.5.3:
  version "3.5.3"
  resolved "https://registry.yarnpkg.com/chokidar/-/chokidar-3.5.3.tgz#1cf37c8707b932bd1af1ae22c0432e2acd1903bd"
  integrity sha512-Dr3sfKRP6oTcjf2JmUmFJfeVMvXBdegxB0iVQ5eb2V10uFJUCAS8OByZdVAyVb8xXNz3GjjTgj9kLWsZTqE6kw==
  dependencies:
    anymatch "~3.1.2"
    braces "~3.0.2"
    glob-parent "~5.1.2"
    is-binary-path "~2.1.0"
    is-glob "~4.0.1"
    normalize-path "~3.0.0"
    readdirp "~3.6.0"
  optionalDependencies:
    fsevents "~2.3.2"

chrome-trace-event@^1.0.2:
  version "1.0.3"
  resolved "https://registry.yarnpkg.com/chrome-trace-event/-/chrome-trace-event-1.0.3.tgz#1015eced4741e15d06664a957dbbf50d041e26ac"
  integrity sha512-p3KULyQg4S7NIHixdwbGX+nFHkoBiA4YQmyWtjb8XngSKV124nJmRysgAeujbUVb15vh+RvFUfCPqU7rXk+hZg==

ci-info@^3.2.0:
  version "3.7.0"
  resolved "https://registry.yarnpkg.com/ci-info/-/ci-info-3.7.0.tgz#6d01b3696c59915b6ce057e4aa4adfc2fa25f5ef"
  integrity sha512-2CpRNYmImPx+RXKLq6jko/L07phmS9I02TyqkcNU20GCF/GgaWvc58hPtjxDX8lPpkdwc9sNh72V9k00S7ezog==

cjs-module-lexer@^1.0.0:
  version "1.2.2"
  resolved "https://registry.yarnpkg.com/cjs-module-lexer/-/cjs-module-lexer-1.2.2.tgz#9f84ba3244a512f3a54e5277e8eef4c489864e40"
  integrity sha512-cOU9usZw8/dXIXKtwa8pM0OTJQuJkxMN6w30csNRUerHfeQ5R6U3kkU/FtJeIf3M202OHfY2U8ccInBG7/xogA==

cli-cursor@^3.1.0:
  version "3.1.0"
  resolved "https://registry.yarnpkg.com/cli-cursor/-/cli-cursor-3.1.0.tgz#264305a7ae490d1d03bf0c9ba7c925d1753af307"
  integrity sha512-I/zHAwsKf9FqGoXM4WWRACob9+SNukZTd94DWF57E4toouRulbCxcUh6RKUEOQlYTHJnzkPMySvPNaaSLNfLZw==
  dependencies:
    restore-cursor "^3.1.0"

cli-spinners@^2.5.0:
  version "2.7.0"
  resolved "https://registry.yarnpkg.com/cli-spinners/-/cli-spinners-2.7.0.tgz#f815fd30b5f9eaac02db604c7a231ed7cb2f797a"
  integrity sha512-qu3pN8Y3qHNgE2AFweciB1IfMnmZ/fsNTEE+NOFjmGB2F/7rLhnhzppvpCnN4FovtP26k8lHyy9ptEbNwWFLzw==

cli-table3@0.6.3:
  version "0.6.3"
  resolved "https://registry.yarnpkg.com/cli-table3/-/cli-table3-0.6.3.tgz#61ab765aac156b52f222954ffc607a6f01dbeeb2"
  integrity sha512-w5Jac5SykAeZJKntOxJCrm63Eg5/4dhMWIcuTbo9rpE+brgaSZo0RuNJZeOyMgsUdhDeojvgyQLmjI+K50ZGyg==
  dependencies:
    string-width "^4.2.0"
  optionalDependencies:
    "@colors/colors" "1.5.0"

cli-width@^3.0.0:
  version "3.0.0"
  resolved "https://registry.yarnpkg.com/cli-width/-/cli-width-3.0.0.tgz#a2f48437a2caa9a22436e794bf071ec9e61cedf6"
  integrity sha512-FxqpkPPwu1HjuN93Omfm4h8uIanXofW0RxVEW3k5RKx+mJJYSthzNhp32Kzxxy3YAEZ/Dc/EWN1vZRY0+kOhbw==

client-only@0.0.1:
  version "0.0.1"
  resolved "https://registry.yarnpkg.com/client-only/-/client-only-0.0.1.tgz#38bba5d403c41ab150bff64a95c85013cf73bca1"
  integrity sha512-IV3Ou0jSMzZrd3pZ48nLkT9DA7Ag1pnPzaiQhpW7c3RbcqqzvzzVu+L8gfqMp/8IM2MQtSiqaCxrrcfu8I8rMA==

cliui@^8.0.1:
  version "8.0.1"
  resolved "https://registry.yarnpkg.com/cliui/-/cliui-8.0.1.tgz#0c04b075db02cbfe60dc8e6cf2f5486b1a3608aa"
  integrity sha512-BSeNnyus75C4//NQ9gQt1/csTXyo/8Sb+afLAkzAptFuMsod9HFokGNudZpi/oQV73hnVK+sR+5PVRMd+Dr7YQ==
  dependencies:
    string-width "^4.2.0"
    strip-ansi "^6.0.1"
    wrap-ansi "^7.0.0"

clone@^1.0.2:
  version "1.0.4"
  resolved "https://registry.yarnpkg.com/clone/-/clone-1.0.4.tgz#da309cc263df15994c688ca902179ca3c7cd7c7e"
  integrity sha512-JQHZ2QMW6l3aH/j6xCqQThY/9OH4D/9ls34cgkUBiEeocRTU04tHfKPBsUK1PqZCUQM7GiA0IIXJSuXHI64Kbg==

co@^4.6.0:
  version "4.6.0"
  resolved "https://registry.yarnpkg.com/co/-/co-4.6.0.tgz#6ea6bdf3d853ae54ccb8e47bfa0bf3f9031fb184"
  integrity sha512-QVb0dM5HvG+uaxitm8wONl7jltx8dqhfU33DcqtOZcLSVIKSDDLDi7+0LbAKiyI8hD9u42m2YxXSkMGWThaecQ==

collect-v8-coverage@^1.0.0:
  version "1.0.1"
  resolved "https://registry.yarnpkg.com/collect-v8-coverage/-/collect-v8-coverage-1.0.1.tgz#cc2c8e94fc18bbdffe64d6534570c8a673b27f59"
  integrity sha512-iBPtljfCNcTKNAto0KEtDfZ3qzjJvqE3aTGZsbhjSBlorqpXJlaWWtPO35D+ZImoC3KWejX64o+yPGxhWSTzfg==

color-convert@^1.9.0:
  version "1.9.3"
  resolved "https://registry.yarnpkg.com/color-convert/-/color-convert-1.9.3.tgz#bb71850690e1f136567de629d2d5471deda4c1e8"
  integrity sha512-QfAUtd+vFdAtFQcC8CCyYt1fYWxSqAiK2cSD6zDB8N3cpsEBAvRxp9zOGg6G/SHHJYAT88/az/IuDGALsNVbGg==
  dependencies:
    color-name "1.1.3"

color-convert@^2.0.1:
  version "2.0.1"
  resolved "https://registry.yarnpkg.com/color-convert/-/color-convert-2.0.1.tgz#72d3a68d598c9bdb3af2ad1e84f21d896abd4de3"
  integrity sha512-RRECPsj7iu/xb5oKYcsFHSppFNnsj/52OVTRKb4zP5onXwVF3zVmmToNcOfGC+CRDpfK/U584fMg38ZHCaElKQ==
  dependencies:
    color-name "~1.1.4"

color-name@1.1.3:
  version "1.1.3"
  resolved "https://registry.yarnpkg.com/color-name/-/color-name-1.1.3.tgz#a7d0558bd89c42f795dd42328f740831ca53bc25"
  integrity sha512-72fSenhMw2HZMTVHeCA9KCmpEIbzWiQsjN+BHcBbS9vr1mtt+vJjPdksIBNUmKAW8TFUDPJK5SUU3QhE9NEXDw==

color-name@~1.1.4:
  version "1.1.4"
  resolved "https://registry.yarnpkg.com/color-name/-/color-name-1.1.4.tgz#c2a09a87acbde69543de6f63fa3995c826c536a2"
  integrity sha512-dOy+3AuW3a2wNbZHIuMZpTcgjGuLU/uBL/ubcZF9OXbDo8ff4O8yVp5Bf0efS8uEoYo5q4Fx7dY9OgQGXgAsQA==

combined-stream@^1.0.8:
  version "1.0.8"
  resolved "https://registry.yarnpkg.com/combined-stream/-/combined-stream-1.0.8.tgz#c3d45a8b34fd730631a110a8a2520682b31d5a7f"
  integrity sha512-FQN4MRfuJeHf7cBbBMJFXhKSDq+2kAArBlmRBvcvFE5BB1HZKXtSFASDhdlz9zOYwxh8lDdnvmMOe/+5cdoEdg==
  dependencies:
    delayed-stream "~1.0.0"

commander@4.1.1, commander@^4.0.0:
  version "4.1.1"
  resolved "https://registry.yarnpkg.com/commander/-/commander-4.1.1.tgz#9fd602bd936294e9e9ef46a3f4d6964044b18068"
  integrity sha512-NOKm8xhkzAjzFx8B2v5OAHT+u5pRQc2UCa2Vq9jYL/31o2wi9mxBA7LIFs3sV5VSC49z6pEhfbMULvShKj26WA==

commander@^2.20.0:
  version "2.20.3"
  resolved "https://registry.yarnpkg.com/commander/-/commander-2.20.3.tgz#fd485e84c03eb4881c20722ba48035e8531aeb33"
  integrity sha512-GpVkmM8vF2vQUkj2LvZmD35JxeJOLCwJ9cUkugyk2nuhbv3+mJvpLYYt+0+USMxE+oj+ey/lJEnhZw75x/OMcQ==

comment-json@4.2.3:
  version "4.2.3"
  resolved "https://registry.yarnpkg.com/comment-json/-/comment-json-4.2.3.tgz#50b487ebbf43abe44431f575ebda07d30d015365"
  integrity sha512-SsxdiOf064DWoZLH799Ata6u7iV658A11PlWtZATDlXPpKGJnbJZ5Z24ybixAi+LUUqJ/GKowAejtC5GFUG7Tw==
  dependencies:
    array-timsort "^1.0.3"
    core-util-is "^1.0.3"
    esprima "^4.0.1"
    has-own-prop "^2.0.0"
    repeat-string "^1.6.1"

component-emitter@^1.3.0:
  version "1.3.0"
  resolved "https://registry.yarnpkg.com/component-emitter/-/component-emitter-1.3.0.tgz#16e4070fba8ae29b679f2215853ee181ab2eabc0"
  integrity sha512-Rd3se6QB+sO1TwqZjscQrurpEPIfO0/yYnSin6Q/rD3mOutHvUrCAhJub3r90uNb+SESBuE0QYoB90YdfatsRg==

concat-map@0.0.1:
  version "0.0.1"
  resolved "https://registry.yarnpkg.com/concat-map/-/concat-map-0.0.1.tgz#d8a96bd77fd68df7793a73036a3ba0d5405d477b"
  integrity sha512-/Srv4dswyQNBfohGpz9o6Yb3Gz3SrUDqBH5rTuhGR7ahtlbYKnVxw2bCFMRljaA7EXHaXZ8wsHdodFvbkhKmqg==

concat-stream@^1.5.2:
  version "1.6.2"
  resolved "https://registry.yarnpkg.com/concat-stream/-/concat-stream-1.6.2.tgz#904bdf194cd3122fc675c77fc4ac3d4ff0fd1a34"
  integrity sha512-27HBghJxjiZtIk3Ycvn/4kbJk/1uZuJFfuPEns6LaEvpvG1f0hTea8lilrouyo9mVc2GWdcEZ8OLoGmSADlrCw==
  dependencies:
    buffer-from "^1.0.0"
    inherits "^2.0.3"
    readable-stream "^2.2.2"
    typedarray "^0.0.6"

consola@^2.15.0:
  version "2.15.3"
  resolved "https://registry.yarnpkg.com/consola/-/consola-2.15.3.tgz#2e11f98d6a4be71ff72e0bdf07bd23e12cb61550"
  integrity sha512-9vAdYbHj6x2fLKC4+oPH0kFzY/orMZyG2Aj+kNylHxKGJ/Ed4dpNyAQYwJOdqO4zdM7XpVHmyejQDcQHrnuXbw==

content-disposition@0.5.4:
  version "0.5.4"
  resolved "https://registry.yarnpkg.com/content-disposition/-/content-disposition-0.5.4.tgz#8b82b4efac82512a02bb0b1dcec9d2c5e8eb5bfe"
  integrity sha512-FveZTNuGw04cxlAiWbzi6zTAL/lhehaWbTtgluJh4/E95DqMwTmha3KZN1aAWA8cFIhHzMZUvLevkw5Rqk+tSQ==
  dependencies:
    safe-buffer "5.2.1"

content-type@~1.0.4:
  version "1.0.4"
  resolved "https://registry.yarnpkg.com/content-type/-/content-type-1.0.4.tgz#e138cc75e040c727b1966fe5e5f8c9aee256fe3b"
  integrity sha512-hIP3EEPs8tB9AT1L+NUqtwOAps4mk2Zob89MWXMHjHWg9milF/j4osnnQLXBCBFBk/tvIG/tUc9mOUJiPBhPXA==

content-type@~1.0.5:
  version "1.0.5"
  resolved "https://registry.yarnpkg.com/content-type/-/content-type-1.0.5.tgz#8b773162656d1d1086784c8f23a54ce6d73d7918"
  integrity sha512-nTjqfcBFEipKdXCv4YDQWCfmcLZKm81ldF0pAopTvyrFGVbcR6P/VAAd5G7N+0tTr8QqiU0tFadD6FK4NtJwOA==

convert-source-map@^1.6.0, convert-source-map@^1.7.0:
  version "1.9.0"
  resolved "https://registry.yarnpkg.com/convert-source-map/-/convert-source-map-1.9.0.tgz#7faae62353fb4213366d0ca98358d22e8368b05f"
  integrity sha512-ASFBup0Mz1uyiIjANan1jzLQami9z1PoYSZCiiYW2FczPbenXc45FZdBZLzOT+r6+iciuEModtmCti+hjaAk0A==

convert-source-map@^2.0.0:
  version "2.0.0"
  resolved "https://registry.yarnpkg.com/convert-source-map/-/convert-source-map-2.0.0.tgz#4b560f649fc4e918dd0ab75cf4961e8bc882d82a"
  integrity sha512-Kvp459HrV2FEJ1CAsi1Ku+MY3kasH19TFykTz2xWmMeq6bk2NU3XXvfJ+Q61m0xktWwt+1HSYf3JZsTms3aRJg==

cookie-signature@1.0.6:
  version "1.0.6"
  resolved "https://registry.yarnpkg.com/cookie-signature/-/cookie-signature-1.0.6.tgz#e303a882b342cc3ee8ca513a79999734dab3ae2c"
  integrity sha512-QADzlaHc8icV8I7vbaJXJwod9HWYp8uCqf1xa4OfNu1T7JVxQIrUgOWtHdNDtPiywmFbiS12VjotIXLrKM3orQ==

cookie@0.5.0:
  version "0.5.0"
  resolved "https://registry.yarnpkg.com/cookie/-/cookie-0.5.0.tgz#d1f5d71adec6558c58f389987c366aa47e994f8b"
  integrity sha512-YZ3GUyn/o8gfKJlnlX7g7xq4gyO6OSuhGPKaaGssGB2qgDUS0gPgtTvoyZLTt9Ab6dC4hfc9dV5arkvc/OCmrw==

cookiejar@^2.1.3:
  version "2.1.3"
  resolved "https://registry.yarnpkg.com/cookiejar/-/cookiejar-2.1.3.tgz#fc7a6216e408e74414b90230050842dacda75acc"
  integrity sha512-JxbCBUdrfr6AQjOXrxoTvAMJO4HBTUIlBzslcJPAz+/KT8yk53fXun51u+RenNYvad/+Vc2DIz5o9UxlCDymFQ==

core-js-pure@^3.25.1:
  version "3.26.1"
  resolved "https://registry.yarnpkg.com/core-js-pure/-/core-js-pure-3.26.1.tgz#653f4d7130c427820dcecd3168b594e8bb095a33"
  integrity sha512-VVXcDpp/xJ21KdULRq/lXdLzQAtX7+37LzpyfFM973il0tWSsDEoyzG38G14AjTpK9VTfiNM9jnFauq/CpaWGQ==

core-util-is@^1.0.3, core-util-is@~1.0.0:
  version "1.0.3"
  resolved "https://registry.yarnpkg.com/core-util-is/-/core-util-is-1.0.3.tgz#a6042d3634c2b27e9328f837b965fac83808db85"
  integrity sha512-ZQBvi1DcpJ4GDqanjucZ2Hj3wEO5pZDS89BWbkcrvdxksJorwUDDZamX9ldFkp9aw2lmBDLgkObEA4DWNJ9FYQ==

cors@2.8.5:
  version "2.8.5"
  resolved "https://registry.yarnpkg.com/cors/-/cors-2.8.5.tgz#eac11da51592dd86b9f06f6e7ac293b3df875d29"
  integrity sha512-KIHbLJqu73RGr/hnbrO9uBeixNGuvSQjul/jdFvS/KFSIH1hWVd1ng7zOHx+YrEfInLG7q4n6GHQ9cDtxv/P6g==
  dependencies:
    object-assign "^4"
    vary "^1"

cosmiconfig@^7.0.1:
  version "7.1.0"
  resolved "https://registry.yarnpkg.com/cosmiconfig/-/cosmiconfig-7.1.0.tgz#1443b9afa596b670082ea46cbd8f6a62b84635f6"
  integrity sha512-AdmX6xUzdNASswsFtmwSt7Vj8po9IuqXm0UXz7QKPuEUmPB4XyjGfaAr2PSuELMwkRMVH1EpIkX5bTZGRB3eCA==
  dependencies:
    "@types/parse-json" "^4.0.0"
    import-fresh "^3.2.1"
    parse-json "^5.0.0"
    path-type "^4.0.0"
    yaml "^1.10.0"

create-require@^1.1.0:
  version "1.1.1"
  resolved "https://registry.yarnpkg.com/create-require/-/create-require-1.1.1.tgz#c1d7e8f1e5f6cfc9ff65f9cd352d37348756c333"
  integrity sha512-dcKFX3jn0MpIaXjisoRvexIJVEKzaq7z2rZKxf+MSr9TkdmHmsU4m2lcLojrj/FHl8mk5VxMmYA+ftRkP/3oKQ==

cross-spawn@^7.0.0, cross-spawn@^7.0.2, cross-spawn@^7.0.3:
  version "7.0.3"
  resolved "https://registry.yarnpkg.com/cross-spawn/-/cross-spawn-7.0.3.tgz#f73a85b9d5d41d045551c177e2882d4ac85728a6"
  integrity sha512-iRDPJKUPVEND7dHPO8rkbOnPpyDygcDFtWjpeWNCgy8WP2rXcxXL8TskReQl6OrB2G7+UJrags1q15Fudc7G6w==
  dependencies:
    path-key "^3.1.0"
    shebang-command "^2.0.0"
    which "^2.0.1"

css.escape@^1.5.1:
  version "1.5.1"
  resolved "https://registry.yarnpkg.com/css.escape/-/css.escape-1.5.1.tgz#42e27d4fa04ae32f931a4b4d4191fa9cddee97cb"
  integrity sha512-YUifsXXuknHlUsmlgyY0PKzgPOr7/FjCePfHNt0jxm83wHZi44VDMQ7/fGNkjY3/jV1MC+1CmZbaHzugyeRtpg==

cssesc@^3.0.0:
  version "3.0.0"
  resolved "https://registry.yarnpkg.com/cssesc/-/cssesc-3.0.0.tgz#37741919903b868565e1c09ea747445cd18983ee"
  integrity sha512-/Tb/JcjK111nNScGob5MNtsntNM1aCNUDipB/TkwZFhyDrrE47SOx/18wF2bbjgc3ZzCSKW1T5nt5EbFoAz/Vg==

cssom@^0.5.0:
  version "0.5.0"
  resolved "https://registry.yarnpkg.com/cssom/-/cssom-0.5.0.tgz#d254fa92cd8b6fbd83811b9fbaed34663cc17c36"
  integrity sha512-iKuQcq+NdHqlAcwUY0o/HL69XQrUaQdMjmStJ8JFmUaiiQErlhrmuigkg/CU4E2J0IyUKUrMAgl36TvN67MqTw==

cssom@~0.3.6:
  version "0.3.8"
  resolved "https://registry.yarnpkg.com/cssom/-/cssom-0.3.8.tgz#9f1276f5b2b463f2114d3f2c75250af8c1a36f4a"
  integrity sha512-b0tGHbfegbhPJpxpiBPU2sCkigAqtM9O121le6bbOlgyV+NyGyCmVfJ6QW9eRjz8CpNfWEOYBIMIGRYkLwsIYg==

cssstyle@^2.3.0:
  version "2.3.0"
  resolved "https://registry.yarnpkg.com/cssstyle/-/cssstyle-2.3.0.tgz#ff665a0ddbdc31864b09647f34163443d90b0852"
  integrity sha512-AZL67abkUzIuvcHqk7c09cezpGNcxUxU4Ioi/05xHk4DQeTkWmGYftIE6ctU6AEt+Gn4n1lDStOtj7FKycP71A==
  dependencies:
    cssom "~0.3.6"

csstype@^3.0.2:
  version "3.1.1"
  resolved "https://registry.yarnpkg.com/csstype/-/csstype-3.1.1.tgz#841b532c45c758ee546a11d5bd7b7b473c8c30b9"
  integrity sha512-DJR/VvkAvSZW9bTouZue2sSxDwdTN92uHjqeKVm+0dAqdfNykRzQ95tay8aXMBAAPpUiq4Qcug2L7neoRh2Egw==

damerau-levenshtein@^1.0.8:
  version "1.0.8"
  resolved "https://registry.yarnpkg.com/damerau-levenshtein/-/damerau-levenshtein-1.0.8.tgz#b43d286ccbd36bc5b2f7ed41caf2d0aba1f8a6e7"
  integrity sha512-sdQSFB7+llfUcQHUQO3+B8ERRj0Oa4w9POWMI/puGtuf7gFywGmkaLCElnudfTiKZV+NvHqL0ifzdrI8Ro7ESA==

data-urls@^3.0.2:
  version "3.0.2"
  resolved "https://registry.yarnpkg.com/data-urls/-/data-urls-3.0.2.tgz#9cf24a477ae22bcef5cd5f6f0bfbc1d2d3be9143"
  integrity sha512-Jy/tj3ldjZJo63sVAvg6LHt2mHvl4V6AgRAmNDtLdm7faqtsx+aJG42rsyCo9JCoRVKwPFzKlIPx3DIibwSIaQ==
  dependencies:
    abab "^2.0.6"
    whatwg-mimetype "^3.0.0"
    whatwg-url "^11.0.0"

debug@2.6.9, debug@^2.6.9:
  version "2.6.9"
  resolved "https://registry.yarnpkg.com/debug/-/debug-2.6.9.tgz#5d128515df134ff327e90a4c93f4e077a536341f"
  integrity sha512-bC7ElrdJaJnPbAP+1EotYvqZsb3ecl5wi6Bfi6BJTUcNowp6cvspg0jXznRTKDjm/E7AdgFBVeAPVMNcKGsHMA==
  dependencies:
    ms "2.0.0"

debug@4, debug@^4.1.0, debug@^4.1.1, debug@^4.3.2, debug@^4.3.4:
  version "4.3.4"
  resolved "https://registry.yarnpkg.com/debug/-/debug-4.3.4.tgz#1319f6579357f2338d3337d2cdd4914bb5dcc865"
  integrity sha512-PRWFHuSU3eDtQJPvnNY7Jcket1j0t5OuOsFzPPzsekD52Zl8qUfFIPEiswXqIvHWGVHOgX+7G/vCNNhehwxfkQ==
  dependencies:
    ms "2.1.2"

debug@^3.2.7:
  version "3.2.7"
  resolved "https://registry.yarnpkg.com/debug/-/debug-3.2.7.tgz#72580b7e9145fb39b6676f9c5e5fb100b934179a"
  integrity sha512-CFjzYYAi4ThfiQvizrFQevTTXHtnCqWfe7x1AhgEscTz6ZbLbfoLRLPugTQyBth6f8ZERVUSyWHFD/7Wu4t1XQ==
  dependencies:
    ms "^2.1.1"

decimal.js@^10.4.2:
  version "10.4.3"
  resolved "https://registry.yarnpkg.com/decimal.js/-/decimal.js-10.4.3.tgz#1044092884d245d1b7f65725fa4ad4c6f781cc23"
  integrity sha512-VBBaLc1MgL5XpzgIP7ny5Z6Nx3UrRkIViUkPUdtl9aya5amy3De1gsUUSB1g3+3sExYNjCAsAznmukyxCb1GRA==

dedent@^1.0.0:
  version "1.5.1"
  resolved "https://registry.yarnpkg.com/dedent/-/dedent-1.5.1.tgz#4f3fc94c8b711e9bb2800d185cd6ad20f2a90aff"
  integrity sha512-+LxW+KLWxu3HW3M2w2ympwtqPrqYRzU8fqi6Fhd18fBALe15blJPI/I4+UHveMVG6lJqB4JNd4UG0S5cnVHwIg==

deep-equal@^2.0.5:
  version "2.1.0"
  resolved "https://registry.yarnpkg.com/deep-equal/-/deep-equal-2.1.0.tgz#5ba60402cf44ab92c2c07f3f3312c3d857a0e1dd"
  integrity sha512-2pxgvWu3Alv1PoWEyVg7HS8YhGlUFUV7N5oOvfL6d+7xAmLSemMwv/c8Zv/i9KFzxV5Kt5CAvQc70fLwVuf4UA==
  dependencies:
    call-bind "^1.0.2"
    es-get-iterator "^1.1.2"
    get-intrinsic "^1.1.3"
    is-arguments "^1.1.1"
    is-date-object "^1.0.5"
    is-regex "^1.1.4"
    isarray "^2.0.5"
    object-is "^1.1.5"
    object-keys "^1.1.1"
    object.assign "^4.1.4"
    regexp.prototype.flags "^1.4.3"
    side-channel "^1.0.4"
    which-boxed-primitive "^1.0.2"
    which-collection "^1.0.1"
    which-typed-array "^1.1.8"

deep-is@^0.1.3, deep-is@~0.1.3:
  version "0.1.4"
  resolved "https://registry.yarnpkg.com/deep-is/-/deep-is-0.1.4.tgz#a6f2dce612fadd2ef1f519b73551f17e85199831"
  integrity sha512-oIPzksmTg4/MriiaYGO+okXDT7ztn/w3Eptv/+gSIdMdKsJo0u4CfYNFJPy+4SKMuCqGw2wxnA+URMg3t8a/bQ==

deepmerge@^4.2.2:
  version "4.2.2"
  resolved "https://registry.yarnpkg.com/deepmerge/-/deepmerge-4.2.2.tgz#44d2ea3679b8f4d4ffba33f03d865fc1e7bf4955"
  integrity sha512-FJ3UgI4gIl+PHZm53knsuSFpE+nESMr7M4v9QcgB7S63Kj/6WqMiFQJpBBYz1Pt+66bZpP3Q7Lye0Oo9MPKEdg==

defaults@^1.0.3:
  version "1.0.4"
  resolved "https://registry.yarnpkg.com/defaults/-/defaults-1.0.4.tgz#b0b02062c1e2aa62ff5d9528f0f98baa90978d7a"
  integrity sha512-eFuaLoy/Rxalv2kr+lqMlUnrDWV+3j4pljOIJgLIhI058IQfWJ7vXhyEIHu+HtC738klGALYxOKDO0bQP3tg8A==
  dependencies:
    clone "^1.0.2"

define-lazy-prop@^2.0.0:
  version "2.0.0"
  resolved "https://registry.yarnpkg.com/define-lazy-prop/-/define-lazy-prop-2.0.0.tgz#3f7ae421129bcaaac9bc74905c98a0009ec9ee7f"
  integrity sha512-Ds09qNh8yw3khSjiJjiUInaGX9xlqZDY7JVryGxdxV7NPeuqQfplOpQ66yJFZut3jLa5zOwkXw1g9EI2uKh4Og==

define-properties@^1.1.3, define-properties@^1.1.4:
  version "1.1.4"
  resolved "https://registry.yarnpkg.com/define-properties/-/define-properties-1.1.4.tgz#0b14d7bd7fbeb2f3572c3a7eda80ea5d57fb05b1"
  integrity sha512-uckOqKcfaVvtBdsVkdPv3XjveQJsNQqmhXgRi8uhvWWuPYZCNlzT8qAyblUgNoXdHdjMTzAqeGjAoli8f+bzPA==
  dependencies:
    has-property-descriptors "^1.0.0"
    object-keys "^1.1.1"

delayed-stream@~1.0.0:
  version "1.0.0"
  resolved "https://registry.yarnpkg.com/delayed-stream/-/delayed-stream-1.0.0.tgz#df3ae199acadfb7d440aaae0b29e2272b24ec619"
  integrity sha512-ZySD7Nf91aLB0RxL4KGrKHBXl7Eds1DAmEdcoVawXnLD7SDhpNgtuII2aAkg7a7QS41jxPSZ17p4VdGnMHk3MQ==

depd@2.0.0:
  version "2.0.0"
  resolved "https://registry.yarnpkg.com/depd/-/depd-2.0.0.tgz#b696163cc757560d09cf22cc8fad1571b79e76df"
  integrity sha512-g7nH6P6dyDioJogAAGprGpCtVImJhpPk/roCzdb3fIh61/s/nPsfR6onyMwkCAR/OlC3yBC0lESvUoQEAssIrw==

destroy@1.2.0:
  version "1.2.0"
  resolved "https://registry.yarnpkg.com/destroy/-/destroy-1.2.0.tgz#4803735509ad8be552934c67df614f94e66fa015"
  integrity sha512-2sJGJTaXIIaR1w4iJSNoN0hnMY7Gpc/n8D4qSCJw8QqFWXf7cuAgnEHxBpweaVcPevC2l3KpjYCx3NypQQgaJg==

detect-newline@^3.0.0:
  version "3.1.0"
  resolved "https://registry.yarnpkg.com/detect-newline/-/detect-newline-3.1.0.tgz#576f5dfc63ae1a192ff192d8ad3af6308991b651"
  integrity sha512-TLz+x/vEXm/Y7P7wn1EJFNLxYpUD4TgMosxY6fAVJUnJMbupHBOncxyWUG9OpTaH9EBD7uFI5LfEgmMOc54DsA==

dezalgo@^1.0.4:
  version "1.0.4"
  resolved "https://registry.yarnpkg.com/dezalgo/-/dezalgo-1.0.4.tgz#751235260469084c132157dfa857f386d4c33d81"
  integrity sha512-rXSP0bf+5n0Qonsb+SVVfNfIsimO4HEtmnIpPHY8Q1UCzKlQrDMfdobr8nJOOsRgWCyMRqeSBQzmWUMq7zvVig==
  dependencies:
    asap "^2.0.0"
    wrappy "1"

didyoumean@^1.2.2:
  version "1.2.2"
  resolved "https://registry.yarnpkg.com/didyoumean/-/didyoumean-1.2.2.tgz#989346ffe9e839b4555ecf5666edea0d3e8ad037"
  integrity sha512-gxtyfqMg7GKyhQmb056K7M3xszy/myH8w+B4RT+QXBQsvAOdc3XymqDDPHx1BgPgsdAA5SIifona89YtRATDzw==

diff-sequences@^29.3.1:
  version "29.3.1"
  resolved "https://registry.yarnpkg.com/diff-sequences/-/diff-sequences-29.3.1.tgz#104b5b95fe725932421a9c6e5b4bef84c3f2249e"
  integrity sha512-hlM3QR272NXCi4pq+N4Kok4kOp6EsgOM3ZSpJI7Da3UAs+Ttsi8MRmB6trM/lhyzUxGfOgnpkHtgqm5Q/CTcfQ==

diff-sequences@^29.4.3:
  version "29.4.3"
  resolved "https://registry.yarnpkg.com/diff-sequences/-/diff-sequences-29.4.3.tgz#9314bc1fabe09267ffeca9cbafc457d8499a13f2"
  integrity sha512-ofrBgwpPhCD85kMKtE9RYFFq6OC1A89oW2vvgWZNCwxrUpRUILopY7lsYyMDSjc8g6U6aiO0Qubg6r4Wgt5ZnA==

diff@^4.0.1:
  version "4.0.2"
  resolved "https://registry.yarnpkg.com/diff/-/diff-4.0.2.tgz#60f3aecb89d5fae520c11aa19efc2bb982aade7d"
  integrity sha512-58lmxKSA4BNyLz+HHMUzlOEpg09FV+ev6ZMe3vJihgdxzgcwZ8VoEEPmALCZG9LmqfVoNMMKpttIYTVG6uDY7A==

dir-glob@^3.0.1:
  version "3.0.1"
  resolved "https://registry.yarnpkg.com/dir-glob/-/dir-glob-3.0.1.tgz#56dbf73d992a4a93ba1584f4534063fd2e41717f"
  integrity sha512-WkrWp9GR4KXfKGYzOLmTuGVi1UWFfws377n9cc55/tb6DuqyF6pcQ5AbiHEshaDpY9v6oaSr2XCDidGmMwdzIA==
  dependencies:
    path-type "^4.0.0"

dlv@^1.1.3:
  version "1.1.3"
  resolved "https://registry.yarnpkg.com/dlv/-/dlv-1.1.3.tgz#5c198a8a11453596e751494d49874bc7732f2e79"
  integrity sha512-+HlytyjlPKnIG8XuRG8WvmBP8xs8P71y+SKKS6ZXWoEgLuePxtDoUEiH7WkdePWrQ5JBpE6aoVqfZfJUQkjXwA==

doctrine@^2.1.0:
  version "2.1.0"
  resolved "https://registry.yarnpkg.com/doctrine/-/doctrine-2.1.0.tgz#5cd01fc101621b42c4cd7f5d1a66243716d3f39d"
  integrity sha512-35mSku4ZXK0vfCuHEDAwt55dg2jNajHZ1odvF+8SSr82EsZY4QmXfuWso8oEd8zRhVObSN18aM0CjSdoBX7zIw==
  dependencies:
    esutils "^2.0.2"

doctrine@^3.0.0:
  version "3.0.0"
  resolved "https://registry.yarnpkg.com/doctrine/-/doctrine-3.0.0.tgz#addebead72a6574db783639dc87a121773973961"
  integrity sha512-yS+Q5i3hBf7GBkd4KG8a7eBNNWNGLTaEwwYWUijIYM7zrlYDM0BFXHjjPWlWZ1Rg7UaddZeIDmi9jF3HmqiQ2w==
  dependencies:
    esutils "^2.0.2"

dom-accessibility-api@^0.5.6, dom-accessibility-api@^0.5.9:
  version "0.5.14"
  resolved "https://registry.yarnpkg.com/dom-accessibility-api/-/dom-accessibility-api-0.5.14.tgz#56082f71b1dc7aac69d83c4285eef39c15d93f56"
  integrity sha512-NMt+m9zFMPZe0JcY9gN224Qvk6qLIdqex29clBvc/y75ZBX9YA9wNK3frsYvu2DI1xcCIwxwnX+TlsJ2DSOADg==

domexception@^4.0.0:
  version "4.0.0"
  resolved "https://registry.yarnpkg.com/domexception/-/domexception-4.0.0.tgz#4ad1be56ccadc86fc76d033353999a8037d03673"
  integrity sha512-A2is4PLG+eeSfoTMA95/s4pvAoSo2mKtiM5jlHkAVewmiO8ISFTFKZjH7UAM1Atli/OT/7JHOrJRJiMKUZKYBw==
  dependencies:
    webidl-conversions "^7.0.0"

dotenv-expand@10.0.0:
  version "10.0.0"
  resolved "https://registry.yarnpkg.com/dotenv-expand/-/dotenv-expand-10.0.0.tgz#12605d00fb0af6d0a592e6558585784032e4ef37"
  integrity sha512-GopVGCpVS1UKH75VKHGuQFqS1Gusej0z4FyQkPdwjil2gNIv+LNsqBlboOzpJFZKVT95GkCyWJbBSdFEFUWI2A==

dotenv@16.1.4:
  version "16.1.4"
  resolved "https://registry.yarnpkg.com/dotenv/-/dotenv-16.1.4.tgz#67ac1a10cd9c25f5ba604e4e08bc77c0ebe0ca8c"
  integrity sha512-m55RtE8AsPeJBpOIFKihEmqUcoVncQIwo7x9U8ZwLEZw9ZpXboz2c+rvog+jUaJvVrZ5kBOeYQBX5+8Aa/OZQw==

eastasianwidth@^0.2.0:
  version "0.2.0"
  resolved "https://registry.yarnpkg.com/eastasianwidth/-/eastasianwidth-0.2.0.tgz#696ce2ec0aa0e6ea93a397ffcf24aa7840c827cb"
  integrity sha512-I88TYZWc9XiYHRQ4/3c5rjjfgkjhLyW2luGIheGERbNQ6OY7yTybanSpDXZa8y7VUP9YmDcYa+eyq4ca7iLqWA==

ee-first@1.1.1:
  version "1.1.1"
  resolved "https://registry.yarnpkg.com/ee-first/-/ee-first-1.1.1.tgz#590c61156b0ae2f4f0255732a158b266bc56b21d"
  integrity sha512-WMwm9LhRUo+WUaRN+vRuETqG89IgZphVSNkdFgeb6sS/E4OrDIN7t48CAewSHXc6C8lefD8KKfr5vY61brQlow==

electron-to-chromium@^1.4.251:
  version "1.4.284"
  resolved "https://registry.yarnpkg.com/electron-to-chromium/-/electron-to-chromium-1.4.284.tgz#61046d1e4cab3a25238f6bf7413795270f125592"
  integrity sha512-M8WEXFuKXMYMVr45fo8mq0wUrrJHheiKZf6BArTKk9ZBYCKJEOU5H8cdWgDT+qCVZf7Na4lVUaZsA+h6uA9+PA==

electron-to-chromium@^1.4.477:
  version "1.4.480"
  resolved "https://registry.yarnpkg.com/electron-to-chromium/-/electron-to-chromium-1.4.480.tgz#40e32849ca50bc23ce29c1516c5adb3fddac919d"
  integrity sha512-IXTgg+bITkQv/FLP9FjX6f9KFCs5hQWeh5uNSKxB9mqYj/JXhHDbu+ekS43LVvbkL3eW6/oZy4+r9Om6lan1Uw==

emittery@^0.13.1:
  version "0.13.1"
  resolved "https://registry.yarnpkg.com/emittery/-/emittery-0.13.1.tgz#c04b8c3457490e0847ae51fced3af52d338e3dad"
  integrity sha512-DeWwawk6r5yR9jFgnDKYt4sLS0LmHJJi3ZOnb5/JdbYwj3nW+FxQnHIjhBKz8YLC7oRNPVM9NQ47I3CVx34eqQ==

emoji-regex@^8.0.0:
  version "8.0.0"
  resolved "https://registry.yarnpkg.com/emoji-regex/-/emoji-regex-8.0.0.tgz#e818fd69ce5ccfcb404594f842963bf53164cc37"
  integrity sha512-MSjYzcWNOA0ewAHpz0MxpYFvwg6yjy1NG3xteoqz644VCo/RPgnr1/GGt+ic3iJTzQ8Eu3TdM14SawnVUmGE6A==

emoji-regex@^9.2.2:
  version "9.2.2"
  resolved "https://registry.yarnpkg.com/emoji-regex/-/emoji-regex-9.2.2.tgz#840c8803b0d8047f4ff0cf963176b32d4ef3ed72"
  integrity sha512-L18DaJsXSUk2+42pv8mLs5jJT2hqFkFE4j21wOmgbUqsZ2hL72NsUU785g9RXgo3s0ZNgVl42TiHp3ZtOv/Vyg==

encodeurl@~1.0.2:
  version "1.0.2"
  resolved "https://registry.yarnpkg.com/encodeurl/-/encodeurl-1.0.2.tgz#ad3ff4c86ec2d029322f5a02c3a9a606c95b3f59"
  integrity sha512-TPJXq8JqFaVYm2CWmPvnP2Iyo4ZSM7/QKcSmuMLDObfpH5fi7RUGmd/rTDf+rut/saiDiQEeVTNgAmJEdAOx0w==

end-of-stream@^1.1.0:
  version "1.4.4"
  resolved "https://registry.yarnpkg.com/end-of-stream/-/end-of-stream-1.4.4.tgz#5ae64a5f45057baf3626ec14da0ca5e4b2431eb0"
  integrity sha512-+uw1inIHVPQoaVuHzRyXd21icM+cnt4CzD5rW+NC1wjOUSTOs+Te7FOv7AhN7vS9x/oIyhLP5PR1H+phQAHu5Q==
  dependencies:
    once "^1.4.0"

enhanced-resolve@^5.0.0, enhanced-resolve@^5.10.0, enhanced-resolve@^5.7.0:
  version "5.12.0"
  resolved "https://registry.yarnpkg.com/enhanced-resolve/-/enhanced-resolve-5.12.0.tgz#300e1c90228f5b570c4d35babf263f6da7155634"
  integrity sha512-QHTXI/sZQmko1cbDoNAa3mJ5qhWUUNAq3vR0/YiD379fWQrcfuoX1+HW2S0MTt7XmoPLapdaDKUtelUSPic7hQ==
  dependencies:
    graceful-fs "^4.2.4"
    tapable "^2.2.0"

enhanced-resolve@^5.15.0:
  version "5.15.0"
  resolved "https://registry.yarnpkg.com/enhanced-resolve/-/enhanced-resolve-5.15.0.tgz#1af946c7d93603eb88e9896cee4904dc012e9c35"
  integrity sha512-LXYT42KJ7lpIKECr2mAXIaMldcNCh/7E0KBKOu4KSfkHmP+mZmSs+8V5gBAqisWBy0OO4W5Oyys0GO1Y8KtdKg==
  dependencies:
    graceful-fs "^4.2.4"
    tapable "^2.2.0"

entities@^4.4.0:
  version "4.4.0"
  resolved "https://registry.yarnpkg.com/entities/-/entities-4.4.0.tgz#97bdaba170339446495e653cfd2db78962900174"
  integrity sha512-oYp7156SP8LkeGD0GF85ad1X9Ai79WtRsZ2gxJqtBuzH+98YUV6jkHEKlZkMbcrjJjIVJNIDP/3WL9wQkoPbWA==

error-ex@^1.3.1:
  version "1.3.2"
  resolved "https://registry.yarnpkg.com/error-ex/-/error-ex-1.3.2.tgz#b4ac40648107fdcdcfae242f428bea8a14d4f1bf"
  integrity sha512-7dFHNmqeFSEt2ZBsCriorKnn3Z2pj+fd9kmI6QoWw4//DL+icEBfc0U7qJCisqrTsKTjw4fNFy2pW9OqStD84g==
  dependencies:
    is-arrayish "^0.2.1"

es-abstract@^1.19.0, es-abstract@^1.20.4:
  version "1.20.5"
  resolved "https://registry.yarnpkg.com/es-abstract/-/es-abstract-1.20.5.tgz#e6dc99177be37cacda5988e692c3fa8b218e95d2"
  integrity sha512-7h8MM2EQhsCA7pU/Nv78qOXFpD8Rhqd12gYiSJVkrH9+e8VuA8JlPJK/hQjjlLv6pJvx/z1iRFKzYb0XT/RuAQ==
  dependencies:
    call-bind "^1.0.2"
    es-to-primitive "^1.2.1"
    function-bind "^1.1.1"
    function.prototype.name "^1.1.5"
    get-intrinsic "^1.1.3"
    get-symbol-description "^1.0.0"
    gopd "^1.0.1"
    has "^1.0.3"
    has-property-descriptors "^1.0.0"
    has-symbols "^1.0.3"
    internal-slot "^1.0.3"
    is-callable "^1.2.7"
    is-negative-zero "^2.0.2"
    is-regex "^1.1.4"
    is-shared-array-buffer "^1.0.2"
    is-string "^1.0.7"
    is-weakref "^1.0.2"
    object-inspect "^1.12.2"
    object-keys "^1.1.1"
    object.assign "^4.1.4"
    regexp.prototype.flags "^1.4.3"
    safe-regex-test "^1.0.0"
    string.prototype.trimend "^1.0.6"
    string.prototype.trimstart "^1.0.6"
    unbox-primitive "^1.0.2"

es-get-iterator@^1.1.2:
  version "1.1.2"
  resolved "https://registry.yarnpkg.com/es-get-iterator/-/es-get-iterator-1.1.2.tgz#9234c54aba713486d7ebde0220864af5e2b283f7"
  integrity sha512-+DTO8GYwbMCwbywjimwZMHp8AuYXOS2JZFWoi2AlPOS3ebnII9w/NLpNZtA7A0YLaVDw+O7KFCeoIV7OPvM7hQ==
  dependencies:
    call-bind "^1.0.2"
    get-intrinsic "^1.1.0"
    has-symbols "^1.0.1"
    is-arguments "^1.1.0"
    is-map "^2.0.2"
    is-set "^2.0.2"
    is-string "^1.0.5"
    isarray "^2.0.5"

es-module-lexer@^1.2.1:
  version "1.3.0"
  resolved "https://registry.yarnpkg.com/es-module-lexer/-/es-module-lexer-1.3.0.tgz#6be9c9e0b4543a60cd166ff6f8b4e9dae0b0c16f"
  integrity sha512-vZK7T0N2CBmBOixhmjdqx2gWVbFZ4DXZ/NyRMZVlJXPa7CyFS+/a4QQsDGDQy9ZfEzxFuNEsMLeQJnKP2p5/JA==

es-shim-unscopables@^1.0.0:
  version "1.0.0"
  resolved "https://registry.yarnpkg.com/es-shim-unscopables/-/es-shim-unscopables-1.0.0.tgz#702e632193201e3edf8713635d083d378e510241"
  integrity sha512-Jm6GPcCdC30eMLbZ2x8z2WuRwAws3zTBBKuusffYVUrNj/GVSUAZ+xKMaUpfNDR5IbyNA5LJbaecoUVbmUcB1w==
  dependencies:
    has "^1.0.3"

es-to-primitive@^1.2.1:
  version "1.2.1"
  resolved "https://registry.yarnpkg.com/es-to-primitive/-/es-to-primitive-1.2.1.tgz#e55cd4c9cdc188bcefb03b366c736323fc5c898a"
  integrity sha512-QCOllgZJtaUo9miYBcLChTUaHNjJF3PYs1VidD7AwiEj1kYxKeQTctLAezAOH5ZKRH0g2IgPn6KwB4IT8iRpvA==
  dependencies:
    is-callable "^1.1.4"
    is-date-object "^1.0.1"
    is-symbol "^1.0.2"

escalade@^3.1.1:
  version "3.1.1"
  resolved "https://registry.yarnpkg.com/escalade/-/escalade-3.1.1.tgz#d8cfdc7000965c5a0174b4a82eaa5c0552742e40"
  integrity sha512-k0er2gUkLf8O0zKJiAhmkTnJlTvINGv7ygDNPbeIsX/TJjGJZHuh9B2UxbsaEkmlEo9MfhrSzmhIlhRlI2GXnw==

escape-html@~1.0.3:
  version "1.0.3"
  resolved "https://registry.yarnpkg.com/escape-html/-/escape-html-1.0.3.tgz#0258eae4d3d0c0974de1c169188ef0051d1d1988"
  integrity sha512-NiSupZ4OeuGwr68lGIeym/ksIZMJodUGOSCZ/FSnTxcrekbvqrgdUxlJOMpijaKZVjAJrWrGs/6Jy8OMuyj9ow==

escape-string-regexp@^1.0.5:
  version "1.0.5"
  resolved "https://registry.yarnpkg.com/escape-string-regexp/-/escape-string-regexp-1.0.5.tgz#1b61c0562190a8dff6ae3bb2cf0200ca130b86d4"
  integrity sha512-vbRorB5FUQWvla16U8R/qgaFIya2qGzwDrNmCZuYKrbdSUMG6I1ZCGQRefkRVhuOkIGVne7BQ35DSfo1qvJqFg==

escape-string-regexp@^2.0.0:
  version "2.0.0"
  resolved "https://registry.yarnpkg.com/escape-string-regexp/-/escape-string-regexp-2.0.0.tgz#a30304e99daa32e23b2fd20f51babd07cffca344"
  integrity sha512-UpzcLCXolUWcNu5HtVMHYdXJjArjsF9C0aNnquZYY4uW/Vu0miy5YoWvbV345HauVvcAUnpRuhMMcqTcGOY2+w==

escape-string-regexp@^4.0.0:
  version "4.0.0"
  resolved "https://registry.yarnpkg.com/escape-string-regexp/-/escape-string-regexp-4.0.0.tgz#14ba83a5d373e3d311e5afca29cf5bfad965bf34"
  integrity sha512-TtpcNJ3XAzx3Gq8sWRzJaVajRs0uVxA2YAkdb1jm2YkPz4G6egUFAyA3n5vtEIZefPk5Wa4UXbKuS5fKkJWdgA==

escodegen@^2.0.0:
  version "2.0.0"
  resolved "https://registry.yarnpkg.com/escodegen/-/escodegen-2.0.0.tgz#5e32b12833e8aa8fa35e1bf0befa89380484c7dd"
  integrity sha512-mmHKys/C8BFUGI+MAWNcSYoORYLMdPzjrknd2Vc+bUsjN5bXcr8EhrNB+UTqfL1y3I9c4fw2ihgtMPQLBRiQxw==
  dependencies:
    esprima "^4.0.1"
    estraverse "^5.2.0"
    esutils "^2.0.2"
    optionator "^0.8.1"
  optionalDependencies:
    source-map "~0.6.1"

eslint-config-next@^13.4.12:
  version "13.4.12"
  resolved "https://registry.yarnpkg.com/eslint-config-next/-/eslint-config-next-13.4.12.tgz#a42ed2f590855a0481c8bbec49e26db56ad3793f"
  integrity sha512-ZF0r5vxKaVazyZH/37Au/XItiG7qUOBw+HaH3PeyXltIMwXorsn6bdrl0Nn9N5v5v9spc+6GM2ryjugbjF6X2g==
  dependencies:
    "@next/eslint-plugin-next" "13.4.12"
    "@rushstack/eslint-patch" "^1.1.3"
    "@typescript-eslint/parser" "^5.42.0"
    eslint-import-resolver-node "^0.3.6"
    eslint-import-resolver-typescript "^3.5.2"
    eslint-plugin-import "^2.26.0"
    eslint-plugin-jsx-a11y "^6.5.1"
    eslint-plugin-react "^7.31.7"
    eslint-plugin-react-hooks "5.0.0-canary-7118f5dd7-20230705"

eslint-config-prettier@^8.9.0:
  version "8.9.0"
  resolved "https://registry.yarnpkg.com/eslint-config-prettier/-/eslint-config-prettier-8.9.0.tgz#094b6254b2804b0544f7cee535f802b6d29ee10b"
  integrity sha512-+sbni7NfVXnOpnRadUA8S28AUlsZt9GjgFvABIRL9Hkn8KqNzOp+7Lw4QWtrwn20KzU3wqu1QoOj2m+7rKRqkA==

eslint-import-resolver-node@^0.3.6:
  version "0.3.6"
  resolved "https://registry.yarnpkg.com/eslint-import-resolver-node/-/eslint-import-resolver-node-0.3.6.tgz#4048b958395da89668252001dbd9eca6b83bacbd"
  integrity sha512-0En0w03NRVMn9Uiyn8YRPDKvWjxCWkslUEhGNTdGx15RvPJYQ+lbOlqrlNI2vEAs4pDYK4f/HN2TbDmk5TP0iw==
  dependencies:
    debug "^3.2.7"
    resolve "^1.20.0"

eslint-import-resolver-typescript@^3.5.2:
  version "3.5.2"
  resolved "https://registry.yarnpkg.com/eslint-import-resolver-typescript/-/eslint-import-resolver-typescript-3.5.2.tgz#9431acded7d898fd94591a08ea9eec3514c7de91"
  integrity sha512-zX4ebnnyXiykjhcBvKIf5TNvt8K7yX6bllTRZ14MiurKPjDpCAZujlszTdB8pcNXhZcOf+god4s9SjQa5GnytQ==
  dependencies:
    debug "^4.3.4"
    enhanced-resolve "^5.10.0"
    get-tsconfig "^4.2.0"
    globby "^13.1.2"
    is-core-module "^2.10.0"
    is-glob "^4.0.3"
    synckit "^0.8.4"

eslint-module-utils@^2.7.3:
  version "2.7.4"
  resolved "https://registry.yarnpkg.com/eslint-module-utils/-/eslint-module-utils-2.7.4.tgz#4f3e41116aaf13a20792261e61d3a2e7e0583974"
  integrity sha512-j4GT+rqzCoRKHwURX7pddtIPGySnX9Si/cgMI5ztrcqOPtk5dDEeZ34CQVPphnqkJytlc97Vuk05Um2mJ3gEQA==
  dependencies:
    debug "^3.2.7"

eslint-plugin-import@^2.26.0:
  version "2.26.0"
  resolved "https://registry.yarnpkg.com/eslint-plugin-import/-/eslint-plugin-import-2.26.0.tgz#f812dc47be4f2b72b478a021605a59fc6fe8b88b"
  integrity sha512-hYfi3FXaM8WPLf4S1cikh/r4IxnO6zrhZbEGz2b660EJRbuxgpDS5gkCuYgGWg2xxh2rBuIr4Pvhve/7c31koA==
  dependencies:
    array-includes "^3.1.4"
    array.prototype.flat "^1.2.5"
    debug "^2.6.9"
    doctrine "^2.1.0"
    eslint-import-resolver-node "^0.3.6"
    eslint-module-utils "^2.7.3"
    has "^1.0.3"
    is-core-module "^2.8.1"
    is-glob "^4.0.3"
    minimatch "^3.1.2"
    object.values "^1.1.5"
    resolve "^1.22.0"
    tsconfig-paths "^3.14.1"

eslint-plugin-jsx-a11y@^6.5.1:
  version "6.6.1"
  resolved "https://registry.yarnpkg.com/eslint-plugin-jsx-a11y/-/eslint-plugin-jsx-a11y-6.6.1.tgz#93736fc91b83fdc38cc8d115deedfc3091aef1ff"
  integrity sha512-sXgFVNHiWffBq23uiS/JaP6eVR622DqwB4yTzKvGZGcPq6/yZ3WmOZfuBks/vHWo9GaFOqC2ZK4i6+C35knx7Q==
  dependencies:
    "@babel/runtime" "^7.18.9"
    aria-query "^4.2.2"
    array-includes "^3.1.5"
    ast-types-flow "^0.0.7"
    axe-core "^4.4.3"
    axobject-query "^2.2.0"
    damerau-levenshtein "^1.0.8"
    emoji-regex "^9.2.2"
    has "^1.0.3"
    jsx-ast-utils "^3.3.2"
    language-tags "^1.0.5"
    minimatch "^3.1.2"
    semver "^6.3.0"

eslint-plugin-prettier@^5.0.0:
  version "5.0.0"
  resolved "https://registry.yarnpkg.com/eslint-plugin-prettier/-/eslint-plugin-prettier-5.0.0.tgz#6887780ed95f7708340ec79acfdf60c35b9be57a"
  integrity sha512-AgaZCVuYDXHUGxj/ZGu1u8H8CYgDY3iG6w5kUFw4AzMVXzB7VvbKgYR4nATIN+OvUrghMbiDLeimVjVY5ilq3w==
  dependencies:
    prettier-linter-helpers "^1.0.0"
    synckit "^0.8.5"

eslint-plugin-react-hooks@5.0.0-canary-7118f5dd7-20230705:
  version "5.0.0-canary-7118f5dd7-20230705"
  resolved "https://registry.yarnpkg.com/eslint-plugin-react-hooks/-/eslint-plugin-react-hooks-5.0.0-canary-7118f5dd7-20230705.tgz#4d55c50e186f1a2b0636433d2b0b2f592ddbccfd"
  integrity sha512-AZYbMo/NW9chdL7vk6HQzQhT+PvTAEVqWk9ziruUoW2kAOcN5qNyelv70e0F1VNQAbvutOC9oc+xfWycI9FxDw==

eslint-plugin-react@7.33.1:
  version "7.33.1"
  resolved "https://registry.yarnpkg.com/eslint-plugin-react/-/eslint-plugin-react-7.33.1.tgz#bc27cccf860ae45413a4a4150bf0977345c1ceab"
  integrity sha512-L093k0WAMvr6VhNwReB8VgOq5s2LesZmrpPdKz/kZElQDzqS7G7+DnKoqT+w4JwuiGeAhAvHO0fvy0Eyk4ejDA==
  dependencies:
    array-includes "^3.1.6"
    array.prototype.flatmap "^1.3.1"
    array.prototype.tosorted "^1.1.1"
    doctrine "^2.1.0"
    estraverse "^5.3.0"
    jsx-ast-utils "^2.4.1 || ^3.0.0"
    minimatch "^3.1.2"
    object.entries "^1.1.6"
    object.fromentries "^2.0.6"
    object.hasown "^1.1.2"
    object.values "^1.1.6"
    prop-types "^15.8.1"
    resolve "^2.0.0-next.4"
    semver "^6.3.1"
    string.prototype.matchall "^4.0.8"

eslint-plugin-react@^7.31.7:
  version "7.31.11"
  resolved "https://registry.yarnpkg.com/eslint-plugin-react/-/eslint-plugin-react-7.31.11.tgz#011521d2b16dcf95795df688a4770b4eaab364c8"
  integrity sha512-TTvq5JsT5v56wPa9OYHzsrOlHzKZKjV+aLgS+55NJP/cuzdiQPC7PfYoUjMoxlffKtvijpk7vA/jmuqRb9nohw==
  dependencies:
    array-includes "^3.1.6"
    array.prototype.flatmap "^1.3.1"
    array.prototype.tosorted "^1.1.1"
    doctrine "^2.1.0"
    estraverse "^5.3.0"
    jsx-ast-utils "^2.4.1 || ^3.0.0"
    minimatch "^3.1.2"
    object.entries "^1.1.6"
    object.fromentries "^2.0.6"
    object.hasown "^1.1.2"
    object.values "^1.1.6"
    prop-types "^15.8.1"
    resolve "^2.0.0-next.3"
    semver "^6.3.0"
    string.prototype.matchall "^4.0.8"

eslint-scope@5.1.1:
  version "5.1.1"
  resolved "https://registry.yarnpkg.com/eslint-scope/-/eslint-scope-5.1.1.tgz#e786e59a66cb92b3f6c1fb0d508aab174848f48c"
  integrity sha512-2NxwbF/hZ0KpepYN0cNbo+FN6XoK7GaHlQhgx/hIZl6Va0bF45RQOOwhLIy8lQDbuCiadSLCBnH2CFYquit5bw==
  dependencies:
    esrecurse "^4.3.0"
    estraverse "^4.1.1"

eslint-scope@^7.2.2:
  version "7.2.2"
  resolved "https://registry.yarnpkg.com/eslint-scope/-/eslint-scope-7.2.2.tgz#deb4f92563390f32006894af62a22dba1c46423f"
  integrity sha512-dOt21O7lTMhDM+X9mB4GX+DZrZtCUJPL/wlcTqxyrx5IvO0IYtILdtrQGQp+8n5S0gwSVmOf9NQrjMOgfQZlIg==
  dependencies:
    esrecurse "^4.3.0"
    estraverse "^5.2.0"

eslint-visitor-keys@^3.3.0:
  version "3.3.0"
  resolved "https://registry.yarnpkg.com/eslint-visitor-keys/-/eslint-visitor-keys-3.3.0.tgz#f6480fa6b1f30efe2d1968aa8ac745b862469826"
  integrity sha512-mQ+suqKJVyeuwGYHAdjMFqjCyfl8+Ldnxuyp3ldiMBFKkvytrXUZWaiPCEav8qDHKty44bD+qV1IP4T+w+xXRA==

eslint-visitor-keys@^3.4.1, eslint-visitor-keys@^3.4.2:
  version "3.4.2"
  resolved "https://registry.yarnpkg.com/eslint-visitor-keys/-/eslint-visitor-keys-3.4.2.tgz#8c2095440eca8c933bedcadf16fefa44dbe9ba5f"
  integrity sha512-8drBzUEyZ2llkpCA67iYrgEssKDUu68V8ChqqOfFupIaG/LCVPUT+CoGJpT77zJprs4T/W7p07LP7zAIMuweVw==

eslint@8.46.0, eslint@^8.46.0:
  version "8.46.0"
  resolved "https://registry.yarnpkg.com/eslint/-/eslint-8.46.0.tgz#a06a0ff6974e53e643acc42d1dcf2e7f797b3552"
  integrity sha512-cIO74PvbW0qU8e0mIvk5IV3ToWdCq5FYG6gWPHHkx6gNdjlbAYvtfHmlCMXxjcoVaIdwy/IAt3+mDkZkfvb2Dg==
  dependencies:
    "@eslint-community/eslint-utils" "^4.2.0"
    "@eslint-community/regexpp" "^4.6.1"
    "@eslint/eslintrc" "^2.1.1"
    "@eslint/js" "^8.46.0"
    "@humanwhocodes/config-array" "^0.11.10"
    "@humanwhocodes/module-importer" "^1.0.1"
    "@nodelib/fs.walk" "^1.2.8"
    ajv "^6.12.4"
    chalk "^4.0.0"
    cross-spawn "^7.0.2"
    debug "^4.3.2"
    doctrine "^3.0.0"
    escape-string-regexp "^4.0.0"
    eslint-scope "^7.2.2"
    eslint-visitor-keys "^3.4.2"
    espree "^9.6.1"
    esquery "^1.4.2"
    esutils "^2.0.2"
    fast-deep-equal "^3.1.3"
    file-entry-cache "^6.0.1"
    find-up "^5.0.0"
    glob-parent "^6.0.2"
    globals "^13.19.0"
    graphemer "^1.4.0"
    ignore "^5.2.0"
    imurmurhash "^0.1.4"
    is-glob "^4.0.0"
    is-path-inside "^3.0.3"
    js-yaml "^4.1.0"
    json-stable-stringify-without-jsonify "^1.0.1"
    levn "^0.4.1"
    lodash.merge "^4.6.2"
    minimatch "^3.1.2"
    natural-compare "^1.4.0"
    optionator "^0.9.3"
    strip-ansi "^6.0.1"
    text-table "^0.2.0"

espree@^9.6.0, espree@^9.6.1:
  version "9.6.1"
  resolved "https://registry.yarnpkg.com/espree/-/espree-9.6.1.tgz#a2a17b8e434690a5432f2f8018ce71d331a48c6f"
  integrity sha512-oruZaFkjorTpF32kDSI5/75ViwGeZginGGy2NoOSg3Q9bnwlnmDm4HLnkl0RE3n+njDXR037aY1+x58Z/zFdwQ==
  dependencies:
    acorn "^8.9.0"
    acorn-jsx "^5.3.2"
    eslint-visitor-keys "^3.4.1"

esprima@^4.0.0, esprima@^4.0.1:
  version "4.0.1"
  resolved "https://registry.yarnpkg.com/esprima/-/esprima-4.0.1.tgz#13b04cdb3e6c5d19df91ab6987a8695619b0aa71"
  integrity sha512-eGuFFw7Upda+g4p+QHvnW0RyTX/SVeJBDM/gCtMARO0cLuT2HcEKnTPvhjV6aGeqrCB/sbNop0Kszm0jsaWU4A==

esquery@^1.4.2:
  version "1.5.0"
  resolved "https://registry.yarnpkg.com/esquery/-/esquery-1.5.0.tgz#6ce17738de8577694edd7361c57182ac8cb0db0b"
  integrity sha512-YQLXUplAwJgCydQ78IMJywZCceoqk1oH01OERdSAJc/7U2AylwjhSCLDEtqwg811idIS/9fIU5GjG73IgjKMVg==
  dependencies:
    estraverse "^5.1.0"

esrecurse@^4.3.0:
  version "4.3.0"
  resolved "https://registry.yarnpkg.com/esrecurse/-/esrecurse-4.3.0.tgz#7ad7964d679abb28bee72cec63758b1c5d2c9921"
  integrity sha512-KmfKL3b6G+RXvP8N1vr3Tq1kL/oCFgn2NYXEtqP8/L3pKapUA4G8cFVaoF3SU323CD4XypR/ffioHmkti6/Tag==
  dependencies:
    estraverse "^5.2.0"

estraverse@^4.1.1:
  version "4.3.0"
  resolved "https://registry.yarnpkg.com/estraverse/-/estraverse-4.3.0.tgz#398ad3f3c5a24948be7725e83d11a7de28cdbd1d"
  integrity sha512-39nnKffWz8xN1BU/2c79n9nB9HDzo0niYUqx6xyqUnyoAnQyyWpOTdZEeiCch8BBu515t4wp9ZmgVfVhn9EBpw==

estraverse@^5.1.0, estraverse@^5.2.0, estraverse@^5.3.0:
  version "5.3.0"
  resolved "https://registry.yarnpkg.com/estraverse/-/estraverse-5.3.0.tgz#2eea5290702f26ab8fe5370370ff86c965d21123"
  integrity sha512-MMdARuVEQziNTeJD8DgMqmhwR11BRQ/cBP+pLtYdSTnf3MIO8fFeiINEbX36ZdNlfU/7A9f3gUw49B3oQsvwBA==

esutils@^2.0.2:
  version "2.0.3"
  resolved "https://registry.yarnpkg.com/esutils/-/esutils-2.0.3.tgz#74d2eb4de0b8da1293711910d50775b9b710ef64"
  integrity sha512-kVscqXk4OCp68SZ0dkgEKVi6/8ij300KBWTJq32P/dYeWTSwK41WyTxalN1eRmA5Z9UU/LX9D7FWSmV9SAYx6g==

etag@~1.8.1:
  version "1.8.1"
  resolved "https://registry.yarnpkg.com/etag/-/etag-1.8.1.tgz#41ae2eeb65efa62268aebfea83ac7d79299b0887"
  integrity sha512-aIL5Fx7mawVa300al2BnEE4iNvo1qETxLrPI/o05L7z6go7fCw1J6EQmbK4FmJ2AS7kgVF/KEZWufBfdClMcPg==

events@^3.2.0:
  version "3.3.0"
  resolved "https://registry.yarnpkg.com/events/-/events-3.3.0.tgz#31a95ad0a924e2d2c419a813aeb2c4e878ea7400"
  integrity sha512-mQw+2fkQbALzQ7V0MY0IqdnXNOeTtP4r0lN9z7AAawCXgqea7bDii20AYrIBrFd/Hx0M2Ocz6S111CaFkUcb0Q==

execa@^4.0.2:
  version "4.1.0"
  resolved "https://registry.yarnpkg.com/execa/-/execa-4.1.0.tgz#4e5491ad1572f2f17a77d388c6c857135b22847a"
  integrity sha512-j5W0//W7f8UxAn8hXVnwG8tLwdiUy4FJLcSupCg6maBYZDpyBvTApK7KyuI4bKj8KOh1r2YH+6ucuYtJv1bTZA==
  dependencies:
    cross-spawn "^7.0.0"
    get-stream "^5.0.0"
    human-signals "^1.1.1"
    is-stream "^2.0.0"
    merge-stream "^2.0.0"
    npm-run-path "^4.0.0"
    onetime "^5.1.0"
    signal-exit "^3.0.2"
    strip-final-newline "^2.0.0"

execa@^5.0.0:
  version "5.1.1"
  resolved "https://registry.yarnpkg.com/execa/-/execa-5.1.1.tgz#f80ad9cbf4298f7bd1d4c9555c21e93741c411dd"
  integrity sha512-8uSpZZocAZRBAPIEINJj3Lo9HyGitllczc27Eh5YYojjMFMn8yHMDMaUHE2Jqfq05D/wucwI4JGURyXt1vchyg==
  dependencies:
    cross-spawn "^7.0.3"
    get-stream "^6.0.0"
    human-signals "^2.1.0"
    is-stream "^2.0.0"
    merge-stream "^2.0.0"
    npm-run-path "^4.0.1"
    onetime "^5.1.2"
    signal-exit "^3.0.3"
    strip-final-newline "^2.0.0"

exit@^0.1.2:
  version "0.1.2"
  resolved "https://registry.yarnpkg.com/exit/-/exit-0.1.2.tgz#0632638f8d877cc82107d30a0fff1a17cba1cd0c"
  integrity sha512-Zk/eNKV2zbjpKzrsQ+n1G6poVbErQxJ0LBOJXaKZ1EViLzH+hrLu9cdXI4zw9dBQJslwBEpbQ2P1oS7nDxs6jQ==

expect@^29.0.0:
  version "29.3.1"
  resolved "https://registry.yarnpkg.com/expect/-/expect-29.3.1.tgz#92877aad3f7deefc2e3f6430dd195b92295554a6"
  integrity sha512-gGb1yTgU30Q0O/tQq+z30KBWv24ApkMgFUpvKBkyLUBL68Wv8dHdJxTBZFl/iT8K/bqDHvUYRH6IIN3rToopPA==
  dependencies:
    "@jest/expect-utils" "^29.3.1"
    jest-get-type "^29.2.0"
    jest-matcher-utils "^29.3.1"
    jest-message-util "^29.3.1"
    jest-util "^29.3.1"

expect@^29.6.2:
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/expect/-/expect-29.6.2.tgz#7b08e83eba18ddc4a2cf62b5f2d1918f5cd84521"
  integrity sha512-iAErsLxJ8C+S02QbLAwgSGSezLQK+XXRDt8IuFXFpwCNw2ECmzZSmjKcCaFVp5VRMk+WAvz6h6jokzEzBFZEuA==
  dependencies:
    "@jest/expect-utils" "^29.6.2"
    "@types/node" "*"
    jest-get-type "^29.4.3"
    jest-matcher-utils "^29.6.2"
    jest-message-util "^29.6.2"
    jest-util "^29.6.2"

express@4.18.2:
  version "4.18.2"
  resolved "https://registry.yarnpkg.com/express/-/express-4.18.2.tgz#3fabe08296e930c796c19e3c516979386ba9fd59"
  integrity sha512-5/PsL6iGPdfQ/lKM1UuielYgv3BUoJfz1aUwU9vHZ+J7gyvwdQXFEBIEIaxeGf0GIcreATNyBExtalisDbuMqQ==
  dependencies:
    accepts "~1.3.8"
    array-flatten "1.1.1"
    body-parser "1.20.1"
    content-disposition "0.5.4"
    content-type "~1.0.4"
    cookie "0.5.0"
    cookie-signature "1.0.6"
    debug "2.6.9"
    depd "2.0.0"
    encodeurl "~1.0.2"
    escape-html "~1.0.3"
    etag "~1.8.1"
    finalhandler "1.2.0"
    fresh "0.5.2"
    http-errors "2.0.0"
    merge-descriptors "1.0.1"
    methods "~1.1.2"
    on-finished "2.4.1"
    parseurl "~1.3.3"
    path-to-regexp "0.1.7"
    proxy-addr "~2.0.7"
    qs "6.11.0"
    range-parser "~1.2.1"
    safe-buffer "5.2.1"
    send "0.18.0"
    serve-static "1.15.0"
    setprototypeof "1.2.0"
    statuses "2.0.1"
    type-is "~1.6.18"
    utils-merge "1.0.1"
    vary "~1.1.2"

external-editor@^3.0.3:
  version "3.1.0"
  resolved "https://registry.yarnpkg.com/external-editor/-/external-editor-3.1.0.tgz#cb03f740befae03ea4d283caed2741a83f335495"
  integrity sha512-hMQ4CX1p1izmuLYyZqLMO/qGNw10wSv9QDCPfzXfyFrOaCSSoRfqE1Kf1s5an66J5JZC62NewG+mK49jOCtQew==
  dependencies:
    chardet "^0.7.0"
    iconv-lite "^0.4.24"
    tmp "^0.0.33"

fast-deep-equal@^3.1.1, fast-deep-equal@^3.1.3:
  version "3.1.3"
  resolved "https://registry.yarnpkg.com/fast-deep-equal/-/fast-deep-equal-3.1.3.tgz#3a7d56b559d6cbc3eb512325244e619a65c6c525"
  integrity sha512-f3qQ9oQy9j2AhBe/H9VC91wLmKBCCU/gDOnKNAYG5hswO7BLKj09Hc5HYNz9cGI++xlpDCIgDaitVs03ATR84Q==

fast-diff@^1.1.2:
  version "1.2.0"
  resolved "https://registry.yarnpkg.com/fast-diff/-/fast-diff-1.2.0.tgz#73ee11982d86caaf7959828d519cfe927fac5f03"
  integrity sha512-xJuoT5+L99XlZ8twedaRf6Ax2TgQVxvgZOYoPKqZufmJib0tL2tegPBOZb1pVNgIhlqDlA0eO0c3wBvQcmzx4w==

fast-glob@^3.2.11, fast-glob@^3.2.12, fast-glob@^3.2.9:
  version "3.2.12"
  resolved "https://registry.yarnpkg.com/fast-glob/-/fast-glob-3.2.12.tgz#7f39ec99c2e6ab030337142da9e0c18f37afae80"
  integrity sha512-DVj4CQIYYow0BlaelwK1pHl5n5cRSJfM60UA0zK891sVInoPri2Ekj7+e1CT3/3qxXenpI+nBBmQAcJPJgaj4w==
  dependencies:
    "@nodelib/fs.stat" "^2.0.2"
    "@nodelib/fs.walk" "^1.2.3"
    glob-parent "^5.1.2"
    merge2 "^1.3.0"
    micromatch "^4.0.4"

fast-json-stable-stringify@2.x, fast-json-stable-stringify@^2.0.0, fast-json-stable-stringify@^2.1.0:
  version "2.1.0"
  resolved "https://registry.yarnpkg.com/fast-json-stable-stringify/-/fast-json-stable-stringify-2.1.0.tgz#874bf69c6f404c2b5d99c481341399fd55892633"
  integrity sha512-lhd/wF+Lk98HZoTCtlVraHtfh5XYijIjalXck7saUtuanSDyLMxnHhSXEDJqHxD7msR8D0uCmqlkwjCV8xvwHw==

fast-levenshtein@^2.0.6, fast-levenshtein@~2.0.6:
  version "2.0.6"
  resolved "https://registry.yarnpkg.com/fast-levenshtein/-/fast-levenshtein-2.0.6.tgz#3d8a5c66883a16a30ca8643e851f19baa7797917"
  integrity sha512-DCXu6Ifhqcks7TZKY3Hxp3y6qphY5SJZmrWMDrKcERSOXWQdMhU9Ig/PYrzyw/ul9jOIyh0N4M0tbC5hodg8dw==

fast-safe-stringify@2.1.1, fast-safe-stringify@^2.1.1:
  version "2.1.1"
  resolved "https://registry.yarnpkg.com/fast-safe-stringify/-/fast-safe-stringify-2.1.1.tgz#c406a83b6e70d9e35ce3b30a81141df30aeba884"
  integrity sha512-W+KJc2dmILlPplD/H4K9l9LcAHAfPtP6BY84uVLXQ6Evcz9Lcg33Y2z1IVblT6xdY54PXYVHEv+0Wpq8Io6zkA==

fastq@^1.6.0:
  version "1.14.0"
  resolved "https://registry.yarnpkg.com/fastq/-/fastq-1.14.0.tgz#107f69d7295b11e0fccc264e1fc6389f623731ce"
  integrity sha512-eR2D+V9/ExcbF9ls441yIuN6TI2ED1Y2ZcA5BmMtJsOkWOFRJQ0Jt0g1UwqXJJVAb+V+umH5Dfr8oh4EVP7VVg==
  dependencies:
    reusify "^1.0.4"

fb-watchman@^2.0.0:
  version "2.0.2"
  resolved "https://registry.yarnpkg.com/fb-watchman/-/fb-watchman-2.0.2.tgz#e9524ee6b5c77e9e5001af0f85f3adbb8623255c"
  integrity sha512-p5161BqbuCaSnB8jIbzQHOlpgsPmK5rJVDfDKO91Axs5NC1uu3HRQm6wt9cd9/+GtQQIO53JdGXXoyDpTAsgYA==
  dependencies:
    bser "2.1.1"

figures@^3.0.0:
  version "3.2.0"
  resolved "https://registry.yarnpkg.com/figures/-/figures-3.2.0.tgz#625c18bd293c604dc4a8ddb2febf0c88341746af"
  integrity sha512-yaduQFRKLXYOGgEn6AZau90j3ggSOyiqXU0F9JZfeXYhNa+Jk4X+s45A2zg5jns87GAFa34BBm2kXw4XpNcbdg==
  dependencies:
    escape-string-regexp "^1.0.5"

file-entry-cache@^6.0.1:
  version "6.0.1"
  resolved "https://registry.yarnpkg.com/file-entry-cache/-/file-entry-cache-6.0.1.tgz#211b2dd9659cb0394b073e7323ac3c933d522027"
  integrity sha512-7Gps/XWymbLk2QLYK4NzpMOrYjMhdIxXuIvy2QBsLE6ljuodKvdkWs/cpyJJ3CVIVpH0Oi1Hvg1ovbMzLdFBBg==
  dependencies:
    flat-cache "^3.0.4"

fill-range@^7.0.1:
  version "7.0.1"
  resolved "https://registry.yarnpkg.com/fill-range/-/fill-range-7.0.1.tgz#1919a6a7c75fe38b2c7c77e5198535da9acdda40"
  integrity sha512-qOo9F+dMUmC2Lcb4BbVvnKJxTPjCm+RRpe4gDuGrzkL7mEVl/djYSu2OdQ2Pa302N4oqkSg9ir6jaLWJ2USVpQ==
  dependencies:
    to-regex-range "^5.0.1"

finalhandler@1.2.0:
  version "1.2.0"
  resolved "https://registry.yarnpkg.com/finalhandler/-/finalhandler-1.2.0.tgz#7d23fe5731b207b4640e4fcd00aec1f9207a7b32"
  integrity sha512-5uXcUVftlQMFnWC9qu/svkWv3GTd2PfUhK/3PLkYNAe7FbqJMt3515HaxE6eRL74GdsriiwujiawdaB1BpEISg==
  dependencies:
    debug "2.6.9"
    encodeurl "~1.0.2"
    escape-html "~1.0.3"
    on-finished "2.4.1"
    parseurl "~1.3.3"
    statuses "2.0.1"
    unpipe "~1.0.0"

find-up@^4.0.0, find-up@^4.1.0:
  version "4.1.0"
  resolved "https://registry.yarnpkg.com/find-up/-/find-up-4.1.0.tgz#97afe7d6cdc0bc5928584b7c8d7b16e8a9aa5d19"
  integrity sha512-PpOwAdQ/YlXQ2vj8a3h8IipDuYRi3wceVQQGYWxNINccq40Anw7BlsEXCMbt1Zt+OLA6Fq9suIpIWD0OsnISlw==
  dependencies:
    locate-path "^5.0.0"
    path-exists "^4.0.0"

find-up@^5.0.0:
  version "5.0.0"
  resolved "https://registry.yarnpkg.com/find-up/-/find-up-5.0.0.tgz#4c92819ecb7083561e4f4a240a86be5198f536fc"
  integrity sha512-78/PXT1wlLLDgTzDs7sjq9hzz0vXD+zn+7wypEe4fXQxCmdmqfGsEPQxmiCSQI3ajFV91bVSsvNtrJRiW6nGng==
  dependencies:
    locate-path "^6.0.0"
    path-exists "^4.0.0"

flat-cache@^3.0.4:
  version "3.0.4"
  resolved "https://registry.yarnpkg.com/flat-cache/-/flat-cache-3.0.4.tgz#61b0338302b2fe9f957dcc32fc2a87f1c3048b11"
  integrity sha512-dm9s5Pw7Jc0GvMYbshN6zchCA9RgQlzzEZX3vylR9IqFfS8XciblUXOKfW6SiuJ0e13eDYZoZV5wdrev7P3Nwg==
  dependencies:
    flatted "^3.1.0"
    rimraf "^3.0.2"

flatted@^3.1.0:
  version "3.2.7"
  resolved "https://registry.yarnpkg.com/flatted/-/flatted-3.2.7.tgz#609f39207cb614b89d0765b477cb2d437fbf9787"
  integrity sha512-5nqDSxl8nn5BSNxyR3n4I6eDmbolI6WT+QqR547RwxQapgjQBmtktdP+HTBb/a/zLsbzERTONyUB5pefh5TtjQ==

for-each@^0.3.3:
  version "0.3.3"
  resolved "https://registry.yarnpkg.com/for-each/-/for-each-0.3.3.tgz#69b447e88a0a5d32c3e7084f3f1710034b21376e"
  integrity sha512-jqYfLp7mo9vIyQf8ykW2v7A+2N4QjeCeI5+Dz9XraiO1ign81wjiH7Fb9vSOWvQfNtmSa4H2RoQTrrXivdUZmw==
  dependencies:
    is-callable "^1.1.3"

foreground-child@^3.1.0:
  version "3.1.1"
  resolved "https://registry.yarnpkg.com/foreground-child/-/foreground-child-3.1.1.tgz#1d173e776d75d2772fed08efe4a0de1ea1b12d0d"
  integrity sha512-TMKDUnIte6bfb5nWv7V/caI169OHgvwjb7V4WkeUvbQQdjr5rWKqHFiKWb/fcOwB+CzBT+qbWjvj+DVwRskpIg==
  dependencies:
    cross-spawn "^7.0.0"
    signal-exit "^4.0.1"

fork-ts-checker-webpack-plugin@8.0.0:
  version "8.0.0"
  resolved "https://registry.yarnpkg.com/fork-ts-checker-webpack-plugin/-/fork-ts-checker-webpack-plugin-8.0.0.tgz#dae45dfe7298aa5d553e2580096ced79b6179504"
  integrity sha512-mX3qW3idpueT2klaQXBzrIM/pHw+T0B/V9KHEvNrqijTq9NFnMZU6oreVxDYcf33P8a5cW+67PjodNHthGnNVg==
  dependencies:
    "@babel/code-frame" "^7.16.7"
    chalk "^4.1.2"
    chokidar "^3.5.3"
    cosmiconfig "^7.0.1"
    deepmerge "^4.2.2"
    fs-extra "^10.0.0"
    memfs "^3.4.1"
    minimatch "^3.0.4"
    node-abort-controller "^3.0.1"
    schema-utils "^3.1.1"
    semver "^7.3.5"
    tapable "^2.2.1"

form-data@^4.0.0:
  version "4.0.0"
  resolved "https://registry.yarnpkg.com/form-data/-/form-data-4.0.0.tgz#93919daeaf361ee529584b9b31664dc12c9fa452"
  integrity sha512-ETEklSGi5t0QMZuiXoA/Q6vcnxcLQP5vdugSpuAyi6SVGi2clPPp+xgEhuMaHC+zGgn31Kd235W35f7Hykkaww==
  dependencies:
    asynckit "^0.4.0"
    combined-stream "^1.0.8"
    mime-types "^2.1.12"

formidable@^2.1.1:
  version "2.1.1"
  resolved "https://registry.yarnpkg.com/formidable/-/formidable-2.1.1.tgz#81269cbea1a613240049f5f61a9d97731517414f"
  integrity sha512-0EcS9wCFEzLvfiks7omJ+SiYJAiD+TzK4Pcw1UlUoGnhUxDcMKjt0P7x8wEb0u6OHu8Nb98WG3nxtlF5C7bvUQ==
  dependencies:
    dezalgo "^1.0.4"
    hexoid "^1.0.0"
    once "^1.4.0"
    qs "^6.11.0"

forwarded@0.2.0:
  version "0.2.0"
  resolved "https://registry.yarnpkg.com/forwarded/-/forwarded-0.2.0.tgz#2269936428aad4c15c7ebe9779a84bf0b2a81811"
  integrity sha512-buRG0fpBtRHSTCOASe6hD258tEubFoRLb4ZNA6NxMVHNw2gOcwHo9wyablzMzOA5z9xA9L1KNjk/Nt6MT9aYow==

fraction.js@^4.2.0:
  version "4.2.0"
  resolved "https://registry.yarnpkg.com/fraction.js/-/fraction.js-4.2.0.tgz#448e5109a313a3527f5a3ab2119ec4cf0e0e2950"
  integrity sha512-MhLuK+2gUcnZe8ZHlaaINnQLl0xRIGRfcGk2yl8xoQAfHrSsL3rYu6FCmBdkdbhc9EPlwyGHewaRsvwRMJtAlA==

fresh@0.5.2:
  version "0.5.2"
  resolved "https://registry.yarnpkg.com/fresh/-/fresh-0.5.2.tgz#3d8cadd90d976569fa835ab1f8e4b23a105605a7"
  integrity sha512-zJ2mQYM18rEFOudeV4GShTGIQ7RbzA7ozbU9I/XBpm7kqgMywgmylMwXHxZJmkVoYkna9d2pVXVXPdYTP9ej8Q==

fs-extra@^10.0.0:
  version "10.1.0"
  resolved "https://registry.yarnpkg.com/fs-extra/-/fs-extra-10.1.0.tgz#02873cfbc4084dde127eaa5f9905eef2325d1abf"
  integrity sha512-oRXApq54ETRj4eMiFzGnHWGy+zo5raudjuxN0b8H7s/RU2oW0Wvsx9O0ACRN/kRq9E8Vu/ReskGB5o3ji+FzHQ==
  dependencies:
    graceful-fs "^4.2.0"
    jsonfile "^6.0.1"
    universalify "^2.0.0"

fs-monkey@^1.0.3:
  version "1.0.3"
  resolved "https://registry.yarnpkg.com/fs-monkey/-/fs-monkey-1.0.3.tgz#ae3ac92d53bb328efe0e9a1d9541f6ad8d48e2d3"
  integrity sha512-cybjIfiiE+pTWicSCLFHSrXZ6EilF30oh91FDP9S2B051prEa7QWfrVTQm10/dDpswBDXZugPa1Ogu8Yh+HV0Q==

fs.realpath@^1.0.0:
  version "1.0.0"
  resolved "https://registry.yarnpkg.com/fs.realpath/-/fs.realpath-1.0.0.tgz#1504ad2523158caa40db4a2787cb01411994ea4f"
  integrity sha512-OO0pH2lK6a0hZnAdau5ItzHPI6pUlvI7jMVnxUQRtw4owF2wk8lOSabtGDCTP4Ggrg2MbGnWO9X8K1t4+fGMDw==

fsevents@^2.3.2, fsevents@~2.3.2:
  version "2.3.2"
  resolved "https://registry.yarnpkg.com/fsevents/-/fsevents-2.3.2.tgz#8a526f78b8fdf4623b709e0b975c52c24c02fd1a"
  integrity sha512-xiqMQR4xAeHTuB9uWm+fFRcIOgKBMiOBP+eXiyT7jsgVCq1bkVygt00oASowB7EdtpOHaaPgKt812P9ab+DDKA==

function-bind@^1.1.1:
  version "1.1.1"
  resolved "https://registry.yarnpkg.com/function-bind/-/function-bind-1.1.1.tgz#a56899d3ea3c9bab874bb9773b7c5ede92f4895d"
  integrity sha512-yIovAzMX49sF8Yl58fSCWJ5svSLuaibPxXQJFLmBObTuCr0Mf1KiPopGM9NiFjiYBCbfaa2Fh6breQ6ANVTI0A==

function.prototype.name@^1.1.5:
  version "1.1.5"
  resolved "https://registry.yarnpkg.com/function.prototype.name/-/function.prototype.name-1.1.5.tgz#cce0505fe1ffb80503e6f9e46cc64e46a12a9621"
  integrity sha512-uN7m/BzVKQnCUF/iW8jYea67v++2u7m5UgENbHRtdDVclOUP+FMPlCNdmk0h/ysGyo2tavMJEDqJAkJdRa1vMA==
  dependencies:
    call-bind "^1.0.2"
    define-properties "^1.1.3"
    es-abstract "^1.19.0"
    functions-have-names "^1.2.2"

functions-have-names@^1.2.2:
  version "1.2.3"
  resolved "https://registry.yarnpkg.com/functions-have-names/-/functions-have-names-1.2.3.tgz#0404fe4ee2ba2f607f0e0ec3c80bae994133b834"
  integrity sha512-xckBUXyTIqT97tq2x2AMb+g163b5JFysYk0x4qxNFwbfQkmNZoiRHb6sPzI9/QV33WeuvVYBUIiD4NzNIyqaRQ==

gensync@^1.0.0-beta.2:
  version "1.0.0-beta.2"
  resolved "https://registry.yarnpkg.com/gensync/-/gensync-1.0.0-beta.2.tgz#32a6ee76c3d7f52d46b2b1ae5d93fea8580a25e0"
  integrity sha512-3hN7NaskYvMDLQY55gnW3NQ+mesEAepTqlg+VEbj7zzqEMBVNhzcGYYeqFo/TlYz6eQiFcp1HcsCZO+nGgS8zg==

get-caller-file@^2.0.5:
  version "2.0.5"
  resolved "https://registry.yarnpkg.com/get-caller-file/-/get-caller-file-2.0.5.tgz#4f94412a82db32f36e3b0b9741f8a97feb031f7e"
  integrity sha512-DyFP3BM/3YHTQOCUL/w0OZHR0lpKeGrxotcHWcqNEdnltqFwXVfhEBQ94eIo34AfQpo0rGki4cyIiftY06h2Fg==

get-intrinsic@^1.0.2, get-intrinsic@^1.1.0, get-intrinsic@^1.1.1, get-intrinsic@^1.1.3:
  version "1.1.3"
  resolved "https://registry.yarnpkg.com/get-intrinsic/-/get-intrinsic-1.1.3.tgz#063c84329ad93e83893c7f4f243ef63ffa351385"
  integrity sha512-QJVz1Tj7MS099PevUG5jvnt9tSkXN8K14dxQlikJuPt4uD9hHAHjLyLBiLR5zELelBdD9QNRAXZzsJx0WaDL9A==
  dependencies:
    function-bind "^1.1.1"
    has "^1.0.3"
    has-symbols "^1.0.3"

get-package-type@^0.1.0:
  version "0.1.0"
  resolved "https://registry.yarnpkg.com/get-package-type/-/get-package-type-0.1.0.tgz#8de2d803cff44df3bc6c456e6668b36c3926e11a"
  integrity sha512-pjzuKtY64GYfWizNAJ0fr9VqttZkNiK2iS430LtIHzjBEr6bX8Am2zm4sW4Ro5wjWW5cAlRL1qAMTcXbjNAO2Q==

get-stream@^5.0.0:
  version "5.2.0"
  resolved "https://registry.yarnpkg.com/get-stream/-/get-stream-5.2.0.tgz#4966a1795ee5ace65e706c4b7beb71257d6e22d3"
  integrity sha512-nBF+F1rAZVCu/p7rjzgA+Yb4lfYXrpl7a6VmJrU8wF9I1CKvP/QwPNZHnOlwbTkY6dvtFIzFMSyQXbLoTQPRpA==
  dependencies:
    pump "^3.0.0"

get-stream@^6.0.0:
  version "6.0.1"
  resolved "https://registry.yarnpkg.com/get-stream/-/get-stream-6.0.1.tgz#a262d8eef67aced57c2852ad6167526a43cbf7b7"
  integrity sha512-ts6Wi+2j3jQjqi70w5AlN8DFnkSwC+MqmxEzdEALB2qXZYV3X/b1CTfgPLGJNMeAWxdPfU8FO1ms3NUfaHCPYg==

get-symbol-description@^1.0.0:
  version "1.0.0"
  resolved "https://registry.yarnpkg.com/get-symbol-description/-/get-symbol-description-1.0.0.tgz#7fdb81c900101fbd564dd5f1a30af5aadc1e58d6"
  integrity sha512-2EmdH1YvIQiZpltCNgkuiUnyukzxM/R6NDJX31Ke3BG1Nq5b0S2PhX59UKi9vZpPDQVdqn+1IcaAwnzTT5vCjw==
  dependencies:
    call-bind "^1.0.2"
    get-intrinsic "^1.1.1"

get-tsconfig@^4.2.0:
  version "4.2.0"
  resolved "https://registry.yarnpkg.com/get-tsconfig/-/get-tsconfig-4.2.0.tgz#ff368dd7104dab47bf923404eb93838245c66543"
  integrity sha512-X8u8fREiYOE6S8hLbq99PeykTDoLVnxvF4DjWKJmz9xy2nNRdUcV8ZN9tniJFeKyTU3qnC9lL8n4Chd6LmVKHg==

glob-parent@^5.1.2, glob-parent@~5.1.2:
  version "5.1.2"
  resolved "https://registry.yarnpkg.com/glob-parent/-/glob-parent-5.1.2.tgz#869832c58034fe68a4093c17dc15e8340d8401c4"
  integrity sha512-AOIgSQCepiJYwP3ARnGx+5VnTu2HBYdzbGP45eLw1vr3zB3vZLeyed1sC9hnbcOc9/SrMyM5RPQrkGz4aS9Zow==
  dependencies:
    is-glob "^4.0.1"

glob-parent@^6.0.2:
  version "6.0.2"
  resolved "https://registry.yarnpkg.com/glob-parent/-/glob-parent-6.0.2.tgz#6d237d99083950c79290f24c7642a3de9a28f9e3"
  integrity sha512-XxwI8EOhVQgWp6iDL+3b0r86f4d6AX6zSU55HfB4ydCEuXLXc5FcYeOu+nnGftS4TEju/11rt4KJPTMgbfmv4A==
  dependencies:
    is-glob "^4.0.3"

glob-to-regexp@^0.4.1:
  version "0.4.1"
  resolved "https://registry.yarnpkg.com/glob-to-regexp/-/glob-to-regexp-0.4.1.tgz#c75297087c851b9a578bd217dd59a92f59fe546e"
  integrity sha512-lkX1HJXwyMcprw/5YUZc2s7DrpAiHB21/V+E1rHUrVNokkvB6bqMzT0VfV6/86ZNabt1k14YOIaT7nDvOX3Iiw==

glob@7.1.6:
  version "7.1.6"
  resolved "https://registry.yarnpkg.com/glob/-/glob-7.1.6.tgz#141f33b81a7c2492e125594307480c46679278a6"
  integrity sha512-LwaxwyZ72Lk7vZINtNNrywX0ZuLyStrdDtabefZKAY5ZGJhVtgdznluResxNmPitE0SAO+O26sWTHeKSI2wMBA==
  dependencies:
    fs.realpath "^1.0.0"
    inflight "^1.0.4"
    inherits "2"
    minimatch "^3.0.4"
    once "^1.3.0"
    path-is-absolute "^1.0.0"

glob@7.1.7:
  version "7.1.7"
  resolved "https://registry.yarnpkg.com/glob/-/glob-7.1.7.tgz#3b193e9233f01d42d0b3f78294bbeeb418f94a90"
  integrity sha512-OvD9ENzPLbegENnYP5UUfJIirTg4+XwMWGaQfQTY0JenxNvvIKP3U3/tAQSPIu/lHxXYSZmpXlUHeqAIdKzBLQ==
  dependencies:
    fs.realpath "^1.0.0"
    inflight "^1.0.4"
    inherits "2"
    minimatch "^3.0.4"
    once "^1.3.0"
    path-is-absolute "^1.0.0"

glob@^10.2.5:
  version "10.3.3"
  resolved "https://registry.yarnpkg.com/glob/-/glob-10.3.3.tgz#8360a4ffdd6ed90df84aa8d52f21f452e86a123b"
  integrity sha512-92vPiMb/iqpmEgsOoIDvTjc50wf9CCCvMzsi6W0JLPeUKE8TWP1a73PgqSrqy7iAZxaSD1YdzU7QZR5LF51MJw==
  dependencies:
    foreground-child "^3.1.0"
    jackspeak "^2.0.3"
    minimatch "^9.0.1"
    minipass "^5.0.0 || ^6.0.2 || ^7.0.0"
    path-scurry "^1.10.1"

glob@^7.0.0, glob@^7.1.3, glob@^7.1.4:
  version "7.2.3"
  resolved "https://registry.yarnpkg.com/glob/-/glob-7.2.3.tgz#b8df0fb802bbfa8e89bd1d938b4e16578ed44f2b"
  integrity sha512-nFR0zLpU2YCaRxwoCJvL6UvCH2JFyFVIvwTLsIf21AuHlMskA1hhTdk+LlYJtOlYt9v6dvszD2BGRqBL+iQK9Q==
  dependencies:
    fs.realpath "^1.0.0"
    inflight "^1.0.4"
    inherits "2"
    minimatch "^3.1.1"
    once "^1.3.0"
    path-is-absolute "^1.0.0"

glob@^9.2.0:
  version "9.3.5"
  resolved "https://registry.yarnpkg.com/glob/-/glob-9.3.5.tgz#ca2ed8ca452781a3009685607fdf025a899dfe21"
  integrity sha512-e1LleDykUz2Iu+MTYdkSsuWX8lvAjAcs0Xef0lNIu0S2wOAzuTxCJtcd9S3cijlwYF18EsU3rzb8jPVobxDh9Q==
  dependencies:
    fs.realpath "^1.0.0"
    minimatch "^8.0.2"
    minipass "^4.2.4"
    path-scurry "^1.6.1"

globals@^11.1.0:
  version "11.12.0"
  resolved "https://registry.yarnpkg.com/globals/-/globals-11.12.0.tgz#ab8795338868a0babd8525758018c2a7eb95c42e"
  integrity sha512-WOBp/EEGUiIsJSp7wcv/y6MO+lV9UoncWqxuFfm8eBwzWNgyfBd6Gz+IeKQ9jCmyhoH99g15M3T+QaVHFjizVA==

globals@^13.19.0:
  version "13.20.0"
  resolved "https://registry.yarnpkg.com/globals/-/globals-13.20.0.tgz#ea276a1e508ffd4f1612888f9d1bad1e2717bf82"
  integrity sha512-Qg5QtVkCy/kv3FUSlu4ukeZDVf9ee0iXLAUYX13gbR17bnejFTzr4iS9bY7kwCf1NztRNm1t91fjOiyx4CSwPQ==
  dependencies:
    type-fest "^0.20.2"

globalyzer@0.1.0:
  version "0.1.0"
  resolved "https://registry.yarnpkg.com/globalyzer/-/globalyzer-0.1.0.tgz#cb76da79555669a1519d5a8edf093afaa0bf1465"
  integrity sha512-40oNTM9UfG6aBmuKxk/giHn5nQ8RVz/SS4Ir6zgzOv9/qC3kKZ9v4etGTcJbEl/NyVQH7FGU7d+X1egr57Md2Q==

globby@^11.1.0:
  version "11.1.0"
  resolved "https://registry.yarnpkg.com/globby/-/globby-11.1.0.tgz#bd4be98bb042f83d796f7e3811991fbe82a0d34b"
  integrity sha512-jhIXaOzy1sb8IyocaruWSn1TjmnBVs8Ayhcy83rmxNJ8q2uWKCAj3CnJY+KpGSXCueAPc0i05kVvVKtP1t9S3g==
  dependencies:
    array-union "^2.1.0"
    dir-glob "^3.0.1"
    fast-glob "^3.2.9"
    ignore "^5.2.0"
    merge2 "^1.4.1"
    slash "^3.0.0"

globby@^13.1.2:
  version "13.1.3"
  resolved "https://registry.yarnpkg.com/globby/-/globby-13.1.3.tgz#f62baf5720bcb2c1330c8d4ef222ee12318563ff"
  integrity sha512-8krCNHXvlCgHDpegPzleMq07yMYTO2sXKASmZmquEYWEmCx6J5UTRbp5RwMJkTJGtcQ44YpiUYUiN0b9mzy8Bw==
  dependencies:
    dir-glob "^3.0.1"
    fast-glob "^3.2.11"
    ignore "^5.2.0"
    merge2 "^1.4.1"
    slash "^4.0.0"

globrex@^0.1.2:
  version "0.1.2"
  resolved "https://registry.yarnpkg.com/globrex/-/globrex-0.1.2.tgz#dd5d9ec826232730cd6793a5e33a9302985e6098"
  integrity sha512-uHJgbwAMwNFf5mLst7IWLNg14x1CkeqglJb/K3doi4dw6q2IvAAmM/Y81kevy83wP+Sst+nutFTYOGg3d1lsxg==

gopd@^1.0.1:
  version "1.0.1"
  resolved "https://registry.yarnpkg.com/gopd/-/gopd-1.0.1.tgz#29ff76de69dac7489b7c0918a5788e56477c332c"
  integrity sha512-d65bNlIadxvpb/A2abVdlqKqV563juRnZ1Wtk6s1sIR8uNsXR70xqIzVqxVf1eTqDunwT2MkczEeaezCKTZhwA==
  dependencies:
    get-intrinsic "^1.1.3"

graceful-fs@^4.1.2, graceful-fs@^4.1.6, graceful-fs@^4.2.0, graceful-fs@^4.2.4, graceful-fs@^4.2.9:
  version "4.2.10"
  resolved "https://registry.yarnpkg.com/graceful-fs/-/graceful-fs-4.2.10.tgz#147d3a006da4ca3ce14728c7aefc287c367d7a6c"
  integrity sha512-9ByhssR2fPVsNZj478qUUbKfmL0+t5BDVyjShtyZZLiK7ZDAArFFfopyOTj0M05wE2tJPisA4iTnnXl2YoPvOA==

graphemer@^1.4.0:
  version "1.4.0"
  resolved "https://registry.yarnpkg.com/graphemer/-/graphemer-1.4.0.tgz#fb2f1d55e0e3a1849aeffc90c4fa0dd53a0e66c6"
  integrity sha512-EtKwoO6kxCL9WO5xipiHTZlSzBm7WLT627TqC/uVRd0HKmq8NXyebnNYxDoBi7wt8eTWrUrKXCOVaFq9x1kgag==

has-bigints@^1.0.1, has-bigints@^1.0.2:
  version "1.0.2"
  resolved "https://registry.yarnpkg.com/has-bigints/-/has-bigints-1.0.2.tgz#0871bd3e3d51626f6ca0966668ba35d5602d6eaa"
  integrity sha512-tSvCKtBr9lkF0Ex0aQiP9N+OpV4zi2r/Nee5VkRDbaqv35RLYMzbwQfFSZZH0kR+Rd6302UJZ2p/bJCEoR3VoQ==

has-flag@^3.0.0:
  version "3.0.0"
  resolved "https://registry.yarnpkg.com/has-flag/-/has-flag-3.0.0.tgz#b5d454dc2199ae225699f3467e5a07f3b955bafd"
  integrity sha512-sKJf1+ceQBr4SMkvQnBDNDtf4TXpVhVGateu0t918bl30FnbE2m4vNLX+VWe/dpjlb+HugGYzW7uQXH98HPEYw==

has-flag@^4.0.0:
  version "4.0.0"
  resolved "https://registry.yarnpkg.com/has-flag/-/has-flag-4.0.0.tgz#944771fd9c81c81265c4d6941860da06bb59479b"
  integrity sha512-EykJT/Q1KjTWctppgIAgfSO0tKVuZUjhgMr17kqTumMl6Afv3EISleU7qZUzoXDFTAHTDC4NOoG/ZxU3EvlMPQ==

has-own-prop@^2.0.0:
  version "2.0.0"
  resolved "https://registry.yarnpkg.com/has-own-prop/-/has-own-prop-2.0.0.tgz#f0f95d58f65804f5d218db32563bb85b8e0417af"
  integrity sha512-Pq0h+hvsVm6dDEa8x82GnLSYHOzNDt7f0ddFa3FqcQlgzEiptPqL+XrOJNavjOzSYiYWIrgeVYYgGlLmnxwilQ==

has-property-descriptors@^1.0.0:
  version "1.0.0"
  resolved "https://registry.yarnpkg.com/has-property-descriptors/-/has-property-descriptors-1.0.0.tgz#610708600606d36961ed04c196193b6a607fa861"
  integrity sha512-62DVLZGoiEBDHQyqG4w9xCuZ7eJEwNmJRWw2VY84Oedb7WFcA27fiEVe8oUQx9hAUJ4ekurquucTGwsyO1XGdQ==
  dependencies:
    get-intrinsic "^1.1.1"

has-symbols@^1.0.1, has-symbols@^1.0.2, has-symbols@^1.0.3:
  version "1.0.3"
  resolved "https://registry.yarnpkg.com/has-symbols/-/has-symbols-1.0.3.tgz#bb7b2c4349251dce87b125f7bdf874aa7c8b39f8"
  integrity sha512-l3LCuF6MgDNwTDKkdYGEihYjt5pRPbEg46rtlmnSPlUbgmB8LOIrKJbYYFBSbnPaJexMKtiPO8hmeRjRz2Td+A==

has-tostringtag@^1.0.0:
  version "1.0.0"
  resolved "https://registry.yarnpkg.com/has-tostringtag/-/has-tostringtag-1.0.0.tgz#7e133818a7d394734f941e73c3d3f9291e658b25"
  integrity sha512-kFjcSNhnlGV1kyoGk7OXKSawH5JOb/LzUc5w9B02hOTO0dfFRjbHQKvg1d6cf3HbeUmtU9VbbV3qzZ2Teh97WQ==
  dependencies:
    has-symbols "^1.0.2"

has@^1.0.3:
  version "1.0.3"
  resolved "https://registry.yarnpkg.com/has/-/has-1.0.3.tgz#722d7cbfc1f6aa8241f16dd814e011e1f41e8796"
  integrity sha512-f2dvO0VU6Oej7RkWJGrehjbzMAjFp5/VKPp5tTpWIV4JHHZK1/BxbFRtf/siA2SWTe09caDmVtYYzWEIbBS4zw==
  dependencies:
    function-bind "^1.1.1"

hexoid@^1.0.0:
  version "1.0.0"
  resolved "https://registry.yarnpkg.com/hexoid/-/hexoid-1.0.0.tgz#ad10c6573fb907de23d9ec63a711267d9dc9bc18"
  integrity sha512-QFLV0taWQOZtvIRIAdBChesmogZrtuXvVWsFHZTk2SU+anspqZ2vMnoLg7IE1+Uk16N19APic1BuF8bC8c2m5g==

hoist-non-react-statics@^3.3.0, hoist-non-react-statics@^3.3.2:
  version "3.3.2"
  resolved "https://registry.yarnpkg.com/hoist-non-react-statics/-/hoist-non-react-statics-3.3.2.tgz#ece0acaf71d62c2969c2ec59feff42a4b1a85b45"
  integrity sha512-/gGivxi8JPKWNm/W0jSmzcMPpfpPLc3dY/6GxhX2hQ9iGj3aDfklV4ET7NjKpSinLpJ5vafa9iiGIEZg10SfBw==
  dependencies:
    react-is "^16.7.0"

html-encoding-sniffer@^3.0.0:
  version "3.0.0"
  resolved "https://registry.yarnpkg.com/html-encoding-sniffer/-/html-encoding-sniffer-3.0.0.tgz#2cb1a8cf0db52414776e5b2a7a04d5dd98158de9"
  integrity sha512-oWv4T4yJ52iKrufjnyZPkrN0CH3QnrUqdB6In1g5Fe1mia8GmF36gnfNySxoZtxD5+NmYw1EElVXiBk93UeskA==
  dependencies:
    whatwg-encoding "^2.0.0"

html-escaper@^2.0.0:
  version "2.0.2"
  resolved "https://registry.yarnpkg.com/html-escaper/-/html-escaper-2.0.2.tgz#dfd60027da36a36dfcbe236262c00a5822681453"
  integrity sha512-H2iMtd0I4Mt5eYiapRdIDjp+XzelXQ0tFE4JS7YFwFevXXMmOp9myNrUvCg0D6ws8iqkRPBfKHgbwig1SmlLfg==

http-errors@2.0.0:
  version "2.0.0"
  resolved "https://registry.yarnpkg.com/http-errors/-/http-errors-2.0.0.tgz#b7774a1486ef73cf7667ac9ae0858c012c57b9d3"
  integrity sha512-FtwrG/euBzaEjYeRqOgly7G0qviiXoJWnvEH2Z1plBdXgbyjv34pHTSb9zoeHMyDy33+DWy5Wt9Wo+TURtOYSQ==
  dependencies:
    depd "2.0.0"
    inherits "2.0.4"
    setprototypeof "1.2.0"
    statuses "2.0.1"
    toidentifier "1.0.1"

http-proxy-agent@^5.0.0:
  version "5.0.0"
  resolved "https://registry.yarnpkg.com/http-proxy-agent/-/http-proxy-agent-5.0.0.tgz#5129800203520d434f142bc78ff3c170800f2b43"
  integrity sha512-n2hY8YdoRE1i7r6M0w9DIw5GgZN0G25P8zLCRQ8rjXtTU3vsNFBI/vWK/UIeE6g5MUUz6avwAPXmL6Fy9D/90w==
  dependencies:
    "@tootallnate/once" "2"
    agent-base "6"
    debug "4"

https-proxy-agent@^5.0.1:
  version "5.0.1"
  resolved "https://registry.yarnpkg.com/https-proxy-agent/-/https-proxy-agent-5.0.1.tgz#c59ef224a04fe8b754f3db0063a25ea30d0005d6"
  integrity sha512-dFcAjpTQFgoLMzC2VwU+C/CbS7uRL0lWmxDITmqm7C+7F0Odmj6s9l6alZc6AELXhrnggM2CeWSXHGOdX2YtwA==
  dependencies:
    agent-base "6"
    debug "4"

human-signals@^1.1.1:
  version "1.1.1"
  resolved "https://registry.yarnpkg.com/human-signals/-/human-signals-1.1.1.tgz#c5b1cd14f50aeae09ab6c59fe63ba3395fe4dfa3"
  integrity sha512-SEQu7vl8KjNL2eoGBLF3+wAjpsNfA9XMlXAYj/3EdaNfAlxKthD1xjEQfGOUhllCGGJVNY34bRr6lPINhNjyZw==

human-signals@^2.1.0:
  version "2.1.0"
  resolved "https://registry.yarnpkg.com/human-signals/-/human-signals-2.1.0.tgz#dc91fcba42e4d06e4abaed33b3e7a3c02f514ea0"
  integrity sha512-B4FFZ6q/T2jhhksgkbEW3HBvWIfDW85snkQgawt07S7J5QXTk6BkNV+0yAeZrM5QpMAdYlocGoljn0sJ/WQkFw==

iconv-lite@0.4.24, iconv-lite@^0.4.24:
  version "0.4.24"
  resolved "https://registry.yarnpkg.com/iconv-lite/-/iconv-lite-0.4.24.tgz#2022b4b25fbddc21d2f524974a474aafe733908b"
  integrity sha512-v3MXnZAcvnywkTUEZomIActle7RXXeedOR31wwl7VlyoXO4Qi9arvSenNQWne1TcRwhCL1HwLI21bEqdpj8/rA==
  dependencies:
    safer-buffer ">= 2.1.2 < 3"

iconv-lite@0.6.3:
  version "0.6.3"
  resolved "https://registry.yarnpkg.com/iconv-lite/-/iconv-lite-0.6.3.tgz#a52f80bf38da1952eb5c681790719871a1a72501"
  integrity sha512-4fCk79wshMdzMp2rH06qWrJE4iolqLhCUH+OiuIgU++RB0+94NlDL81atO7GX55uUKueo0txHNtvEyI6D7WdMw==
  dependencies:
    safer-buffer ">= 2.1.2 < 3.0.0"

ieee754@^1.1.13:
  version "1.2.1"
  resolved "https://registry.yarnpkg.com/ieee754/-/ieee754-1.2.1.tgz#8eb7a10a63fff25d15a57b001586d177d1b0d352"
  integrity sha512-dcyqhDvX1C46lXZcVqCpK+FtMRQVdIMN6/Df5js2zouUsqG7I6sFxitIC+7KYK29KdXOLHdu9zL4sFnoVQnqaA==

ignore@^5.2.0:
  version "5.2.1"
  resolved "https://registry.yarnpkg.com/ignore/-/ignore-5.2.1.tgz#c2b1f76cb999ede1502f3a226a9310fdfe88d46c"
  integrity sha512-d2qQLzTJ9WxQftPAuEQpSPmKqzxePjzVbpAVv62AQ64NTL+wR4JkrVqR/LqFsFEUsHDAiId52mJteHDFuDkElA==

ignore@^5.2.4:
  version "5.2.4"
  resolved "https://registry.yarnpkg.com/ignore/-/ignore-5.2.4.tgz#a291c0c6178ff1b960befe47fcdec301674a6324"
  integrity sha512-MAb38BcSbH0eHNBxn7ql2NH/kX33OkB3lZ1BNdh7ENeRChHTYsTvWrMubiIAMNS2llXEEgZ1MUOBtXChP3kaFQ==

immer@^9.0.21:
  version "9.0.21"
  resolved "https://registry.yarnpkg.com/immer/-/immer-9.0.21.tgz#1e025ea31a40f24fb064f1fef23e931496330176"
  integrity sha512-bc4NBHqOqSfRW7POMkHd51LvClaeMXpm8dx0e8oE2GORbq5aRK7Bxl4FyzVLdGtLmvLKL7BTDBG5ACQm4HWjTA==

import-fresh@^3.2.1:
  version "3.3.0"
  resolved "https://registry.yarnpkg.com/import-fresh/-/import-fresh-3.3.0.tgz#37162c25fcb9ebaa2e6e53d5b4d88ce17d9e0c2b"
  integrity sha512-veYYhQa+D1QBKznvhUHxb8faxlrwUnxseDAbAp457E0wLNio2bOSKnjYDhMj+YiAq61xrMGhQk9iXVk5FzgQMw==
  dependencies:
    parent-module "^1.0.0"
    resolve-from "^4.0.0"

import-local@^3.0.2:
  version "3.1.0"
  resolved "https://registry.yarnpkg.com/import-local/-/import-local-3.1.0.tgz#b4479df8a5fd44f6cdce24070675676063c95cb4"
  integrity sha512-ASB07uLtnDs1o6EHjKpX34BKYDSqnFerfTOJL2HvMqF70LnxpjkzDB8J44oT9pu4AMPkQwf8jl6szgvNd2tRIg==
  dependencies:
    pkg-dir "^4.2.0"
    resolve-cwd "^3.0.0"

imurmurhash@^0.1.4:
  version "0.1.4"
  resolved "https://registry.yarnpkg.com/imurmurhash/-/imurmurhash-0.1.4.tgz#9218b9b2b928a238b13dc4fb6b6d576f231453ea"
  integrity sha512-JmXMZ6wuvDmLiHEml9ykzqO6lwFbof0GG4IkcGaENdCRDDmMVnny7s5HsIgHCbaq0w2MyPhDqkhTUgS2LU2PHA==

indent-string@^4.0.0:
  version "4.0.0"
  resolved "https://registry.yarnpkg.com/indent-string/-/indent-string-4.0.0.tgz#624f8f4497d619b2d9768531d58f4122854d7251"
  integrity sha512-EdDDZu4A2OyIK7Lr/2zG+w5jmbuk1DVBnEwREQvBzspBJkCEbRa8GxU1lghYcaGJCnRWibjDXlq779X1/y5xwg==

inflight@^1.0.4:
  version "1.0.6"
  resolved "https://registry.yarnpkg.com/inflight/-/inflight-1.0.6.tgz#49bd6331d7d02d0c09bc910a1075ba8165b56df9"
  integrity sha512-k92I/b08q4wvFscXCLvqfsHCrjrF7yiXsQuIVvVE7N82W3+aqpzuUdBbfhWcy/FZR3/4IgflMgKLOsvPDrGCJA==
  dependencies:
    once "^1.3.0"
    wrappy "1"

inherits@2, inherits@2.0.4, inherits@^2.0.3, inherits@^2.0.4, inherits@~2.0.3:
  version "2.0.4"
  resolved "https://registry.yarnpkg.com/inherits/-/inherits-2.0.4.tgz#0fa2c64f932917c3433a0ded55363aae37416b7c"
  integrity sha512-k/vGaX4/Yla3WzyMCvTQOXYeIHvqOKtnqBduzTHpzpQZzAskKMhZ2K+EnBiSM9zGSoIFeMpXKxa4dYeZIQqewQ==

inquirer@8.2.4:
  version "8.2.4"
  resolved "https://registry.yarnpkg.com/inquirer/-/inquirer-8.2.4.tgz#ddbfe86ca2f67649a67daa6f1051c128f684f0b4"
  integrity sha512-nn4F01dxU8VeKfq192IjLsxu0/OmMZ4Lg3xKAns148rCaXP6ntAoEkVYZThWjwON8AlzdZZi6oqnhNbxUG9hVg==
  dependencies:
    ansi-escapes "^4.2.1"
    chalk "^4.1.1"
    cli-cursor "^3.1.0"
    cli-width "^3.0.0"
    external-editor "^3.0.3"
    figures "^3.0.0"
    lodash "^4.17.21"
    mute-stream "0.0.8"
    ora "^5.4.1"
    run-async "^2.4.0"
    rxjs "^7.5.5"
    string-width "^4.1.0"
    strip-ansi "^6.0.0"
    through "^2.3.6"
    wrap-ansi "^7.0.0"

inquirer@8.2.5:
  version "8.2.5"
  resolved "https://registry.yarnpkg.com/inquirer/-/inquirer-8.2.5.tgz#d8654a7542c35a9b9e069d27e2df4858784d54f8"
  integrity sha512-QAgPDQMEgrDssk1XiwwHoOGYF9BAbUcc1+j+FhEvaOt8/cKRqyLn0U5qA6F74fGhTMGxf92pOvPBeh29jQJDTQ==
  dependencies:
    ansi-escapes "^4.2.1"
    chalk "^4.1.1"
    cli-cursor "^3.1.0"
    cli-width "^3.0.0"
    external-editor "^3.0.3"
    figures "^3.0.0"
    lodash "^4.17.21"
    mute-stream "0.0.8"
    ora "^5.4.1"
    run-async "^2.4.0"
    rxjs "^7.5.5"
    string-width "^4.1.0"
    strip-ansi "^6.0.0"
    through "^2.3.6"
    wrap-ansi "^7.0.0"

internal-slot@^1.0.3:
  version "1.0.4"
  resolved "https://registry.yarnpkg.com/internal-slot/-/internal-slot-1.0.4.tgz#8551e7baf74a7a6ba5f749cfb16aa60722f0d6f3"
  integrity sha512-tA8URYccNzMo94s5MQZgH8NB/XTa6HsOo0MLfXTKKEnHVVdegzaQoFZ7Jp44bdvLvY2waT5dc+j5ICEswhi7UQ==
  dependencies:
    get-intrinsic "^1.1.3"
    has "^1.0.3"
    side-channel "^1.0.4"

interpret@^1.0.0:
  version "1.4.0"
  resolved "https://registry.yarnpkg.com/interpret/-/interpret-1.4.0.tgz#665ab8bc4da27a774a40584e812e3e0fa45b1a1e"
  integrity sha512-agE4QfB2Lkp9uICn7BAqoscw4SZP9kTE2hxiFI3jBPmXJfdqiahTbUuKGsMoN2GtqL9AxhYioAcVvgsb1HvRbA==

ipaddr.js@1.9.1:
  version "1.9.1"
  resolved "https://registry.yarnpkg.com/ipaddr.js/-/ipaddr.js-1.9.1.tgz#bff38543eeb8984825079ff3a2a8e6cbd46781b3"
  integrity sha512-0KI/607xoxSToH7GjN1FfSbLoU0+btTicjsQSWQlh/hZykN8KpmMf7uYwPW3R+akZ6R/w18ZlXSHBYXiYUPO3g==

is-arguments@^1.1.0, is-arguments@^1.1.1:
  version "1.1.1"
  resolved "https://registry.yarnpkg.com/is-arguments/-/is-arguments-1.1.1.tgz#15b3f88fda01f2a97fec84ca761a560f123efa9b"
  integrity sha512-8Q7EARjzEnKpt/PCD7e1cgUS0a6X8u5tdSiMqXhojOdoV9TsMsiO+9VLC5vAmO8N7/GmXn7yjR8qnA6bVAEzfA==
  dependencies:
    call-bind "^1.0.2"
    has-tostringtag "^1.0.0"

is-arrayish@^0.2.1:
  version "0.2.1"
  resolved "https://registry.yarnpkg.com/is-arrayish/-/is-arrayish-0.2.1.tgz#77c99840527aa8ecb1a8ba697b80645a7a926a9d"
  integrity sha512-zz06S8t0ozoDXMG+ube26zeCTNXcKIPJZJi8hBrF4idCLms4CG9QtK7qBl1boi5ODzFpjswb5JPmHCbMpjaYzg==

is-bigint@^1.0.1:
  version "1.0.4"
  resolved "https://registry.yarnpkg.com/is-bigint/-/is-bigint-1.0.4.tgz#08147a1875bc2b32005d41ccd8291dffc6691df3"
  integrity sha512-zB9CruMamjym81i2JZ3UMn54PKGsQzsJeo6xvN3HJJ4CAsQNB6iRutp2To77OfCNuoxspsIhzaPoO1zyCEhFOg==
  dependencies:
    has-bigints "^1.0.1"

is-binary-path@~2.1.0:
  version "2.1.0"
  resolved "https://registry.yarnpkg.com/is-binary-path/-/is-binary-path-2.1.0.tgz#ea1f7f3b80f064236e83470f86c09c254fb45b09"
  integrity sha512-ZMERYes6pDydyuGidse7OsHxtbI7WVeUEozgR/g7rd0xUimYNlvZRE/K2MgZTjWy725IfelLeVcEM97mmtRGXw==
  dependencies:
    binary-extensions "^2.0.0"

is-boolean-object@^1.1.0:
  version "1.1.2"
  resolved "https://registry.yarnpkg.com/is-boolean-object/-/is-boolean-object-1.1.2.tgz#5c6dc200246dd9321ae4b885a114bb1f75f63719"
  integrity sha512-gDYaKHJmnj4aWxyj6YHyXVpdQawtVLHU5cb+eztPGczf6cjuTdwve5ZIEfgXqH4e57An1D1AKf8CZ3kYrQRqYA==
  dependencies:
    call-bind "^1.0.2"
    has-tostringtag "^1.0.0"

is-callable@^1.1.3, is-callable@^1.1.4, is-callable@^1.2.7:
  version "1.2.7"
  resolved "https://registry.yarnpkg.com/is-callable/-/is-callable-1.2.7.tgz#3bc2a85ea742d9e36205dcacdd72ca1fdc51b055"
  integrity sha512-1BC0BVFhS/p0qtw6enp8e+8OD0UrK0oFLztSjNzhcKA3WDuJxxAPXzPuPtKkjEY9UUoEWlX/8fgKeu2S8i9JTA==

is-core-module@^2.10.0, is-core-module@^2.8.1, is-core-module@^2.9.0:
  version "2.11.0"
  resolved "https://registry.yarnpkg.com/is-core-module/-/is-core-module-2.11.0.tgz#ad4cb3e3863e814523c96f3f58d26cc570ff0144"
  integrity sha512-RRjxlvLDkD1YJwDbroBHMb+cukurkDWNyHx7D3oNB5x9rb5ogcksMC5wHCadcXoo67gVr/+3GFySh3134zi6rw==
  dependencies:
    has "^1.0.3"

is-core-module@^2.11.0:
  version "2.12.1"
  resolved "https://registry.yarnpkg.com/is-core-module/-/is-core-module-2.12.1.tgz#0c0b6885b6f80011c71541ce15c8d66cf5a4f9fd"
  integrity sha512-Q4ZuBAe2FUsKtyQJoQHlvP8OvBERxO3jEmy1I7hcRXcJBGGHFh/aJBswbXuS9sgrDH2QUO8ilkwNPHvHMd8clg==
  dependencies:
    has "^1.0.3"

is-date-object@^1.0.1, is-date-object@^1.0.5:
  version "1.0.5"
  resolved "https://registry.yarnpkg.com/is-date-object/-/is-date-object-1.0.5.tgz#0841d5536e724c25597bf6ea62e1bd38298df31f"
  integrity sha512-9YQaSxsAiSwcvS33MBk3wTCVnWK+HhF8VZR2jRxehM16QcVOdHqPn4VPHmRK4lSr38n9JriurInLcP90xsYNfQ==
  dependencies:
    has-tostringtag "^1.0.0"

is-docker@^2.0.0, is-docker@^2.1.1:
  version "2.2.1"
  resolved "https://registry.yarnpkg.com/is-docker/-/is-docker-2.2.1.tgz#33eeabe23cfe86f14bde4408a02c0cfb853acdaa"
  integrity sha512-F+i2BKsFrH66iaUFc0woD8sLy8getkwTwtOBjvs56Cx4CgJDeKQeqfz8wAYiSb8JOprWhHH5p77PbmYCvvUuXQ==

is-extglob@^2.1.1:
  version "2.1.1"
  resolved "https://registry.yarnpkg.com/is-extglob/-/is-extglob-2.1.1.tgz#a88c02535791f02ed37c76a1b9ea9773c833f8c2"
  integrity sha512-SbKbANkN603Vi4jEZv49LeVJMn4yGwsbzZworEoyEiutsN3nJYdbO36zfhGJ6QEDpOZIFkDtnq5JRxmvl3jsoQ==

is-fullwidth-code-point@^3.0.0:
  version "3.0.0"
  resolved "https://registry.yarnpkg.com/is-fullwidth-code-point/-/is-fullwidth-code-point-3.0.0.tgz#f116f8064fe90b3f7844a38997c0b75051269f1d"
  integrity sha512-zymm5+u+sCsSWyD9qNaejV3DFvhCKclKdizYaJUuHA83RLjb7nSuGnddCHGv0hk+KY7BMAlsWeK4Ueg6EV6XQg==

is-generator-fn@^2.0.0:
  version "2.1.0"
  resolved "https://registry.yarnpkg.com/is-generator-fn/-/is-generator-fn-2.1.0.tgz#7d140adc389aaf3011a8f2a2a4cfa6faadffb118"
  integrity sha512-cTIB4yPYL/Grw0EaSzASzg6bBy9gqCofvWN8okThAYIxKJZC+udlRAmGbM0XLeniEJSs8uEgHPGuHSe1XsOLSQ==

is-glob@^4.0.0, is-glob@^4.0.1, is-glob@^4.0.3, is-glob@~4.0.1:
  version "4.0.3"
  resolved "https://registry.yarnpkg.com/is-glob/-/is-glob-4.0.3.tgz#64f61e42cbbb2eec2071a9dac0b28ba1e65d5084"
  integrity sha512-xelSayHH36ZgE7ZWhli7pW34hNbNl8Ojv5KVmkJD4hBdD3th8Tfk9vYasLM+mXWOZhFkgZfxhLSnrwRr4elSSg==
  dependencies:
    is-extglob "^2.1.1"

is-interactive@^1.0.0:
  version "1.0.0"
  resolved "https://registry.yarnpkg.com/is-interactive/-/is-interactive-1.0.0.tgz#cea6e6ae5c870a7b0a0004070b7b587e0252912e"
  integrity sha512-2HvIEKRoqS62guEC+qBjpvRubdX910WCMuJTZ+I9yvqKU2/12eSL549HMwtabb4oupdj2sMP50k+XJfB/8JE6w==

is-map@^2.0.1, is-map@^2.0.2:
  version "2.0.2"
  resolved "https://registry.yarnpkg.com/is-map/-/is-map-2.0.2.tgz#00922db8c9bf73e81b7a335827bc2a43f2b91127"
  integrity sha512-cOZFQQozTha1f4MxLFzlgKYPTyj26picdZTx82hbc/Xf4K/tZOOXSCkMvU4pKioRXGDLJRn0GM7Upe7kR721yg==

is-negative-zero@^2.0.2:
  version "2.0.2"
  resolved "https://registry.yarnpkg.com/is-negative-zero/-/is-negative-zero-2.0.2.tgz#7bf6f03a28003b8b3965de3ac26f664d765f3150"
  integrity sha512-dqJvarLawXsFbNDeJW7zAz8ItJ9cd28YufuuFzh0G8pNHjJMnY08Dv7sYX2uF5UpQOwieAeOExEYAWWfu7ZZUA==

is-number-object@^1.0.4:
  version "1.0.7"
  resolved "https://registry.yarnpkg.com/is-number-object/-/is-number-object-1.0.7.tgz#59d50ada4c45251784e9904f5246c742f07a42fc"
  integrity sha512-k1U0IRzLMo7ZlYIfzRu23Oh6MiIFasgpb9X76eqfFZAqwH44UI4KTBvBYIZ1dSL9ZzChTB9ShHfLkR4pdW5krQ==
  dependencies:
    has-tostringtag "^1.0.0"

is-number@^7.0.0:
  version "7.0.0"
  resolved "https://registry.yarnpkg.com/is-number/-/is-number-7.0.0.tgz#7535345b896734d5f80c4d06c50955527a14f12b"
  integrity sha512-41Cifkg6e8TylSpdtTpeLVMqvSBEVzTttHvERD741+pnZ8ANv0004MRL43QKPDlK9cGvNp6NZWZUBlbGXYxxng==

is-path-inside@^3.0.3:
  version "3.0.3"
  resolved "https://registry.yarnpkg.com/is-path-inside/-/is-path-inside-3.0.3.tgz#d231362e53a07ff2b0e0ea7fed049161ffd16283"
  integrity sha512-Fd4gABb+ycGAmKou8eMftCupSir5lRxqf4aD/vd0cD2qc4HL07OjCeuHMr8Ro4CoMaeCKDB0/ECBOVWjTwUvPQ==

is-potential-custom-element-name@^1.0.1:
  version "1.0.1"
  resolved "https://registry.yarnpkg.com/is-potential-custom-element-name/-/is-potential-custom-element-name-1.0.1.tgz#171ed6f19e3ac554394edf78caa05784a45bebb5"
  integrity sha512-bCYeRA2rVibKZd+s2625gGnGF/t7DSqDs4dP7CrLA1m7jKWz6pps0LpYLJN8Q64HtmPKJ1hrN3nzPNKFEKOUiQ==

is-regex@^1.1.4:
  version "1.1.4"
  resolved "https://registry.yarnpkg.com/is-regex/-/is-regex-1.1.4.tgz#eef5663cd59fa4c0ae339505323df6854bb15958"
  integrity sha512-kvRdxDsxZjhzUX07ZnLydzS1TU/TJlTUHHY4YLL87e37oUA49DfkLqgy+VjFocowy29cKvcSiu+kIv728jTTVg==
  dependencies:
    call-bind "^1.0.2"
    has-tostringtag "^1.0.0"

is-set@^2.0.1, is-set@^2.0.2:
  version "2.0.2"
  resolved "https://registry.yarnpkg.com/is-set/-/is-set-2.0.2.tgz#90755fa4c2562dc1c5d4024760d6119b94ca18ec"
  integrity sha512-+2cnTEZeY5z/iXGbLhPrOAaK/Mau5k5eXq9j14CpRTftq0pAJu2MwVRSZhyZWBzx3o6X795Lz6Bpb6R0GKf37g==

is-shared-array-buffer@^1.0.2:
  version "1.0.2"
  resolved "https://registry.yarnpkg.com/is-shared-array-buffer/-/is-shared-array-buffer-1.0.2.tgz#8f259c573b60b6a32d4058a1a07430c0a7344c79"
  integrity sha512-sqN2UDu1/0y6uvXyStCOzyhAjCSlHceFoMKJW8W9EU9cvic/QdsZ0kEU93HEy3IUEFZIiH/3w+AH/UQbPHNdhA==
  dependencies:
    call-bind "^1.0.2"

is-stream@^2.0.0:
  version "2.0.1"
  resolved "https://registry.yarnpkg.com/is-stream/-/is-stream-2.0.1.tgz#fac1e3d53b97ad5a9d0ae9cef2389f5810a5c077"
  integrity sha512-hFoiJiTl63nn+kstHGBtewWSKnQLpyb155KHheA1l39uvtO9nWIop1p3udqPcUd/xbF1VLMO4n7OI6p7RbngDg==

is-string@^1.0.5, is-string@^1.0.7:
  version "1.0.7"
  resolved "https://registry.yarnpkg.com/is-string/-/is-string-1.0.7.tgz#0dd12bf2006f255bb58f695110eff7491eebc0fd"
  integrity sha512-tE2UXzivje6ofPW7l23cjDOMa09gb7xlAqG6jG5ej6uPV32TlWP3NKPigtaGeHNu9fohccRYvIiZMfOOnOYUtg==
  dependencies:
    has-tostringtag "^1.0.0"

is-symbol@^1.0.2, is-symbol@^1.0.3:
  version "1.0.4"
  resolved "https://registry.yarnpkg.com/is-symbol/-/is-symbol-1.0.4.tgz#a6dac93b635b063ca6872236de88910a57af139c"
  integrity sha512-C/CPBqKWnvdcxqIARxyOh4v1UUEOCHpgDa0WYgpKDFMszcrPcffg5uhwSgPCLD2WWxmq6isisz87tzT01tuGhg==
  dependencies:
    has-symbols "^1.0.2"

is-typed-array@^1.1.10:
  version "1.1.10"
  resolved "https://registry.yarnpkg.com/is-typed-array/-/is-typed-array-1.1.10.tgz#36a5b5cb4189b575d1a3e4b08536bfb485801e3f"
  integrity sha512-PJqgEHiWZvMpaFZ3uTc8kHPM4+4ADTlDniuQL7cU/UDA0Ql7F70yGfHph3cLNe+c9toaigv+DFzTJKhc2CtO6A==
  dependencies:
    available-typed-arrays "^1.0.5"
    call-bind "^1.0.2"
    for-each "^0.3.3"
    gopd "^1.0.1"
    has-tostringtag "^1.0.0"

is-unicode-supported@^0.1.0:
  version "0.1.0"
  resolved "https://registry.yarnpkg.com/is-unicode-supported/-/is-unicode-supported-0.1.0.tgz#3f26c76a809593b52bfa2ecb5710ed2779b522a7"
  integrity sha512-knxG2q4UC3u8stRGyAVJCOdxFmv5DZiRcdlIaAQXAbSfJya+OhopNotLQrstBhququ4ZpuKbDc/8S6mgXgPFPw==

is-weakmap@^2.0.1:
  version "2.0.1"
  resolved "https://registry.yarnpkg.com/is-weakmap/-/is-weakmap-2.0.1.tgz#5008b59bdc43b698201d18f62b37b2ca243e8cf2"
  integrity sha512-NSBR4kH5oVj1Uwvv970ruUkCV7O1mzgVFO4/rev2cLRda9Tm9HrL70ZPut4rOHgY0FNrUu9BCbXA2sdQ+x0chA==

is-weakref@^1.0.2:
  version "1.0.2"
  resolved "https://registry.yarnpkg.com/is-weakref/-/is-weakref-1.0.2.tgz#9529f383a9338205e89765e0392efc2f100f06f2"
  integrity sha512-qctsuLZmIQ0+vSSMfoVvyFe2+GSEvnmZ2ezTup1SBse9+twCCeial6EEi3Nc2KFcf6+qz2FBPnjXsk8xhKSaPQ==
  dependencies:
    call-bind "^1.0.2"

is-weakset@^2.0.1:
  version "2.0.2"
  resolved "https://registry.yarnpkg.com/is-weakset/-/is-weakset-2.0.2.tgz#4569d67a747a1ce5a994dfd4ef6dcea76e7c0a1d"
  integrity sha512-t2yVvttHkQktwnNNmBQ98AhENLdPUTDTE21uPqAQ0ARwQfGeQKRVS0NNurH7bTf7RrvcVn1OOge45CnBeHCSmg==
  dependencies:
    call-bind "^1.0.2"
    get-intrinsic "^1.1.1"

is-wsl@^2.2.0:
  version "2.2.0"
  resolved "https://registry.yarnpkg.com/is-wsl/-/is-wsl-2.2.0.tgz#74a4c76e77ca9fd3f932f290c17ea326cd157271"
  integrity sha512-fKzAra0rGJUUBwGBgNkHZuToZcn+TtXHpeCgmkMJMMYx1sQDYaCSyjJBSCa2nH1DGm7s3n1oBnohoVTBaN7Lww==
  dependencies:
    is-docker "^2.0.0"

isarray@^2.0.5:
  version "2.0.5"
  resolved "https://registry.yarnpkg.com/isarray/-/isarray-2.0.5.tgz#8af1e4c1221244cc62459faf38940d4e644a5723"
  integrity sha512-xHjhDr3cNBK0BzdUJSPXZntQUx/mwMS5Rw4A7lPJ90XGAO6ISP/ePDNuo0vhqOZU+UD5JoodwCAAoZQd3FeAKw==

isarray@~1.0.0:
  version "1.0.0"
  resolved "https://registry.yarnpkg.com/isarray/-/isarray-1.0.0.tgz#bb935d48582cba168c06834957a54a3e07124f11"
  integrity sha512-VLghIWNM6ELQzo7zwmcg0NmTVyWKYjvIeM83yjp0wRDTmUnrM678fQbcKBo6n2CJEF0szoG//ytg+TKla89ALQ==

isexe@^2.0.0:
  version "2.0.0"
  resolved "https://registry.yarnpkg.com/isexe/-/isexe-2.0.0.tgz#e8fbf374dc556ff8947a10dcb0572d633f2cfa10"
  integrity sha512-RHxMLp9lnKHGHRng9QFhRCMbYAcVpn69smSGcq3f36xjgVVWThj4qqLbTLlq7Ssj8B+fIQ1EuCEGI2lKsyQeIw==

istanbul-lib-coverage@^3.0.0, istanbul-lib-coverage@^3.2.0:
  version "3.2.0"
  resolved "https://registry.yarnpkg.com/istanbul-lib-coverage/-/istanbul-lib-coverage-3.2.0.tgz#189e7909d0a39fa5a3dfad5b03f71947770191d3"
  integrity sha512-eOeJ5BHCmHYvQK7xt9GkdHuzuCGS1Y6g9Gvnx3Ym33fz/HpLRYxiS0wHNr+m/MBC8B647Xt608vCDEvhl9c6Mw==

istanbul-lib-instrument@^5.0.4, istanbul-lib-instrument@^5.1.0:
  version "5.2.1"
  resolved "https://registry.yarnpkg.com/istanbul-lib-instrument/-/istanbul-lib-instrument-5.2.1.tgz#d10c8885c2125574e1c231cacadf955675e1ce3d"
  integrity sha512-pzqtp31nLv/XFOzXGuvhCb8qhjmTVo5vjVk19XE4CRlSWz0KoeJ3bw9XsA7nOp9YBf4qHjwBxkDzKcME/J29Yg==
  dependencies:
    "@babel/core" "^7.12.3"
    "@babel/parser" "^7.14.7"
    "@istanbuljs/schema" "^0.1.2"
    istanbul-lib-coverage "^3.2.0"
    semver "^6.3.0"

istanbul-lib-report@^3.0.0:
  version "3.0.0"
  resolved "https://registry.yarnpkg.com/istanbul-lib-report/-/istanbul-lib-report-3.0.0.tgz#7518fe52ea44de372f460a76b5ecda9ffb73d8a6"
  integrity sha512-wcdi+uAKzfiGT2abPpKZ0hSU1rGQjUQnLvtY5MpQ7QCTahD3VODhcu4wcfY1YtkGaDD5yuydOLINXsfbus9ROw==
  dependencies:
    istanbul-lib-coverage "^3.0.0"
    make-dir "^3.0.0"
    supports-color "^7.1.0"

istanbul-lib-source-maps@^4.0.0:
  version "4.0.1"
  resolved "https://registry.yarnpkg.com/istanbul-lib-source-maps/-/istanbul-lib-source-maps-4.0.1.tgz#895f3a709fcfba34c6de5a42939022f3e4358551"
  integrity sha512-n3s8EwkdFIJCG3BPKBYvskgXGoy88ARzvegkitk60NxRdwltLOTaH7CUiMRXvwYorl0Q712iEjcWB+fK/MrWVw==
  dependencies:
    debug "^4.1.1"
    istanbul-lib-coverage "^3.0.0"
    source-map "^0.6.1"

istanbul-reports@^3.1.3:
  version "3.1.5"
  resolved "https://registry.yarnpkg.com/istanbul-reports/-/istanbul-reports-3.1.5.tgz#cc9a6ab25cb25659810e4785ed9d9fb742578bae"
  integrity sha512-nUsEMa9pBt/NOHqbcbeJEgqIlY/K7rVWUX6Lql2orY5e9roQOthbR3vtY4zzf2orPELg80fnxxk9zUyPlgwD1w==
  dependencies:
    html-escaper "^2.0.0"
    istanbul-lib-report "^3.0.0"

iterare@1.2.1:
  version "1.2.1"
  resolved "https://registry.yarnpkg.com/iterare/-/iterare-1.2.1.tgz#139c400ff7363690e33abffa33cbba8920f00042"
  integrity sha512-RKYVTCjAnRthyJes037NX/IiqeidgN1xc3j1RjFfECFp28A1GVwK9nA+i0rJPaHqSZwygLzRnFlzUuHFoWWy+Q==

jackspeak@^2.0.3:
  version "2.2.2"
  resolved "https://registry.yarnpkg.com/jackspeak/-/jackspeak-2.2.2.tgz#707c62733924b8dc2a0a629dc6248577788b5385"
  integrity sha512-mgNtVv4vUuaKA97yxUHoA3+FkuhtxkjdXEWOyB/N76fjy0FjezEt34oy3epBtvCvS+7DyKwqCFWx/oJLV5+kCg==
  dependencies:
    "@isaacs/cliui" "^8.0.2"
  optionalDependencies:
    "@pkgjs/parseargs" "^0.11.0"

jest-changed-files@^29.5.0:
  version "29.5.0"
  resolved "https://registry.yarnpkg.com/jest-changed-files/-/jest-changed-files-29.5.0.tgz#e88786dca8bf2aa899ec4af7644e16d9dcf9b23e"
  integrity sha512-IFG34IUMUaNBIxjQXF/iu7g6EcdMrGRRxaUSw92I/2g2YC6vCdTltl4nHvt7Ci5nSJwXIkCu8Ka1DKF+X7Z1Ag==
  dependencies:
    execa "^5.0.0"
    p-limit "^3.1.0"

jest-circus@^29.6.2:
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/jest-circus/-/jest-circus-29.6.2.tgz#1e6ffca60151ac66cad63fce34f443f6b5bb4258"
  integrity sha512-G9mN+KOYIUe2sB9kpJkO9Bk18J4dTDArNFPwoZ7WKHKel55eKIS/u2bLthxgojwlf9NLCVQfgzM/WsOVvoC6Fw==
  dependencies:
    "@jest/environment" "^29.6.2"
    "@jest/expect" "^29.6.2"
    "@jest/test-result" "^29.6.2"
    "@jest/types" "^29.6.1"
    "@types/node" "*"
    chalk "^4.0.0"
    co "^4.6.0"
    dedent "^1.0.0"
    is-generator-fn "^2.0.0"
    jest-each "^29.6.2"
    jest-matcher-utils "^29.6.2"
    jest-message-util "^29.6.2"
    jest-runtime "^29.6.2"
    jest-snapshot "^29.6.2"
    jest-util "^29.6.2"
    p-limit "^3.1.0"
    pretty-format "^29.6.2"
    pure-rand "^6.0.0"
    slash "^3.0.0"
    stack-utils "^2.0.3"

jest-cli@^29.6.2:
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/jest-cli/-/jest-cli-29.6.2.tgz#edb381763398d1a292cd1b636a98bfa5644b8fda"
  integrity sha512-TT6O247v6dCEX2UGHGyflMpxhnrL0DNqP2fRTKYm3nJJpCTfXX3GCMQPGFjXDoj0i5/Blp3jriKXFgdfmbYB6Q==
  dependencies:
    "@jest/core" "^29.6.2"
    "@jest/test-result" "^29.6.2"
    "@jest/types" "^29.6.1"
    chalk "^4.0.0"
    exit "^0.1.2"
    graceful-fs "^4.2.9"
    import-local "^3.0.2"
    jest-config "^29.6.2"
    jest-util "^29.6.2"
    jest-validate "^29.6.2"
    prompts "^2.0.1"
    yargs "^17.3.1"

jest-config@^29.6.2:
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/jest-config/-/jest-config-29.6.2.tgz#c68723f06b31ca5e63030686e604727d406cd7c3"
  integrity sha512-VxwFOC8gkiJbuodG9CPtMRjBUNZEHxwfQXmIudSTzFWxaci3Qub1ddTRbFNQlD/zUeaifLndh/eDccFX4wCMQw==
  dependencies:
    "@babel/core" "^7.11.6"
    "@jest/test-sequencer" "^29.6.2"
    "@jest/types" "^29.6.1"
    babel-jest "^29.6.2"
    chalk "^4.0.0"
    ci-info "^3.2.0"
    deepmerge "^4.2.2"
    glob "^7.1.3"
    graceful-fs "^4.2.9"
    jest-circus "^29.6.2"
    jest-environment-node "^29.6.2"
    jest-get-type "^29.4.3"
    jest-regex-util "^29.4.3"
    jest-resolve "^29.6.2"
    jest-runner "^29.6.2"
    jest-util "^29.6.2"
    jest-validate "^29.6.2"
    micromatch "^4.0.4"
    parse-json "^5.2.0"
    pretty-format "^29.6.2"
    slash "^3.0.0"
    strip-json-comments "^3.1.1"

jest-diff@^29.3.1:
  version "29.3.1"
  resolved "https://registry.yarnpkg.com/jest-diff/-/jest-diff-29.3.1.tgz#d8215b72fed8f1e647aed2cae6c752a89e757527"
  integrity sha512-vU8vyiO7568tmin2lA3r2DP8oRvzhvRcD4DjpXc6uGveQodyk7CKLhQlCSiwgx3g0pFaE88/KLZ0yaTWMc4Uiw==
  dependencies:
    chalk "^4.0.0"
    diff-sequences "^29.3.1"
    jest-get-type "^29.2.0"
    pretty-format "^29.3.1"

jest-diff@^29.6.2:
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/jest-diff/-/jest-diff-29.6.2.tgz#c36001e5543e82a0805051d3ceac32e6825c1c46"
  integrity sha512-t+ST7CB9GX5F2xKwhwCf0TAR17uNDiaPTZnVymP9lw0lssa9vG+AFyDZoeIHStU3WowFFwT+ky+er0WVl2yGhA==
  dependencies:
    chalk "^4.0.0"
    diff-sequences "^29.4.3"
    jest-get-type "^29.4.3"
    pretty-format "^29.6.2"

jest-docblock@^29.4.3:
  version "29.4.3"
  resolved "https://registry.yarnpkg.com/jest-docblock/-/jest-docblock-29.4.3.tgz#90505aa89514a1c7dceeac1123df79e414636ea8"
  integrity sha512-fzdTftThczeSD9nZ3fzA/4KkHtnmllawWrXO69vtI+L9WjEIuXWs4AmyME7lN5hU7dB0sHhuPfcKofRsUb/2Fg==
  dependencies:
    detect-newline "^3.0.0"

jest-each@^29.6.2:
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/jest-each/-/jest-each-29.6.2.tgz#c9e4b340bcbe838c73adf46b76817b15712d02ce"
  integrity sha512-MsrsqA0Ia99cIpABBc3izS1ZYoYfhIy0NNWqPSE0YXbQjwchyt6B1HD2khzyPe1WiJA7hbxXy77ZoUQxn8UlSw==
  dependencies:
    "@jest/types" "^29.6.1"
    chalk "^4.0.0"
    jest-get-type "^29.4.3"
    jest-util "^29.6.2"
    pretty-format "^29.6.2"

jest-environment-jsdom@^29.6.2:
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/jest-environment-jsdom/-/jest-environment-jsdom-29.6.2.tgz#4fc68836a7774a771819a2f980cb47af3b1629da"
  integrity sha512-7oa/+266AAEgkzae8i1awNEfTfjwawWKLpiw2XesZmaoVVj9u9t8JOYx18cG29rbPNtkUlZ8V4b5Jb36y/VxoQ==
  dependencies:
    "@jest/environment" "^29.6.2"
    "@jest/fake-timers" "^29.6.2"
    "@jest/types" "^29.6.1"
    "@types/jsdom" "^20.0.0"
    "@types/node" "*"
    jest-mock "^29.6.2"
    jest-util "^29.6.2"
    jsdom "^20.0.0"

jest-environment-node@^29.6.2:
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/jest-environment-node/-/jest-environment-node-29.6.2.tgz#a9ea2cabff39b08eca14ccb32c8ceb924c8bb1ad"
  integrity sha512-YGdFeZ3T9a+/612c5mTQIllvWkddPbYcN2v95ZH24oWMbGA4GGS2XdIF92QMhUhvrjjuQWYgUGW2zawOyH63MQ==
  dependencies:
    "@jest/environment" "^29.6.2"
    "@jest/fake-timers" "^29.6.2"
    "@jest/types" "^29.6.1"
    "@types/node" "*"
    jest-mock "^29.6.2"
    jest-util "^29.6.2"

jest-get-type@^29.2.0:
  version "29.2.0"
  resolved "https://registry.yarnpkg.com/jest-get-type/-/jest-get-type-29.2.0.tgz#726646f927ef61d583a3b3adb1ab13f3a5036408"
  integrity sha512-uXNJlg8hKFEnDgFsrCjznB+sTxdkuqiCL6zMgA75qEbAJjJYTs9XPrvDctrEig2GDow22T/LvHgO57iJhXB/UA==

jest-get-type@^29.4.3:
  version "29.4.3"
  resolved "https://registry.yarnpkg.com/jest-get-type/-/jest-get-type-29.4.3.tgz#1ab7a5207c995161100b5187159ca82dd48b3dd5"
  integrity sha512-J5Xez4nRRMjk8emnTpWrlkyb9pfRQQanDrvWHhsR1+VUfbwxi30eVcZFlcdGInRibU4G5LwHXpI7IRHU0CY+gg==

jest-haste-map@^29.6.2:
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/jest-haste-map/-/jest-haste-map-29.6.2.tgz#298c25ea5255cfad8b723179d4295cf3a50a70d1"
  integrity sha512-+51XleTDAAysvU8rT6AnS1ZJ+WHVNqhj1k6nTvN2PYP+HjU3kqlaKQ1Lnw3NYW3bm2r8vq82X0Z1nDDHZMzHVA==
  dependencies:
    "@jest/types" "^29.6.1"
    "@types/graceful-fs" "^4.1.3"
    "@types/node" "*"
    anymatch "^3.0.3"
    fb-watchman "^2.0.0"
    graceful-fs "^4.2.9"
    jest-regex-util "^29.4.3"
    jest-util "^29.6.2"
    jest-worker "^29.6.2"
    micromatch "^4.0.4"
    walker "^1.0.8"
  optionalDependencies:
    fsevents "^2.3.2"

jest-leak-detector@^29.6.2:
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/jest-leak-detector/-/jest-leak-detector-29.6.2.tgz#e2b307fee78cab091c37858a98c7e1d73cdf5b38"
  integrity sha512-aNqYhfp5uYEO3tdWMb2bfWv6f0b4I0LOxVRpnRLAeque2uqOVVMLh6khnTcE2qJ5wAKop0HcreM1btoysD6bPQ==
  dependencies:
    jest-get-type "^29.4.3"
    pretty-format "^29.6.2"

jest-matcher-utils@^29.3.1:
  version "29.3.1"
  resolved "https://registry.yarnpkg.com/jest-matcher-utils/-/jest-matcher-utils-29.3.1.tgz#6e7f53512f80e817dfa148672bd2d5d04914a572"
  integrity sha512-fkRMZUAScup3txIKfMe3AIZZmPEjWEdsPJFK3AIy5qRohWqQFg1qrmKfYXR9qEkNc7OdAu2N4KPHibEmy4HPeQ==
  dependencies:
    chalk "^4.0.0"
    jest-diff "^29.3.1"
    jest-get-type "^29.2.0"
    pretty-format "^29.3.1"

jest-matcher-utils@^29.6.2:
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/jest-matcher-utils/-/jest-matcher-utils-29.6.2.tgz#39de0be2baca7a64eacb27291f0bd834fea3a535"
  integrity sha512-4LiAk3hSSobtomeIAzFTe+N8kL6z0JtF3n6I4fg29iIW7tt99R7ZcIFW34QkX+DuVrf+CUe6wuVOpm7ZKFJzZQ==
  dependencies:
    chalk "^4.0.0"
    jest-diff "^29.6.2"
    jest-get-type "^29.4.3"
    pretty-format "^29.6.2"

jest-message-util@^29.3.1:
  version "29.3.1"
  resolved "https://registry.yarnpkg.com/jest-message-util/-/jest-message-util-29.3.1.tgz#37bc5c468dfe5120712053dd03faf0f053bd6adb"
  integrity sha512-lMJTbgNcDm5z+6KDxWtqOFWlGQxD6XaYwBqHR8kmpkP+WWWG90I35kdtQHY67Ay5CSuydkTBbJG+tH9JShFCyA==
  dependencies:
    "@babel/code-frame" "^7.12.13"
    "@jest/types" "^29.3.1"
    "@types/stack-utils" "^2.0.0"
    chalk "^4.0.0"
    graceful-fs "^4.2.9"
    micromatch "^4.0.4"
    pretty-format "^29.3.1"
    slash "^3.0.0"
    stack-utils "^2.0.3"

jest-message-util@^29.6.2:
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/jest-message-util/-/jest-message-util-29.6.2.tgz#af7adc2209c552f3f5ae31e77cf0a261f23dc2bb"
  integrity sha512-vnIGYEjoPSuRqV8W9t+Wow95SDp6KPX2Uf7EoeG9G99J2OVh7OSwpS4B6J0NfpEIpfkBNHlBZpA2rblEuEFhZQ==
  dependencies:
    "@babel/code-frame" "^7.12.13"
    "@jest/types" "^29.6.1"
    "@types/stack-utils" "^2.0.0"
    chalk "^4.0.0"
    graceful-fs "^4.2.9"
    micromatch "^4.0.4"
    pretty-format "^29.6.2"
    slash "^3.0.0"
    stack-utils "^2.0.3"

jest-mock@^29.6.2:
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/jest-mock/-/jest-mock-29.6.2.tgz#ef9c9b4d38c34a2ad61010a021866dad41ce5e00"
  integrity sha512-hoSv3lb3byzdKfwqCuT6uTscan471GUECqgNYykg6ob0yiAw3zYc7OrPnI9Qv8Wwoa4lC7AZ9hyS4AiIx5U2zg==
  dependencies:
    "@jest/types" "^29.6.1"
    "@types/node" "*"
    jest-util "^29.6.2"

jest-pnp-resolver@^1.2.2:
  version "1.2.3"
  resolved "https://registry.yarnpkg.com/jest-pnp-resolver/-/jest-pnp-resolver-1.2.3.tgz#930b1546164d4ad5937d5540e711d4d38d4cad2e"
  integrity sha512-+3NpwQEnRoIBtx4fyhblQDPgJI0H1IEIkX7ShLUjPGA7TtUTvI1oiKi3SR4oBR0hQhQR80l4WAe5RrXBwWMA8w==

jest-regex-util@^29.4.3:
  version "29.4.3"
  resolved "https://registry.yarnpkg.com/jest-regex-util/-/jest-regex-util-29.4.3.tgz#a42616141e0cae052cfa32c169945d00c0aa0bb8"
  integrity sha512-O4FglZaMmWXbGHSQInfXewIsd1LMn9p3ZXB/6r4FOkyhX2/iP/soMG98jGvk/A3HAN78+5VWcBGO0BJAPRh4kg==

jest-resolve-dependencies@^29.6.2:
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/jest-resolve-dependencies/-/jest-resolve-dependencies-29.6.2.tgz#36435269b6672c256bcc85fb384872c134cc4cf2"
  integrity sha512-LGqjDWxg2fuQQm7ypDxduLu/m4+4Lb4gczc13v51VMZbVP5tSBILqVx8qfWcsdP8f0G7aIqByIALDB0R93yL+w==
  dependencies:
    jest-regex-util "^29.4.3"
    jest-snapshot "^29.6.2"

jest-resolve@^29.6.2:
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/jest-resolve/-/jest-resolve-29.6.2.tgz#f18405fe4b50159b7b6d85e81f6a524d22afb838"
  integrity sha512-G/iQUvZWI5e3SMFssc4ug4dH0aZiZpsDq9o1PtXTV1210Ztyb2+w+ZgQkB3iOiC5SmAEzJBOHWz6Hvrd+QnNPw==
  dependencies:
    chalk "^4.0.0"
    graceful-fs "^4.2.9"
    jest-haste-map "^29.6.2"
    jest-pnp-resolver "^1.2.2"
    jest-util "^29.6.2"
    jest-validate "^29.6.2"
    resolve "^1.20.0"
    resolve.exports "^2.0.0"
    slash "^3.0.0"

jest-runner@^29.6.2:
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/jest-runner/-/jest-runner-29.6.2.tgz#89e8e32a8fef24781a7c4c49cd1cb6358ac7fc01"
  integrity sha512-wXOT/a0EspYgfMiYHxwGLPCZfC0c38MivAlb2lMEAlwHINKemrttu1uSbcGbfDV31sFaPWnWJPmb2qXM8pqZ4w==
  dependencies:
    "@jest/console" "^29.6.2"
    "@jest/environment" "^29.6.2"
    "@jest/test-result" "^29.6.2"
    "@jest/transform" "^29.6.2"
    "@jest/types" "^29.6.1"
    "@types/node" "*"
    chalk "^4.0.0"
    emittery "^0.13.1"
    graceful-fs "^4.2.9"
    jest-docblock "^29.4.3"
    jest-environment-node "^29.6.2"
    jest-haste-map "^29.6.2"
    jest-leak-detector "^29.6.2"
    jest-message-util "^29.6.2"
    jest-resolve "^29.6.2"
    jest-runtime "^29.6.2"
    jest-util "^29.6.2"
    jest-watcher "^29.6.2"
    jest-worker "^29.6.2"
    p-limit "^3.1.0"
    source-map-support "0.5.13"

jest-runtime@^29.6.2:
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/jest-runtime/-/jest-runtime-29.6.2.tgz#692f25e387f982e89ab83270e684a9786248e545"
  integrity sha512-2X9dqK768KufGJyIeLmIzToDmsN0m7Iek8QNxRSI/2+iPFYHF0jTwlO3ftn7gdKd98G/VQw9XJCk77rbTGZnJg==
  dependencies:
    "@jest/environment" "^29.6.2"
    "@jest/fake-timers" "^29.6.2"
    "@jest/globals" "^29.6.2"
    "@jest/source-map" "^29.6.0"
    "@jest/test-result" "^29.6.2"
    "@jest/transform" "^29.6.2"
    "@jest/types" "^29.6.1"
    "@types/node" "*"
    chalk "^4.0.0"
    cjs-module-lexer "^1.0.0"
    collect-v8-coverage "^1.0.0"
    glob "^7.1.3"
    graceful-fs "^4.2.9"
    jest-haste-map "^29.6.2"
    jest-message-util "^29.6.2"
    jest-mock "^29.6.2"
    jest-regex-util "^29.4.3"
    jest-resolve "^29.6.2"
    jest-snapshot "^29.6.2"
    jest-util "^29.6.2"
    slash "^3.0.0"
    strip-bom "^4.0.0"

jest-snapshot@^29.6.2:
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/jest-snapshot/-/jest-snapshot-29.6.2.tgz#9b431b561a83f2bdfe041e1cab8a6becdb01af9c"
  integrity sha512-1OdjqvqmRdGNvWXr/YZHuyhh5DeaLp1p/F8Tht/MrMw4Kr1Uu/j4lRG+iKl1DAqUJDWxtQBMk41Lnf/JETYBRA==
  dependencies:
    "@babel/core" "^7.11.6"
    "@babel/generator" "^7.7.2"
    "@babel/plugin-syntax-jsx" "^7.7.2"
    "@babel/plugin-syntax-typescript" "^7.7.2"
    "@babel/types" "^7.3.3"
    "@jest/expect-utils" "^29.6.2"
    "@jest/transform" "^29.6.2"
    "@jest/types" "^29.6.1"
    babel-preset-current-node-syntax "^1.0.0"
    chalk "^4.0.0"
    expect "^29.6.2"
    graceful-fs "^4.2.9"
    jest-diff "^29.6.2"
    jest-get-type "^29.4.3"
    jest-matcher-utils "^29.6.2"
    jest-message-util "^29.6.2"
    jest-util "^29.6.2"
    natural-compare "^1.4.0"
    pretty-format "^29.6.2"
    semver "^7.5.3"

jest-util@^29.0.0, jest-util@^29.3.1:
  version "29.3.1"
  resolved "https://registry.yarnpkg.com/jest-util/-/jest-util-29.3.1.tgz#1dda51e378bbcb7e3bc9d8ab651445591ed373e1"
  integrity sha512-7YOVZaiX7RJLv76ZfHt4nbNEzzTRiMW/IiOG7ZOKmTXmoGBxUDefgMAxQubu6WPVqP5zSzAdZG0FfLcC7HOIFQ==
  dependencies:
    "@jest/types" "^29.3.1"
    "@types/node" "*"
    chalk "^4.0.0"
    ci-info "^3.2.0"
    graceful-fs "^4.2.9"
    picomatch "^2.2.3"

jest-util@^29.6.2:
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/jest-util/-/jest-util-29.6.2.tgz#8a052df8fff2eebe446769fd88814521a517664d"
  integrity sha512-3eX1qb6L88lJNCFlEADKOkjpXJQyZRiavX1INZ4tRnrBVr2COd3RgcTLyUiEXMNBlDU/cgYq6taUS0fExrWW4w==
  dependencies:
    "@jest/types" "^29.6.1"
    "@types/node" "*"
    chalk "^4.0.0"
    ci-info "^3.2.0"
    graceful-fs "^4.2.9"
    picomatch "^2.2.3"

jest-validate@^29.6.2:
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/jest-validate/-/jest-validate-29.6.2.tgz#25d972af35b2415b83b1373baf1a47bb266c1082"
  integrity sha512-vGz0yMN5fUFRRbpJDPwxMpgSXW1LDKROHfBopAvDcmD6s+B/s8WJrwi+4bfH4SdInBA5C3P3BI19dBtKzx1Arg==
  dependencies:
    "@jest/types" "^29.6.1"
    camelcase "^6.2.0"
    chalk "^4.0.0"
    jest-get-type "^29.4.3"
    leven "^3.1.0"
    pretty-format "^29.6.2"

jest-watcher@^29.6.2:
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/jest-watcher/-/jest-watcher-29.6.2.tgz#77c224674f0620d9f6643c4cfca186d8893ca088"
  integrity sha512-GZitlqkMkhkefjfN/p3SJjrDaxPflqxEAv3/ik10OirZqJGYH5rPiIsgVcfof0Tdqg3shQGdEIxDBx+B4tuLzA==
  dependencies:
    "@jest/test-result" "^29.6.2"
    "@jest/types" "^29.6.1"
    "@types/node" "*"
    ansi-escapes "^4.2.1"
    chalk "^4.0.0"
    emittery "^0.13.1"
    jest-util "^29.6.2"
    string-length "^4.0.1"

jest-worker@^27.4.5:
  version "27.5.1"
  resolved "https://registry.yarnpkg.com/jest-worker/-/jest-worker-27.5.1.tgz#8d146f0900e8973b106b6f73cc1e9a8cb86f8db0"
  integrity sha512-7vuh85V5cdDofPyxn58nrPjBktZo0u9x1g8WtjQol+jZDaE+fhN+cIvTj11GndBnMnyfrUOG1sZQxCdjKh+DKg==
  dependencies:
    "@types/node" "*"
    merge-stream "^2.0.0"
    supports-color "^8.0.0"

jest-worker@^29.6.2:
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/jest-worker/-/jest-worker-29.6.2.tgz#682fbc4b6856ad0aa122a5403c6d048b83f3fb44"
  integrity sha512-l3ccBOabTdkng8I/ORCkADz4eSMKejTYv1vB/Z83UiubqhC1oQ5Li6dWCyqOIvSifGjUBxuvxvlm6KGK2DtuAQ==
  dependencies:
    "@types/node" "*"
    jest-util "^29.6.2"
    merge-stream "^2.0.0"
    supports-color "^8.0.0"

jest@^29.6.2:
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/jest/-/jest-29.6.2.tgz#3bd55b9fd46a161b2edbdf5f1d1bd0d1eab76c42"
  integrity sha512-8eQg2mqFbaP7CwfsTpCxQ+sHzw1WuNWL5UUvjnWP4hx2riGz9fPSzYOaU5q8/GqWn1TfgZIVTqYJygbGbWAANg==
  dependencies:
    "@jest/core" "^29.6.2"
    "@jest/types" "^29.6.1"
    import-local "^3.0.2"
    jest-cli "^29.6.2"

jiti@^1.18.2:
  version "1.19.1"
  resolved "https://registry.yarnpkg.com/jiti/-/jiti-1.19.1.tgz#fa99e4b76a23053e0e7cde098efe1704a14c16f1"
  integrity sha512-oVhqoRDaBXf7sjkll95LHVS6Myyyb1zaunVwk4Z0+WPSW4gjS0pl01zYKHScTuyEhQsFxV5L4DR5r+YqSyqyyg==

joi@^17.9.2:
  version "17.9.2"
  resolved "https://registry.yarnpkg.com/joi/-/joi-17.9.2.tgz#8b2e4724188369f55451aebd1d0b1d9482470690"
  integrity sha512-Itk/r+V4Dx0V3c7RLFdRh12IOjySm2/WGPMubBT92cQvRfYZhPM2W0hZlctjj72iES8jsRCwp7S/cRmWBnJ4nw==
  dependencies:
    "@hapi/hoek" "^9.0.0"
    "@hapi/topo" "^5.0.0"
    "@sideway/address" "^4.1.3"
    "@sideway/formula" "^3.0.1"
    "@sideway/pinpoint" "^2.0.0"

"js-tokens@^3.0.0 || ^4.0.0", js-tokens@^4.0.0:
  version "4.0.0"
  resolved "https://registry.yarnpkg.com/js-tokens/-/js-tokens-4.0.0.tgz#19203fb59991df98e3a287050d4647cdeaf32499"
  integrity sha512-RdJUflcE3cUzKiMqQgsCu06FPu9UdIJO0beYbPhHN4k6apgJtifcoCtT9bcxOpYBtpD2kCM6Sbzg4CausW/PKQ==

js-yaml@4.1.0, js-yaml@^4.1.0:
  version "4.1.0"
  resolved "https://registry.yarnpkg.com/js-yaml/-/js-yaml-4.1.0.tgz#c1fb65f8f5017901cdd2c951864ba18458a10602"
  integrity sha512-wpxZs9NoxZaJESJGIZTyDEaYpl0FKSA+FB9aJiyemKhMwkxQg63h4T1KJgUGHpTqPDNRcmmYLugrRjJlBtWvRA==
  dependencies:
    argparse "^2.0.1"

js-yaml@^3.13.1:
  version "3.14.1"
  resolved "https://registry.yarnpkg.com/js-yaml/-/js-yaml-3.14.1.tgz#dae812fdb3825fa306609a8717383c50c36a0537"
  integrity sha512-okMH7OXXJ7YrN9Ok3/SXrnu4iX9yOk+25nqX4imS2npuvTYDmo/QEZoqwZkYaIDk3jVvBOTOIEgEhaLOynBS9g==
  dependencies:
    argparse "^1.0.7"
    esprima "^4.0.0"

jsdom@^20.0.0:
  version "20.0.3"
  resolved "https://registry.yarnpkg.com/jsdom/-/jsdom-20.0.3.tgz#886a41ba1d4726f67a8858028c99489fed6ad4db"
  integrity sha512-SYhBvTh89tTfCD/CRdSOm13mOBa42iTaTyfyEWBdKcGdPxPtLFBXuHR8XHb33YNYaP+lLbmSvBTsnoesCNJEsQ==
  dependencies:
    abab "^2.0.6"
    acorn "^8.8.1"
    acorn-globals "^7.0.0"
    cssom "^0.5.0"
    cssstyle "^2.3.0"
    data-urls "^3.0.2"
    decimal.js "^10.4.2"
    domexception "^4.0.0"
    escodegen "^2.0.0"
    form-data "^4.0.0"
    html-encoding-sniffer "^3.0.0"
    http-proxy-agent "^5.0.0"
    https-proxy-agent "^5.0.1"
    is-potential-custom-element-name "^1.0.1"
    nwsapi "^2.2.2"
    parse5 "^7.1.1"
    saxes "^6.0.0"
    symbol-tree "^3.2.4"
    tough-cookie "^4.1.2"
    w3c-xmlserializer "^4.0.0"
    webidl-conversions "^7.0.0"
    whatwg-encoding "^2.0.0"
    whatwg-mimetype "^3.0.0"
    whatwg-url "^11.0.0"
    ws "^8.11.0"
    xml-name-validator "^4.0.0"

jsesc@^2.5.1:
  version "2.5.2"
  resolved "https://registry.yarnpkg.com/jsesc/-/jsesc-2.5.2.tgz#80564d2e483dacf6e8ef209650a67df3f0c283a4"
  integrity sha512-OYu7XEzjkCQ3C5Ps3QIZsQfNpqoJyZZA99wd9aWd05NCtC5pWOkShK2mkL6HXQR6/Cy2lbNdPlZBpuQHXE63gA==

json-parse-even-better-errors@^2.3.0, json-parse-even-better-errors@^2.3.1:
  version "2.3.1"
  resolved "https://registry.yarnpkg.com/json-parse-even-better-errors/-/json-parse-even-better-errors-2.3.1.tgz#7c47805a94319928e05777405dc12e1f7a4ee02d"
  integrity sha512-xyFwyhro/JEof6Ghe2iz2NcXoj2sloNsWr/XsERDK/oiPCfaNhl5ONfp+jQdAZRQQ0IJWNzH9zIZF7li91kh2w==

json-schema-traverse@^0.4.1:
  version "0.4.1"
  resolved "https://registry.yarnpkg.com/json-schema-traverse/-/json-schema-traverse-0.4.1.tgz#69f6a87d9513ab8bb8fe63bdb0979c448e684660"
  integrity sha512-xbbCH5dCYU5T8LcEhhuh7HJ88HXuW3qsI3Y0zOZFKfZEHcpWiHU/Jxzk629Brsab/mMiHQti9wMP+845RPe3Vg==

json-schema-traverse@^1.0.0:
  version "1.0.0"
  resolved "https://registry.yarnpkg.com/json-schema-traverse/-/json-schema-traverse-1.0.0.tgz#ae7bcb3656ab77a73ba5c49bf654f38e6b6860e2"
  integrity sha512-NM8/P9n3XjXhIZn1lLhkFaACTOURQXjWhV4BA/RnOv8xvgqtqpAX9IO4mRQxSx1Rlo4tqzeqb0sOlruaOy3dug==

json-stable-stringify-without-jsonify@^1.0.1:
  version "1.0.1"
  resolved "https://registry.yarnpkg.com/json-stable-stringify-without-jsonify/-/json-stable-stringify-without-jsonify-1.0.1.tgz#9db7b59496ad3f3cfef30a75142d2d930ad72651"
  integrity sha512-Bdboy+l7tA3OGW6FjyFHWkP5LuByj1Tk33Ljyq0axyzdk9//JSi2u3fP1QSmd1KNwq6VOKYGlAu87CisVir6Pw==

json5@^1.0.1:
  version "1.0.1"
  resolved "https://registry.yarnpkg.com/json5/-/json5-1.0.1.tgz#779fb0018604fa854eacbf6252180d83543e3dbe"
  integrity sha512-aKS4WQjPenRxiQsC93MNfjx+nbF4PAdYzmd/1JIj8HYzqfbu86beTuNgXDzPknWk0n0uARlyewZo4s++ES36Ow==
  dependencies:
    minimist "^1.2.0"

json5@^2.2.1:
  version "2.2.1"
  resolved "https://registry.yarnpkg.com/json5/-/json5-2.2.1.tgz#655d50ed1e6f95ad1a3caababd2b0efda10b395c"
  integrity sha512-1hqLFMSrGHRHxav9q9gNjJ5EXznIxGVO09xQRrwplcS8qs28pZ8s8hupZAmqDwZUmVZ2Qb2jnyPOWcDH8m8dlA==

json5@^2.2.2, json5@^2.2.3:
  version "2.2.3"
  resolved "https://registry.yarnpkg.com/json5/-/json5-2.2.3.tgz#78cd6f1a19bdc12b73db5ad0c61efd66c1e29283"
  integrity sha512-XmOWe7eyHYH14cLdVPoyg+GOH3rYX++KpzrylJwSW98t3Nk+U8XOl8FWKOgwtzdb8lXGf6zYwDUzeHMWfxasyg==

jsonc-parser@3.2.0:
  version "3.2.0"
  resolved "https://registry.yarnpkg.com/jsonc-parser/-/jsonc-parser-3.2.0.tgz#31ff3f4c2b9793f89c67212627c51c6394f88e76"
  integrity sha512-gfFQZrcTc8CnKXp6Y4/CBT3fTc0OVuDofpre4aEeEpSBPV5X5v4+Vmx+8snU7RLPrNHPKSgLxGo9YuQzz20o+w==

jsonfile@^6.0.1:
  version "6.1.0"
  resolved "https://registry.yarnpkg.com/jsonfile/-/jsonfile-6.1.0.tgz#bc55b2634793c679ec6403094eb13698a6ec0aae"
  integrity sha512-5dgndWOriYSm5cnYaJNhalLNDKOqFwyDB/rr1E9ZsGciGvKPs8R2xYGCacuf3z6K1YKDz182fd+fY3cn3pMqXQ==
  dependencies:
    universalify "^2.0.0"
  optionalDependencies:
    graceful-fs "^4.1.6"

"jsx-ast-utils@^2.4.1 || ^3.0.0", jsx-ast-utils@^3.3.2:
  version "3.3.3"
  resolved "https://registry.yarnpkg.com/jsx-ast-utils/-/jsx-ast-utils-3.3.3.tgz#76b3e6e6cece5c69d49a5792c3d01bd1a0cdc7ea"
  integrity sha512-fYQHZTZ8jSfmWZ0iyzfwiU4WDX4HpHbMCZ3gPlWYiCl3BoeOTsqKBqnTVfH2rYT7eP5c3sVbeSPHnnJOaTrWiw==
  dependencies:
    array-includes "^3.1.5"
    object.assign "^4.1.3"

kleur@^3.0.3:
  version "3.0.3"
  resolved "https://registry.yarnpkg.com/kleur/-/kleur-3.0.3.tgz#a79c9ecc86ee1ce3fa6206d1216c501f147fc07e"
  integrity sha512-eTIzlVOSUR+JxdDFepEYcBMtZ9Qqdef+rnzWdRZuMbOywu5tO2w2N7rqjoANZ5k9vywhL6Br1VRjUIgTQx4E8w==

language-subtag-registry@^0.3.20:
  version "0.3.22"
  resolved "https://registry.yarnpkg.com/language-subtag-registry/-/language-subtag-registry-0.3.22.tgz#2e1500861b2e457eba7e7ae86877cbd08fa1fd1d"
  integrity sha512-tN0MCzyWnoz/4nHS6uxdlFWoUZT7ABptwKPQ52Ea7URk6vll88bWBVhodtnlfEuCcKWNGoc+uGbw1cwa9IKh/w==

language-tags@^1.0.5:
  version "1.0.6"
  resolved "https://registry.yarnpkg.com/language-tags/-/language-tags-1.0.6.tgz#c087cc42cd92eb71f0925e9e271d4f8be5a93430"
  integrity sha512-HNkaCgM8wZgE/BZACeotAAgpL9FUjEnhgF0FVQMIgH//zqTPreLYMb3rWYkYAqPoF75Jwuycp1da7uz66cfFQg==
  dependencies:
    language-subtag-registry "^0.3.20"

leven@^3.1.0:
  version "3.1.0"
  resolved "https://registry.yarnpkg.com/leven/-/leven-3.1.0.tgz#77891de834064cccba82ae7842bb6b14a13ed7f2"
  integrity sha512-qsda+H8jTaUaN/x5vzW2rzc+8Rw4TAQ/4KjB46IwK5VH+IlVeeeje/EoZRpiXvIqjFgK84QffqPztGI3VBLG1A==

levn@^0.4.1:
  version "0.4.1"
  resolved "https://registry.yarnpkg.com/levn/-/levn-0.4.1.tgz#ae4562c007473b932a6200d403268dd2fffc6ade"
  integrity sha512-+bT2uH4E5LGE7h/n3evcS/sQlJXCpIp6ym8OWJ5eV6+67Dsql/LaaT7qJBAt2rzfoa/5QBGBhxDix1dMt2kQKQ==
  dependencies:
    prelude-ls "^1.2.1"
    type-check "~0.4.0"

levn@~0.3.0:
  version "0.3.0"
  resolved "https://registry.yarnpkg.com/levn/-/levn-0.3.0.tgz#3b09924edf9f083c0490fdd4c0bc4421e04764ee"
  integrity sha512-0OO4y2iOHix2W6ujICbKIaEQXvFQHue65vUG3pb5EUomzPI90z9hsA1VsO/dbIIpC53J8gxM9Q4Oho0jrCM/yA==
  dependencies:
    prelude-ls "~1.1.2"
    type-check "~0.3.2"

lilconfig@^2.0.5:
  version "2.0.6"
  resolved "https://registry.yarnpkg.com/lilconfig/-/lilconfig-2.0.6.tgz#32a384558bd58af3d4c6e077dd1ad1d397bc69d4"
  integrity sha512-9JROoBW7pobfsx+Sq2JsASvCo6Pfo6WWoUW79HuB1BCoBXD4PLWJPqDF6fNj67pqBYTbAHkE57M1kS/+L1neOg==

lilconfig@^2.1.0:
  version "2.1.0"
  resolved "https://registry.yarnpkg.com/lilconfig/-/lilconfig-2.1.0.tgz#78e23ac89ebb7e1bfbf25b18043de756548e7f52"
  integrity sha512-utWOt/GHzuUxnLKxB6dk81RoOeoNeHgbrXiuGk4yyF5qlRz+iIVWu56E2fqGHFrXz0QNUhLB/8nKqvRH66JKGQ==

lines-and-columns@^1.1.6:
  version "1.2.4"
  resolved "https://registry.yarnpkg.com/lines-and-columns/-/lines-and-columns-1.2.4.tgz#eca284f75d2965079309dc0ad9255abb2ebc1632"
  integrity sha512-7ylylesZQ/PV29jhEDl3Ufjo6ZX7gCqJr5F7PKrqc93v7fzSymt1BpwEU8nAUXs8qzzvqhbjhK5QZg6Mt/HkBg==

loader-runner@^4.2.0:
  version "4.3.0"
  resolved "https://registry.yarnpkg.com/loader-runner/-/loader-runner-4.3.0.tgz#c1b4a163b99f614830353b16755e7149ac2314e1"
  integrity sha512-3R/1M+yS3j5ou80Me59j7F9IMs4PXs3VqRrm0TU3AbKPxlmpoY1TNscJV/oGJXo8qCatFGTfDbY6W6ipGOYXfg==

locate-path@^5.0.0:
  version "5.0.0"
  resolved "https://registry.yarnpkg.com/locate-path/-/locate-path-5.0.0.tgz#1afba396afd676a6d42504d0a67a3a7eb9f62aa0"
  integrity sha512-t7hw9pI+WvuwNJXwk5zVHpyhIqzg2qTlklJOf0mVxGSbe3Fp2VieZcduNYjaLDoy6p9uGpQEGWG87WpMKlNq8g==
  dependencies:
    p-locate "^4.1.0"

locate-path@^6.0.0:
  version "6.0.0"
  resolved "https://registry.yarnpkg.com/locate-path/-/locate-path-6.0.0.tgz#55321eb309febbc59c4801d931a72452a681d286"
  integrity sha512-iPZK6eYjbxRu3uB4/WZ3EsEIMJFMqAoopl3R+zuq0UjcAm/MO6KCweDgPfP3elTztoKP3KtnVHxTn2NHBSDVUw==
  dependencies:
    p-locate "^5.0.0"

lodash.memoize@4.x:
  version "4.1.2"
  resolved "https://registry.yarnpkg.com/lodash.memoize/-/lodash.memoize-4.1.2.tgz#bcc6c49a42a2840ed997f323eada5ecd182e0bfe"
  integrity sha512-t7j+NzmgnQzTAYXcsHYLgimltOV1MXHtlOWf6GjL9Kj8GK5FInw5JotxvbOs+IvV1/Dzo04/fCGfLVs7aXb4Ag==

lodash.merge@^4.6.2:
  version "4.6.2"
  resolved "https://registry.yarnpkg.com/lodash.merge/-/lodash.merge-4.6.2.tgz#558aa53b43b661e1925a0afdfa36a9a1085fe57a"
  integrity sha512-0KpjqXRVvrYyCsX1swR/XTK0va6VQkQM6MNo7PqW77ByjAhoARA8EfrP1N4+KlKj8YS0ZUCtRT/YUuhyYDujIQ==

lodash@4.17.21, lodash@^4.17.15, lodash@^4.17.21:
  version "4.17.21"
  resolved "https://registry.yarnpkg.com/lodash/-/lodash-4.17.21.tgz#679591c564c3bffaae8454cf0b3df370c3d6911c"
  integrity sha512-v2kDEe57lecTulaDIuNTPy3Ry4gLGJ6Z1O3vE1krgXZNrsQ+LFTGHVxVjcXPs17LhbZVGedAJv8XZ1tvj5FvSg==

log-symbols@^4.1.0:
  version "4.1.0"
  resolved "https://registry.yarnpkg.com/log-symbols/-/log-symbols-4.1.0.tgz#3fbdbb95b4683ac9fc785111e792e558d4abd503"
  integrity sha512-8XPvpAA8uyhfteu8pIvQxpJZ7SYYdpUivZpGy6sFsBuKRY/7rQGavedeB8aK+Zkyq6upMFVL/9AW6vOYzfRyLg==
  dependencies:
    chalk "^4.1.0"
    is-unicode-supported "^0.1.0"

loose-envify@^1.1.0, loose-envify@^1.4.0:
  version "1.4.0"
  resolved "https://registry.yarnpkg.com/loose-envify/-/loose-envify-1.4.0.tgz#71ee51fa7be4caec1a63839f7e682d8132d30caf"
  integrity sha512-lyuxPGr/Wfhrlem2CL/UcnUc1zcqKAImBDzukY7Y5F/yQiNdko6+fRLevlw1HgMySw7f611UIY408EtxRSoK3Q==
  dependencies:
    js-tokens "^3.0.0 || ^4.0.0"

lru-cache@^6.0.0:
  version "6.0.0"
  resolved "https://registry.yarnpkg.com/lru-cache/-/lru-cache-6.0.0.tgz#6d6fe6570ebd96aaf90fcad1dafa3b2566db3a94"
  integrity sha512-Jo6dJ04CmSjuznwJSS3pUeWmd/H0ffTlkXXgwZi+eq1UCmqQwCh+eLsYOYCwY991i2Fah4h1BEMCx4qThGbsiA==
  dependencies:
    yallist "^4.0.0"

"lru-cache@^9.1.1 || ^10.0.0":
  version "10.0.0"
  resolved "https://registry.yarnpkg.com/lru-cache/-/lru-cache-10.0.0.tgz#b9e2a6a72a129d81ab317202d93c7691df727e61"
  integrity sha512-svTf/fzsKHffP42sujkO/Rjs37BCIsQVRCeNYIm9WN8rgT7ffoUnRtZCqU+6BqcSBdv8gwJeTz8knJpgACeQMw==

lz-string@^1.5.0:
  version "1.5.0"
  resolved "https://registry.yarnpkg.com/lz-string/-/lz-string-1.5.0.tgz#c1ab50f77887b712621201ba9fd4e3a6ed099941"
  integrity sha512-h5bgJWpxJNswbU7qCrV0tIKQCaS3blPDrqKWx+QxzuzL1zGUzij9XCWLrSLsJPu5t+eWA/ycetzYAO5IOMcWAQ==

macos-release@^2.5.0:
  version "2.5.0"
  resolved "https://registry.yarnpkg.com/macos-release/-/macos-release-2.5.0.tgz#067c2c88b5f3fb3c56a375b2ec93826220fa1ff2"
  integrity sha512-EIgv+QZ9r+814gjJj0Bt5vSLJLzswGmSUbUpbi9AIr/fsN2IWFBl2NucV9PAiek+U1STK468tEkxmVYUtuAN3g==

magic-string@0.30.0:
  version "0.30.0"
  resolved "https://registry.yarnpkg.com/magic-string/-/magic-string-0.30.0.tgz#fd58a4748c5c4547338a424e90fa5dd17f4de529"
  integrity sha512-LA+31JYDJLs82r2ScLrlz1GjSgu66ZV518eyWT+S8VhyQn/JL0u9MeBOvQMGYiPk1DBiSN9DDMOcXvigJZaViQ==
  dependencies:
    "@jridgewell/sourcemap-codec" "^1.4.13"

make-dir@^3.0.0:
  version "3.1.0"
  resolved "https://registry.yarnpkg.com/make-dir/-/make-dir-3.1.0.tgz#415e967046b3a7f1d185277d84aa58203726a13f"
  integrity sha512-g3FeP20LNwhALb/6Cz6Dd4F2ngze0jz7tbzrD2wAV+o9FeNHe4rL+yK2md0J/fiSf1sa1ADhXqi5+oVwOM/eGw==
  dependencies:
    semver "^6.0.0"

make-error@1.x, make-error@^1.1.1:
  version "1.3.6"
  resolved "https://registry.yarnpkg.com/make-error/-/make-error-1.3.6.tgz#2eb2e37ea9b67c4891f684a1394799af484cf7a2"
  integrity sha512-s8UhlNe7vPKomQhC1qFelMokr/Sc3AgNbso3n74mVPA5LTZwkB9NlXf4XPamLxJE8h0gh73rM94xvwRT2CVInw==

makeerror@1.0.12:
  version "1.0.12"
  resolved "https://registry.yarnpkg.com/makeerror/-/makeerror-1.0.12.tgz#3e5dd2079a82e812e983cc6610c4a2cb0eaa801a"
  integrity sha512-JmqCvUhmt43madlpFzG4BQzG2Z3m6tvQDNKdClZnO3VbIudJYmxsT0FNJMeiB2+JTSlTQTSbU8QdesVmwJcmLg==
  dependencies:
    tmpl "1.0.5"

media-typer@0.3.0:
  version "0.3.0"
  resolved "https://registry.yarnpkg.com/media-typer/-/media-typer-0.3.0.tgz#8710d7af0aa626f8fffa1ce00168545263255748"
  integrity sha512-dq+qelQ9akHpcOl/gUVRTxVIOkAJ1wR3QAvb4RsVjS8oVoFjDGTc679wJYmUmknUF5HwMLOgb5O+a3KxfWapPQ==

memfs@^3.4.1:
  version "3.4.12"
  resolved "https://registry.yarnpkg.com/memfs/-/memfs-3.4.12.tgz#d00f8ad8dab132dc277c659dc85bfd14b07d03bd"
  integrity sha512-BcjuQn6vfqP+k100e0E9m61Hyqa//Brp+I3f0OBmN0ATHlFA8vx3Lt8z57R3u2bPqe3WGDBC+nF72fTH7isyEw==
  dependencies:
    fs-monkey "^1.0.3"

merge-descriptors@1.0.1:
  version "1.0.1"
  resolved "https://registry.yarnpkg.com/merge-descriptors/-/merge-descriptors-1.0.1.tgz#b00aaa556dd8b44568150ec9d1b953f3f90cbb61"
  integrity sha512-cCi6g3/Zr1iqQi6ySbseM1Xvooa98N0w31jzUYrXPX2xqObmFGHJ0tQ5u74H3mVh7wLouTseZyYIq39g8cNp1w==

merge-stream@^2.0.0:
  version "2.0.0"
  resolved "https://registry.yarnpkg.com/merge-stream/-/merge-stream-2.0.0.tgz#52823629a14dd00c9770fb6ad47dc6310f2c1f60"
  integrity sha512-abv/qOcuPfk3URPfDzmZU1LKmuw8kT+0nIHvKrKgFrwifol/doWcdA4ZqsWQ8ENrFKkd67Mfpo/LovbIUsbt3w==

merge2@^1.3.0, merge2@^1.4.1:
  version "1.4.1"
  resolved "https://registry.yarnpkg.com/merge2/-/merge2-1.4.1.tgz#4368892f885e907455a6fd7dc55c0c9d404990ae"
  integrity sha512-8q7VEgMJW4J8tcfVPy8g09NcQwZdbwFEqhe/WZkoIzjn/3TGDwtOCYtXGxA3O8tPzpczCCDgv+P2P5y00ZJOOg==

methods@^1.1.2, methods@~1.1.2:
  version "1.1.2"
  resolved "https://registry.yarnpkg.com/methods/-/methods-1.1.2.tgz#5529a4d67654134edcc5266656835b0f851afcee"
  integrity sha512-iclAHeNqNm68zFtnZ0e+1L2yUIdvzNoauKU4WBA3VvH/vPFieF7qfRlwUZU+DA9P9bPXIS90ulxoUoCH23sV2w==

micromatch@^4.0.0, micromatch@^4.0.4, micromatch@^4.0.5:
  version "4.0.5"
  resolved "https://registry.yarnpkg.com/micromatch/-/micromatch-4.0.5.tgz#bc8999a7cbbf77cdc89f132f6e467051b49090c6"
  integrity sha512-DMy+ERcEW2q8Z2Po+WNXuw3c5YaUSFjAO5GsJqfEl7UjvtIuFKO6ZrKvcItdy98dwFI2N1tg3zNIdKaQT+aNdA==
  dependencies:
    braces "^3.0.2"
    picomatch "^2.3.1"

mime-db@1.52.0:
  version "1.52.0"
  resolved "https://registry.yarnpkg.com/mime-db/-/mime-db-1.52.0.tgz#bbabcdc02859f4987301c856e3387ce5ec43bf70"
  integrity sha512-sPU4uV7dYlvtWJxwwxHD0PuihVNiE7TyAbQ5SWxDCB9mUYvOgroQOwYQQOKPJ8CIbE+1ETVlOoK1UC2nU3gYvg==

mime-types@^2.1.12, mime-types@^2.1.27, mime-types@~2.1.24, mime-types@~2.1.34:
  version "2.1.35"
  resolved "https://registry.yarnpkg.com/mime-types/-/mime-types-2.1.35.tgz#381a871b62a734450660ae3deee44813f70d959a"
  integrity sha512-ZDY+bPm5zTTF+YpCrAU9nK0UgICYPT0QtT1NZWFv4s++TNkcgVaT0g6+4R2uI4MjQjzysHB1zxuWL50hzaeXiw==
  dependencies:
    mime-db "1.52.0"

mime@1.6.0:
  version "1.6.0"
  resolved "https://registry.yarnpkg.com/mime/-/mime-1.6.0.tgz#32cd9e5c64553bd58d19a568af452acff04981b1"
  integrity sha512-x0Vn8spI+wuJ1O6S7gnbaQg8Pxh4NNHb7KSINmEWKiPE4RKOplvijn+NkmYmmRgP68mc70j2EbeTFRsrswaQeg==

mime@2.6.0:
  version "2.6.0"
  resolved "https://registry.yarnpkg.com/mime/-/mime-2.6.0.tgz#a2a682a95cd4d0cb1d6257e28f83da7e35800367"
  integrity sha512-USPkMeET31rOMiarsBNIHZKLGgvKc/LrjofAnBlOttf5ajRvqiRA8QsenbcooctK6d6Ts6aqZXBA+XbkKthiQg==

mimic-fn@^2.1.0:
  version "2.1.0"
  resolved "https://registry.yarnpkg.com/mimic-fn/-/mimic-fn-2.1.0.tgz#7ed2c2ccccaf84d3ffcb7a69b57711fc2083401b"
  integrity sha512-OqbOk5oEQeAZ8WXWydlu9HJjz9WVdEIvamMCcXmuqUYjTknH/sqsWvhQ3vgwKFRR1HpjvNBKQ37nbJgYzGqGcg==

min-indent@^1.0.0:
  version "1.0.1"
  resolved "https://registry.yarnpkg.com/min-indent/-/min-indent-1.0.1.tgz#a63f681673b30571fbe8bc25686ae746eefa9869"
  integrity sha512-I9jwMn07Sy/IwOj3zVkVik2JTvgpaykDZEigL6Rx6N9LbMywwUSMtxET+7lVoDLLd3O3IXwJwvuuns8UB/HeAg==

minimatch@^3.0.4, minimatch@^3.0.5, minimatch@^3.1.1, minimatch@^3.1.2:
  version "3.1.2"
  resolved "https://registry.yarnpkg.com/minimatch/-/minimatch-3.1.2.tgz#19cd194bfd3e428f049a70817c038d89ab4be35b"
  integrity sha512-J7p63hRiAjw1NDEww1W7i37+ByIrOWO5XQQAzZ3VOcL0PNybwpfmV/N05zFAzwQ9USyEcX6t3UO+K5aqBQOIHw==
  dependencies:
    brace-expansion "^1.1.7"

minimatch@^8.0.2:
  version "8.0.4"
  resolved "https://registry.yarnpkg.com/minimatch/-/minimatch-8.0.4.tgz#847c1b25c014d4e9a7f68aaf63dedd668a626229"
  integrity sha512-W0Wvr9HyFXZRGIDgCicunpQ299OKXs9RgZfaukz4qAW/pJhcpUfupc9c+OObPOFueNy8VSrZgEmDtk6Kh4WzDA==
  dependencies:
    brace-expansion "^2.0.1"

minimatch@^9.0.1:
  version "9.0.3"
  resolved "https://registry.yarnpkg.com/minimatch/-/minimatch-9.0.3.tgz#a6e00c3de44c3a542bfaae70abfc22420a6da825"
  integrity sha512-RHiac9mvaRw0x3AYRgDC1CxAP7HTcNrrECeA8YYJeWnpo+2Q5CegtZjaotWTWxDG3UeGA1coE05iH1mPjT/2mg==
  dependencies:
    brace-expansion "^2.0.1"

minimist@^1.2.0, minimist@^1.2.6:
  version "1.2.7"
  resolved "https://registry.yarnpkg.com/minimist/-/minimist-1.2.7.tgz#daa1c4d91f507390437c6a8bc01078e7000c4d18"
  integrity sha512-bzfL1YUZsP41gmu/qjrEk0Q6i2ix/cVeAhbCbqH9u3zYutS1cLg00qhrD0M2MVdCcx4Sc0UpP2eBWo9rotpq6g==

minipass@^4.2.4:
  version "4.2.8"
  resolved "https://registry.yarnpkg.com/minipass/-/minipass-4.2.8.tgz#f0010f64393ecfc1d1ccb5f582bcaf45f48e1a3a"
  integrity sha512-fNzuVyifolSLFL4NzpF+wEF4qrgqaaKX0haXPQEdQ7NKAN+WecoKMHV09YcuL/DHxrUsYQOK3MiuDf7Ip2OXfQ==

"minipass@^5.0.0 || ^6.0.2 || ^7.0.0":
  version "7.0.2"
  resolved "https://registry.yarnpkg.com/minipass/-/minipass-7.0.2.tgz#58a82b7d81c7010da5bd4b2c0c85ac4b4ec5131e"
  integrity sha512-eL79dXrE1q9dBbDCLg7xfn/vl7MS4F1gvJAgjJrQli/jbQWdUttuVawphqpffoIYfRdq78LHx6GP4bU/EQ2ATA==

mkdirp@^0.5.4:
  version "0.5.6"
  resolved "https://registry.yarnpkg.com/mkdirp/-/mkdirp-0.5.6.tgz#7def03d2432dcae4ba1d611445c48396062255f6"
  integrity sha512-FP+p8RB8OWpF3YZBCrP5gtADmtXApB5AMLn+vdyA+PyxCjrCs00mjyUozssO33cwDeT3wNGdLxJ5M//YqtHAJw==
  dependencies:
    minimist "^1.2.6"

ms@2.0.0:
  version "2.0.0"
  resolved "https://registry.yarnpkg.com/ms/-/ms-2.0.0.tgz#5608aeadfc00be6c2901df5f9861788de0d597c8"
  integrity sha512-Tpp60P6IUJDTuOq/5Z8cdskzJujfwqfOTkrwIwj7IRISpnkJnT6SyJ4PCPnGMoFjC9ddhal5KVIYtAt97ix05A==

ms@2.1.2:
  version "2.1.2"
  resolved "https://registry.yarnpkg.com/ms/-/ms-2.1.2.tgz#d09d1f357b443f493382a8eb3ccd183872ae6009"
  integrity sha512-sGkPx+VjMtmA6MX27oA4FBFELFCZZ4S4XqeGOXCv68tT+jb3vk/RyaKWP0PTKyWtmLSM0b+adUTEvbs1PEaH2w==

ms@2.1.3, ms@^2.1.1:
  version "2.1.3"
  resolved "https://registry.yarnpkg.com/ms/-/ms-2.1.3.tgz#574c8138ce1d2b5861f0b44579dbadd60c6615b2"
  integrity sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA==

multer@1.4.4-lts.1:
  version "1.4.4-lts.1"
  resolved "https://registry.yarnpkg.com/multer/-/multer-1.4.4-lts.1.tgz#24100f701a4611211cfae94ae16ea39bb314e04d"
  integrity sha512-WeSGziVj6+Z2/MwQo3GvqzgR+9Uc+qt8SwHKh3gvNPiISKfsMfG4SvCOFYlxxgkXt7yIV2i1yczehm0EOKIxIg==
  dependencies:
    append-field "^1.0.0"
    busboy "^1.0.0"
    concat-stream "^1.5.2"
    mkdirp "^0.5.4"
    object-assign "^4.1.1"
    type-is "^1.6.4"
    xtend "^4.0.0"

mute-stream@0.0.8:
  version "0.0.8"
  resolved "https://registry.yarnpkg.com/mute-stream/-/mute-stream-0.0.8.tgz#1630c42b2251ff81e2a283de96a5497ea92e5e0d"
  integrity sha512-nnbWWOkoWyUsTjKrhgD0dcz22mdkSnpYqbEjIm2nhwhuxlSkpywJmBo8h0ZqJdkp73mb90SssHkN4rsRaBAfAA==

mz@^2.7.0:
  version "2.7.0"
  resolved "https://registry.yarnpkg.com/mz/-/mz-2.7.0.tgz#95008057a56cafadc2bc63dde7f9ff6955948e32"
  integrity sha512-z81GNO7nnYMEhrGh9LeymoE4+Yr0Wn5McHIZMK5cfQCl+NDX08sCZgUc9/6MHni9IWuFLm1Z3HTCXu2z9fN62Q==
  dependencies:
    any-promise "^1.0.0"
    object-assign "^4.0.1"
    thenify-all "^1.0.0"

nanoid@^3.3.4:
  version "3.3.4"
  resolved "https://registry.yarnpkg.com/nanoid/-/nanoid-3.3.4.tgz#730b67e3cd09e2deacf03c027c81c9d9dbc5e8ab"
  integrity sha512-MqBkQh/OHTS2egovRtLk45wEyNXwF+cokD+1YPf9u5VfJiRdAiRwB2froX5Co9Rh20xs4siNPm8naNotSD6RBw==

nanoid@^3.3.6:
  version "3.3.6"
  resolved "https://registry.yarnpkg.com/nanoid/-/nanoid-3.3.6.tgz#443380c856d6e9f9824267d960b4236ad583ea4c"
  integrity sha512-BGcqMMJuToF7i1rt+2PWSNVnWIkGCU78jBG3RxO/bZlnZPK2Cmi2QaffxGO/2RvWi9sL+FAiRiXMgsyxQ1DIDA==

natural-compare-lite@^1.4.0:
  version "1.4.0"
  resolved "https://registry.yarnpkg.com/natural-compare-lite/-/natural-compare-lite-1.4.0.tgz#17b09581988979fddafe0201e931ba933c96cbb4"
  integrity sha512-Tj+HTDSJJKaZnfiuw+iaF9skdPpTo2GtEly5JHnWV/hfv2Qj/9RKsGISQtLh2ox3l5EAGw487hnBee0sIJ6v2g==

natural-compare@^1.4.0:
  version "1.4.0"
  resolved "https://registry.yarnpkg.com/natural-compare/-/natural-compare-1.4.0.tgz#4abebfeed7541f2c27acfb29bdbbd15c8d5ba4f7"
  integrity sha512-OWND8ei3VtNC9h7V60qff3SVobHr996CTwgxubgyQYEpg290h9J0buyECNNJexkFm5sOajh5G116RYA1c8ZMSw==

negotiator@0.6.3:
  version "0.6.3"
  resolved "https://registry.yarnpkg.com/negotiator/-/negotiator-0.6.3.tgz#58e323a72fedc0d6f9cd4d31fe49f51479590ccd"
  integrity sha512-+EUsqGPLsM+j/zdChZjsnX51g4XrHFOIXwfnCVPGlQk/k5giakcKsuxCObBRu6DSm9opw/O6slWbJdghQM4bBg==

neo-async@^2.6.2:
  version "2.6.2"
  resolved "https://registry.yarnpkg.com/neo-async/-/neo-async-2.6.2.tgz#b4aafb93e3aeb2d8174ca53cf163ab7d7308305f"
  integrity sha512-Yd3UES5mWCSqR+qNT93S3UoYUkqAZ9lLg8a7g9rimsWmYGK8cVToA4/sF3RrshdyV3sAGMXVUmpMYOw+dLpOuw==

next-transpile-modules@10.0.1:
  version "10.0.1"
  resolved "https://registry.yarnpkg.com/next-transpile-modules/-/next-transpile-modules-10.0.1.tgz#1ca2b735b14781f4792f6214f808b600574e0348"
  integrity sha512-4VX/LCMofxIYAVV58UmD+kr8jQflpLWvas/BQ4Co0qWLWzVh06FoZkECkrX5eEZT6oJFqie6+kfbTA3EZCVtdQ==
  dependencies:
    enhanced-resolve "^5.10.0"

next@13.4.12:
  version "13.4.12"
  resolved "https://registry.yarnpkg.com/next/-/next-13.4.12.tgz#809b21ea0aabbe88ced53252c88c4a5bd5af95df"
  integrity sha512-eHfnru9x6NRmTMcjQp6Nz0J4XH9OubmzOa7CkWL+AUrUxpibub3vWwttjduu9No16dug1kq04hiUUpo7J3m3Xw==
  dependencies:
    "@next/env" "13.4.12"
    "@swc/helpers" "0.5.1"
    busboy "1.6.0"
    caniuse-lite "^1.0.30001406"
    postcss "8.4.14"
    styled-jsx "5.1.1"
    watchpack "2.4.0"
    zod "3.21.4"
  optionalDependencies:
    "@next/swc-darwin-arm64" "13.4.12"
    "@next/swc-darwin-x64" "13.4.12"
    "@next/swc-linux-arm64-gnu" "13.4.12"
    "@next/swc-linux-arm64-musl" "13.4.12"
    "@next/swc-linux-x64-gnu" "13.4.12"
    "@next/swc-linux-x64-musl" "13.4.12"
    "@next/swc-win32-arm64-msvc" "13.4.12"
    "@next/swc-win32-ia32-msvc" "13.4.12"
    "@next/swc-win32-x64-msvc" "13.4.12"

node-abort-controller@^3.0.1:
  version "3.0.1"
  resolved "https://registry.yarnpkg.com/node-abort-controller/-/node-abort-controller-3.0.1.tgz#f91fa50b1dee3f909afabb7e261b1e1d6b0cb74e"
  integrity sha512-/ujIVxthRs+7q6hsdjHMaj8hRG9NuWmwrz+JdRwZ14jdFoKSkm+vDsCbF9PLpnSqjaWQJuTmVtcWHNLr+vrOFw==

node-emoji@1.11.0:
  version "1.11.0"
  resolved "https://registry.yarnpkg.com/node-emoji/-/node-emoji-1.11.0.tgz#69a0150e6946e2f115e9d7ea4df7971e2628301c"
  integrity sha512-wo2DpQkQp7Sjm2A0cq+sN7EHKO6Sl0ctXeBdFZrL9T9+UywORbufTcTZxom8YqpLQt/FqNMUkOpkZrJVYSKD3A==
  dependencies:
    lodash "^4.17.21"

node-fetch@^2.6.1:
  version "2.6.7"
  resolved "https://registry.yarnpkg.com/node-fetch/-/node-fetch-2.6.7.tgz#24de9fba827e3b4ae44dc8b20256a379160052ad"
  integrity sha512-ZjMPFEfVx5j+y2yF35Kzx5sF7kDzxuDj6ziH4FFbOp87zKDZNx8yExJIb05OGF4Nlt9IHFIMBkRl41VdvcNdbQ==
  dependencies:
    whatwg-url "^5.0.0"

node-int64@^0.4.0:
  version "0.4.0"
  resolved "https://registry.yarnpkg.com/node-int64/-/node-int64-0.4.0.tgz#87a9065cdb355d3182d8f94ce11188b825c68a3b"
  integrity sha512-O5lz91xSOeoXP6DulyHfllpq+Eg00MWitZIbtPfoSEvqIHdl5gfcY6hYzDWnj0qD5tz52PI08u9qUvSVeUBeHw==

node-releases@^2.0.13:
  version "2.0.13"
  resolved "https://registry.yarnpkg.com/node-releases/-/node-releases-2.0.13.tgz#d5ed1627c23e3461e819b02e57b75e4899b1c81d"
  integrity sha512-uYr7J37ae/ORWdZeQ1xxMJe3NtdmqMC/JZK+geofDrkLUApKRHPd18/TxtBOJ4A0/+uUIliorNrfYV6s1b02eQ==

node-releases@^2.0.6:
  version "2.0.7"
  resolved "https://registry.yarnpkg.com/node-releases/-/node-releases-2.0.7.tgz#593edbc7c22860ee4d32d3933cfebdfab0c0e0e5"
  integrity sha512-EJ3rzxL9pTWPjk5arA0s0dgXpnyiAbJDE6wHT62g7VsgrgQgmmZ+Ru++M1BFofncWja+Pnn3rEr3fieRySAdKQ==

normalize-path@^3.0.0, normalize-path@~3.0.0:
  version "3.0.0"
  resolved "https://registry.yarnpkg.com/normalize-path/-/normalize-path-3.0.0.tgz#0dcd69ff23a1c9b11fd0978316644a0388216a65"
  integrity sha512-6eZs5Ls3WtCisHWp9S2GUy8dqkpGi4BVSz3GaqiE6ezub0512ESztXUwUB6C6IKbQkY2Pnb/mD4WYojCRwcwLA==

normalize-range@^0.1.2:
  version "0.1.2"
  resolved "https://registry.yarnpkg.com/normalize-range/-/normalize-range-0.1.2.tgz#2d10c06bdfd312ea9777695a4d28439456b75942"
  integrity sha512-bdok/XvKII3nUpklnV6P2hxtMNrCboOjAcyBuQnWEhO665FwrSNRxU+AqpsyvO6LgGYPspN+lu5CLtw4jPRKNA==

npm-run-path@^4.0.0, npm-run-path@^4.0.1:
  version "4.0.1"
  resolved "https://registry.yarnpkg.com/npm-run-path/-/npm-run-path-4.0.1.tgz#b7ecd1e5ed53da8e37a55e1c2269e0b97ed748ea"
  integrity sha512-S48WzZW777zhNIrn7gxOlISNAqi9ZC/uQFnRdbeIHhZhCA6UqpkOT8T1G7BvfdgP4Er8gF4sUbaS0i7QvIfCWw==
  dependencies:
    path-key "^3.0.0"

nwsapi@^2.2.2:
  version "2.2.2"
  resolved "https://registry.yarnpkg.com/nwsapi/-/nwsapi-2.2.2.tgz#e5418863e7905df67d51ec95938d67bf801f0bb0"
  integrity sha512-90yv+6538zuvUMnN+zCr8LuV6bPFdq50304114vJYJ8RDyK8D5O9Phpbd6SZWgI7PwzmmfN1upeOJlvybDSgCw==

object-assign@^4, object-assign@^4.0.1, object-assign@^4.1.1:
  version "4.1.1"
  resolved "https://registry.yarnpkg.com/object-assign/-/object-assign-4.1.1.tgz#2109adc7965887cfc05cbbd442cac8bfbb360863"
  integrity sha512-rJgTQnkUnH1sFw8yT6VSU3zD3sWmu6sZhIseY8VX+GRu3P6F7Fu+JNDoXfklElbLJSnc3FUQHVe4cU5hj+BcUg==

object-hash@^3.0.0:
  version "3.0.0"
  resolved "https://registry.yarnpkg.com/object-hash/-/object-hash-3.0.0.tgz#73f97f753e7baffc0e2cc9d6e079079744ac82e9"
  integrity sha512-RSn9F68PjH9HqtltsSnqYC1XXoWe9Bju5+213R98cNGttag9q9yAOTzdbsqvIa7aNm5WffBZFpWYr2aWrklWAw==

object-inspect@^1.12.2, object-inspect@^1.9.0:
  version "1.12.2"
  resolved "https://registry.yarnpkg.com/object-inspect/-/object-inspect-1.12.2.tgz#c0641f26394532f28ab8d796ab954e43c009a8ea"
  integrity sha512-z+cPxW0QGUp0mcqcsgQyLVRDoXFQbXOwBaqyF7VIgI4TWNQsDHrBpUQslRmIfAoYWdYzs6UlKJtB2XJpTaNSpQ==

object-is@^1.1.5:
  version "1.1.5"
  resolved "https://registry.yarnpkg.com/object-is/-/object-is-1.1.5.tgz#b9deeaa5fc7f1846a0faecdceec138e5778f53ac"
  integrity sha512-3cyDsyHgtmi7I7DfSSI2LDp6SK2lwvtbg0p0R1e0RvTqF5ceGx+K2dfSjm1bKDMVCFEDAQvy+o8c6a7VujOddw==
  dependencies:
    call-bind "^1.0.2"
    define-properties "^1.1.3"

object-keys@^1.1.1:
  version "1.1.1"
  resolved "https://registry.yarnpkg.com/object-keys/-/object-keys-1.1.1.tgz#1c47f272df277f3b1daf061677d9c82e2322c60e"
  integrity sha512-NuAESUOUMrlIXOfHKzD6bpPu3tYt3xvjNdRIQ+FeT0lNb4K8WR70CaDxhuNguS2XG+GjkyMwOzsN5ZktImfhLA==

object.assign@^4.1.3, object.assign@^4.1.4:
  version "4.1.4"
  resolved "https://registry.yarnpkg.com/object.assign/-/object.assign-4.1.4.tgz#9673c7c7c351ab8c4d0b516f4343ebf4dfb7799f"
  integrity sha512-1mxKf0e58bvyjSCtKYY4sRe9itRk3PJpquJOjeIkz885CczcI4IvJJDLPS72oowuSh+pBxUFROpX+TU++hxhZQ==
  dependencies:
    call-bind "^1.0.2"
    define-properties "^1.1.4"
    has-symbols "^1.0.3"
    object-keys "^1.1.1"

object.entries@^1.1.6:
  version "1.1.6"
  resolved "https://registry.yarnpkg.com/object.entries/-/object.entries-1.1.6.tgz#9737d0e5b8291edd340a3e3264bb8a3b00d5fa23"
  integrity sha512-leTPzo4Zvg3pmbQ3rDK69Rl8GQvIqMWubrkxONG9/ojtFE2rD9fjMKfSI5BxW3osRH1m6VdzmqK8oAY9aT4x5w==
  dependencies:
    call-bind "^1.0.2"
    define-properties "^1.1.4"
    es-abstract "^1.20.4"

object.fromentries@^2.0.6:
  version "2.0.6"
  resolved "https://registry.yarnpkg.com/object.fromentries/-/object.fromentries-2.0.6.tgz#cdb04da08c539cffa912dcd368b886e0904bfa73"
  integrity sha512-VciD13dswC4j1Xt5394WR4MzmAQmlgN72phd/riNp9vtD7tp4QQWJ0R4wvclXcafgcYK8veHRed2W6XeGBvcfg==
  dependencies:
    call-bind "^1.0.2"
    define-properties "^1.1.4"
    es-abstract "^1.20.4"

object.hasown@^1.1.2:
  version "1.1.2"
  resolved "https://registry.yarnpkg.com/object.hasown/-/object.hasown-1.1.2.tgz#f919e21fad4eb38a57bc6345b3afd496515c3f92"
  integrity sha512-B5UIT3J1W+WuWIU55h0mjlwaqxiE5vYENJXIXZ4VFe05pNYrkKuK0U/6aFcb0pKywYJh7IhfoqUfKVmrJJHZHw==
  dependencies:
    define-properties "^1.1.4"
    es-abstract "^1.20.4"

object.values@^1.1.5, object.values@^1.1.6:
  version "1.1.6"
  resolved "https://registry.yarnpkg.com/object.values/-/object.values-1.1.6.tgz#4abbaa71eba47d63589d402856f908243eea9b1d"
  integrity sha512-FVVTkD1vENCsAcwNs9k6jea2uHC/X0+JcjG8YA60FN5CMaJmG95wT9jek/xX9nornqGRrBkKtzuAu2wuHpKqvw==
  dependencies:
    call-bind "^1.0.2"
    define-properties "^1.1.4"
    es-abstract "^1.20.4"

on-finished@2.4.1:
  version "2.4.1"
  resolved "https://registry.yarnpkg.com/on-finished/-/on-finished-2.4.1.tgz#58c8c44116e54845ad57f14ab10b03533184ac3f"
  integrity sha512-oVlzkg3ENAhCk2zdv7IJwd/QUD4z2RxRwpkcGY8psCVcCYZNq4wYnVWALHM+brtuJjePWiYF/ClmuDr8Ch5+kg==
  dependencies:
    ee-first "1.1.1"

once@^1.3.0, once@^1.3.1, once@^1.4.0:
  version "1.4.0"
  resolved "https://registry.yarnpkg.com/once/-/once-1.4.0.tgz#583b1aa775961d4b113ac17d9c50baef9dd76bd1"
  integrity sha512-lNaJgI+2Q5URQBkccEKHTQOPaXdUxnZZElQTZY0MFUAuaEqe1E+Nyvgdz/aIyNi6Z9MzO5dv1H8n58/GELp3+w==
  dependencies:
    wrappy "1"

onetime@^5.1.0, onetime@^5.1.2:
  version "5.1.2"
  resolved "https://registry.yarnpkg.com/onetime/-/onetime-5.1.2.tgz#d0e96ebb56b07476df1dd9c4806e5237985ca45e"
  integrity sha512-kbpaSSGJTWdAY5KPVeMOKXSrPtr8C8C7wodJbcsd51jRnmD+GZu8Y0VoU6Dm5Z4vWr0Ig/1NKuWRKf7j5aaYSg==
  dependencies:
    mimic-fn "^2.1.0"

open@^8.4.0:
  version "8.4.0"
  resolved "https://registry.yarnpkg.com/open/-/open-8.4.0.tgz#345321ae18f8138f82565a910fdc6b39e8c244f8"
  integrity sha512-XgFPPM+B28FtCCgSb9I+s9szOC1vZRSwgWsRUA5ylIxRTgKozqjOCrVOqGsYABPYK5qnfqClxZTFBa8PKt2v6Q==
  dependencies:
    define-lazy-prop "^2.0.0"
    is-docker "^2.1.1"
    is-wsl "^2.2.0"

optionator@^0.8.1:
  version "0.8.3"
  resolved "https://registry.yarnpkg.com/optionator/-/optionator-0.8.3.tgz#84fa1d036fe9d3c7e21d99884b601167ec8fb495"
  integrity sha512-+IW9pACdk3XWmmTXG8m3upGUJst5XRGzxMRjXzAuJ1XnIFNvfhjjIuYkDvysnPQ7qzqVzLt78BCruntqRhWQbA==
  dependencies:
    deep-is "~0.1.3"
    fast-levenshtein "~2.0.6"
    levn "~0.3.0"
    prelude-ls "~1.1.2"
    type-check "~0.3.2"
    word-wrap "~1.2.3"

optionator@^0.9.3:
  version "0.9.3"
  resolved "https://registry.yarnpkg.com/optionator/-/optionator-0.9.3.tgz#007397d44ed1872fdc6ed31360190f81814e2c64"
  integrity sha512-JjCoypp+jKn1ttEFExxhetCKeJt9zhAgAve5FXHixTvFDW/5aEktX9bufBKLRRMdU7bNtpLfcGu94B3cdEJgjg==
  dependencies:
    "@aashutoshrathi/word-wrap" "^1.2.3"
    deep-is "^0.1.3"
    fast-levenshtein "^2.0.6"
    levn "^0.4.1"
    prelude-ls "^1.2.1"
    type-check "^0.4.0"

ora@5.4.1, ora@^5.4.1:
  version "5.4.1"
  resolved "https://registry.yarnpkg.com/ora/-/ora-5.4.1.tgz#1b2678426af4ac4a509008e5e4ac9e9959db9e18"
  integrity sha512-5b6Y85tPxZZ7QytO+BQzysW31HJku27cRIlkbAXaNx+BdcVi+LlRFmVXzeF6a7JCwJpyw5c4b+YSVImQIrBpuQ==
  dependencies:
    bl "^4.1.0"
    chalk "^4.1.0"
    cli-cursor "^3.1.0"
    cli-spinners "^2.5.0"
    is-interactive "^1.0.0"
    is-unicode-supported "^0.1.0"
    log-symbols "^4.1.0"
    strip-ansi "^6.0.0"
    wcwidth "^1.0.1"

os-name@4.0.1:
  version "4.0.1"
  resolved "https://registry.yarnpkg.com/os-name/-/os-name-4.0.1.tgz#32cee7823de85a8897647ba4d76db46bf845e555"
  integrity sha512-xl9MAoU97MH1Xt5K9ERft2YfCAoaO6msy1OBA0ozxEC0x0TmIoE6K3QvgJMMZA9yKGLmHXNY/YZoDbiGDj4zYw==
  dependencies:
    macos-release "^2.5.0"
    windows-release "^4.0.0"

os-tmpdir@~1.0.2:
  version "1.0.2"
  resolved "https://registry.yarnpkg.com/os-tmpdir/-/os-tmpdir-1.0.2.tgz#bbe67406c79aa85c5cfec766fe5734555dfa1274"
  integrity sha512-D2FR03Vir7FIu45XBY20mTb+/ZSWB00sjU9jdQXt83gDrI4Ztz5Fs7/yy74g2N5SVQY4xY1qDr4rNddwYRVX0g==

p-limit@^2.2.0:
  version "2.3.0"
  resolved "https://registry.yarnpkg.com/p-limit/-/p-limit-2.3.0.tgz#3dd33c647a214fdfffd835933eb086da0dc21db1"
  integrity sha512-//88mFWSJx8lxCzwdAABTJL2MyWB12+eIY7MDL2SqLmAkeKU9qxRvWuSyTjm3FUmpBEMuFfckAIqEaVGUDxb6w==
  dependencies:
    p-try "^2.0.0"

p-limit@^3.0.2, p-limit@^3.1.0:
  version "3.1.0"
  resolved "https://registry.yarnpkg.com/p-limit/-/p-limit-3.1.0.tgz#e1daccbe78d0d1388ca18c64fea38e3e57e3706b"
  integrity sha512-TYOanM3wGwNGsZN2cVTYPArw454xnXj5qmWF1bEoAc4+cU/ol7GVh7odevjp1FNHduHc3KZMcFduxU5Xc6uJRQ==
  dependencies:
    yocto-queue "^0.1.0"

p-locate@^4.1.0:
  version "4.1.0"
  resolved "https://registry.yarnpkg.com/p-locate/-/p-locate-4.1.0.tgz#a3428bb7088b3a60292f66919278b7c297ad4f07"
  integrity sha512-R79ZZ/0wAxKGu3oYMlz8jy/kbhsNrS7SKZ7PxEHBgJ5+F2mtFW2fK2cOtBh1cHYkQsbzFV7I+EoRKe6Yt0oK7A==
  dependencies:
    p-limit "^2.2.0"

p-locate@^5.0.0:
  version "5.0.0"
  resolved "https://registry.yarnpkg.com/p-locate/-/p-locate-5.0.0.tgz#83c8315c6785005e3bd021839411c9e110e6d834"
  integrity sha512-LaNjtRWUBY++zB5nE/NwcaoMylSPk+S+ZHNB1TzdbMJMny6dynpAGt7X/tl/QYq3TIeE6nxHppbo2LGymrG5Pw==
  dependencies:
    p-limit "^3.0.2"

p-try@^2.0.0:
  version "2.2.0"
  resolved "https://registry.yarnpkg.com/p-try/-/p-try-2.2.0.tgz#cb2868540e313d61de58fafbe35ce9004d5540e6"
  integrity sha512-R4nPAVTAU0B9D35/Gk3uJf/7XYbQcyohSKdvAxIRSNghFl4e71hVoGnBNQz9cWaXxO2I10KTC+3jMdvvoKw6dQ==

parent-module@^1.0.0:
  version "1.0.1"
  resolved "https://registry.yarnpkg.com/parent-module/-/parent-module-1.0.1.tgz#691d2709e78c79fae3a156622452d00762caaaa2"
  integrity sha512-GQ2EWRpQV8/o+Aw8YqtfZZPfNRWZYkbidE9k5rpl/hC3vtHHBfGm2Ifi6qWV+coDGkrUKZAxE3Lot5kcsRlh+g==
  dependencies:
    callsites "^3.0.0"

parse-json@^5.0.0, parse-json@^5.2.0:
  version "5.2.0"
  resolved "https://registry.yarnpkg.com/parse-json/-/parse-json-5.2.0.tgz#c76fc66dee54231c962b22bcc8a72cf2f99753cd"
  integrity sha512-ayCKvm/phCGxOkYRSCM82iDwct8/EonSEgCSxWxD7ve6jHggsFl4fZVQBPRNgQoKiuV/odhFrGzQXZwbifC8Rg==
  dependencies:
    "@babel/code-frame" "^7.0.0"
    error-ex "^1.3.1"
    json-parse-even-better-errors "^2.3.0"
    lines-and-columns "^1.1.6"

parse5@^7.0.0, parse5@^7.1.1:
  version "7.1.2"
  resolved "https://registry.yarnpkg.com/parse5/-/parse5-7.1.2.tgz#0736bebbfd77793823240a23b7fc5e010b7f8e32"
  integrity sha512-Czj1WaSVpaoj0wbhMzLmWD69anp2WH7FXMB9n1Sy8/ZFF9jolSQVMu1Ij5WIyGmcBmhk7EOndpO4mIpihVqAXw==
  dependencies:
    entities "^4.4.0"

parseurl@~1.3.3:
  version "1.3.3"
  resolved "https://registry.yarnpkg.com/parseurl/-/parseurl-1.3.3.tgz#9da19e7bee8d12dff0513ed5b76957793bc2e8d4"
  integrity sha512-CiyeOxFT/JZyN5m0z9PfXw4SCBJ6Sygz1Dpl0wqjlhDEGGBP1GnsUVEL0p63hoG1fcj3fHynXi9NYO4nWOL+qQ==

path-exists@^4.0.0:
  version "4.0.0"
  resolved "https://registry.yarnpkg.com/path-exists/-/path-exists-4.0.0.tgz#513bdbe2d3b95d7762e8c1137efa195c6c61b5b3"
  integrity sha512-ak9Qy5Q7jYb2Wwcey5Fpvg2KoAc/ZIhLSLOSBmRmygPsGwkVVt0fZa0qrtMz+m6tJTAHfZQ8FnmB4MG4LWy7/w==

path-is-absolute@^1.0.0:
  version "1.0.1"
  resolved "https://registry.yarnpkg.com/path-is-absolute/-/path-is-absolute-1.0.1.tgz#174b9268735534ffbc7ace6bf53a5a9e1b5c5f5f"
  integrity sha512-AVbw3UJ2e9bq64vSaS9Am0fje1Pa8pbGqTTsmXfaIiMpnr5DlDhfJOuLj9Sf95ZPVDAUerDfEk88MPmPe7UCQg==

path-key@^3.0.0, path-key@^3.1.0:
  version "3.1.1"
  resolved "https://registry.yarnpkg.com/path-key/-/path-key-3.1.1.tgz#581f6ade658cbba65a0d3380de7753295054f375"
  integrity sha512-ojmeN0qd+y0jszEtoY48r0Peq5dwMEkIlCOu6Q5f41lfkswXuKtYrhgoTpLnyIcHm24Uhqx+5Tqm2InSwLhE6Q==

path-parse@^1.0.7:
  version "1.0.7"
  resolved "https://registry.yarnpkg.com/path-parse/-/path-parse-1.0.7.tgz#fbc114b60ca42b30d9daf5858e4bd68bbedb6735"
  integrity sha512-LDJzPVEEEPR+y48z93A0Ed0yXb8pAByGWo/k5YYdYgpY2/2EsOsksJrq7lOHxryrVOn1ejG6oAp8ahvOIQD8sw==

path-scurry@^1.10.1, path-scurry@^1.6.1:
  version "1.10.1"
  resolved "https://registry.yarnpkg.com/path-scurry/-/path-scurry-1.10.1.tgz#9ba6bf5aa8500fe9fd67df4f0d9483b2b0bfc698"
  integrity sha512-MkhCqzzBEpPvxxQ71Md0b1Kk51W01lrYvlMzSUaIzNsODdd7mqhiimSZlr+VegAz5Z6Vzt9Xg2ttE//XBhH3EQ==
  dependencies:
    lru-cache "^9.1.1 || ^10.0.0"
    minipass "^5.0.0 || ^6.0.2 || ^7.0.0"

path-to-regexp@0.1.7:
  version "0.1.7"
  resolved "https://registry.yarnpkg.com/path-to-regexp/-/path-to-regexp-0.1.7.tgz#df604178005f522f15eb4490e7247a1bfaa67f8c"
  integrity sha512-5DFkuoqlv1uYQKxy8omFBeJPQcdoE07Kv2sferDCrAq1ohOU+MSDswDIbnx3YAM60qIOnYa53wBhXW0EbMonrQ==

path-to-regexp@3.2.0:
  version "3.2.0"
  resolved "https://registry.yarnpkg.com/path-to-regexp/-/path-to-regexp-3.2.0.tgz#fa7877ecbc495c601907562222453c43cc204a5f"
  integrity sha512-jczvQbCUS7XmS7o+y1aEO9OBVFeZBQ1MDSEqmO7xSoPgOPoowY/SxLpZ6Vh97/8qHZOteiCKb7gkG9gA2ZUxJA==

path-type@^4.0.0:
  version "4.0.0"
  resolved "https://registry.yarnpkg.com/path-type/-/path-type-4.0.0.tgz#84ed01c0a7ba380afe09d90a8c180dcd9d03043b"
  integrity sha512-gDKb8aZMDeD/tZWs9P6+q0J9Mwkdl6xMV8TjnGP3qJVJ06bdMgkbBlLU8IdfOsIsFz2BW1rNVT3XuNEl8zPAvw==

picocolors@^1.0.0:
  version "1.0.0"
  resolved "https://registry.yarnpkg.com/picocolors/-/picocolors-1.0.0.tgz#cb5bdc74ff3f51892236eaf79d68bc44564ab81c"
  integrity sha512-1fygroTLlHu66zi26VoTDv8yRgm0Fccecssto+MhsZ0D/DGW2sm8E8AjW7NU5VVTRt5GxbeZ5qBuJr+HyLYkjQ==

picomatch@^2.0.4, picomatch@^2.2.1, picomatch@^2.2.3, picomatch@^2.3.1:
  version "2.3.1"
  resolved "https://registry.yarnpkg.com/picomatch/-/picomatch-2.3.1.tgz#3ba3833733646d9d3e4995946c1365a67fb07a42"
  integrity sha512-JU3teHTNjmE2VCGFzuY8EXzCDVwEqB2a8fsIvwaStHhAWJEeVd1o1QD80CU6+ZdEXXSLbSsuLwJjkCBWqRQUVA==

pify@^2.3.0:
  version "2.3.0"
  resolved "https://registry.yarnpkg.com/pify/-/pify-2.3.0.tgz#ed141a6ac043a849ea588498e7dca8b15330e90c"
  integrity sha512-udgsAY+fTnvv7kI7aaxbqwWNb0AHiB0qBO89PZKPkoTmGOgdbrHDKD+0B2X4uTfJ/FT1R09r9gTsjUjNJotuog==

pirates@^4.0.1:
  version "4.0.6"
  resolved "https://registry.yarnpkg.com/pirates/-/pirates-4.0.6.tgz#3018ae32ecfcff6c29ba2267cbf21166ac1f36b9"
  integrity sha512-saLsH7WeYYPiD25LDuLRRY/i+6HaPYr6G1OUlN39otzkSTxKnubR9RTxS3/Kk50s1g2JTgFwWQDQyplC5/SHZg==

pirates@^4.0.4:
  version "4.0.5"
  resolved "https://registry.yarnpkg.com/pirates/-/pirates-4.0.5.tgz#feec352ea5c3268fb23a37c702ab1699f35a5f3b"
  integrity sha512-8V9+HQPupnaXMA23c5hvl69zXvTwTzyAYasnkb0Tts4XvO4CliqONMOnvlq26rkhLC3nWDFBJf73LU1e1VZLaQ==

pkg-dir@^4.2.0:
  version "4.2.0"
  resolved "https://registry.yarnpkg.com/pkg-dir/-/pkg-dir-4.2.0.tgz#f099133df7ede422e81d1d8448270eeb3e4261f3"
  integrity sha512-HRDzbaKjC+AOWVXxAU/x54COGeIv9eb+6CkDSQoNTt4XyWoIJvuPsXizxu/Fr23EiekbtZwmh1IcIG/l/a10GQ==
  dependencies:
    find-up "^4.0.0"

pluralize@8.0.0:
  version "8.0.0"
  resolved "https://registry.yarnpkg.com/pluralize/-/pluralize-8.0.0.tgz#1a6fa16a38d12a1901e0320fa017051c539ce3b1"
  integrity sha512-Nc3IT5yHzflTfbjgqWcCPpo7DaKy4FnpB0l/zCAW0Tc7jxAiuqSxHasntB3D7887LSrA93kDJ9IXovxJYxyLCA==

postcss-import@^15.1.0:
  version "15.1.0"
  resolved "https://registry.yarnpkg.com/postcss-import/-/postcss-import-15.1.0.tgz#41c64ed8cc0e23735a9698b3249ffdbf704adc70"
  integrity sha512-hpr+J05B2FVYUAXHeK1YyI267J/dDDhMU6B6civm8hSY1jYJnBXxzKDKDswzJmtLHryrjhnDjqqp/49t8FALew==
  dependencies:
    postcss-value-parser "^4.0.0"
    read-cache "^1.0.0"
    resolve "^1.1.7"

postcss-js@^4.0.1:
  version "4.0.1"
  resolved "https://registry.yarnpkg.com/postcss-js/-/postcss-js-4.0.1.tgz#61598186f3703bab052f1c4f7d805f3991bee9d2"
  integrity sha512-dDLF8pEO191hJMtlHFPRa8xsizHaM82MLfNkUHdUtVEV3tgTp5oj+8qbEqYM57SLfc74KSbw//4SeJma2LRVIw==
  dependencies:
    camelcase-css "^2.0.1"

postcss-load-config@^4.0.1:
  version "4.0.1"
  resolved "https://registry.yarnpkg.com/postcss-load-config/-/postcss-load-config-4.0.1.tgz#152383f481c2758274404e4962743191d73875bd"
  integrity sha512-vEJIc8RdiBRu3oRAI0ymerOn+7rPuMvRXslTvZUKZonDHFIczxztIyJ1urxM1x9JXEikvpWWTUUqal5j/8QgvA==
  dependencies:
    lilconfig "^2.0.5"
    yaml "^2.1.1"

postcss-nested@^6.0.1:
  version "6.0.1"
  resolved "https://registry.yarnpkg.com/postcss-nested/-/postcss-nested-6.0.1.tgz#f83dc9846ca16d2f4fa864f16e9d9f7d0961662c"
  integrity sha512-mEp4xPMi5bSWiMbsgoPfcP74lsWLHkQbZc3sY+jWYd65CUwXrUaTp0fmNpa01ZcETKlIgUdFN/MpS2xZtqL9dQ==
  dependencies:
    postcss-selector-parser "^6.0.11"

postcss-selector-parser@^6.0.11:
  version "6.0.13"
  resolved "https://registry.yarnpkg.com/postcss-selector-parser/-/postcss-selector-parser-6.0.13.tgz#d05d8d76b1e8e173257ef9d60b706a8e5e99bf1b"
  integrity sha512-EaV1Gl4mUEV4ddhDnv/xtj7sxwrwxdetHdWUGnT4VJQf+4d05v6lHYZr8N573k5Z0BViss7BDhfWtKS3+sfAqQ==
  dependencies:
    cssesc "^3.0.0"
    util-deprecate "^1.0.2"

postcss-value-parser@^4.0.0, postcss-value-parser@^4.2.0:
  version "4.2.0"
  resolved "https://registry.yarnpkg.com/postcss-value-parser/-/postcss-value-parser-4.2.0.tgz#723c09920836ba6d3e5af019f92bc0971c02e514"
  integrity sha512-1NNCs6uurfkVbeXG4S8JFT9t19m45ICnif8zWLd5oPSZ50QnwMfK+H3jv408d4jw/7Bttv5axS5IiHoLaVNHeQ==

postcss@8.4.14:
  version "8.4.14"
  resolved "https://registry.yarnpkg.com/postcss/-/postcss-8.4.14.tgz#ee9274d5622b4858c1007a74d76e42e56fd21caf"
  integrity sha512-E398TUmfAYFPBSdzgeieK2Y1+1cpdxJx8yXbK/m57nRhKSmk1GB2tO4lbLBtlkfPQTDKfe4Xqv1ASWPpayPEig==
  dependencies:
    nanoid "^3.3.4"
    picocolors "^1.0.0"
    source-map-js "^1.0.2"

postcss@^8.4.23, postcss@^8.4.27:
  version "8.4.27"
  resolved "https://registry.yarnpkg.com/postcss/-/postcss-8.4.27.tgz#234d7e4b72e34ba5a92c29636734349e0d9c3057"
  integrity sha512-gY/ACJtJPSmUFPDCHtX78+01fHa64FaU4zaaWfuh1MhGJISufJAH4cun6k/8fwsHYeK4UQmENQK+tRLCFJE8JQ==
  dependencies:
    nanoid "^3.3.6"
    picocolors "^1.0.0"
    source-map-js "^1.0.2"

prelude-ls@^1.2.1:
  version "1.2.1"
  resolved "https://registry.yarnpkg.com/prelude-ls/-/prelude-ls-1.2.1.tgz#debc6489d7a6e6b0e7611888cec880337d316396"
  integrity sha512-vkcDPrRZo1QZLbn5RLGPpg/WmIQ65qoWWhcGKf/b5eplkkarX0m9z8ppCat4mlOqUsWpyNuYgO3VRyrYHSzX5g==

prelude-ls@~1.1.2:
  version "1.1.2"
  resolved "https://registry.yarnpkg.com/prelude-ls/-/prelude-ls-1.1.2.tgz#21932a549f5e52ffd9a827f570e04be62a97da54"
  integrity sha512-ESF23V4SKG6lVSGZgYNpbsiaAkdab6ZgOxe52p7+Kid3W3u3bxR4Vfd/o21dmN7jSt0IwgZ4v5MUd26FEtXE9w==

prettier-linter-helpers@^1.0.0:
  version "1.0.0"
  resolved "https://registry.yarnpkg.com/prettier-linter-helpers/-/prettier-linter-helpers-1.0.0.tgz#d23d41fe1375646de2d0104d3454a3008802cf7b"
  integrity sha512-GbK2cP9nraSSUF9N2XwUwqfzlAFlMNYYl+ShE/V+H8a9uNl/oUqB1w2EL54Jh0OlyRSd8RfWYJ3coVS4TROP2w==
  dependencies:
    fast-diff "^1.1.2"

prettier@^3.0.0:
  version "3.0.0"
  resolved "https://registry.yarnpkg.com/prettier/-/prettier-3.0.0.tgz#e7b19f691245a21d618c68bc54dc06122f6105ae"
  integrity sha512-zBf5eHpwHOGPC47h0zrPyNn+eAEIdEzfywMoYn2XPi0P44Zp0tSq64rq0xAREh4auw2cJZHo9QUob+NqCQky4g==

pretty-format@^27.0.2:
  version "27.5.1"
  resolved "https://registry.yarnpkg.com/pretty-format/-/pretty-format-27.5.1.tgz#2181879fdea51a7a5851fb39d920faa63f01d88e"
  integrity sha512-Qb1gy5OrP5+zDf2Bvnzdl3jsTf1qXVMazbvCoKhtKqVs4/YK4ozX4gKQJJVyNe+cajNPn0KoC0MC3FUmaHWEmQ==
  dependencies:
    ansi-regex "^5.0.1"
    ansi-styles "^5.0.0"
    react-is "^17.0.1"

pretty-format@^29.0.0, pretty-format@^29.3.1:
  version "29.3.1"
  resolved "https://registry.yarnpkg.com/pretty-format/-/pretty-format-29.3.1.tgz#1841cac822b02b4da8971dacb03e8a871b4722da"
  integrity sha512-FyLnmb1cYJV8biEIiRyzRFvs2lry7PPIvOqKVe1GCUEYg4YGmlx1qG9EJNMxArYm7piII4qb8UV1Pncq5dxmcg==
  dependencies:
    "@jest/schemas" "^29.0.0"
    ansi-styles "^5.0.0"
    react-is "^18.0.0"

pretty-format@^29.6.2:
  version "29.6.2"
  resolved "https://registry.yarnpkg.com/pretty-format/-/pretty-format-29.6.2.tgz#3d5829261a8a4d89d8b9769064b29c50ed486a47"
  integrity sha512-1q0oC8eRveTg5nnBEWMXAU2qpv65Gnuf2eCQzSjxpWFkPaPARwqZZDGuNE0zPAZfTCHzIk3A8dIjwlQKKLphyg==
  dependencies:
    "@jest/schemas" "^29.6.0"
    ansi-styles "^5.0.0"
    react-is "^18.0.0"

prisma@^5.1.0:
  version "5.1.0"
  resolved "https://registry.yarnpkg.com/prisma/-/prisma-5.1.0.tgz#29e316b54844f5694a83017a9781a6d6f7cb99ea"
  integrity sha512-wkXvh+6wxk03G8qwpZMOed4Y3j+EQ+bMTlvbDZHeal6k1E8QuGKzRO7DRXlE1NV0WNgOAas8kwZqcLETQ2+BiQ==
  dependencies:
    "@prisma/engines" "5.1.0"

process-nextick-args@~2.0.0:
  version "2.0.1"
  resolved "https://registry.yarnpkg.com/process-nextick-args/-/process-nextick-args-2.0.1.tgz#7820d9b16120cc55ca9ae7792680ae7dba6d7fe2"
  integrity sha512-3ouUOpQhtgrbOa17J7+uxOTpITYWaGP7/AhoR3+A+/1e9skrzelGi/dXzEYyvbxubEF6Wn2ypscTKiKJFFn1ag==

prompts@^2.0.1:
  version "2.4.2"
  resolved "https://registry.yarnpkg.com/prompts/-/prompts-2.4.2.tgz#7b57e73b3a48029ad10ebd44f74b01722a4cb069"
  integrity sha512-NxNv/kLguCA7p3jE8oL2aEBsrJWgAakBpgmgK6lpPWV+WuOmY6r2/zbAVnP+T8bQlA0nzHXSJSJW0Hq7ylaD2Q==
  dependencies:
    kleur "^3.0.3"
    sisteransi "^1.0.5"

prop-types@^15.8.1:
  version "15.8.1"
  resolved "https://registry.yarnpkg.com/prop-types/-/prop-types-15.8.1.tgz#67d87bf1a694f48435cf332c24af10214a3140b5"
  integrity sha512-oj87CgZICdulUohogVAR7AjlC0327U4el4L6eAvOqCeudMDVU0NThNaV+b9Df4dXgSP1gXMTnPdhfe/2qDH5cg==
  dependencies:
    loose-envify "^1.4.0"
    object-assign "^4.1.1"
    react-is "^16.13.1"

proxy-addr@~2.0.7:
  version "2.0.7"
  resolved "https://registry.yarnpkg.com/proxy-addr/-/proxy-addr-2.0.7.tgz#f19fe69ceab311eeb94b42e70e8c2070f9ba1025"
  integrity sha512-llQsMLSUDUPT44jdrU/O37qlnifitDP+ZwrmmZcoSKyLKvtZxpyV0n2/bD/N4tBAAZ/gJEdZU7KMraoK1+XYAg==
  dependencies:
    forwarded "0.2.0"
    ipaddr.js "1.9.1"

psl@^1.1.33:
  version "1.9.0"
  resolved "https://registry.yarnpkg.com/psl/-/psl-1.9.0.tgz#d0df2a137f00794565fcaf3b2c00cd09f8d5a5a7"
  integrity sha512-E/ZsdU4HLs/68gYzgGTkMicWTLPdAftJLfJFlLUAAKZGkStNU72sZjT66SnMDVOfOWY/YAoiD7Jxa9iHvngcag==

pump@^3.0.0:
  version "3.0.0"
  resolved "https://registry.yarnpkg.com/pump/-/pump-3.0.0.tgz#b4a2116815bde2f4e1ea602354e8c75565107a64"
  integrity sha512-LwZy+p3SFs1Pytd/jYct4wpv49HiYCqd9Rlc5ZVdk0V+8Yzv6jR5Blk3TRmPL1ft69TxP0IMZGJ+WPFU2BFhww==
  dependencies:
    end-of-stream "^1.1.0"
    once "^1.3.1"

punycode@^2.1.0, punycode@^2.1.1:
  version "2.1.1"
  resolved "https://registry.yarnpkg.com/punycode/-/punycode-2.1.1.tgz#b58b010ac40c22c5657616c8d2c2c02c7bf479ec"
  integrity sha512-XRsRjdf+j5ml+y/6GKHPZbrF/8p2Yga0JPtdqTIY2Xe5ohJPD9saDJJLPvp9+NSBprVvevdXZybnj2cv8OEd0A==

pure-rand@^6.0.0:
  version "6.0.2"
  resolved "https://registry.yarnpkg.com/pure-rand/-/pure-rand-6.0.2.tgz#a9c2ddcae9b68d736a8163036f088a2781c8b306"
  integrity sha512-6Yg0ekpKICSjPswYOuC5sku/TSWaRYlA0qsXqJgM/d/4pLPHPuTxK7Nbf7jFKzAeedUhR8C7K9Uv63FBsSo8xQ==

qs@6.11.0, qs@^6.11.0:
  version "6.11.0"
  resolved "https://registry.yarnpkg.com/qs/-/qs-6.11.0.tgz#fd0d963446f7a65e1367e01abd85429453f0c37a"
  integrity sha512-MvjoMCJwEarSbUYk5O+nmoSzSutSsTwF85zcHPQ9OrlFoZOYIjaqBAJIqIXjptyD5vThxGq52Xu/MaJzRkIk4Q==
  dependencies:
    side-channel "^1.0.4"

querystringify@^2.1.1:
  version "2.2.0"
  resolved "https://registry.yarnpkg.com/querystringify/-/querystringify-2.2.0.tgz#3345941b4153cb9d082d8eee4cda2016a9aef7f6"
  integrity sha512-FIqgj2EUvTa7R50u0rGsyTftzjYmv/a3hO345bZNrqabNqjtgiDMgmo4mkUjd+nzU5oF3dClKqFIPUKybUyqoQ==

queue-microtask@^1.2.2:
  version "1.2.3"
  resolved "https://registry.yarnpkg.com/queue-microtask/-/queue-microtask-1.2.3.tgz#4929228bbc724dfac43e0efb058caf7b6cfb6243"
  integrity sha512-NuaNSa6flKT5JaSYQzJok04JzTL1CA6aGhv5rfLW3PgqA+M2ChpZQnAC8h8i4ZFkBS8X5RqkDBHA7r4hej3K9A==

randombytes@^2.1.0:
  version "2.1.0"
  resolved "https://registry.yarnpkg.com/randombytes/-/randombytes-2.1.0.tgz#df6f84372f0270dc65cdf6291349ab7a473d4f2a"
  integrity sha512-vYl3iOX+4CKUWuxGi9Ukhie6fsqXqS9FE2Zaic4tNFD2N2QQaXOMFbuKK4QmDHC0JO6B1Zp41J0LpT0oR68amQ==
  dependencies:
    safe-buffer "^5.1.0"

range-parser@~1.2.1:
  version "1.2.1"
  resolved "https://registry.yarnpkg.com/range-parser/-/range-parser-1.2.1.tgz#3cf37023d199e1c24d1a55b84800c2f3e6468031"
  integrity sha512-Hrgsx+orqoygnmhFbKaHE6c296J+HTAQXoxEF6gNupROmmGJRoyzfG3ccAveqCBrwr/2yxQ5BVd/GTl5agOwSg==

raw-body@2.5.1:
  version "2.5.1"
  resolved "https://registry.yarnpkg.com/raw-body/-/raw-body-2.5.1.tgz#fe1b1628b181b700215e5fd42389f98b71392857"
  integrity sha512-qqJBtEyVgS0ZmPGdCFPWJ3FreoqvG4MVQln/kCgF7Olq95IbOp0/BWyMwbdtn4VTvkM8Y7khCQ2Xgk/tcrCXig==
  dependencies:
    bytes "3.1.2"
    http-errors "2.0.0"
    iconv-lite "0.4.24"
    unpipe "1.0.0"

raw-body@2.5.2:
  version "2.5.2"
  resolved "https://registry.yarnpkg.com/raw-body/-/raw-body-2.5.2.tgz#99febd83b90e08975087e8f1f9419a149366b68a"
  integrity sha512-8zGqypfENjCIqGhgXToC8aB2r7YrBX+AQAfIPs/Mlk+BtPTztOvTS01NRW/3Eh60J+a48lt8qsCzirQ6loCVfA==
  dependencies:
    bytes "3.1.2"
    http-errors "2.0.0"
    iconv-lite "0.4.24"
    unpipe "1.0.0"

react-dom@18.2.0:
  version "18.2.0"
  resolved "https://registry.yarnpkg.com/react-dom/-/react-dom-18.2.0.tgz#22aaf38708db2674ed9ada224ca4aa708d821e3d"
  integrity sha512-6IMTriUmvsjHUjNtEDudZfuDQUoWXVxKHhlEGSk81n4YFS+r/Kl99wXiwlVXtPBtJenozv2P+hxDsw9eA7Xo6g==
  dependencies:
    loose-envify "^1.1.0"
    scheduler "^0.23.0"

react-is@^16.13.1, react-is@^16.7.0:
  version "16.13.1"
  resolved "https://registry.yarnpkg.com/react-is/-/react-is-16.13.1.tgz#789729a4dc36de2999dc156dd6c1d9c18cea56a4"
  integrity sha512-24e6ynE2H+OKt4kqsOvNd8kBpV65zoxbA4BVsEOB3ARVWQki/DHzaUoC5KuON/BiccDaCCTZBuOcfZs70kR8bQ==

react-is@^17.0.1:
  version "17.0.2"
  resolved "https://registry.yarnpkg.com/react-is/-/react-is-17.0.2.tgz#e691d4a8e9c789365655539ab372762b0efb54f0"
  integrity sha512-w2GsyukL62IJnlaff/nRegPQR94C/XXamvMWmSHRJ4y7Ts/4ocGRmTHvOs8PSE6pB3dWOrD/nueuU5sduBsQ4w==

react-is@^18.0.0:
  version "18.2.0"
  resolved "https://registry.yarnpkg.com/react-is/-/react-is-18.2.0.tgz#199431eeaaa2e09f86427efbb4f1473edb47609b"
  integrity sha512-xWGDIW6x921xtzPkhiULtthJHoJvBbF3q26fzloPCK0hsvxtPVelvftw3zjbHWSkR2km9Z+4uxbDDK/6Zw9B8w==

react-redux@^8.1.2:
  version "8.1.2"
  resolved "https://registry.yarnpkg.com/react-redux/-/react-redux-8.1.2.tgz#9076bbc6b60f746659ad6d51cb05de9c5e1e9188"
  integrity sha512-xJKYI189VwfsFc4CJvHqHlDrzyFTY/3vZACbE+rr/zQ34Xx1wQfB4OTOSeOSNrF6BDVe8OOdxIrAnMGXA3ggfw==
  dependencies:
    "@babel/runtime" "^7.12.1"
    "@types/hoist-non-react-statics" "^3.3.1"
    "@types/use-sync-external-store" "^0.0.3"
    hoist-non-react-statics "^3.3.2"
    react-is "^18.0.0"
    use-sync-external-store "^1.0.0"

react@18.2.0:
  version "18.2.0"
  resolved "https://registry.yarnpkg.com/react/-/react-18.2.0.tgz#555bd98592883255fa00de14f1151a917b5d77d5"
  integrity sha512-/3IjMdb2L9QbBdWiW5e3P2/npwMBaU9mHCSCUzNln0ZCYbcfTsGbTJrU/kGemdH2IWmB2ioZ+zkxtmq6g09fGQ==
  dependencies:
    loose-envify "^1.1.0"

read-cache@^1.0.0:
  version "1.0.0"
  resolved "https://registry.yarnpkg.com/read-cache/-/read-cache-1.0.0.tgz#e664ef31161166c9751cdbe8dbcf86b5fb58f774"
  integrity sha512-Owdv/Ft7IjOgm/i0xvNDZ1LrRANRfew4b2prF3OWMQLxLfu3bS8FVhCsrSCMK4lR56Y9ya+AThoTpDCTxCmpRA==
  dependencies:
    pify "^2.3.0"

readable-stream@^2.2.2:
  version "2.3.7"
  resolved "https://registry.yarnpkg.com/readable-stream/-/readable-stream-2.3.7.tgz#1eca1cf711aef814c04f62252a36a62f6cb23b57"
  integrity sha512-Ebho8K4jIbHAxnuxi7o42OrZgF/ZTNcsZj6nRKyUmkhLFq8CHItp/fy6hQZuZmP/n3yZ9VBUbp4zz/mX8hmYPw==
  dependencies:
    core-util-is "~1.0.0"
    inherits "~2.0.3"
    isarray "~1.0.0"
    process-nextick-args "~2.0.0"
    safe-buffer "~5.1.1"
    string_decoder "~1.1.1"
    util-deprecate "~1.0.1"

readable-stream@^3.4.0:
  version "3.6.0"
  resolved "https://registry.yarnpkg.com/readable-stream/-/readable-stream-3.6.0.tgz#337bbda3adc0706bd3e024426a286d4b4b2c9198"
  integrity sha512-BViHy7LKeTz4oNnkcLJ+lVSL6vpiFeX6/d3oSH8zCW7UxP2onchk+vTGB143xuFjHS3deTgkKoXXymXqymiIdA==
  dependencies:
    inherits "^2.0.3"
    string_decoder "^1.1.1"
    util-deprecate "^1.0.1"

readdirp@~3.6.0:
  version "3.6.0"
  resolved "https://registry.yarnpkg.com/readdirp/-/readdirp-3.6.0.tgz#74a370bd857116e245b29cc97340cd431a02a6c7"
  integrity sha512-hOS089on8RduqdbhvQ5Z37A0ESjsqz6qnRcffsMU3495FuTdqSm+7bhJ29JvIOsBDEEnan5DPu9t3To9VRlMzA==
  dependencies:
    picomatch "^2.2.1"

rechoir@^0.6.2:
  version "0.6.2"
  resolved "https://registry.yarnpkg.com/rechoir/-/rechoir-0.6.2.tgz#85204b54dba82d5742e28c96756ef43af50e3384"
  integrity sha512-HFM8rkZ+i3zrV+4LQjwQ0W+ez98pApMGM3HUrN04j3CqzPOzl9nmP15Y8YXNm8QHGv/eacOVEjqhmWpkRV0NAw==
  dependencies:
    resolve "^1.1.6"

redent@^3.0.0:
  version "3.0.0"
  resolved "https://registry.yarnpkg.com/redent/-/redent-3.0.0.tgz#e557b7998316bb53c9f1f56fa626352c6963059f"
  integrity sha512-6tDA8g98We0zd0GvVeMT9arEOnTw9qM03L9cJXaCjrip1OO764RDBLBfrB4cwzNGDj5OA5ioymC9GkizgWJDUg==
  dependencies:
    indent-string "^4.0.0"
    strip-indent "^3.0.0"

redux-thunk@^2.4.2:
  version "2.4.2"
  resolved "https://registry.yarnpkg.com/redux-thunk/-/redux-thunk-2.4.2.tgz#b9d05d11994b99f7a91ea223e8b04cf0afa5ef3b"
  integrity sha512-+P3TjtnP0k/FEjcBL5FZpoovtvrTNT/UXd4/sluaSyrURlSlhLSzEdfsTBW7WsKB6yPvgd7q/iZPICFjW4o57Q==

redux@^4.2.1:
  version "4.2.1"
  resolved "https://registry.yarnpkg.com/redux/-/redux-4.2.1.tgz#c08f4306826c49b5e9dc901dee0452ea8fce6197"
  integrity sha512-LAUYz4lc+Do8/g7aeRa8JkyDErK6ekstQaqWQrNRW//MY1TvCEpMtpTWvlQ+FPbWCx+Xixu/6SHt5N0HR+SB4w==
  dependencies:
    "@babel/runtime" "^7.9.2"

reflect-metadata@^0.1.13:
  version "0.1.13"
  resolved "https://registry.yarnpkg.com/reflect-metadata/-/reflect-metadata-0.1.13.tgz#67ae3ca57c972a2aa1642b10fe363fe32d49dc08"
  integrity sha512-Ts1Y/anZELhSsjMcU605fU9RE4Oi3p5ORujwbIKXfWa+0Zxs510Qrmrce5/Jowq3cHSZSJqBjypxmHarc+vEWg==

regenerator-runtime@^0.13.11:
  version "0.13.11"
  resolved "https://registry.yarnpkg.com/regenerator-runtime/-/regenerator-runtime-0.13.11.tgz#f6dca3e7ceec20590d07ada785636a90cdca17f9"
  integrity sha512-kY1AZVr2Ra+t+piVaJ4gxaFaReZVH40AKNo7UCX6W+dEwBo/2oZJzqfuN1qLq1oL45o56cPaTXELwrTh8Fpggg==

regexp.prototype.flags@^1.4.3:
  version "1.4.3"
  resolved "https://registry.yarnpkg.com/regexp.prototype.flags/-/regexp.prototype.flags-1.4.3.tgz#87cab30f80f66660181a3bb7bf5981a872b367ac"
  integrity sha512-fjggEOO3slI6Wvgjwflkc4NFRCTZAu5CnNfBd5qOMYhWdn67nJBBu34/TkD++eeFmd8C9r9jfXJ27+nSiRkSUA==
  dependencies:
    call-bind "^1.0.2"
    define-properties "^1.1.3"
    functions-have-names "^1.2.2"

repeat-string@^1.6.1:
  version "1.6.1"
  resolved "https://registry.yarnpkg.com/repeat-string/-/repeat-string-1.6.1.tgz#8dcae470e1c88abc2d600fff4a776286da75e637"
  integrity sha512-PV0dzCYDNfRi1jCDbJzpW7jNNDRuCOG/jI5ctQcGKt/clZD+YcPS3yIlWuTJMmESC8aevCFmWJy5wjAFgNqN6w==

require-directory@^2.1.1:
  version "2.1.1"
  resolved "https://registry.yarnpkg.com/require-directory/-/require-directory-2.1.1.tgz#8c64ad5fd30dab1c976e2344ffe7f792a6a6df42"
  integrity sha512-fGxEI7+wsG9xrvdjsrlmL22OMTTiHRwAMroiEeMgq8gzoLC/PQr7RsRDSTLUg/bZAZtF+TVIkHc6/4RIKrui+Q==

require-from-string@^2.0.2:
  version "2.0.2"
  resolved "https://registry.yarnpkg.com/require-from-string/-/require-from-string-2.0.2.tgz#89a7fdd938261267318eafe14f9c32e598c36909"
  integrity sha512-Xf0nWe6RseziFMu+Ap9biiUbmplq6S9/p+7w7YXP/JBHhrUDDUhwa+vANyubuqfZWTveU//DYVGsDG7RKL/vEw==

requires-port@^1.0.0:
  version "1.0.0"
  resolved "https://registry.yarnpkg.com/requires-port/-/requires-port-1.0.0.tgz#925d2601d39ac485e091cf0da5c6e694dc3dcaff"
  integrity sha512-KigOCHcocU3XODJxsu8i/j8T9tzT4adHiecwORRQ0ZZFcp7ahwXuRU1m+yuO90C5ZUyGeGfocHDI14M3L3yDAQ==

reselect@^4.1.8:
  version "4.1.8"
  resolved "https://registry.yarnpkg.com/reselect/-/reselect-4.1.8.tgz#3f5dc671ea168dccdeb3e141236f69f02eaec524"
  integrity sha512-ab9EmR80F/zQTMNeneUr4cv+jSwPJgIlvEmVwLerwrWVbpLlBuls9XHzIeTFy4cegU2NHBp3va0LKOzU5qFEYQ==

resolve-cwd@^3.0.0:
  version "3.0.0"
  resolved "https://registry.yarnpkg.com/resolve-cwd/-/resolve-cwd-3.0.0.tgz#0f0075f1bb2544766cf73ba6a6e2adfebcb13f2d"
  integrity sha512-OrZaX2Mb+rJCpH/6CpSqt9xFVpN++x01XnN2ie9g6P5/3xelLAkXWVADpdz1IHD/KFfEXyE6V0U01OQ3UO2rEg==
  dependencies:
    resolve-from "^5.0.0"

resolve-from@^4.0.0:
  version "4.0.0"
  resolved "https://registry.yarnpkg.com/resolve-from/-/resolve-from-4.0.0.tgz#4abcd852ad32dd7baabfe9b40e00a36db5f392e6"
  integrity sha512-pb/MYmXstAkysRFx8piNI1tGFNQIFA3vkE3Gq4EuA1dF6gHp/+vgZqsCGJapvy8N3Q+4o7FwvquPJcnZ7RYy4g==

resolve-from@^5.0.0:
  version "5.0.0"
  resolved "https://registry.yarnpkg.com/resolve-from/-/resolve-from-5.0.0.tgz#c35225843df8f776df21c57557bc087e9dfdfc69"
  integrity sha512-qYg9KP24dD5qka9J47d0aVky0N+b4fTU89LN9iDnjB5waksiC49rvMB0PrUJQGoTmH50XPiqOvAjDfaijGxYZw==

resolve.exports@^2.0.0:
  version "2.0.2"
  resolved "https://registry.yarnpkg.com/resolve.exports/-/resolve.exports-2.0.2.tgz#f8c934b8e6a13f539e38b7098e2e36134f01e800"
  integrity sha512-X2UW6Nw3n/aMgDVy+0rSqgHlv39WZAlZrXCdnbyEiKm17DSqHX4MmQMaST3FbeWR5FTuRcUwYAziZajji0Y7mg==

resolve@^1.1.6, resolve@^1.1.7, resolve@^1.20.0, resolve@^1.22.0:
  version "1.22.1"
  resolved "https://registry.yarnpkg.com/resolve/-/resolve-1.22.1.tgz#27cb2ebb53f91abb49470a928bba7558066ac177"
  integrity sha512-nBpuuYuY5jFsli/JIs1oldw6fOQCBioohqWZg/2hiaOybXOft4lonv85uDOKXdf8rhyK159cxU5cDcK/NKk8zw==
  dependencies:
    is-core-module "^2.9.0"
    path-parse "^1.0.7"
    supports-preserve-symlinks-flag "^1.0.0"

resolve@^1.22.2:
  version "1.22.2"
  resolved "https://registry.yarnpkg.com/resolve/-/resolve-1.22.2.tgz#0ed0943d4e301867955766c9f3e1ae6d01c6845f"
  integrity sha512-Sb+mjNHOULsBv818T40qSPeRiuWLyaGMa5ewydRLFimneixmVy2zdivRl+AF6jaYPC8ERxGDmFSiqui6SfPd+g==
  dependencies:
    is-core-module "^2.11.0"
    path-parse "^1.0.7"
    supports-preserve-symlinks-flag "^1.0.0"

resolve@^2.0.0-next.3, resolve@^2.0.0-next.4:
  version "2.0.0-next.4"
  resolved "https://registry.yarnpkg.com/resolve/-/resolve-2.0.0-next.4.tgz#3d37a113d6429f496ec4752d2a2e58efb1fd4660"
  integrity sha512-iMDbmAWtfU+MHpxt/I5iWI7cY6YVEZUQ3MBgPQ++XD1PELuJHIl82xBmObyP2KyQmkNB2dsqF7seoQQiAn5yDQ==
  dependencies:
    is-core-module "^2.9.0"
    path-parse "^1.0.7"
    supports-preserve-symlinks-flag "^1.0.0"

restore-cursor@^3.1.0:
  version "3.1.0"
  resolved "https://registry.yarnpkg.com/restore-cursor/-/restore-cursor-3.1.0.tgz#39f67c54b3a7a58cea5236d95cf0034239631f7e"
  integrity sha512-l+sSefzHpj5qimhFSE5a8nufZYAM3sBSVMAPtYkmC+4EH2anSGaEMXSD0izRQbu9nfyQ9y5JrVmp7E8oZrUjvA==
  dependencies:
    onetime "^5.1.0"
    signal-exit "^3.0.2"

reusify@^1.0.4:
  version "1.0.4"
  resolved "https://registry.yarnpkg.com/reusify/-/reusify-1.0.4.tgz#90da382b1e126efc02146e90845a88db12925d76"
  integrity sha512-U9nH88a3fc/ekCF1l0/UP1IosiuIjyTh7hBvXVMHYgVcfGvt897Xguj2UOLDeI5BG2m7/uwyaLVT6fbtCwTyzw==

rimraf@4.4.1:
  version "4.4.1"
  resolved "https://registry.yarnpkg.com/rimraf/-/rimraf-4.4.1.tgz#bd33364f67021c5b79e93d7f4fa0568c7c21b755"
  integrity sha512-Gk8NlF062+T9CqNGn6h4tls3k6T1+/nXdOcSZVikNVtlRdYpA7wRJJMoXmuvOnLW844rPjdQ7JgXCYM6PPC/og==
  dependencies:
    glob "^9.2.0"

rimraf@^3.0.2:
  version "3.0.2"
  resolved "https://registry.yarnpkg.com/rimraf/-/rimraf-3.0.2.tgz#f1a5402ba6220ad52cc1282bac1ae3aa49fd061a"
  integrity sha512-JZkJMZkAGFFPP2YqXZXPbMlMBgsxzE8ILs4lMIX/2o0L9UBw9O/Y3o6wFw/i9YLapcUJWwqbi3kdxIPdC62TIA==
  dependencies:
    glob "^7.1.3"

rimraf@^5.0.1:
  version "5.0.1"
  resolved "https://registry.yarnpkg.com/rimraf/-/rimraf-5.0.1.tgz#0881323ab94ad45fec7c0221f27ea1a142f3f0d0"
  integrity sha512-OfFZdwtd3lZ+XZzYP/6gTACubwFcHdLRqS9UX3UwpU2dnGQYkPFISRwvM3w9IiB2w7bW5qGo/uAwE4SmXXSKvg==
  dependencies:
    glob "^10.2.5"

run-async@^2.4.0:
  version "2.4.1"
  resolved "https://registry.yarnpkg.com/run-async/-/run-async-2.4.1.tgz#8440eccf99ea3e70bd409d49aab88e10c189a455"
  integrity sha512-tvVnVv01b8c1RrA6Ep7JkStj85Guv/YrMcwqYQnwjsAS2cTmmPGBBjAjpCW7RrSodNSoE2/qg9O4bceNvUuDgQ==

run-parallel@^1.1.9:
  version "1.2.0"
  resolved "https://registry.yarnpkg.com/run-parallel/-/run-parallel-1.2.0.tgz#66d1368da7bdf921eb9d95bd1a9229e7f21a43ee"
  integrity sha512-5l4VyZR86LZ/lDxZTR6jqL8AFE2S0IFLMP26AbjsLVADxHdhB/c0GUsH+y39UfCi3dzz8OlQuPmnaJOMoDHQBA==
  dependencies:
    queue-microtask "^1.2.2"

run-script-webpack-plugin@^0.2.0:
  version "0.2.0"
  resolved "https://registry.yarnpkg.com/run-script-webpack-plugin/-/run-script-webpack-plugin-0.2.0.tgz#45bfdd4e11345c8619eabaef8113c2a4f26dc653"
  integrity sha512-SVNNq4jxzjfnaW+HkdTlyH1CWwCuSb/weYfic0D7Y/KnhY27YRYkzgybdzTDEPJlpQ73FDCRDbyBFwNsJMmwWQ==

rxjs@7.8.1, rxjs@^7.8.1:
  version "7.8.1"
  resolved "https://registry.yarnpkg.com/rxjs/-/rxjs-7.8.1.tgz#6f6f3d99ea8044291efd92e7c7fcf562c4057543"
  integrity sha512-AA3TVj+0A2iuIoQkWEK/tqFjBq2j+6PO6Y0zJcvzLAFhEFIO3HL0vls9hWLncZbAAbK0mar7oZ4V079I/qPMxg==
  dependencies:
    tslib "^2.1.0"

rxjs@^7.5.5:
  version "7.6.0"
  resolved "https://registry.yarnpkg.com/rxjs/-/rxjs-7.6.0.tgz#361da5362b6ddaa691a2de0b4f2d32028f1eb5a2"
  integrity sha512-DDa7d8TFNUalGC9VqXvQ1euWNN7sc63TrUCuM9J998+ViviahMIjKSOU7rfcgFOF+FCD71BhDRv4hrFz+ImDLQ==
  dependencies:
    tslib "^2.1.0"

safe-buffer@5.2.1, safe-buffer@^5.1.0, safe-buffer@~5.2.0:
  version "5.2.1"
  resolved "https://registry.yarnpkg.com/safe-buffer/-/safe-buffer-5.2.1.tgz#1eaf9fa9bdb1fdd4ec75f58f9cdb4e6b7827eec6"
  integrity sha512-rp3So07KcdmmKbGvgaNxQSJr7bGVSVk5S9Eq1F+ppbRo70+YeaDxkw5Dd8NPN+GD6bjnYm2VuPuCXmpuYvmCXQ==

safe-buffer@~5.1.0, safe-buffer@~5.1.1:
  version "5.1.2"
  resolved "https://registry.yarnpkg.com/safe-buffer/-/safe-buffer-5.1.2.tgz#991ec69d296e0313747d59bdfd2b745c35f8828d"
  integrity sha512-Gd2UZBJDkXlY7GbJxfsE8/nvKkUEU1G38c1siN6QP6a9PT9MmHB8GnpscSmMJSoF8LOIrt8ud/wPtojys4G6+g==

safe-regex-test@^1.0.0:
  version "1.0.0"
  resolved "https://registry.yarnpkg.com/safe-regex-test/-/safe-regex-test-1.0.0.tgz#793b874d524eb3640d1873aad03596db2d4f2295"
  integrity sha512-JBUUzyOgEwXQY1NuPtvcj/qcBDbDmEvWufhlnXZIm75DEHp+afM1r1ujJpJsV/gSM4t59tpDyPi1sd6ZaPFfsA==
  dependencies:
    call-bind "^1.0.2"
    get-intrinsic "^1.1.3"
    is-regex "^1.1.4"

"safer-buffer@>= 2.1.2 < 3", "safer-buffer@>= 2.1.2 < 3.0.0":
  version "2.1.2"
  resolved "https://registry.yarnpkg.com/safer-buffer/-/safer-buffer-2.1.2.tgz#44fa161b0187b9549dd84bb91802f9bd8385cd6a"
  integrity sha512-YZo3K82SD7Riyi0E1EQPojLz7kpepnSQI9IyPbHHg1XXXevb5dJI7tpyN2ADxGcQbHG7vcyRHk0cbwqcQriUtg==

saxes@^6.0.0:
  version "6.0.0"
  resolved "https://registry.yarnpkg.com/saxes/-/saxes-6.0.0.tgz#fe5b4a4768df4f14a201b1ba6a65c1f3d9988cc5"
  integrity sha512-xAg7SOnEhrm5zI3puOOKyy1OMcMlIJZYNJY7xLBwSze0UjhPLnWfj2GF2EpT0jmzaJKIWKHLsaSSajf35bcYnA==
  dependencies:
    xmlchars "^2.2.0"

scheduler@^0.23.0:
  version "0.23.0"
  resolved "https://registry.yarnpkg.com/scheduler/-/scheduler-0.23.0.tgz#ba8041afc3d30eb206a487b6b384002e4e61fdfe"
  integrity sha512-CtuThmgHNg7zIZWAXi3AsyIzA3n4xx7aNyjwC2VJldO2LMVDhFK+63xGqq6CsJH4rTAt6/M+N4GhZiDYPx9eUw==
  dependencies:
    loose-envify "^1.1.0"

schema-utils@^3.1.1:
  version "3.1.1"
  resolved "https://registry.yarnpkg.com/schema-utils/-/schema-utils-3.1.1.tgz#bc74c4b6b6995c1d88f76a8b77bea7219e0c8281"
  integrity sha512-Y5PQxS4ITlC+EahLuXaY86TXfR7Dc5lw294alXOq86JAHCihAIZfqv8nNCWvaEJvaC51uN9hbLGeV0cFBdH+Fw==
  dependencies:
    "@types/json-schema" "^7.0.8"
    ajv "^6.12.5"
    ajv-keywords "^3.5.2"

schema-utils@^3.2.0:
  version "3.3.0"
  resolved "https://registry.yarnpkg.com/schema-utils/-/schema-utils-3.3.0.tgz#f50a88877c3c01652a15b622ae9e9795df7a60fe"
  integrity sha512-pN/yOAvcC+5rQ5nERGuwrjLlYvLTbCibnZ1I7B1LaiAz9BRBlE9GMgE/eqV30P7aJQUf7Ddimy/RsbYO/GrVGg==
  dependencies:
    "@types/json-schema" "^7.0.8"
    ajv "^6.12.5"
    ajv-keywords "^3.5.2"

semver@^6.0.0, semver@^6.3.0:
  version "6.3.0"
  resolved "https://registry.yarnpkg.com/semver/-/semver-6.3.0.tgz#ee0a64c8af5e8ceea67687b133761e1becbd1d3d"
  integrity sha512-b39TBaTSfV6yBrapU89p5fKekE2m/NwnDocOVruQFS1/veMgdzuPcnOM34M6CwxW8jH/lxEa5rBoDeUwu5HHTw==

semver@^6.3.1:
  version "6.3.1"
  resolved "https://registry.yarnpkg.com/semver/-/semver-6.3.1.tgz#556d2ef8689146e46dcea4bfdd095f3434dffcb4"
  integrity sha512-BR7VvDCVHO+q2xBEWskxS6DJE1qRnb7DxzUrogb71CWoSficBxYsiAGd+Kl0mmq/MprG9yArRkyrQxTO6XjMzA==

semver@^7.3.4, semver@^7.3.5, semver@^7.3.7, semver@^7.3.8:
  version "7.3.8"
  resolved "https://registry.yarnpkg.com/semver/-/semver-7.3.8.tgz#07a78feafb3f7b32347d725e33de7e2a2df67798"
  integrity sha512-NB1ctGL5rlHrPJtFDVIVzTyQylMLu9N9VICA6HSFJo8MCGVTMW6gfpicwKmmK/dAjTOrqu5l63JJOpDSrAis3A==
  dependencies:
    lru-cache "^6.0.0"

semver@^7.5.3, semver@^7.5.4:
  version "7.5.4"
  resolved "https://registry.yarnpkg.com/semver/-/semver-7.5.4.tgz#483986ec4ed38e1c6c48c34894a9182dbff68a6e"
  integrity sha512-1bCSESV6Pv+i21Hvpxp3Dx+pSD8lIPt8uVjRrxAUt/nbswYc+tK6Y2btiULjd4+fnq15PX+nqQDC7Oft7WkwcA==
  dependencies:
    lru-cache "^6.0.0"

send@0.18.0:
  version "0.18.0"
  resolved "https://registry.yarnpkg.com/send/-/send-0.18.0.tgz#670167cc654b05f5aa4a767f9113bb371bc706be"
  integrity sha512-qqWzuOjSFOuqPjFe4NOsMLafToQQwBSOEpS+FwEt3A2V3vKubTquT3vmLTQpFgMXp8AlFWFuP1qKaJZOtPpVXg==
  dependencies:
    debug "2.6.9"
    depd "2.0.0"
    destroy "1.2.0"
    encodeurl "~1.0.2"
    escape-html "~1.0.3"
    etag "~1.8.1"
    fresh "0.5.2"
    http-errors "2.0.0"
    mime "1.6.0"
    ms "2.1.3"
    on-finished "2.4.1"
    range-parser "~1.2.1"
    statuses "2.0.1"

serialize-javascript@^6.0.1:
  version "6.0.1"
  resolved "https://registry.yarnpkg.com/serialize-javascript/-/serialize-javascript-6.0.1.tgz#b206efb27c3da0b0ab6b52f48d170b7996458e5c"
  integrity sha512-owoXEFjWRllis8/M1Q+Cw5k8ZH40e3zhp/ovX+Xr/vi1qj6QesbyXXViFbpNvWvPNAD62SutwEXavefrLJWj7w==
  dependencies:
    randombytes "^2.1.0"

serve-static@1.15.0:
  version "1.15.0"
  resolved "https://registry.yarnpkg.com/serve-static/-/serve-static-1.15.0.tgz#faaef08cffe0a1a62f60cad0c4e513cff0ac9540"
  integrity sha512-XGuRDNjXUijsUL0vl6nSD7cwURuzEgglbOaFuZM9g3kwDXOWVTck0jLzjPzGD+TazWbboZYu52/9/XPdUgne9g==
  dependencies:
    encodeurl "~1.0.2"
    escape-html "~1.0.3"
    parseurl "~1.3.3"
    send "0.18.0"

setprototypeof@1.2.0:
  version "1.2.0"
  resolved "https://registry.yarnpkg.com/setprototypeof/-/setprototypeof-1.2.0.tgz#66c9a24a73f9fc28cbe66b09fed3d33dcaf1b424"
  integrity sha512-E5LDX7Wrp85Kil5bhZv46j8jOeboKq5JMmYM3gVGdGH8xFpPWXUMsNrlODCrkoxMEeNi/XZIwuRvY4XNwYMJpw==

shebang-command@^2.0.0:
  version "2.0.0"
  resolved "https://registry.yarnpkg.com/shebang-command/-/shebang-command-2.0.0.tgz#ccd0af4f8835fbdc265b82461aaf0c36663f34ea"
  integrity sha512-kHxr2zZpYtdmrN1qDjrrX/Z1rR1kG8Dx+gkpK1G4eXmvXswmcE1hTWBWYUzlraYw1/yZp6YuDY77YtvbN0dmDA==
  dependencies:
    shebang-regex "^3.0.0"

shebang-regex@^3.0.0:
  version "3.0.0"
  resolved "https://registry.yarnpkg.com/shebang-regex/-/shebang-regex-3.0.0.tgz#ae16f1644d873ecad843b0307b143362d4c42172"
  integrity sha512-7++dFhtcx3353uBaq8DDR4NuxBetBzC7ZQOhmTQInHEd6bSrXdiEyzCvG07Z44UYdLShWUyXt5M/yhz8ekcb1A==

shelljs@0.8.5:
  version "0.8.5"
  resolved "https://registry.yarnpkg.com/shelljs/-/shelljs-0.8.5.tgz#de055408d8361bed66c669d2f000538ced8ee20c"
  integrity sha512-TiwcRcrkhHvbrZbnRcFYMLl30Dfov3HKqzp5tO5b4pt6G/SezKcYhmDg15zXVBswHmctSAQKznqNW2LO5tTDow==
  dependencies:
    glob "^7.0.0"
    interpret "^1.0.0"
    rechoir "^0.6.2"

side-channel@^1.0.4:
  version "1.0.4"
  resolved "https://registry.yarnpkg.com/side-channel/-/side-channel-1.0.4.tgz#efce5c8fdc104ee751b25c58d4290011fa5ea2cf"
  integrity sha512-q5XPytqFEIKHkGdiMIrY10mvLRvnQh42/+GoBlFW3b2LXLE2xxJpZFdm94we0BaoV3RwJyGqg5wS7epxTv0Zvw==
  dependencies:
    call-bind "^1.0.0"
    get-intrinsic "^1.0.2"
    object-inspect "^1.9.0"

signal-exit@^3.0.2, signal-exit@^3.0.3, signal-exit@^3.0.7:
  version "3.0.7"
  resolved "https://registry.yarnpkg.com/signal-exit/-/signal-exit-3.0.7.tgz#a9a1767f8af84155114eaabd73f99273c8f59ad9"
  integrity sha512-wnD2ZE+l+SPC/uoS0vXeE9L1+0wuaMqKlfz9AMUo38JsyLSBWSFcHR1Rri62LZc12vLr1gb3jl7iwQhgwpAbGQ==

signal-exit@^4.0.1:
  version "4.1.0"
  resolved "https://registry.yarnpkg.com/signal-exit/-/signal-exit-4.1.0.tgz#952188c1cbd546070e2dd20d0f41c0ae0530cb04"
  integrity sha512-bzyZ1e88w9O1iNJbKnOlvYTrWPDl46O1bG0D3XInv+9tkPrxrN8jUUTiFlDkkmKWgn1M6CfIA13SuGqOa9Korw==

sisteransi@^1.0.5:
  version "1.0.5"
  resolved "https://registry.yarnpkg.com/sisteransi/-/sisteransi-1.0.5.tgz#134d681297756437cc05ca01370d3a7a571075ed"
  integrity sha512-bLGGlR1QxBcynn2d5YmDX4MGjlZvy2MRBDRNHLJ8VI6l6+9FUiyTFNJ0IveOSP0bcXgVDPRcfGqA0pjaqUpfVg==

slash@^3.0.0:
  version "3.0.0"
  resolved "https://registry.yarnpkg.com/slash/-/slash-3.0.0.tgz#6539be870c165adbd5240220dbe361f1bc4d4634"
  integrity sha512-g9Q1haeby36OSStwb4ntCGGGaKsaVSjQ68fBxoQcutl5fS1vuY18H3wSt3jFyFtrkx+Kz0V1G85A4MyAdDMi2Q==

slash@^4.0.0:
  version "4.0.0"
  resolved "https://registry.yarnpkg.com/slash/-/slash-4.0.0.tgz#2422372176c4c6c5addb5e2ada885af984b396a7"
  integrity sha512-3dOsAHXXUkQTpOYcoAxLIorMTp4gIQr5IW3iVb7A7lFIp0VHhnynm9izx6TssdrIcVIESAlVjtnO2K8bg+Coew==

source-map-js@^1.0.2:
  version "1.0.2"
  resolved "https://registry.yarnpkg.com/source-map-js/-/source-map-js-1.0.2.tgz#adbc361d9c62df380125e7f161f71c826f1e490c"
  integrity sha512-R0XvVJ9WusLiqTCEiGCmICCMplcCkIwwR11mOSD9CR5u+IXYdiseeEuXCVAjS54zqwkLcPNnmU4OeJ6tUrWhDw==

source-map-support@0.5.13:
  version "0.5.13"
  resolved "https://registry.yarnpkg.com/source-map-support/-/source-map-support-0.5.13.tgz#31b24a9c2e73c2de85066c0feb7d44767ed52932"
  integrity sha512-SHSKFHadjVA5oR4PPqhtAVdcBWwRYVd6g6cAXnIbRiIwc2EhPrTuKUBdSLvlEKyIP3GCf89fltvcZiP9MMFA1w==
  dependencies:
    buffer-from "^1.0.0"
    source-map "^0.6.0"

source-map-support@0.5.21, source-map-support@^0.5.21, source-map-support@~0.5.20:
  version "0.5.21"
  resolved "https://registry.yarnpkg.com/source-map-support/-/source-map-support-0.5.21.tgz#04fe7c7f9e1ed2d662233c28cb2b35b9f63f6e4f"
  integrity sha512-uBHU3L3czsIyYXKX88fdrGovxdSCoTGDRZ6SYXtSRxLZUzHg5P/66Ht6uoUlHu9EZod+inXhKo3qQgwXUT/y1w==
  dependencies:
    buffer-from "^1.0.0"
    source-map "^0.6.0"

source-map@0.7.4:
  version "0.7.4"
  resolved "https://registry.yarnpkg.com/source-map/-/source-map-0.7.4.tgz#a9bbe705c9d8846f4e08ff6765acf0f1b0898656"
  integrity sha512-l3BikUxvPOcn5E74dZiq5BGsTb5yEwhaTSzccU6t4sDOH8NWJCstKO5QT2CvtFoK6F0saL7p9xHAqHOlCPJygA==

source-map@^0.6.0, source-map@^0.6.1, source-map@~0.6.1:
  version "0.6.1"
  resolved "https://registry.yarnpkg.com/source-map/-/source-map-0.6.1.tgz#74722af32e9614e9c287a8d0bbde48b5e2f1a263"
  integrity sha512-UjgapumWlbMhkBgzT7Ykc5YXUT46F0iKu8SGXq0bcwP5dz/h0Plj6enJqjz1Zbq2l5WaqYnrVbwWOWMyF3F47g==

sprintf-js@~1.0.2:
  version "1.0.3"
  resolved "https://registry.yarnpkg.com/sprintf-js/-/sprintf-js-1.0.3.tgz#04e6926f662895354f3dd015203633b857297e2c"
  integrity sha512-D9cPgkvLlV3t3IzL0D0YLvGA9Ahk4PcvVwUbN0dSGr1aP0Nrt4AEnTUbuGvquEC0mA64Gqt1fzirlRs5ibXx8g==

stack-utils@^2.0.3:
  version "2.0.6"
  resolved "https://registry.yarnpkg.com/stack-utils/-/stack-utils-2.0.6.tgz#aaf0748169c02fc33c8232abccf933f54a1cc34f"
  integrity sha512-XlkWvfIm6RmsWtNJx+uqtKLS8eqFbxUg0ZzLXqY0caEy9l7hruX8IpiDnjsLavoBgqCCR71TqWO8MaXYheJ3RQ==
  dependencies:
    escape-string-regexp "^2.0.0"

statuses@2.0.1:
  version "2.0.1"
  resolved "https://registry.yarnpkg.com/statuses/-/statuses-2.0.1.tgz#55cb000ccf1d48728bd23c685a063998cf1a1b63"
  integrity sha512-RwNA9Z/7PrK06rYLIzFMlaF+l73iwpzsqRIFgbMLbTcLD6cOao82TaWefPXQvB2fOC4AjuYSEndS7N/mTCbkdQ==

streamsearch@^1.1.0:
  version "1.1.0"
  resolved "https://registry.yarnpkg.com/streamsearch/-/streamsearch-1.1.0.tgz#404dd1e2247ca94af554e841a8ef0eaa238da764"
  integrity sha512-Mcc5wHehp9aXz1ax6bZUyY5afg9u2rv5cqQI3mRrYkGC8rW2hM02jWuwjtL++LS5qinSyhj2QfLyNsuc+VsExg==

string-length@^4.0.1:
  version "4.0.2"
  resolved "https://registry.yarnpkg.com/string-length/-/string-length-4.0.2.tgz#a8a8dc7bd5c1a82b9b3c8b87e125f66871b6e57a"
  integrity sha512-+l6rNN5fYHNhZZy41RXsYptCjA2Igmq4EG7kZAYFQI1E1VTXarr6ZPXBg6eq7Y6eK4FEhY6AJlyuFIb/v/S0VQ==
  dependencies:
    char-regex "^1.0.2"
    strip-ansi "^6.0.0"

"string-width-cjs@npm:string-width@^4.2.0", string-width@^4.1.0, string-width@^4.2.0, string-width@^4.2.3:
  version "4.2.3"
  resolved "https://registry.yarnpkg.com/string-width/-/string-width-4.2.3.tgz#269c7117d27b05ad2e536830a8ec895ef9c6d010"
  integrity sha512-wKyQRQpjJ0sIp62ErSZdGsjMJWsap5oRNihHhu6G7JVO/9jIB6UyevL+tXuOqrng8j/cxKTWyWUwvSTriiZz/g==
  dependencies:
    emoji-regex "^8.0.0"
    is-fullwidth-code-point "^3.0.0"
    strip-ansi "^6.0.1"

string-width@^5.0.1, string-width@^5.1.2:
  version "5.1.2"
  resolved "https://registry.yarnpkg.com/string-width/-/string-width-5.1.2.tgz#14f8daec6d81e7221d2a357e668cab73bdbca794"
  integrity sha512-HnLOCR3vjcY8beoNLtcjZ5/nxn2afmME6lhrDrebokqMap+XbeW8n9TXpPDOqdGK5qcI3oT0GKTW6wC7EMiVqA==
  dependencies:
    eastasianwidth "^0.2.0"
    emoji-regex "^9.2.2"
    strip-ansi "^7.0.1"

string.prototype.matchall@^4.0.8:
  version "4.0.8"
  resolved "https://registry.yarnpkg.com/string.prototype.matchall/-/string.prototype.matchall-4.0.8.tgz#3bf85722021816dcd1bf38bb714915887ca79fd3"
  integrity sha512-6zOCOcJ+RJAQshcTvXPHoxoQGONa3e/Lqx90wUA+wEzX78sg5Bo+1tQo4N0pohS0erG9qtCqJDjNCQBjeWVxyg==
  dependencies:
    call-bind "^1.0.2"
    define-properties "^1.1.4"
    es-abstract "^1.20.4"
    get-intrinsic "^1.1.3"
    has-symbols "^1.0.3"
    internal-slot "^1.0.3"
    regexp.prototype.flags "^1.4.3"
    side-channel "^1.0.4"

string.prototype.trimend@^1.0.6:
  version "1.0.6"
  resolved "https://registry.yarnpkg.com/string.prototype.trimend/-/string.prototype.trimend-1.0.6.tgz#c4a27fa026d979d79c04f17397f250a462944533"
  integrity sha512-JySq+4mrPf9EsDBEDYMOb/lM7XQLulwg5R/m1r0PXEFqrV0qHvl58sdTilSXtKOflCsK2E8jxf+GKC0T07RWwQ==
  dependencies:
    call-bind "^1.0.2"
    define-properties "^1.1.4"
    es-abstract "^1.20.4"

string.prototype.trimstart@^1.0.6:
  version "1.0.6"
  resolved "https://registry.yarnpkg.com/string.prototype.trimstart/-/string.prototype.trimstart-1.0.6.tgz#e90ab66aa8e4007d92ef591bbf3cd422c56bdcf4"
  integrity sha512-omqjMDaY92pbn5HOX7f9IccLA+U1tA9GvtU4JrodiXFfYB7jPzzHpRzpglLAjtUV6bB557zwClJezTqnAiYnQA==
  dependencies:
    call-bind "^1.0.2"
    define-properties "^1.1.4"
    es-abstract "^1.20.4"

string_decoder@^1.1.1:
  version "1.3.0"
  resolved "https://registry.yarnpkg.com/string_decoder/-/string_decoder-1.3.0.tgz#42f114594a46cf1a8e30b0a84f56c78c3edac21e"
  integrity sha512-hkRX8U1WjJFd8LsDJ2yQ/wWWxaopEsABU1XfkM8A+j0+85JAGppt16cr1Whg6KIbb4okU6Mql6BOj+uup/wKeA==
  dependencies:
    safe-buffer "~5.2.0"

string_decoder@~1.1.1:
  version "1.1.1"
  resolved "https://registry.yarnpkg.com/string_decoder/-/string_decoder-1.1.1.tgz#9cf1611ba62685d7030ae9e4ba34149c3af03fc8"
  integrity sha512-n/ShnvDi6FHbbVfviro+WojiFzv+s8MPMHBczVePfUpDJLwoLT0ht1l4YwBCbi8pJAveEEdnkHyPyTP/mzRfwg==
  dependencies:
    safe-buffer "~5.1.0"

"strip-ansi-cjs@npm:strip-ansi@^6.0.1", strip-ansi@^6.0.0, strip-ansi@^6.0.1:
  version "6.0.1"
  resolved "https://registry.yarnpkg.com/strip-ansi/-/strip-ansi-6.0.1.tgz#9e26c63d30f53443e9489495b2105d37b67a85d9"
  integrity sha512-Y38VPSHcqkFrCpFnQ9vuSXmquuv5oXOKpGeT6aGrr3o3Gc9AlVa6JBfUSOCnbxGGZF+/0ooI7KrPuUSztUdU5A==
  dependencies:
    ansi-regex "^5.0.1"

strip-ansi@^7.0.1:
  version "7.1.0"
  resolved "https://registry.yarnpkg.com/strip-ansi/-/strip-ansi-7.1.0.tgz#d5b6568ca689d8561370b0707685d22434faff45"
  integrity sha512-iq6eVVI64nQQTRYq2KtEg2d2uU7LElhTJwsH4YzIHZshxlgZms/wIc4VoDQTlG/IvVIrBKG06CrZnp0qv7hkcQ==
  dependencies:
    ansi-regex "^6.0.1"

strip-bom@^3.0.0:
  version "3.0.0"
  resolved "https://registry.yarnpkg.com/strip-bom/-/strip-bom-3.0.0.tgz#2334c18e9c759f7bdd56fdef7e9ae3d588e68ed3"
  integrity sha512-vavAMRXOgBVNF6nyEEmL3DBK19iRpDcoIwW+swQ+CbGiu7lju6t+JklA1MHweoWtadgt4ISVUsXLyDq34ddcwA==

strip-bom@^4.0.0:
  version "4.0.0"
  resolved "https://registry.yarnpkg.com/strip-bom/-/strip-bom-4.0.0.tgz#9c3505c1db45bcedca3d9cf7a16f5c5aa3901878"
  integrity sha512-3xurFv5tEgii33Zi8Jtp55wEIILR9eh34FAW00PZf+JnSsTmV/ioewSgQl97JHvgjoRGwPShsWm+IdrxB35d0w==

strip-final-newline@^2.0.0:
  version "2.0.0"
  resolved "https://registry.yarnpkg.com/strip-final-newline/-/strip-final-newline-2.0.0.tgz#89b852fb2fcbe936f6f4b3187afb0a12c1ab58ad"
  integrity sha512-BrpvfNAE3dcvq7ll3xVumzjKjZQ5tI1sEUIKr3Uoks0XUl45St3FlatVqef9prk4jRDzhW6WZg+3bk93y6pLjA==

strip-indent@^3.0.0:
  version "3.0.0"
  resolved "https://registry.yarnpkg.com/strip-indent/-/strip-indent-3.0.0.tgz#c32e1cee940b6b3432c771bc2c54bcce73cd3001"
  integrity sha512-laJTa3Jb+VQpaC6DseHhF7dXVqHTfJPCRDaEbid/drOhgitgYku/letMUqOXFoWV0zIIUbjpdH2t+tYj4bQMRQ==
  dependencies:
    min-indent "^1.0.0"

strip-json-comments@^3.1.1:
  version "3.1.1"
  resolved "https://registry.yarnpkg.com/strip-json-comments/-/strip-json-comments-3.1.1.tgz#31f1281b3832630434831c310c01cccda8cbe006"
  integrity sha512-6fPc+R4ihwqP6N/aIv2f1gMH8lOVtWQHoqC4yK6oSDVVocumAsfCqjkXnqiYMhmMwS/mEHLp7Vehlt3ql6lEig==

styled-jsx@5.1.1:
  version "5.1.1"
  resolved "https://registry.yarnpkg.com/styled-jsx/-/styled-jsx-5.1.1.tgz#839a1c3aaacc4e735fed0781b8619ea5d0009d1f"
  integrity sha512-pW7uC1l4mBZ8ugbiZrcIsiIvVx1UmTfw7UkC3Um2tmfUq9Bhk8IiyEIPl6F8agHgjzku6j0xQEZbfA5uSgSaCw==
  dependencies:
    client-only "0.0.1"

sucrase@^3.32.0:
  version "3.34.0"
  resolved "https://registry.yarnpkg.com/sucrase/-/sucrase-3.34.0.tgz#1e0e2d8fcf07f8b9c3569067d92fbd8690fb576f"
  integrity sha512-70/LQEZ07TEcxiU2dz51FKaE6hCTWC6vr7FOk3Gr0U60C3shtAN+H+BFr9XlYe5xqf3RA8nrc+VIwzCfnxuXJw==
  dependencies:
    "@jridgewell/gen-mapping" "^0.3.2"
    commander "^4.0.0"
    glob "7.1.6"
    lines-and-columns "^1.1.6"
    mz "^2.7.0"
    pirates "^4.0.1"
    ts-interface-checker "^0.1.9"

superagent@^8.0.5:
  version "8.0.6"
  resolved "https://registry.yarnpkg.com/superagent/-/superagent-8.0.6.tgz#e3fb0b3112b79b12acd605c08846253197765bf6"
  integrity sha512-HqSe6DSIh3hEn6cJvCkaM1BLi466f1LHi4yubR0tpewlMpk4RUFFy35bKz8SsPBwYfIIJy5eclp+3tCYAuX0bw==
  dependencies:
    component-emitter "^1.3.0"
    cookiejar "^2.1.3"
    debug "^4.3.4"
    fast-safe-stringify "^2.1.1"
    form-data "^4.0.0"
    formidable "^2.1.1"
    methods "^1.1.2"
    mime "2.6.0"
    qs "^6.11.0"
    semver "^7.3.8"

supertest@^6.3.3:
  version "6.3.3"
  resolved "https://registry.yarnpkg.com/supertest/-/supertest-6.3.3.tgz#42f4da199fee656106fd422c094cf6c9578141db"
  integrity sha512-EMCG6G8gDu5qEqRQ3JjjPs6+FYT1a7Hv5ApHvtSghmOFJYtsU5S+pSb6Y2EUeCEY3CmEL3mmQ8YWlPOzQomabA==
  dependencies:
    methods "^1.1.2"
    superagent "^8.0.5"

supports-color@^5.3.0:
  version "5.5.0"
  resolved "https://registry.yarnpkg.com/supports-color/-/supports-color-5.5.0.tgz#e2e69a44ac8772f78a1ec0b35b689df6530efc8f"
  integrity sha512-QjVjwdXIt408MIiAqCX4oUKsgU2EqAGzs2Ppkm4aQYbjm+ZEWEcW4SfFNTr4uMNZma0ey4f5lgLrkB0aX0QMow==
  dependencies:
    has-flag "^3.0.0"

supports-color@^7.1.0:
  version "7.2.0"
  resolved "https://registry.yarnpkg.com/supports-color/-/supports-color-7.2.0.tgz#1b7dcdcb32b8138801b3e478ba6a51caa89648da"
  integrity sha512-qpCAvRl9stuOHveKsn7HncJRvv501qIacKzQlO/+Lwxc9+0q2wLyv4Dfvt80/DPn2pqOBsJdDiogXGR9+OvwRw==
  dependencies:
    has-flag "^4.0.0"

supports-color@^8.0.0:
  version "8.1.1"
  resolved "https://registry.yarnpkg.com/supports-color/-/supports-color-8.1.1.tgz#cd6fc17e28500cff56c1b86c0a7fd4a54a73005c"
  integrity sha512-MpUEN2OodtUzxvKQl72cUF7RQ5EiHsGvSsVG0ia9c5RbWGL2CI4C7EpPS8UTBIplnlzZiNuV56w+FuNxy3ty2Q==
  dependencies:
    has-flag "^4.0.0"

supports-preserve-symlinks-flag@^1.0.0:
  version "1.0.0"
  resolved "https://registry.yarnpkg.com/supports-preserve-symlinks-flag/-/supports-preserve-symlinks-flag-1.0.0.tgz#6eda4bd344a3c94aea376d4cc31bc77311039e09"
  integrity sha512-ot0WnXS9fgdkgIcePe6RHNk1WA8+muPa6cSjeR3V8K27q9BB1rTE3R1p7Hv0z1ZyAc8s6Vvv8DIyWf681MAt0w==

swagger-ui-dist@5.1.0:
  version "5.1.0"
  resolved "https://registry.yarnpkg.com/swagger-ui-dist/-/swagger-ui-dist-5.1.0.tgz#b01b3be06bebb2566b2df586c1632d502ec792ad"
  integrity sha512-c1KmAjuVODxw+vwkNLALQZrgdlBAuBbr2xSPfYrJgseEi7gFKcTvShysPmyuDI4kcUa1+5rFpjWvXdusKY74mg==

swagger-ui-dist@>=5.0.0:
  version "5.3.1"
  resolved "https://registry.yarnpkg.com/swagger-ui-dist/-/swagger-ui-dist-5.3.1.tgz#ae76a74136152d790b06a8b71ca389cac35ab78f"
  integrity sha512-El78OvXp9zMasfPrshtkW1CRx8AugAKoZuGGOTW+8llJzOV1RtDJYqQRz/6+2OakjeWWnZuRlN2Qj1Y0ilux3w==

swagger-ui-express@^5.0.0:
  version "5.0.0"
  resolved "https://registry.yarnpkg.com/swagger-ui-express/-/swagger-ui-express-5.0.0.tgz#7a00a18dd909574cb0d628574a299b9ba53d4d49"
  integrity sha512-tsU9tODVvhyfkNSvf03E6FAk+z+5cU3lXAzMy6Pv4av2Gt2xA0++fogwC4qo19XuFf6hdxevPuVCSKFuMHJhFA==
  dependencies:
    swagger-ui-dist ">=5.0.0"

symbol-observable@4.0.0:
  version "4.0.0"
  resolved "https://registry.yarnpkg.com/symbol-observable/-/symbol-observable-4.0.0.tgz#5b425f192279e87f2f9b937ac8540d1984b39205"
  integrity sha512-b19dMThMV4HVFynSAM1++gBHAbk2Tc/osgLIBZMKsyqh34jb2e8Os7T6ZW/Bt3pJFdBTd2JwAnAAEQV7rSNvcQ==

symbol-tree@^3.2.4:
  version "3.2.4"
  resolved "https://registry.yarnpkg.com/symbol-tree/-/symbol-tree-3.2.4.tgz#430637d248ba77e078883951fb9aa0eed7c63fa2"
  integrity sha512-9QNk5KwDF+Bvz+PyObkmSYjI5ksVUYtjW7AU22r2NKcfLJcXp96hkDWU3+XndOsUb+AQ9QhfzfCT2O+CNWT5Tw==

synckit@^0.8.4:
  version "0.8.4"
  resolved "https://registry.yarnpkg.com/synckit/-/synckit-0.8.4.tgz#0e6b392b73fafdafcde56692e3352500261d64ec"
  integrity sha512-Dn2ZkzMdSX827QbowGbU/4yjWuvNaCoScLLoMo/yKbu+P4GBR6cRGKZH27k6a9bRzdqcyd1DE96pQtQ6uNkmyw==
  dependencies:
    "@pkgr/utils" "^2.3.1"
    tslib "^2.4.0"

synckit@^0.8.5:
  version "0.8.5"
  resolved "https://registry.yarnpkg.com/synckit/-/synckit-0.8.5.tgz#b7f4358f9bb559437f9f167eb6bc46b3c9818fa3"
  integrity sha512-L1dapNV6vu2s/4Sputv8xGsCdAVlb5nRDMFU/E27D44l5U6cw1g0dGd45uLc+OXjNMmF4ntiMdCimzcjFKQI8Q==
  dependencies:
    "@pkgr/utils" "^2.3.1"
    tslib "^2.5.0"

tailwindcss@^3.3.3:
  version "3.3.3"
  resolved "https://registry.yarnpkg.com/tailwindcss/-/tailwindcss-3.3.3.tgz#90da807393a2859189e48e9e7000e6880a736daf"
  integrity sha512-A0KgSkef7eE4Mf+nKJ83i75TMyq8HqY3qmFIJSWy8bNt0v1lG7jUcpGpoTFxAwYcWOphcTBLPPJg+bDfhDf52w==
  dependencies:
    "@alloc/quick-lru" "^5.2.0"
    arg "^5.0.2"
    chokidar "^3.5.3"
    didyoumean "^1.2.2"
    dlv "^1.1.3"
    fast-glob "^3.2.12"
    glob-parent "^6.0.2"
    is-glob "^4.0.3"
    jiti "^1.18.2"
    lilconfig "^2.1.0"
    micromatch "^4.0.5"
    normalize-path "^3.0.0"
    object-hash "^3.0.0"
    picocolors "^1.0.0"
    postcss "^8.4.23"
    postcss-import "^15.1.0"
    postcss-js "^4.0.1"
    postcss-load-config "^4.0.1"
    postcss-nested "^6.0.1"
    postcss-selector-parser "^6.0.11"
    resolve "^1.22.2"
    sucrase "^3.32.0"

tapable@^2.1.1, tapable@^2.2.0, tapable@^2.2.1:
  version "2.2.1"
  resolved "https://registry.yarnpkg.com/tapable/-/tapable-2.2.1.tgz#1967a73ef4060a82f12ab96af86d52fdb76eeca0"
  integrity sha512-GNzQvQTOIP6RyTfE2Qxb8ZVlNmw0n88vp1szwWRimP02mnTsx3Wtn5qRdqY9w2XduFNUgvOwhNnQsjwCp+kqaQ==

terser-webpack-plugin@^5.3.7:
  version "5.3.9"
  resolved "https://registry.yarnpkg.com/terser-webpack-plugin/-/terser-webpack-plugin-5.3.9.tgz#832536999c51b46d468067f9e37662a3b96adfe1"
  integrity sha512-ZuXsqE07EcggTWQjXUj+Aot/OMcD0bMKGgF63f7UxYcu5/AJF53aIpK1YoP5xR9l6s/Hy2b+t1AM0bLNPRuhwA==
  dependencies:
    "@jridgewell/trace-mapping" "^0.3.17"
    jest-worker "^27.4.5"
    schema-utils "^3.1.1"
    serialize-javascript "^6.0.1"
    terser "^5.16.8"

terser@^5.16.8:
  version "5.19.2"
  resolved "https://registry.yarnpkg.com/terser/-/terser-5.19.2.tgz#bdb8017a9a4a8de4663a7983f45c506534f9234e"
  integrity sha512-qC5+dmecKJA4cpYxRa5aVkKehYsQKc+AHeKl0Oe62aYjBL8ZA33tTljktDHJSaxxMnbI5ZYw+o/S2DxxLu8OfA==
  dependencies:
    "@jridgewell/source-map" "^0.3.3"
    acorn "^8.8.2"
    commander "^2.20.0"
    source-map-support "~0.5.20"

test-exclude@^6.0.0:
  version "6.0.0"
  resolved "https://registry.yarnpkg.com/test-exclude/-/test-exclude-6.0.0.tgz#04a8698661d805ea6fa293b6cb9e63ac044ef15e"
  integrity sha512-cAGWPIyOHU6zlmg88jwm7VRyXnMN7iV68OGAbYDk/Mh/xC/pzVPlQtY6ngoIH/5/tciuhGfvESU8GrHrcxD56w==
  dependencies:
    "@istanbuljs/schema" "^0.1.2"
    glob "^7.1.4"
    minimatch "^3.0.4"

text-table@^0.2.0:
  version "0.2.0"
  resolved "https://registry.yarnpkg.com/text-table/-/text-table-0.2.0.tgz#7f5ee823ae805207c00af2df4a84ec3fcfa570b4"
  integrity sha512-N+8UisAXDGk8PFXP4HAzVR9nbfmVJ3zYLAWiTIoqC5v5isinhr+r5uaO8+7r3BMfuNIufIsA7RdpVgacC2cSpw==

thenify-all@^1.0.0:
  version "1.6.0"
  resolved "https://registry.yarnpkg.com/thenify-all/-/thenify-all-1.6.0.tgz#1a1918d402d8fc3f98fbf234db0bcc8cc10e9726"
  integrity sha512-RNxQH/qI8/t3thXJDwcstUO4zeqo64+Uy/+sNVRBx4Xn2OX+OZ9oP+iJnNFqplFra2ZUVeKCSa2oVWi3T4uVmA==
  dependencies:
    thenify ">= 3.1.0 < 4"

"thenify@>= 3.1.0 < 4":
  version "3.3.1"
  resolved "https://registry.yarnpkg.com/thenify/-/thenify-3.3.1.tgz#8932e686a4066038a016dd9e2ca46add9838a95f"
  integrity sha512-RVZSIV5IG10Hk3enotrhvz0T9em6cyHBLkH/YAZuKqd8hRkKhSfCGIcP2KUY0EPxndzANBmNllzWPwak+bheSw==
  dependencies:
    any-promise "^1.0.0"

through@^2.3.6:
  version "2.3.8"
  resolved "https://registry.yarnpkg.com/through/-/through-2.3.8.tgz#0dd4c9ffaabc357960b1b724115d7e0e86a2e1f5"
  integrity sha512-w89qg7PI8wAdvX60bMDP+bFoD5Dvhm9oLheFp5O4a2QF0cSBGsBX4qZmadPMvVqlLJBBci+WqGGOAPvcDeNSVg==

tiny-glob@^0.2.9:
  version "0.2.9"
  resolved "https://registry.yarnpkg.com/tiny-glob/-/tiny-glob-0.2.9.tgz#2212d441ac17928033b110f8b3640683129d31e2"
  integrity sha512-g/55ssRPUjShh+xkfx9UPDXqhckHEsHr4Vd9zX55oSdGZc/MD0m3sferOkwWtp98bv+kcVfEHtRJgBVJzelrzg==
  dependencies:
    globalyzer "0.1.0"
    globrex "^0.1.2"

tmp@^0.0.33:
  version "0.0.33"
  resolved "https://registry.yarnpkg.com/tmp/-/tmp-0.0.33.tgz#6d34335889768d21b2bcda0aa277ced3b1bfadf9"
  integrity sha512-jRCJlojKnZ3addtTOjdIqoRuPEKBvNXcGYqzO6zWZX8KfKEpnGY5jfggJQ3EjKuu8D4bJRr0y+cYJFmYbImXGw==
  dependencies:
    os-tmpdir "~1.0.2"

tmpl@1.0.5:
  version "1.0.5"
  resolved "https://registry.yarnpkg.com/tmpl/-/tmpl-1.0.5.tgz#8683e0b902bb9c20c4f726e3c0b69f36518c07cc"
  integrity sha512-3f0uOEAQwIqGuWW2MVzYg8fV/QNnc/IpuJNG837rLuczAaLVHslWHZQj4IGiEl5Hs3kkbhwL9Ab7Hrsmuj+Smw==

to-fast-properties@^2.0.0:
  version "2.0.0"
  resolved "https://registry.yarnpkg.com/to-fast-properties/-/to-fast-properties-2.0.0.tgz#dc5e698cbd079265bc73e0377681a4e4e83f616e"
  integrity sha512-/OaKK0xYrs3DmxRYqL/yDc+FxFUVYhDlXMhRmv3z915w2HF1tnN1omB354j8VUGO/hbRzyD6Y3sA7v7GS/ceog==

to-regex-range@^5.0.1:
  version "5.0.1"
  resolved "https://registry.yarnpkg.com/to-regex-range/-/to-regex-range-5.0.1.tgz#1648c44aae7c8d988a326018ed72f5b4dd0392e4"
  integrity sha512-65P7iz6X5yEr1cwcgvQxbbIw7Uk3gOy5dIdtZ4rDveLqhrdJP+Li/Hx6tyK0NEb+2GCyneCMJiGqrADCSNk8sQ==
  dependencies:
    is-number "^7.0.0"

toidentifier@1.0.1:
  version "1.0.1"
  resolved "https://registry.yarnpkg.com/toidentifier/-/toidentifier-1.0.1.tgz#3be34321a88a820ed1bd80dfaa33e479fbb8dd35"
  integrity sha512-o5sSPKEkg/DIQNmH43V0/uerLrpzVedkUh8tGNvaeXpfpuwjKenlSox/2O/BTlZUtEe+JG7s5YhEz608PlAHRA==

tough-cookie@^4.1.2:
  version "4.1.2"
  resolved "https://registry.yarnpkg.com/tough-cookie/-/tough-cookie-4.1.2.tgz#e53e84b85f24e0b65dd526f46628db6c85f6b874"
  integrity sha512-G9fqXWoYFZgTc2z8Q5zaHy/vJMjm+WV0AkAeHxVCQiEB1b+dGvWzFW6QV07cY5jQ5gRkeid2qIkzkxUnmoQZUQ==
  dependencies:
    psl "^1.1.33"
    punycode "^2.1.1"
    universalify "^0.2.0"
    url-parse "^1.5.3"

tr46@^3.0.0:
  version "3.0.0"
  resolved "https://registry.yarnpkg.com/tr46/-/tr46-3.0.0.tgz#555c4e297a950617e8eeddef633c87d4d9d6cbf9"
  integrity sha512-l7FvfAHlcmulp8kr+flpQZmVwtu7nfRV7NZujtN0OqES8EL4O4e0qqzL0DC5gAvx/ZC/9lk6rhcUwYvkBnBnYA==
  dependencies:
    punycode "^2.1.1"

tr46@~0.0.3:
  version "0.0.3"
  resolved "https://registry.yarnpkg.com/tr46/-/tr46-0.0.3.tgz#8184fd347dac9cdc185992f3a6622e14b9d9ab6a"
  integrity sha512-N3WMsuqV66lT30CrXNbEjx4GEwlow3v6rr4mCcv6prnfwhS01rkgyFdjPNBYd9br7LpXV1+Emh01fHnq2Gdgrw==

tree-kill@1.2.2:
  version "1.2.2"
  resolved "https://registry.yarnpkg.com/tree-kill/-/tree-kill-1.2.2.tgz#4ca09a9092c88b73a7cdc5e8a01b507b0790a0cc"
  integrity sha512-L0Orpi8qGpRG//Nd+H90vFB+3iHnue1zSSGmNOOCh1GLJ7rUKVwV2HvijphGQS2UmhUZewS9VgvxYIdgr+fG1A==

ts-api-utils@^1.0.1:
  version "1.0.1"
  resolved "https://registry.yarnpkg.com/ts-api-utils/-/ts-api-utils-1.0.1.tgz#8144e811d44c749cd65b2da305a032510774452d"
  integrity sha512-lC/RGlPmwdrIBFTX59wwNzqh7aR2otPNPR/5brHZm/XKFYKsfqxihXUe9pU3JI+3vGkl+vyCoNNnPhJn3aLK1A==

ts-interface-checker@^0.1.9:
  version "0.1.13"
  resolved "https://registry.yarnpkg.com/ts-interface-checker/-/ts-interface-checker-0.1.13.tgz#784fd3d679722bc103b1b4b8030bcddb5db2a699"
  integrity sha512-Y/arvbn+rrz3JCKl9C4kVNfTfSm2/mEp5FSz5EsZSANGPSlQrpRI5M4PKF+mJnE52jOO90PnPSc3Ur3bTQw0gA==

ts-jest@^29.1.1:
  version "29.1.1"
  resolved "https://registry.yarnpkg.com/ts-jest/-/ts-jest-29.1.1.tgz#f58fe62c63caf7bfcc5cc6472082f79180f0815b"
  integrity sha512-D6xjnnbP17cC85nliwGiL+tpoKN0StpgE0TeOjXQTU6MVCfsB4v7aW05CgQ/1OywGb0x/oy9hHFnN+sczTiRaA==
  dependencies:
    bs-logger "0.x"
    fast-json-stable-stringify "2.x"
    jest-util "^29.0.0"
    json5 "^2.2.3"
    lodash.memoize "4.x"
    make-error "1.x"
    semver "^7.5.3"
    yargs-parser "^21.0.1"

ts-loader@^9.4.4:
  version "9.4.4"
  resolved "https://registry.yarnpkg.com/ts-loader/-/ts-loader-9.4.4.tgz#6ceaf4d58dcc6979f84125335904920884b7cee4"
  integrity sha512-MLukxDHBl8OJ5Dk3y69IsKVFRA/6MwzEqBgh+OXMPB/OD01KQuWPFd1WAQP8a5PeSCAxfnkhiuWqfmFJzJQt9w==
  dependencies:
    chalk "^4.1.0"
    enhanced-resolve "^5.0.0"
    micromatch "^4.0.0"
    semver "^7.3.4"

ts-node@^10.9.1:
  version "10.9.1"
  resolved "https://registry.yarnpkg.com/ts-node/-/ts-node-10.9.1.tgz#e73de9102958af9e1f0b168a6ff320e25adcff4b"
  integrity sha512-NtVysVPkxxrwFGUUxGYhfux8k78pQB3JqYBXlLRZgdGUqTO5wU/UyHop5p70iEbGhB7q5KmiZiU0Y3KlJrScEw==
  dependencies:
    "@cspotcode/source-map-support" "^0.8.0"
    "@tsconfig/node10" "^1.0.7"
    "@tsconfig/node12" "^1.0.7"
    "@tsconfig/node14" "^1.0.0"
    "@tsconfig/node16" "^1.0.2"
    acorn "^8.4.1"
    acorn-walk "^8.1.1"
    arg "^4.1.0"
    create-require "^1.1.0"
    diff "^4.0.1"
    make-error "^1.1.1"
    v8-compile-cache-lib "^3.0.1"
    yn "3.1.1"

tsconfig-paths-webpack-plugin@4.1.0:
  version "4.1.0"
  resolved "https://registry.yarnpkg.com/tsconfig-paths-webpack-plugin/-/tsconfig-paths-webpack-plugin-4.1.0.tgz#3c6892c5e7319c146eee1e7302ed9e6f2be4f763"
  integrity sha512-xWFISjviPydmtmgeUAuXp4N1fky+VCtfhOkDUFIv5ea7p4wuTomI4QTrXvFBX2S4jZsmyTSrStQl+E+4w+RzxA==
  dependencies:
    chalk "^4.1.0"
    enhanced-resolve "^5.7.0"
    tsconfig-paths "^4.1.2"

tsconfig-paths@4.2.0, tsconfig-paths@^4.1.2, tsconfig-paths@^4.2.0:
  version "4.2.0"
  resolved "https://registry.yarnpkg.com/tsconfig-paths/-/tsconfig-paths-4.2.0.tgz#ef78e19039133446d244beac0fd6a1632e2d107c"
  integrity sha512-NoZ4roiN7LnbKn9QqE1amc9DJfzvZXxF4xDavcOWt1BPkdx+m+0gJuPM+S0vCe7zTJMYUP0R8pO2XMr+Y8oLIg==
  dependencies:
    json5 "^2.2.2"
    minimist "^1.2.6"
    strip-bom "^3.0.0"

tsconfig-paths@^3.14.1:
  version "3.14.1"
  resolved "https://registry.yarnpkg.com/tsconfig-paths/-/tsconfig-paths-3.14.1.tgz#ba0734599e8ea36c862798e920bcf163277b137a"
  integrity sha512-fxDhWnFSLt3VuTwtvJt5fpwxBHg5AdKWMsgcPOOIilyjymcYVZoCQF8fvFRezCNfblEXmi+PcM1eYHeOAgXCOQ==
  dependencies:
    "@types/json5" "^0.0.29"
    json5 "^1.0.1"
    minimist "^1.2.6"
    strip-bom "^3.0.0"

tslib@2.6.1, tslib@^2.5.0:
  version "2.6.1"
  resolved "https://registry.yarnpkg.com/tslib/-/tslib-2.6.1.tgz#fd8c9a0ff42590b25703c0acb3de3d3f4ede0410"
  integrity sha512-t0hLfiEKfMUoqhG+U1oid7Pva4bbDPHYfJNiB7BiIjRkj1pyC++4N3huJfqY6aRH6VTB0rvtzQwjM4K6qpfOig==

tslib@^1.8.1:
  version "1.14.1"
  resolved "https://registry.yarnpkg.com/tslib/-/tslib-1.14.1.tgz#cf2d38bdc34a134bcaf1091c41f6619e2f672d00"
  integrity sha512-Xni35NKzjgMrwevysHTCArtLDpPvye8zV/0E4EyYn43P7/7qvQwPh9BGkHewbMulVntbigmcT7rdX3BNo9wRJg==

tslib@^2.1.0, tslib@^2.4.0:
  version "2.4.1"
  resolved "https://registry.yarnpkg.com/tslib/-/tslib-2.4.1.tgz#0d0bfbaac2880b91e22df0768e55be9753a5b17e"
  integrity sha512-tGyy4dAjRIEwI7BzsB0lynWgOpfqjUdq91XXAlIWD2OwKBH7oCl/GZG/HT4BOHrTlPMOASlMQ7veyTqpmRcrNA==

tsutils@^3.21.0:
  version "3.21.0"
  resolved "https://registry.yarnpkg.com/tsutils/-/tsutils-3.21.0.tgz#b48717d394cea6c1e096983eed58e9d61715b623"
  integrity sha512-mHKK3iUXL+3UF6xL5k0PEhKRUBKPBCv/+RkEOpjRWxxx27KKRBmmA60A9pgOUvMi8GKhRMPEmjBRPzs2W7O1OA==
  dependencies:
    tslib "^1.8.1"

turbo-darwin-64@1.10.12:
  version "1.10.12"
  resolved "https://registry.yarnpkg.com/turbo-darwin-64/-/turbo-darwin-64-1.10.12.tgz#a3d9d6bd3436e795254865bc3d76a9c79aff8085"
  integrity sha512-vmDfGVPl5/aFenAbOj3eOx3ePNcWVUyZwYr7taRl0ZBbmv2TzjRiFotO4vrKCiTVnbqjQqAFQWY2ugbqCI1kOQ==

turbo-darwin-arm64@1.10.12:
  version "1.10.12"
  resolved "https://registry.yarnpkg.com/turbo-darwin-arm64/-/turbo-darwin-arm64-1.10.12.tgz#ff1d9466935687ca68c0dee88a909c34cc654357"
  integrity sha512-3JliEESLNX2s7g54SOBqqkqJ7UhcOGkS0ywMr5SNuvF6kWVTbuUq7uBU/sVbGq8RwvK1ONlhPvJne5MUqBCTCQ==

turbo-linux-64@1.10.12:
  version "1.10.12"
  resolved "https://registry.yarnpkg.com/turbo-linux-64/-/turbo-linux-64-1.10.12.tgz#d184a491cc67c07672d339e36427378d0fc6b82e"
  integrity sha512-siYhgeX0DidIfHSgCR95b8xPee9enKSOjCzx7EjTLmPqPaCiVebRYvbOIYdQWRqiaKh9yfhUtFmtMOMScUf1gg==

turbo-linux-arm64@1.10.12:
  version "1.10.12"
  resolved "https://registry.yarnpkg.com/turbo-linux-arm64/-/turbo-linux-arm64-1.10.12.tgz#44e6ca10b20fd4c59f8c85acf8366c7c09ebca81"
  integrity sha512-K/ZhvD9l4SslclaMkTiIrnfcACgos79YcAo4kwc8bnMQaKuUeRpM15sxLpZp3xDjDg8EY93vsKyjaOhdFG2UbA==

turbo-windows-64@1.10.12:
  version "1.10.12"
  resolved "https://registry.yarnpkg.com/turbo-windows-64/-/turbo-windows-64-1.10.12.tgz#36380eca8e7b0505d08b87a084efab1500b2a80e"
  integrity sha512-7FSgSwvktWDNOqV65l9AbZwcoueAILeE4L7JvjauNASAjjbuzXGCEq5uN8AQU3U5BOFj4TdXrVmO2dX+lLu8Zg==

turbo-windows-arm64@1.10.12:
  version "1.10.12"
  resolved "https://registry.yarnpkg.com/turbo-windows-arm64/-/turbo-windows-arm64-1.10.12.tgz#757ad59b9abf1949f22280bee6e8aad253743ba5"
  integrity sha512-gCNXF52dwom1HLY9ry/cneBPOKTBHhzpqhMylcyvJP0vp9zeMQQkt6yjYv+6QdnmELC92CtKNp2FsNZo+z0pyw==

turbo@1.10.12:
  version "1.10.12"
  resolved "https://registry.yarnpkg.com/turbo/-/turbo-1.10.12.tgz#cd6f56b92da0600dae9fd94230483556a5c83187"
  integrity sha512-WM3+jTfQWnB9W208pmP4oeehZcC6JQNlydb/ZHMRrhmQa+htGhWLCzd6Q9rLe0MwZLPpSPFV2/bN5egCLyoKjQ==
  optionalDependencies:
    turbo-darwin-64 "1.10.12"
    turbo-darwin-arm64 "1.10.12"
    turbo-linux-64 "1.10.12"
    turbo-linux-arm64 "1.10.12"
    turbo-windows-64 "1.10.12"
    turbo-windows-arm64 "1.10.12"

type-check@^0.4.0, type-check@~0.4.0:
  version "0.4.0"
  resolved "https://registry.yarnpkg.com/type-check/-/type-check-0.4.0.tgz#07b8203bfa7056c0657050e3ccd2c37730bab8f1"
  integrity sha512-XleUoc9uwGXqjWwXaUTZAmzMcFZ5858QA2vvx1Ur5xIcixXIP+8LnFDgRplU30us6teqdlskFfu+ae4K79Ooew==
  dependencies:
    prelude-ls "^1.2.1"

type-check@~0.3.2:
  version "0.3.2"
  resolved "https://registry.yarnpkg.com/type-check/-/type-check-0.3.2.tgz#5884cab512cf1d355e3fb784f30804b2b520db72"
  integrity sha512-ZCmOJdvOWDBYJlzAoFkC+Q0+bUyEOS1ltgp1MGU03fqHG+dbi9tBFU2Rd9QKiDZFAYrhPh2JUf7rZRIuHRKtOg==
  dependencies:
    prelude-ls "~1.1.2"

type-detect@4.0.8:
  version "4.0.8"
  resolved "https://registry.yarnpkg.com/type-detect/-/type-detect-4.0.8.tgz#7646fb5f18871cfbb7749e69bd39a6388eb7450c"
  integrity sha512-0fr/mIH1dlO+x7TlcMy+bIDqKPsw/70tVyeHW787goQjhmqaZe10uwLujubK9q9Lg6Fiho1KUKDYz0Z7k7g5/g==

type-fest@^0.20.2:
  version "0.20.2"
  resolved "https://registry.yarnpkg.com/type-fest/-/type-fest-0.20.2.tgz#1bf207f4b28f91583666cb5fbd327887301cd5f4"
  integrity sha512-Ne+eE4r0/iWnpAxD852z3A+N0Bt5RN//NjJwRd2VFHEmrywxf5vsZlh4R6lixl6B+wz/8d+maTSAkN1FIkI3LQ==

type-fest@^0.21.3:
  version "0.21.3"
  resolved "https://registry.yarnpkg.com/type-fest/-/type-fest-0.21.3.tgz#d260a24b0198436e133fa26a524a6d65fa3b2e37"
  integrity sha512-t0rzBq87m3fVcduHDUFhKmyyX+9eo6WQjZvf51Ea/M0Q7+T374Jp1aUiyUl0GKxp8M/OETVHSDvmkyPgvX+X2w==

type-is@^1.6.4, type-is@~1.6.18:
  version "1.6.18"
  resolved "https://registry.yarnpkg.com/type-is/-/type-is-1.6.18.tgz#4e552cd05df09467dcbc4ef739de89f2cf37c131"
  integrity sha512-TkRKr9sUTxEH8MdfuCSP7VizJyzRNMjj2J2do2Jr3Kym598JVdEksuzPQCnlFPW4ky9Q+iA+ma9BGm06XQBy8g==
  dependencies:
    media-typer "0.3.0"
    mime-types "~2.1.24"

typedarray@^0.0.6:
  version "0.0.6"
  resolved "https://registry.yarnpkg.com/typedarray/-/typedarray-0.0.6.tgz#867ac74e3864187b1d3d47d996a78ec5c8830777"
  integrity sha512-/aCDEGatGvZ2BIk+HmLf4ifCJFwvKFNb9/JeZPMulfgFracn9QFcAf5GO8B/mweUjSoblS5In0cWhqpfs/5PQA==

typescript@5.1.6, typescript@^5.1.6:
  version "5.1.6"
  resolved "https://registry.yarnpkg.com/typescript/-/typescript-5.1.6.tgz#02f8ac202b6dad2c0dd5e0913745b47a37998274"
  integrity sha512-zaWCozRZ6DLEWAWFrVDz1H6FVXzUSfTy5FUMWsQlU8Ym5JP9eO4xkTIROFCQvhQf61z6O/G6ugw3SgAnvvm+HA==

uid@2.0.2:
  version "2.0.2"
  resolved "https://registry.yarnpkg.com/uid/-/uid-2.0.2.tgz#4b5782abf0f2feeefc00fa88006b2b3b7af3e3b9"
  integrity sha512-u3xV3X7uzvi5b1MncmZo3i2Aw222Zk1keqLA1YkHldREkAhAqi65wuPfe7lHx8H/Wzy+8CE7S7uS3jekIM5s8g==
  dependencies:
    "@lukeed/csprng" "^1.0.0"

unbox-primitive@^1.0.2:
  version "1.0.2"
  resolved "https://registry.yarnpkg.com/unbox-primitive/-/unbox-primitive-1.0.2.tgz#29032021057d5e6cdbd08c5129c226dff8ed6f9e"
  integrity sha512-61pPlCD9h51VoreyJ0BReideM3MDKMKnh6+V9L08331ipq6Q8OFXZYiqP6n/tbHx4s5I9uRhcye6BrbkizkBDw==
  dependencies:
    call-bind "^1.0.2"
    has-bigints "^1.0.2"
    has-symbols "^1.0.3"
    which-boxed-primitive "^1.0.2"

universalify@^0.2.0:
  version "0.2.0"
  resolved "https://registry.yarnpkg.com/universalify/-/universalify-0.2.0.tgz#6451760566fa857534745ab1dde952d1b1761be0"
  integrity sha512-CJ1QgKmNg3CwvAv/kOFmtnEN05f0D/cn9QntgNOQlQF9dgvVTHj3t+8JPdjqawCHk7V/KA+fbUqzZ9XWhcqPUg==

universalify@^2.0.0:
  version "2.0.0"
  resolved "https://registry.yarnpkg.com/universalify/-/universalify-2.0.0.tgz#75a4984efedc4b08975c5aeb73f530d02df25717"
  integrity sha512-hAZsKq7Yy11Zu1DE0OzWjw7nnLZmJZYTDZZyEFHZdUhV8FkH5MCfoU1XMaxXovpyW5nq5scPqq0ZDP9Zyl04oQ==

unpipe@1.0.0, unpipe@~1.0.0:
  version "1.0.0"
  resolved "https://registry.yarnpkg.com/unpipe/-/unpipe-1.0.0.tgz#b2bf4ee8514aae6165b4817829d21b2ef49904ec"
  integrity sha512-pjy2bYhSsufwWlKwPc+l3cN7+wuJlK6uz0YdJEOlQDbl6jo/YlPi4mb8agUkVC8BF7V8NuzeyPNqRksA3hztKQ==

update-browserslist-db@^1.0.11:
  version "1.0.11"
  resolved "https://registry.yarnpkg.com/update-browserslist-db/-/update-browserslist-db-1.0.11.tgz#9a2a641ad2907ae7b3616506f4b977851db5b940"
  integrity sha512-dCwEFf0/oT85M1fHBg4F0jtLwJrutGoHSQXCh7u4o2t1drG+c0a9Flnqww6XUKSfQMPpJBRjU8d4RXB09qtvaA==
  dependencies:
    escalade "^3.1.1"
    picocolors "^1.0.0"

update-browserslist-db@^1.0.9:
  version "1.0.10"
  resolved "https://registry.yarnpkg.com/update-browserslist-db/-/update-browserslist-db-1.0.10.tgz#0f54b876545726f17d00cd9a2561e6dade943ff3"
  integrity sha512-OztqDenkfFkbSG+tRxBeAnCVPckDBcvibKd35yDONx6OU8N7sqgwc7rCbkJ/WcYtVRZ4ba68d6byhC21GFh7sQ==
  dependencies:
    escalade "^3.1.1"
    picocolors "^1.0.0"

uri-js@^4.2.2:
  version "4.4.1"
  resolved "https://registry.yarnpkg.com/uri-js/-/uri-js-4.4.1.tgz#9b1a52595225859e55f669d928f88c6c57f2a77e"
  integrity sha512-7rKUyy33Q1yc98pQ1DAmLtwX109F7TIfWlW1Ydo8Wl1ii1SeHieeh0HHfPeL2fMXK6z0s8ecKs9frCuLJvndBg==
  dependencies:
    punycode "^2.1.0"

url-parse@^1.5.3:
  version "1.5.10"
  resolved "https://registry.yarnpkg.com/url-parse/-/url-parse-1.5.10.tgz#9d3c2f736c1d75dd3bd2be507dcc111f1e2ea9c1"
  integrity sha512-WypcfiRhfeUP9vvF0j6rw0J3hrWrw6iZv3+22h6iRMJ/8z1Tj6XfLP4DsUix5MhMPnXpiHDoKyoZ/bdCkwBCiQ==
  dependencies:
    querystringify "^2.1.1"
    requires-port "^1.0.0"

use-sync-external-store@^1.0.0:
  version "1.2.0"
  resolved "https://registry.yarnpkg.com/use-sync-external-store/-/use-sync-external-store-1.2.0.tgz#7dbefd6ef3fe4e767a0cf5d7287aacfb5846928a"
  integrity sha512-eEgnFxGQ1Ife9bzYs6VLi8/4X6CObHMw9Qr9tPY43iKwsPw8xE8+EFsf/2cFZ5S3esXgpWgtSCtLNS41F+sKPA==

util-deprecate@^1.0.1, util-deprecate@^1.0.2, util-deprecate@~1.0.1:
  version "1.0.2"
  resolved "https://registry.yarnpkg.com/util-deprecate/-/util-deprecate-1.0.2.tgz#450d4dc9fa70de732762fbd2d4a28981419a0ccf"
  integrity sha512-EPD5q1uXyFxJpCrLnCc1nHnq3gOa6DZBocAIiI2TaSCA7VCJ1UJDMagCzIkXNsUYfD1daK//LTEQ8xiIbrHtcw==

utils-merge@1.0.1:
  version "1.0.1"
  resolved "https://registry.yarnpkg.com/utils-merge/-/utils-merge-1.0.1.tgz#9f95710f50a267947b2ccc124741c1028427e713"
  integrity sha512-pMZTvIkT1d+TFGvDOqodOclx0QWkkgi6Tdoa8gC8ffGAAqz9pzPTZWAybbsHHoED/ztMtkv/VoYTYyShUn81hA==

uuid@9.0.0:
  version "9.0.0"
  resolved "https://registry.yarnpkg.com/uuid/-/uuid-9.0.0.tgz#592f550650024a38ceb0c562f2f6aa435761efb5"
  integrity sha512-MXcSTerfPa4uqyzStbRoTgt5XIe3x5+42+q1sDuy3R5MDk66URdLMOZe5aPX/SQd+kuYAh0FdP/pO28IkQyTeg==

v8-compile-cache-lib@^3.0.1:
  version "3.0.1"
  resolved "https://registry.yarnpkg.com/v8-compile-cache-lib/-/v8-compile-cache-lib-3.0.1.tgz#6336e8d71965cb3d35a1bbb7868445a7c05264bf"
  integrity sha512-wa7YjyUGfNZngI/vtK0UHAN+lgDCxBPCylVXGp0zu59Fz5aiGtNXaq3DhIov063MorB+VfufLh3JlF2KdTK3xg==

v8-to-istanbul@^9.0.1:
  version "9.0.1"
  resolved "https://registry.yarnpkg.com/v8-to-istanbul/-/v8-to-istanbul-9.0.1.tgz#b6f994b0b5d4ef255e17a0d17dc444a9f5132fa4"
  integrity sha512-74Y4LqY74kLE6IFyIjPtkSTWzUZmj8tdHT9Ii/26dvQ6K9Dl2NbEfj0XgU2sHCtKgt5VupqhlO/5aWuqS+IY1w==
  dependencies:
    "@jridgewell/trace-mapping" "^0.3.12"
    "@types/istanbul-lib-coverage" "^2.0.1"
    convert-source-map "^1.6.0"

vary@^1, vary@~1.1.2:
  version "1.1.2"
  resolved "https://registry.yarnpkg.com/vary/-/vary-1.1.2.tgz#2299f02c6ded30d4a5961b0b9f74524a18f634fc"
  integrity sha512-BNGbWLfd0eUPabhkXUVm0j8uuvREyTh5ovRa/dyow/BqAbZJyC+5fU+IzQOzmAKzYqYRAISoRhdQr3eIZ/PXqg==

w3c-xmlserializer@^4.0.0:
  version "4.0.0"
  resolved "https://registry.yarnpkg.com/w3c-xmlserializer/-/w3c-xmlserializer-4.0.0.tgz#aebdc84920d806222936e3cdce408e32488a3073"
  integrity sha512-d+BFHzbiCx6zGfz0HyQ6Rg69w9k19nviJspaj4yNscGjrHu94sVP+aRm75yEbCh+r2/yR+7q6hux9LVtbuTGBw==
  dependencies:
    xml-name-validator "^4.0.0"

walker@^1.0.8:
  version "1.0.8"
  resolved "https://registry.yarnpkg.com/walker/-/walker-1.0.8.tgz#bd498db477afe573dc04185f011d3ab8a8d7653f"
  integrity sha512-ts/8E8l5b7kY0vlWLewOkDXMmPdLcVV4GmOQLyxuSswIJsweeFZtAsMF7k1Nszz+TYBQrlYRmzOnr398y1JemQ==
  dependencies:
    makeerror "1.0.12"

watchpack@2.4.0, watchpack@^2.4.0:
  version "2.4.0"
  resolved "https://registry.yarnpkg.com/watchpack/-/watchpack-2.4.0.tgz#fa33032374962c78113f93c7f2fb4c54c9862a5d"
  integrity sha512-Lcvm7MGST/4fup+ifyKi2hjyIAwcdI4HRgtvTpIUxBRhB+RFtUh8XtDOxUfctVCnhVi+QQj49i91OyvzkJl6cg==
  dependencies:
    glob-to-regexp "^0.4.1"
    graceful-fs "^4.1.2"

wcwidth@^1.0.1:
  version "1.0.1"
  resolved "https://registry.yarnpkg.com/wcwidth/-/wcwidth-1.0.1.tgz#f0b0dcf915bc5ff1528afadb2c0e17b532da2fe8"
  integrity sha512-XHPEwS0q6TaxcvG85+8EYkbiCux2XtWG2mkc47Ng2A77BQu9+DqIOJldST4HgPkuea7dvKSj5VgX3P1d4rW8Tg==
  dependencies:
    defaults "^1.0.3"

webidl-conversions@^3.0.0:
  version "3.0.1"
  resolved "https://registry.yarnpkg.com/webidl-conversions/-/webidl-conversions-3.0.1.tgz#24534275e2a7bc6be7bc86611cc16ae0a5654871"
  integrity sha512-2JAn3z8AR6rjK8Sm8orRC0h/bcl/DqL7tRPdGZ4I1CjdF+EaMLmYxBHyXuKL849eucPFhvBoxMsflfOb8kxaeQ==

webidl-conversions@^7.0.0:
  version "7.0.0"
  resolved "https://registry.yarnpkg.com/webidl-conversions/-/webidl-conversions-7.0.0.tgz#256b4e1882be7debbf01d05f0aa2039778ea080a"
  integrity sha512-VwddBukDzu71offAQR975unBIGqfKZpM+8ZX6ySk8nYhVoo5CYaZyzt3YBvYtRtO+aoGlqxPg/B87NGVZ/fu6g==

webpack-node-externals@3.0.0, webpack-node-externals@^3.0.0:
  version "3.0.0"
  resolved "https://registry.yarnpkg.com/webpack-node-externals/-/webpack-node-externals-3.0.0.tgz#1a3407c158d547a9feb4229a9e3385b7b60c9917"
  integrity sha512-LnL6Z3GGDPht/AigwRh2dvL9PQPFQ8skEpVrWZXLWBYmqcaojHNN0onvHzie6rq7EWKrrBfPYqNEzTJgiwEQDQ==

webpack-sources@^3.2.3:
  version "3.2.3"
  resolved "https://registry.yarnpkg.com/webpack-sources/-/webpack-sources-3.2.3.tgz#2d4daab8451fd4b240cc27055ff6a0c2ccea0cde"
  integrity sha512-/DyMEOrDgLKKIG0fmvtz+4dUX/3Ghozwgm6iPp8KRhvn+eQf9+Q7GWxVNMk3+uCPWfdXYC4ExGBckIXdFEfH1w==

webpack@5.88.1:
  version "5.88.1"
  resolved "https://registry.yarnpkg.com/webpack/-/webpack-5.88.1.tgz#21eba01e81bd5edff1968aea726e2fbfd557d3f8"
  integrity sha512-FROX3TxQnC/ox4N+3xQoWZzvGXSuscxR32rbzjpXgEzWudJFEJBpdlkkob2ylrv5yzzufD1zph1OoFsLtm6stQ==
  dependencies:
    "@types/eslint-scope" "^3.7.3"
    "@types/estree" "^1.0.0"
    "@webassemblyjs/ast" "^1.11.5"
    "@webassemblyjs/wasm-edit" "^1.11.5"
    "@webassemblyjs/wasm-parser" "^1.11.5"
    acorn "^8.7.1"
    acorn-import-assertions "^1.9.0"
    browserslist "^4.14.5"
    chrome-trace-event "^1.0.2"
    enhanced-resolve "^5.15.0"
    es-module-lexer "^1.2.1"
    eslint-scope "5.1.1"
    events "^3.2.0"
    glob-to-regexp "^0.4.1"
    graceful-fs "^4.2.9"
    json-parse-even-better-errors "^2.3.1"
    loader-runner "^4.2.0"
    mime-types "^2.1.27"
    neo-async "^2.6.2"
    schema-utils "^3.2.0"
    tapable "^2.1.1"
    terser-webpack-plugin "^5.3.7"
    watchpack "^2.4.0"
    webpack-sources "^3.2.3"

webpack@^5.88.2:
  version "5.88.2"
  resolved "https://registry.yarnpkg.com/webpack/-/webpack-5.88.2.tgz#f62b4b842f1c6ff580f3fcb2ed4f0b579f4c210e"
  integrity sha512-JmcgNZ1iKj+aiR0OvTYtWQqJwq37Pf683dY9bVORwVbUrDhLhdn/PlO2sHsFHPkj7sHNQF3JwaAkp49V+Sq1tQ==
  dependencies:
    "@types/eslint-scope" "^3.7.3"
    "@types/estree" "^1.0.0"
    "@webassemblyjs/ast" "^1.11.5"
    "@webassemblyjs/wasm-edit" "^1.11.5"
    "@webassemblyjs/wasm-parser" "^1.11.5"
    acorn "^8.7.1"
    acorn-import-assertions "^1.9.0"
    browserslist "^4.14.5"
    chrome-trace-event "^1.0.2"
    enhanced-resolve "^5.15.0"
    es-module-lexer "^1.2.1"
    eslint-scope "5.1.1"
    events "^3.2.0"
    glob-to-regexp "^0.4.1"
    graceful-fs "^4.2.9"
    json-parse-even-better-errors "^2.3.1"
    loader-runner "^4.2.0"
    mime-types "^2.1.27"
    neo-async "^2.6.2"
    schema-utils "^3.2.0"
    tapable "^2.1.1"
    terser-webpack-plugin "^5.3.7"
    watchpack "^2.4.0"
    webpack-sources "^3.2.3"

whatwg-encoding@^2.0.0:
  version "2.0.0"
  resolved "https://registry.yarnpkg.com/whatwg-encoding/-/whatwg-encoding-2.0.0.tgz#e7635f597fd87020858626805a2729fa7698ac53"
  integrity sha512-p41ogyeMUrw3jWclHWTQg1k05DSVXPLcVxRTYsXUk+ZooOCZLcoYgPZ/HL/D/N+uQPOtcp1me1WhBEaX02mhWg==
  dependencies:
    iconv-lite "0.6.3"

whatwg-mimetype@^3.0.0:
  version "3.0.0"
  resolved "https://registry.yarnpkg.com/whatwg-mimetype/-/whatwg-mimetype-3.0.0.tgz#5fa1a7623867ff1af6ca3dc72ad6b8a4208beba7"
  integrity sha512-nt+N2dzIutVRxARx1nghPKGv1xHikU7HKdfafKkLNLindmPU/ch3U31NOCGGA/dmPcmb1VlofO0vnKAcsm0o/Q==

whatwg-url@^11.0.0:
  version "11.0.0"
  resolved "https://registry.yarnpkg.com/whatwg-url/-/whatwg-url-11.0.0.tgz#0a849eebb5faf2119b901bb76fd795c2848d4018"
  integrity sha512-RKT8HExMpoYx4igMiVMY83lN6UeITKJlBQ+vR/8ZJ8OCdSiN3RwCq+9gH0+Xzj0+5IrM6i4j/6LuvzbZIQgEcQ==
  dependencies:
    tr46 "^3.0.0"
    webidl-conversions "^7.0.0"

whatwg-url@^5.0.0:
  version "5.0.0"
  resolved "https://registry.yarnpkg.com/whatwg-url/-/whatwg-url-5.0.0.tgz#966454e8765462e37644d3626f6742ce8b70965d"
  integrity sha512-saE57nupxk6v3HY35+jzBwYa0rKSy0XR8JSxZPwgLr7ys0IBzhGviA1/TUGJLmSVqs8pb9AnvICXEuOHLprYTw==
  dependencies:
    tr46 "~0.0.3"
    webidl-conversions "^3.0.0"

which-boxed-primitive@^1.0.2:
  version "1.0.2"
  resolved "https://registry.yarnpkg.com/which-boxed-primitive/-/which-boxed-primitive-1.0.2.tgz#13757bc89b209b049fe5d86430e21cf40a89a8e6"
  integrity sha512-bwZdv0AKLpplFY2KZRX6TvyuN7ojjr7lwkg6ml0roIy9YeuSr7JS372qlNW18UQYzgYK9ziGcerWqZOmEn9VNg==
  dependencies:
    is-bigint "^1.0.1"
    is-boolean-object "^1.1.0"
    is-number-object "^1.0.4"
    is-string "^1.0.5"
    is-symbol "^1.0.3"

which-collection@^1.0.1:
  version "1.0.1"
  resolved "https://registry.yarnpkg.com/which-collection/-/which-collection-1.0.1.tgz#70eab71ebbbd2aefaf32f917082fc62cdcb70906"
  integrity sha512-W8xeTUwaln8i3K/cY1nGXzdnVZlidBcagyNFtBdD5kxnb4TvGKR7FfSIS3mYpwWS1QUCutfKz8IY8RjftB0+1A==
  dependencies:
    is-map "^2.0.1"
    is-set "^2.0.1"
    is-weakmap "^2.0.1"
    is-weakset "^2.0.1"

which-typed-array@^1.1.8:
  version "1.1.9"
  resolved "https://registry.yarnpkg.com/which-typed-array/-/which-typed-array-1.1.9.tgz#307cf898025848cf995e795e8423c7f337efbde6"
  integrity sha512-w9c4xkx6mPidwp7180ckYWfMmvxpjlZuIudNtDf4N/tTAUB8VJbX25qZoAsrtGuYNnGw3pa0AXgbGKRB8/EceA==
  dependencies:
    available-typed-arrays "^1.0.5"
    call-bind "^1.0.2"
    for-each "^0.3.3"
    gopd "^1.0.1"
    has-tostringtag "^1.0.0"
    is-typed-array "^1.1.10"

which@^2.0.1:
  version "2.0.2"
  resolved "https://registry.yarnpkg.com/which/-/which-2.0.2.tgz#7c6a8dd0a636a0327e10b59c9286eee93f3f51b1"
  integrity sha512-BLI3Tl1TW3Pvl70l3yq3Y64i+awpwXqsGBYWkkqMtnbXgrMD+yj7rhW0kuEDxzJaYXGjEW5ogapKNMEKNMjibA==
  dependencies:
    isexe "^2.0.0"

windows-release@^4.0.0:
  version "4.0.0"
  resolved "https://registry.yarnpkg.com/windows-release/-/windows-release-4.0.0.tgz#4725ec70217d1bf6e02c7772413b29cdde9ec377"
  integrity sha512-OxmV4wzDKB1x7AZaZgXMVsdJ1qER1ed83ZrTYd5Bwq2HfJVg3DJS8nqlAG4sMoJ7mu8cuRmLEYyU13BKwctRAg==
  dependencies:
    execa "^4.0.2"

word-wrap@~1.2.3:
  version "1.2.3"
  resolved "https://registry.yarnpkg.com/word-wrap/-/word-wrap-1.2.3.tgz#610636f6b1f703891bd34771ccb17fb93b47079c"
  integrity sha512-Hz/mrNwitNRh/HUAtM/VT/5VH+ygD6DV7mYKZAtHOrbs8U7lvPS6xf7EJKMF0uW1KJCl0H701g3ZGus+muE5vQ==

"wrap-ansi-cjs@npm:wrap-ansi@^7.0.0", wrap-ansi@^7.0.0:
  version "7.0.0"
  resolved "https://registry.yarnpkg.com/wrap-ansi/-/wrap-ansi-7.0.0.tgz#67e145cff510a6a6984bdf1152911d69d2eb9e43"
  integrity sha512-YVGIj2kamLSTxw6NsZjoBxfSwsn0ycdesmc4p+Q21c5zPuZ1pl+NfxVdxPtdHvmNVOQ6XSYG4AUtyt/Fi7D16Q==
  dependencies:
    ansi-styles "^4.0.0"
    string-width "^4.1.0"
    strip-ansi "^6.0.0"

wrap-ansi@^8.1.0:
  version "8.1.0"
  resolved "https://registry.yarnpkg.com/wrap-ansi/-/wrap-ansi-8.1.0.tgz#56dc22368ee570face1b49819975d9b9a5ead214"
  integrity sha512-si7QWI6zUMq56bESFvagtmzMdGOtoxfR+Sez11Mobfc7tm+VkUckk9bW2UeffTGVUbOksxmSw0AA2gs8g71NCQ==
  dependencies:
    ansi-styles "^6.1.0"
    string-width "^5.0.1"
    strip-ansi "^7.0.1"

wrappy@1:
  version "1.0.2"
  resolved "https://registry.yarnpkg.com/wrappy/-/wrappy-1.0.2.tgz#b5243d8f3ec1aa35f1364605bc0d1036e30ab69f"
  integrity sha512-l4Sp/DRseor9wL6EvV2+TuQn63dMkPjZ/sp9XkghTEbV9KlPS1xUsZ3u7/IQO4wxtcFB4bgpQPRcR3QCvezPcQ==

write-file-atomic@^4.0.2:
  version "4.0.2"
  resolved "https://registry.yarnpkg.com/write-file-atomic/-/write-file-atomic-4.0.2.tgz#a9df01ae5b77858a027fd2e80768ee433555fcfd"
  integrity sha512-7KxauUdBmSdWnmpaGFg+ppNjKF8uNLry8LyzjauQDOVONfFLNKrKvQOxZ/VuTIcS/gge/YNahf5RIIQWTSarlg==
  dependencies:
    imurmurhash "^0.1.4"
    signal-exit "^3.0.7"

ws@^8.11.0:
  version "8.11.0"
  resolved "https://registry.yarnpkg.com/ws/-/ws-8.11.0.tgz#6a0d36b8edfd9f96d8b25683db2f8d7de6e8e143"
  integrity sha512-HPG3wQd9sNQoT9xHyNCXoDUa+Xw/VevmY9FoHyQ+g+rrMn4j6FB4np7Z0OhdTgjx6MgQLK7jwSy1YecU1+4Asg==

xml-name-validator@^4.0.0:
  version "4.0.0"
  resolved "https://registry.yarnpkg.com/xml-name-validator/-/xml-name-validator-4.0.0.tgz#79a006e2e63149a8600f15430f0a4725d1524835"
  integrity sha512-ICP2e+jsHvAj2E2lIHxa5tjXRlKDJo4IdvPvCXbXQGdzSfmSpNVyIKMvoZHjDY9DP0zV17iI85o90vRFXNccRw==

xmlchars@^2.2.0:
  version "2.2.0"
  resolved "https://registry.yarnpkg.com/xmlchars/-/xmlchars-2.2.0.tgz#060fe1bcb7f9c76fe2a17db86a9bc3ab894210cb"
  integrity sha512-JZnDKK8B0RCDw84FNdDAIpZK+JuJw+s7Lz8nksI7SIuU3UXJJslUthsi+uWBUYOwPFwW7W7PRLRfUKpxjtjFCw==

xtend@^4.0.0:
  version "4.0.2"
  resolved "https://registry.yarnpkg.com/xtend/-/xtend-4.0.2.tgz#bb72779f5fa465186b1f438f674fa347fdb5db54"
  integrity sha512-LKYU1iAXJXUgAXn9URjiu+MWhyUXHsvfp7mcuYm9dSUKK0/CjtrUwFAxD82/mCWbtLsGjFIad0wIsod4zrTAEQ==

y18n@^5.0.5:
  version "5.0.8"
  resolved "https://registry.yarnpkg.com/y18n/-/y18n-5.0.8.tgz#7f4934d0f7ca8c56f95314939ddcd2dd91ce1d55"
  integrity sha512-0pfFzegeDWJHJIAmTLRP2DwHjdF5s7jo9tuztdQxAhINCdvS+3nGINqPd00AphqJR/0LhANUS6/+7SCb98YOfA==

yallist@^4.0.0:
  version "4.0.0"
  resolved "https://registry.yarnpkg.com/yallist/-/yallist-4.0.0.tgz#9bb92790d9c0effec63be73519e11a35019a3a72"
  integrity sha512-3wdGidZyq5PB084XLES5TpOSRA3wjXAlIWMhum2kRcv/41Sn2emQ0dycQW4uZXLejwKvg6EsvbdlVL+FYEct7A==

yaml@^1.10.0:
  version "1.10.2"
  resolved "https://registry.yarnpkg.com/yaml/-/yaml-1.10.2.tgz#2301c5ffbf12b467de8da2333a459e29e7920e4b"
  integrity sha512-r3vXyErRCYJ7wg28yvBY5VSoAF8ZvlcW9/BwUzEtUsjvX/DKs24dIkuwjtuprwJJHsbyUbLApepYTR1BN4uHrg==

yaml@^2.1.1:
  version "2.3.1"
  resolved "https://registry.yarnpkg.com/yaml/-/yaml-2.3.1.tgz#02fe0975d23cd441242aa7204e09fc28ac2ac33b"
  integrity sha512-2eHWfjaoXgTBC2jNM1LRef62VQa0umtvRiDSk6HSzW7RvS5YtkabJrwYLLEKWBc8a5U2PTSCs+dJjUTJdlHsWQ==

yargs-parser@21.1.1, yargs-parser@^21.0.1, yargs-parser@^21.1.1:
  version "21.1.1"
  resolved "https://registry.yarnpkg.com/yargs-parser/-/yargs-parser-21.1.1.tgz#9096bceebf990d21bb31fa9516e0ede294a77d35"
  integrity sha512-tVpsJW7DdjecAiFpbIB1e3qxIQsE6NoPc5/eTdrbbIC4h0LVsWhnoa3g+m2HclBIujHzsxZ4VJVA+GUuc2/LBw==

yargs@^17.3.1:
  version "17.6.2"
  resolved "https://registry.yarnpkg.com/yargs/-/yargs-17.6.2.tgz#2e23f2944e976339a1ee00f18c77fedee8332541"
  integrity sha512-1/9UrdHjDZc0eOU0HxOHoS78C69UD3JRMvzlJ7S79S2nTaWRA/whGCTV8o9e/N/1Va9YIV7Q4sOxD8VV4pCWOw==
  dependencies:
    cliui "^8.0.1"
    escalade "^3.1.1"
    get-caller-file "^2.0.5"
    require-directory "^2.1.1"
    string-width "^4.2.3"
    y18n "^5.0.5"
    yargs-parser "^21.1.1"

yn@3.1.1:
  version "3.1.1"
  resolved "https://registry.yarnpkg.com/yn/-/yn-3.1.1.tgz#1e87401a09d767c1d5eab26a6e4c185182d2eb50"
  integrity sha512-Ux4ygGWsu2c7isFWe8Yu1YluJmqVhxqK2cLXNQA5AcC3QfbGNpM7fu0Y8b/z16pXLnFxZYvWhd3fhBY9DLmC6Q==

yocto-queue@^0.1.0:
  version "0.1.0"
  resolved "https://registry.yarnpkg.com/yocto-queue/-/yocto-queue-0.1.0.tgz#0294eb3dee05028d31ee1a5fa2c556a6aaf10a1b"
  integrity sha512-rVksvsnNCdJ/ohGc6xgPwyN8eheCxsiLM8mxuE/t/mOVqJewPuO1miLpTHQiRgTKCLexL4MeAFVagts7HmNZ2Q==

zod@3.21.4:
  version "3.21.4"
  resolved "https://registry.yarnpkg.com/zod/-/zod-3.21.4.tgz#10882231d992519f0a10b5dd58a38c9dabbb64db"
  integrity sha512-m46AKbrzKVzOzs/DZgVnG5H55N1sv1M8qZU3A8RIKbs3mrACDNeIOeilDymVb2HdmP8uwshOCF4uJ8uM9rCqJw==

===== END yarn.lock =====

